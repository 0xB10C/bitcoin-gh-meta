[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n",
      "created_at" : "2022-12-06T10:43:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26646#issuecomment-1339126268",
      "id" : 1339126268,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26646",
      "node_id" : "IC_kwDOABII585P0XH8",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1339126268/reactions"
      },
      "updated_at" : "2022-12-06T10:43:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1339126268",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1041150868"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1041150868"
         }
      },
      "author_association" : "MEMBER",
      "body" : "call this \"nonfinal\" or something seems clearer to me than mutable ",
      "commit_id" : "139e0e10d96a53231b8c5179def33627aed48d3e",
      "created_at" : "2022-12-06T15:52:18Z",
      "diff_hunk" : "@@ -1343,6 +1344,11 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptPackage(const Package& package,\n     // the new transactions. This ensures we don't double-count transaction counts and sizes when\n     // checking ancestor/descendant limits, or double-count transaction fees for fee-related policy.\n     ATMPArgs single_args = ATMPArgs::SingleInPackageAccept(args);\n+    // Results from individual validation. \"Mutable\" because if a transaction fails by itself but\n+    // succeeds later (i.e. when evaluated with a fee-bumping child), the result changes (though not\n+    // reflected in this map). If a transaction fails more than once, we want to return the first\n+    // result, when it was considered on its own. So changes will only be from invalid -> valid.\n+    std::map<uint256, MempoolAcceptResult> individual_results_mutable;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1041150868",
      "id" : 1041150868,
      "line" : 1351,
      "node_id" : "PRRC_kwDOABII584-DrOU",
      "original_commit_id" : "139e0e10d96a53231b8c5179def33627aed48d3e",
      "original_line" : 1351,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 16,
      "pull_request_review_id" : 1206854880,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1041150868/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-06T16:13:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1041150868",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1041170332"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1041170332"
         }
      },
      "author_association" : "MEMBER",
      "body" : "at 139e0e10d96a53231b8c5179def33627aed48d3e commenting out this line doesn't seem to fail any tests, but it does for this particular commit.",
      "commit_id" : "139e0e10d96a53231b8c5179def33627aed48d3e",
      "created_at" : "2022-12-06T16:08:56Z",
      "diff_hunk" : "@@ -1380,6 +1380,8 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptPackage(const Package& package,\n                 // future.  Continue individually validating the rest of the transactions, because\n                 // some of them may still be valid.\n                 quit_early = true;\n+                package_state.Invalid(PackageValidationResult::PCKG_TX, \"transaction failed\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1041170332",
      "id" : 1041170332,
      "line" : 1398,
      "node_id" : "PRRC_kwDOABII584-Dv-c",
      "original_commit_id" : "c1cd5e340e277d30cf80b5a4c183db0c7b94ca1d",
      "original_line" : 1383,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 4,
      "pull_request_review_id" : 1206854880,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1041170332/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-06T16:13:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1041170332",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1041174515"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1041174515"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ever slightly so meta, but I think `txns_new` should instead be called `package_eval_txns` or something, since there are other new transactions that have been not included in this set, due to being accepted individually. ",
      "commit_id" : "139e0e10d96a53231b8c5179def33627aed48d3e",
      "created_at" : "2022-12-06T16:12:24Z",
      "diff_hunk" : "@@ -1390,24 +1396,40 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptPackage(const Package& package,\n                 // some of them may still be valid.\n                 quit_early = true;\n                 package_state.Invalid(PackageValidationResult::PCKG_TX, \"transaction failed\");\n-                results.emplace(wtxid, single_res);\n+                individual_results_mutable.emplace(wtxid, single_res);\n             } else {\n+                package_state.Invalid(PackageValidationResult::PCKG_TX, \"transaction failed\");\n+                individual_results_mutable.emplace(wtxid, single_res);\n                 txns_new.push_back(tx);\n             }\n         }\n     }\n \n     // Nothing to do if the entire package has already been submitted.\n     if (quit_early || txns_new.empty()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1041174515",
      "id" : 1041174515,
      "line" : 1409,
      "node_id" : "PRRC_kwDOABII584-Dw_z",
      "original_commit_id" : "139e0e10d96a53231b8c5179def33627aed48d3e",
      "original_line" : 1409,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 35,
      "pull_request_review_id" : 1206854880,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1041174515/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-06T16:13:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1041174515",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1041477981"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1041477981"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I see what you mean yeah. Will tweak the test.",
      "commit_id" : "139e0e10d96a53231b8c5179def33627aed48d3e",
      "created_at" : "2022-12-06T21:28:34Z",
      "diff_hunk" : "@@ -1380,6 +1380,8 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptPackage(const Package& package,\n                 // future.  Continue individually validating the rest of the transactions, because\n                 // some of them may still be valid.\n                 quit_early = true;\n+                package_state.Invalid(PackageValidationResult::PCKG_TX, \"transaction failed\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1041477981",
      "id" : 1041477981,
      "in_reply_to_id" : 1041170332,
      "line" : 1398,
      "node_id" : "PRRC_kwDOABII584-E7Fd",
      "original_commit_id" : "c1cd5e340e277d30cf80b5a4c183db0c7b94ca1d",
      "original_line" : 1383,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 4,
      "pull_request_review_id" : 1207353140,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1041477981/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-06T21:28:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1041477981",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1042150573"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1042150573"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah, the problem was the same line exists in the non-quit-early case as well. Deleted that as it's incorrect - if we're not quitting early then `package_state` won't be used. The non-quit-early case shouldn't be modifying package_state. Also added a comment/rename to make this more clear.\r\n\r\nThis also has the effect of making the test fail if you comment out this line on the last commit.",
      "commit_id" : "c5ca0755273597cf1d0f1d10b6b914b13a8bb37f",
      "created_at" : "2022-12-07T12:35:32Z",
      "diff_hunk" : "@@ -1380,6 +1380,8 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptPackage(const Package& package,\n                 // future.  Continue individually validating the rest of the transactions, because\n                 // some of them may still be valid.\n                 quit_early = true;\n+                package_state.Invalid(PackageValidationResult::PCKG_TX, \"transaction failed\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1042150573",
      "id" : 1042150573,
      "in_reply_to_id" : 1041170332,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584-HfSt",
      "original_commit_id" : "c1cd5e340e277d30cf80b5a4c183db0c7b94ca1d",
      "original_line" : 1383,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1208338420,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1042150573/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-07T12:38:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1042150573",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1042151123"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1042151123"
         }
      },
      "author_association" : "MEMBER",
      "body" : "renamed to individual_results_nonfinal",
      "commit_id" : "c5ca0755273597cf1d0f1d10b6b914b13a8bb37f",
      "created_at" : "2022-12-07T12:36:04Z",
      "diff_hunk" : "@@ -1343,6 +1344,11 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptPackage(const Package& package,\n     // the new transactions. This ensures we don't double-count transaction counts and sizes when\n     // checking ancestor/descendant limits, or double-count transaction fees for fee-related policy.\n     ATMPArgs single_args = ATMPArgs::SingleInPackageAccept(args);\n+    // Results from individual validation. \"Mutable\" because if a transaction fails by itself but\n+    // succeeds later (i.e. when evaluated with a fee-bumping child), the result changes (though not\n+    // reflected in this map). If a transaction fails more than once, we want to return the first\n+    // result, when it was considered on its own. So changes will only be from invalid -> valid.\n+    std::map<uint256, MempoolAcceptResult> individual_results_mutable;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1042151123",
      "id" : 1042151123,
      "in_reply_to_id" : 1041150868,
      "line" : 1352,
      "node_id" : "PRRC_kwDOABII584-HfbT",
      "original_commit_id" : "139e0e10d96a53231b8c5179def33627aed48d3e",
      "original_line" : 1352,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 144,
      "pull_request_review_id" : 1208338420,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1042151123/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-07T12:38:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1042151123",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1042153215"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1042153215"
         }
      },
      "author_association" : "MEMBER",
      "body" : "renamed, no problem. 3line diff",
      "commit_id" : "c5ca0755273597cf1d0f1d10b6b914b13a8bb37f",
      "created_at" : "2022-12-07T12:37:50Z",
      "diff_hunk" : "@@ -1390,24 +1396,40 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptPackage(const Package& package,\n                 // some of them may still be valid.\n                 quit_early = true;\n                 package_state.Invalid(PackageValidationResult::PCKG_TX, \"transaction failed\");\n-                results.emplace(wtxid, single_res);\n+                individual_results_mutable.emplace(wtxid, single_res);\n             } else {\n+                package_state.Invalid(PackageValidationResult::PCKG_TX, \"transaction failed\");\n+                individual_results_mutable.emplace(wtxid, single_res);\n                 txns_new.push_back(tx);\n             }\n         }\n     }\n \n     // Nothing to do if the entire package has already been submitted.\n     if (quit_early || txns_new.empty()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1042153215",
      "id" : 1042153215,
      "in_reply_to_id" : 1041174515,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584-Hf7_",
      "original_commit_id" : "139e0e10d96a53231b8c5179def33627aed48d3e",
      "original_line" : 1409,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1208338420,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1042153215/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-07T12:38:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1042153215",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1042272401"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1042272401"
         }
      },
      "author_association" : "MEMBER",
      "body" : "name is still the same as before",
      "commit_id" : "c5ca0755273597cf1d0f1d10b6b914b13a8bb37f",
      "created_at" : "2022-12-07T14:27:12Z",
      "diff_hunk" : "@@ -1343,6 +1344,11 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptPackage(const Package& package,\n     // the new transactions. This ensures we don't double-count transaction counts and sizes when\n     // checking ancestor/descendant limits, or double-count transaction fees for fee-related policy.\n     ATMPArgs single_args = ATMPArgs::SingleInPackageAccept(args);\n+    // Results from individual validation. \"Mutable\" because if a transaction fails by itself but\n+    // succeeds later (i.e. when evaluated with a fee-bumping child), the result changes (though not\n+    // reflected in this map). If a transaction fails more than once, we want to return the first\n+    // result, when it was considered on its own. So changes will only be from invalid -> valid.\n+    std::map<uint256, MempoolAcceptResult> individual_results_mutable;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1042272401",
      "id" : 1042272401,
      "in_reply_to_id" : 1041150868,
      "line" : 1352,
      "node_id" : "PRRC_kwDOABII584-H9CR",
      "original_commit_id" : "139e0e10d96a53231b8c5179def33627aed48d3e",
      "original_line" : 1352,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 144,
      "pull_request_review_id" : 1208518372,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1042272401/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-07T14:34:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1042272401",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1043849641"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1043849641"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm wondering how well-defined this value is. Am I right in thinking that the calculation here is \"sum(fees_of_package_transactions)/sum(size_of_package_transactions)\"?\r\n\r\nWhat happens in this case: we have 3 transactions A -> B, C, where C is a child of both A and B.\r\n\r\nA has a low feerate and cannot make it in to the mempool by itself.  (A+B) has a high enough feerate for acceptance, but we receive for validation (A+B+C) instead.  B cannot make it in by itself, since it would be missing a parent, and we never try A+B, right?  So the package feerate for C would reflect the fees and feerate of B (which could be higher than C's own feerate, I think?).\r\n\r\nDo we require that C pay a higher feerate than any of its parents when doing package acceptance?  If not, then I'm not sure this value will always make sense, ie the package feerate of a transaction with no children ought never be greater than its own feerate.",
      "commit_id" : "c5ca0755273597cf1d0f1d10b6b914b13a8bb37f",
      "created_at" : "2022-12-08T21:37:58Z",
      "diff_hunk" : "@@ -582,6 +582,11 @@ class MemPoolAccept\n         /** Total virtual size of all transactions being replaced. */\n         size_t m_conflicting_size{0};\n \n+        /** If we're doing package validation (i.e. m_package_feerates=true), the \"effective\"\n+         * package feerate of this transaction, which may include fee and vsize of its ancestors\n+         * and/or descendants. */\n+        CFeeRate m_package_feerate{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1043849641",
      "id" : 1043849641,
      "line" : 588,
      "node_id" : "PRRC_kwDOABII584-N-Gp",
      "original_commit_id" : "70d1af27cfcc9db68d7f26fa15eb7ee9510bbde1",
      "original_line" : 588,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 7,
      "pull_request_review_id" : 1210815392,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1043849641/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-08T21:37:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1043849641",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1043854324"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1043854324"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Does this comment equally apply to package submission in master?",
      "commit_id" : "c5ca0755273597cf1d0f1d10b6b914b13a8bb37f",
      "created_at" : "2022-12-08T21:44:52Z",
      "diff_hunk" : "@@ -582,6 +582,11 @@ class MemPoolAccept\n         /** Total virtual size of all transactions being replaced. */\n         size_t m_conflicting_size{0};\n \n+        /** If we're doing package validation (i.e. m_package_feerates=true), the \"effective\"\n+         * package feerate of this transaction, which may include fee and vsize of its ancestors\n+         * and/or descendants. */\n+        CFeeRate m_package_feerate{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1043854324",
      "id" : 1043854324,
      "in_reply_to_id" : 1043849641,
      "line" : 588,
      "node_id" : "PRRC_kwDOABII584-N_P0",
      "original_commit_id" : "70d1af27cfcc9db68d7f26fa15eb7ee9510bbde1",
      "original_line" : 588,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 7,
      "pull_request_review_id" : 1210822120,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1043854324/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-08T21:44:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1043854324",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1043876437"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1043876437"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think so, but I was about to write a test using the example above, except where C is 0-fee, and see if it makes it in...",
      "commit_id" : "c5ca0755273597cf1d0f1d10b6b914b13a8bb37f",
      "created_at" : "2022-12-08T22:17:41Z",
      "diff_hunk" : "@@ -582,6 +582,11 @@ class MemPoolAccept\n         /** Total virtual size of all transactions being replaced. */\n         size_t m_conflicting_size{0};\n \n+        /** If we're doing package validation (i.e. m_package_feerates=true), the \"effective\"\n+         * package feerate of this transaction, which may include fee and vsize of its ancestors\n+         * and/or descendants. */\n+        CFeeRate m_package_feerate{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1043876437",
      "id" : 1043876437,
      "in_reply_to_id" : 1043849641,
      "line" : 588,
      "node_id" : "PRRC_kwDOABII584-OEpV",
      "original_commit_id" : "70d1af27cfcc9db68d7f26fa15eb7ee9510bbde1",
      "original_line" : 588,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 7,
      "pull_request_review_id" : 1210854166,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1043876437/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-08T22:17:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1043876437",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1044346662"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1044346662"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, master does not currently handle this case because we're currently doing A, B, C individually, so we'd get 1 \"too low fee\" and 2 \"missing inputs,\" and then reject all of them. When I first tried to implement for 1-child-with-parents, I had incorrectly assumed this was okay and the code made it in before I realized - my apologies for that. The intention is definitely to fix it.\r\n\r\nRequiring C pay a higher feerate than its parents is ok in the child-with-parents scenario but not generic ancestor package scenario (imagine low fee grandparent, lower fee parent, high fee child). I think we've discussed \"for each tx in topological order, calculate its in-package ancestor set that hasn't made it in yet, and submit that as a package\" - I have drafted this [here](https://github.com/glozow/bitcoin/commit/ef4e4936ab692d87dc0d5d55ac61e13940565947).\r\n\r\nBtw this test case is implemented [here](https://github.com/glozow/bitcoin/commit/6659757cd547e4c3f6b62ef80cbc8cdda4b301b9) (it should fail on master as you expect).",
      "commit_id" : "c5ca0755273597cf1d0f1d10b6b914b13a8bb37f",
      "created_at" : "2022-12-09T11:12:22Z",
      "diff_hunk" : "@@ -582,6 +582,11 @@ class MemPoolAccept\n         /** Total virtual size of all transactions being replaced. */\n         size_t m_conflicting_size{0};\n \n+        /** If we're doing package validation (i.e. m_package_feerates=true), the \"effective\"\n+         * package feerate of this transaction, which may include fee and vsize of its ancestors\n+         * and/or descendants. */\n+        CFeeRate m_package_feerate{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1044346662",
      "id" : 1044346662,
      "in_reply_to_id" : 1043849641,
      "line" : 588,
      "node_id" : "PRRC_kwDOABII584-P3cm",
      "original_commit_id" : "70d1af27cfcc9db68d7f26fa15eb7ee9510bbde1",
      "original_line" : 588,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 7,
      "pull_request_review_id" : 1211507173,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1044346662/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-09T11:12:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1044346662",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1044552718"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1044552718"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can confirm the patch fails as expected: the entire triangle package makes it in the mempool ",
      "commit_id" : "c5ca0755273597cf1d0f1d10b6b914b13a8bb37f",
      "created_at" : "2022-12-09T15:12:27Z",
      "diff_hunk" : "@@ -582,6 +582,11 @@ class MemPoolAccept\n         /** Total virtual size of all transactions being replaced. */\n         size_t m_conflicting_size{0};\n \n+        /** If we're doing package validation (i.e. m_package_feerates=true), the \"effective\"\n+         * package feerate of this transaction, which may include fee and vsize of its ancestors\n+         * and/or descendants. */\n+        CFeeRate m_package_feerate{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1044552718",
      "id" : 1044552718,
      "in_reply_to_id" : 1043849641,
      "line" : 588,
      "node_id" : "PRRC_kwDOABII584-QpwO",
      "original_commit_id" : "70d1af27cfcc9db68d7f26fa15eb7ee9510bbde1",
      "original_line" : 588,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 7,
      "pull_request_review_id" : 1211811542,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1044552718/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-09T15:12:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1044552718",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1045879297"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1045879297"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: list initialization (and in a few more places down below)\r\n```suggestion\r\n        CMutableTransaction mtx_parent_invalid{mtx_parent};\r\n```",
      "commit_id" : "c5ca0755273597cf1d0f1d10b6b914b13a8bb37f",
      "created_at" : "2022-12-12T14:14:50Z",
      "diff_hunk" : "@@ -275,7 +274,30 @@ BOOST_FIXTURE_TEST_CASE(package_submission_tests, TestChain100Setup)\n         BOOST_CHECK_EQUAL(result_3gen_submit.m_state.GetResult(), PackageValidationResult::PCKG_POLICY);\n         BOOST_CHECK_EQUAL(result_3gen_submit.m_state.GetRejectReason(), \"package-not-child-with-parents\");\n         BOOST_CHECK_EQUAL(m_node.mempool->size(), expected_pool_size);\n-        BOOST_CHECK(result_3gen_submit.m_package_feerate == std::nullopt);\n+    }\n+\n+    // Parent and child package where transactions are invalid for reasons other than fee and\n+    // missing inputs, so the package validation isn't expected to happen.\n+    {\n+        CScriptWitness bad_witness;\n+        bad_witness.stack.push_back(std::vector<unsigned char>(1));\n+        CMutableTransaction mtx_parent_invalid = mtx_parent;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1045879297",
      "id" : 1045879297,
      "line" : 284,
      "node_id" : "PRRC_kwDOABII584-VtoB",
      "original_commit_id" : "c5ca0755273597cf1d0f1d10b6b914b13a8bb37f",
      "original_line" : 284,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/test/txpackage_tests.cpp",
      "position" : 53,
      "pull_request_review_id" : 1213662405,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1045879297/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-12T18:01:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1045879297",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1045968527"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1045968527"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit\r\n```suggestion\r\n    const CFeeRate effective_feerate{ws.m_modified_fees, ws.m_vsize};\r\n```",
      "commit_id" : "c5ca0755273597cf1d0f1d10b6b914b13a8bb37f",
      "created_at" : "2022-12-12T15:24:23Z",
      "diff_hunk" : "@@ -1176,16 +1182,17 @@ MempoolAcceptResult MemPoolAccept::AcceptSingleTransaction(const CTransactionRef\n \n     if (!ConsensusScriptChecks(args, ws)) return MempoolAcceptResult::Failure(ws.m_state);\n \n+    const CFeeRate effective_feerate(ws.m_modified_fees, ws.m_vsize);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1045968527",
      "id" : 1045968527,
      "line" : 1185,
      "node_id" : "PRRC_kwDOABII584-WDaP",
      "original_commit_id" : "c5ca0755273597cf1d0f1d10b6b914b13a8bb37f",
      "original_line" : 1185,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 28,
      "pull_request_review_id" : 1213662405,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1045968527/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-12T18:01:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1045968527",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1046011831"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1046011831"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: since this is a member of \"fees\", I think \"effective-rate\" can be a less verbose alternative (and also consistent with \"base\")\r\n```suggestion\r\n                        {RPCResult::Type::STR_AMOUNT, \"effective-rate\", /*optional=*/true, \"if something other than base feerate was used, the effective feerate in \" + CURRENCY_UNIT + \" per KvB. For example, the package feerate and/or feerate with modified fees from prioritisetransaction.\"},\r\n```",
      "commit_id" : "c5ca0755273597cf1d0f1d10b6b914b13a8bb37f",
      "created_at" : "2022-12-12T15:54:58Z",
      "diff_hunk" : "@@ -124,6 +124,7 @@ static RPCHelpMan testmempoolaccept()\n                     {RPCResult::Type::OBJ, \"fees\", /*optional=*/true, \"Transaction fees (only present if 'allowed' is true)\",\n                     {\n                         {RPCResult::Type::STR_AMOUNT, \"base\", \"transaction fee in \" + CURRENCY_UNIT},\n+                        {RPCResult::Type::STR_AMOUNT, \"effective-feerate\", /*optional=*/true, \"if something other than base feerate was used, the effective feerate in \" + CURRENCY_UNIT + \" per KvB. For example, the package feerate and/or feerate with modified fees from prioritisetransaction.\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1046011831",
      "id" : 1046011831,
      "line" : 127,
      "node_id" : "PRRC_kwDOABII584-WN-3",
      "original_commit_id" : "c5ca0755273597cf1d0f1d10b6b914b13a8bb37f",
      "original_line" : 127,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/rpc/mempool.cpp",
      "position" : 4,
      "pull_request_review_id" : 1213662405,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1046011831/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-12T18:01:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1046011831",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1046013886"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1046013886"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Have you considered always including this field? Besides the minimal data overhead, I don't see a reason to not always include it. Simplifies the logic for both server and client?",
      "commit_id" : "c5ca0755273597cf1d0f1d10b6b914b13a8bb37f",
      "created_at" : "2022-12-12T15:56:21Z",
      "diff_hunk" : "@@ -124,6 +124,7 @@ static RPCHelpMan testmempoolaccept()\n                     {RPCResult::Type::OBJ, \"fees\", /*optional=*/true, \"Transaction fees (only present if 'allowed' is true)\",\n                     {\n                         {RPCResult::Type::STR_AMOUNT, \"base\", \"transaction fee in \" + CURRENCY_UNIT},\n+                        {RPCResult::Type::STR_AMOUNT, \"effective-feerate\", /*optional=*/true, \"if something other than base feerate was used, the effective feerate in \" + CURRENCY_UNIT + \" per KvB. For example, the package feerate and/or feerate with modified fees from prioritisetransaction.\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1046013886",
      "id" : 1046013886,
      "in_reply_to_id" : 1046011831,
      "line" : 127,
      "node_id" : "PRRC_kwDOABII584-WOe-",
      "original_commit_id" : "c5ca0755273597cf1d0f1d10b6b914b13a8bb37f",
      "original_line" : 127,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/rpc/mempool.cpp",
      "position" : 4,
      "pull_request_review_id" : 1213662405,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1046013886/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-12T18:01:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1046013886",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1046025065"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1046025065"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "imo this is less readable than the previous `for package_txn in package_txns:`\r\n\r\n(I think the rest of the changes in this loop are an improvement)",
      "commit_id" : "c5ca0755273597cf1d0f1d10b6b914b13a8bb37f",
      "created_at" : "2022-12-12T16:04:45Z",
      "diff_hunk" : "@@ -298,27 +298,19 @@ def test_submit_child_with_parents(self, num_parents, partial_submit):\n         submitpackage_result = node.submitpackage(package=[tx[\"hex\"] for tx in package_txns])\n \n         # Check that each result is present, with the correct size and fees\n-        for package_txn in package_txns:\n-            tx = package_txn[\"tx\"]\n+        for i in range(num_parents + 1):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1046025065",
      "id" : 1046025065,
      "line" : 301,
      "node_id" : "PRRC_kwDOABII584-WRNp",
      "original_commit_id" : "c5ca0755273597cf1d0f1d10b6b914b13a8bb37f",
      "original_line" : 301,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "test/functional/rpc_packages.py",
      "position" : 6,
      "pull_request_review_id" : 1213662405,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1046025065/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-12T18:01:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1046025065",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1046062544"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1046062544"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "alternative suggestion: \"preliminary\", but happy with \"nonfinal\" too.",
      "commit_id" : "c5ca0755273597cf1d0f1d10b6b914b13a8bb37f",
      "created_at" : "2022-12-12T16:31:55Z",
      "diff_hunk" : "@@ -1343,6 +1344,11 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptPackage(const Package& package,\n     // the new transactions. This ensures we don't double-count transaction counts and sizes when\n     // checking ancestor/descendant limits, or double-count transaction fees for fee-related policy.\n     ATMPArgs single_args = ATMPArgs::SingleInPackageAccept(args);\n+    // Results from individual validation. \"Mutable\" because if a transaction fails by itself but\n+    // succeeds later (i.e. when evaluated with a fee-bumping child), the result changes (though not\n+    // reflected in this map). If a transaction fails more than once, we want to return the first\n+    // result, when it was considered on its own. So changes will only be from invalid -> valid.\n+    std::map<uint256, MempoolAcceptResult> individual_results_mutable;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1046062544",
      "id" : 1046062544,
      "in_reply_to_id" : 1041150868,
      "line" : 1352,
      "node_id" : "PRRC_kwDOABII584-WaXQ",
      "original_commit_id" : "139e0e10d96a53231b8c5179def33627aed48d3e",
      "original_line" : 1352,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 144,
      "pull_request_review_id" : 1213662405,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1046062544/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-12T18:01:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1046062544",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1046084540"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1046084540"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Additional lookup can be avoided:\r\n```suggestion\r\n            Assume(results.emplace(wtxid, mempoolaccept_res).second);\r\n```",
      "commit_id" : "c5ca0755273597cf1d0f1d10b6b914b13a8bb37f",
      "created_at" : "2022-12-12T16:47:16Z",
      "diff_hunk" : "@@ -1380,24 +1396,42 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptPackage(const Package& package,\n                 // future.  Continue individually validating the rest of the transactions, because\n                 // some of them may still be valid.\n                 quit_early = true;\n+                package_state_quit_early.Invalid(PackageValidationResult::PCKG_TX, \"transaction failed\");\n+                individual_results_mutable.emplace(wtxid, single_res);\n             } else {\n-                txns_new.push_back(tx);\n+                individual_results_mutable.emplace(wtxid, single_res);\n+                txns_package_eval.push_back(tx);\n             }\n         }\n     }\n \n     // Nothing to do if the entire package has already been submitted.\n-    if (quit_early || txns_new.empty()) {\n+    if (quit_early || txns_package_eval.empty()) {\n+        for (const auto& [wtxid, mempoolaccept_res] : individual_results_mutable) {\n+            Assume(results.find(wtxid) == results.end());\n+            results.emplace(wtxid, mempoolaccept_res);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1046084540",
      "id" : 1046084540,
      "line" : 1412,
      "node_id" : "PRRC_kwDOABII584-Wfu8",
      "original_commit_id" : "c5ca0755273597cf1d0f1d10b6b914b13a8bb37f",
      "original_line" : 1412,
      "original_position" : 170,
      "original_start_line" : 1411,
      "path" : "src/validation.cpp",
      "position" : 170,
      "pull_request_review_id" : 1213662405,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1046084540/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1411,
      "start_side" : "RIGHT",
      "updated_at" : "2022-12-12T18:01:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1046084540",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1046117647"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1046117647"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "std::map::insert [doesn't overwrite](https://en.cppreference.com/w/cpp/container/map/insert) if key already exists, so since we're not using rvalue refs I think this can be simplified without performance degradation:\r\n```suggestion\r\n        // insert doesn't overwrite existing keys\r\n        submission_result.m_tx_results.insert(individual_results_mutable.begin(), individual_results_mutable.end());\r\n```\r\n",
      "commit_id" : "c5ca0755273597cf1d0f1d10b6b914b13a8bb37f",
      "created_at" : "2022-12-12T17:11:26Z",
      "diff_hunk" : "@@ -1380,24 +1396,42 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptPackage(const Package& package,\n                 // future.  Continue individually validating the rest of the transactions, because\n                 // some of them may still be valid.\n                 quit_early = true;\n+                package_state_quit_early.Invalid(PackageValidationResult::PCKG_TX, \"transaction failed\");\n+                individual_results_mutable.emplace(wtxid, single_res);\n             } else {\n-                txns_new.push_back(tx);\n+                individual_results_mutable.emplace(wtxid, single_res);\n+                txns_package_eval.push_back(tx);\n             }\n         }\n     }\n \n     // Nothing to do if the entire package has already been submitted.\n-    if (quit_early || txns_new.empty()) {\n+    if (quit_early || txns_package_eval.empty()) {\n+        for (const auto& [wtxid, mempoolaccept_res] : individual_results_mutable) {\n+            Assume(results.find(wtxid) == results.end());\n+            results.emplace(wtxid, mempoolaccept_res);\n+        }\n         // No package feerate when no package validation was done.\n-        return PackageMempoolAcceptResult(package_state, std::move(results));\n+        return PackageMempoolAcceptResult(package_state_quit_early, std::move(results));\n     }\n-    // Validate the (deduplicated) transactions as a package.\n-    auto submission_result = AcceptMultipleTransactions(txns_new, args);\n+    // Validate the (deduplicated) transactions as a package. Note that submission_result has its\n+    // own PackageValidationState; package_state is unused past this point.\n+    auto submission_result = AcceptMultipleTransactions(txns_package_eval, args);\n     // Include already-in-mempool transaction results in the final result.\n     for (const auto& [wtxid, mempoolaccept_res] : results) {\n+        Assume(submission_result.m_tx_results.find(wtxid) == submission_result.m_tx_results.end());\n         submission_result.m_tx_results.emplace(wtxid, mempoolaccept_res);\n     }\n-    if (submission_result.m_state.IsValid()) assert(submission_result.m_package_feerate.has_value());\n+    if (submission_result.m_state.GetResult() == PackageValidationResult::PCKG_TX) {\n+        // Package validation failed because one or more transactions failed.\n+        // Include individual previous failure reasons if they aren't provided.\n+        for (const auto& [wtxid, mempoolaccept_res] : individual_results_mutable) {\n+            if (submission_result.m_tx_results.find(wtxid) == submission_result.m_tx_results.end()) {\n+                submission_result.m_tx_results.emplace(wtxid, mempoolaccept_res);\n+            }\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1046117647",
      "id" : 1046117647,
      "line" : 1432,
      "node_id" : "PRRC_kwDOABII584-Wn0P",
      "original_commit_id" : "c5ca0755273597cf1d0f1d10b6b914b13a8bb37f",
      "original_line" : 1432,
      "original_position" : 194,
      "original_start_line" : 1428,
      "path" : "src/validation.cpp",
      "position" : 194,
      "pull_request_review_id" : 1213662405,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1046117647/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1428,
      "start_side" : "RIGHT",
      "updated_at" : "2022-12-12T18:01:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1046117647",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1046149577"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1046149577"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Sorry to bikeshed, but `txns_package_eval` is hard to understand imo. Would `txns_to_evaluate` (or `package_txns_to_evaluate`, but I think it's too verbose) work?",
      "commit_id" : "c5ca0755273597cf1d0f1d10b6b914b13a8bb37f",
      "created_at" : "2022-12-12T17:35:32Z",
      "diff_hunk" : "@@ -1390,24 +1396,40 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptPackage(const Package& package,\n                 // some of them may still be valid.\n                 quit_early = true;\n                 package_state.Invalid(PackageValidationResult::PCKG_TX, \"transaction failed\");\n-                results.emplace(wtxid, single_res);\n+                individual_results_mutable.emplace(wtxid, single_res);\n             } else {\n+                package_state.Invalid(PackageValidationResult::PCKG_TX, \"transaction failed\");\n+                individual_results_mutable.emplace(wtxid, single_res);\n                 txns_new.push_back(tx);\n             }\n         }\n     }\n \n     // Nothing to do if the entire package has already been submitted.\n     if (quit_early || txns_new.empty()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1046149577",
      "id" : 1046149577,
      "in_reply_to_id" : 1041174515,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584-WvnJ",
      "original_commit_id" : "139e0e10d96a53231b8c5179def33627aed48d3e",
      "original_line" : 1409,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1213662405,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1046149577/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-12T18:01:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1046149577",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1046155242"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1046155242"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: could make \"previous\" more explicit\r\n```suggestion\r\n        // Include individual failure reasons if not already provided by `AcceptSingleTransaction()`.\r\n```",
      "commit_id" : "c5ca0755273597cf1d0f1d10b6b914b13a8bb37f",
      "created_at" : "2022-12-12T17:39:42Z",
      "diff_hunk" : "@@ -1380,24 +1396,42 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptPackage(const Package& package,\n                 // future.  Continue individually validating the rest of the transactions, because\n                 // some of them may still be valid.\n                 quit_early = true;\n+                package_state_quit_early.Invalid(PackageValidationResult::PCKG_TX, \"transaction failed\");\n+                individual_results_mutable.emplace(wtxid, single_res);\n             } else {\n-                txns_new.push_back(tx);\n+                individual_results_mutable.emplace(wtxid, single_res);\n+                txns_package_eval.push_back(tx);\n             }\n         }\n     }\n \n     // Nothing to do if the entire package has already been submitted.\n-    if (quit_early || txns_new.empty()) {\n+    if (quit_early || txns_package_eval.empty()) {\n+        for (const auto& [wtxid, mempoolaccept_res] : individual_results_mutable) {\n+            Assume(results.find(wtxid) == results.end());\n+            results.emplace(wtxid, mempoolaccept_res);\n+        }\n         // No package feerate when no package validation was done.\n-        return PackageMempoolAcceptResult(package_state, std::move(results));\n+        return PackageMempoolAcceptResult(package_state_quit_early, std::move(results));\n     }\n-    // Validate the (deduplicated) transactions as a package.\n-    auto submission_result = AcceptMultipleTransactions(txns_new, args);\n+    // Validate the (deduplicated) transactions as a package. Note that submission_result has its\n+    // own PackageValidationState; package_state is unused past this point.\n+    auto submission_result = AcceptMultipleTransactions(txns_package_eval, args);\n     // Include already-in-mempool transaction results in the final result.\n     for (const auto& [wtxid, mempoolaccept_res] : results) {\n+        Assume(submission_result.m_tx_results.find(wtxid) == submission_result.m_tx_results.end());\n         submission_result.m_tx_results.emplace(wtxid, mempoolaccept_res);\n     }\n-    if (submission_result.m_state.IsValid()) assert(submission_result.m_package_feerate.has_value());\n+    if (submission_result.m_state.GetResult() == PackageValidationResult::PCKG_TX) {\n+        // Package validation failed because one or more transactions failed.\n+        // Include individual previous failure reasons if they aren't provided.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1046155242",
      "id" : 1046155242,
      "line" : 1427,
      "node_id" : "PRRC_kwDOABII584-Ww_q",
      "original_commit_id" : "c5ca0755273597cf1d0f1d10b6b914b13a8bb37f",
      "original_line" : 1427,
      "original_position" : 189,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 189,
      "pull_request_review_id" : 1213662405,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1046155242/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-12T18:01:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1046155242",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1046158930"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1046158930"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Not specific to this PR, but I think this docstring is out of date? In addition to entire package already being submitted, this block also handles the case of package containing invalid txns. Perhaps good to update now?",
      "commit_id" : "c5ca0755273597cf1d0f1d10b6b914b13a8bb37f",
      "created_at" : "2022-12-12T17:42:23Z",
      "diff_hunk" : "@@ -1380,24 +1396,42 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptPackage(const Package& package,\n                 // future.  Continue individually validating the rest of the transactions, because\n                 // some of them may still be valid.\n                 quit_early = true;\n+                package_state_quit_early.Invalid(PackageValidationResult::PCKG_TX, \"transaction failed\");\n+                individual_results_mutable.emplace(wtxid, single_res);\n             } else {\n-                txns_new.push_back(tx);\n+                individual_results_mutable.emplace(wtxid, single_res);\n+                txns_package_eval.push_back(tx);\n             }\n         }\n     }\n \n     // Nothing to do if the entire package has already been submitted.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1046158930",
      "id" : 1046158930,
      "line" : 1408,
      "node_id" : "PRRC_kwDOABII584-Wx5S",
      "original_commit_id" : "c5ca0755273597cf1d0f1d10b6b914b13a8bb37f",
      "original_line" : 1408,
      "original_position" : 165,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 165,
      "pull_request_review_id" : 1213662405,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1046158930/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-12T18:01:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1046158930",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1046160777"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1046160777"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This comment can now be removed I think",
      "commit_id" : "c5ca0755273597cf1d0f1d10b6b914b13a8bb37f",
      "created_at" : "2022-12-12T17:43:35Z",
      "diff_hunk" : "@@ -1380,24 +1396,42 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptPackage(const Package& package,\n                 // future.  Continue individually validating the rest of the transactions, because\n                 // some of them may still be valid.\n                 quit_early = true;\n+                package_state_quit_early.Invalid(PackageValidationResult::PCKG_TX, \"transaction failed\");\n+                individual_results_mutable.emplace(wtxid, single_res);\n             } else {\n-                txns_new.push_back(tx);\n+                individual_results_mutable.emplace(wtxid, single_res);\n+                txns_package_eval.push_back(tx);\n             }\n         }\n     }\n \n     // Nothing to do if the entire package has already been submitted.\n-    if (quit_early || txns_new.empty()) {\n+    if (quit_early || txns_package_eval.empty()) {\n+        for (const auto& [wtxid, mempoolaccept_res] : individual_results_mutable) {\n+            Assume(results.find(wtxid) == results.end());\n+            results.emplace(wtxid, mempoolaccept_res);\n+        }\n         // No package feerate when no package validation was done.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1046160777",
      "id" : 1046160777,
      "line" : 1414,
      "node_id" : "PRRC_kwDOABII584-WyWJ",
      "original_commit_id" : "c5ca0755273597cf1d0f1d10b6b914b13a8bb37f",
      "original_line" : 1414,
      "original_position" : 172,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 172,
      "pull_request_review_id" : 1213662405,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1046160777/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-12T18:01:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1046160777",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1047045461"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1047045461"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Have you considered always including this field?\r\n\r\nWe don't always know it. We could have quit validation before looking up inputs, e.g. because `CheckTransaction()` failed. It's also possible we couldn't find the inputs at all.",
      "commit_id" : "c5ca0755273597cf1d0f1d10b6b914b13a8bb37f",
      "created_at" : "2022-12-13T11:37:24Z",
      "diff_hunk" : "@@ -124,6 +124,7 @@ static RPCHelpMan testmempoolaccept()\n                     {RPCResult::Type::OBJ, \"fees\", /*optional=*/true, \"Transaction fees (only present if 'allowed' is true)\",\n                     {\n                         {RPCResult::Type::STR_AMOUNT, \"base\", \"transaction fee in \" + CURRENCY_UNIT},\n+                        {RPCResult::Type::STR_AMOUNT, \"effective-feerate\", /*optional=*/true, \"if something other than base feerate was used, the effective feerate in \" + CURRENCY_UNIT + \" per KvB. For example, the package feerate and/or feerate with modified fees from prioritisetransaction.\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1047045461",
      "id" : 1047045461,
      "in_reply_to_id" : 1046011831,
      "line" : 127,
      "node_id" : "PRRC_kwDOABII584-aKVV",
      "original_commit_id" : "c5ca0755273597cf1d0f1d10b6b914b13a8bb37f",
      "original_line" : 127,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/rpc/mempool.cpp",
      "position" : 4,
      "pull_request_review_id" : 1215300420,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1047045461/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-13T11:37:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1047045461",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1048583003"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1048583003"
         }
      },
      "author_association" : "MEMBER",
      "body" : "rename to `results_final` to be self documenting later?",
      "commit_id" : "0d383a65ee01eb58c011c4c056523b9a0f20d96f",
      "created_at" : "2022-12-14T15:02:59Z",
      "diff_hunk" : "@@ -1316,14 +1338,15 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptPackage(const Package& package,\n          return unconfirmed_parent_txids.count(input.prevout.hash) > 0 || m_view.HaveCoin(input.prevout);\n     };\n     if (!std::all_of(child->vin.cbegin(), child->vin.cend(), package_or_confirmed)) {\n-        package_state.Invalid(PackageValidationResult::PCKG_POLICY, \"package-not-child-with-unconfirmed-parents\");\n-        return PackageMempoolAcceptResult(package_state, {});\n+        package_state_quit_early.Invalid(PackageValidationResult::PCKG_POLICY, \"package-not-child-with-unconfirmed-parents\");\n+        return PackageMempoolAcceptResult(package_state_quit_early, {});\n     }\n     // Protect against bugs where we pull more inputs from disk that miss being added to\n     // coins_to_uncache. The backend will be connected again when needed in PreChecks.\n     m_view.SetBackend(m_dummy);\n \n     LOCK(m_pool.cs);\n+    // Stores final results that will not change.\n     std::map<const uint256, const MempoolAcceptResult> results;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1048583003",
      "id" : 1048583003,
      "line" : 1350,
      "node_id" : "PRRC_kwDOABII584-gBtb",
      "original_commit_id" : "0d383a65ee01eb58c011c4c056523b9a0f20d96f",
      "original_line" : 1350,
      "original_position" : 148,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 148,
      "pull_request_review_id" : 1217631020,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1048583003/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-14T15:12:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1048583003",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1048588103"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1048588103"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Could also assert that `m_result_type != MempoolAcceptResult::ResultType::INVALID` to catch possible regressions",
      "commit_id" : "0d383a65ee01eb58c011c4c056523b9a0f20d96f",
      "created_at" : "2022-12-14T15:07:22Z",
      "diff_hunk" : "@@ -1380,24 +1408,38 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptPackage(const Package& package,\n                 // future.  Continue individually validating the rest of the transactions, because\n                 // some of them may still be valid.\n                 quit_early = true;\n+                package_state_quit_early.Invalid(PackageValidationResult::PCKG_TX, \"transaction failed\");\n+                individual_results_nonfinal.emplace(wtxid, single_res);\n             } else {\n-                txns_new.push_back(tx);\n+                individual_results_nonfinal.emplace(wtxid, single_res);\n+                txns_package_eval.push_back(tx);\n             }\n         }\n     }\n \n-    // Nothing to do if the entire package has already been submitted.\n-    if (quit_early || txns_new.empty()) {\n-        // No package feerate when no package validation was done.\n-        return PackageMempoolAcceptResult(package_state, std::move(results));\n+    // Quit early because package validation won't change the result or the entire package has\n+    // already been submitted.\n+    if (quit_early || txns_package_eval.empty()) {\n+        for (const auto& [wtxid, mempoolaccept_res] : individual_results_nonfinal) {\n+            Assume(results.emplace(wtxid, mempoolaccept_res).second);\n+        }\n+        return PackageMempoolAcceptResult(package_state_quit_early, std::move(results));\n     }\n-    // Validate the (deduplicated) transactions as a package.\n-    auto submission_result = AcceptMultipleTransactions(txns_new, args);\n+    // Validate the (deduplicated) transactions as a package. Note that submission_result has its\n+    // own PackageValidationState; package_state is unused past this point.\n+    auto submission_result = AcceptMultipleTransactions(txns_package_eval, args);\n     // Include already-in-mempool transaction results in the final result.\n     for (const auto& [wtxid, mempoolaccept_res] : results) {\n-        submission_result.m_tx_results.emplace(wtxid, mempoolaccept_res);\n+        Assume(submission_result.m_tx_results.emplace(wtxid, mempoolaccept_res).second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26646#discussion_r1048588103",
      "id" : 1048588103,
      "line" : 1433,
      "node_id" : "PRRC_kwDOABII584-gC9H",
      "original_commit_id" : "0d383a65ee01eb58c011c4c056523b9a0f20d96f",
      "original_line" : 1433,
      "original_position" : 200,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 200,
      "pull_request_review_id" : 1217631020,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26646",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1048588103/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-14T15:12:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1048588103",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   }
]
