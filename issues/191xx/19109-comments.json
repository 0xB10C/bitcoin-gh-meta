[
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.\r\n\r\nWhat's the additional memory overhead per peer?",
      "created_at" : "2020-05-29T22:59:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19109#issuecomment-636228113",
      "id" : 636228113,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19109",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzNjIyODExMw==",
      "updated_at" : "2020-05-29T22:59:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/636228113",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Around 54 kB.",
      "created_at" : "2020-05-29T23:23:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19109#issuecomment-636233792",
      "id" : 636233792,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19109",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzNjIzMzc5Mg==",
      "updated_at" : "2020-05-29T23:23:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/636233792",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "If I've got the maths right, in a 15 minute interval we'll announce up to 15,750 txs to an outbound peer (35 every 2 seconds), and 6,300 txs to inbound peers (35 every 5 seconds). If RBF and the like didn't exist, 10k txs would be about 4 blocks worth on average based on some recent blocks.\r\n\r\nRelaying tx's from the mempool in addition to mapRelay was introduced in #16851 and helps obtain missing unconfirmed parents when a child transaction enters the mempool (ie, poor man's package relay via the orphan pool). Without some alternative working form of package relay, I'm not sure it's ideal to drop that?\r\n\r\nPresuming we want to support mempool filtering at all, I think it's useful to be able to obtain old transactions -- if someone tries to send you a payment but uses a low feerate that isn't confirming, you want to be able to pick up that transaction from your peers' mempools so that you can CPFP it, even if you only manage to get online a few hours or a day after it was relayed across the network.\r\n\r\nOne way to preserve that behaviour might be to retain the `longlived_mempool_time` bypass, and do it first:\r\n\r\n```c++\r\n    auto txinfo = mempool.info(txid);\r\n    if (txinfo.tx && txinfo.m_time <= longlived_mempool_time) {\r\n        return txinfo.tx;\r\n    } else {\r\n        LOCK(cs_main);\r\n        if (state->m_recently_relayed_invs.contains(txid)) {\r\n            if (txinfo.tx) return txinfo.tx;\r\n\r\n            // In order to reduce NOTFOUND spam, we retain recently announced txs\r\n            // in mapRelay even if they've been removed from the mempool\r\n            auto mi = mapRelay.find(txid);\r\n            if (mi != mapRelay.end()) return mi->second;\r\n        }\r\n    }\r\n```\r\n\r\nThat way if you'll still relay \"old\" txs (and even do it without locking `cs_main`). This could let you only use `m_recently_relayed_invs` for a shorter period (a few minutes?), which in turn would let you reduce `RELAY_TX_CACHE_TIME` and `INVENTORY_MAX_RECENT_RELAY` correspondingly.\r\n\r\nIf `RELAY_TX_CACHE_TIME` was reduced from 15m to 5m, then we'd announce up to 5250 txs to outbound peers and 2100 txs to inbound peers, so could halve `INVENTORY_MAX_RECENT_RELAY` reducing it from 54kB to 27kB per peer.\r\n\r\nCould be an idea to set nElements to `INV_BC_MAX/INV_BC_INTERVAL * RELAY_TX_CACHE_TIME` (so 6300 for 15m, 2100 for 5m) for inbounds, and set it to 2.5x that for outbounds (so 15750 for 15m, 5250 for 5m) which would change the filter sizes to (85kB, 34kB) for 15m or (28kB, 11kB) for 5m.",
      "created_at" : "2020-05-30T00:26:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19109#issuecomment-636246238",
      "id" : 636246238,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19109",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzNjI0NjIzOA==",
      "updated_at" : "2020-05-30T00:26:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/636246238",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #19053 (refactor: replace CNode pointers by references within net_processing.{h,cpp} by theStack)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-05-30T02:55:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19109#issuecomment-636265665",
      "id" : 636265665,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19109",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzNjI2NTY2NQ==",
      "updated_at" : "2020-06-02T15:09:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/636265665",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ajtowns Good points. We should be moving towards relying more on the mempool where it can provide that data. Your code looks like the right approach.\n\nSo I guess a question is parameters.\n\nWith Poisson distributed intervals, 70 s is enough for a 1 in a million chance to not have had any broadcast events. 104 s is enough for 1 in a billion. Unless there is another reason to extend, 2 minutes should be plenty (both for modelling the longlived_mempool variable, the bloom filter size, and for limiting the relay pool).\n\nIf we're talking about such short windows, perhaps memory usage is really no concern. The bloom filter could also be given a 1/billion fprate, and still be just a few kB.",
      "created_at" : "2020-06-01T08:56:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19109#issuecomment-636712875",
      "id" : 636712875,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19109",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzNjcxMjg3NQ==",
      "updated_at" : "2020-06-01T08:56:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/636712875",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Perhaps the first question is: after how much time are we okay with attackers knowing everything that was in the mempool at the time?\r\n\r\nIf that number is small, perhaps it is sufficient to just allow responding to all tx requests, as long as the tx entered the mempool before the last inv sent out to that peer (a variable which could replace the last BIP35 response to that peer one). That would avoid the need for a Bloom filter entirely.\r\n\r\n",
      "created_at" : "2020-06-01T22:49:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19109#issuecomment-637165812",
      "id" : 637165812,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19109",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzNzE2NTgxMg==",
      "updated_at" : "2020-06-01T22:49:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/637165812",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Updated to @ajtowns' approach suggested above, with a delay constant of 2 minutes.",
      "created_at" : "2020-06-02T03:07:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19109#issuecomment-637242837",
      "id" : 637242837,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19109",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzNzI0MjgzNw==",
      "updated_at" : "2020-06-02T03:07:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/637242837",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Pinging a few people who may be interested in reviewing: @naumenkogs @amiti @jonatack @MarcoFalke ",
      "created_at" : "2020-06-03T20:02:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19109#issuecomment-638431540",
      "id" : 638431540,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19109",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzODQzMTU0MA==",
      "updated_at" : "2020-06-03T20:03:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/638431540",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-06-04T20:35:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19109#issuecomment-639102101",
      "id" : 639102101,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19109",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzOTEwMjEwMQ==",
      "updated_at" : "2020-06-04T20:35:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/639102101",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I'm running with this code, plus this logging patch:\r\n\r\n```diff\r\n@@ -1540,6 +1540,10 @@ CTransactionRef static FindTxForGetData(CNode* peer, const uint256& txid, const\r\n         }\r\n     }\r\n \r\n+    if (txinfo.tx) {\r\n+        LogPrint(BCLog::NET, \"peer requested premature tx %s peer=%d\\n\", txid.ToString(), peer->GetId());\r\n+    }\r\n+\r\n     return {};\r\n }\r\n```\r\n\r\nAnd it's occasionally logging premature entries (a few over 24 hours), which I wasn't seeing with the code currently in master.",
      "created_at" : "2020-06-04T21:16:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19109#issuecomment-639120895",
      "id" : 639120895,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19109",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzOTEyMDg5NQ==",
      "updated_at" : "2020-06-04T21:21:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/639120895",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> And it's occasionally logging premature entries\r\n\r\nI got some examples of that too; but the peer that was doing it looked very spy-ish.\r\n\r\nHowever, I think a legit client could trigger it, if the sequence was \"here's tx X; peer connects; here's tx Y which spends X:n; peers asks for Y; peer doesn't have X so asks for X\", all within the 2 minute timeframe.",
      "created_at" : "2020-06-05T04:37:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19109#issuecomment-639253623",
      "id" : 639253623,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19109",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzOTI1MzYyMw==",
      "updated_at" : "2020-06-05T04:37:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/639253623",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   }
]
