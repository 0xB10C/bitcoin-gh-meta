[
   {
      "body" : "**Note to reviewers:** Let me know if this cleanup is better placed somewhere else (i.e. outside of `OldDecrypt(Ã¢ÂÂ¦)`). One alternative would be to put it in `~BasicTestingSetup()`, but then it'll run for unrelated tests as well.",
      "created_at" : "2017-08-10T17:16:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11024#issuecomment-321616451",
      "id" : 321616451,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11024",
      "updated_at" : "2017-08-10T17:16:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/321616451",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11024#discussion_r132537260"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11024"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/132537260"
         }
      },
      "body" : "I'm not sure I understand this. OpenSSL API is confusing, where is the symmetric \"create\" for this remove/free?\r\nSurprised that this needs `ERR_*` just to deallocate a structure that comes out of the blue.\r\nIs this related to cleanup in `~CInit()` in util.cpp?\r\n",
      "commit_id" : "b3afb6242ec64b7c1f161ff6125b6c1faa801652",
      "created_at" : "2017-08-10T18:49:12Z",
      "diff_hunk" : "@@ -80,8 +81,8 @@ bool OldDecrypt(const std::vector<unsigned char>& vchCiphertext, CKeyingMaterial\n     if (fOk) fOk = EVP_DecryptUpdate(ctx, &vchPlaintext[0], &nPLen, &vchCiphertext[0], nLen) != 0;\n     if (fOk) fOk = EVP_DecryptFinal_ex(ctx, (&vchPlaintext[0]) + nPLen, &nFLen) != 0;\n     EVP_CIPHER_CTX_cleanup(ctx);\n-\n     EVP_CIPHER_CTX_free(ctx);\n+    ERR_remove_thread_state(nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11024#discussion_r132537260",
      "id" : 132537260,
      "original_commit_id" : "b3afb6242ec64b7c1f161ff6125b6c1faa801652",
      "original_position" : 14,
      "path" : "src/wallet/test/crypto_tests.cpp",
      "position" : 14,
      "pull_request_review_id" : 55629781,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11024",
      "updated_at" : "2017-08-10T18:49:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/132537260",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11024#discussion_r132566921"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11024"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/132566921"
         }
      },
      "body" : "Yes, the OpenSSL API is full of surprises! :-)\r\n\r\nThis is my understanding:\r\n\r\n`OldDecrypt(Ã¢ÂÂ¦)` (in `crypto_tests.cpp`) [calls OpenSSL's `EVP_DecryptFinal_ex(Ã¢ÂÂ¦)`](https://github.com/practicalswift/bitcoin/blob/b3afb6242ec64b7c1f161ff6125b6c1faa801652/src/wallet/test/crypto_tests.cpp#L82).\r\n\r\nIf `EVP_DecryptFinal_ex(Ã¢ÂÂ¦)` encounters any errors [then `EVPerr(Ã¢ÂÂ¦)` is called](https://github.com/openssl/openssl/blob/64846096b18340b9a39ddd29a7a0e23c56f22959/crypto/evp/evp_enc.c#L515-L516).\r\n\r\n[EVPerr(Ã¢ÂÂ¦) is defined](https://github.com/openssl/openssl/blob/354ab3653c0f9a218d91d4e5679c738896253d26/include/openssl/err.h#L103) as:\r\n\r\n```\r\n#define EVPerr(f,r)  ERR_PUT_error(ERR_LIB_EVP,(f),(r),OPENSSL_FILE,OPENSSL_LINE)\r\n```\r\n\r\n[`ERR_PUT_error(Ã¢ÂÂ¦)`](https://github.com/openssl/openssl/blob/354ab3653c0f9a218d91d4e5679c738896253d26/crypto/err/err.c#L368-L403) stores stores the errors in a thread local error queue for which the allocations are made using [`OPENSSL_zalloc(Ã¢ÂÂ¦)` in `ERR_get_state(Ã¢ÂÂ¦)`](https://github.com/openssl/openssl/blob/354ab3653c0f9a218d91d4e5679c738896253d26/crypto/err/err.c#L682-L707).",
      "commit_id" : "b3afb6242ec64b7c1f161ff6125b6c1faa801652",
      "created_at" : "2017-08-10T21:02:24Z",
      "diff_hunk" : "@@ -80,8 +81,8 @@ bool OldDecrypt(const std::vector<unsigned char>& vchCiphertext, CKeyingMaterial\n     if (fOk) fOk = EVP_DecryptUpdate(ctx, &vchPlaintext[0], &nPLen, &vchCiphertext[0], nLen) != 0;\n     if (fOk) fOk = EVP_DecryptFinal_ex(ctx, (&vchPlaintext[0]) + nPLen, &nFLen) != 0;\n     EVP_CIPHER_CTX_cleanup(ctx);\n-\n     EVP_CIPHER_CTX_free(ctx);\n+    ERR_remove_thread_state(nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11024#discussion_r132566921",
      "id" : 132566921,
      "original_commit_id" : "b3afb6242ec64b7c1f161ff6125b6c1faa801652",
      "original_position" : 14,
      "path" : "src/wallet/test/crypto_tests.cpp",
      "position" : 14,
      "pull_request_review_id" : 55664107,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11024",
      "updated_at" : "2017-08-10T21:03:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/132566921",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   }
]
