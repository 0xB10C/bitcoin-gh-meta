[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6872#discussion_r42956177"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6872"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/42956177"
         }
      },
      "body" : "You can do slightly better:\r\n```if (it != cacheCoins.end() && (((it->second.flags & CCoinsCacheEntry::DIRTY) == 0) || ((it->second.flags & CCoinsCacheEntry::FRESH) && it->second.coins.IsPruned())))```\r\n\r\nThis will also allow removing entries that were created and spent entirely within a cache.",
      "commit_id" : "2882815e3be064b1cda238035378c9b847899cf2",
      "created_at" : "2015-10-26T02:38:41Z",
      "diff_hunk" : "@@ -192,6 +197,13 @@ bool CCoinsViewCache::Flush() {\n     return fOk;\n }\n \n+void CCoinsViewCache::Uncache(const uint256& hash)\n+{\n+    CCoinsMap::iterator it = cacheCoins.find(hash);\n+    if (it != cacheCoins.end() && it->second.flags == 0)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#discussion_r42956177",
      "id" : 42956177,
      "original_commit_id" : "2882815e3be064b1cda238035378c9b847899cf2",
      "original_position" : 19,
      "path" : "src/coins.cpp",
      "position" : 19,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6872",
      "updated_at" : "2015-10-26T02:38:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/42956177",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6872#discussion_r42956355"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6872"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/42956355"
         }
      },
      "body" : "Such an entry should probably be removed without a call to Uncache, no?",
      "commit_id" : "2882815e3be064b1cda238035378c9b847899cf2",
      "created_at" : "2015-10-26T02:45:11Z",
      "diff_hunk" : "@@ -192,6 +197,13 @@ bool CCoinsViewCache::Flush() {\n     return fOk;\n }\n \n+void CCoinsViewCache::Uncache(const uint256& hash)\n+{\n+    CCoinsMap::iterator it = cacheCoins.find(hash);\n+    if (it != cacheCoins.end() && it->second.flags == 0)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#discussion_r42956355",
      "id" : 42956355,
      "original_commit_id" : "2882815e3be064b1cda238035378c9b847899cf2",
      "original_position" : 19,
      "path" : "src/coins.cpp",
      "position" : 19,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6872",
      "updated_at" : "2015-10-26T02:45:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/42956355",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6872#discussion_r42956411"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6872"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/42956411"
         }
      },
      "body" : "Uh, right, and it already is... never mind!",
      "commit_id" : "2882815e3be064b1cda238035378c9b847899cf2",
      "created_at" : "2015-10-26T02:46:51Z",
      "diff_hunk" : "@@ -192,6 +197,13 @@ bool CCoinsViewCache::Flush() {\n     return fOk;\n }\n \n+void CCoinsViewCache::Uncache(const uint256& hash)\n+{\n+    CCoinsMap::iterator it = cacheCoins.find(hash);\n+    if (it != cacheCoins.end() && it->second.flags == 0)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#discussion_r42956411",
      "id" : 42956411,
      "original_commit_id" : "2882815e3be064b1cda238035378c9b847899cf2",
      "original_position" : 19,
      "path" : "src/coins.cpp",
      "position" : 19,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6872",
      "updated_at" : "2015-10-26T02:46:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/42956411",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6872#discussion_r42956567"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6872"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/42956567"
         }
      },
      "body" : "Even if HaveCoins returns false, the entry may have been pulled into the cache (the parent cache may have a pruned entry), so this probably works better outside of the else branch.",
      "commit_id" : "2882815e3be064b1cda238035378c9b847899cf2",
      "created_at" : "2015-10-26T02:51:00Z",
      "diff_hunk" : "@@ -830,18 +850,22 @@ bool AcceptToMemoryPool(CTxMemPool& pool, CValidationState &state, const CTransa\n         view.SetBackend(viewMemPool);\n \n         // do we already have it?\n-        if (view.HaveCoins(hash))\n+        if (view.HaveCoins(hash)) {\n+            vHashTxnToUncache.push_back(hash);\n             return state.Invalid(false, REJECT_ALREADY_KNOWN, \"txn-already-known\");\n+        }\n \n         // do all inputs exist?\n         // Note that this does not check for the presence of actual outputs (see the next check for that),\n         // and only helps with filling in pfMissingInputs (to determine missing vs spent).\n         BOOST_FOREACH(const CTxIn txin, tx.vin) {\n+            bool fMaybeUncache = !view.HaveCoinsInCache(txin.prevout.hash);\n             if (!view.HaveCoins(txin.prevout.hash)) {\n                 if (pfMissingInputs)\n                     *pfMissingInputs = true;\n                 return false; // fMissingInputs and !state.IsInvalid() is used to detect this condition, don't set state.Invalid()\n-            }\n+            } else if (fMaybeUncache)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#discussion_r42956567",
      "id" : 42956567,
      "original_commit_id" : "2882815e3be064b1cda238035378c9b847899cf2",
      "original_position" : 67,
      "path" : "src/main.cpp",
      "position" : 67,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6872",
      "updated_at" : "2015-10-26T02:51:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/42956567",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6872#discussion_r42956863"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6872"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/42956863"
         }
      },
      "body" : "If coinsUsage is larger than nCoinCacheUsage + limit, this results in an infinite loop?\r\n",
      "commit_id" : "2882815e3be064b1cda238035378c9b847899cf2",
      "created_at" : "2015-10-26T03:00:20Z",
      "diff_hunk" : "@@ -740,6 +740,25 @@ bool CheckTransaction(const CTransaction& tx, CValidationState &state)\n     return true;\n }\n \n+void LimitMempoolSize(CTxMemPool& pool, size_t limit, unsigned long age) {\n+    int expired = pool.Expire(GetTime() - age);\n+    if (expired != 0)\n+        LogPrint(\"mempool\", \"Expired %i transactions from the memory pool\\n\", expired);\n+\n+    size_t mempoolUsage = pool.DynamicMemoryUsage();\n+    size_t coinsUsage = pcoinsTip->DynamicMemoryUsage();\n+\n+    while (mempoolUsage > limit || coinsUsage + mempoolUsage > nCoinCacheUsage + limit) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#discussion_r42956863",
      "id" : 42956863,
      "original_commit_id" : "2882815e3be064b1cda238035378c9b847899cf2",
      "original_position" : 12,
      "path" : "src/main.cpp",
      "position" : 12,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6872",
      "updated_at" : "2015-10-26T03:01:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/42956863",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6872#discussion_r42956959"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6872"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/42956959"
         }
      },
      "body" : "Huh? I could have sworn I deleted the loop as it is too easy for an attacker to fuck with your mempool, even if it did work.",
      "commit_id" : "2882815e3be064b1cda238035378c9b847899cf2",
      "created_at" : "2015-10-26T03:04:11Z",
      "diff_hunk" : "@@ -740,6 +740,25 @@ bool CheckTransaction(const CTransaction& tx, CValidationState &state)\n     return true;\n }\n \n+void LimitMempoolSize(CTxMemPool& pool, size_t limit, unsigned long age) {\n+    int expired = pool.Expire(GetTime() - age);\n+    if (expired != 0)\n+        LogPrint(\"mempool\", \"Expired %i transactions from the memory pool\\n\", expired);\n+\n+    size_t mempoolUsage = pool.DynamicMemoryUsage();\n+    size_t coinsUsage = pcoinsTip->DynamicMemoryUsage();\n+\n+    while (mempoolUsage > limit || coinsUsage + mempoolUsage > nCoinCacheUsage + limit) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#discussion_r42956959",
      "id" : 42956959,
      "original_commit_id" : "2882815e3be064b1cda238035378c9b847899cf2",
      "original_position" : 12,
      "path" : "src/main.cpp",
      "position" : 12,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6872",
      "updated_at" : "2015-10-26T03:04:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/42956959",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Do you feel like pulling in https://github.com/sipa/bitcoin/commit/4186ac95f8283206874af50f9754e894823df66d ?",
      "created_at" : "2015-10-26T03:24:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#issuecomment-151013314",
      "id" : 151013314,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6872",
      "updated_at" : "2015-10-26T03:26:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/151013314",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6872#discussion_r42957654"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6872"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/42957654"
         }
      },
      "body" : "Yeah, I think that loop and the link with coincache size should go away. The coincache size shouldn't exceed its own limit, and the mempool shouldn't exceed its own limit. We may want to move to a model where the size for both is set using a single limit, but that will require other changes elsewhere too.",
      "commit_id" : "2882815e3be064b1cda238035378c9b847899cf2",
      "created_at" : "2015-10-26T03:32:38Z",
      "diff_hunk" : "@@ -740,6 +740,25 @@ bool CheckTransaction(const CTransaction& tx, CValidationState &state)\n     return true;\n }\n \n+void LimitMempoolSize(CTxMemPool& pool, size_t limit, unsigned long age) {\n+    int expired = pool.Expire(GetTime() - age);\n+    if (expired != 0)\n+        LogPrint(\"mempool\", \"Expired %i transactions from the memory pool\\n\", expired);\n+\n+    size_t mempoolUsage = pool.DynamicMemoryUsage();\n+    size_t coinsUsage = pcoinsTip->DynamicMemoryUsage();\n+\n+    while (mempoolUsage > limit || coinsUsage + mempoolUsage > nCoinCacheUsage + limit) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6872#discussion_r42957654",
      "id" : 42957654,
      "original_commit_id" : "2882815e3be064b1cda238035378c9b847899cf2",
      "original_position" : 12,
      "path" : "src/main.cpp",
      "position" : 12,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6872",
      "updated_at" : "2015-10-26T03:32:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/42957654",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   }
]
