[
   {
      "body" : "https://github.com/bitcoin/bitcoin/pull/6872",
      "created_at" : "2015-10-23T06:42:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/6876#issuecomment-150489970",
      "id" : 150489970,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6876",
      "updated_at" : "2015-10-23T06:42:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/150489970",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/620611?v=3",
         "events_url" : "https://api.github.com/users/pstratem/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pstratem/followers",
         "following_url" : "https://api.github.com/users/pstratem/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pstratem/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pstratem",
         "id" : 620611,
         "login" : "pstratem",
         "organizations_url" : "https://api.github.com/users/pstratem/orgs",
         "received_events_url" : "https://api.github.com/users/pstratem/received_events",
         "repos_url" : "https://api.github.com/users/pstratem/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pstratem/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pstratem"
      }
   },
   {
      "body" : "#6872 is likely unrelated. The issue seems to be something stemming from getblocktemplate-related memory usage.",
      "created_at" : "2015-10-23T09:22:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/6876#issuecomment-150525984",
      "id" : 150525984,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6876",
      "updated_at" : "2015-10-23T09:22:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/150525984",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Has anyone tried the Qt version to see if it has the same problem? \r\n\r\nAnd BTW, are the release versions (of the daemon & Qt) compiled in debug mode?\r\n\r\nLast question: can a unit test be cobbled up to test for this memory issue?\r\n\r\nRon",
      "created_at" : "2015-10-23T14:04:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/6876#issuecomment-150581313",
      "id" : 150581313,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6876",
      "updated_at" : "2015-10-23T14:04:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/150581313",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5530763?v=3",
         "events_url" : "https://api.github.com/users/older-c-coder/events{/privacy}",
         "followers_url" : "https://api.github.com/users/older-c-coder/followers",
         "following_url" : "https://api.github.com/users/older-c-coder/following{/other_user}",
         "gists_url" : "https://api.github.com/users/older-c-coder/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/older-c-coder",
         "id" : 5530763,
         "login" : "older-c-coder",
         "organizations_url" : "https://api.github.com/users/older-c-coder/orgs",
         "received_events_url" : "https://api.github.com/users/older-c-coder/received_events",
         "repos_url" : "https://api.github.com/users/older-c-coder/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/older-c-coder/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/older-c-coder/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/older-c-coder"
      }
   },
   {
      "body" : "#6872 may be related. CreateNewBlock() makes fairly extensive use of CCoinsViewCache. I ran a short (4 hour) test with valgrind --tool=massif, and CCoinsViewCache came up as using a lot of memory. A much longer test run is needed for this apparent memory leak issue to show up clearly. I'm about 24 hours into what I plan to be a 40- or 50-hour massif test. I'll post those results when I have them. It might take even longer than 50 hours for massif to get good results. it's taking 30 seconds for valgrind bitcoind to get through a getblocktemplate call, rather than the usual <= 1 sec. I don't know if the leak is related simply to the number of times GBT is called, or if it depends on the uniqueness of the mempool each time GBT is called.\r\n\r\n@older-c-coder I have not tested with Qt. A unit test would likely be difficult to write, since the issue is only apparent in terms of RSS usage after calling GBT frequently for around 24 hours. It's possible that this process might be accelerated (e.g. create a fake mempool from block X, run GBT/CNB, X++;, etc). Even then, such a test is likely to take a while, and we don't yet know if that approach will work at triggering the leak. ",
      "created_at" : "2015-10-23T20:09:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/6876#issuecomment-150677677",
      "id" : 150677677,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6876",
      "updated_at" : "2015-10-23T20:09:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/150677677",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/11898859?v=3",
         "events_url" : "https://api.github.com/users/jtoomim/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtoomim/followers",
         "following_url" : "https://api.github.com/users/jtoomim/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtoomim/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtoomim",
         "id" : 11898859,
         "login" : "jtoomim",
         "organizations_url" : "https://api.github.com/users/jtoomim/orgs",
         "received_events_url" : "https://api.github.com/users/jtoomim/received_events",
         "repos_url" : "https://api.github.com/users/jtoomim/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtoomim/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtoomim/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtoomim"
      }
   },
   {
      "body" : "There has been IRC discussion of this in bitcoin-core-dev on the [20th](https://botbot.me/freenode/bitcoin-core-dev/2015-10-20/?msg=52335129&page=1) and [21st](https://botbot.me/freenode/bitcoin-core-dev/2015-10-21/?msg=52437191&page=2).  \r\nI do not think there is an actual \"leak\".  The increased memory usage is mostly a result of the not actually limited size of CCoinsViewCache discussed in #6872 combined with poor memory allocator behavior.  \r\nThe problem is triggered by calling getblocktemplate which calls `CreateNewBlock`.  In `CreateNewBlock` every single tx in your memory pool is pulled into the in memory cache of both pcoins tip and a cache `view` on top of that.  The memory allocator also causes this memory to be allocated in a different location for every thread that calls getblocktemplate.  Although this memory is freed at the end of `CreateNewBlock`, there seems to be enough fragmentation that there is still some memory being used towards the end of the heap and the bulk of the memory can not be returned to the OS.  This can cause up to # of RPC threads (default: 4) times the memory allocation needed for 1 full memory pool worth of chainstate to remain resident.  In addition, depending on the size of your dbcache, if one of the calls to getblocktemplate causes a rehash of the unordered map in your pcoinsTip cache, then that can also take up space in another memory arena because now it has been allocated from a different thread.\r\n\r\nI'm working on a short term smaller rewrite of `CreateNewBlock` which will not require pulling the entire memory pool worth of txs into the cache, which should make the problem much better.",
      "created_at" : "2015-10-24T12:58:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/6876#issuecomment-150809590",
      "id" : 150809590,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6876",
      "updated_at" : "2015-10-24T12:58:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/150809590",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "body" : "http://toom.im/files/massif.out.27357.log\r\nOr the raw output, if you want to run ms_print on it with your own options:\r\nhttp://toom.im/files/massif.out.27357\r\n\r\n(For best viewing, disable word wrap, like with `less -S massif.out.27357.log`.)\r\n\r\nThe highest memory usage appears to be at timestamp 47. Search for \"47 68\" to jump there. It looks like at that time, a total 46.64% of the heap (411 MB) was in use by CCoinsViewCache via HTTPReq_JSONRPC and CreateNewBlock. The two offending lines in miner.cpp appear to be 175 `if (!view.HaveCoins(txin.prevout.hash))` and 348 `if (!TestBlockValidity(state, *pblock, previndexPrev, false, false))`, the latter of which results in a HaveCoins call later.",
      "created_at" : "2015-10-24T17:05:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/6876#issuecomment-150834379",
      "id" : 150834379,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6876",
      "updated_at" : "2015-10-25T17:39:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/150834379",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/11898859?v=3",
         "events_url" : "https://api.github.com/users/jtoomim/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtoomim/followers",
         "following_url" : "https://api.github.com/users/jtoomim/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtoomim/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtoomim",
         "id" : 11898859,
         "login" : "jtoomim",
         "organizations_url" : "https://api.github.com/users/jtoomim/orgs",
         "received_events_url" : "https://api.github.com/users/jtoomim/received_events",
         "repos_url" : "https://api.github.com/users/jtoomim/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtoomim/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtoomim/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtoomim"
      }
   },
   {
      "body" : "TL.DR from IRC: this seems specific to the glibc multi-thread arena memory allocator. The application deallocates the memory properly, but pages are not given back to the system after deallocation (probably due to fragmentation allocating lots of small objects). Workaround that we determined on IRC is `export MALLOC_ARENA_MAX=1`, see https://gist.github.com/laanwj/efe29c7661ce9b6620a7#linux-specific\r\n",
      "created_at" : "2015-10-26T06:59:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/6876#issuecomment-151045764",
      "id" : 151045764,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6876",
      "updated_at" : "2015-10-26T06:59:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/151045764",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Can confirm the work around works. ( export MALLOC_ARENA_MAX=1 )",
      "created_at" : "2015-10-26T23:46:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/6876#issuecomment-151315899",
      "id" : 151315899,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6876",
      "updated_at" : "2015-10-26T23:46:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/151315899",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/620611?v=3",
         "events_url" : "https://api.github.com/users/pstratem/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pstratem/followers",
         "following_url" : "https://api.github.com/users/pstratem/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pstratem/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pstratem",
         "id" : 620611,
         "login" : "pstratem",
         "organizations_url" : "https://api.github.com/users/pstratem/orgs",
         "received_events_url" : "https://api.github.com/users/pstratem/received_events",
         "repos_url" : "https://api.github.com/users/pstratem/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pstratem/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pstratem"
      }
   },
   {
      "body" : "Seems to be working for me too. 724M RSS after 10 hours. Ten hours isn't long enough to be certain. I'll chirp in tomorrow if it's still a problem.",
      "created_at" : "2015-10-27T00:02:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/6876#issuecomment-151318394",
      "id" : 151318394,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6876",
      "updated_at" : "2015-10-27T00:02:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/151318394",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/11898859?v=3",
         "events_url" : "https://api.github.com/users/jtoomim/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtoomim/followers",
         "following_url" : "https://api.github.com/users/jtoomim/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtoomim/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtoomim",
         "id" : 11898859,
         "login" : "jtoomim",
         "organizations_url" : "https://api.github.com/users/jtoomim/orgs",
         "received_events_url" : "https://api.github.com/users/jtoomim/received_events",
         "repos_url" : "https://api.github.com/users/jtoomim/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtoomim/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtoomim/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtoomim"
      }
   }
]
