[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84932213"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84932213"
         }
      },
      "body" : "Don't you need a fallback for when the chainwork is identical?",
      "commit_id" : "d0f3b607859dd9e46869aa2639d733dc129fabc4",
      "created_at" : "2016-10-25T15:35:52Z",
      "diff_hunk" : "@@ -2799,20 +2799,40 @@ static int64_t nTimeFlush = 0;\n static int64_t nTimeChainState = 0;\n static int64_t nTimePostConnect = 0;\n \n+struct CompareBlockIndexByWork {\n+    bool operator()(const CBlockIndex* a, const CBlockIndex* b) const {\n+        return a->nChainWork < b->nChainWork;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84932213",
      "id" : 84932213,
      "original_commit_id" : "d0f3b607859dd9e46869aa2639d733dc129fabc4",
      "original_position" : 6,
      "path" : "src/main.cpp",
      "position" : 6,
      "pull_request_review_id" : 5678302,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-10-25T15:35:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84932213",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84941470"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84941470"
         }
      },
      "body" : "nit: maybe do this as\r\n\r\n    it = blockTrace.mapBlocks.emplace(pindexNew, std::shared_ptr<const CBlock>(new CBlock())).first;\r\n\r\nOr\r\n\r\n    auto pblockNew = std::make_shared<CBlock>();\r\n\r\nand update following code accordingly\r\n\r\n\r\n",
      "commit_id" : "d0f3b607859dd9e46869aa2639d733dc129fabc4",
      "created_at" : "2016-10-25T16:15:57Z",
      "diff_hunk" : "@@ -2799,20 +2799,40 @@ static int64_t nTimeFlush = 0;\n static int64_t nTimeChainState = 0;\n static int64_t nTimePostConnect = 0;\n \n+struct CompareBlockIndexByWork {\n+    bool operator()(const CBlockIndex* a, const CBlockIndex* b) const {\n+        return a->nChainWork < b->nChainWork;\n+    }\n+};\n+\n+// Used in ActivateBestChain/ConnectBlock to keep track of blocks connected\n+// and notify listeners in the right order.\n+// Note that since mapBlocks is sorted lowest-work to highest-work, iterating\n+// over it will give you the order in which the blocks were connected\n+struct BlockConnectTrace {\n+    std::map<CBlockIndex*, std::shared_ptr<const CBlock>, CompareBlockIndexByWork> mapBlocks;\n+};\n+\n /**\n- * Connect a new block to chainActive. pblock is either NULL or a pointer to a CBlock\n- * corresponding to pindexNew, to bypass loading it again from disk.\n+ * Connect a new block to chainActive.\n+ * If a shared_ptr to the block for pindexNew already exists in blockTrace.mapBlocks,\n+ * we will bypass re-loading the block from disk.\n  */\n-bool static ConnectTip(CValidationState& state, const CChainParams& chainparams, CBlockIndex* pindexNew, const CBlock* pblock, std::vector<std::shared_ptr<const CTransaction>> &txConflicted, std::vector<std::tuple<CTransaction,CBlockIndex*,int>> &txChanged)\n+bool static ConnectTip(CValidationState& state, const CChainParams& chainparams, CBlockIndex* pindexNew, std::vector<std::shared_ptr<const CTransaction>> &txConflicted, BlockConnectTrace& blockTrace)\n {\n     assert(pindexNew->pprev == chainActive.Tip());\n     // Read block from disk.\n     int64_t nTime1 = GetTimeMicros();\n-    CBlock block;\n-    if (!pblock) {\n-        if (!ReadBlockFromDisk(block, pindexNew, chainparams.GetConsensus()))\n+    const CBlock *pblock;\n+    auto it = blockTrace.mapBlocks.find(pindexNew);\n+    if (it == blockTrace.mapBlocks.end()) {\n+        CBlock *pblockNew = new CBlock();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84941470",
      "id" : 84941470,
      "original_commit_id" : "d0f3b607859dd9e46869aa2639d733dc129fabc4",
      "original_position" : 37,
      "path" : "src/main.cpp",
      "position" : 37,
      "pull_request_review_id" : 5686996,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-10-25T17:10:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84941470",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84941702"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84941702"
         }
      },
      "body" : "Since its only used in each ActivateBestChainStep call individually, there is only ever one thing per given height/total work, but the map came out of an older version of the code and is now useless...so I'm replacing it with a vector.",
      "commit_id" : "d0f3b607859dd9e46869aa2639d733dc129fabc4",
      "created_at" : "2016-10-25T16:16:57Z",
      "diff_hunk" : "@@ -2799,20 +2799,40 @@ static int64_t nTimeFlush = 0;\n static int64_t nTimeChainState = 0;\n static int64_t nTimePostConnect = 0;\n \n+struct CompareBlockIndexByWork {\n+    bool operator()(const CBlockIndex* a, const CBlockIndex* b) const {\n+        return a->nChainWork < b->nChainWork;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84941702",
      "id" : 84941702,
      "original_commit_id" : "d0f3b607859dd9e46869aa2639d733dc129fabc4",
      "original_position" : 6,
      "path" : "src/main.cpp",
      "position" : 6,
      "pull_request_review_id" : 5687211,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-10-25T16:16:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84941702",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84948521"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84948521"
         }
      },
      "body" : "See other comment about using make_shared",
      "commit_id" : "d0f3b607859dd9e46869aa2639d733dc129fabc4",
      "created_at" : "2016-10-25T16:50:35Z",
      "diff_hunk" : "@@ -6023,23 +6050,24 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n \n     else if (strCommand == NetMsgType::BLOCK && !fImporting && !fReindex) // Ignore blocks received while importing\n     {\n-        CBlock block;\n-        vRecv >> block;\n+        CBlock *pblock = new CBlock();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84948521",
      "id" : 84948521,
      "original_commit_id" : "d0f3b607859dd9e46869aa2639d733dc129fabc4",
      "original_position" : 181,
      "path" : "src/main.cpp",
      "position" : 181,
      "pull_request_review_id" : 5686996,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-10-25T17:10:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84948521",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84948692"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84948692"
         }
      },
      "body" : "make_shared",
      "commit_id" : "d0f3b607859dd9e46869aa2639d733dc129fabc4",
      "created_at" : "2016-10-25T16:51:24Z",
      "diff_hunk" : "@@ -132,7 +132,8 @@ UniValue generateBlocks(boost::shared_ptr<CReserveScript> coinbaseScript, int nG\n             continue;\n         }\n         CValidationState state;\n-        if (!ProcessNewBlock(state, Params(), NULL, pblock, true, NULL))\n+        std::shared_ptr<const CBlock> shared_pblock(new CBlock(*pblock));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84948692",
      "id" : 84948692,
      "original_commit_id" : "d0f3b607859dd9e46869aa2639d733dc129fabc4",
      "original_position" : 5,
      "path" : "src/rpc/mining.cpp",
      "position" : 5,
      "pull_request_review_id" : 5686996,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-10-25T17:10:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84948692",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84948777"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84948777"
         }
      },
      "body" : "make_shared",
      "commit_id" : "d0f3b607859dd9e46869aa2639d733dc129fabc4",
      "created_at" : "2016-10-25T16:51:53Z",
      "diff_hunk" : "@@ -726,7 +727,9 @@ UniValue submitblock(const JSONRPCRequest& request)\n             + HelpExampleRpc(\"submitblock\", \"\\\"mydata\\\"\")\n         );\n \n-    CBlock block;\n+    CBlock* blockptr = new CBlock();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84948777",
      "id" : 84948777,
      "original_commit_id" : "d0f3b607859dd9e46869aa2639d733dc129fabc4",
      "original_position" : 15,
      "path" : "src/rpc/mining.cpp",
      "position" : 15,
      "pull_request_review_id" : 5686996,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-10-25T17:10:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84948777",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84948818"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84948818"
         }
      },
      "body" : "make_shared",
      "commit_id" : "d0f3b607859dd9e46869aa2639d733dc129fabc4",
      "created_at" : "2016-10-25T16:52:05Z",
      "diff_hunk" : "@@ -223,7 +223,8 @@ BOOST_AUTO_TEST_CASE(CreateNewBlock_validity)\n         pblock->hashMerkleRoot = BlockMerkleRoot(*pblock);\n         pblock->nNonce = blockinfo[i].nonce;\n         CValidationState state;\n-        BOOST_CHECK(ProcessNewBlock(state, chainparams, NULL, pblock, true, NULL));\n+        std::shared_ptr<const CBlock> shared_pblock(new CBlock(*pblock));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84948818",
      "id" : 84948818,
      "original_commit_id" : "d0f3b607859dd9e46869aa2639d733dc129fabc4",
      "original_position" : 5,
      "path" : "src/test/miner_tests.cpp",
      "position" : 5,
      "pull_request_review_id" : 5686996,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-10-25T17:10:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84948818",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84948843"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84948843"
         }
      },
      "body" : "make_shared",
      "commit_id" : "d0f3b607859dd9e46869aa2639d733dc129fabc4",
      "created_at" : "2016-10-25T16:52:13Z",
      "diff_hunk" : "@@ -127,7 +127,8 @@ TestChain100Setup::CreateAndProcessBlock(const std::vector<CMutableTransaction>&\n     while (!CheckProofOfWork(block.GetHash(), block.nBits, chainparams.GetConsensus())) ++block.nNonce;\n \n     CValidationState state;\n-    ProcessNewBlock(state, chainparams, NULL, &block, true, NULL);\n+    std::shared_ptr<const CBlock> shared_pblock(new CBlock(block));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84948843",
      "id" : 84948843,
      "original_commit_id" : "d0f3b607859dd9e46869aa2639d733dc129fabc4",
      "original_position" : 5,
      "path" : "src/test/test_bitcoin.cpp",
      "position" : 5,
      "pull_request_review_id" : 5686996,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-10-25T17:10:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84948843",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84950014"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84950014"
         }
      },
      "body" : "Semantics of passing shared_ptr by reference are a bit wonky. I think it is correct in this use case though. Perhaps it would be better for maintainability to eat the performance cost of an atomic increment and pass by value, or pass by const reference (if possible?).",
      "commit_id" : "d0f3b607859dd9e46869aa2639d733dc129fabc4",
      "created_at" : "2016-10-25T16:58:11Z",
      "diff_hunk" : "@@ -3740,7 +3766,7 @@ static bool AcceptBlock(const CBlock& block, CValidationState& state, const CCha\n     return true;\n }\n \n-bool ProcessNewBlock(CValidationState& state, const CChainParams& chainparams, CNode* pfrom, const CBlock* pblock, bool fForceProcessing, const CDiskBlockPos* dbp)\n+bool ProcessNewBlock(CValidationState& state, const CChainParams& chainparams, CNode* pfrom, std::shared_ptr<const CBlock>& pblock, bool fForceProcessing, const CDiskBlockPos* dbp)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84950014",
      "id" : 84950014,
      "original_commit_id" : "d0f3b607859dd9e46869aa2639d733dc129fabc4",
      "original_position" : 137,
      "path" : "src/main.cpp",
      "position" : 137,
      "pull_request_review_id" : 5686996,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-10-25T17:10:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84950014",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84950114"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84950114"
         }
      },
      "body" : "make_shared",
      "commit_id" : "d0f3b607859dd9e46869aa2639d733dc129fabc4",
      "created_at" : "2016-10-25T16:58:38Z",
      "diff_hunk" : "@@ -5829,7 +5855,8 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n         BlockTransactions resp;\n         vRecv >> resp;\n \n-        CBlock block;\n+        CBlock *pblock = new CBlock();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84950114",
      "id" : 84950114,
      "original_commit_id" : "d0f3b607859dd9e46869aa2639d733dc129fabc4",
      "original_position" : 146,
      "path" : "src/main.cpp",
      "position" : 146,
      "pull_request_review_id" : 5686996,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-10-25T17:10:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84950114",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84951636"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84951636"
         }
      },
      "body" : "I think it may be worthwhile for you to make this a class and keep the implementation details hidden...",
      "commit_id" : "d0f3b607859dd9e46869aa2639d733dc129fabc4",
      "created_at" : "2016-10-25T17:06:55Z",
      "diff_hunk" : "@@ -2799,20 +2799,40 @@ static int64_t nTimeFlush = 0;\n static int64_t nTimeChainState = 0;\n static int64_t nTimePostConnect = 0;\n \n+struct CompareBlockIndexByWork {\n+    bool operator()(const CBlockIndex* a, const CBlockIndex* b) const {\n+        return a->nChainWork < b->nChainWork;\n+    }\n+};\n+\n+// Used in ActivateBestChain/ConnectBlock to keep track of blocks connected\n+// and notify listeners in the right order.\n+// Note that since mapBlocks is sorted lowest-work to highest-work, iterating\n+// over it will give you the order in which the blocks were connected\n+struct BlockConnectTrace {\n+    std::map<CBlockIndex*, std::shared_ptr<const CBlock>, CompareBlockIndexByWork> mapBlocks;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84951636",
      "id" : 84951636,
      "original_commit_id" : "d0f3b607859dd9e46869aa2639d733dc129fabc4",
      "original_position" : 15,
      "path" : "src/main.cpp",
      "position" : 15,
      "pull_request_review_id" : 5686996,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-10-25T17:10:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84951636",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84953007"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84953007"
         }
      },
      "body" : "The shared_ptrs are to a const CBlock, and IIRC you cant blindly cast a shared_ptr<CBlock> to a shared_ptr<const CBlock>, but you need to access the block as non-const, and I kinda prefer this over a const_cast.",
      "commit_id" : "d0f3b607859dd9e46869aa2639d733dc129fabc4",
      "created_at" : "2016-10-25T17:13:42Z",
      "diff_hunk" : "@@ -5829,7 +5855,8 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n         BlockTransactions resp;\n         vRecv >> resp;\n \n-        CBlock block;\n+        CBlock *pblock = new CBlock();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9014#discussion_r84953007",
      "id" : 84953007,
      "original_commit_id" : "d0f3b607859dd9e46869aa2639d733dc129fabc4",
      "original_position" : 146,
      "path" : "src/main.cpp",
      "position" : 146,
      "pull_request_review_id" : 5698055,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9014",
      "updated_at" : "2016-10-25T17:13:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/84953007",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   }
]
