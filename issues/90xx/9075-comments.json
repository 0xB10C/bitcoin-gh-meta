[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9075#discussion_r86640812"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9075"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86640812"
         }
      },
      "body" : "This does not actually remove a duplicate. If there is a reorganization, and some block within it is invalid, `InvalidChainFound` will be called with the tip of the chain, rather than the block that failed. This may have an effect on the large fork detection logic.",
      "commit_id" : "9ab20862d4370bdcee15b20a9515cde3840a06df",
      "created_at" : "2016-11-04T22:05:32Z",
      "diff_hunk" : "@@ -2976,8 +2976,6 @@ static bool ActivateBestChainStep(CValidationState& state, const CChainParams& c\n             if (!ConnectTip(state, chainparams, pindexConnect, pindexConnect == pindexMostWork ? pblock : NULL, txConflicted, txChanged)) {\n                 if (state.IsInvalid()) {\n                     // The block violates a consensus rule.\n-                    if (!state.CorruptionPossible())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9075#discussion_r86640812",
      "id" : 86640812,
      "original_commit_id" : "da6ee5f4ec8a1d09484461dc740e4a375eebdd73",
      "original_position" : 4,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 7292557,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9075",
      "updated_at" : "2016-11-07T00:32:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86640812",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9075#discussion_r86650669"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9075"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86650669"
         }
      },
      "body" : "Nit: You can use std::map::emplace here to avoid two searches (the bool returned in the pair tells you whether an insert occurred or now). You could also remember the created iterator and pass it to mapBlockSource.erase below. (and likewise above)",
      "commit_id" : "9ab20862d4370bdcee15b20a9515cde3840a06df",
      "created_at" : "2016-11-04T23:48:31Z",
      "diff_hunk" : "@@ -6068,13 +6072,19 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n         // Such an unrequested block may still be processed, subject to the\n         // conditions in AcceptBlock().\n         bool forceProcessing = pfrom->fWhitelisted && !IsInitialBlockDownload();\n+        const uint256 hash(block.GetHash());\n         {\n             LOCK(cs_main);\n             // Also always process if we requested the block explicitly, as we may\n             // need it even though it is not a candidate for a new best tip.\n-            forceProcessing |= MarkBlockAsReceived(block.GetHash());\n+            forceProcessing |= MarkBlockAsReceived(hash);\n+            // mapBlockSource is only used for sending reject messages and DoS scores,\n+            // so the race between here and cs_main in ProcessNewBlock is fine.\n+            if (!mapBlockSource.count(hash))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9075#discussion_r86650669",
      "id" : 86650669,
      "original_commit_id" : "7ef1da44a9f93a4ba32cff3f5dbd7e7023456045",
      "original_position" : 69,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 7292557,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9075",
      "updated_at" : "2016-11-07T00:32:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86650669",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9075#discussion_r86652134"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9075"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86652134"
         }
      },
      "body" : "So glad to see this duplication go!",
      "commit_id" : "9ab20862d4370bdcee15b20a9515cde3840a06df",
      "created_at" : "2016-11-05T00:11:00Z",
      "diff_hunk" : "@@ -5885,27 +5889,19 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n                 fBlockRead = true;\n                 // mapBlockSource is only used for sending reject messages and DoS scores,\n                 // so the race between here and cs_main in ProcessNewBlock is fine.\n+                // BIP 152 permits peers to relay compact blocks after validating\n+                // the header only; we should not punish peers if the block turns\n+                // out to be invalid.\n                 if (!mapBlockSource.count(resp.blockhash))\n                     mapBlockSource[resp.blockhash] = std::make_pair(pfrom->GetId(), false);\n             }\n         } // Don't hold cs_main when we call into ProcessNewBlock\n         if (fBlockRead) {\n-            CValidationState state;\n             bool fNewBlock = false;\n             // Since we requested this block (it was in mapBlocksInFlight), force it to be processed,\n             // even if it would not be a candidate for new tip (missing previous block, chain not long enough, etc)\n-            // BIP 152 permits peers to relay compact blocks after validating\n-            // the header only; we should not punish peers if the block turns\n-            // out to be invalid.\n-            ProcessNewBlock(state, chainparams, &block, true, NULL, &fNewBlock);\n-            int nDoS;\n-            if (state.IsInvalid(nDoS)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9075#discussion_r86652134",
      "id" : 86652134,
      "original_commit_id" : "5f0c20b72f8da2d121cb178bd140a27ad53beb9e",
      "original_position" : 50,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 7292557,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9075",
      "updated_at" : "2016-11-07T00:32:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86652134",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9075#discussion_r86700955"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9075"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86700955"
         }
      },
      "body" : "Eek! Youre right. Just removed the commit...it wasnt important anyway.",
      "commit_id" : "9ab20862d4370bdcee15b20a9515cde3840a06df",
      "created_at" : "2016-11-07T00:16:12Z",
      "diff_hunk" : "@@ -2976,8 +2976,6 @@ static bool ActivateBestChainStep(CValidationState& state, const CChainParams& c\n             if (!ConnectTip(state, chainparams, pindexConnect, pindexConnect == pindexMostWork ? pblock : NULL, txConflicted, txChanged)) {\n                 if (state.IsInvalid()) {\n                     // The block violates a consensus rule.\n-                    if (!state.CorruptionPossible())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9075#discussion_r86700955",
      "id" : 86700955,
      "original_commit_id" : "da6ee5f4ec8a1d09484461dc740e4a375eebdd73",
      "original_position" : 4,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 7345425,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9075",
      "updated_at" : "2016-11-07T00:32:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86700955",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9075#discussion_r86701402"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9075"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86701402"
         }
      },
      "body" : "Fixed",
      "commit_id" : "9ab20862d4370bdcee15b20a9515cde3840a06df",
      "created_at" : "2016-11-07T00:32:28Z",
      "diff_hunk" : "@@ -6068,13 +6072,19 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n         // Such an unrequested block may still be processed, subject to the\n         // conditions in AcceptBlock().\n         bool forceProcessing = pfrom->fWhitelisted && !IsInitialBlockDownload();\n+        const uint256 hash(block.GetHash());\n         {\n             LOCK(cs_main);\n             // Also always process if we requested the block explicitly, as we may\n             // need it even though it is not a candidate for a new best tip.\n-            forceProcessing |= MarkBlockAsReceived(block.GetHash());\n+            forceProcessing |= MarkBlockAsReceived(hash);\n+            // mapBlockSource is only used for sending reject messages and DoS scores,\n+            // so the race between here and cs_main in ProcessNewBlock is fine.\n+            if (!mapBlockSource.count(hash))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9075#discussion_r86701402",
      "id" : 86701402,
      "original_commit_id" : "7ef1da44a9f93a4ba32cff3f5dbd7e7023456045",
      "original_position" : 69,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_review_id" : 7345816,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9075",
      "updated_at" : "2016-11-07T00:32:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/86701402",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   }
]
