[
   {
      "author_association" : "NONE",
      "body" : "Doesn't make any difference in rounding down or up the fee. Paying one satoshi more or less doesn't even matter at all since a satoshi is basically worthless. \r\n\r\n> It is unlikely that a user can trigger this as it requires a very specific set of rounding errors to occur as well as the transaction not needing any change and being right on the lower bound of the exact match window. However I was able to trigger the assertion while running coin selection simulations, albeit after thousands of transactions and with some weird feerates.\r\n\r\nThis pr shouldn't be merged. Even op acknowledged that the end user is unlikely to face any issue like he did in his simulations.\r\n",
      "created_at" : "2021-09-11T11:26:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22949#issuecomment-917390481",
      "id" : 917390481,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22949",
      "node_id" : "IC_kwDOABII5842rkSR",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-11T11:26:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/917390481",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/90217294?v=4",
         "events_url" : "https://api.github.com/users/bitcoin-public-domain/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bitcoin-public-domain/followers",
         "following_url" : "https://api.github.com/users/bitcoin-public-domain/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bitcoin-public-domain/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bitcoin-public-domain",
         "id" : 90217294,
         "login" : "bitcoin-public-domain",
         "node_id" : "MDQ6VXNlcjkwMjE3Mjk0",
         "organizations_url" : "https://api.github.com/users/bitcoin-public-domain/orgs",
         "received_events_url" : "https://api.github.com/users/bitcoin-public-domain/received_events",
         "repos_url" : "https://api.github.com/users/bitcoin-public-domain/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bitcoin-public-domain/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bitcoin-public-domain/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bitcoin-public-domain"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "It seems odd to me that the wallet and policy should have different fee calculation results for the same transaction.\r\n\r\nIn terms of pre-signed transactions, what security implications do you imagine? I don't think it is possible for this to cause a transaction's feerate to fall below the default minimum relay fee because the result of the fee calculation at the minimum relay fee is always an integer since the minimum relay fee is an integer. I believe the same is true for the incremental relay fee and how that calculation works.",
      "created_at" : "2021-09-12T00:01:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22949#issuecomment-917506157",
      "id" : 917506157,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22949",
      "node_id" : "IC_kwDOABII5842sAht",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-12T00:01:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/917506157",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : ">  I believe the same is true for the incremental relay fee and how that calculation works.\r\n\r\nI don't think it's true in all cases. Take clawback tx A with fee such as it would be rounded up after this PR, not before. The application wants to replace it with clawback tx B with fee equal to `A's fee + incremental relay fee` such as it would not be rounded up.\r\nBefore this PR tx B would be accepted, after it would be refused.\r\n\r\nOf course it'd be reckless for such an application to not take some leeway in addition to the incremental fee here, but still this PR would be a behaviour change for this edge case.",
      "created_at" : "2021-09-12T14:12:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22949#issuecomment-917644192",
      "id" : 917644192,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22949",
      "node_id" : "IC_kwDOABII5842siOg",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-12T14:12:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/917644192",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I don't think it's true in all cases. Take clawback tx A with fee such as it would be rounded up after this PR, not before. The application wants to replace it with clawback tx B with fee equal to `A's fee + incremental relay fee` such as it would not be rounded up.\r\n> Before this PR tx B would be accepted, after it would be refused.\r\n\r\nHow so? Can you provide a example? I can't think of how that would happen. `CFeeRate::GetFee` is never called on the original feerate in validation, and the calculation of a feerate for a transaction is not changed by this PR.\r\n\r\nConsider the example I give in the test: tx A is a 1-in-1-out 110 vbyte tx that pays a feerate of 1.85 sat/vbyte for an absolute fee if 203.5 sats. With rounding down, A will pay 203 sats. We replace this with tx B where the only thing different is the output, but it is of the same type so the size remains the same. Paying the incremental relay fee should be enough for B to replace A. The incremental feerate is 1 sat/vbyte, so regardless of rounding, it is always 110 sats. So B pays 313 sats.\r\n\r\nWhen validating whether B is allowed to replace A, it needs to pass two fee related checks: [`PaysMoreThanConflicts`](https://github.com/bitcoin/bitcoin/blob/master/src/policy/rbf.cpp#L124) (called [here](https://github.com/bitcoin/bitcoin/blob/master/src/validation.cpp#L785)) and [`PaysForRBF`](https://github.com/bitcoin/bitcoin/blob/master/src/policy/rbf.cpp#L150) (called [here](https://github.com/bitcoin/bitcoin/blob/master/src/validation.cpp#L806)). `PaysMoreThanConflicts` computes the feerates for A and B and just checks that B's feerate is greater than A's. The rounding of computing the feerate given the fee paid and size **did not change**, so both before and after this PR, the calculation for A is `203 * 1000 / 110 = 1845`. The calculation for B is `313 * 1000 / 110 = 2845`. B's feerate is greater than A's, so this check passes, both before and after this PR. `PaysForRBF` checks that the fees for B is greater than A. Then it checks that the difference is not less than the incremental relay fee. Because the incremental relay fee is an integer, the calculation before and after this PR is the same - 110 sats.\r\n\r\nAt no point in this checking process is the original feerate of 1.85 sats/vbyte used because validation does not know that was the original targeted feerate. The only times where validation calls `CFeeRate::GetFee` is to calculate the fee at the minimum relay feerate and the incremental relay feerate, both of which have integers as their default, so their calculations do not change. So I don't see how this change would have any effect on whether transactions are accepted.",
      "created_at" : "2021-09-12T16:45:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22949#issuecomment-917669901",
      "id" : 917669901,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22949",
      "node_id" : "IC_kwDOABII5842sogN",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-12T16:45:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/917669901",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   }
]
