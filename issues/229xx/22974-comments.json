[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "cc @vasild ",
      "created_at" : "2021-09-14T17:55:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22974#issuecomment-919384556",
      "id" : 919384556,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22974",
      "node_id" : "IC_kwDOABII5842zLHs",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-14T17:55:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/919384556",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Nice code reduction.  Did you see a difference in `./src/bench/bench_bitcoin -filter=AddrManGood`?",
      "created_at" : "2021-09-14T18:31:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22974#issuecomment-919411617",
      "id" : 919411617,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22974",
      "node_id" : "IC_kwDOABII5842zRuh",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-14T18:31:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/919411617",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22974#discussion_r708530751"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22974"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/708530751"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in general: clang-format, and where useful consider const, and braced initialization for type safety\r\n```suggestion\r\n        const int bucket{(start_bucket + n) % ADDRMAN_NEW_BUCKET_COUNT};\r\n```",
      "commit_id" : "527641b9e6e2d0f9aab98474c06d1e1eb7963d0a",
      "created_at" : "2021-09-14T18:33:43Z",
      "diff_hunk" : "@@ -486,11 +486,14 @@ void CAddrMan::MakeTried(CAddrInfo& info, int nId)\n     AssertLockHeld(cs);\n \n     // remove the entry from all new buckets\n-    for (int bucket = 0; bucket < ADDRMAN_NEW_BUCKET_COUNT; bucket++) {\n+    int start_bucket = info.GetNewBucket(nKey, m_asmap);\n+    for (int n = 0; n < ADDRMAN_NEW_BUCKET_COUNT; n++) {\n+        int bucket = (start_bucket + n ) % ADDRMAN_NEW_BUCKET_COUNT;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22974#discussion_r708530751",
      "id" : 708530751,
      "line" : 491,
      "node_id" : "PRRC_kwDOABII584qO1I_",
      "original_commit_id" : "527641b9e6e2d0f9aab98474c06d1e1eb7963d0a",
      "original_line" : 491,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : 7,
      "pull_request_review_id" : 754295332,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22974",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-14T18:41:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/708530751",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22974#discussion_r708532028"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22974"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/708532028"
         }
      },
      "author_association" : "MEMBER",
      "body" : "prefer prefix iterator where postfix isn't needed (per developer-notes.md)\r\n```suggestion\r\n    for (int n = 0; n < ADDRMAN_NEW_BUCKET_COUNT; ++n) {\r\n```",
      "commit_id" : "527641b9e6e2d0f9aab98474c06d1e1eb7963d0a",
      "created_at" : "2021-09-14T18:35:32Z",
      "diff_hunk" : "@@ -486,11 +486,14 @@ void CAddrMan::MakeTried(CAddrInfo& info, int nId)\n     AssertLockHeld(cs);\n \n     // remove the entry from all new buckets\n-    for (int bucket = 0; bucket < ADDRMAN_NEW_BUCKET_COUNT; bucket++) {\n+    int start_bucket = info.GetNewBucket(nKey, m_asmap);\n+    for (int n = 0; n < ADDRMAN_NEW_BUCKET_COUNT; n++) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22974#discussion_r708532028",
      "id" : 708532028,
      "line" : 490,
      "node_id" : "PRRC_kwDOABII584qO1c8",
      "original_commit_id" : "527641b9e6e2d0f9aab98474c06d1e1eb7963d0a",
      "original_line" : 490,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : 6,
      "pull_request_review_id" : 754295332,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22974",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-14T18:41:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/708532028",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22974#discussion_r708533494"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22974"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/708533494"
         }
      },
      "author_association" : "MEMBER",
      "body" : "while touching this conditional, maybe add the missing brackets we require with conditionals of more than one line (CVE-2014-1266: the Apple \"goto fail\" vulnerability, https://dwheeler.com/essays/apple-goto-fail)\r\n",
      "commit_id" : "527641b9e6e2d0f9aab98474c06d1e1eb7963d0a",
      "created_at" : "2021-09-14T18:37:47Z",
      "diff_hunk" : "@@ -562,21 +565,8 @@ void CAddrMan::Good_(const CService& addr, bool test_before_evict, int64_t nTime\n     if (info.fInTried)\n         return;\n \n-    // find a bucket it is in now\n-    int nRnd = insecure_rand.randrange(ADDRMAN_NEW_BUCKET_COUNT);\n-    int nUBucket = -1;\n-    for (unsigned int n = 0; n < ADDRMAN_NEW_BUCKET_COUNT; n++) {\n-        int nB = (n + nRnd) % ADDRMAN_NEW_BUCKET_COUNT;\n-        int nBpos = info.GetBucketPosition(nKey, true, nB);\n-        if (vvNew[nB][nBpos] == nId) {\n-            nUBucket = nB;\n-            break;\n-        }\n-    }\n-\n-    // if no bucket is found, something bad happened;\n-    // TODO: maybe re-add the node, but for now, just bail out\n-    if (nUBucket == -1)\n+    // if it is not in new, something bad happened\n+    if (info.nRefCount == 0)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22974#discussion_r708533494",
      "id" : 708533494,
      "line" : 569,
      "node_id" : "PRRC_kwDOABII584qO1z2",
      "original_commit_id" : "527641b9e6e2d0f9aab98474c06d1e1eb7963d0a",
      "original_line" : 569,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : 36,
      "pull_request_review_id" : 754295332,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22974",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-14T18:41:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/708533494",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#22950](https://github.com/bitcoin/bitcoin/pull/22950) ([p2p] Pimpl AddrMan to abstract implementation details by amitiuttarwar)\n* [#22910](https://github.com/bitcoin/bitcoin/pull/22910) ([RFC] Encapsulate asmap in NetGroupManager by jnewbery)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-09-14T18:40:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22974#issuecomment-919417960",
      "id" : 919417960,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22974",
      "node_id" : "IC_kwDOABII5842zTRo",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-14T18:40:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/919417960",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK. Benches are showing a huge speedup for me locally.\r\n\r\nbefore\r\n```\r\n$ ./src/bench/bench_bitcoin -filter=AddrManGood\r\n\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|      801,906,990.00 |                1.25 |    5.7% |      4.26 | AddrManGood\r\n|      814,159,543.00 |                1.23 |    6.4% |      4.03 | AddrManGood\r\n|      775,065,136.00 |                1.29 |    3.5% |      3.82 | AddrManGood\r\n|      795,855,140.00 |                1.26 |    6.8% |      3.98 | AddrManGood\r\n|      763,767,446.00 |                1.31 |    1.7% |      3.93 | AddrManGood\r\n|      778,016,971.00 |                1.29 |    2.9% |      4.03 | AddrManGood\r\n|      839,720,704.00 |                1.19 |    8.6% |      4.22 | AddrManGood\r\n|      777,639,920.00 |                1.29 |    1.8% |      3.92 | AddrManGood\r\n|      788,152,208.00 |                1.27 |    3.8% |      3.89 | AddrManGood\r\n|      792,925,660.00 |                1.26 |    3.2% |      3.99 | AddrManGood\r\n```\r\n\r\nafter\r\n```\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|        5,182,474.00 |              192.96 |   13.8% |      0.03 | AddrManGood\r\n|        5,525,509.00 |              180.98 |   14.6% |      0.03 | AddrManGood\r\n|        7,215,235.00 |              138.60 |    3.7% |      0.04 | AddrManGood\r\n|        5,219,675.00 |              191.58 |    7.5% |      0.03 | AddrManGood\r\n|        4,163,823.00 |              240.16 |    2.3% |      0.02 | AddrManGood\r\n|        6,694,095.00 |              149.39 |   23.0% |      0.05 | AddrManGood\r\n|        5,966,011.00 |              167.62 |   11.0% |      0.03 | AddrManGood\r\n|        4,861,261.00 |              205.71 |    3.6% |      0.03 | AddrManGood\r\n|        5,029,188.00 |              198.84 |   16.4% |      0.03 | AddrManGood\r\n|        5,440,878.00 |              183.79 |   13.1% |      0.03 | AddrManGood\r\n```\r\n",
      "created_at" : "2021-09-14T19:04:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22974#issuecomment-919435266",
      "id" : 919435266,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22974",
      "node_id" : "IC_kwDOABII5842zXgC",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-14T19:04:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/919435266",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks! I didn't know about this benchmark, will try to confirm locally and add the result to OP!",
      "created_at" : "2021-09-14T19:09:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22974#issuecomment-919438590",
      "id" : 919438590,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22974",
      "node_id" : "IC_kwDOABII5842zYT-",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-14T19:09:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/919438590",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   }
]
