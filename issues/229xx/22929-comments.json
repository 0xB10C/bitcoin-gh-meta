[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#23019](https://github.com/bitcoin/bitcoin/pull/23019) (rpc, wallet: Add listaddresses RPC by lsilva01)\n* [#22693](https://github.com/bitcoin/bitcoin/pull/22693) (RPC/Wallet: Add \"use_txids\" to output of getaddressinfo by luke-jr)\n* [#20591](https://github.com/bitcoin/bitcoin/pull/20591) (wallet, bugfix: fix ComputeTimeSmart function during rescanning process. by BitcoinTsunami)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-09-09T12:48:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22929#issuecomment-916060454",
      "id" : 916060454,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22929",
      "node_id" : "IC_kwDOABII5842mfkm",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-21T08:14:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/916060454",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r710464748"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710464748"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In fec5ded232ca37b8a965ce09a3940ccb6ce43249 \"Return used destinations from ScriptPubKeyMan::MarkUnusedAddresses\"\r\n\r\ntypo: makr - > mark\r\n\r\n```suggestion\r\n     * @param keypool_id determines the last key to mark as used\r\n```",
      "commit_id" : "aa7e4381ac838be7422112b41ff38b30b685454f",
      "created_at" : "2021-09-16T20:45:34Z",
      "diff_hunk" : "@@ -481,9 +493,13 @@ class LegacyScriptPubKeyMan : public ScriptPubKeyMan, public FillableSigningProv\n     void LearnAllRelatedScripts(const CPubKey& key);\n \n     /**\n-     * Marks all keys in the keypool up to and including reserve_key as used.\n+     * Marks all keys in the keypool up to and including the provided key as used.\n+     *\n+     * @param keypool_id determines the last key to makr as used",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r710464748",
      "id" : 710464748,
      "line" : 498,
      "node_id" : "PRRC_kwDOABII584qWNTs",
      "original_commit_id" : "fec5ded232ca37b8a965ce09a3940ccb6ce43249",
      "original_line" : 498,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : 46,
      "pull_request_review_id" : 756785367,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-16T20:58:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710464748",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r710466168"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710466168"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In fec5ded232ca37b8a965ce09a3940ccb6ce43249 \"Return used destinations from ScriptPubKeyMan::MarkUnusedAddresses\"\r\n\r\nnit: space before `:`\r\n\r\n```suggestion\r\n                for (const auto& type : LEGACY_OUTPUT_TYPES) {\r\n```",
      "commit_id" : "aa7e4381ac838be7422112b41ff38b30b685454f",
      "created_at" : "2021-09-16T20:47:04Z",
      "diff_hunk" : "@@ -354,15 +354,22 @@ bool LegacyScriptPubKeyMan::TopUpInactiveHDChain(const CKeyID seed_id, int64_t i\n     return true;\n }\n \n-void LegacyScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n+std::vector<WalletDestination> LegacyScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n {\n     LOCK(cs_KeyStore);\n+    std::vector<WalletDestination> result;\n     // extract addresses and check if they match with an unused keypool key\n     for (const auto& keyid : GetAffectedKeys(script, *this)) {\n         std::map<CKeyID, int64_t>::const_iterator mi = m_pool_key_to_index.find(keyid);\n         if (mi != m_pool_key_to_index.end()) {\n             WalletLogPrintf(\"%s: Detected a used keypool key, mark all keypool keys up to this key as used\\n\", __func__);\n-            MarkReserveKeysAsUsed(mi->second);\n+            for (const auto& keypool : MarkReserveKeysAsUsed(mi->second)) {\n+                // derive all possible destinations as any of them could have been used\n+                for (const auto& type: LEGACY_OUTPUT_TYPES) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r710466168",
      "id" : 710466168,
      "line" : 368,
      "node_id" : "PRRC_kwDOABII584qWNp4",
      "original_commit_id" : "fec5ded232ca37b8a965ce09a3940ccb6ce43249",
      "original_line" : 368,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 17,
      "pull_request_review_id" : 756785367,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-16T20:58:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710466168",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r710472000"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710472000"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In cbb90fbc00e345100587cd47926c6c7fc5487628 \"Automatically add labels to detected receiving addresses\"\r\n\r\nShouldn't we be marking everything that doesn't have `dest.internal` as a receiving address? i.e.\r\n\r\n```suggestion\r\n                   if (!dest.internal.value_or(false) && !FindAddressBookEntry(dest.dest, /* allow_change= */ false)) {\r\n```",
      "commit_id" : "aa7e4381ac838be7422112b41ff38b30b685454f",
      "created_at" : "2021-09-16T20:53:24Z",
      "diff_hunk" : "@@ -1059,7 +1059,19 @@ bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef& ptx, CWalletTx::Co\n             for (const CTxOut& txout: tx.vout) {\n                 const auto& spk_man = GetScriptPubKeyMan(txout.scriptPubKey);\n                 if (!spk_man) continue;\n-                spk_man->MarkUnusedAddresses(txout.scriptPubKey);\n+                for (auto& dest : spk_man->MarkUnusedAddresses(txout.scriptPubKey)) {\n+                    // If internal flag is not defined try to infer it from the ScriptPubKeyMan\n+                    if (!dest.internal.has_value()) {\n+                        dest.internal = IsInternalScriptPubKeyMan(spk_man);\n+                    }\n+\n+                    // If this is a receiving address and it's not in the address book yet\n+                    // (e.g. it wasn't generated on this node or we're restoring from backup)\n+                    // add it to the address book for proper transaction accounting\n+                    if (!dest.internal.value_or(true) && !FindAddressBookEntry(dest.dest, /* allow_change= */ false)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r710472000",
      "id" : 710472000,
      "line" : 1073,
      "node_id" : "PRRC_kwDOABII584qWPFA",
      "original_commit_id" : "cbb90fbc00e345100587cd47926c6c7fc5487628",
      "original_line" : 1071,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 28,
      "pull_request_review_id" : 756785367,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-16T20:58:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710472000",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r711910861"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711910861"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "c97c2a99bf5aed073cc28967c5d47a33ec618752",
      "created_at" : "2021-09-20T06:48:02Z",
      "diff_hunk" : "@@ -481,9 +493,13 @@ class LegacyScriptPubKeyMan : public ScriptPubKeyMan, public FillableSigningProv\n     void LearnAllRelatedScripts(const CPubKey& key);\n \n     /**\n-     * Marks all keys in the keypool up to and including reserve_key as used.\n+     * Marks all keys in the keypool up to and including the provided key as used.\n+     *\n+     * @param keypool_id determines the last key to makr as used",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r711910861",
      "id" : 711910861,
      "in_reply_to_id" : 710464748,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584qbuXN",
      "original_commit_id" : "fec5ded232ca37b8a965ce09a3940ccb6ce43249",
      "original_line" : 498,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : null,
      "pull_request_review_id" : 758292045,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-20T06:48:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711910861",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r711910903"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711910903"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "c97c2a99bf5aed073cc28967c5d47a33ec618752",
      "created_at" : "2021-09-20T06:48:09Z",
      "diff_hunk" : "@@ -354,15 +354,22 @@ bool LegacyScriptPubKeyMan::TopUpInactiveHDChain(const CKeyID seed_id, int64_t i\n     return true;\n }\n \n-void LegacyScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n+std::vector<WalletDestination> LegacyScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n {\n     LOCK(cs_KeyStore);\n+    std::vector<WalletDestination> result;\n     // extract addresses and check if they match with an unused keypool key\n     for (const auto& keyid : GetAffectedKeys(script, *this)) {\n         std::map<CKeyID, int64_t>::const_iterator mi = m_pool_key_to_index.find(keyid);\n         if (mi != m_pool_key_to_index.end()) {\n             WalletLogPrintf(\"%s: Detected a used keypool key, mark all keypool keys up to this key as used\\n\", __func__);\n-            MarkReserveKeysAsUsed(mi->second);\n+            for (const auto& keypool : MarkReserveKeysAsUsed(mi->second)) {\n+                // derive all possible destinations as any of them could have been used\n+                for (const auto& type: LEGACY_OUTPUT_TYPES) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r711910903",
      "id" : 711910903,
      "in_reply_to_id" : 710466168,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584qbuX3",
      "original_commit_id" : "fec5ded232ca37b8a965ce09a3940ccb6ce43249",
      "original_line" : 368,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 758292090,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-20T06:48:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711910903",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r711911667"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711911667"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I want to be conservative and skip if we can't determine if that's a change or a receiving destination. But the code is not obvious and I restructured it to make it explicit.",
      "commit_id" : "c97c2a99bf5aed073cc28967c5d47a33ec618752",
      "created_at" : "2021-09-20T06:49:46Z",
      "diff_hunk" : "@@ -1059,7 +1059,19 @@ bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef& ptx, CWalletTx::Co\n             for (const CTxOut& txout: tx.vout) {\n                 const auto& spk_man = GetScriptPubKeyMan(txout.scriptPubKey);\n                 if (!spk_man) continue;\n-                spk_man->MarkUnusedAddresses(txout.scriptPubKey);\n+                for (auto& dest : spk_man->MarkUnusedAddresses(txout.scriptPubKey)) {\n+                    // If internal flag is not defined try to infer it from the ScriptPubKeyMan\n+                    if (!dest.internal.has_value()) {\n+                        dest.internal = IsInternalScriptPubKeyMan(spk_man);\n+                    }\n+\n+                    // If this is a receiving address and it's not in the address book yet\n+                    // (e.g. it wasn't generated on this node or we're restoring from backup)\n+                    // add it to the address book for proper transaction accounting\n+                    if (!dest.internal.value_or(true) && !FindAddressBookEntry(dest.dest, /* allow_change= */ false)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r711911667",
      "id" : 711911667,
      "in_reply_to_id" : 710472000,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584qbujz",
      "original_commit_id" : "cbb90fbc00e345100587cd47926c6c7fc5487628",
      "original_line" : 1071,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 758292996,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-20T06:49:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711911667",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK c97c2a99bf5aed073cc28967c5d47a33ec618752",
      "created_at" : "2021-09-24T20:23:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22929#issuecomment-926898556",
      "id" : 926898556,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22929",
      "node_id" : "IC_kwDOABII5843P1l8",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-24T20:23:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/926898556",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r719146825"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719146825"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@achow101 I believe expanding from cache is enough here. But want to confirm.",
      "commit_id" : "a438bcc7e2cb8c36bfc5d1bc28903f899249549b",
      "created_at" : "2021-09-30T07:48:44Z",
      "diff_hunk" : "@@ -1820,19 +1833,32 @@ bool DescriptorScriptPubKeyMan::TopUp(unsigned int size)\n     return true;\n }\n \n-void DescriptorScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n+std::vector<WalletDestination> DescriptorScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n {\n     LOCK(cs_desc_man);\n+    std::vector<WalletDestination> result;\n     if (IsMine(script)) {\n         int32_t index = m_map_script_pub_keys[script];\n         if (index >= m_wallet_descriptor.next_index) {\n             WalletLogPrintf(\"%s: Detected a used keypool item at index %d, mark all keypool items up to this item as used\\n\", __func__, index);\n-            m_wallet_descriptor.next_index = index + 1;\n+            auto out_keys = std::make_unique<FlatSigningProvider>();\n+            std::vector<CScript> scripts_temp;\n+            while (index >= m_wallet_descriptor.next_index) {\n+                if (!m_wallet_descriptor.descriptor->ExpandFromCache(m_wallet_descriptor.next_index, m_wallet_descriptor.cache, scripts_temp, *out_keys)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r719146825",
      "id" : 719146825,
      "line" : 1847,
      "node_id" : "PRRC_kwDOABII584q3U9J",
      "original_commit_id" : "a438bcc7e2cb8c36bfc5d1bc28903f899249549b",
      "original_line" : 1847,
      "original_position" : 79,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 79,
      "pull_request_review_id" : 767510226,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-30T07:48:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719146825",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r719149474"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719149474"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@achow101 I think it's technically possible to have two descriptors producing same scriptPubKey. Wdyt?",
      "commit_id" : "a438bcc7e2cb8c36bfc5d1bc28903f899249549b",
      "created_at" : "2021-09-30T07:51:55Z",
      "diff_hunk" : "@@ -1062,8 +1064,23 @@ bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef& ptx, CWalletTx::Co\n \n             // loop though all outputs\n             for (const CTxOut& txout: tx.vout) {\n-                for (const auto& spk_man_pair : m_spk_managers) {\n-                    spk_man_pair.second->MarkUnusedAddresses(txout.scriptPubKey);\n+                const auto& spk_man = GetScriptPubKeyMan(txout.scriptPubKey);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r719149474",
      "id" : 719149474,
      "line" : 1067,
      "node_id" : "PRRC_kwDOABII584q3Vmi",
      "original_commit_id" : "a438bcc7e2cb8c36bfc5d1bc28903f899249549b",
      "original_line" : 1067,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 17,
      "pull_request_review_id" : 767513414,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-30T07:51:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719149474",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   }
]
