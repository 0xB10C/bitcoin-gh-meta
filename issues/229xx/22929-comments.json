[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r710464748"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710464748"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In fec5ded232ca37b8a965ce09a3940ccb6ce43249 \"Return used destinations from ScriptPubKeyMan::MarkUnusedAddresses\"\r\n\r\ntypo: makr - > mark\r\n\r\n```suggestion\r\n     * @param keypool_id determines the last key to mark as used\r\n```",
      "commit_id" : "aa7e4381ac838be7422112b41ff38b30b685454f",
      "created_at" : "2021-09-16T20:45:34Z",
      "diff_hunk" : "@@ -481,9 +493,13 @@ class LegacyScriptPubKeyMan : public ScriptPubKeyMan, public FillableSigningProv\n     void LearnAllRelatedScripts(const CPubKey& key);\n \n     /**\n-     * Marks all keys in the keypool up to and including reserve_key as used.\n+     * Marks all keys in the keypool up to and including the provided key as used.\n+     *\n+     * @param keypool_id determines the last key to makr as used",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r710464748",
      "id" : 710464748,
      "line" : 498,
      "node_id" : "PRRC_kwDOABII584qWNTs",
      "original_commit_id" : "fec5ded232ca37b8a965ce09a3940ccb6ce43249",
      "original_line" : 498,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : 46,
      "pull_request_review_id" : 756785367,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-16T20:58:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710464748",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r710466168"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710466168"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In fec5ded232ca37b8a965ce09a3940ccb6ce43249 \"Return used destinations from ScriptPubKeyMan::MarkUnusedAddresses\"\r\n\r\nnit: space before `:`\r\n\r\n```suggestion\r\n                for (const auto& type : LEGACY_OUTPUT_TYPES) {\r\n```",
      "commit_id" : "aa7e4381ac838be7422112b41ff38b30b685454f",
      "created_at" : "2021-09-16T20:47:04Z",
      "diff_hunk" : "@@ -354,15 +354,22 @@ bool LegacyScriptPubKeyMan::TopUpInactiveHDChain(const CKeyID seed_id, int64_t i\n     return true;\n }\n \n-void LegacyScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n+std::vector<WalletDestination> LegacyScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n {\n     LOCK(cs_KeyStore);\n+    std::vector<WalletDestination> result;\n     // extract addresses and check if they match with an unused keypool key\n     for (const auto& keyid : GetAffectedKeys(script, *this)) {\n         std::map<CKeyID, int64_t>::const_iterator mi = m_pool_key_to_index.find(keyid);\n         if (mi != m_pool_key_to_index.end()) {\n             WalletLogPrintf(\"%s: Detected a used keypool key, mark all keypool keys up to this key as used\\n\", __func__);\n-            MarkReserveKeysAsUsed(mi->second);\n+            for (const auto& keypool : MarkReserveKeysAsUsed(mi->second)) {\n+                // derive all possible destinations as any of them could have been used\n+                for (const auto& type: LEGACY_OUTPUT_TYPES) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r710466168",
      "id" : 710466168,
      "line" : 368,
      "node_id" : "PRRC_kwDOABII584qWNp4",
      "original_commit_id" : "fec5ded232ca37b8a965ce09a3940ccb6ce43249",
      "original_line" : 368,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 17,
      "pull_request_review_id" : 756785367,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-16T20:58:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710466168",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r710472000"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710472000"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In cbb90fbc00e345100587cd47926c6c7fc5487628 \"Automatically add labels to detected receiving addresses\"\r\n\r\nShouldn't we be marking everything that doesn't have `dest.internal` as a receiving address? i.e.\r\n\r\n```suggestion\r\n                   if (!dest.internal.value_or(false) && !FindAddressBookEntry(dest.dest, /* allow_change= */ false)) {\r\n```",
      "commit_id" : "aa7e4381ac838be7422112b41ff38b30b685454f",
      "created_at" : "2021-09-16T20:53:24Z",
      "diff_hunk" : "@@ -1059,7 +1059,19 @@ bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef& ptx, CWalletTx::Co\n             for (const CTxOut& txout: tx.vout) {\n                 const auto& spk_man = GetScriptPubKeyMan(txout.scriptPubKey);\n                 if (!spk_man) continue;\n-                spk_man->MarkUnusedAddresses(txout.scriptPubKey);\n+                for (auto& dest : spk_man->MarkUnusedAddresses(txout.scriptPubKey)) {\n+                    // If internal flag is not defined try to infer it from the ScriptPubKeyMan\n+                    if (!dest.internal.has_value()) {\n+                        dest.internal = IsInternalScriptPubKeyMan(spk_man);\n+                    }\n+\n+                    // If this is a receiving address and it's not in the address book yet\n+                    // (e.g. it wasn't generated on this node or we're restoring from backup)\n+                    // add it to the address book for proper transaction accounting\n+                    if (!dest.internal.value_or(true) && !FindAddressBookEntry(dest.dest, /* allow_change= */ false)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r710472000",
      "id" : 710472000,
      "line" : 1073,
      "node_id" : "PRRC_kwDOABII584qWPFA",
      "original_commit_id" : "cbb90fbc00e345100587cd47926c6c7fc5487628",
      "original_line" : 1071,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 28,
      "pull_request_review_id" : 756785367,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-16T20:58:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710472000",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   }
]
