[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#23053](https://github.com/bitcoin/bitcoin/pull/23053) ([fuzz] Use public methods in addrman fuzz tests by jnewbery)\n* [#22976](https://github.com/bitcoin/bitcoin/pull/22976) (scripted-diff: Rename overloaded int GetArg to GetIntArg by ryanofsky)\n* [#22937](https://github.com/bitcoin/bitcoin/pull/22937) (refactor: Forbid calling unsafe fs::path(std::string) constructor and fs::path::string() method by ryanofsky)\n* [#22872](https://github.com/bitcoin/bitcoin/pull/22872) (log: improve checkaddrman logging with duration in milliseconds by jonatack)\n* [#22839](https://github.com/bitcoin/bitcoin/pull/22839) (log: improve addrman logging by mzumsande)\n* [#22508](https://github.com/bitcoin/bitcoin/pull/22508) (fuzz: replace every fuzzer-controlled while loop with a macro by apoelstra)\n* [#20295](https://github.com/bitcoin/bitcoin/pull/20295) (rpc: getblockfrompeer by Sjors)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-09-11T14:56:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#issuecomment-917420738",
      "id" : 917420738,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22950",
      "node_id" : "IC_kwDOABII5842rrrC",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-25T17:36:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/917420738",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Fixed the [lint failure](https://cirrus-ci.com/task/5301111516037120) that was caused by the circular dependencies check ~with 95a066efff8c63b7d81d93977c1980e019708fa9. The check treated `file_name.h` and `file_name.cpp` as the same module, so the import pattern here of `addrman.h` <- `addrman_impl.h` <- `addrman.cpp` was perceived as a circular dependency. I fixed this by telling it to also treat `file_name_impl.h` as part of the same module.~\r\n\r\nMore info about updated fix here: https://github.com/bitcoin/bitcoin/pull/22950#issuecomment-921056093",
      "created_at" : "2021-09-13T22:57:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#issuecomment-918643347",
      "id" : 918643347,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22950",
      "node_id" : "IC_kwDOABII5842wWKT",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-16T16:35:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/918643347",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK. I'm a big fan of compilation firewall patterns. From Herb Sutter:\r\n\r\n> One big advantage of this idiom is that it breaks compile-time dependencies. First, system builds run faster because using a Pimpl can eliminate extra #includes. I have worked on projects where converting just a few widely-visible classes to use Pimpls has halved the systemâs build time. Second, it localizes the build impact of code changes because the parts of a class that reside in the Pimpl can be freely changed â that is, members can be freely added or removed â without recompiling client code. Because itâs so good at eliminating compilation cascades due to changes in only the now-hidden members, itâs often dubbed a âcompilation firewall.â\r\n\r\n(https://herbsutter.com/gotw/_100/)\r\n\r\nBoth are relevant here. addrman.h is eventually included by just about everything, so minimizing its compilation time is potentially a big win. There's also a plan to rework its implementation. If we first make addrman into a pimpl, that could theoretically be done without any impact on the rest of the codebase.",
      "created_at" : "2021-09-14T12:14:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#issuecomment-919092484",
      "id" : 919092484,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22950",
      "node_id" : "IC_kwDOABII5842yD0E",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-14T12:14:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/919092484",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK on improved separation and shorter build times. Debug build clean. Just read through pages 147-156 of Scott Meyers' \"Effective Modern C++\" about the (unique) pointer to implementation idiom and started looking at the commit organisation, particularly the choices in the second (\"Introduce CAddrMan::Impl to encapsulate addrman implementation\") and third (\"Remove external dependencies on CAddrInfo objects\") commits where the action appears to be.\r\n\r\nEdit, noting for myself, also:\r\n- Scott Meyers, \"Effective C++\", item 31\r\n- Herb Sutter, \"Exceptional C++\", items 26-30",
      "created_at" : "2021-09-15T17:59:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#issuecomment-920249059",
      "id" : 920249059,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22950",
      "node_id" : "IC_kwDOABII58422eLj",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-15T19:34:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/920249059",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK\r\n\r\n> Both are relevant here. addrman.h is eventually included by just about everything, so minimizing its compilation time is potentially a big win.\r\n\r\nYes, at some point there was discussion about doing this for `txmempool.h` too, as it's included a fair bit and includes all these boost `multi_index` structures, which i'm sure slow down compilation quite a bit.\r\n",
      "created_at" : "2021-09-16T16:24:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#issuecomment-921048350",
      "id" : 921048350,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22950",
      "node_id" : "IC_kwDOABII58425hUe",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-16T16:24:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/921048350",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "adopted a different fix to the detected circular dependency- I made the impl a stand-alone class, so it's now `AddrManImpl` instead of `AddrMan::Impl`. this means `addrman_impl.h` does not need to import `addrman.h`, and the linter script does not need to be updated :) ",
      "created_at" : "2021-09-16T16:34:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#issuecomment-921056093",
      "id" : 921056093,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22950",
      "node_id" : "IC_kwDOABII58425jNd",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-16T16:34:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/921056093",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-09-20T17:58:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#issuecomment-923150531",
      "id" : 923150531,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22950",
      "node_id" : "IC_kwDOABII5843BijD",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-20T17:58:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/923150531",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "concept ack!",
      "created_at" : "2021-09-21T03:29:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#issuecomment-923583452",
      "id" : 923583452,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22950",
      "node_id" : "IC_kwDOABII5843DMPc",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-21T03:29:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/923583452",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "thanks for the concept ACKs! rebased to incorporate the recent addrman changes. ",
      "created_at" : "2021-09-21T21:55:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#issuecomment-924415628",
      "id" : 924415628,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22950",
      "node_id" : "IC_kwDOABII5843GXaM",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-21T21:55:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/924415628",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I had missed a silent merge conflict, fixed now and ready for review ð",
      "created_at" : "2021-09-22T00:35:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#issuecomment-924488565",
      "id" : 924488565,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22950",
      "node_id" : "IC_kwDOABII5843GpN1",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-22T00:35:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/924488565",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r713849263"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/713849263"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is a forward declaration, so the usual place for it would be at the top of the file. I think placing it here would also means that the doxygen comment would be associated with `AddrManImpl` instead of `AddrMan`.",
      "commit_id" : "11926b09935f491c33b611f1a112a800377a481a",
      "created_at" : "2021-09-22T11:33:17Z",
      "diff_hunk" : "@@ -123,290 +48,63 @@ class CAddrInfo : public CAddress\n  *    * Several indexes are kept for high performance. Setting m_consistency_check_ratio with the -checkaddrman\n  *      configuration option will introduce (expensive) consistency checks for the entire data structure.\n  */\n-\n-/** Total number of buckets for tried addresses */\n-static constexpr int32_t ADDRMAN_TRIED_BUCKET_COUNT_LOG2{8};\n-static constexpr int ADDRMAN_TRIED_BUCKET_COUNT{1 << ADDRMAN_TRIED_BUCKET_COUNT_LOG2};\n-\n-/** Total number of buckets for new addresses */\n-static constexpr int32_t ADDRMAN_NEW_BUCKET_COUNT_LOG2{10};\n-static constexpr int ADDRMAN_NEW_BUCKET_COUNT{1 << ADDRMAN_NEW_BUCKET_COUNT_LOG2};\n-\n-/** Maximum allowed number of entries in buckets for new and tried addresses */\n-static constexpr int32_t ADDRMAN_BUCKET_SIZE_LOG2{6};\n-static constexpr int ADDRMAN_BUCKET_SIZE{1 << ADDRMAN_BUCKET_SIZE_LOG2};\n-\n-/**\n- * Stochastical (IP) address manager\n- */\n-class CAddrMan\n+class AddrManImpl;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r713849263",
      "id" : 713849263,
      "line" : 51,
      "node_id" : "PRRC_kwDOABII584qjHmv",
      "original_commit_id" : "11926b09935f491c33b611f1a112a800377a481a",
      "original_line" : 51,
      "original_position" : 118,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 118,
      "pull_request_review_id" : 760789697,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-22T12:49:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/713849263",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r713887633"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/713887633"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This may just be personal preference, but I think this file would be tidier/easier to read if all of these `AddrMan` boilerplate forwarding functions were collected at the bottom (as is done in txrequest.cpp), rather than interleaved with `AddrManImpl` functions.",
      "commit_id" : "11926b09935f491c33b611f1a112a800377a481a",
      "created_at" : "2021-09-22T12:26:22Z",
      "diff_hunk" : "@@ -1004,16 +984,187 @@ CAddrInfo CAddrMan::SelectTriedCollision_()\n     // If id_new not found in mapInfo remove it from m_tried_collisions\n     if (mapInfo.count(id_new) != 1) {\n         m_tried_collisions.erase(it);\n-        return CAddrInfo();\n+        return {};\n     }\n \n-    const CAddrInfo& newInfo = mapInfo[id_new];\n+    const AddrInfo& newInfo = mapInfo[id_new];\n \n     // which tried bucket to move the entry to\n     int tried_bucket = newInfo.GetTriedBucket(nKey, m_asmap);\n     int tried_bucket_pos = newInfo.GetBucketPosition(nKey, false, tried_bucket);\n \n-    int id_old = vvTried[tried_bucket][tried_bucket_pos];\n+    auto info_old = mapInfo[vvTried[tried_bucket][tried_bucket_pos]];\n+    return {info_old, info_old.nLastTry};\n+}\n+\n+// explicit instantiation\n+template void AddrMan::Serialize(CHashWriter& s) const;\n+template void AddrMan::Serialize(CAutoFile& s) const;\n+template void AddrMan::Serialize(CDataStream& s) const;\n+template void AddrMan::Unserialize(CAutoFile& s);\n+template void AddrMan::Unserialize(CHashVerifier<CAutoFile>& s);\n+template void AddrMan::Unserialize(CDataStream& s);\n+template void AddrMan::Unserialize(CHashVerifier<CDataStream>& s);\n+\n+template <typename Stream>\n+void AddrMan::Serialize(Stream& s_) const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r713887633",
      "id" : 713887633,
      "line" : 1010,
      "node_id" : "PRRC_kwDOABII584qjQ-R",
      "original_commit_id" : "11926b09935f491c33b611f1a112a800377a481a",
      "original_line" : 1010,
      "original_position" : 546,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : 546,
      "pull_request_review_id" : 760789697,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-22T12:49:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/713887633",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r713891466"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/713891466"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe we should just update the internal `GetAddr_()` function to return a `std::vector<CAddress>` instead of introducing this comment?",
      "commit_id" : "11926b09935f491c33b611f1a112a800377a481a",
      "created_at" : "2021-09-22T12:31:02Z",
      "diff_hunk" : "@@ -0,0 +1,287 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_ADDRMAN_IMPL_H\n+#define BITCOIN_ADDRMAN_IMPL_H\n+\n+#include <logging.h>\n+\n+#include <sync.h>\n+#include <unordered_map>\n+#include <unordered_set>\n+\n+/** Total number of buckets for tried addresses */\n+static constexpr int32_t ADDRMAN_TRIED_BUCKET_COUNT_LOG2{8};\n+static constexpr int ADDRMAN_TRIED_BUCKET_COUNT{1 << ADDRMAN_TRIED_BUCKET_COUNT_LOG2};\n+/** Total number of buckets for new addresses */\n+static constexpr int32_t ADDRMAN_NEW_BUCKET_COUNT_LOG2{10};\n+static constexpr int ADDRMAN_NEW_BUCKET_COUNT{1 << ADDRMAN_NEW_BUCKET_COUNT_LOG2};\n+/** Maximum allowed number of entries in buckets for new and tried addresses */\n+static constexpr int32_t ADDRMAN_BUCKET_SIZE_LOG2{6};\n+static constexpr int ADDRMAN_BUCKET_SIZE{1 << ADDRMAN_BUCKET_SIZE_LOG2};\n+\n+/**\n+ * Extended statistics about a CAddress\n+ */\n+class AddrInfo : public CAddress\n+{\n+public:\n+    //! last try whatsoever by us (memory only)\n+    int64_t nLastTry{0};\n+\n+    //! last counted attempt (memory only)\n+    int64_t nLastCountAttempt{0};\n+\n+    //! where knowledge about this address first came from\n+    CNetAddr source;\n+\n+    //! last successful connection by us\n+    int64_t nLastSuccess{0};\n+\n+    //! connection attempts since last successful attempt\n+    int nAttempts{0};\n+\n+    //! reference count in new sets (memory only)\n+    int nRefCount{0};\n+\n+    //! in tried set? (memory only)\n+    bool fInTried{false};\n+\n+    //! position in vRandom\n+    mutable int nRandomPos{-1};\n+\n+    SERIALIZE_METHODS(AddrInfo, obj)\n+    {\n+        READWRITEAS(CAddress, obj);\n+        READWRITE(obj.source, obj.nLastSuccess, obj.nAttempts);\n+    }\n+\n+    AddrInfo(const CAddress& addrIn, const CNetAddr& addrSource) : CAddress(addrIn), source(addrSource)\n+    {\n+    }\n+\n+    AddrInfo() : CAddress(), source()\n+    {\n+    }\n+\n+    //! Calculate in which \"tried\" bucket this entry belongs\n+    int GetTriedBucket(const uint256& nKey, const std::vector<bool>& asmap) const;\n+\n+    //! Calculate in which \"new\" bucket this entry belongs, given a certain source\n+    int GetNewBucket(const uint256& nKey, const CNetAddr& src, const std::vector<bool>& asmap) const;\n+\n+    //! Calculate in which \"new\" bucket this entry belongs, using its default source\n+    int GetNewBucket(const uint256& nKey, const std::vector<bool>& asmap) const\n+    {\n+        return GetNewBucket(nKey, source, asmap);\n+    }\n+\n+    //! Calculate in which position of a bucket to store this entry.\n+    int GetBucketPosition(const uint256& nKey, bool fNew, int nBucket) const;\n+\n+    //! Determine whether the statistics about this entry are bad enough so that it can just be deleted\n+    bool IsTerrible(int64_t nNow = GetAdjustedTime()) const;\n+\n+    //! Calculate the relative chance this entry should be given when selecting nodes to connect to\n+    double GetChance(int64_t nNow = GetAdjustedTime()) const;\n+};\n+\n+class AddrManImpl\n+{\n+public:\n+    AddrManImpl(std::vector<bool>&& asmap, bool deterministic, int32_t consistency_check_ratio)\n+        : insecure_rand{deterministic}\n+        , nKey{deterministic ? uint256{1} : insecure_rand.rand256()}\n+        , m_consistency_check_ratio{consistency_check_ratio}\n+        , m_asmap{std::move(asmap)}\n+    {\n+        for (auto& bucket : vvNew) {\n+            for (auto& entry : bucket) {\n+                entry = -1;\n+            }\n+        }\n+        for (auto& bucket : vvTried) {\n+            for (auto& entry : bucket) {\n+                entry = -1;\n+            }\n+        }\n+    }\n+\n+    ~AddrManImpl()\n+    {\n+        nKey.SetNull();\n+    }\n+\n+\n+    template <typename Stream>\n+    void Serialize(Stream& s_) const EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    template <typename Stream>\n+    void Unserialize(Stream& s_) EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    size_t size() const EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    bool Add(const std::vector<CAddress>& vAddr, const CNetAddr& source, int64_t nTimePenalty = 0)\n+        EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    void Good(const CService& addr, int64_t nTime = GetAdjustedTime())\n+        EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    void Attempt(const CService& addr, bool fCountFailure, int64_t nTime = GetAdjustedTime())\n+        EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    void ResolveCollisions() EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    std::pair<CAddress, int64_t> SelectTriedCollision() EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    std::pair<CAddress, int64_t> Select(bool newOnly = false) const\n+        EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    std::vector<CAddress> GetAddr(size_t max_addresses, size_t max_pct, std::optional<Network> network) const\n+        EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    void Connected(const CService& addr, int64_t nTime = GetAdjustedTime())\n+        EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    void SetServices(const CService& addr, ServiceFlags nServices)\n+        EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    const std::vector<bool>& GetAsmap() const;\n+\n+    friend class AddrManTest;\n+    friend class AddrManDeterministic;\n+\n+private:\n+    //! A mutex to protect the inner data structures.\n+    mutable Mutex cs;\n+\n+    //! Source of random numbers for randomization in inner loops\n+    mutable FastRandomContext insecure_rand GUARDED_BY(cs);\n+\n+    //! secret key to randomize bucket select with\n+    uint256 nKey;\n+\n+    //! Serialization versions.\n+    enum Format : uint8_t {\n+        V0_HISTORICAL = 0,    //!< historic format, before commit e6b343d88\n+        V1_DETERMINISTIC = 1, //!< for pre-asmap files\n+        V2_ASMAP = 2,         //!< for files including asmap version\n+        V3_BIP155 = 3,        //!< same as V2_ASMAP plus addresses are in BIP155 format\n+    };\n+\n+    //! The maximum format this software knows it can unserialize. Also, we always serialize\n+    //! in this format.\n+    //! The format (first byte in the serialized stream) can be higher than this and\n+    //! still this software may be able to unserialize the file - if the second byte\n+    //! (see `lowest_compatible` in `Unserialize()`) is less or equal to this.\n+    static constexpr Format FILE_FORMAT = Format::V3_BIP155;\n+\n+    //! The initial value of a field that is incremented every time an incompatible format\n+    //! change is made (such that old software versions would not be able to parse and\n+    //! understand the new file format). This is 32 because we overtook the \"key size\"\n+    //! field which was 32 historically.\n+    //! @note Don't increment this. Increment `lowest_compatible` in `Serialize()` instead.\n+    static constexpr uint8_t INCOMPATIBILITY_BASE = 32;\n+\n+    //! last used nId\n+    int nIdCount GUARDED_BY(cs){0};\n+\n+    //! table with information about all nIds\n+    std::unordered_map<int, AddrInfo> mapInfo GUARDED_BY(cs);\n+\n+    //! find an nId based on its network address\n+    std::unordered_map<CNetAddr, int, CNetAddrHash> mapAddr GUARDED_BY(cs);\n+\n+    //! randomly-ordered vector of all nIds\n+    //! This is mutable because it is unobservable outside the class, so any\n+    //! changes to it (even in const methods) are also unobservable.\n+    mutable std::vector<int> vRandom GUARDED_BY(cs);\n+\n+    // number of \"tried\" entries\n+    int nTried GUARDED_BY(cs){0};\n+\n+    //! list of \"tried\" buckets\n+    int vvTried[ADDRMAN_TRIED_BUCKET_COUNT][ADDRMAN_BUCKET_SIZE] GUARDED_BY(cs);\n+\n+    //! number of (unique) \"new\" entries\n+    int nNew GUARDED_BY(cs){0};\n+\n+    //! list of \"new\" buckets\n+    int vvNew[ADDRMAN_NEW_BUCKET_COUNT][ADDRMAN_BUCKET_SIZE] GUARDED_BY(cs);\n+\n+    //! last time Good was called (memory only). Initially set to 1 so that \"never\" is strictly worse.\n+    int64_t nLastGood GUARDED_BY(cs){1};\n+\n+    //! Holds addrs inserted into tried table that collide with existing entries. Test-before-evict discipline used to resolve these collisions.\n+    std::set<int> m_tried_collisions;\n+\n+    /** Perform consistency checks every m_consistency_check_ratio operations (if non-zero). */\n+    const int32_t m_consistency_check_ratio;\n+\n+    // Compressed IP->ASN mapping, loaded from a file when a node starts.\n+    // Should be always empty if no file was provided.\n+    // This mapping is then used for bucketing nodes in Addrman.\n+    //\n+    // If asmap is provided, nodes will be bucketed by\n+    // AS they belong to, in order to make impossible for a node\n+    // to connect to several nodes hosted in a single AS.\n+    // This is done in response to Erebus attack, but also to generally\n+    // diversify the connections every node creates,\n+    // especially useful when a large fraction of nodes\n+    // operate under a couple of cloud providers.\n+    //\n+    // If a new asmap was provided, the existing records\n+    // would be re-bucketed accordingly.\n+    const std::vector<bool> m_asmap;\n+\n+    //! Find an entry.\n+    AddrInfo* Find(const CNetAddr& addr, int* pnId = nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    //! Create a new entry and add it to the internal data structures mapInfo, mapAddr and vRandom.\n+    AddrInfo* Create(const CAddress& addr, const CNetAddr& addrSource, int* pnId = nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    //! Swap two elements in vRandom.\n+    void SwapRandom(unsigned int nRandomPos1, unsigned int nRandomPos2) const EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    //! Move an entry from the \"new\" table(s) to the \"tried\" table\n+    void MakeTried(AddrInfo& info, int nId) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    //! Delete an entry. It must not be in tried, and have refcount 0.\n+    void Delete(int nId) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    //! Clear a position in a \"new\" table. This is the only place where entries are actually deleted.\n+    void ClearNew(int nUBucket, int nUBucketPos) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    void Good_(const CService& addr, bool test_before_evict, int64_t time) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    bool Add_(const CAddress& addr, const CNetAddr& source, int64_t nTimePenalty) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    void Attempt_(const CService& addr, bool fCountFailure, int64_t nTime) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    std::pair<CAddress, int64_t> Select_(bool newOnly) const EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    void ResolveCollisions_() EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    std::pair<CAddress, int64_t> SelectTriedCollision_() EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    //! Consistency check, taking into account m_consistency_check_ratio. Will std::abort if an inconsistency is detected.\n+    void Check() const EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    //! Perform consistency check, regardless of m_consistency_check_ratio.\n+    //! @returns an error code or zero.\n+    int ForceCheckAddrman() const EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    /**\n+     * This internal function adds one parameter to the GetAddr wrapper.\n+     *\n+     * @param[out] vAddr         Vector of randomly selected addresses from vRandom.\n+     */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r713891466",
      "id" : 713891466,
      "line" : 279,
      "node_id" : "PRRC_kwDOABII584qjR6K",
      "original_commit_id" : "11926b09935f491c33b611f1a112a800377a481a",
      "original_line" : 279,
      "original_position" : 279,
      "original_start_line" : 276,
      "path" : "src/addrman_impl.h",
      "position" : 279,
      "pull_request_review_id" : 760789697,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950",
      "side" : "RIGHT",
      "start_line" : 276,
      "start_side" : "RIGHT",
      "updated_at" : "2021-09-22T12:49:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/713891466",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r713892970"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/713892970"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Should be grouped above with logging.h, since sync.h is a project header and not a stl header.",
      "commit_id" : "11926b09935f491c33b611f1a112a800377a481a",
      "created_at" : "2021-09-22T12:32:55Z",
      "diff_hunk" : "@@ -0,0 +1,287 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_ADDRMAN_IMPL_H\n+#define BITCOIN_ADDRMAN_IMPL_H\n+\n+#include <logging.h>\n+\n+#include <sync.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r713892970",
      "id" : 713892970,
      "line" : 10,
      "node_id" : "PRRC_kwDOABII584qjSRq",
      "original_commit_id" : "11926b09935f491c33b611f1a112a800377a481a",
      "original_line" : 10,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/addrman_impl.h",
      "position" : 10,
      "pull_request_review_id" : 760789697,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-22T12:49:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/713892970",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r713897836"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/713897836"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Also include:\r\n\r\n- cstdint (for fixed width integer types)\r\n- netaddress.h (for CNetAddr)\r\n- serialize.h (for serialization functions)\r\n- protocol.h (for CAddress)\r\n- uint256.h (for uint256)\r\n- vector (for std::vector)\r\n- utility (for std::pair)\r\n- set (for std::set)\r\n- optional (for std::optional)",
      "commit_id" : "11926b09935f491c33b611f1a112a800377a481a",
      "created_at" : "2021-09-22T12:38:44Z",
      "diff_hunk" : "@@ -0,0 +1,287 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_ADDRMAN_IMPL_H\n+#define BITCOIN_ADDRMAN_IMPL_H\n+\n+#include <logging.h>\n+\n+#include <sync.h>\n+#include <unordered_map>\n+#include <unordered_set>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r713897836",
      "id" : 713897836,
      "line" : 12,
      "node_id" : "PRRC_kwDOABII584qjTds",
      "original_commit_id" : "11926b09935f491c33b611f1a112a800377a481a",
      "original_line" : 12,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/addrman_impl.h",
      "position" : 12,
      "pull_request_review_id" : 760789697,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-22T12:49:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/713897836",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r713899748"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/713899748"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Also include streams.h",
      "commit_id" : "11926b09935f491c33b611f1a112a800377a481a",
      "created_at" : "2021-09-22T12:41:01Z",
      "diff_hunk" : "@@ -6,94 +6,19 @@\n #ifndef BITCOIN_ADDRMAN_H\n #define BITCOIN_ADDRMAN_H\n \n-#include <fs.h>\n-#include <logging.h>\n #include <netaddress.h>\n #include <protocol.h>\n-#include <sync.h>\n #include <timedata.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r713899748",
      "id" : 713899748,
      "line" : 11,
      "node_id" : "PRRC_kwDOABII584qjT7k",
      "original_commit_id" : "11926b09935f491c33b611f1a112a800377a481a",
      "original_line" : 11,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 9,
      "pull_request_review_id" : 760789697,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-22T12:49:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/713899748",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r714350992"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714350992"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fixed",
      "commit_id" : "bb22a365c85f76537aba61c36277fa49d68d5c9f",
      "created_at" : "2021-09-22T22:20:48Z",
      "diff_hunk" : "@@ -123,290 +48,63 @@ class CAddrInfo : public CAddress\n  *    * Several indexes are kept for high performance. Setting m_consistency_check_ratio with the -checkaddrman\n  *      configuration option will introduce (expensive) consistency checks for the entire data structure.\n  */\n-\n-/** Total number of buckets for tried addresses */\n-static constexpr int32_t ADDRMAN_TRIED_BUCKET_COUNT_LOG2{8};\n-static constexpr int ADDRMAN_TRIED_BUCKET_COUNT{1 << ADDRMAN_TRIED_BUCKET_COUNT_LOG2};\n-\n-/** Total number of buckets for new addresses */\n-static constexpr int32_t ADDRMAN_NEW_BUCKET_COUNT_LOG2{10};\n-static constexpr int ADDRMAN_NEW_BUCKET_COUNT{1 << ADDRMAN_NEW_BUCKET_COUNT_LOG2};\n-\n-/** Maximum allowed number of entries in buckets for new and tried addresses */\n-static constexpr int32_t ADDRMAN_BUCKET_SIZE_LOG2{6};\n-static constexpr int ADDRMAN_BUCKET_SIZE{1 << ADDRMAN_BUCKET_SIZE_LOG2};\n-\n-/**\n- * Stochastical (IP) address manager\n- */\n-class CAddrMan\n+class AddrManImpl;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r714350992",
      "id" : 714350992,
      "in_reply_to_id" : 713849263,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584qlCGQ",
      "original_commit_id" : "11926b09935f491c33b611f1a112a800377a481a",
      "original_line" : 51,
      "original_position" : 118,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : null,
      "pull_request_review_id" : 761457568,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-22T22:20:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714350992",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r714351114"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714351114"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I agree, updated",
      "commit_id" : "bb22a365c85f76537aba61c36277fa49d68d5c9f",
      "created_at" : "2021-09-22T22:21:01Z",
      "diff_hunk" : "@@ -1004,16 +984,187 @@ CAddrInfo CAddrMan::SelectTriedCollision_()\n     // If id_new not found in mapInfo remove it from m_tried_collisions\n     if (mapInfo.count(id_new) != 1) {\n         m_tried_collisions.erase(it);\n-        return CAddrInfo();\n+        return {};\n     }\n \n-    const CAddrInfo& newInfo = mapInfo[id_new];\n+    const AddrInfo& newInfo = mapInfo[id_new];\n \n     // which tried bucket to move the entry to\n     int tried_bucket = newInfo.GetTriedBucket(nKey, m_asmap);\n     int tried_bucket_pos = newInfo.GetBucketPosition(nKey, false, tried_bucket);\n \n-    int id_old = vvTried[tried_bucket][tried_bucket_pos];\n+    auto info_old = mapInfo[vvTried[tried_bucket][tried_bucket_pos]];\n+    return {info_old, info_old.nLastTry};\n+}\n+\n+// explicit instantiation\n+template void AddrMan::Serialize(CHashWriter& s) const;\n+template void AddrMan::Serialize(CAutoFile& s) const;\n+template void AddrMan::Serialize(CDataStream& s) const;\n+template void AddrMan::Unserialize(CAutoFile& s);\n+template void AddrMan::Unserialize(CHashVerifier<CAutoFile>& s);\n+template void AddrMan::Unserialize(CDataStream& s);\n+template void AddrMan::Unserialize(CHashVerifier<CDataStream>& s);\n+\n+template <typename Stream>\n+void AddrMan::Serialize(Stream& s_) const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r714351114",
      "id" : 714351114,
      "in_reply_to_id" : 713887633,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584qlCIK",
      "original_commit_id" : "11926b09935f491c33b611f1a112a800377a481a",
      "original_line" : 1010,
      "original_position" : 546,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : null,
      "pull_request_review_id" : 761457672,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-22T22:21:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714351114",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r714351625"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714351625"
         }
      },
      "author_association" : "MEMBER",
      "body" : "sounds good, added commit 5a8415750cdc93b719a8e4c18ee245e236b93006 to handle that ",
      "commit_id" : "bb22a365c85f76537aba61c36277fa49d68d5c9f",
      "created_at" : "2021-09-22T22:22:17Z",
      "diff_hunk" : "@@ -0,0 +1,287 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_ADDRMAN_IMPL_H\n+#define BITCOIN_ADDRMAN_IMPL_H\n+\n+#include <logging.h>\n+\n+#include <sync.h>\n+#include <unordered_map>\n+#include <unordered_set>\n+\n+/** Total number of buckets for tried addresses */\n+static constexpr int32_t ADDRMAN_TRIED_BUCKET_COUNT_LOG2{8};\n+static constexpr int ADDRMAN_TRIED_BUCKET_COUNT{1 << ADDRMAN_TRIED_BUCKET_COUNT_LOG2};\n+/** Total number of buckets for new addresses */\n+static constexpr int32_t ADDRMAN_NEW_BUCKET_COUNT_LOG2{10};\n+static constexpr int ADDRMAN_NEW_BUCKET_COUNT{1 << ADDRMAN_NEW_BUCKET_COUNT_LOG2};\n+/** Maximum allowed number of entries in buckets for new and tried addresses */\n+static constexpr int32_t ADDRMAN_BUCKET_SIZE_LOG2{6};\n+static constexpr int ADDRMAN_BUCKET_SIZE{1 << ADDRMAN_BUCKET_SIZE_LOG2};\n+\n+/**\n+ * Extended statistics about a CAddress\n+ */\n+class AddrInfo : public CAddress\n+{\n+public:\n+    //! last try whatsoever by us (memory only)\n+    int64_t nLastTry{0};\n+\n+    //! last counted attempt (memory only)\n+    int64_t nLastCountAttempt{0};\n+\n+    //! where knowledge about this address first came from\n+    CNetAddr source;\n+\n+    //! last successful connection by us\n+    int64_t nLastSuccess{0};\n+\n+    //! connection attempts since last successful attempt\n+    int nAttempts{0};\n+\n+    //! reference count in new sets (memory only)\n+    int nRefCount{0};\n+\n+    //! in tried set? (memory only)\n+    bool fInTried{false};\n+\n+    //! position in vRandom\n+    mutable int nRandomPos{-1};\n+\n+    SERIALIZE_METHODS(AddrInfo, obj)\n+    {\n+        READWRITEAS(CAddress, obj);\n+        READWRITE(obj.source, obj.nLastSuccess, obj.nAttempts);\n+    }\n+\n+    AddrInfo(const CAddress& addrIn, const CNetAddr& addrSource) : CAddress(addrIn), source(addrSource)\n+    {\n+    }\n+\n+    AddrInfo() : CAddress(), source()\n+    {\n+    }\n+\n+    //! Calculate in which \"tried\" bucket this entry belongs\n+    int GetTriedBucket(const uint256& nKey, const std::vector<bool>& asmap) const;\n+\n+    //! Calculate in which \"new\" bucket this entry belongs, given a certain source\n+    int GetNewBucket(const uint256& nKey, const CNetAddr& src, const std::vector<bool>& asmap) const;\n+\n+    //! Calculate in which \"new\" bucket this entry belongs, using its default source\n+    int GetNewBucket(const uint256& nKey, const std::vector<bool>& asmap) const\n+    {\n+        return GetNewBucket(nKey, source, asmap);\n+    }\n+\n+    //! Calculate in which position of a bucket to store this entry.\n+    int GetBucketPosition(const uint256& nKey, bool fNew, int nBucket) const;\n+\n+    //! Determine whether the statistics about this entry are bad enough so that it can just be deleted\n+    bool IsTerrible(int64_t nNow = GetAdjustedTime()) const;\n+\n+    //! Calculate the relative chance this entry should be given when selecting nodes to connect to\n+    double GetChance(int64_t nNow = GetAdjustedTime()) const;\n+};\n+\n+class AddrManImpl\n+{\n+public:\n+    AddrManImpl(std::vector<bool>&& asmap, bool deterministic, int32_t consistency_check_ratio)\n+        : insecure_rand{deterministic}\n+        , nKey{deterministic ? uint256{1} : insecure_rand.rand256()}\n+        , m_consistency_check_ratio{consistency_check_ratio}\n+        , m_asmap{std::move(asmap)}\n+    {\n+        for (auto& bucket : vvNew) {\n+            for (auto& entry : bucket) {\n+                entry = -1;\n+            }\n+        }\n+        for (auto& bucket : vvTried) {\n+            for (auto& entry : bucket) {\n+                entry = -1;\n+            }\n+        }\n+    }\n+\n+    ~AddrManImpl()\n+    {\n+        nKey.SetNull();\n+    }\n+\n+\n+    template <typename Stream>\n+    void Serialize(Stream& s_) const EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    template <typename Stream>\n+    void Unserialize(Stream& s_) EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    size_t size() const EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    bool Add(const std::vector<CAddress>& vAddr, const CNetAddr& source, int64_t nTimePenalty = 0)\n+        EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    void Good(const CService& addr, int64_t nTime = GetAdjustedTime())\n+        EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    void Attempt(const CService& addr, bool fCountFailure, int64_t nTime = GetAdjustedTime())\n+        EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    void ResolveCollisions() EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    std::pair<CAddress, int64_t> SelectTriedCollision() EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    std::pair<CAddress, int64_t> Select(bool newOnly = false) const\n+        EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    std::vector<CAddress> GetAddr(size_t max_addresses, size_t max_pct, std::optional<Network> network) const\n+        EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    void Connected(const CService& addr, int64_t nTime = GetAdjustedTime())\n+        EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    void SetServices(const CService& addr, ServiceFlags nServices)\n+        EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    const std::vector<bool>& GetAsmap() const;\n+\n+    friend class AddrManTest;\n+    friend class AddrManDeterministic;\n+\n+private:\n+    //! A mutex to protect the inner data structures.\n+    mutable Mutex cs;\n+\n+    //! Source of random numbers for randomization in inner loops\n+    mutable FastRandomContext insecure_rand GUARDED_BY(cs);\n+\n+    //! secret key to randomize bucket select with\n+    uint256 nKey;\n+\n+    //! Serialization versions.\n+    enum Format : uint8_t {\n+        V0_HISTORICAL = 0,    //!< historic format, before commit e6b343d88\n+        V1_DETERMINISTIC = 1, //!< for pre-asmap files\n+        V2_ASMAP = 2,         //!< for files including asmap version\n+        V3_BIP155 = 3,        //!< same as V2_ASMAP plus addresses are in BIP155 format\n+    };\n+\n+    //! The maximum format this software knows it can unserialize. Also, we always serialize\n+    //! in this format.\n+    //! The format (first byte in the serialized stream) can be higher than this and\n+    //! still this software may be able to unserialize the file - if the second byte\n+    //! (see `lowest_compatible` in `Unserialize()`) is less or equal to this.\n+    static constexpr Format FILE_FORMAT = Format::V3_BIP155;\n+\n+    //! The initial value of a field that is incremented every time an incompatible format\n+    //! change is made (such that old software versions would not be able to parse and\n+    //! understand the new file format). This is 32 because we overtook the \"key size\"\n+    //! field which was 32 historically.\n+    //! @note Don't increment this. Increment `lowest_compatible` in `Serialize()` instead.\n+    static constexpr uint8_t INCOMPATIBILITY_BASE = 32;\n+\n+    //! last used nId\n+    int nIdCount GUARDED_BY(cs){0};\n+\n+    //! table with information about all nIds\n+    std::unordered_map<int, AddrInfo> mapInfo GUARDED_BY(cs);\n+\n+    //! find an nId based on its network address\n+    std::unordered_map<CNetAddr, int, CNetAddrHash> mapAddr GUARDED_BY(cs);\n+\n+    //! randomly-ordered vector of all nIds\n+    //! This is mutable because it is unobservable outside the class, so any\n+    //! changes to it (even in const methods) are also unobservable.\n+    mutable std::vector<int> vRandom GUARDED_BY(cs);\n+\n+    // number of \"tried\" entries\n+    int nTried GUARDED_BY(cs){0};\n+\n+    //! list of \"tried\" buckets\n+    int vvTried[ADDRMAN_TRIED_BUCKET_COUNT][ADDRMAN_BUCKET_SIZE] GUARDED_BY(cs);\n+\n+    //! number of (unique) \"new\" entries\n+    int nNew GUARDED_BY(cs){0};\n+\n+    //! list of \"new\" buckets\n+    int vvNew[ADDRMAN_NEW_BUCKET_COUNT][ADDRMAN_BUCKET_SIZE] GUARDED_BY(cs);\n+\n+    //! last time Good was called (memory only). Initially set to 1 so that \"never\" is strictly worse.\n+    int64_t nLastGood GUARDED_BY(cs){1};\n+\n+    //! Holds addrs inserted into tried table that collide with existing entries. Test-before-evict discipline used to resolve these collisions.\n+    std::set<int> m_tried_collisions;\n+\n+    /** Perform consistency checks every m_consistency_check_ratio operations (if non-zero). */\n+    const int32_t m_consistency_check_ratio;\n+\n+    // Compressed IP->ASN mapping, loaded from a file when a node starts.\n+    // Should be always empty if no file was provided.\n+    // This mapping is then used for bucketing nodes in Addrman.\n+    //\n+    // If asmap is provided, nodes will be bucketed by\n+    // AS they belong to, in order to make impossible for a node\n+    // to connect to several nodes hosted in a single AS.\n+    // This is done in response to Erebus attack, but also to generally\n+    // diversify the connections every node creates,\n+    // especially useful when a large fraction of nodes\n+    // operate under a couple of cloud providers.\n+    //\n+    // If a new asmap was provided, the existing records\n+    // would be re-bucketed accordingly.\n+    const std::vector<bool> m_asmap;\n+\n+    //! Find an entry.\n+    AddrInfo* Find(const CNetAddr& addr, int* pnId = nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    //! Create a new entry and add it to the internal data structures mapInfo, mapAddr and vRandom.\n+    AddrInfo* Create(const CAddress& addr, const CNetAddr& addrSource, int* pnId = nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    //! Swap two elements in vRandom.\n+    void SwapRandom(unsigned int nRandomPos1, unsigned int nRandomPos2) const EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    //! Move an entry from the \"new\" table(s) to the \"tried\" table\n+    void MakeTried(AddrInfo& info, int nId) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    //! Delete an entry. It must not be in tried, and have refcount 0.\n+    void Delete(int nId) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    //! Clear a position in a \"new\" table. This is the only place where entries are actually deleted.\n+    void ClearNew(int nUBucket, int nUBucketPos) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    void Good_(const CService& addr, bool test_before_evict, int64_t time) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    bool Add_(const CAddress& addr, const CNetAddr& source, int64_t nTimePenalty) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    void Attempt_(const CService& addr, bool fCountFailure, int64_t nTime) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    std::pair<CAddress, int64_t> Select_(bool newOnly) const EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    void ResolveCollisions_() EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    std::pair<CAddress, int64_t> SelectTriedCollision_() EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    //! Consistency check, taking into account m_consistency_check_ratio. Will std::abort if an inconsistency is detected.\n+    void Check() const EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    //! Perform consistency check, regardless of m_consistency_check_ratio.\n+    //! @returns an error code or zero.\n+    int ForceCheckAddrman() const EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    /**\n+     * This internal function adds one parameter to the GetAddr wrapper.\n+     *\n+     * @param[out] vAddr         Vector of randomly selected addresses from vRandom.\n+     */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r714351625",
      "id" : 714351625,
      "in_reply_to_id" : 713891466,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584qlCQJ",
      "original_commit_id" : "11926b09935f491c33b611f1a112a800377a481a",
      "original_line" : 279,
      "original_position" : 279,
      "original_start_line" : 276,
      "path" : "src/addrman_impl.h",
      "position" : null,
      "pull_request_review_id" : 761458297,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-09-22T22:22:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714351625",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r714351782"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714351782"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "bb22a365c85f76537aba61c36277fa49d68d5c9f",
      "created_at" : "2021-09-22T22:22:35Z",
      "diff_hunk" : "@@ -0,0 +1,287 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_ADDRMAN_IMPL_H\n+#define BITCOIN_ADDRMAN_IMPL_H\n+\n+#include <logging.h>\n+\n+#include <sync.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r714351782",
      "id" : 714351782,
      "in_reply_to_id" : 713892970,
      "line" : 12,
      "node_id" : "PRRC_kwDOABII584qlCSm",
      "original_commit_id" : "11926b09935f491c33b611f1a112a800377a481a",
      "original_line" : 12,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/addrman_impl.h",
      "position" : 12,
      "pull_request_review_id" : 761458475,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-22T22:22:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714351782",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r714352065"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714352065"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "bb22a365c85f76537aba61c36277fa49d68d5c9f",
      "created_at" : "2021-09-22T22:23:27Z",
      "diff_hunk" : "@@ -0,0 +1,287 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_ADDRMAN_IMPL_H\n+#define BITCOIN_ADDRMAN_IMPL_H\n+\n+#include <logging.h>\n+\n+#include <sync.h>\n+#include <unordered_map>\n+#include <unordered_set>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r714352065",
      "id" : 714352065,
      "in_reply_to_id" : 713897836,
      "line" : 19,
      "node_id" : "PRRC_kwDOABII584qlCXB",
      "original_commit_id" : "11926b09935f491c33b611f1a112a800377a481a",
      "original_line" : 19,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/addrman_impl.h",
      "position" : 19,
      "pull_request_review_id" : 761458913,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-22T22:23:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714352065",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r714352157"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714352157"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "bb22a365c85f76537aba61c36277fa49d68d5c9f",
      "created_at" : "2021-09-22T22:23:40Z",
      "diff_hunk" : "@@ -6,94 +6,19 @@\n #ifndef BITCOIN_ADDRMAN_H\n #define BITCOIN_ADDRMAN_H\n \n-#include <fs.h>\n-#include <logging.h>\n #include <netaddress.h>\n #include <protocol.h>\n-#include <sync.h>\n #include <timedata.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r714352157",
      "id" : 714352157,
      "in_reply_to_id" : 713899748,
      "line" : 12,
      "node_id" : "PRRC_kwDOABII584qlCYd",
      "original_commit_id" : "11926b09935f491c33b611f1a112a800377a481a",
      "original_line" : 12,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 10,
      "pull_request_review_id" : 761459023,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-22T22:23:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714352157",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "thanks for the review @jnewbery. I took all your suggestions except for this one that I have a question about-\r\n\r\n> In commit scripted-diff: Rename CAddrMan to AddrMan, is there a reason not to use git grep -l CAddrMan?\r\n\r\nI was trying this out, but am unsure how to exclude release notes. This is what I have so far, any suggestions? `git grep -l CAddrMan | xargs sed -i 's/CAddrMan/AddrMan/g'`\r\n\r\nalso, thank you for the feedback about commit breakdown. I hope its all straightened out now :) ",
      "created_at" : "2021-09-22T22:24:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#issuecomment-925372937",
      "id" : 925372937,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22950",
      "node_id" : "IC_kwDOABII5843KBIJ",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-22T22:24:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/925372937",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "If this is being done in the name of compilation performance, do you have any measurements justifying the change?",
      "created_at" : "2021-09-22T23:39:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#issuecomment-925404222",
      "id" : 925404222,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22950",
      "node_id" : "IC_kwDOABII5843KIw-",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-22T23:39:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/925404222",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I was trying this out, but am unsure how to exclude release notes. \r\n\r\n`git grep -l \"foo_bar\" ./src`",
      "created_at" : "2021-09-23T06:18:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#issuecomment-925534009",
      "id" : 925534009,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22950",
      "node_id" : "IC_kwDOABII5843Koc5",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-23T06:18:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/925534009",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r714655994"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714655994"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What do you think about having the ctor and dtor function bodies in addrman.cpp, so that addrman_impl.h only contains the function declarations?",
      "commit_id" : "bb22a365c85f76537aba61c36277fa49d68d5c9f",
      "created_at" : "2021-09-23T10:14:48Z",
      "diff_hunk" : "@@ -0,0 +1,291 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_ADDRMAN_IMPL_H\n+#define BITCOIN_ADDRMAN_IMPL_H\n+\n+#include <logging.h>\n+#include <netaddress.h>\n+#include <protocol.h>\n+#include <serialize.h>\n+#include <sync.h>\n+#include <uint256.h>\n+\n+#include <cstdint>\n+#include <set>\n+#include <optional>\n+#include <unordered_map>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/** Total number of buckets for tried addresses */\n+static constexpr int32_t ADDRMAN_TRIED_BUCKET_COUNT_LOG2{8};\n+static constexpr int ADDRMAN_TRIED_BUCKET_COUNT{1 << ADDRMAN_TRIED_BUCKET_COUNT_LOG2};\n+/** Total number of buckets for new addresses */\n+static constexpr int32_t ADDRMAN_NEW_BUCKET_COUNT_LOG2{10};\n+static constexpr int ADDRMAN_NEW_BUCKET_COUNT{1 << ADDRMAN_NEW_BUCKET_COUNT_LOG2};\n+/** Maximum allowed number of entries in buckets for new and tried addresses */\n+static constexpr int32_t ADDRMAN_BUCKET_SIZE_LOG2{6};\n+static constexpr int ADDRMAN_BUCKET_SIZE{1 << ADDRMAN_BUCKET_SIZE_LOG2};\n+\n+/**\n+ * Extended statistics about a CAddress\n+ */\n+class AddrInfo : public CAddress\n+{\n+public:\n+    //! last try whatsoever by us (memory only)\n+    int64_t nLastTry{0};\n+\n+    //! last counted attempt (memory only)\n+    int64_t nLastCountAttempt{0};\n+\n+    //! where knowledge about this address first came from\n+    CNetAddr source;\n+\n+    //! last successful connection by us\n+    int64_t nLastSuccess{0};\n+\n+    //! connection attempts since last successful attempt\n+    int nAttempts{0};\n+\n+    //! reference count in new sets (memory only)\n+    int nRefCount{0};\n+\n+    //! in tried set? (memory only)\n+    bool fInTried{false};\n+\n+    //! position in vRandom\n+    mutable int nRandomPos{-1};\n+\n+    SERIALIZE_METHODS(AddrInfo, obj)\n+    {\n+        READWRITEAS(CAddress, obj);\n+        READWRITE(obj.source, obj.nLastSuccess, obj.nAttempts);\n+    }\n+\n+    AddrInfo(const CAddress& addrIn, const CNetAddr& addrSource) : CAddress(addrIn), source(addrSource)\n+    {\n+    }\n+\n+    AddrInfo() : CAddress(), source()\n+    {\n+    }\n+\n+    //! Calculate in which \"tried\" bucket this entry belongs\n+    int GetTriedBucket(const uint256& nKey, const std::vector<bool>& asmap) const;\n+\n+    //! Calculate in which \"new\" bucket this entry belongs, given a certain source\n+    int GetNewBucket(const uint256& nKey, const CNetAddr& src, const std::vector<bool>& asmap) const;\n+\n+    //! Calculate in which \"new\" bucket this entry belongs, using its default source\n+    int GetNewBucket(const uint256& nKey, const std::vector<bool>& asmap) const\n+    {\n+        return GetNewBucket(nKey, source, asmap);\n+    }\n+\n+    //! Calculate in which position of a bucket to store this entry.\n+    int GetBucketPosition(const uint256& nKey, bool fNew, int nBucket) const;\n+\n+    //! Determine whether the statistics about this entry are bad enough so that it can just be deleted\n+    bool IsTerrible(int64_t nNow = GetAdjustedTime()) const;\n+\n+    //! Calculate the relative chance this entry should be given when selecting nodes to connect to\n+    double GetChance(int64_t nNow = GetAdjustedTime()) const;\n+};\n+\n+class AddrManImpl\n+{\n+public:\n+    AddrManImpl(std::vector<bool>&& asmap, bool deterministic, int32_t consistency_check_ratio)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r714655994",
      "id" : 714655994,
      "line" : 102,
      "node_id" : "PRRC_kwDOABII584qmMj6",
      "original_commit_id" : "bb22a365c85f76537aba61c36277fa49d68d5c9f",
      "original_line" : 102,
      "original_position" : 102,
      "original_start_line" : null,
      "path" : "src/addrman_impl.h",
      "position" : 102,
      "pull_request_review_id" : 761829604,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-23T10:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714655994",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r714656686"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714656686"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It seems more natural to have these instantiations below the function definitions for `Serialize()` and `Unserialize()`.",
      "commit_id" : "bb22a365c85f76537aba61c36277fa49d68d5c9f",
      "created_at" : "2021-09-23T10:15:50Z",
      "diff_hunk" : "@@ -1004,16 +987,184 @@ CAddrInfo CAddrMan::SelectTriedCollision_()\n     // If id_new not found in mapInfo remove it from m_tried_collisions\n     if (mapInfo.count(id_new) != 1) {\n         m_tried_collisions.erase(it);\n-        return CAddrInfo();\n+        return {};\n     }\n \n-    const CAddrInfo& newInfo = mapInfo[id_new];\n+    const AddrInfo& newInfo = mapInfo[id_new];\n \n     // which tried bucket to move the entry to\n     int tried_bucket = newInfo.GetTriedBucket(nKey, m_asmap);\n     int tried_bucket_pos = newInfo.GetBucketPosition(nKey, false, tried_bucket);\n \n-    int id_old = vvTried[tried_bucket][tried_bucket_pos];\n+    auto info_old = mapInfo[vvTried[tried_bucket][tried_bucket_pos]];\n+    return {info_old, info_old.nLastTry};\n+}\n+\n+size_t AddrManImpl::size() const\n+{\n+    LOCK(cs); // TODO: Cache this in an atomic to avoid this overhead\n+    return vRandom.size();\n+}\n+\n+bool AddrManImpl::Add(const std::vector<CAddress>& vAddr, const CNetAddr& source, int64_t nTimePenalty)\n+{\n+    LOCK(cs);\n+    int nAdd = 0;\n+    Check();\n+    for (std::vector<CAddress>::const_iterator it = vAddr.begin(); it != vAddr.end(); it++)\n+        nAdd += Add_(*it, source, nTimePenalty) ? 1 : 0;\n+    Check();\n+    if (nAdd) {\n+        LogPrint(BCLog::ADDRMAN, \"Added %i addresses from %s: %i tried, %i new\\n\", nAdd, source.ToString(), nTried, nNew);\n+    }\n+    return nAdd > 0;\n+}\n+\n+void AddrManImpl::Good(const CService& addr, int64_t nTime)\n+{\n+    LOCK(cs);\n+    Check();\n+    Good_(addr, /* test_before_evict */ true, nTime);\n+    Check();\n+}\n+\n+void AddrManImpl::Attempt(const CService& addr, bool fCountFailure, int64_t nTime)\n+{\n+    LOCK(cs);\n+    Check();\n+    Attempt_(addr, fCountFailure, nTime);\n+    Check();\n+}\n+\n+void AddrManImpl::ResolveCollisions()\n+{\n+    LOCK(cs);\n+    Check();\n+    ResolveCollisions_();\n+    Check();\n+}\n+\n+std::pair<CAddress, int64_t> AddrManImpl::SelectTriedCollision()\n+{\n+    LOCK(cs);\n+    Check();\n+    const auto ret = SelectTriedCollision_();\n+    Check();\n+    return ret;\n+}\n+\n+std::pair<CAddress, int64_t> AddrManImpl::Select(bool newOnly) const\n+{\n+    LOCK(cs);\n+    Check();\n+    const auto addrRet = Select_(newOnly);\n+    Check();\n+    return addrRet;\n+}\n+\n+std::vector<CAddress> AddrManImpl::GetAddr(size_t max_addresses, size_t max_pct, std::optional<Network> network) const\n+{\n+    LOCK(cs);\n+    Check();\n+    const auto addresses = GetAddr_(max_addresses, max_pct, network);\n+    Check();\n+    return addresses;\n+}\n+\n+void AddrManImpl::Connected(const CService& addr, int64_t nTime)\n+{\n+    LOCK(cs);\n+    Check();\n+    Connected_(addr, nTime);\n+    Check();\n+}\n+\n+void AddrManImpl::SetServices(const CService& addr, ServiceFlags nServices)\n+{\n+    LOCK(cs);\n+    Check();\n+    SetServices_(addr, nServices);\n+    Check();\n+}\n+\n+const std::vector<bool>& AddrManImpl::GetAsmap() const\n+{\n+    return m_asmap;\n+}\n+\n+// explicit instantiation",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r714656686",
      "id" : 714656686,
      "line" : 1095,
      "node_id" : "PRRC_kwDOABII584qmMuu",
      "original_commit_id" : "bb22a365c85f76537aba61c36277fa49d68d5c9f",
      "original_line" : 1095,
      "original_position" : 646,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : 646,
      "pull_request_review_id" : 761829604,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-23T10:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714656686",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r714662483"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714662483"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Could these `AddrMan` ctor and dtor methods also be moved to the bottom, below the `AddrManImpl` methods?",
      "commit_id" : "bb22a365c85f76537aba61c36277fa49d68d5c9f",
      "created_at" : "2021-09-23T10:25:14Z",
      "diff_hunk" : "@@ -101,26 +103,13 @@ double CAddrInfo::GetChance(int64_t nNow) const\n     return fChance;\n }\n \n-CAddrMan::CAddrMan(std::vector<bool> asmap, bool deterministic, int32_t consistency_check_ratio)\n-    : insecure_rand{deterministic}\n-    , nKey{deterministic ? uint256{1} : insecure_rand.rand256()}\n-    , m_consistency_check_ratio{consistency_check_ratio}\n-    , m_asmap{std::move(asmap)}\n-{\n-    for (auto& bucket : vvNew) {\n-        for (auto& entry : bucket) {\n-            entry = -1;\n-        }\n-    }\n-    for (auto& bucket : vvTried) {\n-        for (auto& entry : bucket) {\n-            entry = -1;\n-        }\n-    }\n-}\n+AddrMan::AddrMan(std::vector<bool> asmap, bool deterministic, int32_t consistency_check_ratio)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r714662483",
      "id" : 714662483,
      "line" : 106,
      "node_id" : "PRRC_kwDOABII584qmOJT",
      "original_commit_id" : "bb22a365c85f76537aba61c36277fa49d68d5c9f",
      "original_line" : 106,
      "original_position" : 97,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : 97,
      "pull_request_review_id" : 761829604,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-23T10:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714662483",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r714665818"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714665818"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Perhaps these two methods should be moved above `Good_`, so that all the underscore internal functions are grouped together.",
      "commit_id" : "bb22a365c85f76537aba61c36277fa49d68d5c9f",
      "created_at" : "2021-09-23T10:30:18Z",
      "diff_hunk" : "@@ -0,0 +1,291 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_ADDRMAN_IMPL_H\n+#define BITCOIN_ADDRMAN_IMPL_H\n+\n+#include <logging.h>\n+#include <netaddress.h>\n+#include <protocol.h>\n+#include <serialize.h>\n+#include <sync.h>\n+#include <uint256.h>\n+\n+#include <cstdint>\n+#include <set>\n+#include <optional>\n+#include <unordered_map>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/** Total number of buckets for tried addresses */\n+static constexpr int32_t ADDRMAN_TRIED_BUCKET_COUNT_LOG2{8};\n+static constexpr int ADDRMAN_TRIED_BUCKET_COUNT{1 << ADDRMAN_TRIED_BUCKET_COUNT_LOG2};\n+/** Total number of buckets for new addresses */\n+static constexpr int32_t ADDRMAN_NEW_BUCKET_COUNT_LOG2{10};\n+static constexpr int ADDRMAN_NEW_BUCKET_COUNT{1 << ADDRMAN_NEW_BUCKET_COUNT_LOG2};\n+/** Maximum allowed number of entries in buckets for new and tried addresses */\n+static constexpr int32_t ADDRMAN_BUCKET_SIZE_LOG2{6};\n+static constexpr int ADDRMAN_BUCKET_SIZE{1 << ADDRMAN_BUCKET_SIZE_LOG2};\n+\n+/**\n+ * Extended statistics about a CAddress\n+ */\n+class AddrInfo : public CAddress\n+{\n+public:\n+    //! last try whatsoever by us (memory only)\n+    int64_t nLastTry{0};\n+\n+    //! last counted attempt (memory only)\n+    int64_t nLastCountAttempt{0};\n+\n+    //! where knowledge about this address first came from\n+    CNetAddr source;\n+\n+    //! last successful connection by us\n+    int64_t nLastSuccess{0};\n+\n+    //! connection attempts since last successful attempt\n+    int nAttempts{0};\n+\n+    //! reference count in new sets (memory only)\n+    int nRefCount{0};\n+\n+    //! in tried set? (memory only)\n+    bool fInTried{false};\n+\n+    //! position in vRandom\n+    mutable int nRandomPos{-1};\n+\n+    SERIALIZE_METHODS(AddrInfo, obj)\n+    {\n+        READWRITEAS(CAddress, obj);\n+        READWRITE(obj.source, obj.nLastSuccess, obj.nAttempts);\n+    }\n+\n+    AddrInfo(const CAddress& addrIn, const CNetAddr& addrSource) : CAddress(addrIn), source(addrSource)\n+    {\n+    }\n+\n+    AddrInfo() : CAddress(), source()\n+    {\n+    }\n+\n+    //! Calculate in which \"tried\" bucket this entry belongs\n+    int GetTriedBucket(const uint256& nKey, const std::vector<bool>& asmap) const;\n+\n+    //! Calculate in which \"new\" bucket this entry belongs, given a certain source\n+    int GetNewBucket(const uint256& nKey, const CNetAddr& src, const std::vector<bool>& asmap) const;\n+\n+    //! Calculate in which \"new\" bucket this entry belongs, using its default source\n+    int GetNewBucket(const uint256& nKey, const std::vector<bool>& asmap) const\n+    {\n+        return GetNewBucket(nKey, source, asmap);\n+    }\n+\n+    //! Calculate in which position of a bucket to store this entry.\n+    int GetBucketPosition(const uint256& nKey, bool fNew, int nBucket) const;\n+\n+    //! Determine whether the statistics about this entry are bad enough so that it can just be deleted\n+    bool IsTerrible(int64_t nNow = GetAdjustedTime()) const;\n+\n+    //! Calculate the relative chance this entry should be given when selecting nodes to connect to\n+    double GetChance(int64_t nNow = GetAdjustedTime()) const;\n+};\n+\n+class AddrManImpl\n+{\n+public:\n+    AddrManImpl(std::vector<bool>&& asmap, bool deterministic, int32_t consistency_check_ratio)\n+        : insecure_rand{deterministic}\n+        , nKey{deterministic ? uint256{1} : insecure_rand.rand256()}\n+        , m_consistency_check_ratio{consistency_check_ratio}\n+        , m_asmap{std::move(asmap)}\n+    {\n+        for (auto& bucket : vvNew) {\n+            for (auto& entry : bucket) {\n+                entry = -1;\n+            }\n+        }\n+        for (auto& bucket : vvTried) {\n+            for (auto& entry : bucket) {\n+                entry = -1;\n+            }\n+        }\n+    }\n+\n+    ~AddrManImpl()\n+    {\n+        nKey.SetNull();\n+    }\n+\n+\n+    template <typename Stream>\n+    void Serialize(Stream& s_) const EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    template <typename Stream>\n+    void Unserialize(Stream& s_) EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    size_t size() const EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    bool Add(const std::vector<CAddress>& vAddr, const CNetAddr& source, int64_t nTimePenalty = 0)\n+        EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    void Good(const CService& addr, int64_t nTime = GetAdjustedTime())\n+        EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    void Attempt(const CService& addr, bool fCountFailure, int64_t nTime = GetAdjustedTime())\n+        EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    void ResolveCollisions() EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    std::pair<CAddress, int64_t> SelectTriedCollision() EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    std::pair<CAddress, int64_t> Select(bool newOnly = false) const\n+        EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    std::vector<CAddress> GetAddr(size_t max_addresses, size_t max_pct, std::optional<Network> network) const\n+        EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    void Connected(const CService& addr, int64_t nTime = GetAdjustedTime())\n+        EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    void SetServices(const CService& addr, ServiceFlags nServices)\n+        EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    const std::vector<bool>& GetAsmap() const;\n+\n+    friend class AddrManTest;\n+    friend class AddrManDeterministic;\n+\n+private:\n+    //! A mutex to protect the inner data structures.\n+    mutable Mutex cs;\n+\n+    //! Source of random numbers for randomization in inner loops\n+    mutable FastRandomContext insecure_rand GUARDED_BY(cs);\n+\n+    //! secret key to randomize bucket select with\n+    uint256 nKey;\n+\n+    //! Serialization versions.\n+    enum Format : uint8_t {\n+        V0_HISTORICAL = 0,    //!< historic format, before commit e6b343d88\n+        V1_DETERMINISTIC = 1, //!< for pre-asmap files\n+        V2_ASMAP = 2,         //!< for files including asmap version\n+        V3_BIP155 = 3,        //!< same as V2_ASMAP plus addresses are in BIP155 format\n+    };\n+\n+    //! The maximum format this software knows it can unserialize. Also, we always serialize\n+    //! in this format.\n+    //! The format (first byte in the serialized stream) can be higher than this and\n+    //! still this software may be able to unserialize the file - if the second byte\n+    //! (see `lowest_compatible` in `Unserialize()`) is less or equal to this.\n+    static constexpr Format FILE_FORMAT = Format::V3_BIP155;\n+\n+    //! The initial value of a field that is incremented every time an incompatible format\n+    //! change is made (such that old software versions would not be able to parse and\n+    //! understand the new file format). This is 32 because we overtook the \"key size\"\n+    //! field which was 32 historically.\n+    //! @note Don't increment this. Increment `lowest_compatible` in `Serialize()` instead.\n+    static constexpr uint8_t INCOMPATIBILITY_BASE = 32;\n+\n+    //! last used nId\n+    int nIdCount GUARDED_BY(cs){0};\n+\n+    //! table with information about all nIds\n+    std::unordered_map<int, AddrInfo> mapInfo GUARDED_BY(cs);\n+\n+    //! find an nId based on its network address\n+    std::unordered_map<CNetAddr, int, CNetAddrHash> mapAddr GUARDED_BY(cs);\n+\n+    //! randomly-ordered vector of all nIds\n+    //! This is mutable because it is unobservable outside the class, so any\n+    //! changes to it (even in const methods) are also unobservable.\n+    mutable std::vector<int> vRandom GUARDED_BY(cs);\n+\n+    // number of \"tried\" entries\n+    int nTried GUARDED_BY(cs){0};\n+\n+    //! list of \"tried\" buckets\n+    int vvTried[ADDRMAN_TRIED_BUCKET_COUNT][ADDRMAN_BUCKET_SIZE] GUARDED_BY(cs);\n+\n+    //! number of (unique) \"new\" entries\n+    int nNew GUARDED_BY(cs){0};\n+\n+    //! list of \"new\" buckets\n+    int vvNew[ADDRMAN_NEW_BUCKET_COUNT][ADDRMAN_BUCKET_SIZE] GUARDED_BY(cs);\n+\n+    //! last time Good was called (memory only). Initially set to 1 so that \"never\" is strictly worse.\n+    int64_t nLastGood GUARDED_BY(cs){1};\n+\n+    //! Holds addrs inserted into tried table that collide with existing entries. Test-before-evict discipline used to resolve these collisions.\n+    std::set<int> m_tried_collisions;\n+\n+    /** Perform consistency checks every m_consistency_check_ratio operations (if non-zero). */\n+    const int32_t m_consistency_check_ratio;\n+\n+    // Compressed IP->ASN mapping, loaded from a file when a node starts.\n+    // Should be always empty if no file was provided.\n+    // This mapping is then used for bucketing nodes in Addrman.\n+    //\n+    // If asmap is provided, nodes will be bucketed by\n+    // AS they belong to, in order to make impossible for a node\n+    // to connect to several nodes hosted in a single AS.\n+    // This is done in response to Erebus attack, but also to generally\n+    // diversify the connections every node creates,\n+    // especially useful when a large fraction of nodes\n+    // operate under a couple of cloud providers.\n+    //\n+    // If a new asmap was provided, the existing records\n+    // would be re-bucketed accordingly.\n+    const std::vector<bool> m_asmap;\n+\n+    //! Find an entry.\n+    AddrInfo* Find(const CNetAddr& addr, int* pnId = nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    //! Create a new entry and add it to the internal data structures mapInfo, mapAddr and vRandom.\n+    AddrInfo* Create(const CAddress& addr, const CNetAddr& addrSource, int* pnId = nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    //! Swap two elements in vRandom.\n+    void SwapRandom(unsigned int nRandomPos1, unsigned int nRandomPos2) const EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    //! Move an entry from the \"new\" table(s) to the \"tried\" table\n+    void MakeTried(AddrInfo& info, int nId) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    //! Delete an entry. It must not be in tried, and have refcount 0.\n+    void Delete(int nId) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    //! Clear a position in a \"new\" table. This is the only place where entries are actually deleted.\n+    void ClearNew(int nUBucket, int nUBucketPos) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    void Good_(const CService& addr, bool test_before_evict, int64_t time) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    bool Add_(const CAddress& addr, const CNetAddr& source, int64_t nTimePenalty) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    void Attempt_(const CService& addr, bool fCountFailure, int64_t nTime) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    std::pair<CAddress, int64_t> Select_(bool newOnly) const EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    void ResolveCollisions_() EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    std::pair<CAddress, int64_t> SelectTriedCollision_() EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    //! Consistency check, taking into account m_consistency_check_ratio. Will std::abort if an inconsistency is detected.\n+    void Check() const EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    //! Perform consistency check, regardless of m_consistency_check_ratio.\n+    //! @returns an error code or zero.\n+    int ForceCheckAddrman() const EXCLUSIVE_LOCKS_REQUIRED(cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r714665818",
      "id" : 714665818,
      "line" : 282,
      "node_id" : "PRRC_kwDOABII584qmO9a",
      "original_commit_id" : "bb22a365c85f76537aba61c36277fa49d68d5c9f",
      "original_line" : 282,
      "original_position" : 282,
      "original_start_line" : 277,
      "path" : "src/addrman_impl.h",
      "position" : 282,
      "pull_request_review_id" : 761829604,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950",
      "side" : "RIGHT",
      "start_line" : 277,
      "start_side" : "RIGHT",
      "updated_at" : "2021-09-23T10:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714665818",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> If this is being done in the name of compilation performance, do you have any measurements justifying the change?\r\n\r\n@jamesob - the most significant impact would be on _recompilation_ times. By totally separating the implementation from the interface, we can make changes to the implementation without any impact on client code that calls into this component. For example, on this branch, making the following change:\r\n\r\n<details>\r\n<summary>Code change</summary>\r\n\r\n```diff\r\ndiff --git a/src/addrman.cpp b/src/addrman.cpp\r\nindex ac2635249c..1257a7503f 100644\r\n--- a/src/addrman.cpp\r\n+++ b/src/addrman.cpp\r\n@@ -1015,7 +1015,7 @@ bool AddrManImpl::Add(const std::vector<CAddress>& vAddr, const CNetAddr& source\r\n         nAdd += Add_(*it, source, nTimePenalty) ? 1 : 0;\r\n     Check();\r\n     if (nAdd) {\r\n-        LogPrint(BCLog::ADDRMAN, \"Added %i addresses from %s: %i tried, %i new\\n\", nAdd, source.ToString(), nTried, nNew);\r\n+        LogPrint(BCLog::ADDRMAN, \"Added %i addresses from %s: %i tried, %i new, %i collisions\\n\", nAdd, source.ToString(), nTried, nNew, m_tried_collisions.size());\r\n     }\r\n     return nAdd > 0;\r\n }\r\n```\r\n</details>\r\n\r\nRecompiles for me in about 35s:\r\n\r\n<details>\r\n<summary>Build</summary>\r\n\r\n```\r\nâ time make\r\nMaking all in src\r\nmake[1]: Entering directory '/home/vagrant/bitcoin/src'\r\nmake[2]: Entering directory '/home/vagrant/bitcoin/src'\r\nmake[3]: Entering directory '/home/vagrant/bitcoin'\r\nmake[3]: Leaving directory '/home/vagrant/bitcoin'\r\n  CXX      libbitcoin_server_a-addrman.o\r\n  AR       libbitcoin_server.a\r\n  CXXLD    bitcoind\r\n  CXXLD    test/test_bitcoin\r\n  CXXLD    bench/bench_bitcoin\r\n  CXXLD    test/fuzz/fuzz\r\nmake[2]: Leaving directory '/home/vagrant/bitcoin/src'\r\nmake[1]: Leaving directory '/home/vagrant/bitcoin/src'\r\nMaking all in doc/man\r\nmake[1]: Entering directory '/home/vagrant/bitcoin/doc/man'\r\nmake[1]: Nothing to be done for 'all'.\r\nmake[1]: Leaving directory '/home/vagrant/bitcoin/doc/man'\r\nmake[1]: Entering directory '/home/vagrant/bitcoin'\r\nmake[1]: Nothing to be done for 'all-am'.\r\nmake[1]: Leaving directory '/home/vagrant/bitcoin'\r\n\r\nreal    0m35.758s\r\nuser    0m26.836s\r\nsys     0m7.951s\r\n```\r\n\r\n</details>\r\n\r\nOn master, making the equivalent change:\r\n\r\n<details>\r\n<summary>Code change</summary>\r\n\r\n```diff\r\ndiff --git a/src/addrman.h b/src/addrman.h\r\nindex 7dd8528bef..08f158f6c6 100644\r\n--- a/src/addrman.h\r\n+++ b/src/addrman.h\r\n@@ -174,7 +174,7 @@ public:\r\n             nAdd += Add_(*it, source, nTimePenalty) ? 1 : 0;\r\n         Check();\r\n         if (nAdd) {\r\n-            LogPrint(BCLog::ADDRMAN, \"Added %i addresses from %s: %i tried, %i new\\n\", nAdd, source.ToString(), nTried, nNew);\r\n+            LogPrint(BCLog::ADDRMAN, \"Added %i addresses from %s: %i tried, %i new, %i collisions\\n\", nAdd, source.ToString(), nTried, nNew, m_tried_collisions.size());\r\n         }\r\n         return nAdd > 0;\r\n     }\r\n```\r\n\r\n</details>\r\n\r\nresults in a very long build of 9m29s, since those changes get included in many other translation units:\r\n\r\n<details>\r\n<summary>Build</summary>\r\n\r\n```\r\nâ time make\r\nMaking all in src\r\nmake[1]: Entering directory '/home/vagrant/bitcoin/src'\r\nmake[2]: Entering directory '/home/vagrant/bitcoin/src'\r\nmake[3]: Entering directory '/home/vagrant/bitcoin'\r\nmake[3]: Leaving directory '/home/vagrant/bitcoin'\r\n  CXX      init/bitcoind-bitcoind.o\r\n  CXX      libbitcoin_server_a-addrdb.o\r\n  CXX      libbitcoin_server_a-addrman.o\r\n  CXX      libbitcoin_server_a-init.o\r\n  CXX      libbitcoin_server_a-mapport.o\r\n  CXX      libbitcoin_server_a-net.o\r\n  CXX      libbitcoin_server_a-net_processing.o\r\n  CXX      node/libbitcoin_server_a-context.o\r\n  CXX      node/libbitcoin_server_a-interfaces.o\r\n  CXX      node/libbitcoin_server_a-transaction.o\r\n  CXX      rpc/libbitcoin_server_a-mining.o\r\n  CXX      rpc/libbitcoin_server_a-net.o\r\n  CXX      libbitcoin_server_a-torcontrol.o\r\n  CXX      libbitcoin_server_a-txorphanage.o\r\n  CXX      libbitcoin_server_a-txrequest.o\r\n  CXX      wallet/libbitcoin_server_a-init.o\r\n  AR       libbitcoin_server.a\r\n  CXX      interfaces/libbitcoin_util_a-init.o\r\n  AR       libbitcoin_util.a\r\n  CXXLD    bitcoind\r\n  CXXLD    bitcoin-cli\r\n  CXXLD    bitcoin-tx\r\n  CXXLD    bitcoin-wallet\r\n  CXXLD    bitcoin-util\r\n  CXX      test/test_bitcoin-addrman_tests.o\r\n  CXX      test/test_bitcoin-denialofservice_tests.o\r\n  CXX      test/test_bitcoin-i2p_tests.o\r\n  CXX      test/test_bitcoin-validation_tests.o\r\n  CXX      test/test_bitcoin-net_peer_eviction_tests.o\r\n  CXX      test/test_bitcoin-net_tests.o\r\n  CXX      test/test_bitcoin-txrequest_tests.o\r\n  CXX      test/util/libtest_util_a-net.o\r\n  CXX      test/util/libtest_util_a-setup_common.o\r\n  AR       libtest_util.a\r\n  CXXLD    test/test_bitcoin\r\n  CXX      test/fuzz/fuzz-addition_overflow.o\r\n  CXX      test/fuzz/fuzz-addrman.o\r\n  CXX      test/fuzz/fuzz-autofile.o\r\n  CXX      test/fuzz/fuzz-banman.o\r\n  CXX      test/fuzz/fuzz-block_header.o\r\n  CXX      test/fuzz/fuzz-blockfilter.o\r\n  CXX      test/fuzz/fuzz-bloom_filter.o\r\n  CXX      test/fuzz/fuzz-buffered_file.o\r\n  CXX      test/fuzz/fuzz-chain.o\r\n  CXX      test/fuzz/fuzz-checkqueue.o\r\n  CXX      test/fuzz/fuzz-coins_view.o\r\n  CXX      test/fuzz/fuzz-connman.o\r\n  CXX      test/fuzz/fuzz-crypto.o\r\n  CXX      test/fuzz/fuzz-crypto_aes256.o\r\n  CXX      test/fuzz/fuzz-crypto_aes256cbc.o\r\n  CXX      test/fuzz/fuzz-crypto_chacha20.o\r\n  CXX      test/fuzz/fuzz-crypto_chacha20_poly1305_aead.o\r\n  CXX      test/fuzz/fuzz-crypto_common.o\r\n  CXX      test/fuzz/fuzz-crypto_hkdf_hmac_sha256_l32.o\r\n  CXX      test/fuzz/fuzz-crypto_poly1305.o\r\n  CXX      test/fuzz/fuzz-cuckoocache.o\r\n  CXX      test/fuzz/fuzz-deserialize.o\r\n  CXX      test/fuzz/fuzz-fee_rate.o\r\n  CXX      test/fuzz/fuzz-fees.o\r\n  CXX      test/fuzz/fuzz-flatfile.o\r\n  CXX      test/fuzz/fuzz-float.o\r\ntest/fuzz/float.cpp: In function âvoid float_fuzz_target(FuzzBufferType)â:\r\ntest/fuzz/float.cpp:60:30: warning: âtmpâ may be used uninitialized in this function [-Wmaybe-uninitialized]\r\n   60 |         assert(std::isnan(d) || d == d_deserialized);\r\n      |                              ^~\r\n  CXX      test/fuzz/fuzz-golomb_rice.o\r\n  CXX      test/fuzz/fuzz-http_request.o\r\n  CXX      test/fuzz/fuzz-i2p.o\r\n  CXX      test/fuzz/fuzz-integer.o\r\n  CXX      test/fuzz/fuzz-kitchen_sink.o\r\n  CXX      test/fuzz/fuzz-load_external_block_file.o\r\n  CXX      test/fuzz/fuzz-merkleblock.o\r\n  CXX      test/fuzz/fuzz-message.o\r\n  CXX      test/fuzz/fuzz-muhash.o\r\n  CXX      test/fuzz/fuzz-multiplication_overflow.o\r\n  CXX      test/fuzz/fuzz-net.o\r\n  CXX      test/fuzz/fuzz-net_permissions.o\r\n  CXX      test/fuzz/fuzz-netaddress.o\r\n  CXX      test/fuzz/fuzz-netbase_dns_lookup.o\r\n  CXX      test/fuzz/fuzz-node_eviction.o\r\n  CXX      test/fuzz/fuzz-p2p_transport_serialization.o\r\n  CXX      test/fuzz/fuzz-parse_hd_keypath.o\r\n  CXX      test/fuzz/fuzz-policy_estimator.o\r\n  CXX      test/fuzz/fuzz-policy_estimator_io.o\r\n  CXX      test/fuzz/fuzz-pow.o\r\n  CXX      test/fuzz/fuzz-primitives_transaction.o\r\n  CXX      test/fuzz/fuzz-process_message.o\r\n  CXX      test/fuzz/fuzz-process_messages.o\r\n  CXX      test/fuzz/fuzz-protocol.o\r\n  CXX      test/fuzz/fuzz-random.o\r\n  CXX      test/fuzz/fuzz-rbf.o\r\n  CXX      test/fuzz/fuzz-rolling_bloom_filter.o\r\n  CXX      test/fuzz/fuzz-rpc.o\r\n  CXX      test/fuzz/fuzz-script.o\r\n  CXX      test/fuzz/fuzz-script_bitcoin_consensus.o\r\n  CXX      test/fuzz/fuzz-script_descriptor_cache.o\r\n  CXX      test/fuzz/fuzz-script_interpreter.o\r\n  CXX      test/fuzz/fuzz-script_ops.o\r\n  CXX      test/fuzz/fuzz-script_sigcache.o\r\n  CXX      test/fuzz/fuzz-script_sign.o\r\n  CXX      test/fuzz/fuzz-scriptnum_ops.o\r\n  CXX      test/fuzz/fuzz-secp256k1_ec_seckey_import_export_der.o\r\n  CXX      test/fuzz/fuzz-secp256k1_ecdsa_signature_parse_der_lax.o\r\n  CXX      test/fuzz/fuzz-signature_checker.o\r\n  CXX      test/fuzz/fuzz-signet.o\r\n  CXX      test/fuzz/fuzz-socks5.o\r\n  CXX      test/fuzz/fuzz-span.o\r\n  CXX      test/fuzz/fuzz-string.o\r\n  CXX      test/fuzz/fuzz-strprintf.o\r\n  CXX      test/fuzz/fuzz-system.o\r\n  CXX      test/fuzz/fuzz-timedata.o\r\n  CXX      test/fuzz/fuzz-torcontrol.o\r\n  CXX      test/fuzz/fuzz-tx_pool.o\r\n  CXX      test/fuzz/fuzz-txrequest.o\r\n  CXX      test/fuzz/fuzz-utxo_snapshot.o\r\n  CXX      test/fuzz/fuzz-validation_load_mempool.o\r\n  CXX      test/fuzz/fuzz-versionbits.o\r\n  CXX      test/fuzz/libtest_fuzz_a-util.o\r\n  AR       libtest_fuzz.a\r\n  CXXLD    test/fuzz/fuzz\r\nmake[2]: Leaving directory '/home/vagrant/bitcoin/src'\r\nmake[1]: Leaving directory '/home/vagrant/bitcoin/src'\r\nMaking all in doc/man\r\nmake[1]: Entering directory '/home/vagrant/bitcoin/doc/man'\r\nmake[1]: Nothing to be done for 'all'.\r\nmake[1]: Leaving directory '/home/vagrant/bitcoin/doc/man'\r\nmake[1]: Entering directory '/home/vagrant/bitcoin'\r\nmake[1]: Nothing to be done for 'all-am'.\r\nmake[1]: Leaving directory '/home/vagrant/bitcoin'\r\n\r\nreal\t9m29.276s\r\nuser\t8m34.052s\r\nsys\t0m51.490s\r\n\r\n```\r\n\r\n</details>\r\n\r\n(gui and bench were disabled for all builds - I expect the difference would be even more pronounced with those components also enabled).\r\n\r\nThere may be a marginal speed up in compiling from scratch since the header is slimmed down, but I expect it'd be a small improvement.\r\n\r\nHowever, for me the improved recompilation time is **not** the main motivation for this change. There are two motivations which I think are more important:\r\n\r\n1. Slimming down the header file to just well-documented interface methods makes it much easier for people writing client code that relies on addrman to very quickly understand the class's responsibilities and contracts without having to concern themselves with the internal implementation details.\r\n2. The upcoming rework of addrman (https://github.com/sipa/bitcoin/tree/202106_multiindex_addrman) can be achieved with _just_ changes to addrman.cpp, leaving the interface and header file the same. That makes it much easier to review, verify that there are no functional changes, and test conformance between the old and new implementations.",
      "created_at" : "2021-09-23T11:11:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#issuecomment-925715583",
      "id" : 925715583,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22950",
      "node_id" : "IC_kwDOABII5843LUx_",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-23T11:11:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/925715583",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-09-24T18:06:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#issuecomment-926824949",
      "id" : 926824949,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22950",
      "node_id" : "IC_kwDOABII5843Pjn1",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-24T18:06:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/926824949",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r715892071"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/715892071"
         }
      },
      "author_association" : "MEMBER",
      "body" : "to make sure I understand correctly, is this the order you're suggesting? \r\n- `AddrManImpl::Serialize`\r\n- `AddrManImpl::Unserialize`\r\n- explicit instantiations\r\n- `AddrManImpl` [ other functions ]\r\n- `AddrMan::Serialize`\r\n- `AddrMan::Unserialize`\r\n\r\nThe reason I think the current order makes more sense is because the explicit instantiations are for the `AddrMan` template, not the impl template.",
      "commit_id" : "0cc7031002079b35953bac1e9d4268b6321893c7",
      "created_at" : "2021-09-24T20:40:47Z",
      "diff_hunk" : "@@ -1004,16 +987,184 @@ CAddrInfo CAddrMan::SelectTriedCollision_()\n     // If id_new not found in mapInfo remove it from m_tried_collisions\n     if (mapInfo.count(id_new) != 1) {\n         m_tried_collisions.erase(it);\n-        return CAddrInfo();\n+        return {};\n     }\n \n-    const CAddrInfo& newInfo = mapInfo[id_new];\n+    const AddrInfo& newInfo = mapInfo[id_new];\n \n     // which tried bucket to move the entry to\n     int tried_bucket = newInfo.GetTriedBucket(nKey, m_asmap);\n     int tried_bucket_pos = newInfo.GetBucketPosition(nKey, false, tried_bucket);\n \n-    int id_old = vvTried[tried_bucket][tried_bucket_pos];\n+    auto info_old = mapInfo[vvTried[tried_bucket][tried_bucket_pos]];\n+    return {info_old, info_old.nLastTry};\n+}\n+\n+size_t AddrManImpl::size() const\n+{\n+    LOCK(cs); // TODO: Cache this in an atomic to avoid this overhead\n+    return vRandom.size();\n+}\n+\n+bool AddrManImpl::Add(const std::vector<CAddress>& vAddr, const CNetAddr& source, int64_t nTimePenalty)\n+{\n+    LOCK(cs);\n+    int nAdd = 0;\n+    Check();\n+    for (std::vector<CAddress>::const_iterator it = vAddr.begin(); it != vAddr.end(); it++)\n+        nAdd += Add_(*it, source, nTimePenalty) ? 1 : 0;\n+    Check();\n+    if (nAdd) {\n+        LogPrint(BCLog::ADDRMAN, \"Added %i addresses from %s: %i tried, %i new\\n\", nAdd, source.ToString(), nTried, nNew);\n+    }\n+    return nAdd > 0;\n+}\n+\n+void AddrManImpl::Good(const CService& addr, int64_t nTime)\n+{\n+    LOCK(cs);\n+    Check();\n+    Good_(addr, /* test_before_evict */ true, nTime);\n+    Check();\n+}\n+\n+void AddrManImpl::Attempt(const CService& addr, bool fCountFailure, int64_t nTime)\n+{\n+    LOCK(cs);\n+    Check();\n+    Attempt_(addr, fCountFailure, nTime);\n+    Check();\n+}\n+\n+void AddrManImpl::ResolveCollisions()\n+{\n+    LOCK(cs);\n+    Check();\n+    ResolveCollisions_();\n+    Check();\n+}\n+\n+std::pair<CAddress, int64_t> AddrManImpl::SelectTriedCollision()\n+{\n+    LOCK(cs);\n+    Check();\n+    const auto ret = SelectTriedCollision_();\n+    Check();\n+    return ret;\n+}\n+\n+std::pair<CAddress, int64_t> AddrManImpl::Select(bool newOnly) const\n+{\n+    LOCK(cs);\n+    Check();\n+    const auto addrRet = Select_(newOnly);\n+    Check();\n+    return addrRet;\n+}\n+\n+std::vector<CAddress> AddrManImpl::GetAddr(size_t max_addresses, size_t max_pct, std::optional<Network> network) const\n+{\n+    LOCK(cs);\n+    Check();\n+    const auto addresses = GetAddr_(max_addresses, max_pct, network);\n+    Check();\n+    return addresses;\n+}\n+\n+void AddrManImpl::Connected(const CService& addr, int64_t nTime)\n+{\n+    LOCK(cs);\n+    Check();\n+    Connected_(addr, nTime);\n+    Check();\n+}\n+\n+void AddrManImpl::SetServices(const CService& addr, ServiceFlags nServices)\n+{\n+    LOCK(cs);\n+    Check();\n+    SetServices_(addr, nServices);\n+    Check();\n+}\n+\n+const std::vector<bool>& AddrManImpl::GetAsmap() const\n+{\n+    return m_asmap;\n+}\n+\n+// explicit instantiation",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r715892071",
      "id" : 715892071,
      "in_reply_to_id" : 714656686,
      "line" : 1118,
      "node_id" : "PRRC_kwDOABII584qq6Vn",
      "original_commit_id" : "bb22a365c85f76537aba61c36277fa49d68d5c9f",
      "original_line" : 1118,
      "original_position" : 646,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : 644,
      "pull_request_review_id" : 763459559,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-24T20:40:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/715892071",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r715897043"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/715897043"
         }
      },
      "author_association" : "MEMBER",
      "body" : "hm, but they are still internal functions? ",
      "commit_id" : "0cc7031002079b35953bac1e9d4268b6321893c7",
      "created_at" : "2021-09-24T20:51:00Z",
      "diff_hunk" : "@@ -0,0 +1,291 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_ADDRMAN_IMPL_H\n+#define BITCOIN_ADDRMAN_IMPL_H\n+\n+#include <logging.h>\n+#include <netaddress.h>\n+#include <protocol.h>\n+#include <serialize.h>\n+#include <sync.h>\n+#include <uint256.h>\n+\n+#include <cstdint>\n+#include <set>\n+#include <optional>\n+#include <unordered_map>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/** Total number of buckets for tried addresses */\n+static constexpr int32_t ADDRMAN_TRIED_BUCKET_COUNT_LOG2{8};\n+static constexpr int ADDRMAN_TRIED_BUCKET_COUNT{1 << ADDRMAN_TRIED_BUCKET_COUNT_LOG2};\n+/** Total number of buckets for new addresses */\n+static constexpr int32_t ADDRMAN_NEW_BUCKET_COUNT_LOG2{10};\n+static constexpr int ADDRMAN_NEW_BUCKET_COUNT{1 << ADDRMAN_NEW_BUCKET_COUNT_LOG2};\n+/** Maximum allowed number of entries in buckets for new and tried addresses */\n+static constexpr int32_t ADDRMAN_BUCKET_SIZE_LOG2{6};\n+static constexpr int ADDRMAN_BUCKET_SIZE{1 << ADDRMAN_BUCKET_SIZE_LOG2};\n+\n+/**\n+ * Extended statistics about a CAddress\n+ */\n+class AddrInfo : public CAddress\n+{\n+public:\n+    //! last try whatsoever by us (memory only)\n+    int64_t nLastTry{0};\n+\n+    //! last counted attempt (memory only)\n+    int64_t nLastCountAttempt{0};\n+\n+    //! where knowledge about this address first came from\n+    CNetAddr source;\n+\n+    //! last successful connection by us\n+    int64_t nLastSuccess{0};\n+\n+    //! connection attempts since last successful attempt\n+    int nAttempts{0};\n+\n+    //! reference count in new sets (memory only)\n+    int nRefCount{0};\n+\n+    //! in tried set? (memory only)\n+    bool fInTried{false};\n+\n+    //! position in vRandom\n+    mutable int nRandomPos{-1};\n+\n+    SERIALIZE_METHODS(AddrInfo, obj)\n+    {\n+        READWRITEAS(CAddress, obj);\n+        READWRITE(obj.source, obj.nLastSuccess, obj.nAttempts);\n+    }\n+\n+    AddrInfo(const CAddress& addrIn, const CNetAddr& addrSource) : CAddress(addrIn), source(addrSource)\n+    {\n+    }\n+\n+    AddrInfo() : CAddress(), source()\n+    {\n+    }\n+\n+    //! Calculate in which \"tried\" bucket this entry belongs\n+    int GetTriedBucket(const uint256& nKey, const std::vector<bool>& asmap) const;\n+\n+    //! Calculate in which \"new\" bucket this entry belongs, given a certain source\n+    int GetNewBucket(const uint256& nKey, const CNetAddr& src, const std::vector<bool>& asmap) const;\n+\n+    //! Calculate in which \"new\" bucket this entry belongs, using its default source\n+    int GetNewBucket(const uint256& nKey, const std::vector<bool>& asmap) const\n+    {\n+        return GetNewBucket(nKey, source, asmap);\n+    }\n+\n+    //! Calculate in which position of a bucket to store this entry.\n+    int GetBucketPosition(const uint256& nKey, bool fNew, int nBucket) const;\n+\n+    //! Determine whether the statistics about this entry are bad enough so that it can just be deleted\n+    bool IsTerrible(int64_t nNow = GetAdjustedTime()) const;\n+\n+    //! Calculate the relative chance this entry should be given when selecting nodes to connect to\n+    double GetChance(int64_t nNow = GetAdjustedTime()) const;\n+};\n+\n+class AddrManImpl\n+{\n+public:\n+    AddrManImpl(std::vector<bool>&& asmap, bool deterministic, int32_t consistency_check_ratio)\n+        : insecure_rand{deterministic}\n+        , nKey{deterministic ? uint256{1} : insecure_rand.rand256()}\n+        , m_consistency_check_ratio{consistency_check_ratio}\n+        , m_asmap{std::move(asmap)}\n+    {\n+        for (auto& bucket : vvNew) {\n+            for (auto& entry : bucket) {\n+                entry = -1;\n+            }\n+        }\n+        for (auto& bucket : vvTried) {\n+            for (auto& entry : bucket) {\n+                entry = -1;\n+            }\n+        }\n+    }\n+\n+    ~AddrManImpl()\n+    {\n+        nKey.SetNull();\n+    }\n+\n+\n+    template <typename Stream>\n+    void Serialize(Stream& s_) const EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    template <typename Stream>\n+    void Unserialize(Stream& s_) EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    size_t size() const EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    bool Add(const std::vector<CAddress>& vAddr, const CNetAddr& source, int64_t nTimePenalty = 0)\n+        EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    void Good(const CService& addr, int64_t nTime = GetAdjustedTime())\n+        EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    void Attempt(const CService& addr, bool fCountFailure, int64_t nTime = GetAdjustedTime())\n+        EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    void ResolveCollisions() EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    std::pair<CAddress, int64_t> SelectTriedCollision() EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    std::pair<CAddress, int64_t> Select(bool newOnly = false) const\n+        EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    std::vector<CAddress> GetAddr(size_t max_addresses, size_t max_pct, std::optional<Network> network) const\n+        EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    void Connected(const CService& addr, int64_t nTime = GetAdjustedTime())\n+        EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    void SetServices(const CService& addr, ServiceFlags nServices)\n+        EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    const std::vector<bool>& GetAsmap() const;\n+\n+    friend class AddrManTest;\n+    friend class AddrManDeterministic;\n+\n+private:\n+    //! A mutex to protect the inner data structures.\n+    mutable Mutex cs;\n+\n+    //! Source of random numbers for randomization in inner loops\n+    mutable FastRandomContext insecure_rand GUARDED_BY(cs);\n+\n+    //! secret key to randomize bucket select with\n+    uint256 nKey;\n+\n+    //! Serialization versions.\n+    enum Format : uint8_t {\n+        V0_HISTORICAL = 0,    //!< historic format, before commit e6b343d88\n+        V1_DETERMINISTIC = 1, //!< for pre-asmap files\n+        V2_ASMAP = 2,         //!< for files including asmap version\n+        V3_BIP155 = 3,        //!< same as V2_ASMAP plus addresses are in BIP155 format\n+    };\n+\n+    //! The maximum format this software knows it can unserialize. Also, we always serialize\n+    //! in this format.\n+    //! The format (first byte in the serialized stream) can be higher than this and\n+    //! still this software may be able to unserialize the file - if the second byte\n+    //! (see `lowest_compatible` in `Unserialize()`) is less or equal to this.\n+    static constexpr Format FILE_FORMAT = Format::V3_BIP155;\n+\n+    //! The initial value of a field that is incremented every time an incompatible format\n+    //! change is made (such that old software versions would not be able to parse and\n+    //! understand the new file format). This is 32 because we overtook the \"key size\"\n+    //! field which was 32 historically.\n+    //! @note Don't increment this. Increment `lowest_compatible` in `Serialize()` instead.\n+    static constexpr uint8_t INCOMPATIBILITY_BASE = 32;\n+\n+    //! last used nId\n+    int nIdCount GUARDED_BY(cs){0};\n+\n+    //! table with information about all nIds\n+    std::unordered_map<int, AddrInfo> mapInfo GUARDED_BY(cs);\n+\n+    //! find an nId based on its network address\n+    std::unordered_map<CNetAddr, int, CNetAddrHash> mapAddr GUARDED_BY(cs);\n+\n+    //! randomly-ordered vector of all nIds\n+    //! This is mutable because it is unobservable outside the class, so any\n+    //! changes to it (even in const methods) are also unobservable.\n+    mutable std::vector<int> vRandom GUARDED_BY(cs);\n+\n+    // number of \"tried\" entries\n+    int nTried GUARDED_BY(cs){0};\n+\n+    //! list of \"tried\" buckets\n+    int vvTried[ADDRMAN_TRIED_BUCKET_COUNT][ADDRMAN_BUCKET_SIZE] GUARDED_BY(cs);\n+\n+    //! number of (unique) \"new\" entries\n+    int nNew GUARDED_BY(cs){0};\n+\n+    //! list of \"new\" buckets\n+    int vvNew[ADDRMAN_NEW_BUCKET_COUNT][ADDRMAN_BUCKET_SIZE] GUARDED_BY(cs);\n+\n+    //! last time Good was called (memory only). Initially set to 1 so that \"never\" is strictly worse.\n+    int64_t nLastGood GUARDED_BY(cs){1};\n+\n+    //! Holds addrs inserted into tried table that collide with existing entries. Test-before-evict discipline used to resolve these collisions.\n+    std::set<int> m_tried_collisions;\n+\n+    /** Perform consistency checks every m_consistency_check_ratio operations (if non-zero). */\n+    const int32_t m_consistency_check_ratio;\n+\n+    // Compressed IP->ASN mapping, loaded from a file when a node starts.\n+    // Should be always empty if no file was provided.\n+    // This mapping is then used for bucketing nodes in Addrman.\n+    //\n+    // If asmap is provided, nodes will be bucketed by\n+    // AS they belong to, in order to make impossible for a node\n+    // to connect to several nodes hosted in a single AS.\n+    // This is done in response to Erebus attack, but also to generally\n+    // diversify the connections every node creates,\n+    // especially useful when a large fraction of nodes\n+    // operate under a couple of cloud providers.\n+    //\n+    // If a new asmap was provided, the existing records\n+    // would be re-bucketed accordingly.\n+    const std::vector<bool> m_asmap;\n+\n+    //! Find an entry.\n+    AddrInfo* Find(const CNetAddr& addr, int* pnId = nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    //! Create a new entry and add it to the internal data structures mapInfo, mapAddr and vRandom.\n+    AddrInfo* Create(const CAddress& addr, const CNetAddr& addrSource, int* pnId = nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    //! Swap two elements in vRandom.\n+    void SwapRandom(unsigned int nRandomPos1, unsigned int nRandomPos2) const EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    //! Move an entry from the \"new\" table(s) to the \"tried\" table\n+    void MakeTried(AddrInfo& info, int nId) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    //! Delete an entry. It must not be in tried, and have refcount 0.\n+    void Delete(int nId) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    //! Clear a position in a \"new\" table. This is the only place where entries are actually deleted.\n+    void ClearNew(int nUBucket, int nUBucketPos) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    void Good_(const CService& addr, bool test_before_evict, int64_t time) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    bool Add_(const CAddress& addr, const CNetAddr& source, int64_t nTimePenalty) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    void Attempt_(const CService& addr, bool fCountFailure, int64_t nTime) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    std::pair<CAddress, int64_t> Select_(bool newOnly) const EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    void ResolveCollisions_() EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    std::pair<CAddress, int64_t> SelectTriedCollision_() EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    //! Consistency check, taking into account m_consistency_check_ratio. Will std::abort if an inconsistency is detected.\n+    void Check() const EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    //! Perform consistency check, regardless of m_consistency_check_ratio.\n+    //! @returns an error code or zero.\n+    int ForceCheckAddrman() const EXCLUSIVE_LOCKS_REQUIRED(cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r715897043",
      "id" : 715897043,
      "in_reply_to_id" : 714665818,
      "line" : 262,
      "node_id" : "PRRC_kwDOABII584qq7jT",
      "original_commit_id" : "bb22a365c85f76537aba61c36277fa49d68d5c9f",
      "original_line" : 262,
      "original_position" : 282,
      "original_start_line" : 277,
      "path" : "src/addrman_impl.h",
      "position" : 262,
      "pull_request_review_id" : 763466037,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950",
      "side" : "RIGHT",
      "start_line" : 257,
      "start_side" : "RIGHT",
      "updated_at" : "2021-09-24T20:51:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/715897043",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "latest push: \r\n- rebased to address a small conflict with #23025 \r\n- updated the scripted diffs to use `grep` to generate the file names \r\n- split up the first commit into two parts as suggested in https://github.com/bitcoin/bitcoin/pull/22950#pullrequestreview-761829604\r\n- moved around some code to address review comments ",
      "created_at" : "2021-09-24T21:09:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#issuecomment-926920984",
      "id" : 926920984,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22950",
      "node_id" : "IC_kwDOABII5843P7EY",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-24T21:09:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/926920984",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r715905721"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/715905721"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "0cc7031002079b35953bac1e9d4268b6321893c7",
      "created_at" : "2021-09-24T21:10:06Z",
      "diff_hunk" : "@@ -101,26 +103,13 @@ double CAddrInfo::GetChance(int64_t nNow) const\n     return fChance;\n }\n \n-CAddrMan::CAddrMan(std::vector<bool> asmap, bool deterministic, int32_t consistency_check_ratio)\n-    : insecure_rand{deterministic}\n-    , nKey{deterministic ? uint256{1} : insecure_rand.rand256()}\n-    , m_consistency_check_ratio{consistency_check_ratio}\n-    , m_asmap{std::move(asmap)}\n-{\n-    for (auto& bucket : vvNew) {\n-        for (auto& entry : bucket) {\n-            entry = -1;\n-        }\n-    }\n-    for (auto& bucket : vvTried) {\n-        for (auto& entry : bucket) {\n-            entry = -1;\n-        }\n-    }\n-}\n+AddrMan::AddrMan(std::vector<bool> asmap, bool deterministic, int32_t consistency_check_ratio)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r715905721",
      "id" : 715905721,
      "in_reply_to_id" : 714662483,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584qq9q5",
      "original_commit_id" : "bb22a365c85f76537aba61c36277fa49d68d5c9f",
      "original_line" : 106,
      "original_position" : 97,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : null,
      "pull_request_review_id" : 763477577,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-24T21:10:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/715905721",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r715905837"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/715905837"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "0cc7031002079b35953bac1e9d4268b6321893c7",
      "created_at" : "2021-09-24T21:10:18Z",
      "diff_hunk" : "@@ -0,0 +1,291 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_ADDRMAN_IMPL_H\n+#define BITCOIN_ADDRMAN_IMPL_H\n+\n+#include <logging.h>\n+#include <netaddress.h>\n+#include <protocol.h>\n+#include <serialize.h>\n+#include <sync.h>\n+#include <uint256.h>\n+\n+#include <cstdint>\n+#include <set>\n+#include <optional>\n+#include <unordered_map>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/** Total number of buckets for tried addresses */\n+static constexpr int32_t ADDRMAN_TRIED_BUCKET_COUNT_LOG2{8};\n+static constexpr int ADDRMAN_TRIED_BUCKET_COUNT{1 << ADDRMAN_TRIED_BUCKET_COUNT_LOG2};\n+/** Total number of buckets for new addresses */\n+static constexpr int32_t ADDRMAN_NEW_BUCKET_COUNT_LOG2{10};\n+static constexpr int ADDRMAN_NEW_BUCKET_COUNT{1 << ADDRMAN_NEW_BUCKET_COUNT_LOG2};\n+/** Maximum allowed number of entries in buckets for new and tried addresses */\n+static constexpr int32_t ADDRMAN_BUCKET_SIZE_LOG2{6};\n+static constexpr int ADDRMAN_BUCKET_SIZE{1 << ADDRMAN_BUCKET_SIZE_LOG2};\n+\n+/**\n+ * Extended statistics about a CAddress\n+ */\n+class AddrInfo : public CAddress\n+{\n+public:\n+    //! last try whatsoever by us (memory only)\n+    int64_t nLastTry{0};\n+\n+    //! last counted attempt (memory only)\n+    int64_t nLastCountAttempt{0};\n+\n+    //! where knowledge about this address first came from\n+    CNetAddr source;\n+\n+    //! last successful connection by us\n+    int64_t nLastSuccess{0};\n+\n+    //! connection attempts since last successful attempt\n+    int nAttempts{0};\n+\n+    //! reference count in new sets (memory only)\n+    int nRefCount{0};\n+\n+    //! in tried set? (memory only)\n+    bool fInTried{false};\n+\n+    //! position in vRandom\n+    mutable int nRandomPos{-1};\n+\n+    SERIALIZE_METHODS(AddrInfo, obj)\n+    {\n+        READWRITEAS(CAddress, obj);\n+        READWRITE(obj.source, obj.nLastSuccess, obj.nAttempts);\n+    }\n+\n+    AddrInfo(const CAddress& addrIn, const CNetAddr& addrSource) : CAddress(addrIn), source(addrSource)\n+    {\n+    }\n+\n+    AddrInfo() : CAddress(), source()\n+    {\n+    }\n+\n+    //! Calculate in which \"tried\" bucket this entry belongs\n+    int GetTriedBucket(const uint256& nKey, const std::vector<bool>& asmap) const;\n+\n+    //! Calculate in which \"new\" bucket this entry belongs, given a certain source\n+    int GetNewBucket(const uint256& nKey, const CNetAddr& src, const std::vector<bool>& asmap) const;\n+\n+    //! Calculate in which \"new\" bucket this entry belongs, using its default source\n+    int GetNewBucket(const uint256& nKey, const std::vector<bool>& asmap) const\n+    {\n+        return GetNewBucket(nKey, source, asmap);\n+    }\n+\n+    //! Calculate in which position of a bucket to store this entry.\n+    int GetBucketPosition(const uint256& nKey, bool fNew, int nBucket) const;\n+\n+    //! Determine whether the statistics about this entry are bad enough so that it can just be deleted\n+    bool IsTerrible(int64_t nNow = GetAdjustedTime()) const;\n+\n+    //! Calculate the relative chance this entry should be given when selecting nodes to connect to\n+    double GetChance(int64_t nNow = GetAdjustedTime()) const;\n+};\n+\n+class AddrManImpl\n+{\n+public:\n+    AddrManImpl(std::vector<bool>&& asmap, bool deterministic, int32_t consistency_check_ratio)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r715905837",
      "id" : 715905837,
      "in_reply_to_id" : 714655994,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584qq9st",
      "original_commit_id" : "bb22a365c85f76537aba61c36277fa49d68d5c9f",
      "original_line" : 102,
      "original_position" : 102,
      "original_start_line" : null,
      "path" : "src/addrman_impl.h",
      "position" : null,
      "pull_request_review_id" : 763477689,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-24T21:10:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/715905837",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r716097906"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/716097906"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: I think using `AddrInfo&` instead of `auto` would make it clearer that it gets sliced to `CAddress` in the next line.",
      "commit_id" : "0cc7031002079b35953bac1e9d4268b6321893c7",
      "created_at" : "2021-09-25T21:05:04Z",
      "diff_hunk" : "@@ -1010,9 +1010,8 @@ CAddrInfo AddrManImpl::SelectTriedCollision_()\n     int tried_bucket = newInfo.GetTriedBucket(nKey, m_asmap);\n     int tried_bucket_pos = newInfo.GetBucketPosition(nKey, false, tried_bucket);\n \n-    int id_old = vvTried[tried_bucket][tried_bucket_pos];\n-\n-    return mapInfo[id_old];\n+    auto info_old = mapInfo[vvTried[tried_bucket][tried_bucket_pos]];",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r716097906",
      "id" : 716097906,
      "line" : 1017,
      "node_id" : "PRRC_kwDOABII584qrsly",
      "original_commit_id" : "21481fe2fe44c56fbf5dcfed69ec382a842f43a2",
      "original_line" : 1013,
      "original_position" : 73,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : 542,
      "pull_request_review_id" : 763630048,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-26T11:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/716097906",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r716099416"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/716099416"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Since this wasn't obvious to me immediately, just noting that this works because the [default constructor](https://en.cppreference.com/w/cpp/utility/pair/pair) of `std::pair` value-initializes both elements (i.e. this returns a pair with a default-initialized `CAddress` and 0 for int64_t).",
      "commit_id" : "0cc7031002079b35953bac1e9d4268b6321893c7",
      "created_at" : "2021-09-25T21:20:13Z",
      "diff_hunk" : "@@ -694,15 +694,13 @@ void AddrManImpl::Attempt_(const CService& addr, bool fCountFailure, int64_t nTi\n     }\n }\n \n-CAddrInfo AddrManImpl::Select_(bool newOnly) const\n+std::pair<CAddress, int64_t> AddrManImpl::Select_(bool newOnly) const\n {\n     AssertLockHeld(cs);\n \n-    if (vRandom.empty())\n-        return CAddrInfo();\n+    if (vRandom.empty()) return {};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r716099416",
      "id" : 716099416,
      "line" : 702,
      "node_id" : "PRRC_kwDOABII584qrs9Y",
      "original_commit_id" : "21481fe2fe44c56fbf5dcfed69ec382a842f43a2",
      "original_line" : 701,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : 346,
      "pull_request_review_id" : 763630048,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-26T11:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/716099416",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r716101195"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/716101195"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The move-only commit f113b09d8ea31bc2e1cf6a5178b3d1d93a1c9bb2 makes `nLastTry` and `nLastCountAttempt` private for one commit.",
      "commit_id" : "0cc7031002079b35953bac1e9d4268b6321893c7",
      "created_at" : "2021-09-25T21:38:58Z",
      "diff_hunk" : "@@ -5,6 +5,77 @@\n #ifndef BITCOIN_ADDRMAN_IMPL_H\n #define BITCOIN_ADDRMAN_IMPL_H\n \n+/**\n+ * Extended statistics about a CAddress\n+ */\n+class CAddrInfo : public CAddress\n+{\n+private:\n+    //! last try whatsoever by us (memory only)\n+    int64_t nLastTry{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r716101195",
      "id" : 716101195,
      "line" : 40,
      "node_id" : "PRRC_kwDOABII584qrtZL",
      "original_commit_id" : "f113b09d8ea31bc2e1cf6a5178b3d1d93a1c9bb2",
      "original_line" : 15,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/addrman_impl.h",
      "position" : 40,
      "pull_request_review_id" : 763630048,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-26T11:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/716101195",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r716499594"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/716499594"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: I'd remove all the default arguments in AddrManImpl, at least in the public interface. Having defaults in both `AddrMan` and `AddrManImpl` can be a source of error when not both are updated",
      "commit_id" : "0cc7031002079b35953bac1e9d4268b6321893c7",
      "created_at" : "2021-09-27T09:06:12Z",
      "diff_hunk" : "@@ -0,0 +1,206 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_ADDRMAN_IMPL_H\n+#define BITCOIN_ADDRMAN_IMPL_H\n+\n+class AddrManImpl\n+{\n+public:\n+    AddrManImpl(std::vector<bool>&& asmap, bool deterministic, int32_t consistency_check_ratio);\n+\n+    ~AddrManImpl();\n+\n+    template <typename Stream>\n+    void Serialize(Stream& s_) const EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    template <typename Stream>\n+    void Unserialize(Stream& s_) EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    size_t size() const EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    bool Add(const std::vector<CAddress> &vAddr, const CNetAddr& source, int64_t nTimePenalty = 0)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r716499594",
      "id" : 716499594,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584qtOqK",
      "original_commit_id" : "527cbd168acb776eb03e4506f186afb5e0a85d90",
      "original_line" : 23,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/addrman_impl.h",
      "position" : null,
      "pull_request_review_id" : 764020359,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-27T09:07:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/716499594",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/14386?v=4",
         "events_url" : "https://api.github.com/users/martinus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/martinus/followers",
         "following_url" : "https://api.github.com/users/martinus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/martinus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/martinus",
         "id" : 14386,
         "login" : "martinus",
         "node_id" : "MDQ6VXNlcjE0Mzg2",
         "organizations_url" : "https://api.github.com/users/martinus/orgs",
         "received_events_url" : "https://api.github.com/users/martinus/received_events",
         "repos_url" : "https://api.github.com/users/martinus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/martinus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/martinus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/martinus"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> One general point: I wonder whether the pattern AddrManImpl::Function() and AddrManImpl::Function_() should still exist in the context of the PImpl, because now there are already two sets of functions that mostly just pass things along. With the recent changes to Check() allowing much more flexibility when and how often to call the checks, maybe it is not necessary anymore and the Check() calls could be merged into the Function_() ? (Changing this shouldn't be part of this PR, just wanted to bring up the idea).\r\n\r\n@mzumsande - I agree that this would be nice. Once this PR has been merged, that kind of change can be made without touching the header file and recompiling anything.\r\n\r\nDo you think it would be overkill to have a variadic template `CheckExecuteCheck()` function that implements the pattern of locking `cs`, running `Check()`, calling the internal function, then running `Check()` again?",
      "created_at" : "2021-09-27T09:37:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#issuecomment-927696951",
      "id" : 927696951,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22950",
      "node_id" : "IC_kwDOABII5843S4g3",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-27T09:37:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/927696951",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r716532315"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/716532315"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I mean that these instantiations of `AddrMan::Serialize()` and `AddrMan::Unserialize()` should be below the template function definitions for `AddrMan::Serialize()` and `AddrMan::Unserialize()` (i.e. just move them down 10 lines).",
      "commit_id" : "0cc7031002079b35953bac1e9d4268b6321893c7",
      "created_at" : "2021-09-27T09:47:43Z",
      "diff_hunk" : "@@ -1004,16 +987,184 @@ CAddrInfo CAddrMan::SelectTriedCollision_()\n     // If id_new not found in mapInfo remove it from m_tried_collisions\n     if (mapInfo.count(id_new) != 1) {\n         m_tried_collisions.erase(it);\n-        return CAddrInfo();\n+        return {};\n     }\n \n-    const CAddrInfo& newInfo = mapInfo[id_new];\n+    const AddrInfo& newInfo = mapInfo[id_new];\n \n     // which tried bucket to move the entry to\n     int tried_bucket = newInfo.GetTriedBucket(nKey, m_asmap);\n     int tried_bucket_pos = newInfo.GetBucketPosition(nKey, false, tried_bucket);\n \n-    int id_old = vvTried[tried_bucket][tried_bucket_pos];\n+    auto info_old = mapInfo[vvTried[tried_bucket][tried_bucket_pos]];\n+    return {info_old, info_old.nLastTry};\n+}\n+\n+size_t AddrManImpl::size() const\n+{\n+    LOCK(cs); // TODO: Cache this in an atomic to avoid this overhead\n+    return vRandom.size();\n+}\n+\n+bool AddrManImpl::Add(const std::vector<CAddress>& vAddr, const CNetAddr& source, int64_t nTimePenalty)\n+{\n+    LOCK(cs);\n+    int nAdd = 0;\n+    Check();\n+    for (std::vector<CAddress>::const_iterator it = vAddr.begin(); it != vAddr.end(); it++)\n+        nAdd += Add_(*it, source, nTimePenalty) ? 1 : 0;\n+    Check();\n+    if (nAdd) {\n+        LogPrint(BCLog::ADDRMAN, \"Added %i addresses from %s: %i tried, %i new\\n\", nAdd, source.ToString(), nTried, nNew);\n+    }\n+    return nAdd > 0;\n+}\n+\n+void AddrManImpl::Good(const CService& addr, int64_t nTime)\n+{\n+    LOCK(cs);\n+    Check();\n+    Good_(addr, /* test_before_evict */ true, nTime);\n+    Check();\n+}\n+\n+void AddrManImpl::Attempt(const CService& addr, bool fCountFailure, int64_t nTime)\n+{\n+    LOCK(cs);\n+    Check();\n+    Attempt_(addr, fCountFailure, nTime);\n+    Check();\n+}\n+\n+void AddrManImpl::ResolveCollisions()\n+{\n+    LOCK(cs);\n+    Check();\n+    ResolveCollisions_();\n+    Check();\n+}\n+\n+std::pair<CAddress, int64_t> AddrManImpl::SelectTriedCollision()\n+{\n+    LOCK(cs);\n+    Check();\n+    const auto ret = SelectTriedCollision_();\n+    Check();\n+    return ret;\n+}\n+\n+std::pair<CAddress, int64_t> AddrManImpl::Select(bool newOnly) const\n+{\n+    LOCK(cs);\n+    Check();\n+    const auto addrRet = Select_(newOnly);\n+    Check();\n+    return addrRet;\n+}\n+\n+std::vector<CAddress> AddrManImpl::GetAddr(size_t max_addresses, size_t max_pct, std::optional<Network> network) const\n+{\n+    LOCK(cs);\n+    Check();\n+    const auto addresses = GetAddr_(max_addresses, max_pct, network);\n+    Check();\n+    return addresses;\n+}\n+\n+void AddrManImpl::Connected(const CService& addr, int64_t nTime)\n+{\n+    LOCK(cs);\n+    Check();\n+    Connected_(addr, nTime);\n+    Check();\n+}\n+\n+void AddrManImpl::SetServices(const CService& addr, ServiceFlags nServices)\n+{\n+    LOCK(cs);\n+    Check();\n+    SetServices_(addr, nServices);\n+    Check();\n+}\n+\n+const std::vector<bool>& AddrManImpl::GetAsmap() const\n+{\n+    return m_asmap;\n+}\n+\n+// explicit instantiation",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r716532315",
      "id" : 716532315,
      "in_reply_to_id" : 714656686,
      "line" : 1118,
      "node_id" : "PRRC_kwDOABII584qtWpb",
      "original_commit_id" : "bb22a365c85f76537aba61c36277fa49d68d5c9f",
      "original_line" : 1118,
      "original_position" : 646,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : 644,
      "pull_request_review_id" : 764062920,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-27T09:47:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/716532315",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r716534699"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/716534699"
         }
      },
      "author_association" : "MEMBER",
      "body" : "By \"internal functions\", I mean private functions that are called by the public \"outer functions\". There's a pattern that the public `Good()` function calls private `Good_()`, public `Add()` calls private `Add_()`, etc. It makes sense to group all of the `FunctionName_()` functions together.",
      "commit_id" : "0cc7031002079b35953bac1e9d4268b6321893c7",
      "created_at" : "2021-09-27T09:50:31Z",
      "diff_hunk" : "@@ -0,0 +1,291 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_ADDRMAN_IMPL_H\n+#define BITCOIN_ADDRMAN_IMPL_H\n+\n+#include <logging.h>\n+#include <netaddress.h>\n+#include <protocol.h>\n+#include <serialize.h>\n+#include <sync.h>\n+#include <uint256.h>\n+\n+#include <cstdint>\n+#include <set>\n+#include <optional>\n+#include <unordered_map>\n+#include <unordered_set>\n+#include <utility>\n+#include <vector>\n+\n+/** Total number of buckets for tried addresses */\n+static constexpr int32_t ADDRMAN_TRIED_BUCKET_COUNT_LOG2{8};\n+static constexpr int ADDRMAN_TRIED_BUCKET_COUNT{1 << ADDRMAN_TRIED_BUCKET_COUNT_LOG2};\n+/** Total number of buckets for new addresses */\n+static constexpr int32_t ADDRMAN_NEW_BUCKET_COUNT_LOG2{10};\n+static constexpr int ADDRMAN_NEW_BUCKET_COUNT{1 << ADDRMAN_NEW_BUCKET_COUNT_LOG2};\n+/** Maximum allowed number of entries in buckets for new and tried addresses */\n+static constexpr int32_t ADDRMAN_BUCKET_SIZE_LOG2{6};\n+static constexpr int ADDRMAN_BUCKET_SIZE{1 << ADDRMAN_BUCKET_SIZE_LOG2};\n+\n+/**\n+ * Extended statistics about a CAddress\n+ */\n+class AddrInfo : public CAddress\n+{\n+public:\n+    //! last try whatsoever by us (memory only)\n+    int64_t nLastTry{0};\n+\n+    //! last counted attempt (memory only)\n+    int64_t nLastCountAttempt{0};\n+\n+    //! where knowledge about this address first came from\n+    CNetAddr source;\n+\n+    //! last successful connection by us\n+    int64_t nLastSuccess{0};\n+\n+    //! connection attempts since last successful attempt\n+    int nAttempts{0};\n+\n+    //! reference count in new sets (memory only)\n+    int nRefCount{0};\n+\n+    //! in tried set? (memory only)\n+    bool fInTried{false};\n+\n+    //! position in vRandom\n+    mutable int nRandomPos{-1};\n+\n+    SERIALIZE_METHODS(AddrInfo, obj)\n+    {\n+        READWRITEAS(CAddress, obj);\n+        READWRITE(obj.source, obj.nLastSuccess, obj.nAttempts);\n+    }\n+\n+    AddrInfo(const CAddress& addrIn, const CNetAddr& addrSource) : CAddress(addrIn), source(addrSource)\n+    {\n+    }\n+\n+    AddrInfo() : CAddress(), source()\n+    {\n+    }\n+\n+    //! Calculate in which \"tried\" bucket this entry belongs\n+    int GetTriedBucket(const uint256& nKey, const std::vector<bool>& asmap) const;\n+\n+    //! Calculate in which \"new\" bucket this entry belongs, given a certain source\n+    int GetNewBucket(const uint256& nKey, const CNetAddr& src, const std::vector<bool>& asmap) const;\n+\n+    //! Calculate in which \"new\" bucket this entry belongs, using its default source\n+    int GetNewBucket(const uint256& nKey, const std::vector<bool>& asmap) const\n+    {\n+        return GetNewBucket(nKey, source, asmap);\n+    }\n+\n+    //! Calculate in which position of a bucket to store this entry.\n+    int GetBucketPosition(const uint256& nKey, bool fNew, int nBucket) const;\n+\n+    //! Determine whether the statistics about this entry are bad enough so that it can just be deleted\n+    bool IsTerrible(int64_t nNow = GetAdjustedTime()) const;\n+\n+    //! Calculate the relative chance this entry should be given when selecting nodes to connect to\n+    double GetChance(int64_t nNow = GetAdjustedTime()) const;\n+};\n+\n+class AddrManImpl\n+{\n+public:\n+    AddrManImpl(std::vector<bool>&& asmap, bool deterministic, int32_t consistency_check_ratio)\n+        : insecure_rand{deterministic}\n+        , nKey{deterministic ? uint256{1} : insecure_rand.rand256()}\n+        , m_consistency_check_ratio{consistency_check_ratio}\n+        , m_asmap{std::move(asmap)}\n+    {\n+        for (auto& bucket : vvNew) {\n+            for (auto& entry : bucket) {\n+                entry = -1;\n+            }\n+        }\n+        for (auto& bucket : vvTried) {\n+            for (auto& entry : bucket) {\n+                entry = -1;\n+            }\n+        }\n+    }\n+\n+    ~AddrManImpl()\n+    {\n+        nKey.SetNull();\n+    }\n+\n+\n+    template <typename Stream>\n+    void Serialize(Stream& s_) const EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    template <typename Stream>\n+    void Unserialize(Stream& s_) EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    size_t size() const EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    bool Add(const std::vector<CAddress>& vAddr, const CNetAddr& source, int64_t nTimePenalty = 0)\n+        EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    void Good(const CService& addr, int64_t nTime = GetAdjustedTime())\n+        EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    void Attempt(const CService& addr, bool fCountFailure, int64_t nTime = GetAdjustedTime())\n+        EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    void ResolveCollisions() EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    std::pair<CAddress, int64_t> SelectTriedCollision() EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    std::pair<CAddress, int64_t> Select(bool newOnly = false) const\n+        EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    std::vector<CAddress> GetAddr(size_t max_addresses, size_t max_pct, std::optional<Network> network) const\n+        EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    void Connected(const CService& addr, int64_t nTime = GetAdjustedTime())\n+        EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    void SetServices(const CService& addr, ServiceFlags nServices)\n+        EXCLUSIVE_LOCKS_REQUIRED(!cs);\n+\n+    const std::vector<bool>& GetAsmap() const;\n+\n+    friend class AddrManTest;\n+    friend class AddrManDeterministic;\n+\n+private:\n+    //! A mutex to protect the inner data structures.\n+    mutable Mutex cs;\n+\n+    //! Source of random numbers for randomization in inner loops\n+    mutable FastRandomContext insecure_rand GUARDED_BY(cs);\n+\n+    //! secret key to randomize bucket select with\n+    uint256 nKey;\n+\n+    //! Serialization versions.\n+    enum Format : uint8_t {\n+        V0_HISTORICAL = 0,    //!< historic format, before commit e6b343d88\n+        V1_DETERMINISTIC = 1, //!< for pre-asmap files\n+        V2_ASMAP = 2,         //!< for files including asmap version\n+        V3_BIP155 = 3,        //!< same as V2_ASMAP plus addresses are in BIP155 format\n+    };\n+\n+    //! The maximum format this software knows it can unserialize. Also, we always serialize\n+    //! in this format.\n+    //! The format (first byte in the serialized stream) can be higher than this and\n+    //! still this software may be able to unserialize the file - if the second byte\n+    //! (see `lowest_compatible` in `Unserialize()`) is less or equal to this.\n+    static constexpr Format FILE_FORMAT = Format::V3_BIP155;\n+\n+    //! The initial value of a field that is incremented every time an incompatible format\n+    //! change is made (such that old software versions would not be able to parse and\n+    //! understand the new file format). This is 32 because we overtook the \"key size\"\n+    //! field which was 32 historically.\n+    //! @note Don't increment this. Increment `lowest_compatible` in `Serialize()` instead.\n+    static constexpr uint8_t INCOMPATIBILITY_BASE = 32;\n+\n+    //! last used nId\n+    int nIdCount GUARDED_BY(cs){0};\n+\n+    //! table with information about all nIds\n+    std::unordered_map<int, AddrInfo> mapInfo GUARDED_BY(cs);\n+\n+    //! find an nId based on its network address\n+    std::unordered_map<CNetAddr, int, CNetAddrHash> mapAddr GUARDED_BY(cs);\n+\n+    //! randomly-ordered vector of all nIds\n+    //! This is mutable because it is unobservable outside the class, so any\n+    //! changes to it (even in const methods) are also unobservable.\n+    mutable std::vector<int> vRandom GUARDED_BY(cs);\n+\n+    // number of \"tried\" entries\n+    int nTried GUARDED_BY(cs){0};\n+\n+    //! list of \"tried\" buckets\n+    int vvTried[ADDRMAN_TRIED_BUCKET_COUNT][ADDRMAN_BUCKET_SIZE] GUARDED_BY(cs);\n+\n+    //! number of (unique) \"new\" entries\n+    int nNew GUARDED_BY(cs){0};\n+\n+    //! list of \"new\" buckets\n+    int vvNew[ADDRMAN_NEW_BUCKET_COUNT][ADDRMAN_BUCKET_SIZE] GUARDED_BY(cs);\n+\n+    //! last time Good was called (memory only). Initially set to 1 so that \"never\" is strictly worse.\n+    int64_t nLastGood GUARDED_BY(cs){1};\n+\n+    //! Holds addrs inserted into tried table that collide with existing entries. Test-before-evict discipline used to resolve these collisions.\n+    std::set<int> m_tried_collisions;\n+\n+    /** Perform consistency checks every m_consistency_check_ratio operations (if non-zero). */\n+    const int32_t m_consistency_check_ratio;\n+\n+    // Compressed IP->ASN mapping, loaded from a file when a node starts.\n+    // Should be always empty if no file was provided.\n+    // This mapping is then used for bucketing nodes in Addrman.\n+    //\n+    // If asmap is provided, nodes will be bucketed by\n+    // AS they belong to, in order to make impossible for a node\n+    // to connect to several nodes hosted in a single AS.\n+    // This is done in response to Erebus attack, but also to generally\n+    // diversify the connections every node creates,\n+    // especially useful when a large fraction of nodes\n+    // operate under a couple of cloud providers.\n+    //\n+    // If a new asmap was provided, the existing records\n+    // would be re-bucketed accordingly.\n+    const std::vector<bool> m_asmap;\n+\n+    //! Find an entry.\n+    AddrInfo* Find(const CNetAddr& addr, int* pnId = nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    //! Create a new entry and add it to the internal data structures mapInfo, mapAddr and vRandom.\n+    AddrInfo* Create(const CAddress& addr, const CNetAddr& addrSource, int* pnId = nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    //! Swap two elements in vRandom.\n+    void SwapRandom(unsigned int nRandomPos1, unsigned int nRandomPos2) const EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    //! Move an entry from the \"new\" table(s) to the \"tried\" table\n+    void MakeTried(AddrInfo& info, int nId) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    //! Delete an entry. It must not be in tried, and have refcount 0.\n+    void Delete(int nId) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    //! Clear a position in a \"new\" table. This is the only place where entries are actually deleted.\n+    void ClearNew(int nUBucket, int nUBucketPos) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    void Good_(const CService& addr, bool test_before_evict, int64_t time) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    bool Add_(const CAddress& addr, const CNetAddr& source, int64_t nTimePenalty) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    void Attempt_(const CService& addr, bool fCountFailure, int64_t nTime) EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    std::pair<CAddress, int64_t> Select_(bool newOnly) const EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    void ResolveCollisions_() EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    std::pair<CAddress, int64_t> SelectTriedCollision_() EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    //! Consistency check, taking into account m_consistency_check_ratio. Will std::abort if an inconsistency is detected.\n+    void Check() const EXCLUSIVE_LOCKS_REQUIRED(cs);\n+\n+    //! Perform consistency check, regardless of m_consistency_check_ratio.\n+    //! @returns an error code or zero.\n+    int ForceCheckAddrman() const EXCLUSIVE_LOCKS_REQUIRED(cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r716534699",
      "id" : 716534699,
      "in_reply_to_id" : 714665818,
      "line" : 262,
      "node_id" : "PRRC_kwDOABII584qtXOr",
      "original_commit_id" : "bb22a365c85f76537aba61c36277fa49d68d5c9f",
      "original_line" : 262,
      "original_position" : 282,
      "original_start_line" : 277,
      "path" : "src/addrman_impl.h",
      "position" : 262,
      "pull_request_review_id" : 764065760,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950",
      "side" : "RIGHT",
      "start_line" : 257,
      "start_side" : "RIGHT",
      "updated_at" : "2021-09-27T09:50:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/716534699",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK 0cc7031002079b35953bac1e9d4268b6321893c7\r\n\r\nIf you retouch again, you could move the function bodies of `CAddrMan::~CAddrMan()` and `CAddrMan::GetAsmap()` into addrman.cpp in the first commit (_[move-only] Move CAddrMan function definitions to cpp_) to make the second commit cleaner.",
      "created_at" : "2021-09-27T10:31:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#issuecomment-927736344",
      "id" : 927736344,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22950",
      "node_id" : "IC_kwDOABII5843TCIY",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-27T10:31:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/927736344",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-09-27T13:25:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#issuecomment-927873966",
      "id" : 927873966,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22950",
      "node_id" : "IC_kwDOABII5843Tjuu",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-27T13:25:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/927873966",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r717088501"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717088501"
         }
      },
      "author_association" : "MEMBER",
      "body" : "~Nit: If the compiler doesn't elide this, the const will force an extra copy: https://stackoverflow.com/questions/25784544/will-returning-a-const-object-from-a-function-prevent-move-construction-from-out/25786015~\r\n\r\nEdit: TIL. Looks like this is \"permitted\" to be elided according to the [c++17 draft spec](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2017/n4713.pdf): (emphasis mine)\r\n\r\n> \r\n> This elision of copy/move operations, called copy elision, is **permitted** in the following circumstances (which may be combined to eliminate multiple copies):\r\n> - in a return statement in a function with a class return type, when the expression is the name of a non-volatile automatic object (other than a function parameter or a variable introduced by the exception-declaration of a handler (18.3)) with the same type (**_ignoring cv-qualification_**) as the function return type, the copy/move operation can be omitted by constructing the automatic object directly into the function callâs return object\r\n\r\nBut \"required\" [according to cppreference](https://en.cppreference.com/w/cpp/language/copy_elision):\r\n\r\n> Under the following circumstances, the compilers are **required** to omit the copy and move construction of class objects, even if the copy/move constructor and the destructor have observable side-effects. The objects are constructed directly into the storage where they would otherwise be copied/moved to. The copy/move constructors need not be present or accessible:\r\n> \r\n> - In a return statement, when the operand is a prvalue of the same class type (**_ignoring cv-qualification_**) as the function return type\r\n\r\nSo.. ð¤·\r\n\r\nMaybe that draft wasn't final wrt elision or maybe cppreference is wrong. It really doesn't matter either way :)",
      "commit_id" : "0cc7031002079b35953bac1e9d4268b6321893c7",
      "created_at" : "2021-09-27T22:26:28Z",
      "diff_hunk" : "@@ -1080,10 +1083,9 @@ std::vector<CAddress> AddrManImpl::GetAddr(size_t max_addresses, size_t max_pct,\n {\n     LOCK(cs);\n     Check();\n-    std::vector<CAddress> vAddr;\n-    GetAddr_(vAddr, max_addresses, max_pct, network);\n+    const auto addresses = GetAddr_(max_addresses, max_pct, network);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#discussion_r717088501",
      "id" : 717088501,
      "line" : 1087,
      "node_id" : "PRRC_kwDOABII584qveb1",
      "original_commit_id" : "29252f3f60e22030e6f3f798df2e38c12d2314f4",
      "original_line" : 1086,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : 612,
      "pull_request_review_id" : 764763599,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22950",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-27T23:55:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717088501",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK. Needs rebase.\r\n\r\nOnly skimmed the move-only and scripted-diff commits. Reviewed in-order and each commit is well-explained. +1 to the contained interface.\r\n\r\nAgree with @mzumsande about cleaning up the internal functions as a next step, but not as a part of this PR.\r\n\r\nIt would be nice if we had a time type so it'd be obvious what the second member of the pair was in the return values from `Select` and friends, but that's not worth addressing here.\r\n\r\nMy only other nit has already been pointed out here: https://github.com/bitcoin/bitcoin/pull/22950#discussion_r716101195 . ",
      "created_at" : "2021-09-27T22:59:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22950#issuecomment-928405824",
      "id" : 928405824,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22950",
      "node_id" : "IC_kwDOABII5843VllA",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-27T23:02:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/928405824",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   }
]
