[
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for working on this. Strong Concept ACK!",
      "created_at" : "2021-01-03T09:20:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#issuecomment-753589415",
      "id" : 753589415,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20833",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1MzU4OTQxNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-03T09:20:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/753589415",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK and approach ACK.",
      "created_at" : "2021-01-03T10:38:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#issuecomment-753597483",
      "id" : 753597483,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20833",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1MzU5NzQ4Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-03T10:38:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/753597483",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #21391 ([Bundle 5/n] Prune g_chainman usage in RPC modules by dongcarl)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-01-03T11:29:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#issuecomment-753602927",
      "id" : 753602927,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20833",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1MzYwMjkyNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-25T01:18:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/753602927",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r552161033"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/552161033"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This means that we will update our script cache with transactions that might not ultimately get accepted to the mempool?  This would need to be restructured before exposing to the p2p network to avoid becoming a DoS vector.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-05T19:57:33Z",
      "diff_hunk" : "@@ -1024,46 +993,104 @@ bool MemPoolAccept::Finalize(ATMPArgs& args, Workspace& ws)\n     return true;\n }\n \n-bool MemPoolAccept::AcceptSingleTransaction(const CTransactionRef& ptx, ATMPArgs& args)\n+MempoolAcceptResult MemPoolAccept::AcceptSingleTransaction(const CTransactionRef& ptx, ATMPArgs& args)\n {\n     AssertLockHeld(cs_main);\n     LOCK(m_pool.cs); // mempool \"read lock\" (held through GetMainSignals().TransactionAddedToMempool())\n \n     Workspace workspace(ptx);\n+    MempoolAcceptResult result(ptx);\n \n-    if (!PreChecks(args, workspace)) return false;\n+    if (!PreChecks(args, result, workspace)) {\n+        result.m_accepted = false;\n+        return result;\n+    }\n \n     // Only compute the precomputed transaction data if we need to verify\n     // scripts (ie, other policy checks pass). We perform the inexpensive\n     // checks first and avoid hashing and signature verification unless those\n     // checks pass, to mitigate CPU exhaustion denial-of-service attacks.\n     PrecomputedTransactionData txdata;\n \n-    if (!PolicyScriptChecks(args, workspace, txdata)) return false;\n+    if (!PolicyScriptChecks(args, result, workspace, txdata)) {\n+        result.m_accepted = false;\n+        return result;\n+    }\n \n-    if (!ConsensusScriptChecks(args, workspace, txdata)) return false;\n+    if (!ConsensusScriptChecks(args, result, workspace, txdata)) {\n+        result.m_accepted = false;\n+        return result;\n+    }\n \n     // Tx was accepted, but not added\n-    if (args.m_test_accept) return true;\n+    if (args.m_test_accept) {\n+        result.m_accepted = true;\n+        return result;\n+    }\n \n-    if (!Finalize(args, workspace)) return false;\n+    if (!Finalize(args, result, workspace)) {\n+        result.m_accepted = false;\n+        return result;\n+    }\n \n     GetMainSignals().TransactionAddedToMempool(ptx, m_pool.GetAndIncrementSequence());\n \n-    return true;\n+    result.m_accepted = true;\n+    return result;\n+}\n+\n+std::vector<MempoolAcceptResult> MemPoolAccept::AcceptMultipleTransactions(std::vector<const CTransactionRef>& txns, ATMPArgs& args)\n+{\n+    AssertLockHeld(cs_main);\n+    LOCK(m_pool.cs);\n+    std::vector<MempoolAcceptResult> results{};\n+    std::vector<Workspace> workspaces{};\n+    workspaces.reserve(txns.size());\n+    std::transform(txns.begin(), txns.end(), std::back_inserter(workspaces), [](const CTransactionRef& tx) {\n+        return Workspace(tx);\n+    });\n+    // Do all PreChecks first and fail fast to avoid running expensive script\n+    // checks when unnecessary.\n+    for (unsigned int i = 0; i < txns.size(); ++i) {\n+        MempoolAcceptResult result(txns[i]);\n+        if (!PreChecks(args, result, workspaces[i])) {\n+            result.m_accepted = false;\n+            return std::vector<MempoolAcceptResult> {std::move(result)};\n+        }\n+        result.m_accepted = true; // Allowed so far\n+        m_viewmempool.AddPackageTransaction(txns[i]);\n+        results.push_back(result);\n+    }\n+\n+    // TODO: Enforce package-level feerate and other policies before script checks.\n+\n+    for (unsigned int i = 0; i < txns.size(); ++i) {\n+        PrecomputedTransactionData txdata;\n+\n+        if (!PolicyScriptChecks(args, results[i], workspaces[i], txdata)) {\n+            results[i].m_accepted = false;\n+            return std::vector<MempoolAcceptResult> {std::move(results[i])};\n+        }\n+\n+        if (!ConsensusScriptChecks(args, results[i], workspaces[i], txdata)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r552161033",
      "id" : 552161033,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjE2MTAzMw==",
      "original_commit_id" : "25412b8d13a5287670033d6bab7730e978bbb6be",
      "original_line" : 1075,
      "original_position" : 398,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 562088788,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/552161033",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r552168344"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/552168344"
         }
      },
      "author_association" : "MEMBER",
      "body" : "On further thought: if you're only implementing this for testmempoolaccept anyway, why bother with the call to ConsensusScriptChecks?  It can only return failure if our software is broken -- it's a safeguard against miners creating invalid blocks, not something that users should expect to ever run into.\r\n\r\nIf you drop this call, then dropping CIFMAC is also no longer necessary, right?",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-05T20:12:32Z",
      "diff_hunk" : "@@ -1024,46 +993,104 @@ bool MemPoolAccept::Finalize(ATMPArgs& args, Workspace& ws)\n     return true;\n }\n \n-bool MemPoolAccept::AcceptSingleTransaction(const CTransactionRef& ptx, ATMPArgs& args)\n+MempoolAcceptResult MemPoolAccept::AcceptSingleTransaction(const CTransactionRef& ptx, ATMPArgs& args)\n {\n     AssertLockHeld(cs_main);\n     LOCK(m_pool.cs); // mempool \"read lock\" (held through GetMainSignals().TransactionAddedToMempool())\n \n     Workspace workspace(ptx);\n+    MempoolAcceptResult result(ptx);\n \n-    if (!PreChecks(args, workspace)) return false;\n+    if (!PreChecks(args, result, workspace)) {\n+        result.m_accepted = false;\n+        return result;\n+    }\n \n     // Only compute the precomputed transaction data if we need to verify\n     // scripts (ie, other policy checks pass). We perform the inexpensive\n     // checks first and avoid hashing and signature verification unless those\n     // checks pass, to mitigate CPU exhaustion denial-of-service attacks.\n     PrecomputedTransactionData txdata;\n \n-    if (!PolicyScriptChecks(args, workspace, txdata)) return false;\n+    if (!PolicyScriptChecks(args, result, workspace, txdata)) {\n+        result.m_accepted = false;\n+        return result;\n+    }\n \n-    if (!ConsensusScriptChecks(args, workspace, txdata)) return false;\n+    if (!ConsensusScriptChecks(args, result, workspace, txdata)) {\n+        result.m_accepted = false;\n+        return result;\n+    }\n \n     // Tx was accepted, but not added\n-    if (args.m_test_accept) return true;\n+    if (args.m_test_accept) {\n+        result.m_accepted = true;\n+        return result;\n+    }\n \n-    if (!Finalize(args, workspace)) return false;\n+    if (!Finalize(args, result, workspace)) {\n+        result.m_accepted = false;\n+        return result;\n+    }\n \n     GetMainSignals().TransactionAddedToMempool(ptx, m_pool.GetAndIncrementSequence());\n \n-    return true;\n+    result.m_accepted = true;\n+    return result;\n+}\n+\n+std::vector<MempoolAcceptResult> MemPoolAccept::AcceptMultipleTransactions(std::vector<const CTransactionRef>& txns, ATMPArgs& args)\n+{\n+    AssertLockHeld(cs_main);\n+    LOCK(m_pool.cs);\n+    std::vector<MempoolAcceptResult> results{};\n+    std::vector<Workspace> workspaces{};\n+    workspaces.reserve(txns.size());\n+    std::transform(txns.begin(), txns.end(), std::back_inserter(workspaces), [](const CTransactionRef& tx) {\n+        return Workspace(tx);\n+    });\n+    // Do all PreChecks first and fail fast to avoid running expensive script\n+    // checks when unnecessary.\n+    for (unsigned int i = 0; i < txns.size(); ++i) {\n+        MempoolAcceptResult result(txns[i]);\n+        if (!PreChecks(args, result, workspaces[i])) {\n+            result.m_accepted = false;\n+            return std::vector<MempoolAcceptResult> {std::move(result)};\n+        }\n+        result.m_accepted = true; // Allowed so far\n+        m_viewmempool.AddPackageTransaction(txns[i]);\n+        results.push_back(result);\n+    }\n+\n+    // TODO: Enforce package-level feerate and other policies before script checks.\n+\n+    for (unsigned int i = 0; i < txns.size(); ++i) {\n+        PrecomputedTransactionData txdata;\n+\n+        if (!PolicyScriptChecks(args, results[i], workspaces[i], txdata)) {\n+            results[i].m_accepted = false;\n+            return std::vector<MempoolAcceptResult> {std::move(results[i])};\n+        }\n+\n+        if (!ConsensusScriptChecks(args, results[i], workspaces[i], txdata)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r552168344",
      "id" : 552168344,
      "in_reply_to_id" : 552161033,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjE2ODM0NA==",
      "original_commit_id" : "25412b8d13a5287670033d6bab7730e978bbb6be",
      "original_line" : 1075,
      "original_position" : 398,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 562098520,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/552168344",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r552180013"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/552180013"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "AFAIK we only use the script cache when it passes, so I don't think it's a DoS vector? On master, if you call `testmempoolaccept`, it caches the successful script executions with consensus flags.\r\n\r\n> On further thought: if you're only implementing this for testmempoolaccept anyway, why bother with the call to ConsensusScriptChecks?\r\n\r\nGood point, `PolicyScriptChecks` is stricter so `ConsensusScriptChecks` is unnecessary. And yes, we could then keep CIFMAC. But in order to do actual, non-test-accepts, we'll have to revisit the issue again (since I assume we'll want to call `ConsensusScriptChecks` then). It'd be \"kicking the can down the road.\"",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-05T20:37:04Z",
      "diff_hunk" : "@@ -1024,46 +993,104 @@ bool MemPoolAccept::Finalize(ATMPArgs& args, Workspace& ws)\n     return true;\n }\n \n-bool MemPoolAccept::AcceptSingleTransaction(const CTransactionRef& ptx, ATMPArgs& args)\n+MempoolAcceptResult MemPoolAccept::AcceptSingleTransaction(const CTransactionRef& ptx, ATMPArgs& args)\n {\n     AssertLockHeld(cs_main);\n     LOCK(m_pool.cs); // mempool \"read lock\" (held through GetMainSignals().TransactionAddedToMempool())\n \n     Workspace workspace(ptx);\n+    MempoolAcceptResult result(ptx);\n \n-    if (!PreChecks(args, workspace)) return false;\n+    if (!PreChecks(args, result, workspace)) {\n+        result.m_accepted = false;\n+        return result;\n+    }\n \n     // Only compute the precomputed transaction data if we need to verify\n     // scripts (ie, other policy checks pass). We perform the inexpensive\n     // checks first and avoid hashing and signature verification unless those\n     // checks pass, to mitigate CPU exhaustion denial-of-service attacks.\n     PrecomputedTransactionData txdata;\n \n-    if (!PolicyScriptChecks(args, workspace, txdata)) return false;\n+    if (!PolicyScriptChecks(args, result, workspace, txdata)) {\n+        result.m_accepted = false;\n+        return result;\n+    }\n \n-    if (!ConsensusScriptChecks(args, workspace, txdata)) return false;\n+    if (!ConsensusScriptChecks(args, result, workspace, txdata)) {\n+        result.m_accepted = false;\n+        return result;\n+    }\n \n     // Tx was accepted, but not added\n-    if (args.m_test_accept) return true;\n+    if (args.m_test_accept) {\n+        result.m_accepted = true;\n+        return result;\n+    }\n \n-    if (!Finalize(args, workspace)) return false;\n+    if (!Finalize(args, result, workspace)) {\n+        result.m_accepted = false;\n+        return result;\n+    }\n \n     GetMainSignals().TransactionAddedToMempool(ptx, m_pool.GetAndIncrementSequence());\n \n-    return true;\n+    result.m_accepted = true;\n+    return result;\n+}\n+\n+std::vector<MempoolAcceptResult> MemPoolAccept::AcceptMultipleTransactions(std::vector<const CTransactionRef>& txns, ATMPArgs& args)\n+{\n+    AssertLockHeld(cs_main);\n+    LOCK(m_pool.cs);\n+    std::vector<MempoolAcceptResult> results{};\n+    std::vector<Workspace> workspaces{};\n+    workspaces.reserve(txns.size());\n+    std::transform(txns.begin(), txns.end(), std::back_inserter(workspaces), [](const CTransactionRef& tx) {\n+        return Workspace(tx);\n+    });\n+    // Do all PreChecks first and fail fast to avoid running expensive script\n+    // checks when unnecessary.\n+    for (unsigned int i = 0; i < txns.size(); ++i) {\n+        MempoolAcceptResult result(txns[i]);\n+        if (!PreChecks(args, result, workspaces[i])) {\n+            result.m_accepted = false;\n+            return std::vector<MempoolAcceptResult> {std::move(result)};\n+        }\n+        result.m_accepted = true; // Allowed so far\n+        m_viewmempool.AddPackageTransaction(txns[i]);\n+        results.push_back(result);\n+    }\n+\n+    // TODO: Enforce package-level feerate and other policies before script checks.\n+\n+    for (unsigned int i = 0; i < txns.size(); ++i) {\n+        PrecomputedTransactionData txdata;\n+\n+        if (!PolicyScriptChecks(args, results[i], workspaces[i], txdata)) {\n+            results[i].m_accepted = false;\n+            return std::vector<MempoolAcceptResult> {std::move(results[i])};\n+        }\n+\n+        if (!ConsensusScriptChecks(args, results[i], workspaces[i], txdata)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r552180013",
      "id" : 552180013,
      "in_reply_to_id" : 552161033,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjE4MDAxMw==",
      "original_commit_id" : "25412b8d13a5287670033d6bab7730e978bbb6be",
      "original_line" : 1075,
      "original_position" : 398,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 562113660,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/552180013",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r552684985"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/552684985"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I assume that the ultimate goal of package validation is to only accept the whole set of transactions if each one individually makes it into the mempool (probably along with some other properties on the feerate of the package being used rather than individual feerates).  If that's correct, then calling `ConsensusScriptChecks` on anything (which will add to the script cache) before you finish calling `PolicyScriptChecks` on later transactions in the package will mean that a policy failure in a later transaction could cause the whole package to be rejected, while still having updated the cache.\r\n\r\nIf exposed on the p2p network, an attacker could wipe out a target's script cache for free this way, which is the DoS vector I was referring to.\r\n\r\nSo instead, you can make this loop just call `PolicyScriptChecks`, which is good enough for test_accept.  Once you implement adding to the mempool on success, you could have a new loop over the set of transactions in the package (topologically sorted) that invokes `ConsensusScriptChecks` and then adds the transaction to the mempool.  This way, CIFMAC doesn't need to be touched at all, because all a transaction's inputs are already in the utxo set or the mempool at the time `ConsensusScriptChecks` is invoked.  (This is essentially the structure I proposed in #16401.)",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-06T14:53:09Z",
      "diff_hunk" : "@@ -1024,46 +993,104 @@ bool MemPoolAccept::Finalize(ATMPArgs& args, Workspace& ws)\n     return true;\n }\n \n-bool MemPoolAccept::AcceptSingleTransaction(const CTransactionRef& ptx, ATMPArgs& args)\n+MempoolAcceptResult MemPoolAccept::AcceptSingleTransaction(const CTransactionRef& ptx, ATMPArgs& args)\n {\n     AssertLockHeld(cs_main);\n     LOCK(m_pool.cs); // mempool \"read lock\" (held through GetMainSignals().TransactionAddedToMempool())\n \n     Workspace workspace(ptx);\n+    MempoolAcceptResult result(ptx);\n \n-    if (!PreChecks(args, workspace)) return false;\n+    if (!PreChecks(args, result, workspace)) {\n+        result.m_accepted = false;\n+        return result;\n+    }\n \n     // Only compute the precomputed transaction data if we need to verify\n     // scripts (ie, other policy checks pass). We perform the inexpensive\n     // checks first and avoid hashing and signature verification unless those\n     // checks pass, to mitigate CPU exhaustion denial-of-service attacks.\n     PrecomputedTransactionData txdata;\n \n-    if (!PolicyScriptChecks(args, workspace, txdata)) return false;\n+    if (!PolicyScriptChecks(args, result, workspace, txdata)) {\n+        result.m_accepted = false;\n+        return result;\n+    }\n \n-    if (!ConsensusScriptChecks(args, workspace, txdata)) return false;\n+    if (!ConsensusScriptChecks(args, result, workspace, txdata)) {\n+        result.m_accepted = false;\n+        return result;\n+    }\n \n     // Tx was accepted, but not added\n-    if (args.m_test_accept) return true;\n+    if (args.m_test_accept) {\n+        result.m_accepted = true;\n+        return result;\n+    }\n \n-    if (!Finalize(args, workspace)) return false;\n+    if (!Finalize(args, result, workspace)) {\n+        result.m_accepted = false;\n+        return result;\n+    }\n \n     GetMainSignals().TransactionAddedToMempool(ptx, m_pool.GetAndIncrementSequence());\n \n-    return true;\n+    result.m_accepted = true;\n+    return result;\n+}\n+\n+std::vector<MempoolAcceptResult> MemPoolAccept::AcceptMultipleTransactions(std::vector<const CTransactionRef>& txns, ATMPArgs& args)\n+{\n+    AssertLockHeld(cs_main);\n+    LOCK(m_pool.cs);\n+    std::vector<MempoolAcceptResult> results{};\n+    std::vector<Workspace> workspaces{};\n+    workspaces.reserve(txns.size());\n+    std::transform(txns.begin(), txns.end(), std::back_inserter(workspaces), [](const CTransactionRef& tx) {\n+        return Workspace(tx);\n+    });\n+    // Do all PreChecks first and fail fast to avoid running expensive script\n+    // checks when unnecessary.\n+    for (unsigned int i = 0; i < txns.size(); ++i) {\n+        MempoolAcceptResult result(txns[i]);\n+        if (!PreChecks(args, result, workspaces[i])) {\n+            result.m_accepted = false;\n+            return std::vector<MempoolAcceptResult> {std::move(result)};\n+        }\n+        result.m_accepted = true; // Allowed so far\n+        m_viewmempool.AddPackageTransaction(txns[i]);\n+        results.push_back(result);\n+    }\n+\n+    // TODO: Enforce package-level feerate and other policies before script checks.\n+\n+    for (unsigned int i = 0; i < txns.size(); ++i) {\n+        PrecomputedTransactionData txdata;\n+\n+        if (!PolicyScriptChecks(args, results[i], workspaces[i], txdata)) {\n+            results[i].m_accepted = false;\n+            return std::vector<MempoolAcceptResult> {std::move(results[i])};\n+        }\n+\n+        if (!ConsensusScriptChecks(args, results[i], workspaces[i], txdata)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r552684985",
      "id" : 552684985,
      "in_reply_to_id" : 552161033,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjY4NDk4NQ==",
      "original_commit_id" : "25412b8d13a5287670033d6bab7730e978bbb6be",
      "original_line" : 1075,
      "original_position" : 398,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 562770282,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/552684985",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r552814597"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/552814597"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Do we want to commit to that?",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-06T17:05:54Z",
      "diff_hunk" : "@@ -889,7 +888,7 @@ static RPCHelpMan testmempoolaccept()\n                 },\n                 RPCResult{\n                     RPCResult::Type::ARR, \"\", \"The result of the mempool acceptance test for each raw transaction in the input array.\\n\"\n-                        \"Length is exactly one for now.\",\n+                        \"Length is exactly one if any failures occur.\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r552814597",
      "id" : 552814597,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjgxNDU5Nw==",
      "original_commit_id" : "10860308da57ae417aeb6a0e35515235e5f9360a",
      "original_line" : 891,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : null,
      "pull_request_review_id" : 562884556,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/552814597",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r552815366"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/552815366"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This syntax seems strange?",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-06T17:06:38Z",
      "diff_hunk" : "@@ -921,56 +920,80 @@ static RPCHelpMan testmempoolaccept()\n         UniValueType(), // VNUM or VSTR, checked inside AmountFromValue()\n     });\n \n-    if (request.params[0].get_array().size() != 1) {\n-        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Array must contain exactly one raw transaction for now\");\n-    }\n-\n-    CMutableTransaction mtx;\n-    if (!DecodeHexTx(mtx, request.params[0].get_array()[0].get_str())) {\n-        throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed. Make sure the tx has at least one input.\");\n-    }\n-    CTransactionRef tx(MakeTransactionRef(std::move(mtx)));\n-    const uint256& tx_hash = tx->GetHash();\n-\n+    UniValue transactions = request.params[0].get_array();\n+    const size_t num_txns = {transactions.size()};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r552815366",
      "id" : 552815366,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjgxNTM2Ng==",
      "original_commit_id" : "10860308da57ae417aeb6a0e35515235e5f9360a",
      "original_line" : 924,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : null,
      "pull_request_review_id" : 562884556,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/552815366",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r552930655"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/552930655"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> I assume that the ultimate goal of package validation is to only accept the whole set of transactions if each one individually makes it into the mempool... \r\nIf that's correct, then calling ConsensusScriptChecks on anything (which will add to the script cache) before you finish calling PolicyScriptChecks on later transactions in the package will mean that a policy failure in a later transaction could cause the whole package to be rejected, while still having updated the cache.\r\n\r\nRight, I have the same vision in mind, and absolutely agree. I should change these two be separate loops - all `PolicyScriptChecks`, then all `ConsensusScriptChecks`. This would mean that we would only be calling `ConsensusScriptChecks` (which is effectively just used to cache script results) if all of them would pass - there's no way for any of them to fail consensus if they passed policy.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-06T19:53:47Z",
      "diff_hunk" : "@@ -1024,46 +993,104 @@ bool MemPoolAccept::Finalize(ATMPArgs& args, Workspace& ws)\n     return true;\n }\n \n-bool MemPoolAccept::AcceptSingleTransaction(const CTransactionRef& ptx, ATMPArgs& args)\n+MempoolAcceptResult MemPoolAccept::AcceptSingleTransaction(const CTransactionRef& ptx, ATMPArgs& args)\n {\n     AssertLockHeld(cs_main);\n     LOCK(m_pool.cs); // mempool \"read lock\" (held through GetMainSignals().TransactionAddedToMempool())\n \n     Workspace workspace(ptx);\n+    MempoolAcceptResult result(ptx);\n \n-    if (!PreChecks(args, workspace)) return false;\n+    if (!PreChecks(args, result, workspace)) {\n+        result.m_accepted = false;\n+        return result;\n+    }\n \n     // Only compute the precomputed transaction data if we need to verify\n     // scripts (ie, other policy checks pass). We perform the inexpensive\n     // checks first and avoid hashing and signature verification unless those\n     // checks pass, to mitigate CPU exhaustion denial-of-service attacks.\n     PrecomputedTransactionData txdata;\n \n-    if (!PolicyScriptChecks(args, workspace, txdata)) return false;\n+    if (!PolicyScriptChecks(args, result, workspace, txdata)) {\n+        result.m_accepted = false;\n+        return result;\n+    }\n \n-    if (!ConsensusScriptChecks(args, workspace, txdata)) return false;\n+    if (!ConsensusScriptChecks(args, result, workspace, txdata)) {\n+        result.m_accepted = false;\n+        return result;\n+    }\n \n     // Tx was accepted, but not added\n-    if (args.m_test_accept) return true;\n+    if (args.m_test_accept) {\n+        result.m_accepted = true;\n+        return result;\n+    }\n \n-    if (!Finalize(args, workspace)) return false;\n+    if (!Finalize(args, result, workspace)) {\n+        result.m_accepted = false;\n+        return result;\n+    }\n \n     GetMainSignals().TransactionAddedToMempool(ptx, m_pool.GetAndIncrementSequence());\n \n-    return true;\n+    result.m_accepted = true;\n+    return result;\n+}\n+\n+std::vector<MempoolAcceptResult> MemPoolAccept::AcceptMultipleTransactions(std::vector<const CTransactionRef>& txns, ATMPArgs& args)\n+{\n+    AssertLockHeld(cs_main);\n+    LOCK(m_pool.cs);\n+    std::vector<MempoolAcceptResult> results{};\n+    std::vector<Workspace> workspaces{};\n+    workspaces.reserve(txns.size());\n+    std::transform(txns.begin(), txns.end(), std::back_inserter(workspaces), [](const CTransactionRef& tx) {\n+        return Workspace(tx);\n+    });\n+    // Do all PreChecks first and fail fast to avoid running expensive script\n+    // checks when unnecessary.\n+    for (unsigned int i = 0; i < txns.size(); ++i) {\n+        MempoolAcceptResult result(txns[i]);\n+        if (!PreChecks(args, result, workspaces[i])) {\n+            result.m_accepted = false;\n+            return std::vector<MempoolAcceptResult> {std::move(result)};\n+        }\n+        result.m_accepted = true; // Allowed so far\n+        m_viewmempool.AddPackageTransaction(txns[i]);\n+        results.push_back(result);\n+    }\n+\n+    // TODO: Enforce package-level feerate and other policies before script checks.\n+\n+    for (unsigned int i = 0; i < txns.size(); ++i) {\n+        PrecomputedTransactionData txdata;\n+\n+        if (!PolicyScriptChecks(args, results[i], workspaces[i], txdata)) {\n+            results[i].m_accepted = false;\n+            return std::vector<MempoolAcceptResult> {std::move(results[i])};\n+        }\n+\n+        if (!ConsensusScriptChecks(args, results[i], workspaces[i], txdata)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r552930655",
      "id" : 552930655,
      "in_reply_to_id" : 552161033,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjkzMDY1NQ==",
      "original_commit_id" : "25412b8d13a5287670033d6bab7730e978bbb6be",
      "original_line" : 1075,
      "original_position" : 398,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 562998317,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/552930655",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r552997459"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/552997459"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The more I think about this, the more it makes sense ð \r\nIn actual package accept, we don't need CoinsViewMempool after `PolicyScriptChecks`, we can actually just go one by one in the package (after topological sort) and run `ConsensusScriptChecks` + submit to mempool. And subsequent txns should have all of the Coins they need from the pool. Apologies if this was obvious to you - is this what you had in mind?",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-06T22:31:20Z",
      "diff_hunk" : "@@ -1024,46 +993,104 @@ bool MemPoolAccept::Finalize(ATMPArgs& args, Workspace& ws)\n     return true;\n }\n \n-bool MemPoolAccept::AcceptSingleTransaction(const CTransactionRef& ptx, ATMPArgs& args)\n+MempoolAcceptResult MemPoolAccept::AcceptSingleTransaction(const CTransactionRef& ptx, ATMPArgs& args)\n {\n     AssertLockHeld(cs_main);\n     LOCK(m_pool.cs); // mempool \"read lock\" (held through GetMainSignals().TransactionAddedToMempool())\n \n     Workspace workspace(ptx);\n+    MempoolAcceptResult result(ptx);\n \n-    if (!PreChecks(args, workspace)) return false;\n+    if (!PreChecks(args, result, workspace)) {\n+        result.m_accepted = false;\n+        return result;\n+    }\n \n     // Only compute the precomputed transaction data if we need to verify\n     // scripts (ie, other policy checks pass). We perform the inexpensive\n     // checks first and avoid hashing and signature verification unless those\n     // checks pass, to mitigate CPU exhaustion denial-of-service attacks.\n     PrecomputedTransactionData txdata;\n \n-    if (!PolicyScriptChecks(args, workspace, txdata)) return false;\n+    if (!PolicyScriptChecks(args, result, workspace, txdata)) {\n+        result.m_accepted = false;\n+        return result;\n+    }\n \n-    if (!ConsensusScriptChecks(args, workspace, txdata)) return false;\n+    if (!ConsensusScriptChecks(args, result, workspace, txdata)) {\n+        result.m_accepted = false;\n+        return result;\n+    }\n \n     // Tx was accepted, but not added\n-    if (args.m_test_accept) return true;\n+    if (args.m_test_accept) {\n+        result.m_accepted = true;\n+        return result;\n+    }\n \n-    if (!Finalize(args, workspace)) return false;\n+    if (!Finalize(args, result, workspace)) {\n+        result.m_accepted = false;\n+        return result;\n+    }\n \n     GetMainSignals().TransactionAddedToMempool(ptx, m_pool.GetAndIncrementSequence());\n \n-    return true;\n+    result.m_accepted = true;\n+    return result;\n+}\n+\n+std::vector<MempoolAcceptResult> MemPoolAccept::AcceptMultipleTransactions(std::vector<const CTransactionRef>& txns, ATMPArgs& args)\n+{\n+    AssertLockHeld(cs_main);\n+    LOCK(m_pool.cs);\n+    std::vector<MempoolAcceptResult> results{};\n+    std::vector<Workspace> workspaces{};\n+    workspaces.reserve(txns.size());\n+    std::transform(txns.begin(), txns.end(), std::back_inserter(workspaces), [](const CTransactionRef& tx) {\n+        return Workspace(tx);\n+    });\n+    // Do all PreChecks first and fail fast to avoid running expensive script\n+    // checks when unnecessary.\n+    for (unsigned int i = 0; i < txns.size(); ++i) {\n+        MempoolAcceptResult result(txns[i]);\n+        if (!PreChecks(args, result, workspaces[i])) {\n+            result.m_accepted = false;\n+            return std::vector<MempoolAcceptResult> {std::move(result)};\n+        }\n+        result.m_accepted = true; // Allowed so far\n+        m_viewmempool.AddPackageTransaction(txns[i]);\n+        results.push_back(result);\n+    }\n+\n+    // TODO: Enforce package-level feerate and other policies before script checks.\n+\n+    for (unsigned int i = 0; i < txns.size(); ++i) {\n+        PrecomputedTransactionData txdata;\n+\n+        if (!PolicyScriptChecks(args, results[i], workspaces[i], txdata)) {\n+            results[i].m_accepted = false;\n+            return std::vector<MempoolAcceptResult> {std::move(results[i])};\n+        }\n+\n+        if (!ConsensusScriptChecks(args, results[i], workspaces[i], txdata)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r552997459",
      "id" : 552997459,
      "in_reply_to_id" : 552161033,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjk5NzQ1OQ==",
      "original_commit_id" : "25412b8d13a5287670033d6bab7730e978bbb6be",
      "original_line" : 1075,
      "original_position" : 398,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 563082415,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/552997459",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r553003781"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/553003781"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I believe we plan to validate packages atomically, so we would never have a situation of \"these txns passed, but those didn't.\" That's why I believed length 1 for failure would be alright, especially since this wouldn't be an API-breaking change. I imagine it could be helpful to return more information to the client, but don't know what that would look like concretely.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-06T22:49:39Z",
      "diff_hunk" : "@@ -889,7 +888,7 @@ static RPCHelpMan testmempoolaccept()\n                 },\n                 RPCResult{\n                     RPCResult::Type::ARR, \"\", \"The result of the mempool acceptance test for each raw transaction in the input array.\\n\"\n-                        \"Length is exactly one for now.\",\n+                        \"Length is exactly one if any failures occur.\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r553003781",
      "id" : 553003781,
      "in_reply_to_id" : 552814597,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAwMzc4MQ==",
      "original_commit_id" : "10860308da57ae417aeb6a0e35515235e5f9360a",
      "original_line" : 891,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : null,
      "pull_request_review_id" : 563090036,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/553003781",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r553011795"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/553011795"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "(Open to ideas)",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-06T23:14:02Z",
      "diff_hunk" : "@@ -889,7 +888,7 @@ static RPCHelpMan testmempoolaccept()\n                 },\n                 RPCResult{\n                     RPCResult::Type::ARR, \"\", \"The result of the mempool acceptance test for each raw transaction in the input array.\\n\"\n-                        \"Length is exactly one for now.\",\n+                        \"Length is exactly one if any failures occur.\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r553011795",
      "id" : 553011795,
      "in_reply_to_id" : 552814597,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzAxMTc5NQ==",
      "original_commit_id" : "10860308da57ae417aeb6a0e35515235e5f9360a",
      "original_line" : 891,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : null,
      "pull_request_review_id" : 563099740,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/553011795",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r553349758"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/553349758"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes -- sounds like we're on the same page!",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-07T14:10:06Z",
      "diff_hunk" : "@@ -1024,46 +993,104 @@ bool MemPoolAccept::Finalize(ATMPArgs& args, Workspace& ws)\n     return true;\n }\n \n-bool MemPoolAccept::AcceptSingleTransaction(const CTransactionRef& ptx, ATMPArgs& args)\n+MempoolAcceptResult MemPoolAccept::AcceptSingleTransaction(const CTransactionRef& ptx, ATMPArgs& args)\n {\n     AssertLockHeld(cs_main);\n     LOCK(m_pool.cs); // mempool \"read lock\" (held through GetMainSignals().TransactionAddedToMempool())\n \n     Workspace workspace(ptx);\n+    MempoolAcceptResult result(ptx);\n \n-    if (!PreChecks(args, workspace)) return false;\n+    if (!PreChecks(args, result, workspace)) {\n+        result.m_accepted = false;\n+        return result;\n+    }\n \n     // Only compute the precomputed transaction data if we need to verify\n     // scripts (ie, other policy checks pass). We perform the inexpensive\n     // checks first and avoid hashing and signature verification unless those\n     // checks pass, to mitigate CPU exhaustion denial-of-service attacks.\n     PrecomputedTransactionData txdata;\n \n-    if (!PolicyScriptChecks(args, workspace, txdata)) return false;\n+    if (!PolicyScriptChecks(args, result, workspace, txdata)) {\n+        result.m_accepted = false;\n+        return result;\n+    }\n \n-    if (!ConsensusScriptChecks(args, workspace, txdata)) return false;\n+    if (!ConsensusScriptChecks(args, result, workspace, txdata)) {\n+        result.m_accepted = false;\n+        return result;\n+    }\n \n     // Tx was accepted, but not added\n-    if (args.m_test_accept) return true;\n+    if (args.m_test_accept) {\n+        result.m_accepted = true;\n+        return result;\n+    }\n \n-    if (!Finalize(args, workspace)) return false;\n+    if (!Finalize(args, result, workspace)) {\n+        result.m_accepted = false;\n+        return result;\n+    }\n \n     GetMainSignals().TransactionAddedToMempool(ptx, m_pool.GetAndIncrementSequence());\n \n-    return true;\n+    result.m_accepted = true;\n+    return result;\n+}\n+\n+std::vector<MempoolAcceptResult> MemPoolAccept::AcceptMultipleTransactions(std::vector<const CTransactionRef>& txns, ATMPArgs& args)\n+{\n+    AssertLockHeld(cs_main);\n+    LOCK(m_pool.cs);\n+    std::vector<MempoolAcceptResult> results{};\n+    std::vector<Workspace> workspaces{};\n+    workspaces.reserve(txns.size());\n+    std::transform(txns.begin(), txns.end(), std::back_inserter(workspaces), [](const CTransactionRef& tx) {\n+        return Workspace(tx);\n+    });\n+    // Do all PreChecks first and fail fast to avoid running expensive script\n+    // checks when unnecessary.\n+    for (unsigned int i = 0; i < txns.size(); ++i) {\n+        MempoolAcceptResult result(txns[i]);\n+        if (!PreChecks(args, result, workspaces[i])) {\n+            result.m_accepted = false;\n+            return std::vector<MempoolAcceptResult> {std::move(result)};\n+        }\n+        result.m_accepted = true; // Allowed so far\n+        m_viewmempool.AddPackageTransaction(txns[i]);\n+        results.push_back(result);\n+    }\n+\n+    // TODO: Enforce package-level feerate and other policies before script checks.\n+\n+    for (unsigned int i = 0; i < txns.size(); ++i) {\n+        PrecomputedTransactionData txdata;\n+\n+        if (!PolicyScriptChecks(args, results[i], workspaces[i], txdata)) {\n+            results[i].m_accepted = false;\n+            return std::vector<MempoolAcceptResult> {std::move(results[i])};\n+        }\n+\n+        if (!ConsensusScriptChecks(args, results[i], workspaces[i], txdata)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r553349758",
      "id" : 553349758,
      "in_reply_to_id" : 552161033,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzM0OTc1OA==",
      "original_commit_id" : "25412b8d13a5287670033d6bab7730e978bbb6be",
      "original_line" : 1075,
      "original_position" : 398,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 563513837,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/553349758",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "5th time's the charm I guess ð this is ready for review!",
      "created_at" : "2021-01-08T23:10:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#issuecomment-757042159",
      "id" : 757042159,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20833",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1NzA0MjE1OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-08T23:10:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/757042159",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK :) ",
      "created_at" : "2021-01-09T19:48:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#issuecomment-757357961",
      "id" : 757357961,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20833",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1NzM1Nzk2MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-09T19:48:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/757357961",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--4a62be1de6b64f3ed646cdc7932c8cf5-->\nðµï¸ @sipa has been requested to review this pull request as specified in the REVIEWERS file.",
      "created_at" : "2021-01-13T11:45:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#issuecomment-759396273",
      "id" : 759396273,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20833",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1OTM5NjI3Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-13T11:45:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/759396273",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r557161651"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/557161651"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in commit c97fae1011c4bd376898af73576756f163eeaf58:\r\n\r\nThis member seems currently unused? Also, what is the point of copying the (already cached) txid once more? If you need a reference to the tx, maybe store the `CTransactionRef`, but that seems redundant, because the caller is already aware of the tx.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-14T08:11:02Z",
      "diff_hunk" : "@@ -194,12 +194,22 @@ void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune);\n /** Prune block files up to a given height */\n void PruneBlockFilesManual(int nManualPruneHeight);\n \n-/** (try to) add transaction to memory pool\n- * plTxnReplaced will be appended to with all transactions replaced from mempool\n- * @param[out] fee_out optional argument to return tx fee to the caller **/\n-bool AcceptToMemoryPool(CTxMemPool& pool, TxValidationState &state, const CTransactionRef &tx,\n-                        std::list<CTransactionRef>* plTxnReplaced,\n-                        bool bypass_limits, bool test_accept=false, CAmount* fee_out=nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+/** Per-transaction result from trying to accept a transaction to the memory pool. */\n+struct MempoolAcceptResult {\n+    MempoolAcceptResult(const CTransactionRef& ptx) : txid(ptx->GetHash()) {}\n+\n+    uint256 txid;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r557161651",
      "id" : 557161651,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzE2MTY1MQ==",
      "original_commit_id" : "c97fae1011c4bd376898af73576756f163eeaf58",
      "original_line" : 201,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 567995465,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/557161651",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r557163163"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/557163163"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Would be nice to clarify what kind of fee this is. Probably base fee and not prioritized fee?",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-14T08:12:09Z",
      "diff_hunk" : "@@ -194,12 +194,22 @@ void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune);\n /** Prune block files up to a given height */\n void PruneBlockFilesManual(int nManualPruneHeight);\n \n-/** (try to) add transaction to memory pool\n- * plTxnReplaced will be appended to with all transactions replaced from mempool\n- * @param[out] fee_out optional argument to return tx fee to the caller **/\n-bool AcceptToMemoryPool(CTxMemPool& pool, TxValidationState &state, const CTransactionRef &tx,\n-                        std::list<CTransactionRef>* plTxnReplaced,\n-                        bool bypass_limits, bool test_accept=false, CAmount* fee_out=nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+/** Per-transaction result from trying to accept a transaction to the memory pool. */\n+struct MempoolAcceptResult {\n+    MempoolAcceptResult(const CTransactionRef& ptx) : txid(ptx->GetHash()) {}\n+\n+    uint256 txid;\n+    bool m_accepted = false;\n+    TxValidationState m_state;\n+    std::list<CTransactionRef> m_replaced_transactions{};\n+    CAmount m_fee = CAmount(0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r557163163",
      "id" : 557163163,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzE2MzE2Mw==",
      "original_commit_id" : "c97fae1011c4bd376898af73576756f163eeaf58",
      "original_line" : 205,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 567995465,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/557163163",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r557185885"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/557185885"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not sure if it makes sense to return a fee of `0` when the tx was rejected. At the very least the members that are optional, should be `std::optional`. Though, I am thinking that it could make sense to return two completely different types, based on whether the tx was accepted? I.e. a struct with `{fee, replaced_txs}` if the tx was accepted and a struct with `{state}` if the tx was rejected.\r\n\r\nThis would make it harder at the call sites to make mistakes such as returning the fee of a rejected tx.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-14T08:26:35Z",
      "diff_hunk" : "@@ -194,12 +194,22 @@ void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune);\n /** Prune block files up to a given height */\n void PruneBlockFilesManual(int nManualPruneHeight);\n \n-/** (try to) add transaction to memory pool\n- * plTxnReplaced will be appended to with all transactions replaced from mempool\n- * @param[out] fee_out optional argument to return tx fee to the caller **/\n-bool AcceptToMemoryPool(CTxMemPool& pool, TxValidationState &state, const CTransactionRef &tx,\n-                        std::list<CTransactionRef>* plTxnReplaced,\n-                        bool bypass_limits, bool test_accept=false, CAmount* fee_out=nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+/** Per-transaction result from trying to accept a transaction to the memory pool. */\n+struct MempoolAcceptResult {\n+    MempoolAcceptResult(const CTransactionRef& ptx) : txid(ptx->GetHash()) {}\n+\n+    uint256 txid;\n+    bool m_accepted = false;\n+    TxValidationState m_state;\n+    std::list<CTransactionRef> m_replaced_transactions{};\n+    CAmount m_fee = CAmount(0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r557185885",
      "id" : 557185885,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzE4NTg4NQ==",
      "original_commit_id" : "c97fae1011c4bd376898af73576756f163eeaf58",
      "original_line" : 205,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 567995465,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/557185885",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-01-14T16:34:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#issuecomment-760311306",
      "id" : 760311306,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20833",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2MDMxMTMwNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-14T16:34:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/760311306",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r557530738"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/557530738"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Right, it's not used in https://github.com/bitcoin/bitcoin/commit/c97fae1011c4bd376898af73576756f163eeaf58. I ended up needing it for multi-accept on the failure case to indicate which tx failed. It might fit better in https://github.com/bitcoin/bitcoin/pull/20833/commits/2f36f0743158817635a39f7efb60541fe0c4b31d",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-14T16:35:31Z",
      "diff_hunk" : "@@ -194,12 +194,22 @@ void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune);\n /** Prune block files up to a given height */\n void PruneBlockFilesManual(int nManualPruneHeight);\n \n-/** (try to) add transaction to memory pool\n- * plTxnReplaced will be appended to with all transactions replaced from mempool\n- * @param[out] fee_out optional argument to return tx fee to the caller **/\n-bool AcceptToMemoryPool(CTxMemPool& pool, TxValidationState &state, const CTransactionRef &tx,\n-                        std::list<CTransactionRef>* plTxnReplaced,\n-                        bool bypass_limits, bool test_accept=false, CAmount* fee_out=nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+/** Per-transaction result from trying to accept a transaction to the memory pool. */\n+struct MempoolAcceptResult {\n+    MempoolAcceptResult(const CTransactionRef& ptx) : txid(ptx->GetHash()) {}\n+\n+    uint256 txid;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r557530738",
      "id" : 557530738,
      "in_reply_to_id" : 557161651,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzUzMDczOA==",
      "original_commit_id" : "c97fae1011c4bd376898af73576756f163eeaf58",
      "original_line" : 201,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 568412951,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/557530738",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r557561211"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/557561211"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: you can probably ditch`self.extra_args = [[]]` right?",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-14T17:19:03Z",
      "diff_hunk" : "@@ -0,0 +1,186 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"RPCs that handle raw transaction packages.\"\"\"\n+\n+from decimal import Decimal\n+from io import BytesIO\n+\n+from test_framework.address import ADDRESS_BCRT1_P2WSH_OP_TRUE\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    BIP125_SEQUENCE_NUMBER,\n+    COIN,\n+    CTransaction,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+    hex_str_to_bytes,\n+)\n+\n+class RPCPackagesTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+        self.extra_args = [[]]",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r557561211",
      "id" : 557561211,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzU2MTIxMQ==",
      "original_commit_id" : "79e5512206fa91acc09b843bd2962903fb2b6b8d",
      "original_line" : 25,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "test/functional/rpc_packages.py",
      "position" : null,
      "pull_request_review_id" : 568454011,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/557561211",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r557562563"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/557562563"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "would it be better to check that this now passes without throwing rather than removing it?",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-14T17:21:04Z",
      "diff_hunk" : "@@ -65,7 +65,6 @@ def run_test(self):\n \n         self.log.info('Should not accept garbage to testmempoolaccept')\n         assert_raises_rpc_error(-3, 'Expected type array, got string', lambda: node.testmempoolaccept(rawtxs='ff00baar'))\n-        assert_raises_rpc_error(-8, 'Array must contain exactly one raw transaction for now', lambda: node.testmempoolaccept(rawtxs=['ff00baar', 'ff22']))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r557562563",
      "id" : 557562563,
      "line" : 70,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzU2MjU2Mw==",
      "original_commit_id" : "79e5512206fa91acc09b843bd2962903fb2b6b8d",
      "original_line" : 70,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/mempool_accept.py",
      "position" : 4,
      "pull_request_review_id" : 568454011,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/557562563",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r557600992"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/557600992"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I preferred keeping the package-related tests in rpc_package.py",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-14T18:24:33Z",
      "diff_hunk" : "@@ -65,7 +65,6 @@ def run_test(self):\n \n         self.log.info('Should not accept garbage to testmempoolaccept')\n         assert_raises_rpc_error(-3, 'Expected type array, got string', lambda: node.testmempoolaccept(rawtxs='ff00baar'))\n-        assert_raises_rpc_error(-8, 'Array must contain exactly one raw transaction for now', lambda: node.testmempoolaccept(rawtxs=['ff00baar', 'ff22']))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r557600992",
      "id" : 557600992,
      "in_reply_to_id" : 557562563,
      "line" : 70,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzYwMDk5Mg==",
      "original_commit_id" : "79e5512206fa91acc09b843bd2962903fb2b6b8d",
      "original_line" : 70,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/mempool_accept.py",
      "position" : 4,
      "pull_request_review_id" : 568506197,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/557600992",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r557601346"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/557601346"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "(also these 2 are not well-formed transactions, so it would return a deserialization error)",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-14T18:25:08Z",
      "diff_hunk" : "@@ -65,7 +65,6 @@ def run_test(self):\n \n         self.log.info('Should not accept garbage to testmempoolaccept')\n         assert_raises_rpc_error(-3, 'Expected type array, got string', lambda: node.testmempoolaccept(rawtxs='ff00baar'))\n-        assert_raises_rpc_error(-8, 'Array must contain exactly one raw transaction for now', lambda: node.testmempoolaccept(rawtxs=['ff00baar', 'ff22']))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r557601346",
      "id" : 557601346,
      "in_reply_to_id" : 557562563,
      "line" : 70,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzYwMTM0Ng==",
      "original_commit_id" : "79e5512206fa91acc09b843bd2962903fb2b6b8d",
      "original_line" : 70,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/mempool_accept.py",
      "position" : 4,
      "pull_request_review_id" : 568506667,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/557601346",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r557603719"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/557603719"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "OK, that makes sense. All good ð",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-14T18:29:15Z",
      "diff_hunk" : "@@ -65,7 +65,6 @@ def run_test(self):\n \n         self.log.info('Should not accept garbage to testmempoolaccept')\n         assert_raises_rpc_error(-3, 'Expected type array, got string', lambda: node.testmempoolaccept(rawtxs='ff00baar'))\n-        assert_raises_rpc_error(-8, 'Array must contain exactly one raw transaction for now', lambda: node.testmempoolaccept(rawtxs=['ff00baar', 'ff22']))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r557603719",
      "id" : 557603719,
      "in_reply_to_id" : 557562563,
      "line" : 70,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzYwMzcxOQ==",
      "original_commit_id" : "79e5512206fa91acc09b843bd2962903fb2b6b8d",
      "original_line" : 70,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/mempool_accept.py",
      "position" : 4,
      "pull_request_review_id" : 568509766,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/557603719",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@mjdietzx thanks for review! :)\r\n\r\n> I think soon `test/functional/rpc_packages.py` can be done with `MiniWallet` and get rid of some code.\r\n\r\nI didn't feel like `MiniWallet` suited my needs at the moment - I needed to chain transactions and wanted more control over the scripts. I considered just adding more functionality to `MiniWallet` but it might not be needed elsewhere and would conflict with a lot of the PRs that stem from #20078 (which I am a huge fan of) ð. Certainly interested in putting more of the code in test_framework/wallet.py in the future, if it could be reused!",
      "created_at" : "2021-01-14T18:45:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#issuecomment-760395006",
      "id" : 760395006,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20833",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2MDM5NTAwNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-14T18:51:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/760395006",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r557613939"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/557613939"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ah true! I'm also starting to think that `m_accepted == m_state.IsValid()` always?? ð¤ maybe could get rid of that and do\r\n\r\n```c\r\nTxValidationState m_state;\r\nstd::optional<std::list<CTransactionRef>> m_replaced_transactions;\r\nstd::optional<CAmount> m_base_fee;\r\n```",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-14T18:47:14Z",
      "diff_hunk" : "@@ -194,12 +194,22 @@ void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune);\n /** Prune block files up to a given height */\n void PruneBlockFilesManual(int nManualPruneHeight);\n \n-/** (try to) add transaction to memory pool\n- * plTxnReplaced will be appended to with all transactions replaced from mempool\n- * @param[out] fee_out optional argument to return tx fee to the caller **/\n-bool AcceptToMemoryPool(CTxMemPool& pool, TxValidationState &state, const CTransactionRef &tx,\n-                        std::list<CTransactionRef>* plTxnReplaced,\n-                        bool bypass_limits, bool test_accept=false, CAmount* fee_out=nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+/** Per-transaction result from trying to accept a transaction to the memory pool. */\n+struct MempoolAcceptResult {\n+    MempoolAcceptResult(const CTransactionRef& ptx) : txid(ptx->GetHash()) {}\n+\n+    uint256 txid;\n+    bool m_accepted = false;\n+    TxValidationState m_state;\n+    std::list<CTransactionRef> m_replaced_transactions{};\n+    CAmount m_fee = CAmount(0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r557613939",
      "id" : 557613939,
      "in_reply_to_id" : 557185885,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzYxMzkzOQ==",
      "original_commit_id" : "c97fae1011c4bd376898af73576756f163eeaf58",
      "original_line" : 205,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 568522776,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/557613939",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r557615182"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/557615182"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "ya i think you're right",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-14T18:49:28Z",
      "diff_hunk" : "@@ -0,0 +1,186 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"RPCs that handle raw transaction packages.\"\"\"\n+\n+from decimal import Decimal\n+from io import BytesIO\n+\n+from test_framework.address import ADDRESS_BCRT1_P2WSH_OP_TRUE\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    BIP125_SEQUENCE_NUMBER,\n+    COIN,\n+    CTransaction,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+    hex_str_to_bytes,\n+)\n+\n+class RPCPackagesTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+        self.extra_args = [[]]",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r557615182",
      "id" : 557615182,
      "in_reply_to_id" : 557561211,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzYxNTE4Mg==",
      "original_commit_id" : "79e5512206fa91acc09b843bd2962903fb2b6b8d",
      "original_line" : 25,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "test/functional/rpc_packages.py",
      "position" : null,
      "pull_request_review_id" : 568524233,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/557615182",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r557626960"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/557626960"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not sure about the equivalence right now, but `if m_accepted then m_state.IsValid()` should hold.\r\n\r\nSo you don't need to return a validation state if the tx was accepted. Though, instead of having a return struct with\r\n```\r\noptional<state>\r\noptional<fee>\r\noptional<txs>\r\n...\r\n```\r\n\r\nIt could make sense to have one struct `Success` with \r\n```\r\nfee\r\ntxs\r\n```\r\nand then return `std::variant<Sucess, TxValidationState>`\r\n\r\n\r\nwdyt?",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-14T19:10:50Z",
      "diff_hunk" : "@@ -194,12 +194,22 @@ void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune);\n /** Prune block files up to a given height */\n void PruneBlockFilesManual(int nManualPruneHeight);\n \n-/** (try to) add transaction to memory pool\n- * plTxnReplaced will be appended to with all transactions replaced from mempool\n- * @param[out] fee_out optional argument to return tx fee to the caller **/\n-bool AcceptToMemoryPool(CTxMemPool& pool, TxValidationState &state, const CTransactionRef &tx,\n-                        std::list<CTransactionRef>* plTxnReplaced,\n-                        bool bypass_limits, bool test_accept=false, CAmount* fee_out=nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+/** Per-transaction result from trying to accept a transaction to the memory pool. */\n+struct MempoolAcceptResult {\n+    MempoolAcceptResult(const CTransactionRef& ptx) : txid(ptx->GetHash()) {}\n+\n+    uint256 txid;\n+    bool m_accepted = false;\n+    TxValidationState m_state;\n+    std::list<CTransactionRef> m_replaced_transactions{};\n+    CAmount m_fee = CAmount(0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r557626960",
      "id" : 557626960,
      "in_reply_to_id" : 557185885,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzYyNjk2MA==",
      "original_commit_id" : "c97fae1011c4bd376898af73576756f163eeaf58",
      "original_line" : 205,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 568539848,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/557626960",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r559265297"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559265297"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think we have a coding style recommendation for this, but IMO it's more intuitive to have `comment - arg` rather than `arg - comment`. At least other codebase callsites are following this.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-18T00:39:09Z",
      "diff_hunk" : "@@ -48,9 +48,8 @@ static void AssembleBlock(benchmark::Bench& bench)\n         LOCK(::cs_main); // Required for ::AcceptToMemoryPool.\n \n         for (const auto& txr : txs) {\n-            TxValidationState state;\n-            bool ret{::AcceptToMemoryPool(*test_setup.m_node.mempool, state, txr, nullptr /* plTxnReplaced */, false /* bypass_limits */)};\n-            assert(ret);\n+            const MempoolAcceptResult res = ::AcceptToMemoryPool(*test_setup.m_node.mempool, txr, false /* bypass_limits */);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r559265297",
      "id" : 559265297,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTI2NTI5Nw==",
      "original_commit_id" : "c97fae1011c4bd376898af73576756f163eeaf58",
      "original_line" : 51,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/bench/block_assemble.cpp",
      "position" : null,
      "pull_request_review_id" : 570114670,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559265297",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r559265704"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559265704"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why breaking line for rvalue ?",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-18T00:42:09Z",
      "diff_hunk" : "@@ -50,23 +50,21 @@ TransactionError BroadcastTransaction(NodeContext& node, const CTransactionRef t\n     }\n     if (!node.mempool->exists(hashTx)) {\n         // Transaction is not already in the mempool.\n-        TxValidationState state;\n         if (max_tx_fee > 0) {\n             // First, call ATMP with test_accept and check the fee. If ATMP\n             // fails here, return error immediately.\n-            CAmount fee{0};\n-            if (!AcceptToMemoryPool(*node.mempool, state, tx,\n-                nullptr /* plTxnReplaced */, false /* bypass_limits */, /* test_accept */ true, &fee)) {\n-                return HandleATMPError(state, err_string);\n-            } else if (fee > max_tx_fee) {\n+            const MempoolAcceptResult result =\n+                AcceptToMemoryPool(*node.mempool, tx, false /* bypass_limits */, true /* test_accept */);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r559265704",
      "id" : 559265704,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTI2NTcwNA==",
      "original_commit_id" : "c97fae1011c4bd376898af73576756f163eeaf58",
      "original_line" : 57,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/node/transaction.cpp",
      "position" : null,
      "pull_request_review_id" : 570114670,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559265704",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r559269796"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559269796"
         }
      },
      "author_association" : "MEMBER",
      "body" : "\"Evaluation result of a single-transaction mempool acceptance\", better than repeating twice transaction ?",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-18T01:07:36Z",
      "diff_hunk" : "@@ -194,12 +194,22 @@ void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune);\n /** Prune block files up to a given height */\n void PruneBlockFilesManual(int nManualPruneHeight);\n \n-/** (try to) add transaction to memory pool\n- * plTxnReplaced will be appended to with all transactions replaced from mempool\n- * @param[out] fee_out optional argument to return tx fee to the caller **/\n-bool AcceptToMemoryPool(CTxMemPool& pool, TxValidationState &state, const CTransactionRef &tx,\n-                        std::list<CTransactionRef>* plTxnReplaced,\n-                        bool bypass_limits, bool test_accept=false, CAmount* fee_out=nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+/** Per-transaction result from trying to accept a transaction to the memory pool. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r559269796",
      "id" : 559269796,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTI2OTc5Ng==",
      "original_commit_id" : "c97fae1011c4bd376898af73576756f163eeaf58",
      "original_line" : 197,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 570114670,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559269796",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r559286531"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559286531"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I need to dig more but if we do have a bug slips in, you might inflate the utxo cache and not update accurately `coins_to_uncache`. Thus in case of invalid transactions it avoids wasting cache space with junks. I don't understand your commit rational to deprecate this belt-and-suspender. ",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-18T02:34:08Z",
      "diff_hunk" : "@@ -659,11 +659,6 @@ bool MemPoolAccept::PreChecks(ATMPArgs& args, MempoolAcceptResult& result, Works\n     // Bring the best block into scope\n     m_view.GetBestBlock();\n \n-    // we have all inputs cached now, so switch back to dummy (to protect\n-    // against bugs where we pull more inputs from disk that miss being added\n-    // to coins_to_uncache)\n-    m_view.SetBackend(m_dummy);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r559286531",
      "id" : 559286531,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTI4NjUzMQ==",
      "original_commit_id" : "4a8e3e1a1767865a32905e8043b7c2e28b0cfd6a",
      "original_line" : 700,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 570114670,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559286531",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r559287607"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559287607"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think you need mempool state for this new check and the other one. You're verifying package element against each other (txid-vs-txid, input-vs-input). \r\n\r\nMaybe they could be gathered in some `SanitizePackage` function called in `ProcessNewPackage`. This would avoid encumbering more `PreChecks()` code path.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-18T02:38:39Z",
      "diff_hunk" : "@@ -602,6 +605,11 @@ bool MemPoolAccept::PreChecks(ATMPArgs& args, MempoolAcceptResult& result, Works\n         return state.Invalid(TxValidationResult::TX_CONFLICT, \"txn-already-in-mempool\");\n     }\n \n+    // Check for duplicates in package",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r559287607",
      "id" : 559287607,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTI4NzYwNw==",
      "original_commit_id" : "2f36f0743158817635a39f7efb60541fe0c4b31d",
      "original_line" : 608,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 570114670,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559287607",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r559288304"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559288304"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think you can split `ProcessNewPackage()`/`AcceptMultipleTransactions` in its own commit. Better to isolate mempool changes from rpc-level ones IMO.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-18T02:41:59Z",
      "diff_hunk" : "@@ -921,56 +920,78 @@ static RPCHelpMan testmempoolaccept()\n         UniValueType(), // VNUM or VSTR, checked inside AmountFromValue()\n     });\n \n-    if (request.params[0].get_array().size() != 1) {\n-        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Array must contain exactly one raw transaction for now\");\n-    }\n-\n-    CMutableTransaction mtx;\n-    if (!DecodeHexTx(mtx, request.params[0].get_array()[0].get_str())) {\n-        throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed. Make sure the tx has at least one input.\");\n-    }\n-    CTransactionRef tx(MakeTransactionRef(std::move(mtx)));\n-    const uint256& tx_hash = tx->GetHash();\n-\n+    UniValue transactions = request.params[0].get_array();\n     const CFeeRate max_raw_tx_fee_rate = request.params[1].isNull() ?\n                                              DEFAULT_MAX_RAW_TX_FEE_RATE :\n                                              CFeeRate(AmountFromValue(request.params[1]));\n \n     CTxMemPool& mempool = EnsureMemPool(request.context);\n-    int64_t virtual_size = GetVirtualTransactionSize(*tx);\n-    CAmount max_raw_tx_fee = max_raw_tx_fee_rate.GetFee(virtual_size);\n \n-    UniValue result(UniValue::VARR);\n-    UniValue result_0(UniValue::VOBJ);\n-    result_0.pushKV(\"txid\", tx_hash.GetHex());\n+    std::vector<CTransactionRef> txns;\n \n-    MempoolAcceptResult accept_result(std::move(tx));\n-    {\n-        LOCK(cs_main);\n-        accept_result = AcceptToMemoryPool(mempool, std::move(tx),\n-            false /* bypass_limits */, true /* test_accept */);\n+    for (unsigned int i = 0; i < transactions.size(); ++i) {\n+        CMutableTransaction mtx;\n+        if (!DecodeHexTx(mtx, transactions[i].get_str())) {\n+            throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed\");\n+        }\n+        txns.emplace_back(MakeTransactionRef(std::move(mtx)));\n     }\n-    const bool test_accept_res = accept_result.m_accepted;\n-    const TxValidationState state = accept_result.m_state;\n-    const CAmount fee = accept_result.m_fee;\n \n-    // Check that fee does not exceed maximum fee\n-    if (test_accept_res && max_raw_tx_fee && fee > max_raw_tx_fee) {\n-        result_0.pushKV(\"allowed\", false);\n-        result_0.pushKV(\"reject-reason\", \"max-fee-exceeded\");\n-        result.push_back(std::move(result_0));\n-        return result;\n+    std::vector<MempoolAcceptResult> validation_results;\n+    if (transactions.size() == 1) {\n+        {\n+            LOCK(cs_main);\n+            validation_results.emplace_back(\n+                AcceptToMemoryPool(mempool, txns[0], false /* bypass_limits */, true /* test_accept */));\n+        }\n+    } else {\n+        {\n+            LOCK(cs_main);\n+            validation_results = ProcessNewPackage(mempool, txns, true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r559288304",
      "id" : 559288304,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTI4ODMwNA==",
      "original_commit_id" : "2f36f0743158817635a39f7efb60541fe0c4b31d",
      "original_line" : 950,
      "original_position" : 80,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : null,
      "pull_request_review_id" : 570114670,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559288304",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ariard i think it is only intended to be a convenient way to sanity check for \"static\" standardness bounds, not for testing the whole validity prior to broadcast (which is intractable..). ",
      "created_at" : "2021-01-18T08:34:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#issuecomment-762080588",
      "id" : 762080588,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20833",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2MjA4MDU4OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-18T08:34:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/762080588",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r559619214"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559619214"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Let me try to elaborate a bit: when validating packages, we have each coin in the `m_viewmempool`, which at this point is the `m_view` backend. If we set the backend to dummy, we lose the ability to look up those coins. Typically, the backend allows for going to disk (which would be unnecessary after this line and be the source of a `coins_to_uncache` leak). Since we need the coins in `CheckSequenceLocks` right afterward, and then for `CheckInputScripts` again later, I got rid of it ð¤ maybe a little aggressive oops\r\n\r\nThe lines above for each input:\r\n\r\n```c\r\n        if (!coins_cache.HaveCoinInCache(txin.prevout)) {\r\n            coins_to_uncache.push_back(txin.prevout);\r\n        }\r\n```\r\n\r\nshould catch all of the coins that we need to uncache. It's a belt-and-suspenders check I would prefer not to remove, but we would need to implement a little differently. Perhaps a boolean in `CCoinsViewMemPool` for allowing fetching from disk?",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-18T14:51:11Z",
      "diff_hunk" : "@@ -659,11 +659,6 @@ bool MemPoolAccept::PreChecks(ATMPArgs& args, MempoolAcceptResult& result, Works\n     // Bring the best block into scope\n     m_view.GetBestBlock();\n \n-    // we have all inputs cached now, so switch back to dummy (to protect\n-    // against bugs where we pull more inputs from disk that miss being added\n-    // to coins_to_uncache)\n-    m_view.SetBackend(m_dummy);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r559619214",
      "id" : 559619214,
      "in_reply_to_id" : 559286531,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTYxOTIxNA==",
      "original_commit_id" : "4a8e3e1a1767865a32905e8043b7c2e28b0cfd6a",
      "original_line" : 700,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 570558793,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559619214",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r559722425"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559722425"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah I agree - I just started writing this and I think we should actually put the `TxValidationState` and `m_base_fees` into the `MemPoolAccept::Workspace` (since we need access throughout validation), then return whichever is appropriate at the end.\r\n\r\nHow does this look?\r\n```c\r\n\r\nstruct MempoolAcceptSuccess {\r\n    std::list<CTransactionRef> m_replaced_transactions;\r\n    CAmount m_base_fee;\r\n}\r\n\r\nusing MempoolAcceptResult = std::variant<MempoolAcceptSuccess, TxValidationState>;\r\nusing PackageAcceptResult = std::variant<std::vector<MempoolAcceptSuccess>, std::tuple<uint256, TxValidationState>>;\r\n```\r\n",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-18T17:45:53Z",
      "diff_hunk" : "@@ -194,12 +194,22 @@ void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune);\n /** Prune block files up to a given height */\n void PruneBlockFilesManual(int nManualPruneHeight);\n \n-/** (try to) add transaction to memory pool\n- * plTxnReplaced will be appended to with all transactions replaced from mempool\n- * @param[out] fee_out optional argument to return tx fee to the caller **/\n-bool AcceptToMemoryPool(CTxMemPool& pool, TxValidationState &state, const CTransactionRef &tx,\n-                        std::list<CTransactionRef>* plTxnReplaced,\n-                        bool bypass_limits, bool test_accept=false, CAmount* fee_out=nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+/** Per-transaction result from trying to accept a transaction to the memory pool. */\n+struct MempoolAcceptResult {\n+    MempoolAcceptResult(const CTransactionRef& ptx) : txid(ptx->GetHash()) {}\n+\n+    uint256 txid;\n+    bool m_accepted = false;\n+    TxValidationState m_state;\n+    std::list<CTransactionRef> m_replaced_transactions{};\n+    CAmount m_fee = CAmount(0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r559722425",
      "id" : 559722425,
      "in_reply_to_id" : 557185885,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTcyMjQyNQ==",
      "original_commit_id" : "c97fae1011c4bd376898af73576756f163eeaf58",
      "original_line" : 205,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 570690922,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559722425",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r559745529"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559745529"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Looks good",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-18T18:43:50Z",
      "diff_hunk" : "@@ -194,12 +194,22 @@ void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune);\n /** Prune block files up to a given height */\n void PruneBlockFilesManual(int nManualPruneHeight);\n \n-/** (try to) add transaction to memory pool\n- * plTxnReplaced will be appended to with all transactions replaced from mempool\n- * @param[out] fee_out optional argument to return tx fee to the caller **/\n-bool AcceptToMemoryPool(CTxMemPool& pool, TxValidationState &state, const CTransactionRef &tx,\n-                        std::list<CTransactionRef>* plTxnReplaced,\n-                        bool bypass_limits, bool test_accept=false, CAmount* fee_out=nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+/** Per-transaction result from trying to accept a transaction to the memory pool. */\n+struct MempoolAcceptResult {\n+    MempoolAcceptResult(const CTransactionRef& ptx) : txid(ptx->GetHash()) {}\n+\n+    uint256 txid;\n+    bool m_accepted = false;\n+    TxValidationState m_state;\n+    std::list<CTransactionRef> m_replaced_transactions{};\n+    CAmount m_fee = CAmount(0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r559745529",
      "id" : 559745529,
      "in_reply_to_id" : 557185885,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTc0NTUyOQ==",
      "original_commit_id" : "c97fae1011c4bd376898af73576756f163eeaf58",
      "original_line" : 205,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 570719254,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559745529",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r559772174"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559772174"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Oops. I just realized `Workspace` is intended to be const after `PreChecks` populates it, so it can't hold `TxValidationState` since that can mutate during the script checks.\r\nWill do the `std::optional` approach for now, it's actually a bit cleaner I think.",
      "commit_id" : "79e5512206fa91acc09b843bd2962903fb2b6b8d",
      "created_at" : "2021-01-18T19:57:40Z",
      "diff_hunk" : "@@ -194,12 +194,22 @@ void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune);\n /** Prune block files up to a given height */\n void PruneBlockFilesManual(int nManualPruneHeight);\n \n-/** (try to) add transaction to memory pool\n- * plTxnReplaced will be appended to with all transactions replaced from mempool\n- * @param[out] fee_out optional argument to return tx fee to the caller **/\n-bool AcceptToMemoryPool(CTxMemPool& pool, TxValidationState &state, const CTransactionRef &tx,\n-                        std::list<CTransactionRef>* plTxnReplaced,\n-                        bool bypass_limits, bool test_accept=false, CAmount* fee_out=nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+/** Per-transaction result from trying to accept a transaction to the memory pool. */\n+struct MempoolAcceptResult {\n+    MempoolAcceptResult(const CTransactionRef& ptx) : txid(ptx->GetHash()) {}\n+\n+    uint256 txid;\n+    bool m_accepted = false;\n+    TxValidationState m_state;\n+    std::list<CTransactionRef> m_replaced_transactions{};\n+    CAmount m_fee = CAmount(0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r559772174",
      "id" : 559772174,
      "in_reply_to_id" : 557185885,
      "line" : 205,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTc3MjE3NA==",
      "original_commit_id" : "c97fae1011c4bd376898af73576756f163eeaf58",
      "original_line" : 205,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 34,
      "pull_request_review_id" : 570750327,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-18T19:57:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559772174",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@darosior Yes but as `testmempoolaccept` result is `{success, failure}` so for e.g if a package tx is time-locked in the future, you will get a failure and wrongly fail your L2 flow ? I don't think \"static\" (or stateless?) standardness bounds is more defined.",
      "created_at" : "2021-01-19T02:05:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#issuecomment-762553705",
      "id" : 762553705,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20833",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2MjU1MzcwNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-19T02:07:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/762553705",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ariard i think it would be useful to test the first stage -non timelocked- flow (in specific for Revault, the deposit-emergency, deposit-unvault-cancel, and deposit-unvault-emergency scenarii) without mocking actual tx sending and block generation. I don't think it'd be really useful for \"check at runtime\" either.\r\nAs for the \"static\" bounds, there are for instance the maximum standard witscript size or minimum relay fee that are time (and fee-bumping) independent.",
      "created_at" : "2021-01-19T11:54:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#issuecomment-762794603",
      "id" : 762794603,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20833",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2Mjc5NDYwMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-19T11:54:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/762794603",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r560327691"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/560327691"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "ay @MarcoFalke, the `std::variant` method is a bit hairy... see [this branch](https://github.com/glozow/bitcoin/commit/7d9151afc0d95e232bf1f57e8e052f5dc3bef7e7). It works, but has a larger diff so I'm worried it might encumber reviewers. If you think it's an improvement, I can leave it for a followup or something?",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-19T16:51:46Z",
      "diff_hunk" : "@@ -194,12 +194,22 @@ void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune);\n /** Prune block files up to a given height */\n void PruneBlockFilesManual(int nManualPruneHeight);\n \n-/** (try to) add transaction to memory pool\n- * plTxnReplaced will be appended to with all transactions replaced from mempool\n- * @param[out] fee_out optional argument to return tx fee to the caller **/\n-bool AcceptToMemoryPool(CTxMemPool& pool, TxValidationState &state, const CTransactionRef &tx,\n-                        std::list<CTransactionRef>* plTxnReplaced,\n-                        bool bypass_limits, bool test_accept=false, CAmount* fee_out=nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+/** Per-transaction result from trying to accept a transaction to the memory pool. */\n+struct MempoolAcceptResult {\n+    MempoolAcceptResult(const CTransactionRef& ptx) : txid(ptx->GetHash()) {}\n+\n+    uint256 txid;\n+    bool m_accepted = false;\n+    TxValidationState m_state;\n+    std::list<CTransactionRef> m_replaced_transactions{};\n+    CAmount m_fee = CAmount(0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r560327691",
      "id" : 560327691,
      "in_reply_to_id" : 557185885,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDMyNzY5MQ==",
      "original_commit_id" : "c97fae1011c4bd376898af73576756f163eeaf58",
      "original_line" : 205,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 571445634,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/560327691",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r560506055"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/560506055"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't like long lines ð¤· I put it back since it's not too bad",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-19T21:25:13Z",
      "diff_hunk" : "@@ -50,23 +50,21 @@ TransactionError BroadcastTransaction(NodeContext& node, const CTransactionRef t\n     }\n     if (!node.mempool->exists(hashTx)) {\n         // Transaction is not already in the mempool.\n-        TxValidationState state;\n         if (max_tx_fee > 0) {\n             // First, call ATMP with test_accept and check the fee. If ATMP\n             // fails here, return error immediately.\n-            CAmount fee{0};\n-            if (!AcceptToMemoryPool(*node.mempool, state, tx,\n-                nullptr /* plTxnReplaced */, false /* bypass_limits */, /* test_accept */ true, &fee)) {\n-                return HandleATMPError(state, err_string);\n-            } else if (fee > max_tx_fee) {\n+            const MempoolAcceptResult result =\n+                AcceptToMemoryPool(*node.mempool, tx, false /* bypass_limits */, true /* test_accept */);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r560506055",
      "id" : 560506055,
      "in_reply_to_id" : 559265704,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDUwNjA1NQ==",
      "original_commit_id" : "c97fae1011c4bd376898af73576756f163eeaf58",
      "original_line" : 57,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/node/transaction.cpp",
      "position" : null,
      "pull_request_review_id" : 571673426,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/560506055",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r560507542"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/560507542"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Right good point. I've removed it since checking inputs is a better way to test duplicates/conflicts. I'll note for the future to do context-free sanitization checks before taking the lock :) ",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-19T21:27:35Z",
      "diff_hunk" : "@@ -602,6 +605,11 @@ bool MemPoolAccept::PreChecks(ATMPArgs& args, MempoolAcceptResult& result, Works\n         return state.Invalid(TxValidationResult::TX_CONFLICT, \"txn-already-in-mempool\");\n     }\n \n+    // Check for duplicates in package",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r560507542",
      "id" : 560507542,
      "in_reply_to_id" : 559287607,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDUwNzU0Mg==",
      "original_commit_id" : "2f36f0743158817635a39f7efb60541fe0c4b31d",
      "original_line" : 608,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 571675057,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/560507542",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r560507626"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/560507626"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "taken",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-19T21:27:44Z",
      "diff_hunk" : "@@ -921,56 +920,78 @@ static RPCHelpMan testmempoolaccept()\n         UniValueType(), // VNUM or VSTR, checked inside AmountFromValue()\n     });\n \n-    if (request.params[0].get_array().size() != 1) {\n-        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Array must contain exactly one raw transaction for now\");\n-    }\n-\n-    CMutableTransaction mtx;\n-    if (!DecodeHexTx(mtx, request.params[0].get_array()[0].get_str())) {\n-        throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed. Make sure the tx has at least one input.\");\n-    }\n-    CTransactionRef tx(MakeTransactionRef(std::move(mtx)));\n-    const uint256& tx_hash = tx->GetHash();\n-\n+    UniValue transactions = request.params[0].get_array();\n     const CFeeRate max_raw_tx_fee_rate = request.params[1].isNull() ?\n                                              DEFAULT_MAX_RAW_TX_FEE_RATE :\n                                              CFeeRate(AmountFromValue(request.params[1]));\n \n     CTxMemPool& mempool = EnsureMemPool(request.context);\n-    int64_t virtual_size = GetVirtualTransactionSize(*tx);\n-    CAmount max_raw_tx_fee = max_raw_tx_fee_rate.GetFee(virtual_size);\n \n-    UniValue result(UniValue::VARR);\n-    UniValue result_0(UniValue::VOBJ);\n-    result_0.pushKV(\"txid\", tx_hash.GetHex());\n+    std::vector<CTransactionRef> txns;\n \n-    MempoolAcceptResult accept_result(std::move(tx));\n-    {\n-        LOCK(cs_main);\n-        accept_result = AcceptToMemoryPool(mempool, std::move(tx),\n-            false /* bypass_limits */, true /* test_accept */);\n+    for (unsigned int i = 0; i < transactions.size(); ++i) {\n+        CMutableTransaction mtx;\n+        if (!DecodeHexTx(mtx, transactions[i].get_str())) {\n+            throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed\");\n+        }\n+        txns.emplace_back(MakeTransactionRef(std::move(mtx)));\n     }\n-    const bool test_accept_res = accept_result.m_accepted;\n-    const TxValidationState state = accept_result.m_state;\n-    const CAmount fee = accept_result.m_fee;\n \n-    // Check that fee does not exceed maximum fee\n-    if (test_accept_res && max_raw_tx_fee && fee > max_raw_tx_fee) {\n-        result_0.pushKV(\"allowed\", false);\n-        result_0.pushKV(\"reject-reason\", \"max-fee-exceeded\");\n-        result.push_back(std::move(result_0));\n-        return result;\n+    std::vector<MempoolAcceptResult> validation_results;\n+    if (transactions.size() == 1) {\n+        {\n+            LOCK(cs_main);\n+            validation_results.emplace_back(\n+                AcceptToMemoryPool(mempool, txns[0], false /* bypass_limits */, true /* test_accept */));\n+        }\n+    } else {\n+        {\n+            LOCK(cs_main);\n+            validation_results = ProcessNewPackage(mempool, txns, true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r560507626",
      "id" : 560507626,
      "in_reply_to_id" : 559288304,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDUwNzYyNg==",
      "original_commit_id" : "2f36f0743158817635a39f7efb60541fe0c4b31d",
      "original_line" : 950,
      "original_position" : 80,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : null,
      "pull_request_review_id" : 571675166,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/560507626",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r560508663"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/560508663"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I agree, really, but didn't change it because I'd rather put all my opinion-energy into having a `MempoolAcceptResult` struct ð ",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-19T21:29:38Z",
      "diff_hunk" : "@@ -48,9 +48,8 @@ static void AssembleBlock(benchmark::Bench& bench)\n         LOCK(::cs_main); // Required for ::AcceptToMemoryPool.\n \n         for (const auto& txr : txs) {\n-            TxValidationState state;\n-            bool ret{::AcceptToMemoryPool(*test_setup.m_node.mempool, state, txr, nullptr /* plTxnReplaced */, false /* bypass_limits */)};\n-            assert(ret);\n+            const MempoolAcceptResult res = ::AcceptToMemoryPool(*test_setup.m_node.mempool, txr, false /* bypass_limits */);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r560508663",
      "id" : 560508663,
      "in_reply_to_id" : 559265297,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDUwODY2Mw==",
      "original_commit_id" : "c97fae1011c4bd376898af73576756f163eeaf58",
      "original_line" : 51,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/bench/block_assemble.cpp",
      "position" : null,
      "pull_request_review_id" : 571676452,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/560508663",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r560509157"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/560509157"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "taken!",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-19T21:30:35Z",
      "diff_hunk" : "@@ -194,12 +194,22 @@ void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune);\n /** Prune block files up to a given height */\n void PruneBlockFilesManual(int nManualPruneHeight);\n \n-/** (try to) add transaction to memory pool\n- * plTxnReplaced will be appended to with all transactions replaced from mempool\n- * @param[out] fee_out optional argument to return tx fee to the caller **/\n-bool AcceptToMemoryPool(CTxMemPool& pool, TxValidationState &state, const CTransactionRef &tx,\n-                        std::list<CTransactionRef>* plTxnReplaced,\n-                        bool bypass_limits, bool test_accept=false, CAmount* fee_out=nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+/** Per-transaction result from trying to accept a transaction to the memory pool. */\n+struct MempoolAcceptResult {\n+    MempoolAcceptResult(const CTransactionRef& ptx) : txid(ptx->GetHash()) {}\n+\n+    uint256 txid;\n+    bool m_accepted = false;\n+    TxValidationState m_state;\n+    std::list<CTransactionRef> m_replaced_transactions{};\n+    CAmount m_fee = CAmount(0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r560509157",
      "id" : 560509157,
      "in_reply_to_id" : 557163163,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDUwOTE1Nw==",
      "original_commit_id" : "c97fae1011c4bd376898af73576756f163eeaf58",
      "original_line" : 205,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 571677074,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/560509157",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r560509955"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/560509955"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Moved it to the relevant commit. Putting a `CTransactionRef` in the `MempoolAcceptResult` when returning failure so that we know which tx failed; we need it to get the txid and wtxid in `testmempoolaccept`.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-19T21:32:05Z",
      "diff_hunk" : "@@ -194,12 +194,22 @@ void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune);\n /** Prune block files up to a given height */\n void PruneBlockFilesManual(int nManualPruneHeight);\n \n-/** (try to) add transaction to memory pool\n- * plTxnReplaced will be appended to with all transactions replaced from mempool\n- * @param[out] fee_out optional argument to return tx fee to the caller **/\n-bool AcceptToMemoryPool(CTxMemPool& pool, TxValidationState &state, const CTransactionRef &tx,\n-                        std::list<CTransactionRef>* plTxnReplaced,\n-                        bool bypass_limits, bool test_accept=false, CAmount* fee_out=nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+/** Per-transaction result from trying to accept a transaction to the memory pool. */\n+struct MempoolAcceptResult {\n+    MempoolAcceptResult(const CTransactionRef& ptx) : txid(ptx->GetHash()) {}\n+\n+    uint256 txid;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r560509955",
      "id" : 560509955,
      "in_reply_to_id" : 557161651,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDUwOTk1NQ==",
      "original_commit_id" : "c97fae1011c4bd376898af73576756f163eeaf58",
      "original_line" : 201,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 571678081,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/560509955",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased, split up the refactoring commit (hopefully now very digestible chunks), and took some of the review suggestions so far. Thanks a ton for your reviews @jnewbery @MarcoFalke @sdaftuar @mjdietzx @darosior @ariard ð¤ hope you take a look again!\r\n\r\n@ariard Re: timelocks, off-chain covenants, etc. yep this obviously has some limitations and I wouldn't consider this a perfect tester for L2 transactions. If we could come up with some test vectors where, for example, the option to ignore timelocks in dry-runs would be extremely useful, I think we could consider it. Regardless, I think a basic package accept like this moves in that direction :)",
      "created_at" : "2021-01-19T21:59:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#issuecomment-763168517",
      "id" : 763168517,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20833",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2MzE2ODUxNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-19T21:59:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/763168517",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r562041253"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/562041253"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Unless I am mistaken, incorrectly reading this will result in an uninitialized read, which is only detected by valgrind. Wouldn't it be better to make this safe for non-valgrind use via an std::optional at least. Or is that also a bit too verbose (like the std::variant approach)?",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-21T16:56:51Z",
      "diff_hunk" : "@@ -187,12 +187,34 @@ void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune);\n /** Prune block files up to a given height */\n void PruneBlockFilesManual(int nManualPruneHeight);\n \n-/** (try to) add transaction to memory pool\n- * plTxnReplaced will be appended to with all transactions replaced from mempool\n- * @param[out] fee_out optional argument to return tx fee to the caller **/\n-bool AcceptToMemoryPool(CTxMemPool& pool, TxValidationState &state, const CTransactionRef &tx,\n-                        std::list<CTransactionRef>* plTxnReplaced,\n-                        bool bypass_limits, bool test_accept=false, CAmount* fee_out=nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+/**\n+* Validation result for a single transaction mempool acceptance.\n+* When m_accepted = true, m_replaced_transactions contains a list\n+* of replaced transactions and m_base_fees contains the tx fees.\n+*/\n+struct MempoolAcceptResult {\n+    bool m_accepted;\n+    TxValidationState m_state;\n+\n+    // Valid when m_accepted = true\n+    std::list<CTransactionRef> m_replaced_transactions;\n+    CAmount m_base_fees;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r562041253",
      "id" : 562041253,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjA0MTI1Mw==",
      "original_commit_id" : "c75f7052921bc15c39d4b4272ef2c18550a51a0d",
      "original_line" : 204,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 573537979,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/562041253",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@glozow @darosior I think we need distinctions to understand better what this package-`testmempoolaccept` is achieving for transaction chains. I agree that it lets L2 application devs manually test the mempool validity of a _static_ chain of transactions, and that way avoid to deploy a completely broken stack in production. Just note the caveat, `fRequireStandard` is false for testnet, so be careful to do dry-run in regtest.\r\n\r\nBut beyond, L2s may have _dynamic_ chain of transactions, i.e transactions function of counterparty contributions (e.g LN `update_add_htlc`) or behaviors (e.g a remote commitment broadcast). Asserting mempool validity of this type of chain is irrelevant as soon as you start to be in production, a malicious counterparty might hit a standard bound you forgot or weren't able to test during dry-runs. As a L2 dev what you're aiming for is a _txstandardness verifier_, a tool encapsulating ATMP checks. Maybe with some configurable options like `fRelaxTimelocks` or `fBypassFees` to morph the checks to your protocol flow.\r\n\r\nMy final point, we should be careful to scope this new `testmempoolaccept` to the first usage in the release notes. Just to avoid someone hoping to achieve the second usage after this change and potentially breaking stuff on dumb-or-edge cases :)\r\n\r\nI'll be back to code review soon.",
      "created_at" : "2021-01-22T01:45:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#issuecomment-765057102",
      "id" : 765057102,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20833",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2NTA1NzEwMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-22T01:45:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/765057102",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r562779844"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/562779844"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah good point, let me whip up the `std::optional` method real quick and get back to you on the verbosity",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-22T17:14:23Z",
      "diff_hunk" : "@@ -187,12 +187,34 @@ void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune);\n /** Prune block files up to a given height */\n void PruneBlockFilesManual(int nManualPruneHeight);\n \n-/** (try to) add transaction to memory pool\n- * plTxnReplaced will be appended to with all transactions replaced from mempool\n- * @param[out] fee_out optional argument to return tx fee to the caller **/\n-bool AcceptToMemoryPool(CTxMemPool& pool, TxValidationState &state, const CTransactionRef &tx,\n-                        std::list<CTransactionRef>* plTxnReplaced,\n-                        bool bypass_limits, bool test_accept=false, CAmount* fee_out=nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+/**\n+* Validation result for a single transaction mempool acceptance.\n+* When m_accepted = true, m_replaced_transactions contains a list\n+* of replaced transactions and m_base_fees contains the tx fees.\n+*/\n+struct MempoolAcceptResult {\n+    bool m_accepted;\n+    TxValidationState m_state;\n+\n+    // Valid when m_accepted = true\n+    std::list<CTransactionRef> m_replaced_transactions;\n+    CAmount m_base_fees;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r562779844",
      "id" : 562779844,
      "in_reply_to_id" : 562041253,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mjc3OTg0NA==",
      "original_commit_id" : "c75f7052921bc15c39d4b4272ef2c18550a51a0d",
      "original_line" : 204,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 574456709,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/562779844",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@ariard\r\n> Just note the caveat, `fRequireStandard` is false for testnet, so be careful to do dry-run in regtest.\r\n\r\nI think `fRequireStandard` is [true for regtest](https://github.com/bitcoin/bitcoin/blob/32b191fb66e644c690c94cbfdae6ddbc754769d7/src/chainparams.cpp#L424) and [false for testnet](https://github.com/bitcoin/bitcoin/blob/32b191fb66e644c690c94cbfdae6ddbc754769d7/src/chainparams.cpp#L243).\r\n\r\n> My final point, we should be careful to scope this new `testmempoolaccept` to the first usage in the release notes. Just to avoid someone hoping to achieve the second usage after this change and potentially breaking stuff on dumb-or-edge cases :)\r\n\r\nI certainly hope it didn't seem like I was over-promising what this enables, agree about clearly defining the (limited) scope. I'll be sure to tag you for release notes review :)",
      "created_at" : "2021-01-22T17:26:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#issuecomment-765569041",
      "id" : 765569041,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20833",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2NTU2OTA0MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-22T17:26:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/765569041",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r563150542"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563150542"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Would it be useful to add a short check here that `testmempoolaccept` fails if the transactions aren't sorted? For example:\r\n\r\n```\r\n        self.log.info(\"Test package with unsorted transactions isn't accepted\")\r\n        unsorted_chain = [chain[0], chain[2], chain[1]]\r\n        orphaned = CTransaction()\r\n        orphaned.deserialize(BytesIO(hex_str_to_bytes(unsorted_chain[1])))\r\n        testres_bad = node.testmempoolaccept(rawtxs=unsorted_chain)\r\n        assert_equal(testres_bad, [{\"txid\": orphaned.rehash(), \"wtxid\": orphaned.getwtxid(), \"allowed\": False, \"reject-reason\": \"missing-inputs\"}])\r\n```",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-23T13:04:29Z",
      "diff_hunk" : "@@ -0,0 +1,186 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"RPCs that handle raw transaction packages.\"\"\"\n+\n+from decimal import Decimal\n+from io import BytesIO\n+\n+from test_framework.address import ADDRESS_BCRT1_P2WSH_OP_TRUE\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    BIP125_SEQUENCE_NUMBER,\n+    COIN,\n+    CTransaction,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+    hex_str_to_bytes,\n+)\n+\n+class RPCPackagesTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+        self.setup_clean_chain = True\n+\n+    def run_test(self):\n+        self.log.info(\"Generate blocks to create UTXOs\")\n+        node = self.nodes[0]\n+        self.privkeys = [node.get_deterministic_priv_key().key]\n+        self.address = node.get_deterministic_priv_key().address\n+        self.coins = []\n+        # The last 100 coinbase transactions are premature\n+        for b in node.generatetoaddress(120, self.address)[:20]:\n+            coinbase = node.getblock(blockhash=b, verbosity=2)[\"tx\"][0]\n+            self.coins.append({\n+                \"txid\": coinbase[\"txid\"],\n+                \"amount\": coinbase[\"vout\"][0][\"value\"],\n+                \"scriptPubKey\": coinbase[\"vout\"][0][\"scriptPubKey\"],\n+            })\n+\n+        # Create some transactions that can be reused throughout the test. Never submit these to mempool.\n+        self.independent_txns_hex = []\n+        self.independent_txns_testres = []\n+        for _ in range(3):\n+            coin = self.coins.pop()\n+            rawtx = node.createrawtransaction([{\"txid\" : coin[\"txid\"], \"vout\" : 0}],\n+                {self.address : coin[\"amount\"] - Decimal(\"0.0001\")})\n+            signedtx = node.signrawtransactionwithkey(hexstring=rawtx, privkeys=self.privkeys)\n+            assert signedtx[\"complete\"]\n+            testres = node.testmempoolaccept([signedtx[\"hex\"]])\n+            assert testres[0][\"allowed\"]\n+            self.independent_txns_hex.append(signedtx[\"hex\"])\n+            # testmempoolaccept returns a list of length one, avoid creating a 2D list\n+            self.independent_txns_testres.append(testres[0])\n+\n+        self.test_independent()\n+        self.test_chain()\n+        self.test_conflicting()\n+        self.test_rbf()\n+\n+    def chain_transaction(self, parent_txid, value, parent_scriptPubKey=None):\n+        \"\"\"Build a transaction that spends parent_txid:vout. Return tuple (transaction id, raw hex).\"\"\"\n+        node = self.nodes[0]\n+        inputs = [{\"txid\" : parent_txid, \"vout\" : 0}]\n+        outputs = {self.address : value}\n+        rawtx = node.createrawtransaction(inputs, outputs)\n+        prevtxs = [{\n+            \"txid\": parent_txid,\n+            \"vout\": 0,\n+            \"scriptPubKey\": parent_scriptPubKey,\n+            \"amount\": value + Decimal(\"0.0001\"),\n+        }] if parent_scriptPubKey else None\n+        signedtx = node.signrawtransactionwithkey(hexstring=rawtx, privkeys=self.privkeys, prevtxs=prevtxs)\n+        tx = CTransaction()\n+        assert signedtx[\"complete\"]\n+        tx.deserialize(BytesIO(hex_str_to_bytes(signedtx[\"hex\"])))\n+        return (tx.rehash(), signedtx[\"hex\"], tx.vout[0].scriptPubKey.hex())\n+\n+    def test_independent(self):\n+        self.log.info(\"Test multiple independent transactions in a package\")\n+        node = self.nodes[0]\n+        assert_equal(self.independent_txns_testres, node.testmempoolaccept(rawtxs=self.independent_txns_hex))\n+\n+        self.log.info(\"Test a valid package with garbage inserted\")\n+        garbage_tx = node.createrawtransaction([{\"txid\": \"00\" * 32, \"vout\": 5}], {self.address: 1})\n+        tx = CTransaction()\n+        tx.deserialize(BytesIO(hex_str_to_bytes(garbage_tx)))\n+        testres_bad = node.testmempoolaccept(self.independent_txns_hex + [garbage_tx])\n+        assert_equal(testres_bad, [{\"txid\": tx.rehash(), \"wtxid\": tx.getwtxid(), \"allowed\": False, \"reject-reason\": \"missing-inputs\"}])\n+\n+    def test_chain(self):\n+        node = self.nodes[0]\n+        first_coin = self.coins.pop()\n+\n+        self.log.info(\"Create a chain of three transactions\")\n+        scriptPubKey = None\n+        txid = first_coin[\"txid\"]\n+        chain = []\n+        value = first_coin[\"amount\"]\n+\n+        for _ in range(3):\n+            value -= Decimal(\"0.0001\") # Deduct reasonable fee\n+            (txid, txhex, scriptPubKey) = self.chain_transaction(txid, value, scriptPubKey)\n+            chain.append(txhex)\n+\n+        self.log.info(\"Testmempoolaccept with entire package\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r563150542",
      "id" : 563150542,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzE1MDU0Mg==",
      "original_commit_id" : "ebca80d81124fac369e18467e17a1bacfdbfefec",
      "original_line" : 155,
      "original_position" : 107,
      "original_start_line" : null,
      "path" : "test/functional/rpc_packages.py",
      "position" : null,
      "pull_request_review_id" : 574845534,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563150542",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4276679?v=4",
         "events_url" : "https://api.github.com/users/robot-dreams/events{/privacy}",
         "followers_url" : "https://api.github.com/users/robot-dreams/followers",
         "following_url" : "https://api.github.com/users/robot-dreams/following{/other_user}",
         "gists_url" : "https://api.github.com/users/robot-dreams/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/robot-dreams",
         "id" : 4276679,
         "login" : "robot-dreams",
         "node_id" : "MDQ6VXNlcjQyNzY2Nzk=",
         "organizations_url" : "https://api.github.com/users/robot-dreams/orgs",
         "received_events_url" : "https://api.github.com/users/robot-dreams/received_events",
         "repos_url" : "https://api.github.com/users/robot-dreams/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/robot-dreams/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/robot-dreams/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/robot-dreams"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r563151242"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563151242"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Nit: Is it worth explicitly mentioning that on failure, the one entry in the result array corresponds to the first transaction in the package that failed validation?",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-23T13:11:27Z",
      "diff_hunk" : "@@ -889,7 +888,7 @@ static RPCHelpMan testmempoolaccept()\n                 },\n                 RPCResult{\n                     RPCResult::Type::ARR, \"\", \"The result of the mempool acceptance test for each raw transaction in the input array.\\n\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r563151242",
      "id" : 563151242,
      "line" : 898,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzE1MTI0Mg==",
      "original_commit_id" : "ebca80d81124fac369e18467e17a1bacfdbfefec",
      "original_line" : 898,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : 22,
      "pull_request_review_id" : 574845534,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563151242",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4276679?v=4",
         "events_url" : "https://api.github.com/users/robot-dreams/events{/privacy}",
         "followers_url" : "https://api.github.com/users/robot-dreams/followers",
         "following_url" : "https://api.github.com/users/robot-dreams/following{/other_user}",
         "gists_url" : "https://api.github.com/users/robot-dreams/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/robot-dreams",
         "id" : 4276679,
         "login" : "robot-dreams",
         "node_id" : "MDQ6VXNlcjQyNzY2Nzk=",
         "organizations_url" : "https://api.github.com/users/robot-dreams/orgs",
         "received_events_url" : "https://api.github.com/users/robot-dreams/received_events",
         "repos_url" : "https://api.github.com/users/robot-dreams/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/robot-dreams/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/robot-dreams/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/robot-dreams"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r563152582"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563152582"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Style nit (feel free to ignore):\r\n\r\nRather than extending `CCoinsViewMemPool`, would it make sense to instead add something like `CCoinsViewPackage : CCoinsViewBacked`? Doing so might have the following advantages:\r\n\r\n* The backing `CCoinsView` doesn't have to be a `CCoinsViewMemPool` (e.g. what if you want to submit a package to a block-relay-only node in the future)\r\n* It separates the concerns of tracking mempool coins and having scratch space\r\n* It makes it more obvious that each time you validate a package, you need a separate instance of `CCoinsViewPackage` (and that you shouldn't reuse an existing `CCoinsViewMemPool`)",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-23T13:26:29Z",
      "diff_hunk" : "@@ -880,15 +880,28 @@ class CTxMemPool\n  * It also allows you to sign a double-spend directly in\n  * signrawtransactionwithkey and signrawtransactionwithwallet,\n  * as long as the conflicting transaction is not yet confirmed.\n+ * It can also serve as temporary scratch space for some set",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r563152582",
      "id" : 563152582,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzE1MjU4Mg==",
      "original_commit_id" : "ebca80d81124fac369e18467e17a1bacfdbfefec",
      "original_line" : 891,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : null,
      "pull_request_review_id" : 574845534,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563152582",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4276679?v=4",
         "events_url" : "https://api.github.com/users/robot-dreams/events{/privacy}",
         "followers_url" : "https://api.github.com/users/robot-dreams/followers",
         "following_url" : "https://api.github.com/users/robot-dreams/following{/other_user}",
         "gists_url" : "https://api.github.com/users/robot-dreams/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/robot-dreams",
         "id" : 4276679,
         "login" : "robot-dreams",
         "node_id" : "MDQ6VXNlcjQyNzY2Nzk=",
         "organizations_url" : "https://api.github.com/users/robot-dreams/orgs",
         "received_events_url" : "https://api.github.com/users/robot-dreams/received_events",
         "repos_url" : "https://api.github.com/users/robot-dreams/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/robot-dreams/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/robot-dreams/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/robot-dreams"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r563155678"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563155678"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Nit: Is it worth saying \"with the **first** failure\"?",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-23T13:57:18Z",
      "diff_hunk" : "@@ -187,12 +187,48 @@ void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune);\n /** Prune block files up to a given height */\n void PruneBlockFilesManual(int nManualPruneHeight);\n \n-/** (try to) add transaction to memory pool\n- * plTxnReplaced will be appended to with all transactions replaced from mempool\n- * @param[out] fee_out optional argument to return tx fee to the caller **/\n-bool AcceptToMemoryPool(CTxMemPool& pool, TxValidationState &state, const CTransactionRef &tx,\n-                        std::list<CTransactionRef>* plTxnReplaced,\n-                        bool bypass_limits, bool test_accept=false, CAmount* fee_out=nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+/**\n+* Validation result for a single transaction mempool acceptance.\n+* When m_accepted = true, m_replaced_transactions contains a list\n+* of replaced transactions and m_base_fees contains the tx fees.\n+*/\n+struct MempoolAcceptResult {\n+    bool m_accepted;\n+    CTransactionRef ptx;\n+\n+    // Valid when m_accepted = false\n+    TxValidationState m_state;\n+\n+    // Valid when m_accepted = true\n+    std::list<CTransactionRef> m_replaced_transactions;\n+    CAmount m_base_fees;\n+\n+    explicit MempoolAcceptResult(const CTransactionRef& tx, const TxValidationState& state) : ptx(tx), m_state(state) {\n+        m_accepted = false;\n+    }\n+\n+    /** Constructor for success case */\n+    explicit MempoolAcceptResult(std::list<CTransactionRef>&& replaced_txns, CAmount fees) :\n+        m_replaced_transactions(std::move(replaced_txns)), m_base_fees(fees) {\n+        m_accepted = true;\n+    }\n+};\n+\n+/**\n+ * (Try to) add a transaction to the memory pool.\n+ */\n+MempoolAcceptResult AcceptToMemoryPool(CTxMemPool& pool, const CTransactionRef &tx,\n+                        bool bypass_limits, bool test_accept=false) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+\n+/**\n+* Atomically test acceptance of multiple transactions.\n+* If validation fails for any individual transaction, this returns\n+* a single MempoolAcceptResult with the failure. If all successful,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r563155678",
      "id" : 563155678,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzE1NTY3OA==",
      "original_commit_id" : "ebca80d81124fac369e18467e17a1bacfdbfefec",
      "original_line" : 226,
      "original_position" : 62,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 574845534,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563155678",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4276679?v=4",
         "events_url" : "https://api.github.com/users/robot-dreams/events{/privacy}",
         "followers_url" : "https://api.github.com/users/robot-dreams/followers",
         "following_url" : "https://api.github.com/users/robot-dreams/following{/other_user}",
         "gists_url" : "https://api.github.com/users/robot-dreams/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/robot-dreams",
         "id" : 4276679,
         "login" : "robot-dreams",
         "node_id" : "MDQ6VXNlcjQyNzY2Nzk=",
         "organizations_url" : "https://api.github.com/users/robot-dreams/orgs",
         "received_events_url" : "https://api.github.com/users/robot-dreams/received_events",
         "repos_url" : "https://api.github.com/users/robot-dreams/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/robot-dreams/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/robot-dreams/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/robot-dreams"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r563156391"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563156391"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Nit: Is `state` still needed here?",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-23T14:04:12Z",
      "diff_hunk" : "@@ -5011,10 +5071,10 @@ bool LoadMempool(CTxMemPool& pool)\n             TxValidationState state;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r563156391",
      "id" : 563156391,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzE1NjM5MQ==",
      "original_commit_id" : "ebca80d81124fac369e18467e17a1bacfdbfefec",
      "original_line" : 5071,
      "original_position" : 371,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 574845534,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563156391",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4276679?v=4",
         "events_url" : "https://api.github.com/users/robot-dreams/events{/privacy}",
         "followers_url" : "https://api.github.com/users/robot-dreams/followers",
         "following_url" : "https://api.github.com/users/robot-dreams/following{/other_user}",
         "gists_url" : "https://api.github.com/users/robot-dreams/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/robot-dreams",
         "id" : 4276679,
         "login" : "robot-dreams",
         "node_id" : "MDQ6VXNlcjQyNzY2Nzk=",
         "organizations_url" : "https://api.github.com/users/robot-dreams/orgs",
         "received_events_url" : "https://api.github.com/users/robot-dreams/received_events",
         "repos_url" : "https://api.github.com/users/robot-dreams/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/robot-dreams/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/robot-dreams/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/robot-dreams"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r563157572"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563157572"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Is it worth keeping some flavor of the \"Make sure the tx has at least one input.\" message that was removed above?",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-23T14:15:43Z",
      "diff_hunk" : "@@ -922,67 +921,77 @@ static RPCHelpMan testmempoolaccept()\n         UniValueType(), // VNUM or VSTR, checked inside AmountFromValue()\n     });\n \n-    if (request.params[0].get_array().size() != 1) {\n-        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Array must contain exactly one raw transaction for now\");\n-    }\n-\n-    CMutableTransaction mtx;\n-    if (!DecodeHexTx(mtx, request.params[0].get_array()[0].get_str())) {\n-        throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed. Make sure the tx has at least one input.\");\n-    }\n-    CTransactionRef tx(MakeTransactionRef(std::move(mtx)));\n-\n+    const UniValue raw_transactions = request.params[0].get_array();\n     const CFeeRate max_raw_tx_fee_rate = request.params[1].isNull() ?\n                                              DEFAULT_MAX_RAW_TX_FEE_RATE :\n                                              CFeeRate(AmountFromValue(request.params[1]));\n \n     CTxMemPool& mempool = EnsureMemPool(request.context);\n-    int64_t virtual_size = GetVirtualTransactionSize(*tx);\n-    CAmount max_raw_tx_fee = max_raw_tx_fee_rate.GetFee(virtual_size);\n-\n-    UniValue result(UniValue::VARR);\n-    UniValue result_0(UniValue::VOBJ);\n-    result_0.pushKV(\"txid\", tx->GetHash().GetHex());\n-    result_0.pushKV(\"wtxid\", tx->GetWitnessHash().GetHex());\n+    std::vector<CTransactionRef> txns;\n \n-    TxValidationState state;\n-    bool test_accept_res;\n-    CAmount fee{0};\n-    {\n-        LOCK(cs_main);\n-        test_accept_res = AcceptToMemoryPool(mempool, state, std::move(tx),\n-            nullptr /* plTxnReplaced */, false /* bypass_limits */, /* test_accept */ true, &fee);\n+    for (unsigned int i = 0; i < raw_transactions.size(); ++i) {\n+        CMutableTransaction mtx;\n+        if (!DecodeHexTx(mtx, raw_transactions[i].get_str())) {\n+            throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r563157572",
      "id" : 563157572,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzE1NzU3Mg==",
      "original_commit_id" : "ebca80d81124fac369e18467e17a1bacfdbfefec",
      "original_line" : 939,
      "original_position" : 58,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : null,
      "pull_request_review_id" : 574845534,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563157572",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4276679?v=4",
         "events_url" : "https://api.github.com/users/robot-dreams/events{/privacy}",
         "followers_url" : "https://api.github.com/users/robot-dreams/followers",
         "following_url" : "https://api.github.com/users/robot-dreams/following{/other_user}",
         "gists_url" : "https://api.github.com/users/robot-dreams/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/robot-dreams",
         "id" : 4276679,
         "login" : "robot-dreams",
         "node_id" : "MDQ6VXNlcjQyNzY2Nzk=",
         "organizations_url" : "https://api.github.com/users/robot-dreams/orgs",
         "received_events_url" : "https://api.github.com/users/robot-dreams/received_events",
         "repos_url" : "https://api.github.com/users/robot-dreams/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/robot-dreams/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/robot-dreams/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/robot-dreams"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r563160249"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563160249"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Just confirming, does the requirement \"either return all successes or just the first failure\" apply to the RPC as a whole, or only to the internal call `ProcessNewPackage`?\r\n\r\nI ask because it looks like you could add rejected transactions inside this loop. For example, if I update `test_chain` in `rpc_packages.py` so that the 2nd transaction in the chain has an unreasonable fee, the RPC response `testres_multiple` is as follows:\r\n\r\n```\r\n[\r\n{'txid': ..., 'wtxid': ..., 'allowed': True, 'vsize': 191, 'fees': {'base': Decimal('0.00010000')}},\r\n{'txid': ..., 'wtxid': ..., 'allowed': False, 'reject-reason': 'max-fee-exceeded'},\r\n{'txid': ..., 'wtxid': ..., 'allowed': True, 'vsize': 191, 'fees': {'base': Decimal('0.00010000')}}\r\n]\r\n```",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-23T14:40:23Z",
      "diff_hunk" : "@@ -922,67 +921,77 @@ static RPCHelpMan testmempoolaccept()\n         UniValueType(), // VNUM or VSTR, checked inside AmountFromValue()\n     });\n \n-    if (request.params[0].get_array().size() != 1) {\n-        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Array must contain exactly one raw transaction for now\");\n-    }\n-\n-    CMutableTransaction mtx;\n-    if (!DecodeHexTx(mtx, request.params[0].get_array()[0].get_str())) {\n-        throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed. Make sure the tx has at least one input.\");\n-    }\n-    CTransactionRef tx(MakeTransactionRef(std::move(mtx)));\n-\n+    const UniValue raw_transactions = request.params[0].get_array();\n     const CFeeRate max_raw_tx_fee_rate = request.params[1].isNull() ?\n                                              DEFAULT_MAX_RAW_TX_FEE_RATE :\n                                              CFeeRate(AmountFromValue(request.params[1]));\n \n     CTxMemPool& mempool = EnsureMemPool(request.context);\n-    int64_t virtual_size = GetVirtualTransactionSize(*tx);\n-    CAmount max_raw_tx_fee = max_raw_tx_fee_rate.GetFee(virtual_size);\n-\n-    UniValue result(UniValue::VARR);\n-    UniValue result_0(UniValue::VOBJ);\n-    result_0.pushKV(\"txid\", tx->GetHash().GetHex());\n-    result_0.pushKV(\"wtxid\", tx->GetWitnessHash().GetHex());\n+    std::vector<CTransactionRef> txns;\n \n-    TxValidationState state;\n-    bool test_accept_res;\n-    CAmount fee{0};\n-    {\n-        LOCK(cs_main);\n-        test_accept_res = AcceptToMemoryPool(mempool, state, std::move(tx),\n-            nullptr /* plTxnReplaced */, false /* bypass_limits */, /* test_accept */ true, &fee);\n+    for (unsigned int i = 0; i < raw_transactions.size(); ++i) {\n+        CMutableTransaction mtx;\n+        if (!DecodeHexTx(mtx, raw_transactions[i].get_str())) {\n+            throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed\");\n+        }\n+        txns.emplace_back(MakeTransactionRef(std::move(mtx)));\n     }\n \n-    // Check that fee does not exceed maximum fee\n-    if (test_accept_res && max_raw_tx_fee && fee > max_raw_tx_fee) {\n-        result_0.pushKV(\"allowed\", false);\n-        result_0.pushKV(\"reject-reason\", \"max-fee-exceeded\");\n-        result.push_back(std::move(result_0));\n-        return result;\n+    std::vector<MempoolAcceptResult> validation_results;\n+    if (txns.size() == 1) {\n+        validation_results.emplace_back(WITH_LOCK(cs_main,\n+            return AcceptToMemoryPool(mempool, txns[0], false /* bypass_limits */, true /* test_accept */)));\n+    } else {\n+        validation_results = WITH_LOCK(cs_main, return ProcessNewPackage(mempool, txns, true));\n     }\n-    result_0.pushKV(\"allowed\", test_accept_res);\n \n-    // Only return the fee and vsize if the transaction would pass ATMP.\n-    // These can be used to calculate the feerate.\n-    if (test_accept_res) {\n-        result_0.pushKV(\"vsize\", virtual_size);\n-        UniValue fees(UniValue::VOBJ);\n-        fees.pushKV(\"base\", ValueFromAmount(fee));\n-        result_0.pushKV(\"fees\", fees);\n-    } else {\n-        if (state.IsInvalid()) {\n-            if (state.GetResult() == TxValidationResult::TX_MISSING_INPUTS) {\n-                result_0.pushKV(\"reject-reason\", \"missing-inputs\");\n+    auto tx_accepted = [](MempoolAcceptResult& res) { return res.m_accepted; };\n+    const bool all_valid = std::all_of(validation_results.begin(), validation_results.end(), tx_accepted);\n+    // ProcessNewPackage should return a MempoolAcceptResult per transaction\n+    // or exactly 1 for the first error that occurs.\n+    CHECK_NONFATAL(all_valid || validation_results.size() == 1);\n+\n+    // TODO: Report absurd fees for packages.\n+\n+    UniValue result(UniValue::VARR);\n+    if (all_valid) {\n+        for (unsigned int i = 0; i < validation_results.size(); ++i) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r563160249",
      "id" : 563160249,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzE2MDI0OQ==",
      "original_commit_id" : "ebca80d81124fac369e18467e17a1bacfdbfefec",
      "original_line" : 961,
      "original_position" : 99,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : null,
      "pull_request_review_id" : 574845534,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563160249",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4276679?v=4",
         "events_url" : "https://api.github.com/users/robot-dreams/events{/privacy}",
         "followers_url" : "https://api.github.com/users/robot-dreams/followers",
         "following_url" : "https://api.github.com/users/robot-dreams/following{/other_user}",
         "gists_url" : "https://api.github.com/users/robot-dreams/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/robot-dreams",
         "id" : 4276679,
         "login" : "robot-dreams",
         "node_id" : "MDQ6VXNlcjQyNzY2Nzk=",
         "organizations_url" : "https://api.github.com/users/robot-dreams/orgs",
         "received_events_url" : "https://api.github.com/users/robot-dreams/received_events",
         "repos_url" : "https://api.github.com/users/robot-dreams/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/robot-dreams/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/robot-dreams/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/robot-dreams"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r563815372"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563815372"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Please see [this branch](https://github.com/glozow/bitcoin/commit/408a32b5c70a6c2d657304ae0a874dadb635f4fa), it's not too bad verbosity-wise, I have a couple ternary operators like this:\r\n\r\n```c\r\nconst TxValidationState state = result.m_state == nullopt ? TxValidationState{} : result.m_state.value();\r\n```\r\n\r\nincorrect read throws a `bad optional access`",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-25T15:32:37Z",
      "diff_hunk" : "@@ -187,12 +187,34 @@ void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune);\n /** Prune block files up to a given height */\n void PruneBlockFilesManual(int nManualPruneHeight);\n \n-/** (try to) add transaction to memory pool\n- * plTxnReplaced will be appended to with all transactions replaced from mempool\n- * @param[out] fee_out optional argument to return tx fee to the caller **/\n-bool AcceptToMemoryPool(CTxMemPool& pool, TxValidationState &state, const CTransactionRef &tx,\n-                        std::list<CTransactionRef>* plTxnReplaced,\n-                        bool bypass_limits, bool test_accept=false, CAmount* fee_out=nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+/**\n+* Validation result for a single transaction mempool acceptance.\n+* When m_accepted = true, m_replaced_transactions contains a list\n+* of replaced transactions and m_base_fees contains the tx fees.\n+*/\n+struct MempoolAcceptResult {\n+    bool m_accepted;\n+    TxValidationState m_state;\n+\n+    // Valid when m_accepted = true\n+    std::list<CTransactionRef> m_replaced_transactions;\n+    CAmount m_base_fees;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r563815372",
      "id" : 563815372,
      "in_reply_to_id" : 562041253,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzgxNTM3Mg==",
      "original_commit_id" : "c75f7052921bc15c39d4b4272ef2c18550a51a0d",
      "original_line" : 204,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 575515777,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563815372",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r563815889"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563815889"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "good point! will add that test",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-25T15:33:20Z",
      "diff_hunk" : "@@ -0,0 +1,186 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"RPCs that handle raw transaction packages.\"\"\"\n+\n+from decimal import Decimal\n+from io import BytesIO\n+\n+from test_framework.address import ADDRESS_BCRT1_P2WSH_OP_TRUE\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    BIP125_SEQUENCE_NUMBER,\n+    COIN,\n+    CTransaction,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+    hex_str_to_bytes,\n+)\n+\n+class RPCPackagesTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+        self.setup_clean_chain = True\n+\n+    def run_test(self):\n+        self.log.info(\"Generate blocks to create UTXOs\")\n+        node = self.nodes[0]\n+        self.privkeys = [node.get_deterministic_priv_key().key]\n+        self.address = node.get_deterministic_priv_key().address\n+        self.coins = []\n+        # The last 100 coinbase transactions are premature\n+        for b in node.generatetoaddress(120, self.address)[:20]:\n+            coinbase = node.getblock(blockhash=b, verbosity=2)[\"tx\"][0]\n+            self.coins.append({\n+                \"txid\": coinbase[\"txid\"],\n+                \"amount\": coinbase[\"vout\"][0][\"value\"],\n+                \"scriptPubKey\": coinbase[\"vout\"][0][\"scriptPubKey\"],\n+            })\n+\n+        # Create some transactions that can be reused throughout the test. Never submit these to mempool.\n+        self.independent_txns_hex = []\n+        self.independent_txns_testres = []\n+        for _ in range(3):\n+            coin = self.coins.pop()\n+            rawtx = node.createrawtransaction([{\"txid\" : coin[\"txid\"], \"vout\" : 0}],\n+                {self.address : coin[\"amount\"] - Decimal(\"0.0001\")})\n+            signedtx = node.signrawtransactionwithkey(hexstring=rawtx, privkeys=self.privkeys)\n+            assert signedtx[\"complete\"]\n+            testres = node.testmempoolaccept([signedtx[\"hex\"]])\n+            assert testres[0][\"allowed\"]\n+            self.independent_txns_hex.append(signedtx[\"hex\"])\n+            # testmempoolaccept returns a list of length one, avoid creating a 2D list\n+            self.independent_txns_testres.append(testres[0])\n+\n+        self.test_independent()\n+        self.test_chain()\n+        self.test_conflicting()\n+        self.test_rbf()\n+\n+    def chain_transaction(self, parent_txid, value, parent_scriptPubKey=None):\n+        \"\"\"Build a transaction that spends parent_txid:vout. Return tuple (transaction id, raw hex).\"\"\"\n+        node = self.nodes[0]\n+        inputs = [{\"txid\" : parent_txid, \"vout\" : 0}]\n+        outputs = {self.address : value}\n+        rawtx = node.createrawtransaction(inputs, outputs)\n+        prevtxs = [{\n+            \"txid\": parent_txid,\n+            \"vout\": 0,\n+            \"scriptPubKey\": parent_scriptPubKey,\n+            \"amount\": value + Decimal(\"0.0001\"),\n+        }] if parent_scriptPubKey else None\n+        signedtx = node.signrawtransactionwithkey(hexstring=rawtx, privkeys=self.privkeys, prevtxs=prevtxs)\n+        tx = CTransaction()\n+        assert signedtx[\"complete\"]\n+        tx.deserialize(BytesIO(hex_str_to_bytes(signedtx[\"hex\"])))\n+        return (tx.rehash(), signedtx[\"hex\"], tx.vout[0].scriptPubKey.hex())\n+\n+    def test_independent(self):\n+        self.log.info(\"Test multiple independent transactions in a package\")\n+        node = self.nodes[0]\n+        assert_equal(self.independent_txns_testres, node.testmempoolaccept(rawtxs=self.independent_txns_hex))\n+\n+        self.log.info(\"Test a valid package with garbage inserted\")\n+        garbage_tx = node.createrawtransaction([{\"txid\": \"00\" * 32, \"vout\": 5}], {self.address: 1})\n+        tx = CTransaction()\n+        tx.deserialize(BytesIO(hex_str_to_bytes(garbage_tx)))\n+        testres_bad = node.testmempoolaccept(self.independent_txns_hex + [garbage_tx])\n+        assert_equal(testres_bad, [{\"txid\": tx.rehash(), \"wtxid\": tx.getwtxid(), \"allowed\": False, \"reject-reason\": \"missing-inputs\"}])\n+\n+    def test_chain(self):\n+        node = self.nodes[0]\n+        first_coin = self.coins.pop()\n+\n+        self.log.info(\"Create a chain of three transactions\")\n+        scriptPubKey = None\n+        txid = first_coin[\"txid\"]\n+        chain = []\n+        value = first_coin[\"amount\"]\n+\n+        for _ in range(3):\n+            value -= Decimal(\"0.0001\") # Deduct reasonable fee\n+            (txid, txhex, scriptPubKey) = self.chain_transaction(txid, value, scriptPubKey)\n+            chain.append(txhex)\n+\n+        self.log.info(\"Testmempoolaccept with entire package\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r563815889",
      "id" : 563815889,
      "in_reply_to_id" : 563150542,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzgxNTg4OQ==",
      "original_commit_id" : "ebca80d81124fac369e18467e17a1bacfdbfefec",
      "original_line" : 155,
      "original_position" : 107,
      "original_start_line" : null,
      "path" : "test/functional/rpc_packages.py",
      "position" : null,
      "pull_request_review_id" : 575516497,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563815889",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r563828396"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563828396"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Cool, thanks for looking. Not sure if the ternary makes sense. It seems `state` is currently assumed to be always properly initialized (redundantly to the boolean return value). So maybe it could make sense to not make this optional. I do like that the other members (fee and replaced txs) are optional in your branch.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-25T15:48:53Z",
      "diff_hunk" : "@@ -187,12 +187,34 @@ void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune);\n /** Prune block files up to a given height */\n void PruneBlockFilesManual(int nManualPruneHeight);\n \n-/** (try to) add transaction to memory pool\n- * plTxnReplaced will be appended to with all transactions replaced from mempool\n- * @param[out] fee_out optional argument to return tx fee to the caller **/\n-bool AcceptToMemoryPool(CTxMemPool& pool, TxValidationState &state, const CTransactionRef &tx,\n-                        std::list<CTransactionRef>* plTxnReplaced,\n-                        bool bypass_limits, bool test_accept=false, CAmount* fee_out=nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+/**\n+* Validation result for a single transaction mempool acceptance.\n+* When m_accepted = true, m_replaced_transactions contains a list\n+* of replaced transactions and m_base_fees contains the tx fees.\n+*/\n+struct MempoolAcceptResult {\n+    bool m_accepted;\n+    TxValidationState m_state;\n+\n+    // Valid when m_accepted = true\n+    std::list<CTransactionRef> m_replaced_transactions;\n+    CAmount m_base_fees;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r563828396",
      "id" : 563828396,
      "in_reply_to_id" : 562041253,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzgyODM5Ng==",
      "original_commit_id" : "c75f7052921bc15c39d4b4272ef2c18550a51a0d",
      "original_line" : 204,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 575532879,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563828396",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r563829921"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563829921"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Note that m_state.IsValid() holds when m_accpeted = *true*, so this comment could be confusing. I think the comment can just be removed.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-25T15:50:51Z",
      "diff_hunk" : "@@ -187,12 +187,48 @@ void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune);\n /** Prune block files up to a given height */\n void PruneBlockFilesManual(int nManualPruneHeight);\n \n-/** (try to) add transaction to memory pool\n- * plTxnReplaced will be appended to with all transactions replaced from mempool\n- * @param[out] fee_out optional argument to return tx fee to the caller **/\n-bool AcceptToMemoryPool(CTxMemPool& pool, TxValidationState &state, const CTransactionRef &tx,\n-                        std::list<CTransactionRef>* plTxnReplaced,\n-                        bool bypass_limits, bool test_accept=false, CAmount* fee_out=nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+/**\n+* Validation result for a single transaction mempool acceptance.\n+* When m_accepted = true, m_replaced_transactions contains a list\n+* of replaced transactions and m_base_fees contains the tx fees.\n+*/\n+struct MempoolAcceptResult {\n+    bool m_accepted;\n+    CTransactionRef ptx;\n+\n+    // Valid when m_accepted = false",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r563829921",
      "id" : 563829921,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzgyOTkyMQ==",
      "original_commit_id" : "ebca80d81124fac369e18467e17a1bacfdbfefec",
      "original_line" : 201,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 575534904,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563829921",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r563860484"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563860484"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ah yeah! That makes sense, leave state as-is, and optional members when they only make sense for valid transactions.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-25T16:29:48Z",
      "diff_hunk" : "@@ -187,12 +187,34 @@ void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune);\n /** Prune block files up to a given height */\n void PruneBlockFilesManual(int nManualPruneHeight);\n \n-/** (try to) add transaction to memory pool\n- * plTxnReplaced will be appended to with all transactions replaced from mempool\n- * @param[out] fee_out optional argument to return tx fee to the caller **/\n-bool AcceptToMemoryPool(CTxMemPool& pool, TxValidationState &state, const CTransactionRef &tx,\n-                        std::list<CTransactionRef>* plTxnReplaced,\n-                        bool bypass_limits, bool test_accept=false, CAmount* fee_out=nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+/**\n+* Validation result for a single transaction mempool acceptance.\n+* When m_accepted = true, m_replaced_transactions contains a list\n+* of replaced transactions and m_base_fees contains the tx fees.\n+*/\n+struct MempoolAcceptResult {\n+    bool m_accepted;\n+    TxValidationState m_state;\n+\n+    // Valid when m_accepted = true\n+    std::list<CTransactionRef> m_replaced_transactions;\n+    CAmount m_base_fees;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r563860484",
      "id" : 563860484,
      "in_reply_to_id" : 562041253,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mzg2MDQ4NA==",
      "original_commit_id" : "c75f7052921bc15c39d4b4272ef2c18550a51a0d",
      "original_line" : 204,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 575574819,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563860484",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r563867627"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563867627"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "it applies to the RPC as well, only 1 result on failure",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-25T16:39:03Z",
      "diff_hunk" : "@@ -922,67 +921,77 @@ static RPCHelpMan testmempoolaccept()\n         UniValueType(), // VNUM or VSTR, checked inside AmountFromValue()\n     });\n \n-    if (request.params[0].get_array().size() != 1) {\n-        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Array must contain exactly one raw transaction for now\");\n-    }\n-\n-    CMutableTransaction mtx;\n-    if (!DecodeHexTx(mtx, request.params[0].get_array()[0].get_str())) {\n-        throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed. Make sure the tx has at least one input.\");\n-    }\n-    CTransactionRef tx(MakeTransactionRef(std::move(mtx)));\n-\n+    const UniValue raw_transactions = request.params[0].get_array();\n     const CFeeRate max_raw_tx_fee_rate = request.params[1].isNull() ?\n                                              DEFAULT_MAX_RAW_TX_FEE_RATE :\n                                              CFeeRate(AmountFromValue(request.params[1]));\n \n     CTxMemPool& mempool = EnsureMemPool(request.context);\n-    int64_t virtual_size = GetVirtualTransactionSize(*tx);\n-    CAmount max_raw_tx_fee = max_raw_tx_fee_rate.GetFee(virtual_size);\n-\n-    UniValue result(UniValue::VARR);\n-    UniValue result_0(UniValue::VOBJ);\n-    result_0.pushKV(\"txid\", tx->GetHash().GetHex());\n-    result_0.pushKV(\"wtxid\", tx->GetWitnessHash().GetHex());\n+    std::vector<CTransactionRef> txns;\n \n-    TxValidationState state;\n-    bool test_accept_res;\n-    CAmount fee{0};\n-    {\n-        LOCK(cs_main);\n-        test_accept_res = AcceptToMemoryPool(mempool, state, std::move(tx),\n-            nullptr /* plTxnReplaced */, false /* bypass_limits */, /* test_accept */ true, &fee);\n+    for (unsigned int i = 0; i < raw_transactions.size(); ++i) {\n+        CMutableTransaction mtx;\n+        if (!DecodeHexTx(mtx, raw_transactions[i].get_str())) {\n+            throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed\");\n+        }\n+        txns.emplace_back(MakeTransactionRef(std::move(mtx)));\n     }\n \n-    // Check that fee does not exceed maximum fee\n-    if (test_accept_res && max_raw_tx_fee && fee > max_raw_tx_fee) {\n-        result_0.pushKV(\"allowed\", false);\n-        result_0.pushKV(\"reject-reason\", \"max-fee-exceeded\");\n-        result.push_back(std::move(result_0));\n-        return result;\n+    std::vector<MempoolAcceptResult> validation_results;\n+    if (txns.size() == 1) {\n+        validation_results.emplace_back(WITH_LOCK(cs_main,\n+            return AcceptToMemoryPool(mempool, txns[0], false /* bypass_limits */, true /* test_accept */)));\n+    } else {\n+        validation_results = WITH_LOCK(cs_main, return ProcessNewPackage(mempool, txns, true));\n     }\n-    result_0.pushKV(\"allowed\", test_accept_res);\n \n-    // Only return the fee and vsize if the transaction would pass ATMP.\n-    // These can be used to calculate the feerate.\n-    if (test_accept_res) {\n-        result_0.pushKV(\"vsize\", virtual_size);\n-        UniValue fees(UniValue::VOBJ);\n-        fees.pushKV(\"base\", ValueFromAmount(fee));\n-        result_0.pushKV(\"fees\", fees);\n-    } else {\n-        if (state.IsInvalid()) {\n-            if (state.GetResult() == TxValidationResult::TX_MISSING_INPUTS) {\n-                result_0.pushKV(\"reject-reason\", \"missing-inputs\");\n+    auto tx_accepted = [](MempoolAcceptResult& res) { return res.m_accepted; };\n+    const bool all_valid = std::all_of(validation_results.begin(), validation_results.end(), tx_accepted);\n+    // ProcessNewPackage should return a MempoolAcceptResult per transaction\n+    // or exactly 1 for the first error that occurs.\n+    CHECK_NONFATAL(all_valid || validation_results.size() == 1);\n+\n+    // TODO: Report absurd fees for packages.\n+\n+    UniValue result(UniValue::VARR);\n+    if (all_valid) {\n+        for (unsigned int i = 0; i < validation_results.size(); ++i) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r563867627",
      "id" : 563867627,
      "in_reply_to_id" : 563160249,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mzg2NzYyNw==",
      "original_commit_id" : "ebca80d81124fac369e18467e17a1bacfdbfefec",
      "original_line" : 961,
      "original_position" : 99,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : null,
      "pull_request_review_id" : 575584080,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563867627",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r564004706"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/564004706"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> Rather than extending CCoinsViewMemPool, would it make sense to instead add something like CCoinsViewPackage : CCoinsViewBacked?\r\n\r\nThis is a really interesting idea, and I think it should be the case to have the \"top level\" have the package caches -> \"bottom level\" backend is the `CCoinsViewMemPool`. Let me try to do it this way and see what happens!",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-25T19:57:56Z",
      "diff_hunk" : "@@ -880,15 +880,28 @@ class CTxMemPool\n  * It also allows you to sign a double-spend directly in\n  * signrawtransactionwithkey and signrawtransactionwithwallet,\n  * as long as the conflicting transaction is not yet confirmed.\n+ * It can also serve as temporary scratch space for some set",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r564004706",
      "id" : 564004706,
      "in_reply_to_id" : 563152582,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDAwNDcwNg==",
      "original_commit_id" : "ebca80d81124fac369e18467e17a1bacfdbfefec",
      "original_line" : 891,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : null,
      "pull_request_review_id" : 575759633,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/564004706",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r564005481"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/564005481"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Note that `CCoinsViewMemPool` is created with `MemPoolAccept` instances so we don't really reuse an existing one.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-25T19:59:13Z",
      "diff_hunk" : "@@ -880,15 +880,28 @@ class CTxMemPool\n  * It also allows you to sign a double-spend directly in\n  * signrawtransactionwithkey and signrawtransactionwithwallet,\n  * as long as the conflicting transaction is not yet confirmed.\n+ * It can also serve as temporary scratch space for some set",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r564005481",
      "id" : 564005481,
      "in_reply_to_id" : 563152582,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDAwNTQ4MQ==",
      "original_commit_id" : "ebca80d81124fac369e18467e17a1bacfdbfefec",
      "original_line" : 891,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : null,
      "pull_request_review_id" : 575760578,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/564005481",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r565391428"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565391428"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@ariard, thanks for the push to look into this. I got a pretty simple solution: we shouldn't do `m_view.SetBackend(dummy)`, we should do `m_viewmempool.SetBackend(dummy)`, since that's the backend that's actually pointing to the coins cache.\r\n\r\nThe hierarchy is `m_view -> m_viewmempool -> coinscache`.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-27T15:16:27Z",
      "diff_hunk" : "@@ -659,11 +659,6 @@ bool MemPoolAccept::PreChecks(ATMPArgs& args, MempoolAcceptResult& result, Works\n     // Bring the best block into scope\n     m_view.GetBestBlock();\n \n-    // we have all inputs cached now, so switch back to dummy (to protect\n-    // against bugs where we pull more inputs from disk that miss being added\n-    // to coins_to_uncache)\n-    m_view.SetBackend(m_dummy);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r565391428",
      "id" : 565391428,
      "in_reply_to_id" : 559286531,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTM5MTQyOA==",
      "original_commit_id" : "4a8e3e1a1767865a32905e8043b7c2e28b0cfd6a",
      "original_line" : 700,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 577444676,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565391428",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r565409230"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565409230"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "good catch, removed ð \r\n(btw, how did you comment on a non-diff line? ð± )",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-27T15:37:23Z",
      "diff_hunk" : "@@ -5011,10 +5071,10 @@ bool LoadMempool(CTxMemPool& pool)\n             TxValidationState state;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r565409230",
      "id" : 565409230,
      "in_reply_to_id" : 563156391,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQwOTIzMA==",
      "original_commit_id" : "ebca80d81124fac369e18467e17a1bacfdbfefec",
      "original_line" : 5071,
      "original_position" : 371,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 577468931,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565409230",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r565409820"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565409820"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done!",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-27T15:38:02Z",
      "diff_hunk" : "@@ -889,7 +888,7 @@ static RPCHelpMan testmempoolaccept()\n                 },\n                 RPCResult{\n                     RPCResult::Type::ARR, \"\", \"The result of the mempool acceptance test for each raw transaction in the input array.\\n\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r565409820",
      "id" : 565409820,
      "in_reply_to_id" : 563151242,
      "line" : 898,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQwOTgyMA==",
      "original_commit_id" : "ebca80d81124fac369e18467e17a1bacfdbfefec",
      "original_line" : 898,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : 22,
      "pull_request_review_id" : 577469624,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565409820",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r565414051"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565414051"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I now have the comment \"Valid when m_accepted = false\" for the tx pointer, not for  the TxValidationState",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-27T15:42:58Z",
      "diff_hunk" : "@@ -187,12 +187,48 @@ void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune);\n /** Prune block files up to a given height */\n void PruneBlockFilesManual(int nManualPruneHeight);\n \n-/** (try to) add transaction to memory pool\n- * plTxnReplaced will be appended to with all transactions replaced from mempool\n- * @param[out] fee_out optional argument to return tx fee to the caller **/\n-bool AcceptToMemoryPool(CTxMemPool& pool, TxValidationState &state, const CTransactionRef &tx,\n-                        std::list<CTransactionRef>* plTxnReplaced,\n-                        bool bypass_limits, bool test_accept=false, CAmount* fee_out=nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+/**\n+* Validation result for a single transaction mempool acceptance.\n+* When m_accepted = true, m_replaced_transactions contains a list\n+* of replaced transactions and m_base_fees contains the tx fees.\n+*/\n+struct MempoolAcceptResult {\n+    bool m_accepted;\n+    CTransactionRef ptx;\n+\n+    // Valid when m_accepted = false",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r565414051",
      "id" : 565414051,
      "in_reply_to_id" : 563829921,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQxNDA1MQ==",
      "original_commit_id" : "ebca80d81124fac369e18467e17a1bacfdbfefec",
      "original_line" : 201,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 577475332,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565414051",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r565444091"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565444091"
         }
      },
      "author_association" : "NONE",
      "body" : "I'm not very familiar with `CHECK_NONFATAL` but see it throws an error if either condition here evaluates to false. \r\n\r\nIf `validation_results.size() == 1` that means one of the transactions failed validation, so we want to throw an error. Should this line be changed to `CHECK_NONFATAL(all_valid || validation_results.size() != 1);`?",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-27T16:19:51Z",
      "diff_hunk" : "@@ -922,67 +924,77 @@ static RPCHelpMan testmempoolaccept()\n         UniValueType(), // VNUM or VSTR, checked inside AmountFromValue()\n     });\n \n-    if (request.params[0].get_array().size() != 1) {\n-        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Array must contain exactly one raw transaction for now\");\n-    }\n-\n-    CMutableTransaction mtx;\n-    if (!DecodeHexTx(mtx, request.params[0].get_array()[0].get_str())) {\n-        throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed. Make sure the tx has at least one input.\");\n-    }\n-    CTransactionRef tx(MakeTransactionRef(std::move(mtx)));\n-\n+    const UniValue raw_transactions = request.params[0].get_array();\n     const CFeeRate max_raw_tx_fee_rate = request.params[1].isNull() ?\n                                              DEFAULT_MAX_RAW_TX_FEE_RATE :\n                                              CFeeRate(AmountFromValue(request.params[1]));\n \n     CTxMemPool& mempool = EnsureMemPool(request.context);\n-    int64_t virtual_size = GetVirtualTransactionSize(*tx);\n-    CAmount max_raw_tx_fee = max_raw_tx_fee_rate.GetFee(virtual_size);\n-\n-    UniValue result(UniValue::VARR);\n-    UniValue result_0(UniValue::VOBJ);\n-    result_0.pushKV(\"txid\", tx->GetHash().GetHex());\n-    result_0.pushKV(\"wtxid\", tx->GetWitnessHash().GetHex());\n+    std::vector<CTransactionRef> txns;\n \n-    TxValidationState state;\n-    bool test_accept_res;\n-    CAmount fee{0};\n-    {\n-        LOCK(cs_main);\n-        test_accept_res = AcceptToMemoryPool(mempool, state, std::move(tx),\n-            nullptr /* plTxnReplaced */, false /* bypass_limits */, /* test_accept */ true, &fee);\n+    for (unsigned int i = 0; i < raw_transactions.size(); ++i) {\n+        CMutableTransaction mtx;\n+        if (!DecodeHexTx(mtx, raw_transactions[i].get_str())) {\n+            throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed\");\n+        }\n+        txns.emplace_back(MakeTransactionRef(std::move(mtx)));\n     }\n \n-    // Check that fee does not exceed maximum fee\n-    if (test_accept_res && max_raw_tx_fee && fee > max_raw_tx_fee) {\n-        result_0.pushKV(\"allowed\", false);\n-        result_0.pushKV(\"reject-reason\", \"max-fee-exceeded\");\n-        result.push_back(std::move(result_0));\n-        return result;\n+    std::vector<MempoolAcceptResult> validation_results;\n+    if (txns.size() == 1) {\n+        validation_results.emplace_back(WITH_LOCK(cs_main,\n+            return AcceptToMemoryPool(mempool, txns[0], false /* bypass_limits */, true /* test_accept */)));\n+    } else {\n+        validation_results = WITH_LOCK(cs_main, return ProcessNewPackage(mempool, txns, true));\n     }\n-    result_0.pushKV(\"allowed\", test_accept_res);\n \n-    // Only return the fee and vsize if the transaction would pass ATMP.\n-    // These can be used to calculate the feerate.\n-    if (test_accept_res) {\n-        result_0.pushKV(\"vsize\", virtual_size);\n-        UniValue fees(UniValue::VOBJ);\n-        fees.pushKV(\"base\", ValueFromAmount(fee));\n-        result_0.pushKV(\"fees\", fees);\n-    } else {\n-        if (state.IsInvalid()) {\n-            if (state.GetResult() == TxValidationResult::TX_MISSING_INPUTS) {\n-                result_0.pushKV(\"reject-reason\", \"missing-inputs\");\n+    auto tx_accepted = [](MempoolAcceptResult& res) { return res.m_accepted; };\n+    const bool all_valid = std::all_of(validation_results.begin(), validation_results.end(), tx_accepted);\n+    // ProcessNewPackage should return a MempoolAcceptResult per transaction\n+    // or exactly 1 for the first error that occurs.\n+    CHECK_NONFATAL(all_valid || validation_results.size() == 1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r565444091",
      "id" : 565444091,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQ0NDA5MQ==",
      "original_commit_id" : "70f84b22199cd0afffd12ea8e8934d22b0f0c7f4",
      "original_line" : 955,
      "original_position" : 94,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : null,
      "pull_request_review_id" : 577515495,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565444091",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1823216?v=4",
         "events_url" : "https://api.github.com/users/satsie/events{/privacy}",
         "followers_url" : "https://api.github.com/users/satsie/followers",
         "following_url" : "https://api.github.com/users/satsie/following{/other_user}",
         "gists_url" : "https://api.github.com/users/satsie/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/satsie",
         "id" : 1823216,
         "login" : "satsie",
         "node_id" : "MDQ6VXNlcjE4MjMyMTY=",
         "organizations_url" : "https://api.github.com/users/satsie/orgs",
         "received_events_url" : "https://api.github.com/users/satsie/received_events",
         "repos_url" : "https://api.github.com/users/satsie/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/satsie/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/satsie/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/satsie"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r565449378"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565449378"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is a change in behavior. Previously, if `fAddToMempool` is false or `(*it)->IsCoinBase()`, we'd short circuit and not call `AcceptToMemoryPool()`",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-27T16:26:32Z",
      "diff_hunk" : "@@ -378,10 +387,9 @@ static void UpdateMempoolForReorg(CTxMemPool& mempool, DisconnectedBlockTransact\n     auto it = disconnectpool.queuedTx.get<insertion_order>().rbegin();\n     while (it != disconnectpool.queuedTx.get<insertion_order>().rend()) {\n         // ignore validation errors in resurrected transactions\n-        TxValidationState stateDummy;\n-        if (!fAddToMempool || (*it)->IsCoinBase() ||\n-            !AcceptToMemoryPool(mempool, stateDummy, *it,\n-                                nullptr /* plTxnReplaced */, true /* bypass_limits */)) {\n+        const MempoolAcceptResult result = AcceptToMemoryPool(mempool, *it, true /* bypass_limits */);\n+\n+        if (!fAddToMempool || (*it)->IsCoinBase() || !result.m_accepted) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r565449378",
      "id" : 565449378,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQ0OTM3OA==",
      "original_commit_id" : "70f84b22199cd0afffd12ea8e8934d22b0f0c7f4",
      "original_line" : 392,
      "original_position" : 51,
      "original_start_line" : 390,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 577522548,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565449378",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r565450892"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565450892"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is it necessary to wrap the `std::shared_ptr` in a `std::optional`? Can you just use a null pointer to mean not present?",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-27T16:28:12Z",
      "diff_hunk" : "@@ -189,12 +189,52 @@ void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune);\n /** Prune block files up to a given height */\n void PruneBlockFilesManual(int nManualPruneHeight);\n \n-/** (try to) add transaction to memory pool\n- * plTxnReplaced will be appended to with all transactions replaced from mempool\n- * @param[out] fee_out optional argument to return tx fee to the caller **/\n-bool AcceptToMemoryPool(CTxMemPool& pool, TxValidationState &state, const CTransactionRef &tx,\n-                        std::list<CTransactionRef>* plTxnReplaced,\n-                        bool bypass_limits, bool test_accept=false, CAmount* fee_out=nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+/**\n+* Validation result for a single transaction mempool acceptance.\n+* When m_accepted = true, m_replaced_transactions contains a list\n+* of replaced transactions and m_base_fees contains the tx fees.\n+*/\n+struct MempoolAcceptResult {\n+    bool m_accepted;\n+    TxValidationState m_state;\n+\n+    // Valid when m_accepted = false\n+    std::optional<CTransactionRef> m_ptx;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r565450892",
      "id" : 565450892,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQ1MDg5Mg==",
      "original_commit_id" : "70f84b22199cd0afffd12ea8e8934d22b0f0c7f4",
      "original_line" : 202,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 577522548,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565450892",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r565451590"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565451590"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe clean up the style while you're here:\r\n\r\n- `CTransactionRef &tx` -> `CTransactionRef& tx`\r\n- align second line with opening parens",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-27T16:28:58Z",
      "diff_hunk" : "@@ -189,12 +189,52 @@ void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune);\n /** Prune block files up to a given height */\n void PruneBlockFilesManual(int nManualPruneHeight);\n \n-/** (try to) add transaction to memory pool\n- * plTxnReplaced will be appended to with all transactions replaced from mempool\n- * @param[out] fee_out optional argument to return tx fee to the caller **/\n-bool AcceptToMemoryPool(CTxMemPool& pool, TxValidationState &state, const CTransactionRef &tx,\n-                        std::list<CTransactionRef>* plTxnReplaced,\n-                        bool bypass_limits, bool test_accept=false, CAmount* fee_out=nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+/**\n+* Validation result for a single transaction mempool acceptance.\n+* When m_accepted = true, m_replaced_transactions contains a list\n+* of replaced transactions and m_base_fees contains the tx fees.\n+*/\n+struct MempoolAcceptResult {\n+    bool m_accepted;\n+    TxValidationState m_state;\n+\n+    // Valid when m_accepted = false\n+    std::optional<CTransactionRef> m_ptx;\n+\n+    // Valid when m_accepted = true\n+    std::optional<std::list<CTransactionRef>> m_replaced_transactions;\n+    std::optional<CAmount> m_base_fees;\n+\n+    /** Constructor for failure case */\n+    explicit MempoolAcceptResult(TxValidationState state, CTransactionRef ptx) : m_state(state), m_ptx(ptx) {\n+        m_accepted = false;\n+        m_replaced_transactions = nullopt;\n+        m_base_fees = nullopt;\n+    }\n+\n+    /** Constructor for success case */\n+    explicit MempoolAcceptResult(TxValidationState state, std::list<CTransactionRef>&& replaced_txns, CAmount fees) :\n+        m_state(state), m_replaced_transactions(std::move(replaced_txns)), m_base_fees(fees) {\n+        m_accepted = true;\n+        m_ptx = nullopt;\n+    }\n+};\n+\n+/**\n+ * (Try to) add a transaction to the memory pool.\n+ */\n+MempoolAcceptResult AcceptToMemoryPool(CTxMemPool& pool, const CTransactionRef &tx,\n+                        bool bypass_limits, bool test_accept=false) EXCLUSIVE_LOCKS_REQUIRED(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r565451590",
      "id" : 565451590,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQ1MTU5MA==",
      "original_commit_id" : "70f84b22199cd0afffd12ea8e8934d22b0f0c7f4",
      "original_line" : 227,
      "original_position" : 61,
      "original_start_line" : 226,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 577522548,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565451590",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r565454965"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565454965"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Try to keep lines below 100-120 chars and align args with opening parens:\r\n\r\n```suggestion\r\nstatic MempoolAcceptResult AcceptToMemoryPoolWithTime(const CChainParams& chainparams, CTxMemPool& pool,\r\n                                                      const CTransactionRef& tx, int64_t nAcceptTime,\r\n                                                      bool bypass_limits, bool test_accept)\r\n    EXCLUSIVE_LOCKS_REQUIRED(cs_main)\r\n\r\n```",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-27T16:33:15Z",
      "diff_hunk" : "@@ -1029,46 +1040,84 @@ bool MemPoolAccept::Finalize(ATMPArgs& args, Workspace& ws)\n     return true;\n }\n \n-bool MemPoolAccept::AcceptSingleTransaction(const CTransactionRef& ptx, ATMPArgs& args)\n+MempoolAcceptResult MemPoolAccept::AcceptSingleTransaction(const CTransactionRef& ptx, ATMPArgs& args)\n {\n     AssertLockHeld(cs_main);\n     LOCK(m_pool.cs); // mempool \"read lock\" (held through GetMainSignals().TransactionAddedToMempool())\n \n     Workspace workspace(ptx);\n \n-    if (!PreChecks(args, workspace)) return false;\n+    if (!PreChecks(args, workspace)) return MempoolAcceptResult(workspace.m_state, workspace.m_ptx);\n \n     // Only compute the precomputed transaction data if we need to verify\n     // scripts (ie, other policy checks pass). We perform the inexpensive\n     // checks first and avoid hashing and signature verification unless those\n     // checks pass, to mitigate CPU exhaustion denial-of-service attacks.\n     PrecomputedTransactionData txdata;\n \n-    if (!PolicyScriptChecks(args, workspace, txdata)) return false;\n+    if (!PolicyScriptChecks(args, workspace, txdata)) return MempoolAcceptResult(workspace.m_state, workspace.m_ptx);\n \n-    if (!ConsensusScriptChecks(args, workspace, txdata)) return false;\n+    if (!ConsensusScriptChecks(args, workspace, txdata)) return MempoolAcceptResult(workspace.m_state, workspace.m_ptx);\n \n     // Tx was accepted, but not added\n-    if (args.m_test_accept) return true;\n+    if (args.m_test_accept) {\n+        return MempoolAcceptResult(workspace.m_state, std::move(workspace.m_replaced_transactions), workspace.m_base_fees);\n+    }\n \n-    if (!Finalize(args, workspace)) return false;\n+    if (!Finalize(args, workspace)) return MempoolAcceptResult(workspace.m_state, workspace.m_ptx);\n \n     GetMainSignals().TransactionAddedToMempool(ptx, m_pool.GetAndIncrementSequence());\n \n-    return true;\n+    return MempoolAcceptResult(workspace.m_state, std::move(workspace.m_replaced_transactions), workspace.m_base_fees);\n+}\n+\n+std::vector<MempoolAcceptResult> MemPoolAccept::AcceptMultipleTransactions(std::vector<CTransactionRef>& txns, ATMPArgs& args)\n+{\n+    AssertLockHeld(cs_main);\n+    std::vector<Workspace> workspaces{};\n+    workspaces.reserve(txns.size());\n+    std::transform(txns.begin(), txns.end(), std::back_inserter(workspaces), [](CTransactionRef& tx) {\n+        return Workspace(tx);\n+    });\n+\n+    LOCK(m_pool.cs);\n+    // Do all PreChecks first and fail fast to avoid running expensive script\n+    // checks when unnecessary.\n+    for (unsigned int i = 0; i < txns.size(); ++i) {\n+        Workspace& workspace = workspaces[i];\n+        if (!PreChecks(args, workspace)) {\n+            return std::vector<MempoolAcceptResult> { MempoolAcceptResult(workspace.m_state, workspace.m_ptx) };\n+        }\n+        m_viewmempool.AddPackageTransaction(txns[i]);\n+    }\n+\n+    // TODO: Enforce package-level feerate and other policies before script checks.\n+    for (unsigned int i = 0; i < txns.size(); ++i) {\n+        PrecomputedTransactionData txdata;\n+        Workspace& workspace = workspaces[i];\n+\n+        if (!PolicyScriptChecks(args, workspace, txdata)) {\n+            return std::vector<MempoolAcceptResult> { MempoolAcceptResult(workspace.m_state, workspace.m_ptx) };\n+        }\n+    }\n+    std::vector<MempoolAcceptResult> results;\n+    std::transform(workspaces.begin(), workspaces.end(), std::back_inserter(results), [](Workspace& ws) {\n+        return MempoolAcceptResult(ws.m_state, std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+    });\n+    return results;\n }\n \n } // anon namespace\n \n /** (try to) add transaction to memory pool with a specified acceptance time **/\n-static bool AcceptToMemoryPoolWithTime(const CChainParams& chainparams, CTxMemPool& pool, TxValidationState &state, const CTransactionRef &tx,\n-                        int64_t nAcceptTime, std::list<CTransactionRef>* plTxnReplaced,\n-                        bool bypass_limits, bool test_accept, CAmount* fee_out=nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n+static MempoolAcceptResult AcceptToMemoryPoolWithTime(const CChainParams& chainparams, CTxMemPool& pool, const CTransactionRef &tx,\n+                        int64_t nAcceptTime, bool bypass_limits, bool test_accept) EXCLUSIVE_LOCKS_REQUIRED(cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r565454965",
      "id" : 565454965,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQ1NDk2NQ==",
      "original_commit_id" : "70f84b22199cd0afffd12ea8e8934d22b0f0c7f4",
      "original_line" : 1114,
      "original_position" : 318,
      "original_start_line" : 1113,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 577522548,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565454965",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r565467098"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565467098"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit f14f8b73900d2da4e15119780e19683c8499b700 (_[refactor] return MempoolAcceptResult_), these local vars shouldn't be necessary. You're simply initializing them to default values, then passing them to the `ATMPArgs` initializer which copies them. You can save yourself some typing (and potentially an unnecessary copy) by creating those default values in the initializer itself:\r\n\r\n```diff\r\n@@ -1063,9 +1063,7 @@ static MempoolAcceptResult AcceptToMemoryPoolWithTime(const CChainParams& chainp\r\n {\r\n     TxValidationState state;\r\n     std::vector<COutPoint> coins_to_uncache;\r\n-    CAmount fee = 0;\r\n-    std::list<CTransactionRef> m_replaced_transactions;\r\n-    MemPoolAccept::ATMPArgs args { chainparams, state, nAcceptTime, m_replaced_transactions, bypass_limits, coins_to_uncache, test_accept, fee };\r\n+    MemPoolAccept::ATMPArgs args { chainparams, state, nAcceptTime, {}, bypass_limits, coins_to_uncache, test_accept, {} };\r\n \r\n     const MempoolAcceptResult result = MemPoolAccept(pool).AcceptSingleTransaction(tx, args);\r\n     if (!result.m_accepted) {\r\n```",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-27T16:48:50Z",
      "diff_hunk" : "@@ -1029,46 +1024,51 @@ bool MemPoolAccept::Finalize(ATMPArgs& args, Workspace& ws)\n     return true;\n }\n \n-bool MemPoolAccept::AcceptSingleTransaction(const CTransactionRef& ptx, ATMPArgs& args)\n+MempoolAcceptResult MemPoolAccept::AcceptSingleTransaction(const CTransactionRef& ptx, ATMPArgs& args)\n {\n     AssertLockHeld(cs_main);\n     LOCK(m_pool.cs); // mempool \"read lock\" (held through GetMainSignals().TransactionAddedToMempool())\n \n     Workspace workspace(ptx);\n \n-    if (!PreChecks(args, workspace)) return false;\n+    if (!PreChecks(args, workspace)) return MempoolAcceptResult(args.m_state);\n \n     // Only compute the precomputed transaction data if we need to verify\n     // scripts (ie, other policy checks pass). We perform the inexpensive\n     // checks first and avoid hashing and signature verification unless those\n     // checks pass, to mitigate CPU exhaustion denial-of-service attacks.\n     PrecomputedTransactionData txdata;\n \n-    if (!PolicyScriptChecks(args, workspace, txdata)) return false;\n+    if (!PolicyScriptChecks(args, workspace, txdata)) return MempoolAcceptResult(args.m_state);\n \n-    if (!ConsensusScriptChecks(args, workspace, txdata)) return false;\n+    if (!ConsensusScriptChecks(args, workspace, txdata)) return MempoolAcceptResult(args.m_state);\n \n     // Tx was accepted, but not added\n-    if (args.m_test_accept) return true;\n+    if (args.m_test_accept) {\n+        return MempoolAcceptResult(args.m_state, std::move(args.m_replaced_transactions), args.m_fee_out);\n+    }\n \n-    if (!Finalize(args, workspace)) return false;\n+    if (!Finalize(args, workspace)) return MempoolAcceptResult(args.m_state);\n \n     GetMainSignals().TransactionAddedToMempool(ptx, m_pool.GetAndIncrementSequence());\n \n-    return true;\n+    return MempoolAcceptResult(args.m_state, std::move(args.m_replaced_transactions), args.m_fee_out);\n }\n \n } // anon namespace\n \n /** (try to) add transaction to memory pool with a specified acceptance time **/\n-static bool AcceptToMemoryPoolWithTime(const CChainParams& chainparams, CTxMemPool& pool, TxValidationState &state, const CTransactionRef &tx,\n-                        int64_t nAcceptTime, std::list<CTransactionRef>* plTxnReplaced,\n-                        bool bypass_limits, bool test_accept, CAmount* fee_out=nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n+static MempoolAcceptResult AcceptToMemoryPoolWithTime(const CChainParams& chainparams, CTxMemPool& pool, const CTransactionRef &tx,\n+                        int64_t nAcceptTime, bool bypass_limits, bool test_accept) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n {\n+    TxValidationState state;\n     std::vector<COutPoint> coins_to_uncache;\n-    MemPoolAccept::ATMPArgs args { chainparams, state, nAcceptTime, plTxnReplaced, bypass_limits, coins_to_uncache, test_accept, fee_out };\n-    bool res = MemPoolAccept(pool).AcceptSingleTransaction(tx, args);\n-    if (!res) {\n+    CAmount fee = 0;\n+    std::list<CTransactionRef> m_replaced_transactions;\n+    MemPoolAccept::ATMPArgs args { chainparams, state, nAcceptTime, m_replaced_transactions, bypass_limits, coins_to_uncache, test_accept, fee };",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r565467098",
      "id" : 565467098,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQ2NzA5OA==",
      "original_commit_id" : "f14f8b73900d2da4e15119780e19683c8499b700",
      "original_line" : 1068,
      "original_position" : 117,
      "original_start_line" : 1066,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 577522548,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565467098",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r565467203"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565467203"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`CHECK_NONFATAL` (documented in developer notes [here](https://github.com/bitcoin/bitcoin/blob/master/doc/developer-notes.md#assertions-and-checks)) helps with internal logic bugs. Here, the bug would be a testmempoolaccept thing only (and therefore not be fatal enough to crash the node), but we'd definitely want to address it.\r\n\r\nHere, we are merely making sure that, if there were any errors, the length of `validation_results` should be 1. It's okay for a transaction to be invalid so we don't want to throw an error for that. This check is just to make sure that `ProcessNewPackage()` is adhering to the API we expect. I hope this helps!",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-27T16:48:56Z",
      "diff_hunk" : "@@ -922,67 +924,77 @@ static RPCHelpMan testmempoolaccept()\n         UniValueType(), // VNUM or VSTR, checked inside AmountFromValue()\n     });\n \n-    if (request.params[0].get_array().size() != 1) {\n-        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Array must contain exactly one raw transaction for now\");\n-    }\n-\n-    CMutableTransaction mtx;\n-    if (!DecodeHexTx(mtx, request.params[0].get_array()[0].get_str())) {\n-        throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed. Make sure the tx has at least one input.\");\n-    }\n-    CTransactionRef tx(MakeTransactionRef(std::move(mtx)));\n-\n+    const UniValue raw_transactions = request.params[0].get_array();\n     const CFeeRate max_raw_tx_fee_rate = request.params[1].isNull() ?\n                                              DEFAULT_MAX_RAW_TX_FEE_RATE :\n                                              CFeeRate(AmountFromValue(request.params[1]));\n \n     CTxMemPool& mempool = EnsureMemPool(request.context);\n-    int64_t virtual_size = GetVirtualTransactionSize(*tx);\n-    CAmount max_raw_tx_fee = max_raw_tx_fee_rate.GetFee(virtual_size);\n-\n-    UniValue result(UniValue::VARR);\n-    UniValue result_0(UniValue::VOBJ);\n-    result_0.pushKV(\"txid\", tx->GetHash().GetHex());\n-    result_0.pushKV(\"wtxid\", tx->GetWitnessHash().GetHex());\n+    std::vector<CTransactionRef> txns;\n \n-    TxValidationState state;\n-    bool test_accept_res;\n-    CAmount fee{0};\n-    {\n-        LOCK(cs_main);\n-        test_accept_res = AcceptToMemoryPool(mempool, state, std::move(tx),\n-            nullptr /* plTxnReplaced */, false /* bypass_limits */, /* test_accept */ true, &fee);\n+    for (unsigned int i = 0; i < raw_transactions.size(); ++i) {\n+        CMutableTransaction mtx;\n+        if (!DecodeHexTx(mtx, raw_transactions[i].get_str())) {\n+            throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed\");\n+        }\n+        txns.emplace_back(MakeTransactionRef(std::move(mtx)));\n     }\n \n-    // Check that fee does not exceed maximum fee\n-    if (test_accept_res && max_raw_tx_fee && fee > max_raw_tx_fee) {\n-        result_0.pushKV(\"allowed\", false);\n-        result_0.pushKV(\"reject-reason\", \"max-fee-exceeded\");\n-        result.push_back(std::move(result_0));\n-        return result;\n+    std::vector<MempoolAcceptResult> validation_results;\n+    if (txns.size() == 1) {\n+        validation_results.emplace_back(WITH_LOCK(cs_main,\n+            return AcceptToMemoryPool(mempool, txns[0], false /* bypass_limits */, true /* test_accept */)));\n+    } else {\n+        validation_results = WITH_LOCK(cs_main, return ProcessNewPackage(mempool, txns, true));\n     }\n-    result_0.pushKV(\"allowed\", test_accept_res);\n \n-    // Only return the fee and vsize if the transaction would pass ATMP.\n-    // These can be used to calculate the feerate.\n-    if (test_accept_res) {\n-        result_0.pushKV(\"vsize\", virtual_size);\n-        UniValue fees(UniValue::VOBJ);\n-        fees.pushKV(\"base\", ValueFromAmount(fee));\n-        result_0.pushKV(\"fees\", fees);\n-    } else {\n-        if (state.IsInvalid()) {\n-            if (state.GetResult() == TxValidationResult::TX_MISSING_INPUTS) {\n-                result_0.pushKV(\"reject-reason\", \"missing-inputs\");\n+    auto tx_accepted = [](MempoolAcceptResult& res) { return res.m_accepted; };\n+    const bool all_valid = std::all_of(validation_results.begin(), validation_results.end(), tx_accepted);\n+    // ProcessNewPackage should return a MempoolAcceptResult per transaction\n+    // or exactly 1 for the first error that occurs.\n+    CHECK_NONFATAL(all_valid || validation_results.size() == 1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r565467203",
      "id" : 565467203,
      "in_reply_to_id" : 565444091,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQ2NzIwMw==",
      "original_commit_id" : "70f84b22199cd0afffd12ea8e8934d22b0f0c7f4",
      "original_line" : 955,
      "original_position" : 94,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : null,
      "pull_request_review_id" : 577546105,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565467203",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r565468063"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565468063"
         }
      },
      "author_association" : "MEMBER",
      "body" : "maintain alignment with parens",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-27T16:50:06Z",
      "diff_hunk" : "@@ -5013,13 +5081,12 @@ bool LoadMempool(CTxMemPool& pool)\n             if (amountdelta) {\n                 pool.PrioritiseTransaction(tx->GetHash(), amountdelta);\n             }\n-            TxValidationState state;\n             if (nTime > nNow - nExpiryTimeout) {\n                 LOCK(cs_main);\n-                AcceptToMemoryPoolWithTime(chainparams, pool, state, tx, nTime,\n-                                           nullptr /* plTxnReplaced */, false /* bypass_limits */,\n+                const MempoolAcceptResult result = AcceptToMemoryPoolWithTime(chainparams, pool, tx, nTime,\n+                                           false /* bypass_limits */,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r565468063",
      "id" : 565468063,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQ2ODA2Mw==",
      "original_commit_id" : "70f84b22199cd0afffd12ea8e8934d22b0f0c7f4",
      "original_line" : 5087,
      "original_position" : 381,
      "original_start_line" : 5086,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 577522548,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565468063",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r565469529"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565469529"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This can be a reference",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-27T16:52:03Z",
      "diff_hunk" : "@@ -2177,10 +2177,10 @@ void PeerManagerImpl::ProcessOrphanTx(std::set<uint256>& orphan_work_set)\n         if (orphan_it == mapOrphanTransactions.end()) continue;\n \n         const CTransactionRef porphanTx = orphan_it->second.tx;\n-        TxValidationState state;\n-        std::list<CTransactionRef> removed_txn;\n+        const MempoolAcceptResult result = AcceptToMemoryPool(m_mempool, porphanTx, false /* bypass_limits */);\n+        const TxValidationState state = result.m_state;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r565469529",
      "id" : 565469529,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQ2OTUyOQ==",
      "original_commit_id" : "70f84b22199cd0afffd12ea8e8934d22b0f0c7f4",
      "original_line" : 2181,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 577522548,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565469529",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r565470752"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565470752"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This can be a reference.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-27T16:53:30Z",
      "diff_hunk" : "@@ -3183,10 +3183,10 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             return;\n         }\n \n-        TxValidationState state;\n-        std::list<CTransactionRef> lRemovedTxn;\n+        const MempoolAcceptResult result = AcceptToMemoryPool(m_mempool, ptx, false /* bypass_limits */);\n+        const TxValidationState state = result.m_state;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r565470752",
      "id" : 565470752,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTQ3MDc1Mg==",
      "original_commit_id" : "70f84b22199cd0afffd12ea8e8934d22b0f0c7f4",
      "original_line" : 3187,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 577522548,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565470752",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK. A great first step for packages!",
      "created_at" : "2021-01-27T16:56:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#issuecomment-768423929",
      "id" : 768423929,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20833",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2ODQyMzkyOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-27T16:56:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/768423929",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3072149?v=4",
         "events_url" : "https://api.github.com/users/duncandean/events{/privacy}",
         "followers_url" : "https://api.github.com/users/duncandean/followers",
         "following_url" : "https://api.github.com/users/duncandean/following{/other_user}",
         "gists_url" : "https://api.github.com/users/duncandean/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/duncandean",
         "id" : 3072149,
         "login" : "duncandean",
         "node_id" : "MDQ6VXNlcjMwNzIxNDk=",
         "organizations_url" : "https://api.github.com/users/duncandean/orgs",
         "received_events_url" : "https://api.github.com/users/duncandean/received_events",
         "repos_url" : "https://api.github.com/users/duncandean/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/duncandean/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/duncandean/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/duncandean"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r565567920"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565567920"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think this local variable is needed. It's only used in one place below (in the if conditional). You could just use `validation_results[i].m_base_fees.value()` there.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-27T19:14:53Z",
      "diff_hunk" : "@@ -922,67 +924,77 @@ static RPCHelpMan testmempoolaccept()\n         UniValueType(), // VNUM or VSTR, checked inside AmountFromValue()\n     });\n \n-    if (request.params[0].get_array().size() != 1) {\n-        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Array must contain exactly one raw transaction for now\");\n-    }\n-\n-    CMutableTransaction mtx;\n-    if (!DecodeHexTx(mtx, request.params[0].get_array()[0].get_str())) {\n-        throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed. Make sure the tx has at least one input.\");\n-    }\n-    CTransactionRef tx(MakeTransactionRef(std::move(mtx)));\n-\n+    const UniValue raw_transactions = request.params[0].get_array();\n     const CFeeRate max_raw_tx_fee_rate = request.params[1].isNull() ?\n                                              DEFAULT_MAX_RAW_TX_FEE_RATE :\n                                              CFeeRate(AmountFromValue(request.params[1]));\n \n     CTxMemPool& mempool = EnsureMemPool(request.context);\n-    int64_t virtual_size = GetVirtualTransactionSize(*tx);\n-    CAmount max_raw_tx_fee = max_raw_tx_fee_rate.GetFee(virtual_size);\n-\n-    UniValue result(UniValue::VARR);\n-    UniValue result_0(UniValue::VOBJ);\n-    result_0.pushKV(\"txid\", tx->GetHash().GetHex());\n-    result_0.pushKV(\"wtxid\", tx->GetWitnessHash().GetHex());\n+    std::vector<CTransactionRef> txns;\n \n-    TxValidationState state;\n-    bool test_accept_res;\n-    CAmount fee{0};\n-    {\n-        LOCK(cs_main);\n-        test_accept_res = AcceptToMemoryPool(mempool, state, std::move(tx),\n-            nullptr /* plTxnReplaced */, false /* bypass_limits */, /* test_accept */ true, &fee);\n+    for (unsigned int i = 0; i < raw_transactions.size(); ++i) {\n+        CMutableTransaction mtx;\n+        if (!DecodeHexTx(mtx, raw_transactions[i].get_str())) {\n+            throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed\");\n+        }\n+        txns.emplace_back(MakeTransactionRef(std::move(mtx)));\n     }\n \n-    // Check that fee does not exceed maximum fee\n-    if (test_accept_res && max_raw_tx_fee && fee > max_raw_tx_fee) {\n-        result_0.pushKV(\"allowed\", false);\n-        result_0.pushKV(\"reject-reason\", \"max-fee-exceeded\");\n-        result.push_back(std::move(result_0));\n-        return result;\n+    std::vector<MempoolAcceptResult> validation_results;\n+    if (txns.size() == 1) {\n+        validation_results.emplace_back(WITH_LOCK(cs_main,\n+            return AcceptToMemoryPool(mempool, txns[0], false /* bypass_limits */, true /* test_accept */)));\n+    } else {\n+        validation_results = WITH_LOCK(cs_main, return ProcessNewPackage(mempool, txns, true));\n     }\n-    result_0.pushKV(\"allowed\", test_accept_res);\n \n-    // Only return the fee and vsize if the transaction would pass ATMP.\n-    // These can be used to calculate the feerate.\n-    if (test_accept_res) {\n-        result_0.pushKV(\"vsize\", virtual_size);\n-        UniValue fees(UniValue::VOBJ);\n-        fees.pushKV(\"base\", ValueFromAmount(fee));\n-        result_0.pushKV(\"fees\", fees);\n-    } else {\n-        if (state.IsInvalid()) {\n-            if (state.GetResult() == TxValidationResult::TX_MISSING_INPUTS) {\n-                result_0.pushKV(\"reject-reason\", \"missing-inputs\");\n+    auto tx_accepted = [](MempoolAcceptResult& res) { return res.m_accepted; };\n+    const bool all_valid = std::all_of(validation_results.begin(), validation_results.end(), tx_accepted);\n+    // ProcessNewPackage should return a MempoolAcceptResult per transaction\n+    // or exactly 1 for the first error that occurs.\n+    CHECK_NONFATAL(all_valid || validation_results.size() == 1);\n+\n+    // TODO: Report absurd fees for packages.\n+\n+    UniValue result(UniValue::VARR);\n+    if (all_valid) {\n+        for (unsigned int i = 0; i < validation_results.size(); ++i) {\n+            UniValue result_inner(UniValue::VOBJ);\n+            const CTransaction tx = *txns[i];\n+            result_inner.pushKV(\"txid\", tx.GetHash().GetHex());\n+            result_inner.pushKV(\"wtxid\", tx.GetWitnessHash().GetHex());\n+\n+            const CAmount fee = validation_results[i].m_base_fees.value();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r565567920",
      "id" : 565567920,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTU2NzkyMA==",
      "original_commit_id" : "70f84b22199cd0afffd12ea8e8934d22b0f0c7f4",
      "original_line" : 967,
      "original_position" : 106,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : null,
      "pull_request_review_id" : 577522548,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565567920",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r565572115"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565572115"
         }
      },
      "author_association" : "NONE",
      "body" : "Ah! Thanks for linking to that description ð  [This was](https://doxygen.bitcoincore.org/check_8h.html#a46a3e27097aa5e94bbf62075bad7016f) the only one I had been working off of so the link you provided is super helpful for understanding the purpose of CHECK_NONFATAL. \r\n\r\nI was getting hung up on the `||`, or part of the evaluation. I think I understand it now, an error will only be thrown if both `all_valid` and `validation_results.size() == 1` evaluate to false, reason being that these two statements are incompatible (if there is an invalid tx, `validation_results.size()` can't be anything other than 1). Thanks for the clarification! Please mark this guy as resolved when you get a chance! (I don't believe I have permission to)",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-27T19:21:33Z",
      "diff_hunk" : "@@ -922,67 +924,77 @@ static RPCHelpMan testmempoolaccept()\n         UniValueType(), // VNUM or VSTR, checked inside AmountFromValue()\n     });\n \n-    if (request.params[0].get_array().size() != 1) {\n-        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Array must contain exactly one raw transaction for now\");\n-    }\n-\n-    CMutableTransaction mtx;\n-    if (!DecodeHexTx(mtx, request.params[0].get_array()[0].get_str())) {\n-        throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed. Make sure the tx has at least one input.\");\n-    }\n-    CTransactionRef tx(MakeTransactionRef(std::move(mtx)));\n-\n+    const UniValue raw_transactions = request.params[0].get_array();\n     const CFeeRate max_raw_tx_fee_rate = request.params[1].isNull() ?\n                                              DEFAULT_MAX_RAW_TX_FEE_RATE :\n                                              CFeeRate(AmountFromValue(request.params[1]));\n \n     CTxMemPool& mempool = EnsureMemPool(request.context);\n-    int64_t virtual_size = GetVirtualTransactionSize(*tx);\n-    CAmount max_raw_tx_fee = max_raw_tx_fee_rate.GetFee(virtual_size);\n-\n-    UniValue result(UniValue::VARR);\n-    UniValue result_0(UniValue::VOBJ);\n-    result_0.pushKV(\"txid\", tx->GetHash().GetHex());\n-    result_0.pushKV(\"wtxid\", tx->GetWitnessHash().GetHex());\n+    std::vector<CTransactionRef> txns;\n \n-    TxValidationState state;\n-    bool test_accept_res;\n-    CAmount fee{0};\n-    {\n-        LOCK(cs_main);\n-        test_accept_res = AcceptToMemoryPool(mempool, state, std::move(tx),\n-            nullptr /* plTxnReplaced */, false /* bypass_limits */, /* test_accept */ true, &fee);\n+    for (unsigned int i = 0; i < raw_transactions.size(); ++i) {\n+        CMutableTransaction mtx;\n+        if (!DecodeHexTx(mtx, raw_transactions[i].get_str())) {\n+            throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed\");\n+        }\n+        txns.emplace_back(MakeTransactionRef(std::move(mtx)));\n     }\n \n-    // Check that fee does not exceed maximum fee\n-    if (test_accept_res && max_raw_tx_fee && fee > max_raw_tx_fee) {\n-        result_0.pushKV(\"allowed\", false);\n-        result_0.pushKV(\"reject-reason\", \"max-fee-exceeded\");\n-        result.push_back(std::move(result_0));\n-        return result;\n+    std::vector<MempoolAcceptResult> validation_results;\n+    if (txns.size() == 1) {\n+        validation_results.emplace_back(WITH_LOCK(cs_main,\n+            return AcceptToMemoryPool(mempool, txns[0], false /* bypass_limits */, true /* test_accept */)));\n+    } else {\n+        validation_results = WITH_LOCK(cs_main, return ProcessNewPackage(mempool, txns, true));\n     }\n-    result_0.pushKV(\"allowed\", test_accept_res);\n \n-    // Only return the fee and vsize if the transaction would pass ATMP.\n-    // These can be used to calculate the feerate.\n-    if (test_accept_res) {\n-        result_0.pushKV(\"vsize\", virtual_size);\n-        UniValue fees(UniValue::VOBJ);\n-        fees.pushKV(\"base\", ValueFromAmount(fee));\n-        result_0.pushKV(\"fees\", fees);\n-    } else {\n-        if (state.IsInvalid()) {\n-            if (state.GetResult() == TxValidationResult::TX_MISSING_INPUTS) {\n-                result_0.pushKV(\"reject-reason\", \"missing-inputs\");\n+    auto tx_accepted = [](MempoolAcceptResult& res) { return res.m_accepted; };\n+    const bool all_valid = std::all_of(validation_results.begin(), validation_results.end(), tx_accepted);\n+    // ProcessNewPackage should return a MempoolAcceptResult per transaction\n+    // or exactly 1 for the first error that occurs.\n+    CHECK_NONFATAL(all_valid || validation_results.size() == 1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r565572115",
      "id" : 565572115,
      "in_reply_to_id" : 565444091,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTU3MjExNQ==",
      "original_commit_id" : "70f84b22199cd0afffd12ea8e8934d22b0f0c7f4",
      "original_line" : 955,
      "original_position" : 94,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : null,
      "pull_request_review_id" : 577680431,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565572115",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1823216?v=4",
         "events_url" : "https://api.github.com/users/satsie/events{/privacy}",
         "followers_url" : "https://api.github.com/users/satsie/followers",
         "following_url" : "https://api.github.com/users/satsie/following{/other_user}",
         "gists_url" : "https://api.github.com/users/satsie/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/satsie",
         "id" : 1823216,
         "login" : "satsie",
         "node_id" : "MDQ6VXNlcjE4MjMyMTY=",
         "organizations_url" : "https://api.github.com/users/satsie/orgs",
         "received_events_url" : "https://api.github.com/users/satsie/received_events",
         "repos_url" : "https://api.github.com/users/satsie/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/satsie/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/satsie/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/satsie"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r565741093"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565741093"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "in f14f8b73900d2da4e15119780e19683c8499b700:\r\n\r\nnit: I slightly prefer\r\n```\r\nBOOST_CHECK(!result.m_accepted);\r\n```",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-28T00:41:27Z",
      "diff_hunk" : "@@ -30,25 +30,21 @@ BOOST_FIXTURE_TEST_CASE(tx_mempool_reject_coinbase, TestChain100Setup)\n \n     BOOST_CHECK(CTransaction(coinbaseTx).IsCoinBase());\n \n-    TxValidationState state;\n-\n     LOCK(cs_main);\n \n     unsigned int initialPoolSize = m_node.mempool->size();\n+    const MempoolAcceptResult result = AcceptToMemoryPool(*m_node.mempool, MakeTransactionRef(coinbaseTx),\n+                true /* bypass_limits */);\n \n-    BOOST_CHECK_EQUAL(\n-            false,\n-            AcceptToMemoryPool(*m_node.mempool, state, MakeTransactionRef(coinbaseTx),\n-                nullptr /* plTxnReplaced */,\n-                true /* bypass_limits */));\n+    BOOST_CHECK_EQUAL(false, result.m_accepted);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r565741093",
      "id" : 565741093,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTc0MTA5Mw==",
      "original_commit_id" : "f14f8b73900d2da4e15119780e19683c8499b700",
      "original_line" : 39,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/test/txvalidation_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 577896489,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565741093",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r565807726"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565807726"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "ah, right",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-28T04:10:08Z",
      "diff_hunk" : "@@ -378,10 +387,9 @@ static void UpdateMempoolForReorg(CTxMemPool& mempool, DisconnectedBlockTransact\n     auto it = disconnectpool.queuedTx.get<insertion_order>().rbegin();\n     while (it != disconnectpool.queuedTx.get<insertion_order>().rend()) {\n         // ignore validation errors in resurrected transactions\n-        TxValidationState stateDummy;\n-        if (!fAddToMempool || (*it)->IsCoinBase() ||\n-            !AcceptToMemoryPool(mempool, stateDummy, *it,\n-                                nullptr /* plTxnReplaced */, true /* bypass_limits */)) {\n+        const MempoolAcceptResult result = AcceptToMemoryPool(mempool, *it, true /* bypass_limits */);\n+\n+        if (!fAddToMempool || (*it)->IsCoinBase() || !result.m_accepted) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r565807726",
      "id" : 565807726,
      "in_reply_to_id" : 565449378,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTgwNzcyNg==",
      "original_commit_id" : "70f84b22199cd0afffd12ea8e8934d22b0f0c7f4",
      "original_line" : 392,
      "original_position" : 51,
      "original_start_line" : 390,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 577972356,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565807726",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r566521663"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566521663"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Also used in `fees.pushKV(\"base\", ValueFromAmount(fee))` if that's better?",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-29T01:34:35Z",
      "diff_hunk" : "@@ -922,67 +924,77 @@ static RPCHelpMan testmempoolaccept()\n         UniValueType(), // VNUM or VSTR, checked inside AmountFromValue()\n     });\n \n-    if (request.params[0].get_array().size() != 1) {\n-        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Array must contain exactly one raw transaction for now\");\n-    }\n-\n-    CMutableTransaction mtx;\n-    if (!DecodeHexTx(mtx, request.params[0].get_array()[0].get_str())) {\n-        throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed. Make sure the tx has at least one input.\");\n-    }\n-    CTransactionRef tx(MakeTransactionRef(std::move(mtx)));\n-\n+    const UniValue raw_transactions = request.params[0].get_array();\n     const CFeeRate max_raw_tx_fee_rate = request.params[1].isNull() ?\n                                              DEFAULT_MAX_RAW_TX_FEE_RATE :\n                                              CFeeRate(AmountFromValue(request.params[1]));\n \n     CTxMemPool& mempool = EnsureMemPool(request.context);\n-    int64_t virtual_size = GetVirtualTransactionSize(*tx);\n-    CAmount max_raw_tx_fee = max_raw_tx_fee_rate.GetFee(virtual_size);\n-\n-    UniValue result(UniValue::VARR);\n-    UniValue result_0(UniValue::VOBJ);\n-    result_0.pushKV(\"txid\", tx->GetHash().GetHex());\n-    result_0.pushKV(\"wtxid\", tx->GetWitnessHash().GetHex());\n+    std::vector<CTransactionRef> txns;\n \n-    TxValidationState state;\n-    bool test_accept_res;\n-    CAmount fee{0};\n-    {\n-        LOCK(cs_main);\n-        test_accept_res = AcceptToMemoryPool(mempool, state, std::move(tx),\n-            nullptr /* plTxnReplaced */, false /* bypass_limits */, /* test_accept */ true, &fee);\n+    for (unsigned int i = 0; i < raw_transactions.size(); ++i) {\n+        CMutableTransaction mtx;\n+        if (!DecodeHexTx(mtx, raw_transactions[i].get_str())) {\n+            throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed\");\n+        }\n+        txns.emplace_back(MakeTransactionRef(std::move(mtx)));\n     }\n \n-    // Check that fee does not exceed maximum fee\n-    if (test_accept_res && max_raw_tx_fee && fee > max_raw_tx_fee) {\n-        result_0.pushKV(\"allowed\", false);\n-        result_0.pushKV(\"reject-reason\", \"max-fee-exceeded\");\n-        result.push_back(std::move(result_0));\n-        return result;\n+    std::vector<MempoolAcceptResult> validation_results;\n+    if (txns.size() == 1) {\n+        validation_results.emplace_back(WITH_LOCK(cs_main,\n+            return AcceptToMemoryPool(mempool, txns[0], false /* bypass_limits */, true /* test_accept */)));\n+    } else {\n+        validation_results = WITH_LOCK(cs_main, return ProcessNewPackage(mempool, txns, true));\n     }\n-    result_0.pushKV(\"allowed\", test_accept_res);\n \n-    // Only return the fee and vsize if the transaction would pass ATMP.\n-    // These can be used to calculate the feerate.\n-    if (test_accept_res) {\n-        result_0.pushKV(\"vsize\", virtual_size);\n-        UniValue fees(UniValue::VOBJ);\n-        fees.pushKV(\"base\", ValueFromAmount(fee));\n-        result_0.pushKV(\"fees\", fees);\n-    } else {\n-        if (state.IsInvalid()) {\n-            if (state.GetResult() == TxValidationResult::TX_MISSING_INPUTS) {\n-                result_0.pushKV(\"reject-reason\", \"missing-inputs\");\n+    auto tx_accepted = [](MempoolAcceptResult& res) { return res.m_accepted; };\n+    const bool all_valid = std::all_of(validation_results.begin(), validation_results.end(), tx_accepted);\n+    // ProcessNewPackage should return a MempoolAcceptResult per transaction\n+    // or exactly 1 for the first error that occurs.\n+    CHECK_NONFATAL(all_valid || validation_results.size() == 1);\n+\n+    // TODO: Report absurd fees for packages.\n+\n+    UniValue result(UniValue::VARR);\n+    if (all_valid) {\n+        for (unsigned int i = 0; i < validation_results.size(); ++i) {\n+            UniValue result_inner(UniValue::VOBJ);\n+            const CTransaction tx = *txns[i];\n+            result_inner.pushKV(\"txid\", tx.GetHash().GetHex());\n+            result_inner.pushKV(\"wtxid\", tx.GetWitnessHash().GetHex());\n+\n+            const CAmount fee = validation_results[i].m_base_fees.value();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r566521663",
      "id" : 566521663,
      "in_reply_to_id" : 565567920,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjUyMTY2Mw==",
      "original_commit_id" : "70f84b22199cd0afffd12ea8e8934d22b0f0c7f4",
      "original_line" : 967,
      "original_position" : 106,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : null,
      "pull_request_review_id" : 578877473,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566521663",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r566527100"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566527100"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Mm, I agree that's better. Also renaming it to `m_failed_ptx` to make it more clear.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-29T01:51:10Z",
      "diff_hunk" : "@@ -189,12 +189,52 @@ void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune);\n /** Prune block files up to a given height */\n void PruneBlockFilesManual(int nManualPruneHeight);\n \n-/** (try to) add transaction to memory pool\n- * plTxnReplaced will be appended to with all transactions replaced from mempool\n- * @param[out] fee_out optional argument to return tx fee to the caller **/\n-bool AcceptToMemoryPool(CTxMemPool& pool, TxValidationState &state, const CTransactionRef &tx,\n-                        std::list<CTransactionRef>* plTxnReplaced,\n-                        bool bypass_limits, bool test_accept=false, CAmount* fee_out=nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+/**\n+* Validation result for a single transaction mempool acceptance.\n+* When m_accepted = true, m_replaced_transactions contains a list\n+* of replaced transactions and m_base_fees contains the tx fees.\n+*/\n+struct MempoolAcceptResult {\n+    bool m_accepted;\n+    TxValidationState m_state;\n+\n+    // Valid when m_accepted = false\n+    std::optional<CTransactionRef> m_ptx;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r566527100",
      "id" : 566527100,
      "in_reply_to_id" : 565450892,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjUyNzEwMA==",
      "original_commit_id" : "70f84b22199cd0afffd12ea8e8934d22b0f0c7f4",
      "original_line" : 202,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 578883564,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566527100",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for your review @jnewbery, addressed your comments and some other style stuff in the last push!",
      "created_at" : "2021-01-29T02:14:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#issuecomment-769526936",
      "id" : 769526936,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20833",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2OTUyNjkzNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-29T02:14:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/769526936",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@stackman27 that's a good point, no package limits could be a bit of a footgun even in `testmempoolaccept`. Maybe limit 25, which would be the same as `DEFAULT_DESCENDANT_LIMIT`? Mempool wouldn't consider packages larger than that anyway, and if it's not 1 package then they don't need to put it in one call.",
      "created_at" : "2021-01-29T20:08:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#issuecomment-770023093",
      "id" : 770023093,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20833",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3MDAyMzA5Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-29T20:08:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/770023093",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567222730"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567222730"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "in b76910ebd4d8a07534e145c498c7f7d0ce297ccd:\r\n\r\nDo these have to be optional if they are \"guarded\" by `m_accepted` anyway? Especially the list could just be empty anyway.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-30T09:25:58Z",
      "diff_hunk" : "@@ -189,12 +189,38 @@ void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune);\n /** Prune block files up to a given height */\n void PruneBlockFilesManual(int nManualPruneHeight);\n \n-/** (try to) add transaction to memory pool\n- * plTxnReplaced will be appended to with all transactions replaced from mempool\n- * @param[out] fee_out optional argument to return tx fee to the caller **/\n-bool AcceptToMemoryPool(CTxMemPool& pool, TxValidationState &state, const CTransactionRef &tx,\n-                        std::list<CTransactionRef>* plTxnReplaced,\n-                        bool bypass_limits, bool test_accept=false, CAmount* fee_out=nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+/**\n+* Validation result for a single transaction mempool acceptance.\n+* When m_accepted = true, m_replaced_transactions contains a list\n+* of replaced transactions and m_base_fees contains the tx fees.\n+*/\n+struct MempoolAcceptResult {\n+    bool m_accepted;\n+    TxValidationState m_state;\n+\n+    // Valid when m_accepted = true\n+    std::optional<std::list<CTransactionRef>> m_replaced_transactions;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567222730",
      "id" : 567222730,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzIyMjczMA==",
      "original_commit_id" : "b76910ebd4d8a07534e145c498c7f7d0ce297ccd",
      "original_line" : 199,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 577896489,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567222730",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567223369"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567223369"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "in b76910e:\r\n\r\nStylistically I find it odd to give public members of a struct the m_* prefix. The way we use structs usually, just bundling some data without complex methods, it doesn't seem needed internally to the struct and externally, where the struct is used looks very wrong to me. But there doesn't seem to be a clear rule on this looking at the codebase. I just did it this way in `IndexSummary` and I didn't get complaints. So maybe something to think about.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-30T09:33:04Z",
      "diff_hunk" : "@@ -189,12 +189,38 @@ void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune);\n /** Prune block files up to a given height */\n void PruneBlockFilesManual(int nManualPruneHeight);\n \n-/** (try to) add transaction to memory pool\n- * plTxnReplaced will be appended to with all transactions replaced from mempool\n- * @param[out] fee_out optional argument to return tx fee to the caller **/\n-bool AcceptToMemoryPool(CTxMemPool& pool, TxValidationState &state, const CTransactionRef &tx,\n-                        std::list<CTransactionRef>* plTxnReplaced,\n-                        bool bypass_limits, bool test_accept=false, CAmount* fee_out=nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+/**\n+* Validation result for a single transaction mempool acceptance.\n+* When m_accepted = true, m_replaced_transactions contains a list\n+* of replaced transactions and m_base_fees contains the tx fees.\n+*/\n+struct MempoolAcceptResult {\n+    bool m_accepted;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567223369",
      "id" : 567223369,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzIyMzM2OQ==",
      "original_commit_id" : "b76910ebd4d8a07534e145c498c7f7d0ce297ccd",
      "original_line" : 198,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 577896489,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567223369",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567223619"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567223619"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "in b76910e:\r\n\r\nI think I would have left `m_accepted` out of the struct and have `AcceptToMemoryPool` return an optional of `MempoolAcceptResult`.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-30T09:36:11Z",
      "diff_hunk" : "@@ -189,12 +189,38 @@ void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune);\n /** Prune block files up to a given height */\n void PruneBlockFilesManual(int nManualPruneHeight);\n \n-/** (try to) add transaction to memory pool\n- * plTxnReplaced will be appended to with all transactions replaced from mempool\n- * @param[out] fee_out optional argument to return tx fee to the caller **/\n-bool AcceptToMemoryPool(CTxMemPool& pool, TxValidationState &state, const CTransactionRef &tx,\n-                        std::list<CTransactionRef>* plTxnReplaced,\n-                        bool bypass_limits, bool test_accept=false, CAmount* fee_out=nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+/**\n+* Validation result for a single transaction mempool acceptance.\n+* When m_accepted = true, m_replaced_transactions contains a list\n+* of replaced transactions and m_base_fees contains the tx fees.\n+*/\n+struct MempoolAcceptResult {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567223619",
      "id" : 567223619,
      "line" : 190,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzIyMzYxOQ==",
      "original_commit_id" : "b76910ebd4d8a07534e145c498c7f7d0ce297ccd",
      "original_line" : 190,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 11,
      "pull_request_review_id" : 577896489,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567223619",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567226540"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567226540"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "in 048ef0a7e62cca10c588b451c9060e7846ac398b:\r\n\r\nThis looks like an error?",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-30T10:06:11Z",
      "diff_hunk" : "@@ -922,60 +924,77 @@ static RPCHelpMan testmempoolaccept()\n         UniValueType(), // VNUM or VSTR, checked inside AmountFromValue()\n     });\n \n-    if (request.params[0].get_array().size() != 1) {\n-        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Array must contain exactly one raw transaction for now\");\n-    }\n-\n-    CMutableTransaction mtx;\n-    if (!DecodeHexTx(mtx, request.params[0].get_array()[0].get_str())) {\n-        throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed. Make sure the tx has at least one input.\");\n-    }\n-    CTransactionRef tx(MakeTransactionRef(std::move(mtx)));\n-\n+    const UniValue raw_transactions = request.params[0].get_array();\n     const CFeeRate max_raw_tx_fee_rate = request.params[1].isNull() ?\n                                              DEFAULT_MAX_RAW_TX_FEE_RATE :\n                                              CFeeRate(AmountFromValue(request.params[1]));\n \n     CTxMemPool& mempool = EnsureMemPool(request.context);\n-    int64_t virtual_size = GetVirtualTransactionSize(*tx);\n-    CAmount max_raw_tx_fee = max_raw_tx_fee_rate.GetFee(virtual_size);\n+    std::vector<CTransactionRef> txns;\n+\n+    for (unsigned int i = 0; i < raw_transactions.size(); ++i) {\n+        CMutableTransaction mtx;\n+        if (!DecodeHexTx(mtx, raw_transactions[i].get_str())) {\n+            throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed\");\n+        }\n+        txns.emplace_back(MakeTransactionRef(std::move(mtx)));\n+    }\n+\n+    std::vector<MempoolAcceptResult> validation_results;\n+    if (txns.size() == 1) {\n+        validation_results.emplace_back(WITH_LOCK(cs_main,\n+            return AcceptToMemoryPool(mempool, txns[0], false /* bypass_limits */, true /* test_accept */)));\n+    } else {\n+        validation_results = WITH_LOCK(cs_main, return ProcessNewPackage(mempool, txns, true));\n+    }\n+\n+    auto tx_accepted = [](MempoolAcceptResult& res) { return res.m_accepted; };\n+    const bool all_valid = std::all_of(validation_results.begin(), validation_results.end(), tx_accepted);\n+    // ProcessNewPackage should return a MempoolAcceptResult per transaction\n+    // or exactly 1 for the first error that occurs.\n+    CHECK_NONFATAL(all_valid || validation_results.size() == 1);\n+\n+    // TODO: Report absurd fees for packages.\n \n     UniValue result(UniValue::VARR);\n-    UniValue result_0(UniValue::VOBJ);\n-    result_0.pushKV(\"txid\", tx->GetHash().GetHex());\n-    result_0.pushKV(\"wtxid\", tx->GetWitnessHash().GetHex());\n-\n-    MempoolAcceptResult accept_result = WITH_LOCK(cs_main,\n-\t\t    return AcceptToMemoryPool(mempool, std::move(tx), false /* bypass_limits */, true /* test_accept */));\n-    const bool test_accept_res = accept_result.m_accepted;\n-\n-    // Only return the fee and vsize if the transaction would pass ATMP.\n-    // These can be used to calculate the feerate.\n-    if (test_accept_res) {\n-        const CAmount fee = accept_result.m_base_fees.value();\n-        // Check that fee does not exceed maximum fee\n-        if (max_raw_tx_fee && fee > max_raw_tx_fee) {\n-            result_0.pushKV(\"allowed\", false);\n-            result_0.pushKV(\"reject-reason\", \"max-fee-exceeded\");\n-            result.push_back(std::move(result_0));\n-            return result;\n+    if (all_valid) {\n+        for (unsigned int i = 0; i < validation_results.size(); ++i) {\n+            UniValue result_inner(UniValue::VOBJ);\n+            const CTransaction tx = *txns[i];\n+            result_inner.pushKV(\"txid\", tx.GetHash().GetHex());\n+            result_inner.pushKV(\"wtxid\", tx.GetWitnessHash().GetHex());\n+\n+            const CAmount fee = validation_results[i].m_base_fees.value();\n+            const int64_t virtual_size = GetVirtualTransactionSize(tx);\n+            const CAmount max_raw_tx_fee = max_raw_tx_fee_rate.GetFee(virtual_size);\n+            // Check that fee does not exceed maximum fee\n+            if (max_raw_tx_fee && fee > max_raw_tx_fee) {\n+                result_inner.pushKV(\"allowed\", false);\n+                result_inner.pushKV(\"reject-reason\", \"max-fee-exceeded\");\n+                result_inner.push_back(std::move(result_inner));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567226540",
      "id" : 567226540,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzIyNjU0MA==",
      "original_commit_id" : "048ef0a7e62cca10c588b451c9060e7846ac398b",
      "original_line" : 974,
      "original_position" : 101,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : null,
      "pull_request_review_id" : 577896489,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567226540",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567454265"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567454265"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "in b76910ebd4d8a07534e145c498c7f7d0ce297ccd:\r\n\r\nI guess this result can be `const`, too.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-31T17:02:19Z",
      "diff_hunk" : "@@ -945,32 +945,29 @@ static RPCHelpMan testmempoolaccept()\n     result_0.pushKV(\"txid\", tx->GetHash().GetHex());\n     result_0.pushKV(\"wtxid\", tx->GetWitnessHash().GetHex());\n \n-    TxValidationState state;\n-    bool test_accept_res;\n-    CAmount fee{0};\n-    {\n-        LOCK(cs_main);\n-        test_accept_res = AcceptToMemoryPool(mempool, state, std::move(tx),\n-            nullptr /* plTxnReplaced */, false /* bypass_limits */, /* test_accept */ true, &fee);\n-    }\n-\n-    // Check that fee does not exceed maximum fee\n-    if (test_accept_res && max_raw_tx_fee && fee > max_raw_tx_fee) {\n-        result_0.pushKV(\"allowed\", false);\n-        result_0.pushKV(\"reject-reason\", \"max-fee-exceeded\");\n-        result.push_back(std::move(result_0));\n-        return result;\n-    }\n-    result_0.pushKV(\"allowed\", test_accept_res);\n+    MempoolAcceptResult accept_result = WITH_LOCK(cs_main,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567454265",
      "id" : 567454265,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzQ1NDI2NQ==",
      "original_commit_id" : "b76910ebd4d8a07534e145c498c7f7d0ce297ccd",
      "original_line" : 948,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : null,
      "pull_request_review_id" : 577896489,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567454265",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567459195"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567459195"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "in 17ca2d8e72bc5d9249e4a01a2dbc2bb362dbd9d8:\r\n\r\nThese members could get an m_* prefix. Also I think they could use some comments explaining what context they are used in. Or the added comments above could be more explicit.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-31T17:41:43Z",
      "diff_hunk" : "@@ -880,15 +880,28 @@ class CTxMemPool\n  * It also allows you to sign a double-spend directly in\n  * signrawtransactionwithkey and signrawtransactionwithwallet,\n  * as long as the conflicting transaction is not yet confirmed.\n+ * It can also serve as temporary scratch space for some set\n+ * of transactions (i.e. as a member of MemPoolAccept to validate\n+ * packages) and tracks the Coins added and removed by them.\n  */\n class CCoinsViewMemPool : public CCoinsViewBacked\n {\n protected:\n     const CTxMemPool& mempool;\n+    std::map<COutPoint, Coin> cache_package_add;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567459195",
      "id" : 567459195,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzQ1OTE5NQ==",
      "original_commit_id" : "17ca2d8e72bc5d9249e4a01a2dbc2bb362dbd9d8",
      "original_line" : 891,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : null,
      "pull_request_review_id" : 577896489,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567459195",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567471786"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567471786"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "in 2fac0136138012ae26c8e12ef77e9486ad5cd831:\r\n\r\nDo you have to generate these and can't use the cached chain?",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-31T19:26:46Z",
      "diff_hunk" : "@@ -0,0 +1,193 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"RPCs that handle raw transaction packages.\"\"\"\n+\n+from decimal import Decimal\n+from io import BytesIO\n+\n+from test_framework.address import ADDRESS_BCRT1_P2WSH_OP_TRUE\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    BIP125_SEQUENCE_NUMBER,\n+    COIN,\n+    CTransaction,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+    hex_str_to_bytes,\n+)\n+\n+class RPCPackagesTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+        self.setup_clean_chain = True\n+\n+    def run_test(self):\n+        self.log.info(\"Generate blocks to create UTXOs\")\n+        node = self.nodes[0]\n+        self.privkeys = [node.get_deterministic_priv_key().key]\n+        self.address = node.get_deterministic_priv_key().address\n+        self.coins = []\n+        # The last 100 coinbase transactions are premature\n+        for b in node.generatetoaddress(120, self.address)[:20]:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567471786",
      "id" : 567471786,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzQ3MTc4Ng==",
      "original_commit_id" : "2fac0136138012ae26c8e12ef77e9486ad5cd831",
      "original_line" : 39,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "test/functional/rpc_packages.py",
      "position" : null,
      "pull_request_review_id" : 577896489,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567471786",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567475382"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567475382"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "in 17ca2d8e72bc5d9249e4a01a2dbc2bb362dbd9d8:\r\n\r\nI am probably missing something but I find it strange that this is ignoring the result of `GetCoin()`. So we don't care at this point that the prevout might already be spent? Might be worth a comment.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-01-31T19:55:51Z",
      "diff_hunk" : "@@ -905,19 +905,48 @@ bool CTxMemPool::HasNoInputsOf(const CTransaction &tx) const\n CCoinsViewMemPool::CCoinsViewMemPool(CCoinsView* baseIn, const CTxMemPool& mempoolIn) : CCoinsViewBacked(baseIn), mempool(mempoolIn) { }\n \n bool CCoinsViewMemPool::GetCoin(const COutPoint &outpoint, Coin &coin) const {\n+    // Check to see if the inputs are spent by a tx being considered for a package.\n+    // It's possible that a package spends entries in the mempool, and this would\n+    // only be reflected in the cache_package_remove.\n+    if (auto it = cache_package_remove.find(outpoint); it != cache_package_remove.end()) {\n+        coin = it->second;\n+        return false;\n+    }\n+\n+    // Check to see if the inputs are in a tx being considered for a package.\n+    // These Coins would not be available in the mempool or underlying CoinsView.\n+    if (auto it = cache_package_add.find(outpoint); it != cache_package_add.end()) {\n+        coin = it->second;\n+        return true;\n+    }\n+\n     // If an entry in the mempool exists, always return that one, as it's guaranteed to never\n-    // conflict with the underlying cache, and it cannot have pruned entries (as it contains full)\n-    // transactions. First checking the underlying cache risks returning a pruned entry instead.\n+    // conflict with the underlying cache, and it cannot have spent entries.\n     CTransactionRef ptx = mempool.get(outpoint.hash);\n-    if (ptx) {\n-        if (outpoint.n < ptx->vout.size()) {\n-            coin = Coin(ptx->vout[outpoint.n], MEMPOOL_HEIGHT, false);\n-            return true;\n-        } else {\n-            return false;\n-        }\n+\n+    // Check the underlying CoinsView.\n+    if (!ptx) return base->GetCoin(outpoint, coin);\n+\n+    // \"Create\" a Coin from a mempool transaction output.\n+    if (outpoint.n < ptx->vout.size()) {\n+        coin = Coin(ptx->vout[outpoint.n], MEMPOOL_HEIGHT, false);\n+        return true;\n+    }\n+    return false;\n+}\n+\n+void CCoinsViewMemPool::AddPackageTransaction(const CTransactionRef& tx) {\n+    package_txids.insert(tx->GetHash());\n+    // Coins spent by this transaction\n+    for (auto input : tx->vin) {\n+        Coin spent_coin;\n+        GetCoin(input.prevout, spent_coin);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567475382",
      "id" : 567475382,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzQ3NTM4Mg==",
      "original_commit_id" : "17ca2d8e72bc5d9249e4a01a2dbc2bb362dbd9d8",
      "original_line" : 943,
      "original_position" : 48,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 577896489,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567475382",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567589472"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567589472"
         }
      },
      "author_association" : "MEMBER",
      "body" : "That wouldn't work, because the error reason couldn't be returned?",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-02-01T06:30:11Z",
      "diff_hunk" : "@@ -189,12 +189,38 @@ void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune);\n /** Prune block files up to a given height */\n void PruneBlockFilesManual(int nManualPruneHeight);\n \n-/** (try to) add transaction to memory pool\n- * plTxnReplaced will be appended to with all transactions replaced from mempool\n- * @param[out] fee_out optional argument to return tx fee to the caller **/\n-bool AcceptToMemoryPool(CTxMemPool& pool, TxValidationState &state, const CTransactionRef &tx,\n-                        std::list<CTransactionRef>* plTxnReplaced,\n-                        bool bypass_limits, bool test_accept=false, CAmount* fee_out=nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+/**\n+* Validation result for a single transaction mempool acceptance.\n+* When m_accepted = true, m_replaced_transactions contains a list\n+* of replaced transactions and m_base_fees contains the tx fees.\n+*/\n+struct MempoolAcceptResult {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567589472",
      "id" : 567589472,
      "in_reply_to_id" : 567223619,
      "line" : 190,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzU4OTQ3Mg==",
      "original_commit_id" : "b76910ebd4d8a07534e145c498c7f7d0ce297ccd",
      "original_line" : 190,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 11,
      "pull_request_review_id" : 580044650,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567589472",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567827106"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567827106"
         }
      },
      "author_association" : "MEMBER",
      "body" : "There's no guidance in the style guide on this. I tried to update the style guide to include guidance in https://github.com/bitcoin/bitcoin/pull/19759, but people had *very strong feelings* so I backed off.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-02-01T13:32:31Z",
      "diff_hunk" : "@@ -189,12 +189,38 @@ void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune);\n /** Prune block files up to a given height */\n void PruneBlockFilesManual(int nManualPruneHeight);\n \n-/** (try to) add transaction to memory pool\n- * plTxnReplaced will be appended to with all transactions replaced from mempool\n- * @param[out] fee_out optional argument to return tx fee to the caller **/\n-bool AcceptToMemoryPool(CTxMemPool& pool, TxValidationState &state, const CTransactionRef &tx,\n-                        std::list<CTransactionRef>* plTxnReplaced,\n-                        bool bypass_limits, bool test_accept=false, CAmount* fee_out=nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+/**\n+* Validation result for a single transaction mempool acceptance.\n+* When m_accepted = true, m_replaced_transactions contains a list\n+* of replaced transactions and m_base_fees contains the tx fees.\n+*/\n+struct MempoolAcceptResult {\n+    bool m_accepted;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567827106",
      "id" : 567827106,
      "in_reply_to_id" : 567223369,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzgyNzEwNg==",
      "original_commit_id" : "b76910ebd4d8a07534e145c498c7f7d0ce297ccd",
      "original_line" : 198,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 580354195,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567827106",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567837440"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567837440"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Since these ctors are just initializing members, you could do it all in the initializer list:\r\n\r\n```suggestion\r\n    /** Constructor for failure case */\r\n    explicit MempoolAcceptResult(TxValidationState state, CTransactionRef ptx) :\r\n        m_accepted(false), m_state(state), m_failed_ptx(ptx), m_replaced_transactions(nullopt),\r\n        m_base_fees(nullopt) {}\r\n\r\n    /** Constructor for success case */\r\n    explicit MempoolAcceptResult(TxValidationState state, std::list<CTransactionRef>&& replaced_txns, CAmount fees) :\r\n        m_accepted(true), m_state(state), m_failed_ptx(nullptr),\r\n        m_replaced_transactions(std::move(replaced_txns)), m_base_fees(fees) {}\r\n\r\n```",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-02-01T13:48:08Z",
      "diff_hunk" : "@@ -189,12 +189,53 @@ void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune);\n /** Prune block files up to a given height */\n void PruneBlockFilesManual(int nManualPruneHeight);\n \n-/** (try to) add transaction to memory pool\n- * plTxnReplaced will be appended to with all transactions replaced from mempool\n- * @param[out] fee_out optional argument to return tx fee to the caller **/\n-bool AcceptToMemoryPool(CTxMemPool& pool, TxValidationState &state, const CTransactionRef &tx,\n-                        std::list<CTransactionRef>* plTxnReplaced,\n-                        bool bypass_limits, bool test_accept=false, CAmount* fee_out=nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+/**\n+* Validation result for a single transaction mempool acceptance.\n+* When m_accepted = true, m_replaced_transactions contains a list\n+* of replaced transactions and m_base_fees contains the tx fees.\n+*/\n+struct MempoolAcceptResult {\n+    bool m_accepted;\n+    TxValidationState m_state;\n+\n+    // Points to failed tx when m_accepted = false\n+    CTransactionRef m_failed_ptx;\n+\n+    // Valid when m_accepted = true\n+    std::optional<std::list<CTransactionRef>> m_replaced_transactions;\n+    std::optional<CAmount> m_base_fees;\n+\n+    /** Constructor for failure case */\n+    explicit MempoolAcceptResult(TxValidationState state, CTransactionRef ptx) :\n+        m_state(state), m_failed_ptx(ptx) {\n+        m_accepted = false;\n+        m_replaced_transactions = nullopt;\n+        m_base_fees = nullopt;\n+    }\n+\n+    /** Constructor for success case */\n+    explicit MempoolAcceptResult(TxValidationState state, std::list<CTransactionRef>&& replaced_txns, CAmount fees) :\n+        m_state(state), m_replaced_transactions(std::move(replaced_txns)), m_base_fees(fees) {\n+        m_accepted = true;\n+        m_failed_ptx = nullptr;\n+    }\n+};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567837440",
      "id" : 567837440,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzgzNzQ0MA==",
      "original_commit_id" : "2fac0136138012ae26c8e12ef77e9486ad5cd831",
      "original_line" : 226,
      "original_position" : 56,
      "original_start_line" : 208,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 580367672,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567837440",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567839245"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567839245"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Consider joining these lines:\r\n\r\n```suggestion\r\n                if (AcceptToMemoryPoolWithTime(chainparams, pool, tx, nTime,\r\n                                               false /* bypass_limits */,\r\n                                               false /* test_accept */).m_accepted) {\r\n```",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-02-01T13:50:44Z",
      "diff_hunk" : "@@ -5013,13 +5084,12 @@ bool LoadMempool(CTxMemPool& pool)\n             if (amountdelta) {\n                 pool.PrioritiseTransaction(tx->GetHash(), amountdelta);\n             }\n-            TxValidationState state;\n             if (nTime > nNow - nExpiryTimeout) {\n                 LOCK(cs_main);\n-                AcceptToMemoryPoolWithTime(chainparams, pool, state, tx, nTime,\n-                                           nullptr /* plTxnReplaced */, false /* bypass_limits */,\n-                                           false /* test_accept */);\n-                if (state.IsValid()) {\n+                const MempoolAcceptResult result = AcceptToMemoryPoolWithTime(chainparams, pool, tx, nTime,\n+                                                                                false /* bypass_limits */,\n+                                                                                false /* test_accept */);\n+                if (result.m_accepted) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567839245",
      "id" : 567839245,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzgzOTI0NQ==",
      "original_commit_id" : "2fac0136138012ae26c8e12ef77e9486ad5cd831",
      "original_line" : 5092,
      "original_position" : 387,
      "original_start_line" : 5089,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 580367672,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567839245",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567843710"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567843710"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oops. You're right. Ignore this!",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-02-01T13:57:25Z",
      "diff_hunk" : "@@ -922,67 +924,77 @@ static RPCHelpMan testmempoolaccept()\n         UniValueType(), // VNUM or VSTR, checked inside AmountFromValue()\n     });\n \n-    if (request.params[0].get_array().size() != 1) {\n-        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Array must contain exactly one raw transaction for now\");\n-    }\n-\n-    CMutableTransaction mtx;\n-    if (!DecodeHexTx(mtx, request.params[0].get_array()[0].get_str())) {\n-        throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed. Make sure the tx has at least one input.\");\n-    }\n-    CTransactionRef tx(MakeTransactionRef(std::move(mtx)));\n-\n+    const UniValue raw_transactions = request.params[0].get_array();\n     const CFeeRate max_raw_tx_fee_rate = request.params[1].isNull() ?\n                                              DEFAULT_MAX_RAW_TX_FEE_RATE :\n                                              CFeeRate(AmountFromValue(request.params[1]));\n \n     CTxMemPool& mempool = EnsureMemPool(request.context);\n-    int64_t virtual_size = GetVirtualTransactionSize(*tx);\n-    CAmount max_raw_tx_fee = max_raw_tx_fee_rate.GetFee(virtual_size);\n-\n-    UniValue result(UniValue::VARR);\n-    UniValue result_0(UniValue::VOBJ);\n-    result_0.pushKV(\"txid\", tx->GetHash().GetHex());\n-    result_0.pushKV(\"wtxid\", tx->GetWitnessHash().GetHex());\n+    std::vector<CTransactionRef> txns;\n \n-    TxValidationState state;\n-    bool test_accept_res;\n-    CAmount fee{0};\n-    {\n-        LOCK(cs_main);\n-        test_accept_res = AcceptToMemoryPool(mempool, state, std::move(tx),\n-            nullptr /* plTxnReplaced */, false /* bypass_limits */, /* test_accept */ true, &fee);\n+    for (unsigned int i = 0; i < raw_transactions.size(); ++i) {\n+        CMutableTransaction mtx;\n+        if (!DecodeHexTx(mtx, raw_transactions[i].get_str())) {\n+            throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed\");\n+        }\n+        txns.emplace_back(MakeTransactionRef(std::move(mtx)));\n     }\n \n-    // Check that fee does not exceed maximum fee\n-    if (test_accept_res && max_raw_tx_fee && fee > max_raw_tx_fee) {\n-        result_0.pushKV(\"allowed\", false);\n-        result_0.pushKV(\"reject-reason\", \"max-fee-exceeded\");\n-        result.push_back(std::move(result_0));\n-        return result;\n+    std::vector<MempoolAcceptResult> validation_results;\n+    if (txns.size() == 1) {\n+        validation_results.emplace_back(WITH_LOCK(cs_main,\n+            return AcceptToMemoryPool(mempool, txns[0], false /* bypass_limits */, true /* test_accept */)));\n+    } else {\n+        validation_results = WITH_LOCK(cs_main, return ProcessNewPackage(mempool, txns, true));\n     }\n-    result_0.pushKV(\"allowed\", test_accept_res);\n \n-    // Only return the fee and vsize if the transaction would pass ATMP.\n-    // These can be used to calculate the feerate.\n-    if (test_accept_res) {\n-        result_0.pushKV(\"vsize\", virtual_size);\n-        UniValue fees(UniValue::VOBJ);\n-        fees.pushKV(\"base\", ValueFromAmount(fee));\n-        result_0.pushKV(\"fees\", fees);\n-    } else {\n-        if (state.IsInvalid()) {\n-            if (state.GetResult() == TxValidationResult::TX_MISSING_INPUTS) {\n-                result_0.pushKV(\"reject-reason\", \"missing-inputs\");\n+    auto tx_accepted = [](MempoolAcceptResult& res) { return res.m_accepted; };\n+    const bool all_valid = std::all_of(validation_results.begin(), validation_results.end(), tx_accepted);\n+    // ProcessNewPackage should return a MempoolAcceptResult per transaction\n+    // or exactly 1 for the first error that occurs.\n+    CHECK_NONFATAL(all_valid || validation_results.size() == 1);\n+\n+    // TODO: Report absurd fees for packages.\n+\n+    UniValue result(UniValue::VARR);\n+    if (all_valid) {\n+        for (unsigned int i = 0; i < validation_results.size(); ++i) {\n+            UniValue result_inner(UniValue::VOBJ);\n+            const CTransaction tx = *txns[i];\n+            result_inner.pushKV(\"txid\", tx.GetHash().GetHex());\n+            result_inner.pushKV(\"wtxid\", tx.GetWitnessHash().GetHex());\n+\n+            const CAmount fee = validation_results[i].m_base_fees.value();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567843710",
      "id" : 567843710,
      "in_reply_to_id" : 565567920,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Nzg0MzcxMA==",
      "original_commit_id" : "70f84b22199cd0afffd12ea8e8934d22b0f0c7f4",
      "original_line" : 967,
      "original_position" : 106,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : null,
      "pull_request_review_id" : 580367672,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567843710",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567852656"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567852656"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    TxValidationState& state = ws.m_state;\r\n```",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-02-01T14:10:32Z",
      "diff_hunk" : "@@ -556,12 +568,12 @@ bool MemPoolAccept::PreChecks(ATMPArgs& args, Workspace& ws)\n     const uint256& hash = ws.m_hash;\n \n     // Copy/alias what we need out of args\n-    TxValidationState &state = args.m_state;\n     const int64_t nAcceptTime = args.m_accept_time;\n     const bool bypass_limits = args.m_bypass_limits;\n     std::vector<COutPoint>& coins_to_uncache = args.m_coins_to_uncache;\n \n     // Alias what we need out of ws\n+    TxValidationState &state = ws.m_state;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567852656",
      "id" : 567852656,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Nzg1MjY1Ng==",
      "original_commit_id" : "2fac0136138012ae26c8e12ef77e9486ad5cd831",
      "original_line" : 576,
      "original_position" : 131,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 580388483,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567852656",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567853147"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567853147"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    TxValidationState& state = ws.m_state;\r\n```",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-02-01T14:11:12Z",
      "diff_hunk" : "@@ -923,11 +938,10 @@ bool MemPoolAccept::PreChecks(ATMPArgs& args, Workspace& ws)\n     return true;\n }\n \n-bool MemPoolAccept::PolicyScriptChecks(ATMPArgs& args, const Workspace& ws, PrecomputedTransactionData& txdata)\n+bool MemPoolAccept::PolicyScriptChecks(const ATMPArgs& args, Workspace& ws, PrecomputedTransactionData& txdata)\n {\n     const CTransaction& tx = *ws.m_ptx;\n-\n-    TxValidationState &state = args.m_state;\n+    TxValidationState &state = ws.m_state;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567853147",
      "id" : 567853147,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Nzg1MzE0Nw==",
      "original_commit_id" : "2fac0136138012ae26c8e12ef77e9486ad5cd831",
      "original_line" : 944,
      "original_position" : 190,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 580388483,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567853147",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567853236"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567853236"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    TxValidationState& state = ws.m_state;\r\n```",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-02-01T14:11:21Z",
      "diff_hunk" : "@@ -950,12 +964,11 @@ bool MemPoolAccept::PolicyScriptChecks(ATMPArgs& args, const Workspace& ws, Prec\n     return true;\n }\n \n-bool MemPoolAccept::ConsensusScriptChecks(ATMPArgs& args, const Workspace& ws, PrecomputedTransactionData& txdata)\n+bool MemPoolAccept::ConsensusScriptChecks(const ATMPArgs& args, Workspace& ws, PrecomputedTransactionData& txdata)\n {\n     const CTransaction& tx = *ws.m_ptx;\n     const uint256& hash = ws.m_hash;\n-\n-    TxValidationState &state = args.m_state;\n+    TxValidationState &state = ws.m_state;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567853236",
      "id" : 567853236,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Nzg1MzIzNg==",
      "original_commit_id" : "2fac0136138012ae26c8e12ef77e9486ad5cd831",
      "original_line" : 971,
      "original_position" : 205,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 580388483,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567853236",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567853513"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567853513"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    TxValidationState& state = ws.m_state;\r\n```",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-02-01T14:11:48Z",
      "diff_hunk" : "@@ -982,11 +995,11 @@ bool MemPoolAccept::ConsensusScriptChecks(ATMPArgs& args, const Workspace& ws, P\n     return true;\n }\n \n-bool MemPoolAccept::Finalize(ATMPArgs& args, Workspace& ws)\n+bool MemPoolAccept::Finalize(const ATMPArgs& args, Workspace& ws)\n {\n     const CTransaction& tx = *ws.m_ptx;\n     const uint256& hash = ws.m_hash;\n-    TxValidationState &state = args.m_state;\n+    TxValidationState &state = ws.m_state;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567853513",
      "id" : 567853513,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Nzg1MzUxMw==",
      "original_commit_id" : "2fac0136138012ae26c8e12ef77e9486ad5cd831",
      "original_line" : 1002,
      "original_position" : 219,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 580388483,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567853513",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567854054"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567854054"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Consider changing this to `ws` to match parameter names in the other functions.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-02-01T14:12:34Z",
      "diff_hunk" : "@@ -1029,46 +1041,86 @@ bool MemPoolAccept::Finalize(ATMPArgs& args, Workspace& ws)\n     return true;\n }\n \n-bool MemPoolAccept::AcceptSingleTransaction(const CTransactionRef& ptx, ATMPArgs& args)\n+MempoolAcceptResult MemPoolAccept::AcceptSingleTransaction(const CTransactionRef& ptx, ATMPArgs& args)\n {\n     AssertLockHeld(cs_main);\n     LOCK(m_pool.cs); // mempool \"read lock\" (held through GetMainSignals().TransactionAddedToMempool())\n \n     Workspace workspace(ptx);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567854054",
      "id" : 567854054,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Nzg1NDA1NA==",
      "original_commit_id" : "2fac0136138012ae26c8e12ef77e9486ad5cd831",
      "original_line" : 1049,
      "original_position" : 243,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 580388483,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567854054",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567856457"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567856457"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This seems to be the odd one out in ATMPArgs, now that all of the others are const. Any reason that this one shouldn't live in Workspace?",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-02-01T14:16:09Z",
      "diff_hunk" : "@@ -474,11 +481,13 @@ class MemPoolAccept\n          */\n         std::vector<COutPoint>& m_coins_to_uncache;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567856457",
      "id" : 567856457,
      "line" : 598,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Nzg1NjQ1Nw==",
      "original_commit_id" : "2fac0136138012ae26c8e12ef77e9486ad5cd831",
      "original_line" : 598,
      "original_position" : 67,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 146,
      "pull_request_review_id" : 580388483,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567856457",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567860224"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567860224"
         }
      },
      "author_association" : "MEMBER",
      "body" : "There's no need to set `coin` in this failure case. From the interface definition in `CCoinsView::GetCoin`:\r\n\r\n> When false is returned, coin's value is unspecified.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-02-01T14:21:19Z",
      "diff_hunk" : "@@ -905,19 +905,48 @@ bool CTxMemPool::HasNoInputsOf(const CTransaction &tx) const\n CCoinsViewMemPool::CCoinsViewMemPool(CCoinsView* baseIn, const CTxMemPool& mempoolIn) : CCoinsViewBacked(baseIn), mempool(mempoolIn) { }\n \n bool CCoinsViewMemPool::GetCoin(const COutPoint &outpoint, Coin &coin) const {\n+    // Check to see if the inputs are spent by a tx being considered for a package.\n+    // It's possible that a package spends entries in the mempool, and this would\n+    // only be reflected in the cache_package_remove.\n+    if (auto it = cache_package_remove.find(outpoint); it != cache_package_remove.end()) {\n+        coin = it->second;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567860224",
      "id" : 567860224,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Nzg2MDIyNA==",
      "original_commit_id" : "2fac0136138012ae26c8e12ef77e9486ad5cd831",
      "original_line" : 912,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 580388483,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567860224",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567861603"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567861603"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You can just use `std::map.count()` here since you don't actually need the value of the coin.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-02-01T14:23:18Z",
      "diff_hunk" : "@@ -905,19 +905,48 @@ bool CTxMemPool::HasNoInputsOf(const CTransaction &tx) const\n CCoinsViewMemPool::CCoinsViewMemPool(CCoinsView* baseIn, const CTxMemPool& mempoolIn) : CCoinsViewBacked(baseIn), mempool(mempoolIn) { }\n \n bool CCoinsViewMemPool::GetCoin(const COutPoint &outpoint, Coin &coin) const {\n+    // Check to see if the inputs are spent by a tx being considered for a package.\n+    // It's possible that a package spends entries in the mempool, and this would\n+    // only be reflected in the cache_package_remove.\n+    if (auto it = cache_package_remove.find(outpoint); it != cache_package_remove.end()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567861603",
      "id" : 567861603,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Nzg2MTYwMw==",
      "original_commit_id" : "2fac0136138012ae26c8e12ef77e9486ad5cd831",
      "original_line" : 911,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 580388483,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567861603",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567863028"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567863028"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Remove \", and it cannot have spent entries\". That's vestigial from when a `CCoins` objects was returned for the full transaction.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-02-01T14:25:15Z",
      "diff_hunk" : "@@ -905,19 +905,48 @@ bool CTxMemPool::HasNoInputsOf(const CTransaction &tx) const\n CCoinsViewMemPool::CCoinsViewMemPool(CCoinsView* baseIn, const CTxMemPool& mempoolIn) : CCoinsViewBacked(baseIn), mempool(mempoolIn) { }\n \n bool CCoinsViewMemPool::GetCoin(const COutPoint &outpoint, Coin &coin) const {\n+    // Check to see if the inputs are spent by a tx being considered for a package.\n+    // It's possible that a package spends entries in the mempool, and this would\n+    // only be reflected in the cache_package_remove.\n+    if (auto it = cache_package_remove.find(outpoint); it != cache_package_remove.end()) {\n+        coin = it->second;\n+        return false;\n+    }\n+\n+    // Check to see if the inputs are in a tx being considered for a package.\n+    // These Coins would not be available in the mempool or underlying CoinsView.\n+    if (auto it = cache_package_add.find(outpoint); it != cache_package_add.end()) {\n+        coin = it->second;\n+        return true;\n+    }\n+\n     // If an entry in the mempool exists, always return that one, as it's guaranteed to never\n-    // conflict with the underlying cache, and it cannot have pruned entries (as it contains full)\n-    // transactions. First checking the underlying cache risks returning a pruned entry instead.\n+    // conflict with the underlying cache, and it cannot have spent entries.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567863028",
      "id" : 567863028,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Nzg2MzAyOA==",
      "original_commit_id" : "2fac0136138012ae26c8e12ef77e9486ad5cd831",
      "original_line" : 924,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 580388483,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567863028",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567867011"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567867011"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Switching the logic ordering here is a little confusing. I'd suggest leaving it as it was.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-02-01T14:30:16Z",
      "diff_hunk" : "@@ -905,19 +905,48 @@ bool CTxMemPool::HasNoInputsOf(const CTransaction &tx) const\n CCoinsViewMemPool::CCoinsViewMemPool(CCoinsView* baseIn, const CTxMemPool& mempoolIn) : CCoinsViewBacked(baseIn), mempool(mempoolIn) { }\n \n bool CCoinsViewMemPool::GetCoin(const COutPoint &outpoint, Coin &coin) const {\n+    // Check to see if the inputs are spent by a tx being considered for a package.\n+    // It's possible that a package spends entries in the mempool, and this would\n+    // only be reflected in the cache_package_remove.\n+    if (auto it = cache_package_remove.find(outpoint); it != cache_package_remove.end()) {\n+        coin = it->second;\n+        return false;\n+    }\n+\n+    // Check to see if the inputs are in a tx being considered for a package.\n+    // These Coins would not be available in the mempool or underlying CoinsView.\n+    if (auto it = cache_package_add.find(outpoint); it != cache_package_add.end()) {\n+        coin = it->second;\n+        return true;\n+    }\n+\n     // If an entry in the mempool exists, always return that one, as it's guaranteed to never\n-    // conflict with the underlying cache, and it cannot have pruned entries (as it contains full)\n-    // transactions. First checking the underlying cache risks returning a pruned entry instead.\n+    // conflict with the underlying cache, and it cannot have spent entries.\n     CTransactionRef ptx = mempool.get(outpoint.hash);\n-    if (ptx) {\n-        if (outpoint.n < ptx->vout.size()) {\n-            coin = Coin(ptx->vout[outpoint.n], MEMPOOL_HEIGHT, false);\n-            return true;\n-        } else {\n-            return false;\n-        }\n+\n+    // Check the underlying CoinsView.\n+    if (!ptx) return base->GetCoin(outpoint, coin);\n+\n+    // \"Create\" a Coin from a mempool transaction output.\n+    if (outpoint.n < ptx->vout.size()) {\n+        coin = Coin(ptx->vout[outpoint.n], MEMPOOL_HEIGHT, false);\n+        return true;\n+    }\n+    return false;\n+}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567867011",
      "id" : 567867011,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Nzg2NzAxMQ==",
      "original_commit_id" : "2fac0136138012ae26c8e12ef77e9486ad5cd831",
      "original_line" : 961,
      "original_position" : 41,
      "original_start_line" : 927,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 580388483,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567867011",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567867414"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567867414"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Presumably `tx->IsCoinBase()` will always be false here? We can't accept coinbase transactions into our mempool.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-02-01T14:30:48Z",
      "diff_hunk" : "@@ -905,19 +905,48 @@ bool CTxMemPool::HasNoInputsOf(const CTransaction &tx) const\n CCoinsViewMemPool::CCoinsViewMemPool(CCoinsView* baseIn, const CTxMemPool& mempoolIn) : CCoinsViewBacked(baseIn), mempool(mempoolIn) { }\n \n bool CCoinsViewMemPool::GetCoin(const COutPoint &outpoint, Coin &coin) const {\n+    // Check to see if the inputs are spent by a tx being considered for a package.\n+    // It's possible that a package spends entries in the mempool, and this would\n+    // only be reflected in the cache_package_remove.\n+    if (auto it = cache_package_remove.find(outpoint); it != cache_package_remove.end()) {\n+        coin = it->second;\n+        return false;\n+    }\n+\n+    // Check to see if the inputs are in a tx being considered for a package.\n+    // These Coins would not be available in the mempool or underlying CoinsView.\n+    if (auto it = cache_package_add.find(outpoint); it != cache_package_add.end()) {\n+        coin = it->second;\n+        return true;\n+    }\n+\n     // If an entry in the mempool exists, always return that one, as it's guaranteed to never\n-    // conflict with the underlying cache, and it cannot have pruned entries (as it contains full)\n-    // transactions. First checking the underlying cache risks returning a pruned entry instead.\n+    // conflict with the underlying cache, and it cannot have spent entries.\n     CTransactionRef ptx = mempool.get(outpoint.hash);\n-    if (ptx) {\n-        if (outpoint.n < ptx->vout.size()) {\n-            coin = Coin(ptx->vout[outpoint.n], MEMPOOL_HEIGHT, false);\n-            return true;\n-        } else {\n-            return false;\n-        }\n+\n+    // Check the underlying CoinsView.\n+    if (!ptx) return base->GetCoin(outpoint, coin);\n+\n+    // \"Create\" a Coin from a mempool transaction output.\n+    if (outpoint.n < ptx->vout.size()) {\n+        coin = Coin(ptx->vout[outpoint.n], MEMPOOL_HEIGHT, false);\n+        return true;\n+    }\n+    return false;\n+}\n+\n+void CCoinsViewMemPool::AddPackageTransaction(const CTransactionRef& tx) {\n+    package_txids.insert(tx->GetHash());\n+    // Coins spent by this transaction\n+    for (auto input : tx->vin) {\n+        Coin spent_coin;\n+        GetCoin(input.prevout, spent_coin);\n+        cache_package_remove.emplace(input.prevout, spent_coin);\n+    }\n+    // Coins added by this transaction\n+    for (unsigned int i = 0; i < tx->vout.size(); ++i) {\n+        cache_package_add.emplace(COutPoint(tx->GetHash(), i), Coin(tx->vout[i], MEMPOOL_HEIGHT, tx->IsCoinBase()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567867414",
      "id" : 567867414,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Nzg2NzQxNA==",
      "original_commit_id" : "2fac0136138012ae26c8e12ef77e9486ad5cd831",
      "original_line" : 948,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 580388483,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567867414",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567868462"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567868462"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It looks like this (and by extension, `package_txids`) is unused.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-02-01T14:32:24Z",
      "diff_hunk" : "@@ -880,15 +880,28 @@ class CTxMemPool\n  * It also allows you to sign a double-spend directly in\n  * signrawtransactionwithkey and signrawtransactionwithwallet,\n  * as long as the conflicting transaction is not yet confirmed.\n+ * It can also serve as temporary scratch space for some set\n+ * of transactions (i.e. as a member of MemPoolAccept to validate\n+ * packages) and tracks the Coins added and removed by them.\n  */\n class CCoinsViewMemPool : public CCoinsViewBacked\n {\n protected:\n     const CTxMemPool& mempool;\n+    std::map<COutPoint, Coin> cache_package_add;\n+    std::map<COutPoint, Coin> cache_package_remove;\n+    std::set<uint256> package_txids;\n \n public:\n     CCoinsViewMemPool(CCoinsView* baseIn, const CTxMemPool& mempoolIn);\n-    bool GetCoin(const COutPoint &outpoint, Coin &coin) const override;\n+    bool GetCoin(const COutPoint& outpoint, Coin& coin) const override;\n+    void AddPackageTransaction(const CTransactionRef& tx);\n+    bool PackageContains(uint256 txid) const {\n+        return package_txids.count(txid) != 0;\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567868462",
      "id" : 567868462,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Nzg2ODQ2Mg==",
      "original_commit_id" : "2fac0136138012ae26c8e12ef77e9486ad5cd831",
      "original_line" : 901,
      "original_position" : 23,
      "original_start_line" : 899,
      "path" : "src/txmempool.h",
      "position" : null,
      "pull_request_review_id" : 580388483,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567868462",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567869882"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567869882"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What's the reason for having two maps here? Why not just keep one, add to it when a new coin is created and remove from it when the coin is spent?",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-02-01T14:34:17Z",
      "diff_hunk" : "@@ -880,15 +880,28 @@ class CTxMemPool\n  * It also allows you to sign a double-spend directly in\n  * signrawtransactionwithkey and signrawtransactionwithwallet,\n  * as long as the conflicting transaction is not yet confirmed.\n+ * It can also serve as temporary scratch space for some set\n+ * of transactions (i.e. as a member of MemPoolAccept to validate\n+ * packages) and tracks the Coins added and removed by them.\n  */\n class CCoinsViewMemPool : public CCoinsViewBacked\n {\n protected:\n     const CTxMemPool& mempool;\n+    std::map<COutPoint, Coin> cache_package_add;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567869882",
      "id" : 567869882,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Nzg2OTg4Mg==",
      "original_commit_id" : "2fac0136138012ae26c8e12ef77e9486ad5cd831",
      "original_line" : 891,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : null,
      "pull_request_review_id" : 580388483,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567869882",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567875231"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567875231"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It seems a bit odd that the first time `PreChecks()` is called, we're calling `SetBackend()` when the backend is already set in the constructor for `MemPoolAccept`, and that we repeatedly call `m_view.SetBackend(m_viewmempool)`\r\n\r\nI suggest that in `MemPoolAccept::MemPoolAccept()`:\r\n\r\n- set `m_viewmempool` to be backed by `m_dummy`\r\n- set `m_view` to be backed by `m_viewmempool`\r\n\r\nand then here, remove the `m_view.SetBackend(m_viewmempool)` call.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-02-01T14:41:34Z",
      "diff_hunk" : "@@ -641,6 +653,14 @@ bool MemPoolAccept::PreChecks(ATMPArgs& args, Workspace& ws)\n \n     LockPoints lp;\n     m_view.SetBackend(m_viewmempool);\n+    m_viewmempool.SetBackend(::ChainstateActive().CoinsTip());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567875231",
      "id" : 567875231,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Nzg3NTIzMQ==",
      "original_commit_id" : "2fac0136138012ae26c8e12ef77e9486ad5cd831",
      "original_line" : 656,
      "original_position" : 139,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 580388483,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567875231",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567887448"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567887448"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this whole comment about \"must keep pool.cs\" is obsolete, since `pool.cs` is kept throughout the `MemPoolAccept` run.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-02-01T14:57:05Z",
      "diff_hunk" : "@@ -671,25 +691,20 @@ bool MemPoolAccept::PreChecks(ATMPArgs& args, Workspace& ws)\n     // we have all inputs cached now, so switch back to dummy (to protect\n     // against bugs where we pull more inputs from disk that miss being added\n     // to coins_to_uncache)\n-    m_view.SetBackend(m_dummy);\n+    m_viewmempool.SetBackend(m_dummy);\n \n     // Only accept BIP68 sequence locked transactions that can be mined in the next\n     // block; we don't want our mempool filled up with transactions that can't\n-    // be mined yet.\n-    // Must keep pool.cs for this unless we change CheckSequenceLocks to take a\n-    // CoinsViewCache instead of create its own\n-    if (!CheckSequenceLocks(m_pool, tx, STANDARD_LOCKTIME_VERIFY_FLAGS, &lp))\n+    // be mined yet. Must keep pool.cs because this uses a CCoinsViewMemPool.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567887448",
      "id" : 567887448,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Nzg4NzQ0OA==",
      "original_commit_id" : "2fac0136138012ae26c8e12ef77e9486ad5cd831",
      "original_line" : 698,
      "original_position" : 163,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 580388483,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567887448",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567911483"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567911483"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "woah o.O nice catch. I should add a test for absurd fees in package ð ",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-02-01T15:27:46Z",
      "diff_hunk" : "@@ -922,60 +924,77 @@ static RPCHelpMan testmempoolaccept()\n         UniValueType(), // VNUM or VSTR, checked inside AmountFromValue()\n     });\n \n-    if (request.params[0].get_array().size() != 1) {\n-        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Array must contain exactly one raw transaction for now\");\n-    }\n-\n-    CMutableTransaction mtx;\n-    if (!DecodeHexTx(mtx, request.params[0].get_array()[0].get_str())) {\n-        throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed. Make sure the tx has at least one input.\");\n-    }\n-    CTransactionRef tx(MakeTransactionRef(std::move(mtx)));\n-\n+    const UniValue raw_transactions = request.params[0].get_array();\n     const CFeeRate max_raw_tx_fee_rate = request.params[1].isNull() ?\n                                              DEFAULT_MAX_RAW_TX_FEE_RATE :\n                                              CFeeRate(AmountFromValue(request.params[1]));\n \n     CTxMemPool& mempool = EnsureMemPool(request.context);\n-    int64_t virtual_size = GetVirtualTransactionSize(*tx);\n-    CAmount max_raw_tx_fee = max_raw_tx_fee_rate.GetFee(virtual_size);\n+    std::vector<CTransactionRef> txns;\n+\n+    for (unsigned int i = 0; i < raw_transactions.size(); ++i) {\n+        CMutableTransaction mtx;\n+        if (!DecodeHexTx(mtx, raw_transactions[i].get_str())) {\n+            throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed\");\n+        }\n+        txns.emplace_back(MakeTransactionRef(std::move(mtx)));\n+    }\n+\n+    std::vector<MempoolAcceptResult> validation_results;\n+    if (txns.size() == 1) {\n+        validation_results.emplace_back(WITH_LOCK(cs_main,\n+            return AcceptToMemoryPool(mempool, txns[0], false /* bypass_limits */, true /* test_accept */)));\n+    } else {\n+        validation_results = WITH_LOCK(cs_main, return ProcessNewPackage(mempool, txns, true));\n+    }\n+\n+    auto tx_accepted = [](MempoolAcceptResult& res) { return res.m_accepted; };\n+    const bool all_valid = std::all_of(validation_results.begin(), validation_results.end(), tx_accepted);\n+    // ProcessNewPackage should return a MempoolAcceptResult per transaction\n+    // or exactly 1 for the first error that occurs.\n+    CHECK_NONFATAL(all_valid || validation_results.size() == 1);\n+\n+    // TODO: Report absurd fees for packages.\n \n     UniValue result(UniValue::VARR);\n-    UniValue result_0(UniValue::VOBJ);\n-    result_0.pushKV(\"txid\", tx->GetHash().GetHex());\n-    result_0.pushKV(\"wtxid\", tx->GetWitnessHash().GetHex());\n-\n-    MempoolAcceptResult accept_result = WITH_LOCK(cs_main,\n-\t\t    return AcceptToMemoryPool(mempool, std::move(tx), false /* bypass_limits */, true /* test_accept */));\n-    const bool test_accept_res = accept_result.m_accepted;\n-\n-    // Only return the fee and vsize if the transaction would pass ATMP.\n-    // These can be used to calculate the feerate.\n-    if (test_accept_res) {\n-        const CAmount fee = accept_result.m_base_fees.value();\n-        // Check that fee does not exceed maximum fee\n-        if (max_raw_tx_fee && fee > max_raw_tx_fee) {\n-            result_0.pushKV(\"allowed\", false);\n-            result_0.pushKV(\"reject-reason\", \"max-fee-exceeded\");\n-            result.push_back(std::move(result_0));\n-            return result;\n+    if (all_valid) {\n+        for (unsigned int i = 0; i < validation_results.size(); ++i) {\n+            UniValue result_inner(UniValue::VOBJ);\n+            const CTransaction tx = *txns[i];\n+            result_inner.pushKV(\"txid\", tx.GetHash().GetHex());\n+            result_inner.pushKV(\"wtxid\", tx.GetWitnessHash().GetHex());\n+\n+            const CAmount fee = validation_results[i].m_base_fees.value();\n+            const int64_t virtual_size = GetVirtualTransactionSize(tx);\n+            const CAmount max_raw_tx_fee = max_raw_tx_fee_rate.GetFee(virtual_size);\n+            // Check that fee does not exceed maximum fee\n+            if (max_raw_tx_fee && fee > max_raw_tx_fee) {\n+                result_inner.pushKV(\"allowed\", false);\n+                result_inner.pushKV(\"reject-reason\", \"max-fee-exceeded\");\n+                result_inner.push_back(std::move(result_inner));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567911483",
      "id" : 567911483,
      "in_reply_to_id" : 567226540,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzkxMTQ4Mw==",
      "original_commit_id" : "048ef0a7e62cca10c588b451c9060e7846ac398b",
      "original_line" : 974,
      "original_position" : 101,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : null,
      "pull_request_review_id" : 580468003,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567911483",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567916643"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567916643"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah I'm mostly trying to replicate the current usage, which is:\r\n1. ATMP returns a boolean. we check that first. (equivalent = `m_accepted`)\r\n2. if the boolean is false, we care about the TxValidationState `state`. I'm not sure if `state.IsValid()` is ever true when the boolean is false, but there is a [code path](https://github.com/bitcoin/bitcoin/blob/2c0fc856a6b0c82c5dddbbaee417171577514507/src/node/transaction.cpp#L24) for it, so I don't want to try to change it in a refactor.\r\n3. If boolean true, we sometimes look at fees and stuff.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-02-01T15:34:14Z",
      "diff_hunk" : "@@ -189,12 +189,38 @@ void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune);\n /** Prune block files up to a given height */\n void PruneBlockFilesManual(int nManualPruneHeight);\n \n-/** (try to) add transaction to memory pool\n- * plTxnReplaced will be appended to with all transactions replaced from mempool\n- * @param[out] fee_out optional argument to return tx fee to the caller **/\n-bool AcceptToMemoryPool(CTxMemPool& pool, TxValidationState &state, const CTransactionRef &tx,\n-                        std::list<CTransactionRef>* plTxnReplaced,\n-                        bool bypass_limits, bool test_accept=false, CAmount* fee_out=nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+/**\n+* Validation result for a single transaction mempool acceptance.\n+* When m_accepted = true, m_replaced_transactions contains a list\n+* of replaced transactions and m_base_fees contains the tx fees.\n+*/\n+struct MempoolAcceptResult {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567916643",
      "id" : 567916643,
      "in_reply_to_id" : 567223619,
      "line" : 190,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzkxNjY0Mw==",
      "original_commit_id" : "b76910ebd4d8a07534e145c498c7f7d0ce297ccd",
      "original_line" : 190,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 11,
      "pull_request_review_id" : 580474837,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567916643",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567918360"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567918360"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I want to generate to deterministic address so I don't need to use wallet",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-02-01T15:36:24Z",
      "diff_hunk" : "@@ -0,0 +1,193 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"RPCs that handle raw transaction packages.\"\"\"\n+\n+from decimal import Decimal\n+from io import BytesIO\n+\n+from test_framework.address import ADDRESS_BCRT1_P2WSH_OP_TRUE\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    BIP125_SEQUENCE_NUMBER,\n+    COIN,\n+    CTransaction,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+    hex_str_to_bytes,\n+)\n+\n+class RPCPackagesTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+        self.setup_clean_chain = True\n+\n+    def run_test(self):\n+        self.log.info(\"Generate blocks to create UTXOs\")\n+        node = self.nodes[0]\n+        self.privkeys = [node.get_deterministic_priv_key().key]\n+        self.address = node.get_deterministic_priv_key().address\n+        self.coins = []\n+        # The last 100 coinbase transactions are premature\n+        for b in node.generatetoaddress(120, self.address)[:20]:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567918360",
      "id" : 567918360,
      "in_reply_to_id" : 567471786,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzkxODM2MA==",
      "original_commit_id" : "2fac0136138012ae26c8e12ef77e9486ad5cd831",
      "original_line" : 39,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "test/functional/rpc_packages.py",
      "position" : null,
      "pull_request_review_id" : 580477162,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567918360",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567928002"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567928002"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "We had a short discussion about it [here](https://github.com/bitcoin/bitcoin/pull/20833#discussion_r557185885). I think the main idea is to distinguish between a meaningless `fee`/`replaced_transactions` and a 0/empty one. It is \"guarded\" but technically the caller could still access them ð don't want them to do that by accident.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-02-01T15:48:00Z",
      "diff_hunk" : "@@ -189,12 +189,38 @@ void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune);\n /** Prune block files up to a given height */\n void PruneBlockFilesManual(int nManualPruneHeight);\n \n-/** (try to) add transaction to memory pool\n- * plTxnReplaced will be appended to with all transactions replaced from mempool\n- * @param[out] fee_out optional argument to return tx fee to the caller **/\n-bool AcceptToMemoryPool(CTxMemPool& pool, TxValidationState &state, const CTransactionRef &tx,\n-                        std::list<CTransactionRef>* plTxnReplaced,\n-                        bool bypass_limits, bool test_accept=false, CAmount* fee_out=nullptr) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+/**\n+* Validation result for a single transaction mempool acceptance.\n+* When m_accepted = true, m_replaced_transactions contains a list\n+* of replaced transactions and m_base_fees contains the tx fees.\n+*/\n+struct MempoolAcceptResult {\n+    bool m_accepted;\n+    TxValidationState m_state;\n+\n+    // Valid when m_accepted = true\n+    std::optional<std::list<CTransactionRef>> m_replaced_transactions;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567928002",
      "id" : 567928002,
      "in_reply_to_id" : 567222730,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzkyODAwMg==",
      "original_commit_id" : "b76910ebd4d8a07534e145c498c7f7d0ce297ccd",
      "original_line" : 199,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 580489635,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567928002",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567938951"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567938951"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Consider using range based loops here:\r\n\r\n```suggestion\r\n    for (Workspace& ws : workspaces) {\r\n        if (!PreChecks(args, ws)) {\r\n            return std::vector<MempoolAcceptResult> { MempoolAcceptResult(ws.m_state, ws.m_ptx) };\r\n        }\r\n        m_viewmempool.AddPackageTransaction(ws.m_ptx);\r\n    }\r\n\r\n    // TODO: Enforce package-level feerate and other policies before script checks.\r\n    for (Workspace& ws : workspaces) {\r\n        PrecomputedTransactionData txdata;\r\n\r\n        if (!PolicyScriptChecks(args, ws, txdata)) {\r\n            return std::vector<MempoolAcceptResult> { MempoolAcceptResult(ws.m_state, ws.m_ptx) };\r\n        }\r\n    }\r\n```",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-02-01T16:01:12Z",
      "diff_hunk" : "@@ -1029,46 +1041,86 @@ bool MemPoolAccept::Finalize(ATMPArgs& args, Workspace& ws)\n     return true;\n }\n \n-bool MemPoolAccept::AcceptSingleTransaction(const CTransactionRef& ptx, ATMPArgs& args)\n+MempoolAcceptResult MemPoolAccept::AcceptSingleTransaction(const CTransactionRef& ptx, ATMPArgs& args)\n {\n     AssertLockHeld(cs_main);\n     LOCK(m_pool.cs); // mempool \"read lock\" (held through GetMainSignals().TransactionAddedToMempool())\n \n     Workspace workspace(ptx);\n \n-    if (!PreChecks(args, workspace)) return false;\n+    if (!PreChecks(args, workspace)) return MempoolAcceptResult(workspace.m_state, workspace.m_ptx);\n \n     // Only compute the precomputed transaction data if we need to verify\n     // scripts (ie, other policy checks pass). We perform the inexpensive\n     // checks first and avoid hashing and signature verification unless those\n     // checks pass, to mitigate CPU exhaustion denial-of-service attacks.\n     PrecomputedTransactionData txdata;\n \n-    if (!PolicyScriptChecks(args, workspace, txdata)) return false;\n+    if (!PolicyScriptChecks(args, workspace, txdata)) return MempoolAcceptResult(workspace.m_state, workspace.m_ptx);\n \n-    if (!ConsensusScriptChecks(args, workspace, txdata)) return false;\n+    if (!ConsensusScriptChecks(args, workspace, txdata)) return MempoolAcceptResult(workspace.m_state, workspace.m_ptx);\n \n     // Tx was accepted, but not added\n-    if (args.m_test_accept) return true;\n+    if (args.m_test_accept) {\n+        return MempoolAcceptResult(workspace.m_state, std::move(workspace.m_replaced_transactions), workspace.m_base_fees);\n+    }\n \n-    if (!Finalize(args, workspace)) return false;\n+    if (!Finalize(args, workspace)) return MempoolAcceptResult(workspace.m_state, workspace.m_ptx);\n \n     GetMainSignals().TransactionAddedToMempool(ptx, m_pool.GetAndIncrementSequence());\n \n-    return true;\n+    return MempoolAcceptResult(workspace.m_state, std::move(workspace.m_replaced_transactions), workspace.m_base_fees);\n+}\n+\n+std::vector<MempoolAcceptResult> MemPoolAccept::AcceptMultipleTransactions(std::vector<CTransactionRef>& txns, ATMPArgs& args)\n+{\n+    AssertLockHeld(cs_main);\n+    std::vector<Workspace> workspaces{};\n+    workspaces.reserve(txns.size());\n+    std::transform(txns.begin(), txns.end(), std::back_inserter(workspaces), [](CTransactionRef& tx) {\n+        return Workspace(tx);\n+    });\n+\n+    LOCK(m_pool.cs);\n+    // Do all PreChecks first and fail fast to avoid running expensive script\n+    // checks when unnecessary.\n+    for (unsigned int i = 0; i < txns.size(); ++i) {\n+        Workspace& workspace = workspaces[i];\n+        if (!PreChecks(args, workspace)) {\n+            return std::vector<MempoolAcceptResult> { MempoolAcceptResult(workspace.m_state, workspace.m_ptx) };\n+        }\n+        m_viewmempool.AddPackageTransaction(txns[i]);\n+    }\n+\n+    // TODO: Enforce package-level feerate and other policies before script checks.\n+    for (unsigned int i = 0; i < txns.size(); ++i) {\n+        PrecomputedTransactionData txdata;\n+        Workspace& workspace = workspaces[i];\n+\n+        if (!PolicyScriptChecks(args, workspace, txdata)) {\n+            return std::vector<MempoolAcceptResult> { MempoolAcceptResult(workspace.m_state, workspace.m_ptx) };\n+        }\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567938951",
      "id" : 567938951,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzkzODk1MQ==",
      "original_commit_id" : "2fac0136138012ae26c8e12ef77e9486ad5cd831",
      "original_line" : 1303,
      "original_position" : 303,
      "original_start_line" : 1087,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 580388483,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567938951",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567942595"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567942595"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No need for the local temporary `chainparams`:\r\n\r\n```suggestion\r\n    MemPoolAccept::ATMPArgs args { Params(), GetTime(), false, coins_to_uncache, test_accept };\r\n```\r\n\r\nSame goes for `chainparams` var in `AcceptToMemoryPool()` if you want to change it.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-02-01T16:05:55Z",
      "diff_hunk" : "@@ -1080,15 +1132,34 @@ static bool AcceptToMemoryPoolWithTime(const CChainParams& chainparams, CTxMemPo\n     // After we've (potentially) uncached entries, ensure our coins cache is still within its size limits\n     BlockValidationState state_dummy;\n     ::ChainstateActive().FlushStateToDisk(chainparams, state_dummy, FlushStateMode::PERIODIC);\n-    return res;\n+    return result;\n+}\n+\n+MempoolAcceptResult AcceptToMemoryPool(CTxMemPool& pool, const CTransactionRef &tx, bool bypass_limits, bool test_accept)\n+{\n+    const CChainParams& chainparams = Params();\n+    return AcceptToMemoryPoolWithTime(chainparams, pool, tx, GetTime(), bypass_limits, test_accept);\n }\n \n-bool AcceptToMemoryPool(CTxMemPool& pool, TxValidationState &state, const CTransactionRef &tx,\n-                        std::list<CTransactionRef>* plTxnReplaced,\n-                        bool bypass_limits, bool test_accept, CAmount* fee_out)\n+std::vector<MempoolAcceptResult> ProcessNewPackage(CTxMemPool& pool, std::vector<CTransactionRef>& txns, bool test_accept)\n {\n+    AssertLockHeld(cs_main);\n+    assert(test_accept); // Only allow package accept dry-runs (testmempoolaccept RPC).\n+\n     const CChainParams& chainparams = Params();\n-    return AcceptToMemoryPoolWithTime(chainparams, pool, state, tx, GetTime(), plTxnReplaced, bypass_limits, test_accept, fee_out);\n+    std::vector<COutPoint> coins_to_uncache;\n+    MemPoolAccept::ATMPArgs args { chainparams, GetTime(), false, coins_to_uncache, test_accept };",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567942595",
      "id" : 567942595,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Nzk0MjU5NQ==",
      "original_commit_id" : "2fac0136138012ae26c8e12ef77e9486ad5cd831",
      "original_line" : 1315,
      "original_position" : 358,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 580388483,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567942595",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567952639"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567952639"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm not sure that I like the interface of passing back a CTransactionRef just for this failure case. I wonder if we should:\r\n\r\n- allow `m_accepted` to be tri-state {accepted, failed, not_fully_validated}. That can be achieved with a `std::optional<bool>`\r\n- return a `MempoolAcceptResult` for all transactions in the package where either:\r\n  - all are success\r\n  - one is fail and the rest are not_fully_validated\r\n- work out the txid of the failing transaction from its index in the vector.\r\n\r\nWhat do you think?",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-02-01T16:18:26Z",
      "diff_hunk" : "@@ -922,67 +924,77 @@ static RPCHelpMan testmempoolaccept()\n         UniValueType(), // VNUM or VSTR, checked inside AmountFromValue()\n     });\n \n-    if (request.params[0].get_array().size() != 1) {\n-        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Array must contain exactly one raw transaction for now\");\n-    }\n-\n-    CMutableTransaction mtx;\n-    if (!DecodeHexTx(mtx, request.params[0].get_array()[0].get_str())) {\n-        throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed. Make sure the tx has at least one input.\");\n-    }\n-    CTransactionRef tx(MakeTransactionRef(std::move(mtx)));\n-\n+    const UniValue raw_transactions = request.params[0].get_array();\n     const CFeeRate max_raw_tx_fee_rate = request.params[1].isNull() ?\n                                              DEFAULT_MAX_RAW_TX_FEE_RATE :\n                                              CFeeRate(AmountFromValue(request.params[1]));\n \n     CTxMemPool& mempool = EnsureMemPool(request.context);\n-    int64_t virtual_size = GetVirtualTransactionSize(*tx);\n-    CAmount max_raw_tx_fee = max_raw_tx_fee_rate.GetFee(virtual_size);\n-\n-    UniValue result(UniValue::VARR);\n-    UniValue result_0(UniValue::VOBJ);\n-    result_0.pushKV(\"txid\", tx->GetHash().GetHex());\n-    result_0.pushKV(\"wtxid\", tx->GetWitnessHash().GetHex());\n+    std::vector<CTransactionRef> txns;\n \n-    TxValidationState state;\n-    bool test_accept_res;\n-    CAmount fee{0};\n-    {\n-        LOCK(cs_main);\n-        test_accept_res = AcceptToMemoryPool(mempool, state, std::move(tx),\n-            nullptr /* plTxnReplaced */, false /* bypass_limits */, /* test_accept */ true, &fee);\n+    for (unsigned int i = 0; i < raw_transactions.size(); ++i) {\n+        CMutableTransaction mtx;\n+        if (!DecodeHexTx(mtx, raw_transactions[i].get_str())) {\n+            throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed\");\n+        }\n+        txns.emplace_back(MakeTransactionRef(std::move(mtx)));\n     }\n \n-    // Check that fee does not exceed maximum fee\n-    if (test_accept_res && max_raw_tx_fee && fee > max_raw_tx_fee) {\n-        result_0.pushKV(\"allowed\", false);\n-        result_0.pushKV(\"reject-reason\", \"max-fee-exceeded\");\n-        result.push_back(std::move(result_0));\n-        return result;\n+    std::vector<MempoolAcceptResult> validation_results;\n+    if (txns.size() == 1) {\n+        validation_results.emplace_back(WITH_LOCK(cs_main,\n+            return AcceptToMemoryPool(mempool, txns[0], false /* bypass_limits */, true /* test_accept */)));\n+    } else {\n+        validation_results = WITH_LOCK(cs_main, return ProcessNewPackage(mempool, txns, true));\n     }\n-    result_0.pushKV(\"allowed\", test_accept_res);\n \n-    // Only return the fee and vsize if the transaction would pass ATMP.\n-    // These can be used to calculate the feerate.\n-    if (test_accept_res) {\n-        result_0.pushKV(\"vsize\", virtual_size);\n-        UniValue fees(UniValue::VOBJ);\n-        fees.pushKV(\"base\", ValueFromAmount(fee));\n-        result_0.pushKV(\"fees\", fees);\n-    } else {\n-        if (state.IsInvalid()) {\n-            if (state.GetResult() == TxValidationResult::TX_MISSING_INPUTS) {\n-                result_0.pushKV(\"reject-reason\", \"missing-inputs\");\n+    auto tx_accepted = [](MempoolAcceptResult& res) { return res.m_accepted; };\n+    const bool all_valid = std::all_of(validation_results.begin(), validation_results.end(), tx_accepted);\n+    // ProcessNewPackage should return a MempoolAcceptResult per transaction\n+    // or exactly 1 for the first error that occurs.\n+    CHECK_NONFATAL(all_valid || validation_results.size() == 1);\n+\n+    // TODO: Report absurd fees for packages.\n+\n+    UniValue result(UniValue::VARR);\n+    if (all_valid) {\n+        for (unsigned int i = 0; i < validation_results.size(); ++i) {\n+            UniValue result_inner(UniValue::VOBJ);\n+            const CTransaction tx = *txns[i];\n+            result_inner.pushKV(\"txid\", tx.GetHash().GetHex());\n+            result_inner.pushKV(\"wtxid\", tx.GetWitnessHash().GetHex());\n+\n+            const CAmount fee = validation_results[i].m_base_fees.value();\n+            const int64_t virtual_size = GetVirtualTransactionSize(tx);\n+            const CAmount max_raw_tx_fee = max_raw_tx_fee_rate.GetFee(virtual_size);\n+            // Check that fee does not exceed maximum fee\n+            if (max_raw_tx_fee && fee > max_raw_tx_fee) {\n+                result_inner.pushKV(\"allowed\", false);\n+                result_inner.pushKV(\"reject-reason\", \"max-fee-exceeded\");\n+                result_inner.push_back(std::move(result_inner));\n             } else {\n-                result_0.pushKV(\"reject-reason\", strprintf(\"%s\", state.GetRejectReason()));\n+                result_inner.pushKV(\"allowed\", true);\n+                result_inner.pushKV(\"vsize\", virtual_size);\n+                UniValue fees(UniValue::VOBJ);\n+                fees.pushKV(\"base\", ValueFromAmount(fee));\n+                result_inner.pushKV(\"fees\", fees);\n             }\n+            result.push_back(std::move(result_inner));\n+        }\n+    } else {\n+        Assume(validation_results[0].m_failed_ptx);\n+        UniValue result_0(UniValue::VOBJ);\n+        result_0.pushKV(\"txid\", validation_results[0].m_failed_ptx->GetHash().GetHex());\n+        result_0.pushKV(\"wtxid\", validation_results[0].m_failed_ptx->GetWitnessHash().GetHex());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567952639",
      "id" : 567952639,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Nzk1MjYzOQ==",
      "original_commit_id" : "2fac0136138012ae26c8e12ef77e9486ad5cd831",
      "original_line" : 988,
      "original_position" : 128,
      "original_start_line" : 987,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : null,
      "pull_request_review_id" : 580388483,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567952639",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567998921"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567998921"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes, I don't like it either. The lifetime of `Workspace` ends when `MemPoolAccept::AcceptSingleTransaction()` returns, but the coins in `coins_to_uncache` are uncached in ATMP afterward. If it's appropriate to do coin-uncaching inside `MemPoolAccept::Accept()` functions, then we can move it?",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-02-01T17:17:42Z",
      "diff_hunk" : "@@ -474,11 +481,13 @@ class MemPoolAccept\n          */\n         std::vector<COutPoint>& m_coins_to_uncache;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r567998921",
      "id" : 567998921,
      "in_reply_to_id" : 567856457,
      "line" : 598,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Nzk5ODkyMQ==",
      "original_commit_id" : "2fac0136138012ae26c8e12ef77e9486ad5cd831",
      "original_line" : 598,
      "original_position" : 67,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 146,
      "pull_request_review_id" : 580583759,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/567998921",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r568003551"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568003551"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "We wouldn't be able to distinguish between a `missing-inputs` and a `conflict-in-package`. Perhaps that's desirable, but I felt this was simpler?",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-02-01T17:24:24Z",
      "diff_hunk" : "@@ -880,15 +880,28 @@ class CTxMemPool\n  * It also allows you to sign a double-spend directly in\n  * signrawtransactionwithkey and signrawtransactionwithwallet,\n  * as long as the conflicting transaction is not yet confirmed.\n+ * It can also serve as temporary scratch space for some set\n+ * of transactions (i.e. as a member of MemPoolAccept to validate\n+ * packages) and tracks the Coins added and removed by them.\n  */\n class CCoinsViewMemPool : public CCoinsViewBacked\n {\n protected:\n     const CTxMemPool& mempool;\n+    std::map<COutPoint, Coin> cache_package_add;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r568003551",
      "id" : 568003551,
      "in_reply_to_id" : 567869882,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODAwMzU1MQ==",
      "original_commit_id" : "2fac0136138012ae26c8e12ef77e9486ad5cd831",
      "original_line" : 891,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : null,
      "pull_request_review_id" : 580589882,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568003551",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r568003927"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568003927"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Agreed ð§  will update",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-02-01T17:25:01Z",
      "diff_hunk" : "@@ -641,6 +653,14 @@ bool MemPoolAccept::PreChecks(ATMPArgs& args, Workspace& ws)\n \n     LockPoints lp;\n     m_view.SetBackend(m_viewmempool);\n+    m_viewmempool.SetBackend(::ChainstateActive().CoinsTip());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r568003927",
      "id" : 568003927,
      "in_reply_to_id" : 567875231,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODAwMzkyNw==",
      "original_commit_id" : "2fac0136138012ae26c8e12ef77e9486ad5cd831",
      "original_line" : 656,
      "original_position" : 139,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 580590426,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568003927",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r568010215"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568010215"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Perhaps they could be uncached in `MemPoolAccept`'s destructor? That's similar to an RAII pattern where the object releases any resources as it goes out of scope.\r\n\r\nI don't think this needs to be done as part of this PR. Could be a follow up if it sounds like an improvement to you.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-02-01T17:34:12Z",
      "diff_hunk" : "@@ -474,11 +481,13 @@ class MemPoolAccept\n          */\n         std::vector<COutPoint>& m_coins_to_uncache;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r568010215",
      "id" : 568010215,
      "in_reply_to_id" : 567856457,
      "line" : 598,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODAxMDIxNQ==",
      "original_commit_id" : "2fac0136138012ae26c8e12ef77e9486ad5cd831",
      "original_line" : 598,
      "original_position" : 67,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 146,
      "pull_request_review_id" : 580598683,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568010215",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r568010841"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568010841"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah, great point. Maybe add a code comment to say that?",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-02-01T17:35:11Z",
      "diff_hunk" : "@@ -880,15 +880,28 @@ class CTxMemPool\n  * It also allows you to sign a double-spend directly in\n  * signrawtransactionwithkey and signrawtransactionwithwallet,\n  * as long as the conflicting transaction is not yet confirmed.\n+ * It can also serve as temporary scratch space for some set\n+ * of transactions (i.e. as a member of MemPoolAccept to validate\n+ * packages) and tracks the Coins added and removed by them.\n  */\n class CCoinsViewMemPool : public CCoinsViewBacked\n {\n protected:\n     const CTxMemPool& mempool;\n+    std::map<COutPoint, Coin> cache_package_add;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r568010841",
      "id" : 568010841,
      "in_reply_to_id" : 567869882,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODAxMDg0MQ==",
      "original_commit_id" : "2fac0136138012ae26c8e12ef77e9486ad5cd831",
      "original_line" : 891,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : null,
      "pull_request_review_id" : 580599512,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568010841",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r568228020"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568228020"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah, maybe for a future PR ð¤ would be nice. The only complication is that we only uncache if the validation failed, so `MemPoolAccept` would need to know that when it's destructing...",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-02-02T00:04:51Z",
      "diff_hunk" : "@@ -474,11 +481,13 @@ class MemPoolAccept\n          */\n         std::vector<COutPoint>& m_coins_to_uncache;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r568228020",
      "id" : 568228020,
      "in_reply_to_id" : 567856457,
      "line" : 598,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODIyODAyMA==",
      "original_commit_id" : "2fac0136138012ae26c8e12ef77e9486ad5cd831",
      "original_line" : 598,
      "original_position" : 67,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 146,
      "pull_request_review_id" : 580876636,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568228020",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r568246712"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568246712"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "You're right, I'll add an `Assume()` so we get a debug error if it's spent.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-02-02T00:52:24Z",
      "diff_hunk" : "@@ -905,19 +905,48 @@ bool CTxMemPool::HasNoInputsOf(const CTransaction &tx) const\n CCoinsViewMemPool::CCoinsViewMemPool(CCoinsView* baseIn, const CTxMemPool& mempoolIn) : CCoinsViewBacked(baseIn), mempool(mempoolIn) { }\n \n bool CCoinsViewMemPool::GetCoin(const COutPoint &outpoint, Coin &coin) const {\n+    // Check to see if the inputs are spent by a tx being considered for a package.\n+    // It's possible that a package spends entries in the mempool, and this would\n+    // only be reflected in the cache_package_remove.\n+    if (auto it = cache_package_remove.find(outpoint); it != cache_package_remove.end()) {\n+        coin = it->second;\n+        return false;\n+    }\n+\n+    // Check to see if the inputs are in a tx being considered for a package.\n+    // These Coins would not be available in the mempool or underlying CoinsView.\n+    if (auto it = cache_package_add.find(outpoint); it != cache_package_add.end()) {\n+        coin = it->second;\n+        return true;\n+    }\n+\n     // If an entry in the mempool exists, always return that one, as it's guaranteed to never\n-    // conflict with the underlying cache, and it cannot have pruned entries (as it contains full)\n-    // transactions. First checking the underlying cache risks returning a pruned entry instead.\n+    // conflict with the underlying cache, and it cannot have spent entries.\n     CTransactionRef ptx = mempool.get(outpoint.hash);\n-    if (ptx) {\n-        if (outpoint.n < ptx->vout.size()) {\n-            coin = Coin(ptx->vout[outpoint.n], MEMPOOL_HEIGHT, false);\n-            return true;\n-        } else {\n-            return false;\n-        }\n+\n+    // Check the underlying CoinsView.\n+    if (!ptx) return base->GetCoin(outpoint, coin);\n+\n+    // \"Create\" a Coin from a mempool transaction output.\n+    if (outpoint.n < ptx->vout.size()) {\n+        coin = Coin(ptx->vout[outpoint.n], MEMPOOL_HEIGHT, false);\n+        return true;\n+    }\n+    return false;\n+}\n+\n+void CCoinsViewMemPool::AddPackageTransaction(const CTransactionRef& tx) {\n+    package_txids.insert(tx->GetHash());\n+    // Coins spent by this transaction\n+    for (auto input : tx->vin) {\n+        Coin spent_coin;\n+        GetCoin(input.prevout, spent_coin);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r568246712",
      "id" : 568246712,
      "in_reply_to_id" : 567475382,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODI0NjcxMg==",
      "original_commit_id" : "17ca2d8e72bc5d9249e4a01a2dbc2bb362dbd9d8",
      "original_line" : 943,
      "original_position" : 48,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 580898285,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568246712",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "To all the lovely reviewers, as @jnewbery [pointed out](https://github.com/bitcoin/bitcoin/pull/20833#pullrequestreview-580388483), this PR is getting a little big ð so I've split off the refactoring commits to #21062.\r\n\r\nThanks a ton for the review @fjahr ð I think I've addressed all your comments/questions.\r\n\r\n@jnewbery I've addressed most of your comments - I agree with you on returning a vector (all success) || (maybe some succeeded, one failed, and all others not-fully-validated) from `ProcessNewPackage`. Do you also recommend doing that for the `testmempoolaccept` API? Marking this as a draft so I can figure this out while the refactors are cooking, heh.",
      "created_at" : "2021-02-02T02:07:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#issuecomment-771294064",
      "id" : 771294064,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20833",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3MTI5NDA2NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-03T19:01:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/771294064",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "To reviewers: #21062 is merged.\r\n~Next chunk is #21146, which is centered around `MemPoolAccept`'s interaction with the coins cache.\r\nThis PR is up-to-date so feel free to review, but we need #21146 first ð~",
      "created_at" : "2021-02-11T22:26:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#issuecomment-777833961",
      "id" : 777833961,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20833",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NzgzMzk2MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-02T18:28:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/777833961",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "This is ready for review ð  no blockers anymore\r\nThe approach has slightly changed - I'm now extending `CCoinsViewCache` to create a `CCoinsViewTemporary` (used only in mempool validation) to track package coins. They're stored at the top layer of the `MemPoolAccept` coins hierarchy, in `m_view` instead of `m_viewmempool`. And we can clear the temporary coins to reset the state without deleting`cacheCoins` :)",
      "created_at" : "2021-03-02T18:41:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#issuecomment-789126577",
      "id" : 789126577,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20833",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4OTEyNjU3Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-02T18:41:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/789126577",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r585817249"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585817249"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Nit: I would write mempool as a single word at this point in the lingo evolution. :)",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-02T18:43:07Z",
      "diff_hunk" : "@@ -28,7 +28,8 @@ struct MinerTestingSetup : public TestingSetup {\n     void TestPackageSelection(const CChainParams& chainparams, const CScript& scriptPubKey, const std::vector<CTransactionRef>& txFirst) EXCLUSIVE_LOCKS_REQUIRED(::cs_main, m_node.mempool->cs);\n     bool TestSequenceLocks(const CTransaction& tx, int flags) EXCLUSIVE_LOCKS_REQUIRED(::cs_main, m_node.mempool->cs)\n     {\n-        return CheckSequenceLocks(::ChainstateActive(), *m_node.mempool, tx, flags);\n+        CCoinsViewMemPool viewMemPool(&::ChainstateActive().CoinsTip(), *m_node.mempool);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r585817249",
      "id" : 585817249,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTgxNzI0OQ==",
      "original_commit_id" : "4b891df74160a8df0ca69ef35eedf22bf5f39a93",
      "original_line" : 31,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/test/miner_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 602147210,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585817249",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r585825994"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585825994"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Optionally add an introductory comment for `coin_empty`. Perhaps `spent_coin` is more speaking.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-02T18:55:55Z",
      "diff_hunk" : "@@ -462,6 +462,113 @@ static bool CheckInputsFromMempoolAndCache(const CTransaction& tx, TxValidationS\n     return CheckInputScripts(tx, state, view, flags, /* cacheSigStore = */ true, /* cacheFullSciptStore = */ true, txdata);\n }\n \n+static const Coin coin_empty;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r585825994",
      "id" : 585825994,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTgyNTk5NA==",
      "original_commit_id" : "6bf3ff6b0514b2ba199f502efd2953afdaf428a6",
      "original_line" : 466,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 602147210,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585825994",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed CI failure",
      "created_at" : "2021-03-03T02:59:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#issuecomment-789389804",
      "id" : 789389804,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20833",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4OTM4OTgwNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-03T02:59:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/789389804",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r586764973"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586764973"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Slightly surprised that the function's name is `getâ¦` but it returns a boolean on whether the retrieval was successful. I'd kinda expect a `getâ¦` function to return the object.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-03T20:44:04Z",
      "diff_hunk" : "@@ -462,6 +462,113 @@ static bool CheckInputsFromMempoolAndCache(const CTransaction& tx, TxValidationS\n     return CheckInputScripts(tx, state, view, flags, /* cacheSigStore = */ true, /* cacheFullSciptStore = */ true, txdata);\n }\n \n+static const Coin coin_empty;\n+/**\n+ * A CoinsView that adds a memory cache to another CoinsView and serves as temporary scratch space.\n+ * Used by MemPoolAccept class to validate transactions and packages before submitting to mempool.\n+ * A backend can be set to provide read access to chainstate and/or mempool coins, but writing to\n+ * the backend is disabled. Avoid using a CCoinsViewTemporary in consensus-critical paths such\n+ * as writing to the script cache. See CheckInputsFromMempoolAndCache as an example. When not being\n+ * used to validate a package (m_temp_added and m_temp_spent are empty), a CCoinsViewTemporary\n+ * behaves exactly like a CCoinsViewCache.\n+ */\n+class CCoinsViewTemporary : public CCoinsViewCache\n+{\n+protected:\n+    /**\n+    * Coins made available by transactions being validated. Tracking these allows for package\n+    * validation, since we can access transaction outputs without submitting them to mempool.\n+    */\n+    std::map<COutPoint, Coin> m_temp_added;\n+\n+    /**\n+    * Coins spent by transactions being validated. When there are multiple, we need to track these\n+    * in order to distinguish between missing/spent coins and conflicts within a package.\n+    */\n+    std::set<COutPoint> m_temp_spent;\n+\n+public:\n+\n+    CCoinsViewTemporary(CCoinsView* baseIn) : CCoinsViewCache(baseIn) {}\n+\n+    // Delete the copy constructor to prevent accidentally using it when one intends to create a\n+    // CCoinsViewTemporary on top of a base cache.\n+    CCoinsViewTemporary(const CCoinsViewTemporary &) = delete;\n+\n+    bool GetCoin(const COutPoint& outpoint, Coin& coin) const override {\n+        coin = AccessCoin(outpoint);\n+        return !coin.IsSpent();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r586764973",
      "id" : 586764973,
      "line" : 503,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4Njc2NDk3Mw==",
      "original_commit_id" : "6bf3ff6b0514b2ba199f502efd2953afdaf428a6",
      "original_line" : 503,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 72,
      "pull_request_review_id" : 602147210,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586764973",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r586775962"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586775962"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If this is is supposed to mean that there are two conflicting transactions in the package, this could be phrased a bit more clearly. How about:\r\n\r\n\"Check if another transaction in the package has already spent the given UTXO. UTXO consumed by this package are only tracked in `m_temp_spent`.\"",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-03T21:01:52Z",
      "diff_hunk" : "@@ -462,6 +462,113 @@ static bool CheckInputsFromMempoolAndCache(const CTransaction& tx, TxValidationS\n     return CheckInputScripts(tx, state, view, flags, /* cacheSigStore = */ true, /* cacheFullSciptStore = */ true, txdata);\n }\n \n+static const Coin coin_empty;\n+/**\n+ * A CoinsView that adds a memory cache to another CoinsView and serves as temporary scratch space.\n+ * Used by MemPoolAccept class to validate transactions and packages before submitting to mempool.\n+ * A backend can be set to provide read access to chainstate and/or mempool coins, but writing to\n+ * the backend is disabled. Avoid using a CCoinsViewTemporary in consensus-critical paths such\n+ * as writing to the script cache. See CheckInputsFromMempoolAndCache as an example. When not being\n+ * used to validate a package (m_temp_added and m_temp_spent are empty), a CCoinsViewTemporary\n+ * behaves exactly like a CCoinsViewCache.\n+ */\n+class CCoinsViewTemporary : public CCoinsViewCache\n+{\n+protected:\n+    /**\n+    * Coins made available by transactions being validated. Tracking these allows for package\n+    * validation, since we can access transaction outputs without submitting them to mempool.\n+    */\n+    std::map<COutPoint, Coin> m_temp_added;\n+\n+    /**\n+    * Coins spent by transactions being validated. When there are multiple, we need to track these\n+    * in order to distinguish between missing/spent coins and conflicts within a package.\n+    */\n+    std::set<COutPoint> m_temp_spent;\n+\n+public:\n+\n+    CCoinsViewTemporary(CCoinsView* baseIn) : CCoinsViewCache(baseIn) {}\n+\n+    // Delete the copy constructor to prevent accidentally using it when one intends to create a\n+    // CCoinsViewTemporary on top of a base cache.\n+    CCoinsViewTemporary(const CCoinsViewTemporary &) = delete;\n+\n+    bool GetCoin(const COutPoint& outpoint, Coin& coin) const override {\n+        coin = AccessCoin(outpoint);\n+        return !coin.IsSpent();\n+    }\n+\n+    const Coin& AccessCoin(const COutPoint& outpoint) const override {\n+        // Check to see if the inputs are spent by a tx being considered for a package. When a\n+        // package transaction spends coins from the mempool, it is only reflected in m_temp_spent.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r586775962",
      "id" : 586775962,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4Njc3NTk2Mg==",
      "original_commit_id" : "6bf3ff6b0514b2ba199f502efd2953afdaf428a6",
      "original_line" : 506,
      "original_position" : 44,
      "original_start_line" : 504,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 602147210,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586775962",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r586777630"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586777630"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Isn't only a single package under review here? How about:\r\n\r\n\"Check whether the input was created by another transaction in the package under review.\"",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-03T21:04:48Z",
      "diff_hunk" : "@@ -462,6 +462,113 @@ static bool CheckInputsFromMempoolAndCache(const CTransaction& tx, TxValidationS\n     return CheckInputScripts(tx, state, view, flags, /* cacheSigStore = */ true, /* cacheFullSciptStore = */ true, txdata);\n }\n \n+static const Coin coin_empty;\n+/**\n+ * A CoinsView that adds a memory cache to another CoinsView and serves as temporary scratch space.\n+ * Used by MemPoolAccept class to validate transactions and packages before submitting to mempool.\n+ * A backend can be set to provide read access to chainstate and/or mempool coins, but writing to\n+ * the backend is disabled. Avoid using a CCoinsViewTemporary in consensus-critical paths such\n+ * as writing to the script cache. See CheckInputsFromMempoolAndCache as an example. When not being\n+ * used to validate a package (m_temp_added and m_temp_spent are empty), a CCoinsViewTemporary\n+ * behaves exactly like a CCoinsViewCache.\n+ */\n+class CCoinsViewTemporary : public CCoinsViewCache\n+{\n+protected:\n+    /**\n+    * Coins made available by transactions being validated. Tracking these allows for package\n+    * validation, since we can access transaction outputs without submitting them to mempool.\n+    */\n+    std::map<COutPoint, Coin> m_temp_added;\n+\n+    /**\n+    * Coins spent by transactions being validated. When there are multiple, we need to track these\n+    * in order to distinguish between missing/spent coins and conflicts within a package.\n+    */\n+    std::set<COutPoint> m_temp_spent;\n+\n+public:\n+\n+    CCoinsViewTemporary(CCoinsView* baseIn) : CCoinsViewCache(baseIn) {}\n+\n+    // Delete the copy constructor to prevent accidentally using it when one intends to create a\n+    // CCoinsViewTemporary on top of a base cache.\n+    CCoinsViewTemporary(const CCoinsViewTemporary &) = delete;\n+\n+    bool GetCoin(const COutPoint& outpoint, Coin& coin) const override {\n+        coin = AccessCoin(outpoint);\n+        return !coin.IsSpent();\n+    }\n+\n+    const Coin& AccessCoin(const COutPoint& outpoint) const override {\n+        // Check to see if the inputs are spent by a tx being considered for a package. When a\n+        // package transaction spends coins from the mempool, it is only reflected in m_temp_spent.\n+        if (m_temp_spent.count(outpoint)) {\n+            return coin_empty;\n+        }\n+\n+        // Check to see if the inputs are in a tx being considered for a package.\n+        // These Coins would not be available in the underlying CoinsView.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r586777630",
      "id" : 586777630,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4Njc3NzYzMA==",
      "original_commit_id" : "6bf3ff6b0514b2ba199f502efd2953afdaf428a6",
      "original_line" : 514,
      "original_position" : 50,
      "original_start_line" : 510,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 602147210,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586777630",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r586778515"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586778515"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It would make more sense to me if the names of `GetCoin` and `AccessCoin` were swappedâ¦ :confounded:",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-03T21:06:24Z",
      "diff_hunk" : "@@ -462,6 +462,113 @@ static bool CheckInputsFromMempoolAndCache(const CTransaction& tx, TxValidationS\n     return CheckInputScripts(tx, state, view, flags, /* cacheSigStore = */ true, /* cacheFullSciptStore = */ true, txdata);\n }\n \n+static const Coin coin_empty;\n+/**\n+ * A CoinsView that adds a memory cache to another CoinsView and serves as temporary scratch space.\n+ * Used by MemPoolAccept class to validate transactions and packages before submitting to mempool.\n+ * A backend can be set to provide read access to chainstate and/or mempool coins, but writing to\n+ * the backend is disabled. Avoid using a CCoinsViewTemporary in consensus-critical paths such\n+ * as writing to the script cache. See CheckInputsFromMempoolAndCache as an example. When not being\n+ * used to validate a package (m_temp_added and m_temp_spent are empty), a CCoinsViewTemporary\n+ * behaves exactly like a CCoinsViewCache.\n+ */\n+class CCoinsViewTemporary : public CCoinsViewCache\n+{\n+protected:\n+    /**\n+    * Coins made available by transactions being validated. Tracking these allows for package\n+    * validation, since we can access transaction outputs without submitting them to mempool.\n+    */\n+    std::map<COutPoint, Coin> m_temp_added;\n+\n+    /**\n+    * Coins spent by transactions being validated. When there are multiple, we need to track these\n+    * in order to distinguish between missing/spent coins and conflicts within a package.\n+    */\n+    std::set<COutPoint> m_temp_spent;\n+\n+public:\n+\n+    CCoinsViewTemporary(CCoinsView* baseIn) : CCoinsViewCache(baseIn) {}\n+\n+    // Delete the copy constructor to prevent accidentally using it when one intends to create a\n+    // CCoinsViewTemporary on top of a base cache.\n+    CCoinsViewTemporary(const CCoinsViewTemporary &) = delete;\n+\n+    bool GetCoin(const COutPoint& outpoint, Coin& coin) const override {\n+        coin = AccessCoin(outpoint);\n+        return !coin.IsSpent();\n+    }\n+\n+    const Coin& AccessCoin(const COutPoint& outpoint) const override {\n+        // Check to see if the inputs are spent by a tx being considered for a package. When a\n+        // package transaction spends coins from the mempool, it is only reflected in m_temp_spent.\n+        if (m_temp_spent.count(outpoint)) {\n+            return coin_empty;\n+        }\n+\n+        // Check to see if the inputs are in a tx being considered for a package.\n+        // These Coins would not be available in the underlying CoinsView.\n+        if (auto it = m_temp_added.find(outpoint); it != m_temp_added.end()) {\n+            assert(!it->second.IsSpent());\n+            return it->second;\n+        }\n+        return CCoinsViewCache::AccessCoin(outpoint);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r586778515",
      "id" : 586778515,
      "line" : 519,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4Njc3ODUxNQ==",
      "original_commit_id" : "6bf3ff6b0514b2ba199f502efd2953afdaf428a6",
      "original_line" : 519,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 88,
      "pull_request_review_id" : 602147210,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586778515",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r587883103"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587883103"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It would have helped me if this comment had stated what assumptions the transaction package underlies if any,  (e.g. whether they are all part of a connected set or not). I might have expected such assumptions to be explicitly stated in the parameter descriptions of a function in another codebase.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-04T22:47:45Z",
      "diff_hunk" : "@@ -603,6 +603,9 @@ class MemPoolAccept\n     // Single transaction acceptance\n     MempoolAcceptResult AcceptSingleTransaction(const CTransactionRef& ptx, ATMPArgs& args) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    // Multiple transaction acceptance\n+    std::vector<MempoolAcceptResult> AcceptMultipleTransactions(std::vector<CTransactionRef>& txns, ATMPArgs& args) EXCLUSIVE_LOCKS_REQUIRED(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r587883103",
      "id" : 587883103,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4Nzg4MzEwMw==",
      "original_commit_id" : "390574584a5798c06014ca045020b1d46e22ce31",
      "original_line" : 611,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 602147210,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587883103",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r587889697"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587889697"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This sounds like you're assuming that you're getting the transactions in topological order. If that's a requirement, it would be good to list that above as mentioned.\r\n\r\nAlso, you may want to make your API input checks as lenient as possible and a specific order does not seem necessary to me.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-04T22:56:02Z",
      "diff_hunk" : "@@ -1165,28 +1172,93 @@ MempoolAcceptResult MemPoolAccept::AcceptSingleTransaction(const CTransactionRef\n \n     Workspace ws(ptx);\n \n-    if (!PreChecks(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!PreChecks(args, ws)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\n \n     // Only compute the precomputed transaction data if we need to verify\n     // scripts (ie, other policy checks pass). We perform the inexpensive\n     // checks first and avoid hashing and signature verification unless those\n     // checks pass, to mitigate CPU exhaustion denial-of-service attacks.\n     PrecomputedTransactionData txdata;\n \n-    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\n \n-    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\n \n     // Tx was accepted, but not added\n     if (args.m_test_accept) {\n-        return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+        return MempoolAcceptResult(*ws.m_ptx, std::move(ws.m_replaced_transactions), ws.m_base_fees);\n     }\n \n-    if (!Finalize(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!Finalize(args, ws)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\n \n     GetMainSignals().TransactionAddedToMempool(ptx, m_pool.GetAndIncrementSequence());\n \n-    return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+    return MempoolAcceptResult(*ws.m_ptx, std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+}\n+\n+std::vector<MempoolAcceptResult> MemPoolAccept::AcceptMultipleTransactions(std::vector<CTransactionRef>& txns, ATMPArgs& args)\n+{\n+    AssertLockHeld(cs_main);\n+    std::vector<Workspace> workspaces{};\n+    const int package_size = txns.size();\n+    workspaces.reserve(package_size);\n+    std::transform(txns.begin(), txns.end(), std::back_inserter(workspaces), [](CTransactionRef& tx) {\n+        return Workspace(tx);\n+    });\n+    std::vector<MempoolAcceptResult> results;\n+    results.reserve(package_size);\n+\n+    LOCK(m_pool.cs);\n+    // Do all PreChecks first and fail fast to avoid running expensive script checks when unnecessary.\n+    for (Workspace& ws : workspaces) {\n+        if (!PreChecks(args, ws)) {\n+            // Exit early to avoid doing pointless work. Return results in the same order as input txns.\n+            const auto failed_or_unfinished = [&, failed_ptx = ws.m_ptx](Workspace& ws) {\n+                                              return ws.m_ptx == failed_ptx\n+                                              ? MempoolAcceptResult(*ws.m_ptx, ws.m_state, /* finished */ true)\n+                                              : MempoolAcceptResult(*ws.m_ptx, ws.m_state, /* finished */ false);\n+            };\n+            std::transform(workspaces.begin(), workspaces.end(), std::back_inserter(results), failed_or_unfinished);\n+            return results;\n+        }\n+        m_view.PackageAddTransaction(ws.m_ptx);\n+    }\n+\n+    // Now that we have verified all inputs are available and there are no conflicts in the package,\n+    // clear the temporary coins (m_temp_added and m_temp_spent), otherwise script checks will error\n+    // on coins that are spent within the package.\n+    m_view.ClearTemporaryCoins();\n+\n+    for (Workspace& ws : workspaces) {\n+        PrecomputedTransactionData txdata;\n+        if (!PolicyScriptChecks(args, ws, txdata)) {\n+            // Exit early to avoid doing pointless work. Return results in the same order as input txns.\n+            CTransactionRef failed_ptx = ws.m_ptx;\n+            const auto failed_or_unfinished = [&failed_ptx](Workspace& ws) {\n+                                              return ws.m_ptx == failed_ptx\n+                                              ? MempoolAcceptResult(*ws.m_ptx, ws.m_state, /* finished */ true)\n+                                              : MempoolAcceptResult(*ws.m_ptx, ws.m_state, /* finished */ false);\n+            };\n+            auto it_curr = std::find_if(workspaces.begin(), workspaces.end(),\n+                                        [& failed_ptx](Workspace& ws) { return ws.m_ptx == failed_ptx; });\n+            // When test_accept=true, transactions that pass PolicyScriptChecks are valid because there are\n+            // no further mempool checks (passing PolicyScriptChecks implies passing ConsensusScriptChecks).\n+            std::transform(workspaces.begin(), it_curr, std::back_inserter(results), [](Workspace& ws) {\n+                           return MempoolAcceptResult(*ws.m_ptx, std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+            });\n+            std::transform(it_curr, workspaces.end(), std::back_inserter(results), failed_or_unfinished);\n+            return results;\n+        }\n+        // Add the coins back because subsequent transaction(s) in the package may need them for",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r587889697",
      "id" : 587889697,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4Nzg4OTY5Nw==",
      "original_commit_id" : "390574584a5798c06014ca045020b1d46e22ce31",
      "original_line" : 1256,
      "original_position" : 108,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 602147210,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587889697",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r587893955"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587893955"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I thought this RPC was supposed to generally fail if any transactions fail.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-04T23:04:07Z",
      "diff_hunk" : "@@ -890,13 +892,15 @@ static RPCHelpMan testmempoolaccept()\n                 },\n                 RPCResult{\n                     RPCResult::Type::ARR, \"\", \"The result of the mempool acceptance test for each raw transaction in the input array.\\n\"\n-                        \"Length is exactly one for now.\",\n+                        \"Returns results for each transaction in the same order they were passed in.\\n\"\n+                        \"It is possible for transactions to not be fully validated ('allowed' unset) if an earlier transaction failed.\\n\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r587893955",
      "id" : 587893955,
      "line" : 900,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4Nzg5Mzk1NQ==",
      "original_commit_id" : "a3264ac359a62b6a4fb0bae8976f8a363652d934",
      "original_line" : 900,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : 25,
      "pull_request_review_id" : 602147210,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587893955",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r587905367"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587905367"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Optional additional tests:\r\nâ¢ parent with two distinct child transactions\r\nâ¢ child with two parent transactions",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-04T23:25:25Z",
      "diff_hunk" : "@@ -0,0 +1,245 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"RPCs that handle raw transaction packages.\"\"\"\n+\n+from decimal import Decimal\n+from io import BytesIO\n+\n+from test_framework.address import ADDRESS_BCRT1_P2WSH_OP_TRUE\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    BIP125_SEQUENCE_NUMBER,\n+    COIN,\n+    CTransaction,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+    hex_str_to_bytes,\n+)\n+\n+class RPCPackagesTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+        self.setup_clean_chain = True\n+\n+    def run_test(self):\n+        self.log.info(\"Generate blocks to create UTXOs\")\n+        node = self.nodes[0]\n+        self.privkeys = [node.get_deterministic_priv_key().key]\n+        self.address = node.get_deterministic_priv_key().address\n+        self.coins = []\n+        # The last 100 coinbase transactions are premature\n+        for b in node.generatetoaddress(120, self.address)[:20]:\n+            coinbase = node.getblock(blockhash=b, verbosity=2)[\"tx\"][0]\n+            self.coins.append({\n+                \"txid\": coinbase[\"txid\"],\n+                \"amount\": coinbase[\"vout\"][0][\"value\"],\n+                \"scriptPubKey\": coinbase[\"vout\"][0][\"scriptPubKey\"],\n+            })\n+\n+        # Create some transactions that can be reused throughout the test. Never submit these to mempool.\n+        self.independent_txns_hex = []\n+        self.independent_txns_testres = []\n+        for _ in range(3):\n+            coin = self.coins.pop()\n+            rawtx = node.createrawtransaction([{\"txid\" : coin[\"txid\"], \"vout\" : 0}],\n+                {self.address : coin[\"amount\"] - Decimal(\"0.0001\")})\n+            signedtx = node.signrawtransactionwithkey(hexstring=rawtx, privkeys=self.privkeys)\n+            assert signedtx[\"complete\"]\n+            testres = node.testmempoolaccept([signedtx[\"hex\"]])\n+            assert testres[0][\"allowed\"]\n+            self.independent_txns_hex.append(signedtx[\"hex\"])\n+            # testmempoolaccept returns a list of length one, avoid creating a 2D list\n+            self.independent_txns_testres.append(testres[0])\n+\n+        self.test_independent()\n+        self.test_chain()\n+        self.test_conflicting()\n+        self.test_rbf()\n+\n+    def chain_transaction(self, parent_txid, value, parent_locking_script=None):\n+        \"\"\"Build a transaction that spends parent_txid:vout.\n+        Return tuple (CTransaction object, raw hex, scriptPub).\n+        \"\"\"\n+        node = self.nodes[0]\n+        inputs = [{\"txid\" : parent_txid, \"vout\" : 0}]\n+        outputs = {self.address : value}\n+        rawtx = node.createrawtransaction(inputs, outputs)\n+        prevtxs = [{\n+            \"txid\": parent_txid,\n+            \"vout\": 0,\n+            \"scriptPubKey\": parent_locking_script,\n+            \"amount\": value + Decimal(\"0.0001\"),\n+        }] if parent_locking_script else None\n+        signedtx = node.signrawtransactionwithkey(hexstring=rawtx, privkeys=self.privkeys, prevtxs=prevtxs)\n+        tx = CTransaction()\n+        assert signedtx[\"complete\"]\n+        tx.deserialize(BytesIO(hex_str_to_bytes(signedtx[\"hex\"])))\n+        return (tx, signedtx[\"hex\"], tx.vout[0].scriptPubKey.hex())\n+\n+    def test_independent(self):\n+        self.log.info(\"Test multiple independent transactions in a package\")\n+        node = self.nodes[0]\n+        assert_equal(self.independent_txns_testres, node.testmempoolaccept(rawtxs=self.independent_txns_hex))\n+\n+        self.log.info(\"Test a valid package with garbage inserted\")\n+        garbage_tx = node.createrawtransaction([{\"txid\": \"00\" * 32, \"vout\": 5}], {self.address: 1})\n+        tx = CTransaction()\n+        tx.deserialize(BytesIO(hex_str_to_bytes(garbage_tx)))\n+        testres_bad = node.testmempoolaccept(self.independent_txns_hex + [garbage_tx])\n+        testres_independent_ids = [{\"txid\": res[\"txid\"], \"wtxid\": res[\"wtxid\"]} for res in self.independent_txns_testres]\n+        assert_equal(testres_bad, testres_independent_ids + [\n+            {\"txid\": tx.rehash(), \"wtxid\": tx.getwtxid(), \"allowed\": False, \"reject-reason\": \"missing-inputs\"}\n+        ])\n+\n+        self.log.info(\"Check testmempoolaccept tells us when some transactions completed validation successfully\")\n+        coin = self.coins.pop()\n+        tx_bad_sig_hex = node.createrawtransaction([{\"txid\" : coin[\"txid\"], \"vout\" : 0}],\n+                                           {self.address : coin[\"amount\"] - Decimal(\"0.0001\")})\n+        tx_bad_sig = CTransaction()\n+        tx_bad_sig.deserialize(BytesIO(hex_str_to_bytes(tx_bad_sig_hex)))\n+        testres_bad_sig = node.testmempoolaccept(self.independent_txns_hex + [tx_bad_sig_hex])\n+        assert_equal(testres_bad_sig, self.independent_txns_testres + [{\n+            \"txid\": tx_bad_sig.rehash(),\n+            \"wtxid\": tx_bad_sig.getwtxid(), \"allowed\": False,\n+            \"reject-reason\": \"mandatory-script-verify-flag-failed (Operation not valid with the current stack size)\"\n+        }])\n+\n+        self.log.info(\"Check testmempoolaccept reports txns in packages that exceed max feerate\")\n+        coin = self.coins.pop()\n+        tx_high_fee_raw = node.createrawtransaction([{\"txid\" : coin[\"txid\"], \"vout\" : 0}],\n+                                           {self.address : coin[\"amount\"] - Decimal(\"0.999\")})\n+        tx_high_fee_signed = node.signrawtransactionwithkey(hexstring=tx_high_fee_raw, privkeys=self.privkeys)\n+        assert tx_high_fee_signed[\"complete\"]\n+        tx_high_fee = CTransaction()\n+        tx_high_fee.deserialize(BytesIO(hex_str_to_bytes(tx_high_fee_signed[\"hex\"])))\n+        testres_high_fee = node.testmempoolaccept([tx_high_fee_signed[\"hex\"]])\n+        assert_equal(testres_high_fee, [\n+            {\"txid\": tx_high_fee.rehash(), \"wtxid\": tx_high_fee.getwtxid(), \"allowed\": False, \"reject-reason\": \"max-fee-exceeded\"}\n+        ])\n+        testres_package_high_fee = node.testmempoolaccept(self.independent_txns_hex + [tx_high_fee_signed[\"hex\"]])\n+        assert_equal(testres_package_high_fee, self.independent_txns_testres + testres_high_fee)\n+\n+    def test_chain(self):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r587905367",
      "id" : 587905367,
      "line" : 135,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NzkwNTM2Nw==",
      "original_commit_id" : "61d54b613d4bfbfcdd16239a73c500c5fd89ff49",
      "original_line" : 135,
      "original_position" : 125,
      "original_start_line" : null,
      "path" : "test/functional/rpc_packages.py",
      "position" : 135,
      "pull_request_review_id" : 602147210,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587905367",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r587906781"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587906781"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Maybe I'm just overlooking it, but what about a valid set of independent transactions? That should be accepted now, but later fail when you require packages to consist of dependent transactions. Especially, I would be interested in seeing that the connectedness test properly recognizes two independent parent-child pairs as unconnected.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-04T23:28:27Z",
      "diff_hunk" : "@@ -0,0 +1,245 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"RPCs that handle raw transaction packages.\"\"\"\n+\n+from decimal import Decimal\n+from io import BytesIO\n+\n+from test_framework.address import ADDRESS_BCRT1_P2WSH_OP_TRUE\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    BIP125_SEQUENCE_NUMBER,\n+    COIN,\n+    CTransaction,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+    hex_str_to_bytes,\n+)\n+\n+class RPCPackagesTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+        self.setup_clean_chain = True\n+\n+    def run_test(self):\n+        self.log.info(\"Generate blocks to create UTXOs\")\n+        node = self.nodes[0]\n+        self.privkeys = [node.get_deterministic_priv_key().key]\n+        self.address = node.get_deterministic_priv_key().address\n+        self.coins = []\n+        # The last 100 coinbase transactions are premature\n+        for b in node.generatetoaddress(120, self.address)[:20]:\n+            coinbase = node.getblock(blockhash=b, verbosity=2)[\"tx\"][0]\n+            self.coins.append({\n+                \"txid\": coinbase[\"txid\"],\n+                \"amount\": coinbase[\"vout\"][0][\"value\"],\n+                \"scriptPubKey\": coinbase[\"vout\"][0][\"scriptPubKey\"],\n+            })\n+\n+        # Create some transactions that can be reused throughout the test. Never submit these to mempool.\n+        self.independent_txns_hex = []\n+        self.independent_txns_testres = []\n+        for _ in range(3):\n+            coin = self.coins.pop()\n+            rawtx = node.createrawtransaction([{\"txid\" : coin[\"txid\"], \"vout\" : 0}],\n+                {self.address : coin[\"amount\"] - Decimal(\"0.0001\")})\n+            signedtx = node.signrawtransactionwithkey(hexstring=rawtx, privkeys=self.privkeys)\n+            assert signedtx[\"complete\"]\n+            testres = node.testmempoolaccept([signedtx[\"hex\"]])\n+            assert testres[0][\"allowed\"]\n+            self.independent_txns_hex.append(signedtx[\"hex\"])\n+            # testmempoolaccept returns a list of length one, avoid creating a 2D list\n+            self.independent_txns_testres.append(testres[0])\n+\n+        self.test_independent()\n+        self.test_chain()\n+        self.test_conflicting()\n+        self.test_rbf()\n+\n+    def chain_transaction(self, parent_txid, value, parent_locking_script=None):\n+        \"\"\"Build a transaction that spends parent_txid:vout.\n+        Return tuple (CTransaction object, raw hex, scriptPub).\n+        \"\"\"\n+        node = self.nodes[0]\n+        inputs = [{\"txid\" : parent_txid, \"vout\" : 0}]\n+        outputs = {self.address : value}\n+        rawtx = node.createrawtransaction(inputs, outputs)\n+        prevtxs = [{\n+            \"txid\": parent_txid,\n+            \"vout\": 0,\n+            \"scriptPubKey\": parent_locking_script,\n+            \"amount\": value + Decimal(\"0.0001\"),\n+        }] if parent_locking_script else None\n+        signedtx = node.signrawtransactionwithkey(hexstring=rawtx, privkeys=self.privkeys, prevtxs=prevtxs)\n+        tx = CTransaction()\n+        assert signedtx[\"complete\"]\n+        tx.deserialize(BytesIO(hex_str_to_bytes(signedtx[\"hex\"])))\n+        return (tx, signedtx[\"hex\"], tx.vout[0].scriptPubKey.hex())\n+\n+    def test_independent(self):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r587906781",
      "id" : 587906781,
      "line" : 92,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NzkwNjc4MQ==",
      "original_commit_id" : "61d54b613d4bfbfcdd16239a73c500c5fd89ff49",
      "original_line" : 92,
      "original_position" : 82,
      "original_start_line" : null,
      "path" : "test/functional/rpc_packages.py",
      "position" : 92,
      "pull_request_review_id" : 602147210,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/587906781",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r588925773"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/588925773"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I changed my mind on it because it seemed like the 1-if-failure API was confusing and less helpful",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-06T20:14:55Z",
      "diff_hunk" : "@@ -890,13 +892,15 @@ static RPCHelpMan testmempoolaccept()\n                 },\n                 RPCResult{\n                     RPCResult::Type::ARR, \"\", \"The result of the mempool acceptance test for each raw transaction in the input array.\\n\"\n-                        \"Length is exactly one for now.\",\n+                        \"Returns results for each transaction in the same order they were passed in.\\n\"\n+                        \"It is possible for transactions to not be fully validated ('allowed' unset) if an earlier transaction failed.\\n\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r588925773",
      "id" : 588925773,
      "in_reply_to_id" : 587893955,
      "line" : 900,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4ODkyNTc3Mw==",
      "original_commit_id" : "a3264ac359a62b6a4fb0bae8976f8a363652d934",
      "original_line" : 900,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : 25,
      "pull_request_review_id" : 605784646,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/588925773",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r589631384"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/589631384"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Marking as resolved because this wouldn't be a change for this PR, but yes I agree the CoinsView API is not the most aptly named :)",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-08T17:58:45Z",
      "diff_hunk" : "@@ -462,6 +462,113 @@ static bool CheckInputsFromMempoolAndCache(const CTransaction& tx, TxValidationS\n     return CheckInputScripts(tx, state, view, flags, /* cacheSigStore = */ true, /* cacheFullSciptStore = */ true, txdata);\n }\n \n+static const Coin coin_empty;\n+/**\n+ * A CoinsView that adds a memory cache to another CoinsView and serves as temporary scratch space.\n+ * Used by MemPoolAccept class to validate transactions and packages before submitting to mempool.\n+ * A backend can be set to provide read access to chainstate and/or mempool coins, but writing to\n+ * the backend is disabled. Avoid using a CCoinsViewTemporary in consensus-critical paths such\n+ * as writing to the script cache. See CheckInputsFromMempoolAndCache as an example. When not being\n+ * used to validate a package (m_temp_added and m_temp_spent are empty), a CCoinsViewTemporary\n+ * behaves exactly like a CCoinsViewCache.\n+ */\n+class CCoinsViewTemporary : public CCoinsViewCache\n+{\n+protected:\n+    /**\n+    * Coins made available by transactions being validated. Tracking these allows for package\n+    * validation, since we can access transaction outputs without submitting them to mempool.\n+    */\n+    std::map<COutPoint, Coin> m_temp_added;\n+\n+    /**\n+    * Coins spent by transactions being validated. When there are multiple, we need to track these\n+    * in order to distinguish between missing/spent coins and conflicts within a package.\n+    */\n+    std::set<COutPoint> m_temp_spent;\n+\n+public:\n+\n+    CCoinsViewTemporary(CCoinsView* baseIn) : CCoinsViewCache(baseIn) {}\n+\n+    // Delete the copy constructor to prevent accidentally using it when one intends to create a\n+    // CCoinsViewTemporary on top of a base cache.\n+    CCoinsViewTemporary(const CCoinsViewTemporary &) = delete;\n+\n+    bool GetCoin(const COutPoint& outpoint, Coin& coin) const override {\n+        coin = AccessCoin(outpoint);\n+        return !coin.IsSpent();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r589631384",
      "id" : 589631384,
      "in_reply_to_id" : 586764973,
      "line" : 503,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4OTYzMTM4NA==",
      "original_commit_id" : "6bf3ff6b0514b2ba199f502efd2953afdaf428a6",
      "original_line" : 503,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 72,
      "pull_request_review_id" : 606559339,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/589631384",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r589631544"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/589631544"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Marking as resolved because this wouldn't be a change for this PR, but yes I agree the CoinsView API is not the most aptly named :)",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-08T17:58:58Z",
      "diff_hunk" : "@@ -462,6 +462,113 @@ static bool CheckInputsFromMempoolAndCache(const CTransaction& tx, TxValidationS\n     return CheckInputScripts(tx, state, view, flags, /* cacheSigStore = */ true, /* cacheFullSciptStore = */ true, txdata);\n }\n \n+static const Coin coin_empty;\n+/**\n+ * A CoinsView that adds a memory cache to another CoinsView and serves as temporary scratch space.\n+ * Used by MemPoolAccept class to validate transactions and packages before submitting to mempool.\n+ * A backend can be set to provide read access to chainstate and/or mempool coins, but writing to\n+ * the backend is disabled. Avoid using a CCoinsViewTemporary in consensus-critical paths such\n+ * as writing to the script cache. See CheckInputsFromMempoolAndCache as an example. When not being\n+ * used to validate a package (m_temp_added and m_temp_spent are empty), a CCoinsViewTemporary\n+ * behaves exactly like a CCoinsViewCache.\n+ */\n+class CCoinsViewTemporary : public CCoinsViewCache\n+{\n+protected:\n+    /**\n+    * Coins made available by transactions being validated. Tracking these allows for package\n+    * validation, since we can access transaction outputs without submitting them to mempool.\n+    */\n+    std::map<COutPoint, Coin> m_temp_added;\n+\n+    /**\n+    * Coins spent by transactions being validated. When there are multiple, we need to track these\n+    * in order to distinguish between missing/spent coins and conflicts within a package.\n+    */\n+    std::set<COutPoint> m_temp_spent;\n+\n+public:\n+\n+    CCoinsViewTemporary(CCoinsView* baseIn) : CCoinsViewCache(baseIn) {}\n+\n+    // Delete the copy constructor to prevent accidentally using it when one intends to create a\n+    // CCoinsViewTemporary on top of a base cache.\n+    CCoinsViewTemporary(const CCoinsViewTemporary &) = delete;\n+\n+    bool GetCoin(const COutPoint& outpoint, Coin& coin) const override {\n+        coin = AccessCoin(outpoint);\n+        return !coin.IsSpent();\n+    }\n+\n+    const Coin& AccessCoin(const COutPoint& outpoint) const override {\n+        // Check to see if the inputs are spent by a tx being considered for a package. When a\n+        // package transaction spends coins from the mempool, it is only reflected in m_temp_spent.\n+        if (m_temp_spent.count(outpoint)) {\n+            return coin_empty;\n+        }\n+\n+        // Check to see if the inputs are in a tx being considered for a package.\n+        // These Coins would not be available in the underlying CoinsView.\n+        if (auto it = m_temp_added.find(outpoint); it != m_temp_added.end()) {\n+            assert(!it->second.IsSpent());\n+            return it->second;\n+        }\n+        return CCoinsViewCache::AccessCoin(outpoint);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r589631544",
      "id" : 589631544,
      "in_reply_to_id" : 586778515,
      "line" : 519,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4OTYzMTU0NA==",
      "original_commit_id" : "6bf3ff6b0514b2ba199f502efd2953afdaf428a6",
      "original_line" : 519,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 88,
      "pull_request_review_id" : 606559526,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/589631544",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r589653414"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/589653414"
         }
      },
      "author_association" : "MEMBER",
      "body" : "FWIW, there is a historical reason why there are lots of `bool Get*(....,&return_object)` functions in the codebase. Before C++11's move semantics it was hard to avoid copies in many cases (needing `swap`s all over the place...). [copy elision](https://en.cppreference.com/w/cpp/language/copy_elision) existed in C++98, but has been expanded greatly since (and is now mandatory in C++17). It's also only since C++17 that `std::optional` exists so there is a clean way of returning an optional value; before that you'd sometimes see an idiom of functions returning a `std::pair<value, bool>` (e.g. `std::set::insert`), but without structured binding (also C++17) or even `std::tie` (C++11) that's pretty annoying to use too.\r\n\r\nTL;DR: there used to not really be a great way of having getters that are both efficient and can fail. With the current language, I think it'd just return `std::optional<Coin>`.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-08T18:31:59Z",
      "diff_hunk" : "@@ -462,6 +462,113 @@ static bool CheckInputsFromMempoolAndCache(const CTransaction& tx, TxValidationS\n     return CheckInputScripts(tx, state, view, flags, /* cacheSigStore = */ true, /* cacheFullSciptStore = */ true, txdata);\n }\n \n+static const Coin coin_empty;\n+/**\n+ * A CoinsView that adds a memory cache to another CoinsView and serves as temporary scratch space.\n+ * Used by MemPoolAccept class to validate transactions and packages before submitting to mempool.\n+ * A backend can be set to provide read access to chainstate and/or mempool coins, but writing to\n+ * the backend is disabled. Avoid using a CCoinsViewTemporary in consensus-critical paths such\n+ * as writing to the script cache. See CheckInputsFromMempoolAndCache as an example. When not being\n+ * used to validate a package (m_temp_added and m_temp_spent are empty), a CCoinsViewTemporary\n+ * behaves exactly like a CCoinsViewCache.\n+ */\n+class CCoinsViewTemporary : public CCoinsViewCache\n+{\n+protected:\n+    /**\n+    * Coins made available by transactions being validated. Tracking these allows for package\n+    * validation, since we can access transaction outputs without submitting them to mempool.\n+    */\n+    std::map<COutPoint, Coin> m_temp_added;\n+\n+    /**\n+    * Coins spent by transactions being validated. When there are multiple, we need to track these\n+    * in order to distinguish between missing/spent coins and conflicts within a package.\n+    */\n+    std::set<COutPoint> m_temp_spent;\n+\n+public:\n+\n+    CCoinsViewTemporary(CCoinsView* baseIn) : CCoinsViewCache(baseIn) {}\n+\n+    // Delete the copy constructor to prevent accidentally using it when one intends to create a\n+    // CCoinsViewTemporary on top of a base cache.\n+    CCoinsViewTemporary(const CCoinsViewTemporary &) = delete;\n+\n+    bool GetCoin(const COutPoint& outpoint, Coin& coin) const override {\n+        coin = AccessCoin(outpoint);\n+        return !coin.IsSpent();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r589653414",
      "id" : 589653414,
      "in_reply_to_id" : 586764973,
      "line" : 503,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4OTY1MzQxNA==",
      "original_commit_id" : "6bf3ff6b0514b2ba199f502efd2953afdaf428a6",
      "original_line" : 503,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 72,
      "pull_request_review_id" : 606587811,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/589653414",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r589746428"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/589746428"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> â¢ parent with two distinct child transactions\r\n> â¢ child with two parent transactions\r\n\r\nAdded both tests. Thanks for the suggestion!",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-08T21:03:35Z",
      "diff_hunk" : "@@ -0,0 +1,245 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"RPCs that handle raw transaction packages.\"\"\"\n+\n+from decimal import Decimal\n+from io import BytesIO\n+\n+from test_framework.address import ADDRESS_BCRT1_P2WSH_OP_TRUE\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    BIP125_SEQUENCE_NUMBER,\n+    COIN,\n+    CTransaction,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+    hex_str_to_bytes,\n+)\n+\n+class RPCPackagesTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+        self.setup_clean_chain = True\n+\n+    def run_test(self):\n+        self.log.info(\"Generate blocks to create UTXOs\")\n+        node = self.nodes[0]\n+        self.privkeys = [node.get_deterministic_priv_key().key]\n+        self.address = node.get_deterministic_priv_key().address\n+        self.coins = []\n+        # The last 100 coinbase transactions are premature\n+        for b in node.generatetoaddress(120, self.address)[:20]:\n+            coinbase = node.getblock(blockhash=b, verbosity=2)[\"tx\"][0]\n+            self.coins.append({\n+                \"txid\": coinbase[\"txid\"],\n+                \"amount\": coinbase[\"vout\"][0][\"value\"],\n+                \"scriptPubKey\": coinbase[\"vout\"][0][\"scriptPubKey\"],\n+            })\n+\n+        # Create some transactions that can be reused throughout the test. Never submit these to mempool.\n+        self.independent_txns_hex = []\n+        self.independent_txns_testres = []\n+        for _ in range(3):\n+            coin = self.coins.pop()\n+            rawtx = node.createrawtransaction([{\"txid\" : coin[\"txid\"], \"vout\" : 0}],\n+                {self.address : coin[\"amount\"] - Decimal(\"0.0001\")})\n+            signedtx = node.signrawtransactionwithkey(hexstring=rawtx, privkeys=self.privkeys)\n+            assert signedtx[\"complete\"]\n+            testres = node.testmempoolaccept([signedtx[\"hex\"]])\n+            assert testres[0][\"allowed\"]\n+            self.independent_txns_hex.append(signedtx[\"hex\"])\n+            # testmempoolaccept returns a list of length one, avoid creating a 2D list\n+            self.independent_txns_testres.append(testres[0])\n+\n+        self.test_independent()\n+        self.test_chain()\n+        self.test_conflicting()\n+        self.test_rbf()\n+\n+    def chain_transaction(self, parent_txid, value, parent_locking_script=None):\n+        \"\"\"Build a transaction that spends parent_txid:vout.\n+        Return tuple (CTransaction object, raw hex, scriptPub).\n+        \"\"\"\n+        node = self.nodes[0]\n+        inputs = [{\"txid\" : parent_txid, \"vout\" : 0}]\n+        outputs = {self.address : value}\n+        rawtx = node.createrawtransaction(inputs, outputs)\n+        prevtxs = [{\n+            \"txid\": parent_txid,\n+            \"vout\": 0,\n+            \"scriptPubKey\": parent_locking_script,\n+            \"amount\": value + Decimal(\"0.0001\"),\n+        }] if parent_locking_script else None\n+        signedtx = node.signrawtransactionwithkey(hexstring=rawtx, privkeys=self.privkeys, prevtxs=prevtxs)\n+        tx = CTransaction()\n+        assert signedtx[\"complete\"]\n+        tx.deserialize(BytesIO(hex_str_to_bytes(signedtx[\"hex\"])))\n+        return (tx, signedtx[\"hex\"], tx.vout[0].scriptPubKey.hex())\n+\n+    def test_independent(self):\n+        self.log.info(\"Test multiple independent transactions in a package\")\n+        node = self.nodes[0]\n+        assert_equal(self.independent_txns_testres, node.testmempoolaccept(rawtxs=self.independent_txns_hex))\n+\n+        self.log.info(\"Test a valid package with garbage inserted\")\n+        garbage_tx = node.createrawtransaction([{\"txid\": \"00\" * 32, \"vout\": 5}], {self.address: 1})\n+        tx = CTransaction()\n+        tx.deserialize(BytesIO(hex_str_to_bytes(garbage_tx)))\n+        testres_bad = node.testmempoolaccept(self.independent_txns_hex + [garbage_tx])\n+        testres_independent_ids = [{\"txid\": res[\"txid\"], \"wtxid\": res[\"wtxid\"]} for res in self.independent_txns_testres]\n+        assert_equal(testres_bad, testres_independent_ids + [\n+            {\"txid\": tx.rehash(), \"wtxid\": tx.getwtxid(), \"allowed\": False, \"reject-reason\": \"missing-inputs\"}\n+        ])\n+\n+        self.log.info(\"Check testmempoolaccept tells us when some transactions completed validation successfully\")\n+        coin = self.coins.pop()\n+        tx_bad_sig_hex = node.createrawtransaction([{\"txid\" : coin[\"txid\"], \"vout\" : 0}],\n+                                           {self.address : coin[\"amount\"] - Decimal(\"0.0001\")})\n+        tx_bad_sig = CTransaction()\n+        tx_bad_sig.deserialize(BytesIO(hex_str_to_bytes(tx_bad_sig_hex)))\n+        testres_bad_sig = node.testmempoolaccept(self.independent_txns_hex + [tx_bad_sig_hex])\n+        assert_equal(testres_bad_sig, self.independent_txns_testres + [{\n+            \"txid\": tx_bad_sig.rehash(),\n+            \"wtxid\": tx_bad_sig.getwtxid(), \"allowed\": False,\n+            \"reject-reason\": \"mandatory-script-verify-flag-failed (Operation not valid with the current stack size)\"\n+        }])\n+\n+        self.log.info(\"Check testmempoolaccept reports txns in packages that exceed max feerate\")\n+        coin = self.coins.pop()\n+        tx_high_fee_raw = node.createrawtransaction([{\"txid\" : coin[\"txid\"], \"vout\" : 0}],\n+                                           {self.address : coin[\"amount\"] - Decimal(\"0.999\")})\n+        tx_high_fee_signed = node.signrawtransactionwithkey(hexstring=tx_high_fee_raw, privkeys=self.privkeys)\n+        assert tx_high_fee_signed[\"complete\"]\n+        tx_high_fee = CTransaction()\n+        tx_high_fee.deserialize(BytesIO(hex_str_to_bytes(tx_high_fee_signed[\"hex\"])))\n+        testres_high_fee = node.testmempoolaccept([tx_high_fee_signed[\"hex\"]])\n+        assert_equal(testres_high_fee, [\n+            {\"txid\": tx_high_fee.rehash(), \"wtxid\": tx_high_fee.getwtxid(), \"allowed\": False, \"reject-reason\": \"max-fee-exceeded\"}\n+        ])\n+        testres_package_high_fee = node.testmempoolaccept(self.independent_txns_hex + [tx_high_fee_signed[\"hex\"]])\n+        assert_equal(testres_package_high_fee, self.independent_txns_testres + testres_high_fee)\n+\n+    def test_chain(self):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r589746428",
      "id" : 589746428,
      "in_reply_to_id" : 587905367,
      "line" : 135,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4OTc0NjQyOA==",
      "original_commit_id" : "61d54b613d4bfbfcdd16239a73c500c5fd89ff49",
      "original_line" : 135,
      "original_position" : 125,
      "original_start_line" : null,
      "path" : "test/functional/rpc_packages.py",
      "position" : 135,
      "pull_request_review_id" : 606705865,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/589746428",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r589749652"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/589749652"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I've been thinking about your comment about making the API more lenient, and I agree that I should always let `testmempoolaccept` accept lists of transactions that aren't necessarily connected. My plan for now is to return a `depends` list for each transaction, which will allow us to test the package-ness of the transactions passed in.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-08T21:09:04Z",
      "diff_hunk" : "@@ -0,0 +1,245 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"RPCs that handle raw transaction packages.\"\"\"\n+\n+from decimal import Decimal\n+from io import BytesIO\n+\n+from test_framework.address import ADDRESS_BCRT1_P2WSH_OP_TRUE\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    BIP125_SEQUENCE_NUMBER,\n+    COIN,\n+    CTransaction,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+    hex_str_to_bytes,\n+)\n+\n+class RPCPackagesTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+        self.setup_clean_chain = True\n+\n+    def run_test(self):\n+        self.log.info(\"Generate blocks to create UTXOs\")\n+        node = self.nodes[0]\n+        self.privkeys = [node.get_deterministic_priv_key().key]\n+        self.address = node.get_deterministic_priv_key().address\n+        self.coins = []\n+        # The last 100 coinbase transactions are premature\n+        for b in node.generatetoaddress(120, self.address)[:20]:\n+            coinbase = node.getblock(blockhash=b, verbosity=2)[\"tx\"][0]\n+            self.coins.append({\n+                \"txid\": coinbase[\"txid\"],\n+                \"amount\": coinbase[\"vout\"][0][\"value\"],\n+                \"scriptPubKey\": coinbase[\"vout\"][0][\"scriptPubKey\"],\n+            })\n+\n+        # Create some transactions that can be reused throughout the test. Never submit these to mempool.\n+        self.independent_txns_hex = []\n+        self.independent_txns_testres = []\n+        for _ in range(3):\n+            coin = self.coins.pop()\n+            rawtx = node.createrawtransaction([{\"txid\" : coin[\"txid\"], \"vout\" : 0}],\n+                {self.address : coin[\"amount\"] - Decimal(\"0.0001\")})\n+            signedtx = node.signrawtransactionwithkey(hexstring=rawtx, privkeys=self.privkeys)\n+            assert signedtx[\"complete\"]\n+            testres = node.testmempoolaccept([signedtx[\"hex\"]])\n+            assert testres[0][\"allowed\"]\n+            self.independent_txns_hex.append(signedtx[\"hex\"])\n+            # testmempoolaccept returns a list of length one, avoid creating a 2D list\n+            self.independent_txns_testres.append(testres[0])\n+\n+        self.test_independent()\n+        self.test_chain()\n+        self.test_conflicting()\n+        self.test_rbf()\n+\n+    def chain_transaction(self, parent_txid, value, parent_locking_script=None):\n+        \"\"\"Build a transaction that spends parent_txid:vout.\n+        Return tuple (CTransaction object, raw hex, scriptPub).\n+        \"\"\"\n+        node = self.nodes[0]\n+        inputs = [{\"txid\" : parent_txid, \"vout\" : 0}]\n+        outputs = {self.address : value}\n+        rawtx = node.createrawtransaction(inputs, outputs)\n+        prevtxs = [{\n+            \"txid\": parent_txid,\n+            \"vout\": 0,\n+            \"scriptPubKey\": parent_locking_script,\n+            \"amount\": value + Decimal(\"0.0001\"),\n+        }] if parent_locking_script else None\n+        signedtx = node.signrawtransactionwithkey(hexstring=rawtx, privkeys=self.privkeys, prevtxs=prevtxs)\n+        tx = CTransaction()\n+        assert signedtx[\"complete\"]\n+        tx.deserialize(BytesIO(hex_str_to_bytes(signedtx[\"hex\"])))\n+        return (tx, signedtx[\"hex\"], tx.vout[0].scriptPubKey.hex())\n+\n+    def test_independent(self):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r589749652",
      "id" : 589749652,
      "in_reply_to_id" : 587906781,
      "line" : 92,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4OTc0OTY1Mg==",
      "original_commit_id" : "61d54b613d4bfbfcdd16239a73c500c5fd89ff49",
      "original_line" : 92,
      "original_position" : 82,
      "original_start_line" : null,
      "path" : "test/functional/rpc_packages.py",
      "position" : 92,
      "pull_request_review_id" : 606709912,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/589749652",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Addressed @Xekyo's comments, added more tests",
      "created_at" : "2021-03-08T21:10:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#issuecomment-793080147",
      "id" : 793080147,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20833",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MzA4MDE0Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-08T21:10:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/793080147",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r594425788"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594425788"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit : \"/* bypass_limits */ false\"",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-15T15:15:17Z",
      "diff_hunk" : "@@ -1120,6 +1304,30 @@ MempoolAcceptResult AcceptToMemoryPool(CChainState& active_chainstate, CTxMemPoo\n     return AcceptToMemoryPoolWithTime(Params(), pool, active_chainstate, tx, GetTime(), bypass_limits, test_accept);\n }\n \n+std::vector<MempoolAcceptResult> ProcessNewPackage(CChainState& active_chainstate, CTxMemPool& pool,\n+                                                   std::vector<CTransactionRef>& txns, bool test_accept)\n+{\n+    AssertLockHeld(cs_main);\n+    assert(test_accept); // Only allow package accept dry-runs (testmempoolaccept RPC).\n+\n+    std::vector<COutPoint> coins_to_uncache;\n+    const CChainParams& chainparams = Params();\n+    MemPoolAccept::ATMPArgs args { chainparams, GetTime(), false, coins_to_uncache, test_accept };",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r594425788",
      "id" : 594425788,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDQyNTc4OA==",
      "original_commit_id" : "06f8fce092edf62f5bbabc5de41b2b499046b965",
      "original_line" : 1315,
      "original_position" : 308,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 612313192,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594425788",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r594447808"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594447808"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Should we limit the submitted package size for a reasonable bound for now (`MAX_PACKAGE_SIZE`) ?\r\n\r\nEven if package can only be submitted by the RPC interface, I'm not sure I would qualify this one of fully-trusted. A service provider or L2 node might indirectly call `testmempoolaccept` on its local node with some package content contributed by a user/counterparty. E.g in LN, the number of HTLCs txn on a given commitment is partially chosen by the counterparty, even if upper bounded by protocol parameter.\r\n\r\nI would like to avoid some naive Bitcoin infrastructure opening the DoS surface of their local node by allowing thousands-width package evaluation. We don't have a visibility on package composition and the simple schemes we have in mind while designing this stuff might not be the one submitted in deployment.\r\n\r\nEDIT: I know we have (in theory) the `-limitdescendantcount` bound , but we might still have DoS around a package-specific data structure, which might be reached without triggering descendants upper bound.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-15T15:39:55Z",
      "diff_hunk" : "@@ -1120,6 +1304,30 @@ MempoolAcceptResult AcceptToMemoryPool(CChainState& active_chainstate, CTxMemPoo\n     return AcceptToMemoryPoolWithTime(Params(), pool, active_chainstate, tx, GetTime(), bypass_limits, test_accept);\n }\n \n+std::vector<MempoolAcceptResult> ProcessNewPackage(CChainState& active_chainstate, CTxMemPool& pool,\n+                                                   std::vector<CTransactionRef>& txns, bool test_accept)\n+{\n+    AssertLockHeld(cs_main);\n+    assert(test_accept); // Only allow package accept dry-runs (testmempoolaccept RPC).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r594447808",
      "id" : 594447808,
      "line" : 1349,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDQ0NzgwOA==",
      "original_commit_id" : "06f8fce092edf62f5bbabc5de41b2b499046b965",
      "original_line" : 1349,
      "original_position" : 304,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 363,
      "pull_request_review_id" : 612313192,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594447808",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r594478671"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594478671"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think we have an issue with how we're currently evaluating package in case of conflict.\r\n\r\nLet's say you have a conflicting chain of transaction with your mempool. Conflicting parent transaction has a 5sat/vbyte feerate 300 vbyte size, child transaction has a 20sat/vbyte feerate 400 vbyte size. Absolute fee of this chain of transaction is thus 5 * 300 + 20 * 400 = 9500 sat.\r\n\r\nA package is tested for mempool-acceptance with the following composition. Parent tx has a 100sat/vbyte feerate 300 vbyte size, child transaction has a 10sat/vbyte 400 vbyte size. Absolute fee of the parent transaction is thus 30000 sat.\r\n\r\nPackage parent feerate and absolute fee is superior to the replaced chain of transaction (9500sat). Following bip125 requirement it should be accepted in the mempool, and evict the conflicting chain of transactions. Package child submitted later on, even if its feerate was under the previously-conflicting child (10sat/vbyte vs 20sat/vbyte) is accepted anyway as the parent clears up the way. Note, conflicting transactions are evicted in `Finalize()`.\r\n\r\nHowever, this PR is evaluating for conflict the whole package in the raw, without removing conflicting transaction from previously and successfully evaluated package member. In the above scenario described, I think the package child would fail to be accepted in the mempool, the conflicting child still being present.\r\n\r\nThus, submitting your package via `testmempoolaccept` or your transaction atomically might yell two differing results, all other things being equal ?",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-15T16:14:39Z",
      "diff_hunk" : "@@ -1060,28 +1176,93 @@ MempoolAcceptResult MemPoolAccept::AcceptSingleTransaction(const CTransactionRef\n \n     Workspace ws(ptx);\n \n-    if (!PreChecks(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!PreChecks(args, ws)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\n \n     // Only compute the precomputed transaction data if we need to verify\n     // scripts (ie, other policy checks pass). We perform the inexpensive\n     // checks first and avoid hashing and signature verification unless those\n     // checks pass, to mitigate CPU exhaustion denial-of-service attacks.\n     PrecomputedTransactionData txdata;\n \n-    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\n \n-    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\n \n     // Tx was accepted, but not added\n     if (args.m_test_accept) {\n-        return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+        return MempoolAcceptResult(*ws.m_ptx, std::move(ws.m_replaced_transactions), ws.m_base_fees);\n     }\n \n-    if (!Finalize(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!Finalize(args, ws)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\n \n     GetMainSignals().TransactionAddedToMempool(ptx, m_pool.GetAndIncrementSequence());\n \n-    return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+    return MempoolAcceptResult(*ws.m_ptx, std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+}\n+\n+std::vector<MempoolAcceptResult> MemPoolAccept::AcceptMultipleTransactions(std::vector<CTransactionRef>& txns, ATMPArgs& args)\n+{\n+    AssertLockHeld(cs_main);\n+    std::vector<Workspace> workspaces{};\n+    const int package_size = txns.size();\n+    workspaces.reserve(package_size);\n+    std::transform(txns.begin(), txns.end(), std::back_inserter(workspaces), [](CTransactionRef& tx) {\n+        return Workspace(tx);\n+    });\n+    std::vector<MempoolAcceptResult> results;\n+    results.reserve(package_size);\n+\n+    LOCK(m_pool.cs);\n+    // Do all PreChecks first and fail fast to avoid running expensive script checks when unnecessary.\n+    for (Workspace& ws : workspaces) {\n+        if (!PreChecks(args, ws)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r594478671",
      "id" : 594478671,
      "line" : 1255,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDQ3ODY3MQ==",
      "original_commit_id" : "06f8fce092edf62f5bbabc5de41b2b499046b965",
      "original_line" : 1255,
      "original_position" : 235,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 291,
      "pull_request_review_id" : 612313192,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594478671",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r594489891"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594489891"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't follow the rational to clear the temporary coins \"otherwise scripts checks will error on coins that are spent within the package\". If a coin is already spent by a previous input from the same transaction or even another package transaction it's the expected script checks behavior to fail on it ? \r\n\r\nAt the contrary, I would understand removing coins to avoid a package parent spending a coin lately added by a package child. Thus I expect that kind of pathological case catched up earlier, when we try to access parent spent coins in `PreChecks()` ?",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-15T16:27:23Z",
      "diff_hunk" : "@@ -1060,28 +1176,93 @@ MempoolAcceptResult MemPoolAccept::AcceptSingleTransaction(const CTransactionRef\n \n     Workspace ws(ptx);\n \n-    if (!PreChecks(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!PreChecks(args, ws)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\n \n     // Only compute the precomputed transaction data if we need to verify\n     // scripts (ie, other policy checks pass). We perform the inexpensive\n     // checks first and avoid hashing and signature verification unless those\n     // checks pass, to mitigate CPU exhaustion denial-of-service attacks.\n     PrecomputedTransactionData txdata;\n \n-    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\n \n-    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\n \n     // Tx was accepted, but not added\n     if (args.m_test_accept) {\n-        return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+        return MempoolAcceptResult(*ws.m_ptx, std::move(ws.m_replaced_transactions), ws.m_base_fees);\n     }\n \n-    if (!Finalize(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!Finalize(args, ws)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\n \n     GetMainSignals().TransactionAddedToMempool(ptx, m_pool.GetAndIncrementSequence());\n \n-    return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+    return MempoolAcceptResult(*ws.m_ptx, std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+}\n+\n+std::vector<MempoolAcceptResult> MemPoolAccept::AcceptMultipleTransactions(std::vector<CTransactionRef>& txns, ATMPArgs& args)\n+{\n+    AssertLockHeld(cs_main);\n+    std::vector<Workspace> workspaces{};\n+    const int package_size = txns.size();\n+    workspaces.reserve(package_size);\n+    std::transform(txns.begin(), txns.end(), std::back_inserter(workspaces), [](CTransactionRef& tx) {\n+        return Workspace(tx);\n+    });\n+    std::vector<MempoolAcceptResult> results;\n+    results.reserve(package_size);\n+\n+    LOCK(m_pool.cs);\n+    // Do all PreChecks first and fail fast to avoid running expensive script checks when unnecessary.\n+    for (Workspace& ws : workspaces) {\n+        if (!PreChecks(args, ws)) {\n+            // Exit early to avoid doing pointless work. Return results in the same order as input txns.\n+            const auto failed_or_unfinished = [&, failed_ptx = ws.m_ptx](Workspace& ws) {\n+                                              return ws.m_ptx == failed_ptx\n+                                              ? MempoolAcceptResult(*ws.m_ptx, ws.m_state, /* finished */ true)\n+                                              : MempoolAcceptResult(*ws.m_ptx, ws.m_state, /* finished */ false);\n+            };\n+            std::transform(workspaces.begin(), workspaces.end(), std::back_inserter(results), failed_or_unfinished);\n+            return results;\n+        }\n+        m_view.PackageAddTransaction(ws.m_ptx);\n+    }\n+\n+    // Now that we have verified all inputs are available and there are no conflicts in the package,\n+    // clear the temporary coins (m_temp_added and m_temp_spent), otherwise script checks will error\n+    // on coins that are spent within the package.\n+    m_view.ClearTemporaryCoins();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r594489891",
      "id" : 594489891,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDQ4OTg5MQ==",
      "original_commit_id" : "06f8fce092edf62f5bbabc5de41b2b499046b965",
      "original_line" : 1234,
      "original_position" : 251,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 612313192,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594489891",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r594502100"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594502100"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think you're forgetting the mempool size check in `Finalize` which might exclude your newly package if it was in the feerate-bottom of the mempool. See `CTxMemPool::TrimToSize`.\r\n\r\n---------\r\n\r\nBeyond the fact that policy flags are a superset of the consensus ones, you could also recall that's running `ConsensusScriptChecks` isn't worthy here as we don't try to cache script results. `testmempoolaccept` transactions are likely never to be broadcasted on the network, so better to spare the cache, IMHO. But maybe precise we should do it when we use this code path for package evaluation from the network ?",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-15T16:42:29Z",
      "diff_hunk" : "@@ -1060,28 +1176,93 @@ MempoolAcceptResult MemPoolAccept::AcceptSingleTransaction(const CTransactionRef\n \n     Workspace ws(ptx);\n \n-    if (!PreChecks(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!PreChecks(args, ws)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\n \n     // Only compute the precomputed transaction data if we need to verify\n     // scripts (ie, other policy checks pass). We perform the inexpensive\n     // checks first and avoid hashing and signature verification unless those\n     // checks pass, to mitigate CPU exhaustion denial-of-service attacks.\n     PrecomputedTransactionData txdata;\n \n-    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\n \n-    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\n \n     // Tx was accepted, but not added\n     if (args.m_test_accept) {\n-        return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+        return MempoolAcceptResult(*ws.m_ptx, std::move(ws.m_replaced_transactions), ws.m_base_fees);\n     }\n \n-    if (!Finalize(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!Finalize(args, ws)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\n \n     GetMainSignals().TransactionAddedToMempool(ptx, m_pool.GetAndIncrementSequence());\n \n-    return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+    return MempoolAcceptResult(*ws.m_ptx, std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+}\n+\n+std::vector<MempoolAcceptResult> MemPoolAccept::AcceptMultipleTransactions(std::vector<CTransactionRef>& txns, ATMPArgs& args)\n+{\n+    AssertLockHeld(cs_main);\n+    std::vector<Workspace> workspaces{};\n+    const int package_size = txns.size();\n+    workspaces.reserve(package_size);\n+    std::transform(txns.begin(), txns.end(), std::back_inserter(workspaces), [](CTransactionRef& tx) {\n+        return Workspace(tx);\n+    });\n+    std::vector<MempoolAcceptResult> results;\n+    results.reserve(package_size);\n+\n+    LOCK(m_pool.cs);\n+    // Do all PreChecks first and fail fast to avoid running expensive script checks when unnecessary.\n+    for (Workspace& ws : workspaces) {\n+        if (!PreChecks(args, ws)) {\n+            // Exit early to avoid doing pointless work. Return results in the same order as input txns.\n+            const auto failed_or_unfinished = [&, failed_ptx = ws.m_ptx](Workspace& ws) {\n+                                              return ws.m_ptx == failed_ptx\n+                                              ? MempoolAcceptResult(*ws.m_ptx, ws.m_state, /* finished */ true)\n+                                              : MempoolAcceptResult(*ws.m_ptx, ws.m_state, /* finished */ false);\n+            };\n+            std::transform(workspaces.begin(), workspaces.end(), std::back_inserter(results), failed_or_unfinished);\n+            return results;\n+        }\n+        m_view.PackageAddTransaction(ws.m_ptx);\n+    }\n+\n+    // Now that we have verified all inputs are available and there are no conflicts in the package,\n+    // clear the temporary coins (m_temp_added and m_temp_spent), otherwise script checks will error\n+    // on coins that are spent within the package.\n+    m_view.ClearTemporaryCoins();\n+\n+    for (Workspace& ws : workspaces) {\n+        PrecomputedTransactionData txdata;\n+        if (!PolicyScriptChecks(args, ws, txdata)) {\n+            // Exit early to avoid doing pointless work. Return results in the same order as input txns.\n+            CTransactionRef failed_ptx = ws.m_ptx;\n+            const auto failed_or_unfinished = [&failed_ptx](Workspace& ws) {\n+                                              return ws.m_ptx == failed_ptx\n+                                              ? MempoolAcceptResult(*ws.m_ptx, ws.m_state, /* finished */ true)\n+                                              : MempoolAcceptResult(*ws.m_ptx, ws.m_state, /* finished */ false);\n+            };\n+            auto it_curr = std::find_if(workspaces.begin(), workspaces.end(),\n+                                        [& failed_ptx](Workspace& ws) { return ws.m_ptx == failed_ptx; });\n+            // When test_accept=true, transactions that pass PolicyScriptChecks are valid because there are\n+            // no further mempool checks (passing PolicyScriptChecks implies passing ConsensusScriptChecks).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r594502100",
      "id" : 594502100,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDUwMjEwMA==",
      "original_commit_id" : "06f8fce092edf62f5bbabc5de41b2b499046b965",
      "original_line" : 1249,
      "original_position" : 266,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 612313192,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594502100",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r594513639"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594513639"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Do you have test coverage for this ?\r\n\r\n`CalculateMemPoolAncestors` is running on `m_pool` which is updated with validated transaction only in `Finalize`. I don't see how a package transaction is successfully accounted in descendant/ancestor limits in the subsequent evaluation of the package...",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-15T16:56:13Z",
      "diff_hunk" : "@@ -876,7 +876,9 @@ static RPCHelpMan sendrawtransaction()\n static RPCHelpMan testmempoolaccept()\n {\n     return RPCHelpMan{\"testmempoolaccept\",\n-                \"\\nReturns result of mempool acceptance tests indicating if raw transaction (serialized, hex-encoded) would be accepted by mempool.\\n\"\n+                \"\\nReturns result of mempool acceptance tests indicating if raw transaction(s) (serialized, hex-encoded) would be accepted by mempool.\\n\"\n+                \"\\nIf multiple transactions are passed in, they must be sorted in order of dependency and not conflict with each other.\\n\"\n+                \"\\nThe maximum number of transactions allowed is determined by the mempool descendant policy (-limitdescendantcount).\\n\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r594513639",
      "id" : 594513639,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDUxMzYzOQ==",
      "original_commit_id" : "06f8fce092edf62f5bbabc5de41b2b499046b965",
      "original_line" : 882,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : null,
      "pull_request_review_id" : 612313192,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594513639",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r594521296"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594521296"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this is only needed for spentness evaluation in `GetCoin` ? If so just make it part of the new class.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-15T17:05:16Z",
      "diff_hunk" : "@@ -465,6 +463,114 @@ static bool CheckInputsFromMempoolAndCache(const CTransaction& tx, TxValidationS\n     return CheckInputScripts(tx, state, view, flags, /* cacheSigStore = */ true, /* cacheFullSciptStore = */ true, txdata);\n }\n \n+/** An empty coin used as a placeholder for a spent coin.*/\n+static const Coin coin_spent;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r594521296",
      "id" : 594521296,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDUyMTI5Ng==",
      "original_commit_id" : "06f8fce092edf62f5bbabc5de41b2b499046b965",
      "original_line" : 467,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 612313192,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594521296",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r594522337"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594522337"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Code-organisation wise, maybe better to move it in `coins.h`, validation.cpp is already wide enough ?",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-15T17:06:36Z",
      "diff_hunk" : "@@ -465,6 +463,114 @@ static bool CheckInputsFromMempoolAndCache(const CTransaction& tx, TxValidationS\n     return CheckInputScripts(tx, state, view, flags, /* cacheSigStore = */ true, /* cacheFullSciptStore = */ true, txdata);\n }\n \n+/** An empty coin used as a placeholder for a spent coin.*/\n+static const Coin coin_spent;\n+/**\n+ * A CoinsView that adds a memory cache to another CoinsView and serves as temporary scratch space.\n+ * Used by MemPoolAccept class to validate transactions and packages before submitting to mempool.\n+ * A backend can be set to provide read access to chainstate and/or mempool coins, but writing to\n+ * the backend is disabled. Avoid using a CCoinsViewTemporary in consensus-critical paths such\n+ * as writing to the script cache. See CheckInputsFromMempoolAndCache as an example. When not being\n+ * used to validate a package (m_temp_added and m_temp_spent are empty), a CCoinsViewTemporary\n+ * behaves exactly like a CCoinsViewCache.\n+ */\n+class CCoinsViewTemporary : public CCoinsViewCache",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r594522337",
      "id" : 594522337,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDUyMjMzNw==",
      "original_commit_id" : "06f8fce092edf62f5bbabc5de41b2b499046b965",
      "original_line" : 477,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 612313192,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594522337",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r594527279"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594527279"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think we should think twice w.r.t independence as the evaluation of _topologically_-independent packages might still have interdependent evaluations.\r\n\r\nLet's say your package 1 is replacing in-mempool tx A. Such high-feerate tx A is a replacement blocker for the low-feerate package 2. Evaluating package 1 then package 2 make both of them accepted, the reserve isn't true.\r\n\r\nAlso it make it harder to reason on package upper bound size, as you might have N independent packages all under descendant limit but collectively far above.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-15T17:12:35Z",
      "diff_hunk" : "@@ -226,6 +230,18 @@ struct MempoolAcceptResult {\n MempoolAcceptResult AcceptToMemoryPool(CChainState& active_chainstate, CTxMemPool& pool, const CTransactionRef& tx,\n                                        bool bypass_limits, bool test_accept=false) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+/**\n+* Atomically test acceptance of multiple transactions.\n+* @param[in]    txns                Group of transactions which may be independent or contain",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r594527279",
      "id" : 594527279,
      "line" : 260,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDUyNzI3OQ==",
      "original_commit_id" : "06f8fce092edf62f5bbabc5de41b2b499046b965",
      "original_line" : 260,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 92,
      "pull_request_review_id" : 612313192,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594527279",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r594661303"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594661303"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I actually think it's better organization to put it in validation.cpp, since it's only used by MemPoolAccept.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-15T20:29:10Z",
      "diff_hunk" : "@@ -465,6 +463,114 @@ static bool CheckInputsFromMempoolAndCache(const CTransaction& tx, TxValidationS\n     return CheckInputScripts(tx, state, view, flags, /* cacheSigStore = */ true, /* cacheFullSciptStore = */ true, txdata);\n }\n \n+/** An empty coin used as a placeholder for a spent coin.*/\n+static const Coin coin_spent;\n+/**\n+ * A CoinsView that adds a memory cache to another CoinsView and serves as temporary scratch space.\n+ * Used by MemPoolAccept class to validate transactions and packages before submitting to mempool.\n+ * A backend can be set to provide read access to chainstate and/or mempool coins, but writing to\n+ * the backend is disabled. Avoid using a CCoinsViewTemporary in consensus-critical paths such\n+ * as writing to the script cache. See CheckInputsFromMempoolAndCache as an example. When not being\n+ * used to validate a package (m_temp_added and m_temp_spent are empty), a CCoinsViewTemporary\n+ * behaves exactly like a CCoinsViewCache.\n+ */\n+class CCoinsViewTemporary : public CCoinsViewCache",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r594661303",
      "id" : 594661303,
      "in_reply_to_id" : 594522337,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDY2MTMwMw==",
      "original_commit_id" : "06f8fce092edf62f5bbabc5de41b2b499046b965",
      "original_line" : 477,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 612615911,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594661303",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r594662472"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594662472"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'll update the comment to make it clearer. A lot of functions in the script checks do a quick assert(!coin.IsSpent()) sanity check. This breaks when the coin is spent by a later transaction in the package (and we've updated it while going through all the PreChecks)",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-15T20:31:06Z",
      "diff_hunk" : "@@ -1060,28 +1176,93 @@ MempoolAcceptResult MemPoolAccept::AcceptSingleTransaction(const CTransactionRef\n \n     Workspace ws(ptx);\n \n-    if (!PreChecks(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!PreChecks(args, ws)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\n \n     // Only compute the precomputed transaction data if we need to verify\n     // scripts (ie, other policy checks pass). We perform the inexpensive\n     // checks first and avoid hashing and signature verification unless those\n     // checks pass, to mitigate CPU exhaustion denial-of-service attacks.\n     PrecomputedTransactionData txdata;\n \n-    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\n \n-    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\n \n     // Tx was accepted, but not added\n     if (args.m_test_accept) {\n-        return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+        return MempoolAcceptResult(*ws.m_ptx, std::move(ws.m_replaced_transactions), ws.m_base_fees);\n     }\n \n-    if (!Finalize(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!Finalize(args, ws)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\n \n     GetMainSignals().TransactionAddedToMempool(ptx, m_pool.GetAndIncrementSequence());\n \n-    return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+    return MempoolAcceptResult(*ws.m_ptx, std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+}\n+\n+std::vector<MempoolAcceptResult> MemPoolAccept::AcceptMultipleTransactions(std::vector<CTransactionRef>& txns, ATMPArgs& args)\n+{\n+    AssertLockHeld(cs_main);\n+    std::vector<Workspace> workspaces{};\n+    const int package_size = txns.size();\n+    workspaces.reserve(package_size);\n+    std::transform(txns.begin(), txns.end(), std::back_inserter(workspaces), [](CTransactionRef& tx) {\n+        return Workspace(tx);\n+    });\n+    std::vector<MempoolAcceptResult> results;\n+    results.reserve(package_size);\n+\n+    LOCK(m_pool.cs);\n+    // Do all PreChecks first and fail fast to avoid running expensive script checks when unnecessary.\n+    for (Workspace& ws : workspaces) {\n+        if (!PreChecks(args, ws)) {\n+            // Exit early to avoid doing pointless work. Return results in the same order as input txns.\n+            const auto failed_or_unfinished = [&, failed_ptx = ws.m_ptx](Workspace& ws) {\n+                                              return ws.m_ptx == failed_ptx\n+                                              ? MempoolAcceptResult(*ws.m_ptx, ws.m_state, /* finished */ true)\n+                                              : MempoolAcceptResult(*ws.m_ptx, ws.m_state, /* finished */ false);\n+            };\n+            std::transform(workspaces.begin(), workspaces.end(), std::back_inserter(results), failed_or_unfinished);\n+            return results;\n+        }\n+        m_view.PackageAddTransaction(ws.m_ptx);\n+    }\n+\n+    // Now that we have verified all inputs are available and there are no conflicts in the package,\n+    // clear the temporary coins (m_temp_added and m_temp_spent), otherwise script checks will error\n+    // on coins that are spent within the package.\n+    m_view.ClearTemporaryCoins();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r594662472",
      "id" : 594662472,
      "in_reply_to_id" : 594489891,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDY2MjQ3Mg==",
      "original_commit_id" : "06f8fce092edf62f5bbabc5de41b2b499046b965",
      "original_line" : 1234,
      "original_position" : 251,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 612617407,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594662472",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r595906163"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595906163"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can this be a const reference?\r\n\r\n```suggestion\r\n                        const CCoinsView& viewMemPool,\r\n```\r\n\r\nPassing by const reference indicates that the argument won't be mutated in the function, and is the preferred way of passing in-params that are not cheap to copy (https://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Rf-in)",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-17T10:50:14Z",
      "diff_hunk" : "@@ -258,11 +276,11 @@ bool TestLockPointValidity(CChain& active_chain, const LockPoints* lp) EXCLUSIVE\n  * See consensus/consensus.h for flag definitions.\n  */\n bool CheckSequenceLocks(CChainState& active_chainstate,\n-                        const CTxMemPool& pool,\n+                        CCoinsView& viewMemPool,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r595906163",
      "id" : 595906163,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTkwNjE2Mw==",
      "original_commit_id" : "06f8fce092edf62f5bbabc5de41b2b499046b965",
      "original_line" : 279,
      "original_position" : 82,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 614162419,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595906163",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r595919203"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595919203"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Indeed:\r\n\r\n```diff\r\n-/** An empty coin used as a placeholder for a spent coin.*/\r\n-static const Coin coin_spent;\r\n /**\r\n  * A CoinsView that adds a memory cache to another CoinsView and serves as temporary scratch space.\r\n  * Used by MemPoolAccept class to validate transactions and packages before submitting to mempool.\r\n@@ -489,6 +487,8 @@ protected:\r\n     */\r\n     std::set<COutPoint> m_temp_spent;\r\n \r\n+    /** An empty coin used as a placeholder for a spent coin.*/\r\n+    inline static const Coin s_coin_spent;\r\n public:\r\n \r\n     CCoinsViewTemporary(CCoinsView* baseIn) : CCoinsViewCache(baseIn) {}\r\n@@ -506,7 +506,7 @@ public:\r\n         // Check to see if another tx in the package has already spent this coin (conflict-in-package).\r\n         // Coins spent by others in the package are only tracked in m_temp_spent.\r\n         if (m_temp_spent.count(outpoint)) {\r\n-            return coin_spent;\r\n+            return s_coin_spent;\r\n         }\r\n```",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-17T11:09:40Z",
      "diff_hunk" : "@@ -465,6 +463,114 @@ static bool CheckInputsFromMempoolAndCache(const CTransaction& tx, TxValidationS\n     return CheckInputScripts(tx, state, view, flags, /* cacheSigStore = */ true, /* cacheFullSciptStore = */ true, txdata);\n }\n \n+/** An empty coin used as a placeholder for a spent coin.*/\n+static const Coin coin_spent;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r595919203",
      "id" : 595919203,
      "in_reply_to_id" : 594521296,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTkxOTIwMw==",
      "original_commit_id" : "06f8fce092edf62f5bbabc5de41b2b499046b965",
      "original_line" : 467,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 614162419,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595919203",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r595922179"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595922179"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You could combine these into a single `std::set<COutPoint, std::optional<Coin>>` (where `nullopt` indicates that the coin has been spent). That'd avoid doing lookups in both places. Up to you whether you think that's clearer or not.\r\n\r\nEDIT: Or even just use `std::set<COutPoint, Coin>`, where the `Coin` is an empty (spent) coin if the coin has been spent.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-17T11:14:21Z",
      "diff_hunk" : "@@ -465,6 +463,114 @@ static bool CheckInputsFromMempoolAndCache(const CTransaction& tx, TxValidationS\n     return CheckInputScripts(tx, state, view, flags, /* cacheSigStore = */ true, /* cacheFullSciptStore = */ true, txdata);\n }\n \n+/** An empty coin used as a placeholder for a spent coin.*/\n+static const Coin coin_spent;\n+/**\n+ * A CoinsView that adds a memory cache to another CoinsView and serves as temporary scratch space.\n+ * Used by MemPoolAccept class to validate transactions and packages before submitting to mempool.\n+ * A backend can be set to provide read access to chainstate and/or mempool coins, but writing to\n+ * the backend is disabled. Avoid using a CCoinsViewTemporary in consensus-critical paths such\n+ * as writing to the script cache. See CheckInputsFromMempoolAndCache as an example. When not being\n+ * used to validate a package (m_temp_added and m_temp_spent are empty), a CCoinsViewTemporary\n+ * behaves exactly like a CCoinsViewCache.\n+ */\n+class CCoinsViewTemporary : public CCoinsViewCache\n+{\n+protected:\n+    /**\n+    * Coins made available by transactions being validated. Tracking these allows for package\n+    * validation, since we can access transaction outputs without submitting them to mempool.\n+    */\n+    std::map<COutPoint, Coin> m_temp_added;\n+\n+    /**\n+    * Coins spent by transactions being validated. When there are multiple, we need to track these\n+    * in order to distinguish between missing/spent coins and conflicts within a package.\n+    */\n+    std::set<COutPoint> m_temp_spent;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r595922179",
      "id" : 595922179,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTkyMjE3OQ==",
      "original_commit_id" : "06f8fce092edf62f5bbabc5de41b2b499046b965",
      "original_line" : 488,
      "original_position" : 52,
      "original_start_line" : 484,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 614162419,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595922179",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r595923333"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595923333"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    * Coins spent by transactions being validated. When validating a package, we need to track these\r\n```",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-17T11:16:11Z",
      "diff_hunk" : "@@ -465,6 +463,114 @@ static bool CheckInputsFromMempoolAndCache(const CTransaction& tx, TxValidationS\n     return CheckInputScripts(tx, state, view, flags, /* cacheSigStore = */ true, /* cacheFullSciptStore = */ true, txdata);\n }\n \n+/** An empty coin used as a placeholder for a spent coin.*/\n+static const Coin coin_spent;\n+/**\n+ * A CoinsView that adds a memory cache to another CoinsView and serves as temporary scratch space.\n+ * Used by MemPoolAccept class to validate transactions and packages before submitting to mempool.\n+ * A backend can be set to provide read access to chainstate and/or mempool coins, but writing to\n+ * the backend is disabled. Avoid using a CCoinsViewTemporary in consensus-critical paths such\n+ * as writing to the script cache. See CheckInputsFromMempoolAndCache as an example. When not being\n+ * used to validate a package (m_temp_added and m_temp_spent are empty), a CCoinsViewTemporary\n+ * behaves exactly like a CCoinsViewCache.\n+ */\n+class CCoinsViewTemporary : public CCoinsViewCache\n+{\n+protected:\n+    /**\n+    * Coins made available by transactions being validated. Tracking these allows for package\n+    * validation, since we can access transaction outputs without submitting them to mempool.\n+    */\n+    std::map<COutPoint, Coin> m_temp_added;\n+\n+    /**\n+    * Coins spent by transactions being validated. When there are multiple, we need to track these",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r595923333",
      "id" : 595923333,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTkyMzMzMw==",
      "original_commit_id" : "06f8fce092edf62f5bbabc5de41b2b499046b965",
      "original_line" : 487,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 614162419,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595923333",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r595924363"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595924363"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We've stopped using hungarian style naming, so this should probably just be called `CoinsViewTemporary` (the `C` indicated \"class\")",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-17T11:17:41Z",
      "diff_hunk" : "@@ -465,6 +463,114 @@ static bool CheckInputsFromMempoolAndCache(const CTransaction& tx, TxValidationS\n     return CheckInputScripts(tx, state, view, flags, /* cacheSigStore = */ true, /* cacheFullSciptStore = */ true, txdata);\n }\n \n+/** An empty coin used as a placeholder for a spent coin.*/\n+static const Coin coin_spent;\n+/**\n+ * A CoinsView that adds a memory cache to another CoinsView and serves as temporary scratch space.\n+ * Used by MemPoolAccept class to validate transactions and packages before submitting to mempool.\n+ * A backend can be set to provide read access to chainstate and/or mempool coins, but writing to\n+ * the backend is disabled. Avoid using a CCoinsViewTemporary in consensus-critical paths such\n+ * as writing to the script cache. See CheckInputsFromMempoolAndCache as an example. When not being\n+ * used to validate a package (m_temp_added and m_temp_spent are empty), a CCoinsViewTemporary\n+ * behaves exactly like a CCoinsViewCache.\n+ */\n+class CCoinsViewTemporary : public CCoinsViewCache",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r595924363",
      "id" : 595924363,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTkyNDM2Mw==",
      "original_commit_id" : "06f8fce092edf62f5bbabc5de41b2b499046b965",
      "original_line" : 477,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 614162419,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595924363",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r595931131"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595931131"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Doesn't need to be `protected`. Nothing inherits from this class so it can use (default) private specifier.\r\n\r\n```suggestion\r\n```",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-17T11:28:33Z",
      "diff_hunk" : "@@ -465,6 +463,114 @@ static bool CheckInputsFromMempoolAndCache(const CTransaction& tx, TxValidationS\n     return CheckInputScripts(tx, state, view, flags, /* cacheSigStore = */ true, /* cacheFullSciptStore = */ true, txdata);\n }\n \n+/** An empty coin used as a placeholder for a spent coin.*/\n+static const Coin coin_spent;\n+/**\n+ * A CoinsView that adds a memory cache to another CoinsView and serves as temporary scratch space.\n+ * Used by MemPoolAccept class to validate transactions and packages before submitting to mempool.\n+ * A backend can be set to provide read access to chainstate and/or mempool coins, but writing to\n+ * the backend is disabled. Avoid using a CCoinsViewTemporary in consensus-critical paths such\n+ * as writing to the script cache. See CheckInputsFromMempoolAndCache as an example. When not being\n+ * used to validate a package (m_temp_added and m_temp_spent are empty), a CCoinsViewTemporary\n+ * behaves exactly like a CCoinsViewCache.\n+ */\n+class CCoinsViewTemporary : public CCoinsViewCache\n+{\n+protected:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r595931131",
      "id" : 595931131,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTkzMTEzMQ==",
      "original_commit_id" : "06f8fce092edf62f5bbabc5de41b2b499046b965",
      "original_line" : 479,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 614162419,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595931131",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r595946210"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595946210"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It makes me slightly uneasy that we're returning a reference to a CTransaction object which was passed in to `ProcessNewPackage()`. The caller needs to know that they can't let that passed-in CTransaction go out of scope, or they'll have a dangling reference.\r\n\r\nWhat do you think about passing back the txid, and then having the caller look up the txid/wtxid/virtual size from the CTransaction object that they're holding? Or passing back those details in the MempoolAcceptResult?",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-17T11:53:05Z",
      "diff_hunk" : "@@ -189,32 +189,36 @@ void PruneBlockFilesManual(CChainState& active_chainstate, int nManualPruneHeigh\n * Validation result for a single transaction mempool acceptance.\n */\n struct MempoolAcceptResult {\n-    /** Used to indicate the results of mempool validation,\n-    * including the possibility of unfinished validation.\n+    /** Used to indicate the results of mempool validation.\n+    * It's possible for a result to be unknown in the case of\n+    * package validation when an earlier tx fails and validation\n+    * is terminated early. See ResultType::UNFINISHED.\n     */\n     enum class ResultType {\n         VALID, //!> Fully validated, valid.\n         INVALID, //!> Invalid.\n+        UNFINISHED, //!> Not fully validated.\n     };\n-    ResultType m_result_type;\n-    TxValidationState m_state;\n+    const CTransaction& m_tx;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r595946210",
      "id" : 595946210,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTk0NjIxMA==",
      "original_commit_id" : "06f8fce092edf62f5bbabc5de41b2b499046b965",
      "original_line" : 202,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 614162419,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595946210",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r595957763"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595957763"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It's not immediately obvious what the different constructor calls here indicate. Perhaps adding factory methods to the struct would make it a bit clearer:\r\n\r\n```diff\r\ndiff --git a/src/validation.cpp b/src/validation.cpp\r\nindex 121181393d..c65964a976 100644\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -1176,7 +1176,7 @@ MempoolAcceptResult MemPoolAccept::AcceptSingleTransaction(const CTransactionRef\r\n \r\n     Workspace ws(ptx);\r\n \r\n-    if (!PreChecks(args, ws)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\r\n+    if (!PreChecks(args, ws)) return MempoolAcceptResult::Failure(*ws.m_ptx, ws.m_state);\r\n \r\n     // Only compute the precomputed transaction data if we need to verify\r\n     // scripts (ie, other policy checks pass). We perform the inexpensive\r\n@@ -1184,20 +1184,20 @@ MempoolAcceptResult MemPoolAccept::AcceptSingleTransaction(const CTransactionRef\r\n     // checks pass, to mitigate CPU exhaustion denial-of-service attacks.\r\n     PrecomputedTransactionData txdata;\r\n \r\n-    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\r\n+    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult::Failure(*ws.m_ptx, ws.m_state);\r\n \r\n-    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\r\n+    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult::Failure(*ws.m_ptx, ws.m_state);\r\n \r\n     // Tx was accepted, but not added\r\n     if (args.m_test_accept) {\r\n-        return MempoolAcceptResult(*ws.m_ptx, std::move(ws.m_replaced_transactions), ws.m_base_fees);\r\n+        return MempoolAcceptResult::Success(*ws.m_ptx, std::move(ws.m_replaced_transactions), ws.m_base_fees);\r\n     }\r\n \r\n-    if (!Finalize(args, ws)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\r\n+    if (!Finalize(args, ws)) return MempoolAcceptResult::Failure(*ws.m_ptx, ws.m_state);\r\n \r\n     GetMainSignals().TransactionAddedToMempool(ptx, m_pool.GetAndIncrementSequence());\r\n \r\n-    return MempoolAcceptResult(*ws.m_ptx, std::move(ws.m_replaced_transactions), ws.m_base_fees);\r\n+    return MempoolAcceptResult::Success(*ws.m_ptx, std::move(ws.m_replaced_transactions), ws.m_base_fees);\r\n }\r\n \r\n std::vector<MempoolAcceptResult> MemPoolAccept::AcceptMultipleTransactions(std::vector<CTransactionRef>& txns, ATMPArgs& args)\r\n@@ -1219,8 +1219,8 @@ std::vector<MempoolAcceptResult> MemPoolAccept::AcceptMultipleTransactions(std::\r\n             // Exit early to avoid doing pointless work. Return results in the same order as input txns.\r\n             const auto failed_or_unfinished = [&, failed_ptx = ws.m_ptx](Workspace& ws) {\r\n                                               return ws.m_ptx == failed_ptx\r\n-                                              ? MempoolAcceptResult(*ws.m_ptx, ws.m_state, /* finished */ true)\r\n-                                              : MempoolAcceptResult(*ws.m_ptx, ws.m_state, /* finished */ false);\r\n+                                              ? MempoolAcceptResult::Failure(*ws.m_ptx, ws.m_state, /* finished */ true)\r\n+                                              : MempoolAcceptResult::Failure(*ws.m_ptx, ws.m_state, /* finished */ false);\r\n             };\r\n             std::transform(workspaces.begin(), workspaces.end(), std::back_inserter(results), failed_or_unfinished);\r\n             return results;\r\n@@ -1240,15 +1240,15 @@ std::vector<MempoolAcceptResult> MemPoolAccept::AcceptMultipleTransactions(std::\r\n             CTransactionRef failed_ptx = ws.m_ptx;\r\n             const auto failed_or_unfinished = [&failed_ptx](Workspace& ws) {\r\n                                               return ws.m_ptx == failed_ptx\r\n-                                              ? MempoolAcceptResult(*ws.m_ptx, ws.m_state, /* finished */ true)\r\n-                                              : MempoolAcceptResult(*ws.m_ptx, ws.m_state, /* finished */ false);\r\n+                                              ? MempoolAcceptResult::Failure(*ws.m_ptx, ws.m_state, /* finished */ true)\r\n+                                              : MempoolAcceptResult::Failure(*ws.m_ptx, ws.m_state, /* finished */ false);\r\n             };\r\n             auto it_curr = std::find_if(workspaces.begin(), workspaces.end(),\r\n                                         [& failed_ptx](Workspace& ws) { return ws.m_ptx == failed_ptx; });\r\n             // When test_accept=true, transactions that pass PolicyScriptChecks are valid because there are\r\n             // no further mempool checks (passing PolicyScriptChecks implies passing ConsensusScriptChecks).\r\n             std::transform(workspaces.begin(), it_curr, std::back_inserter(results), [](Workspace& ws) {\r\n-                           return MempoolAcceptResult(*ws.m_ptx, std::move(ws.m_replaced_transactions), ws.m_base_fees);\r\n+                           return MempoolAcceptResult::Success(*ws.m_ptx, std::move(ws.m_replaced_transactions), ws.m_base_fees);\r\n             });\r\n             std::transform(it_curr, workspaces.end(), std::back_inserter(results), failed_or_unfinished);\r\n             return results;\r\n@@ -1260,7 +1260,7 @@ std::vector<MempoolAcceptResult> MemPoolAccept::AcceptMultipleTransactions(std::\r\n \r\n     std::transform(workspaces.begin(), workspaces.end(), std::back_inserter(results), [](Workspace& ws) {\r\n         // All successful MemPoolAcceptResults\r\n-        return MempoolAcceptResult(*ws.m_ptx, std::move(ws.m_replaced_transactions), ws.m_base_fees);\r\n+        return MempoolAcceptResult::Success(*ws.m_ptx, std::move(ws.m_replaced_transactions), ws.m_base_fees);\r\n     });\r\n     return results;\r\n }\r\ndiff --git a/src/validation.h b/src/validation.h\r\nindex 64f1b24743..234c1db895 100644\r\n--- a/src/validation.h\r\n+++ b/src/validation.h\r\n@@ -209,8 +209,19 @@ struct MempoolAcceptResult {\r\n     /** Raw base fees in satoshis. */\r\n     const std::optional<CAmount> m_base_fees;\r\n \r\n+    static MempoolAcceptResult Success(const CTransaction& tx, std::list<CTransactionRef>&& replaced_txns, CAmount fees)\r\n+    {\r\n+        return MempoolAcceptResult(tx, std::move(replaced_txns), fees);\r\n+    }\r\n+\r\n+    static MempoolAcceptResult Failure(const CTransaction& tx, TxValidationState state, bool finished=true)\r\n+    {\r\n+        return MempoolAcceptResult(tx, state, finished);\r\n+    }\r\n+\r\n+private:\r\n     /** Constructor for failure case */\r\n-    explicit MempoolAcceptResult(const CTransaction& tx, TxValidationState state, bool finished=true)\r\n+    explicit MempoolAcceptResult(const CTransaction& tx, TxValidationState state, bool finished)\r\n         : m_tx(tx), m_result_type(finished ? ResultType::INVALID : ResultType::UNFINISHED),\r\n         m_state(state), m_replaced_transactions(nullopt), m_base_fees(nullopt) {\r\n             if (finished) Assume(!state.IsValid()); // Can be invalid or error\r\n```",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-17T12:11:10Z",
      "diff_hunk" : "@@ -1060,28 +1176,93 @@ MempoolAcceptResult MemPoolAccept::AcceptSingleTransaction(const CTransactionRef\n \n     Workspace ws(ptx);\n \n-    if (!PreChecks(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!PreChecks(args, ws)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r595957763",
      "id" : 595957763,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTk1Nzc2Mw==",
      "original_commit_id" : "06f8fce092edf62f5bbabc5de41b2b499046b965",
      "original_line" : 1179,
      "original_position" : 191,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 614162419,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595957763",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r595962632"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595962632"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It's confusing that you're using the same variable name `ws` in the for loop and as an argument to this lambda.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-17T12:18:45Z",
      "diff_hunk" : "@@ -1060,28 +1176,93 @@ MempoolAcceptResult MemPoolAccept::AcceptSingleTransaction(const CTransactionRef\n \n     Workspace ws(ptx);\n \n-    if (!PreChecks(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!PreChecks(args, ws)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\n \n     // Only compute the precomputed transaction data if we need to verify\n     // scripts (ie, other policy checks pass). We perform the inexpensive\n     // checks first and avoid hashing and signature verification unless those\n     // checks pass, to mitigate CPU exhaustion denial-of-service attacks.\n     PrecomputedTransactionData txdata;\n \n-    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\n \n-    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\n \n     // Tx was accepted, but not added\n     if (args.m_test_accept) {\n-        return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+        return MempoolAcceptResult(*ws.m_ptx, std::move(ws.m_replaced_transactions), ws.m_base_fees);\n     }\n \n-    if (!Finalize(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!Finalize(args, ws)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\n \n     GetMainSignals().TransactionAddedToMempool(ptx, m_pool.GetAndIncrementSequence());\n \n-    return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+    return MempoolAcceptResult(*ws.m_ptx, std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+}\n+\n+std::vector<MempoolAcceptResult> MemPoolAccept::AcceptMultipleTransactions(std::vector<CTransactionRef>& txns, ATMPArgs& args)\n+{\n+    AssertLockHeld(cs_main);\n+    std::vector<Workspace> workspaces{};\n+    const int package_size = txns.size();\n+    workspaces.reserve(package_size);\n+    std::transform(txns.begin(), txns.end(), std::back_inserter(workspaces), [](CTransactionRef& tx) {\n+        return Workspace(tx);\n+    });\n+    std::vector<MempoolAcceptResult> results;\n+    results.reserve(package_size);\n+\n+    LOCK(m_pool.cs);\n+    // Do all PreChecks first and fail fast to avoid running expensive script checks when unnecessary.\n+    for (Workspace& ws : workspaces) {\n+        if (!PreChecks(args, ws)) {\n+            // Exit early to avoid doing pointless work. Return results in the same order as input txns.\n+            const auto failed_or_unfinished = [&, failed_ptx = ws.m_ptx](Workspace& ws) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r595962632",
      "id" : 595962632,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTk2MjYzMg==",
      "original_commit_id" : "06f8fce092edf62f5bbabc5de41b2b499046b965",
      "original_line" : 1220,
      "original_position" : 237,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 614162419,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595962632",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r595967349"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595967349"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I wonder if we should have a separate constructor for the UNFINISHED state. It doesn't really make sense to pass in a `TxValidationState` object if acceptance testing is incomplete.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-17T12:25:52Z",
      "diff_hunk" : "@@ -189,32 +189,36 @@ void PruneBlockFilesManual(CChainState& active_chainstate, int nManualPruneHeigh\n * Validation result for a single transaction mempool acceptance.\n */\n struct MempoolAcceptResult {\n-    /** Used to indicate the results of mempool validation,\n-    * including the possibility of unfinished validation.\n+    /** Used to indicate the results of mempool validation.\n+    * It's possible for a result to be unknown in the case of\n+    * package validation when an earlier tx fails and validation\n+    * is terminated early. See ResultType::UNFINISHED.\n     */\n     enum class ResultType {\n         VALID, //!> Fully validated, valid.\n         INVALID, //!> Invalid.\n+        UNFINISHED, //!> Not fully validated.\n     };\n-    ResultType m_result_type;\n-    TxValidationState m_state;\n+    const CTransaction& m_tx;\n+    const ResultType m_result_type;\n+    const TxValidationState m_state;\n \n     // The following fields are only present when m_result_type = ResultType::VALID\n     /** Mempool transactions replaced by the tx per BIP 125 rules. */\n-    std::optional<std::list<CTransactionRef>> m_replaced_transactions;\n-    /** Raw base fees. */\n-    std::optional<CAmount> m_base_fees;\n+    const std::optional<std::list<CTransactionRef>> m_replaced_transactions;\n+    /** Raw base fees in satoshis. */\n+    const std::optional<CAmount> m_base_fees;\n \n     /** Constructor for failure case */\n-    explicit MempoolAcceptResult(TxValidationState state)\n-        : m_result_type(ResultType::INVALID),\n+    explicit MempoolAcceptResult(const CTransaction& tx, TxValidationState state, bool finished=true)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r595967349",
      "id" : 595967349,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTk2NzM0OQ==",
      "original_commit_id" : "06f8fce092edf62f5bbabc5de41b2b499046b965",
      "original_line" : 213,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 614162419,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595967349",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r595971282"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595971282"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I love `std::transform` more than most, but I think this would be simpler if you just pushed the results onto `results` as you went (and then filled in the remaining `results` as `UNFINISHED` if you fail on any tx).",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-17T12:31:34Z",
      "diff_hunk" : "@@ -1060,28 +1176,93 @@ MempoolAcceptResult MemPoolAccept::AcceptSingleTransaction(const CTransactionRef\n \n     Workspace ws(ptx);\n \n-    if (!PreChecks(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!PreChecks(args, ws)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\n \n     // Only compute the precomputed transaction data if we need to verify\n     // scripts (ie, other policy checks pass). We perform the inexpensive\n     // checks first and avoid hashing and signature verification unless those\n     // checks pass, to mitigate CPU exhaustion denial-of-service attacks.\n     PrecomputedTransactionData txdata;\n \n-    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\n \n-    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\n \n     // Tx was accepted, but not added\n     if (args.m_test_accept) {\n-        return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+        return MempoolAcceptResult(*ws.m_ptx, std::move(ws.m_replaced_transactions), ws.m_base_fees);\n     }\n \n-    if (!Finalize(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!Finalize(args, ws)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\n \n     GetMainSignals().TransactionAddedToMempool(ptx, m_pool.GetAndIncrementSequence());\n \n-    return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+    return MempoolAcceptResult(*ws.m_ptx, std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+}\n+\n+std::vector<MempoolAcceptResult> MemPoolAccept::AcceptMultipleTransactions(std::vector<CTransactionRef>& txns, ATMPArgs& args)\n+{\n+    AssertLockHeld(cs_main);\n+    std::vector<Workspace> workspaces{};\n+    const int package_size = txns.size();\n+    workspaces.reserve(package_size);\n+    std::transform(txns.begin(), txns.end(), std::back_inserter(workspaces), [](CTransactionRef& tx) {\n+        return Workspace(tx);\n+    });\n+    std::vector<MempoolAcceptResult> results;\n+    results.reserve(package_size);\n+\n+    LOCK(m_pool.cs);\n+    // Do all PreChecks first and fail fast to avoid running expensive script checks when unnecessary.\n+    for (Workspace& ws : workspaces) {\n+        if (!PreChecks(args, ws)) {\n+            // Exit early to avoid doing pointless work. Return results in the same order as input txns.\n+            const auto failed_or_unfinished = [&, failed_ptx = ws.m_ptx](Workspace& ws) {\n+                                              return ws.m_ptx == failed_ptx\n+                                              ? MempoolAcceptResult(*ws.m_ptx, ws.m_state, /* finished */ true)\n+                                              : MempoolAcceptResult(*ws.m_ptx, ws.m_state, /* finished */ false);\n+            };\n+            std::transform(workspaces.begin(), workspaces.end(), std::back_inserter(results), failed_or_unfinished);\n+            return results;\n+        }\n+        m_view.PackageAddTransaction(ws.m_ptx);\n+    }\n+\n+    // Now that we have verified all inputs are available and there are no conflicts in the package,\n+    // clear the temporary coins (m_temp_added and m_temp_spent), otherwise script checks will error\n+    // on coins that are spent within the package.\n+    m_view.ClearTemporaryCoins();\n+\n+    for (Workspace& ws : workspaces) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r595971282",
      "id" : 595971282,
      "line" : 1291,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTk3MTI4Mg==",
      "original_commit_id" : "06f8fce092edf62f5bbabc5de41b2b499046b965",
      "original_line" : 1291,
      "original_position" : 253,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 327,
      "pull_request_review_id" : 614162419,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595971282",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-03-17T12:45:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#issuecomment-801052485",
      "id" : 801052485,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20833",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwMTA1MjQ4NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-17T12:45:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/801052485",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r596390724"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/596390724"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ooh that's nice! ð ",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-17T21:20:06Z",
      "diff_hunk" : "@@ -1060,28 +1176,93 @@ MempoolAcceptResult MemPoolAccept::AcceptSingleTransaction(const CTransactionRef\n \n     Workspace ws(ptx);\n \n-    if (!PreChecks(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!PreChecks(args, ws)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r596390724",
      "id" : 596390724,
      "in_reply_to_id" : 595957763,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NjM5MDcyNA==",
      "original_commit_id" : "06f8fce092edf62f5bbabc5de41b2b499046b965",
      "original_line" : 1179,
      "original_position" : 191,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 614795026,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/596390724",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r597224531"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597224531"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> Do you have test coverage for this ?\r\n\r\nYes, I update the test case in mempool_accept.py, it should return a JSON Serialization Error for > 25 transactions.\r\n\r\nWill be pushing an update to add package count/size limits in the validation code.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-18T20:36:30Z",
      "diff_hunk" : "@@ -876,7 +876,9 @@ static RPCHelpMan sendrawtransaction()\n static RPCHelpMan testmempoolaccept()\n {\n     return RPCHelpMan{\"testmempoolaccept\",\n-                \"\\nReturns result of mempool acceptance tests indicating if raw transaction (serialized, hex-encoded) would be accepted by mempool.\\n\"\n+                \"\\nReturns result of mempool acceptance tests indicating if raw transaction(s) (serialized, hex-encoded) would be accepted by mempool.\\n\"\n+                \"\\nIf multiple transactions are passed in, they must be sorted in order of dependency and not conflict with each other.\\n\"\n+                \"\\nThe maximum number of transactions allowed is determined by the mempool descendant policy (-limitdescendantcount).\\n\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r597224531",
      "id" : 597224531,
      "in_reply_to_id" : 594513639,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NzIyNDUzMQ==",
      "original_commit_id" : "06f8fce092edf62f5bbabc5de41b2b499046b965",
      "original_line" : 882,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : null,
      "pull_request_review_id" : 615850456,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597224531",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r597558092"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597558092"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n#include <vector>\r\n\r\n#include <consensus/validation.h>\r\n#include <primitives/transaction.h>\r\n```",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-19T10:19:38Z",
      "diff_hunk" : "@@ -0,0 +1,31 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_PACKAGES_H\n+#define BITCOIN_PACKAGES_H\n+\n+#include <consensus/validation.h>\n+#include <primitives/transaction.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r597558092",
      "id" : 597558092,
      "line" : 11,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NzU1ODA5Mg==",
      "original_commit_id" : "917d4b7cc5347c2bc6f17acd267ea3cccd5f1b75",
      "original_line" : 11,
      "original_position" : 9,
      "original_start_line" : 7,
      "path" : "src/packages.h",
      "position" : 11,
      "pull_request_review_id" : 616250661,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : 9,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597558092",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r597558738"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597558738"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can be constexpr, uint32_t and brace initialized :grimacing: \r\n\r\n```suggestion\r\nstatic constexpr uint32_t MAX_PACKAGE_COUNT{25};\r\n```",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-19T10:20:32Z",
      "diff_hunk" : "@@ -0,0 +1,31 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_PACKAGES_H\n+#define BITCOIN_PACKAGES_H\n+\n+#include <consensus/validation.h>\n+#include <primitives/transaction.h>\n+\n+/** Default maximum number of transactions in a package. */\n+static const unsigned int MAX_PACKAGE_COUNT = 25;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r597558738",
      "id" : 597558738,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NzU1ODczOA==",
      "original_commit_id" : "917d4b7cc5347c2bc6f17acd267ea3cccd5f1b75",
      "original_line" : 12,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/packages.h",
      "position" : null,
      "pull_request_review_id" : 616250661,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597558738",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r597561136"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597561136"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No need to do two lookups into the map:\r\n\r\n```suggestion\r\n        auto it = validation_result.m_tx_results.find(tx->GetHash());\r\n        if (it == validation_result.m_tx_results.end()) {\r\n            // Validation unfinished. Just return the txid and wtxid.\r\n            rpc_result.push_back(result_inner);\r\n            continue;\r\n        }\r\n        const auto& accept_result = it->second;\r\n```",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-19T10:24:32Z",
      "diff_hunk" : "@@ -923,59 +928,70 @@ static RPCHelpMan testmempoolaccept()\n         UniValueType(), // VNUM or VSTR, checked inside AmountFromValue()\n     });\n \n-    if (request.params[0].get_array().size() != 1) {\n-        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Array must contain exactly one raw transaction for now\");\n+    if (request.params[0].get_array().size() > MAX_PACKAGE_COUNT) {\n+        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Array cannot contain more than \" + ToString(MAX_PACKAGE_COUNT) + \" transactions.\");\n     }\n \n-    CMutableTransaction mtx;\n-    if (!DecodeHexTx(mtx, request.params[0].get_array()[0].get_str())) {\n-        throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed. Make sure the tx has at least one input.\");\n-    }\n-    CTransactionRef tx(MakeTransactionRef(std::move(mtx)));\n-\n+    const UniValue raw_transactions = request.params[0].get_array();\n     const CFeeRate max_raw_tx_fee_rate = request.params[1].isNull() ?\n                                              DEFAULT_MAX_RAW_TX_FEE_RATE :\n                                              CFeeRate(AmountFromValue(request.params[1]));\n \n     CTxMemPool& mempool = EnsureMemPool(request.context);\n-    int64_t virtual_size = GetVirtualTransactionSize(*tx);\n-    CAmount max_raw_tx_fee = max_raw_tx_fee_rate.GetFee(virtual_size);\n+    std::vector<CTransactionRef> txns;\n \n-    UniValue result(UniValue::VARR);\n-    UniValue result_0(UniValue::VOBJ);\n-    result_0.pushKV(\"txid\", tx->GetHash().GetHex());\n-    result_0.pushKV(\"wtxid\", tx->GetWitnessHash().GetHex());\n-\n-    const MempoolAcceptResult accept_result = WITH_LOCK(cs_main, return AcceptToMemoryPool(::ChainstateActive(), mempool, std::move(tx),\n-                                                  false /* bypass_limits */, /* test_accept */ true));\n-\n-    // Only return the fee and vsize if the transaction would pass ATMP.\n-    // These can be used to calculate the feerate.\n-    if (accept_result.m_result_type == MempoolAcceptResult::ResultType::VALID) {\n-        const CAmount fee = accept_result.m_base_fees.value();\n-        // Check that fee does not exceed maximum fee\n-        if (max_raw_tx_fee && fee > max_raw_tx_fee) {\n-            result_0.pushKV(\"allowed\", false);\n-            result_0.pushKV(\"reject-reason\", \"max-fee-exceeded\");\n-        } else {\n-            result_0.pushKV(\"allowed\", true);\n-            result_0.pushKV(\"vsize\", virtual_size);\n-            UniValue fees(UniValue::VOBJ);\n-            fees.pushKV(\"base\", ValueFromAmount(fee));\n-            result_0.pushKV(\"fees\", fees);\n+    for (unsigned int i = 0; i < raw_transactions.size(); ++i) {\n+        CMutableTransaction mtx;\n+        if (!DecodeHexTx(mtx, raw_transactions[i].get_str())) {\n+            throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed. Make sure the tx has at least one input.\");\n         }\n-        result.push_back(std::move(result_0));\n-    } else {\n-        result_0.pushKV(\"allowed\", false);\n-        const TxValidationState state = accept_result.m_state;\n-        if (state.GetResult() == TxValidationResult::TX_MISSING_INPUTS) {\n-            result_0.pushKV(\"reject-reason\", \"missing-inputs\");\n+        txns.emplace_back(MakeTransactionRef(std::move(mtx)));\n+    }\n+\n+    const PackageMempoolAcceptResult& validation_result =\n+        WITH_LOCK(cs_main, return ProcessNewPackage(::ChainstateActive(), mempool, txns, /* test_accept */ true));\n+\n+    UniValue rpc_result(UniValue::VARR);\n+\n+    for (auto tx : txns) {\n+        UniValue result_inner(UniValue::VOBJ);\n+        result_inner.pushKV(\"txid\", tx->GetHash().GetHex());\n+        result_inner.pushKV(\"wtxid\", tx->GetWitnessHash().GetHex());\n+        if (validation_result.m_tx_results.find(tx->GetHash()) == validation_result.m_tx_results.end()) {\n+            // Validation unfinished. Just return the txid and wtxid.\n+            rpc_result.push_back(result_inner);\n+            continue;\n+        }\n+        const auto& accept_result = validation_result.m_tx_results.find(tx->GetHash())->second;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r597561136",
      "id" : 597561136,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NzU2MTEzNg==",
      "original_commit_id" : "917d4b7cc5347c2bc6f17acd267ea3cccd5f1b75",
      "original_line" : 965,
      "original_position" : 113,
      "original_start_line" : 960,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : null,
      "pull_request_review_id" : 616250661,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597561136",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r597567858"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597567858"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Perhaps avoid using the global `::ChainstateActive()` function to avoid conflict with #21391 \r\n\r\n```diff\r\ndiff --git a/src/rpc/rawtransaction.cpp b/src/rpc/rawtransaction.cpp\r\nindex cddb082c2f..1ad0b16545 100644\r\n--- a/src/rpc/rawtransaction.cpp\r\n+++ b/src/rpc/rawtransaction.cpp\r\n@@ -938,6 +938,8 @@ static RPCHelpMan testmempoolaccept()\r\n                                              CFeeRate(AmountFromValue(request.params[1]));\r\n \r\n     CTxMemPool& mempool = EnsureMemPool(request.context);\r\n+    CChainState& chainstate = EnsureChainman(request.context).ActiveChainstate();\r\n     std::vector<CTransactionRef> txns;\r\n \r\n     for (unsigned int i = 0; i < raw_transactions.size(); ++i) {\r\n@@ -949,7 +951,7 @@ static RPCHelpMan testmempoolaccept()\r\n     }\r\n \r\n     const PackageMempoolAcceptResult& validation_result =\r\n-        WITH_LOCK(cs_main, return ProcessNewPackage(::ChainstateActive(), mempool, txns, /* test_accept */ true));\r\n+        WITH_LOCK(cs_main, return ProcessNewPackage(chainstate, mempool, txns, /* test_accept */ true));\r\n \r\n     UniValue rpc_result(UniValue::VARR);\r\n```",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-19T10:35:06Z",
      "diff_hunk" : "@@ -923,59 +928,70 @@ static RPCHelpMan testmempoolaccept()\n         UniValueType(), // VNUM or VSTR, checked inside AmountFromValue()\n     });\n \n-    if (request.params[0].get_array().size() != 1) {\n-        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Array must contain exactly one raw transaction for now\");\n+    if (request.params[0].get_array().size() > MAX_PACKAGE_COUNT) {\n+        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Array cannot contain more than \" + ToString(MAX_PACKAGE_COUNT) + \" transactions.\");\n     }\n \n-    CMutableTransaction mtx;\n-    if (!DecodeHexTx(mtx, request.params[0].get_array()[0].get_str())) {\n-        throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed. Make sure the tx has at least one input.\");\n-    }\n-    CTransactionRef tx(MakeTransactionRef(std::move(mtx)));\n-\n+    const UniValue raw_transactions = request.params[0].get_array();\n     const CFeeRate max_raw_tx_fee_rate = request.params[1].isNull() ?\n                                              DEFAULT_MAX_RAW_TX_FEE_RATE :\n                                              CFeeRate(AmountFromValue(request.params[1]));\n \n     CTxMemPool& mempool = EnsureMemPool(request.context);\n-    int64_t virtual_size = GetVirtualTransactionSize(*tx);\n-    CAmount max_raw_tx_fee = max_raw_tx_fee_rate.GetFee(virtual_size);\n+    std::vector<CTransactionRef> txns;\n \n-    UniValue result(UniValue::VARR);\n-    UniValue result_0(UniValue::VOBJ);\n-    result_0.pushKV(\"txid\", tx->GetHash().GetHex());\n-    result_0.pushKV(\"wtxid\", tx->GetWitnessHash().GetHex());\n-\n-    const MempoolAcceptResult accept_result = WITH_LOCK(cs_main, return AcceptToMemoryPool(::ChainstateActive(), mempool, std::move(tx),\n-                                                  false /* bypass_limits */, /* test_accept */ true));\n-\n-    // Only return the fee and vsize if the transaction would pass ATMP.\n-    // These can be used to calculate the feerate.\n-    if (accept_result.m_result_type == MempoolAcceptResult::ResultType::VALID) {\n-        const CAmount fee = accept_result.m_base_fees.value();\n-        // Check that fee does not exceed maximum fee\n-        if (max_raw_tx_fee && fee > max_raw_tx_fee) {\n-            result_0.pushKV(\"allowed\", false);\n-            result_0.pushKV(\"reject-reason\", \"max-fee-exceeded\");\n-        } else {\n-            result_0.pushKV(\"allowed\", true);\n-            result_0.pushKV(\"vsize\", virtual_size);\n-            UniValue fees(UniValue::VOBJ);\n-            fees.pushKV(\"base\", ValueFromAmount(fee));\n-            result_0.pushKV(\"fees\", fees);\n+    for (unsigned int i = 0; i < raw_transactions.size(); ++i) {\n+        CMutableTransaction mtx;\n+        if (!DecodeHexTx(mtx, raw_transactions[i].get_str())) {\n+            throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed. Make sure the tx has at least one input.\");\n         }\n-        result.push_back(std::move(result_0));\n-    } else {\n-        result_0.pushKV(\"allowed\", false);\n-        const TxValidationState state = accept_result.m_state;\n-        if (state.GetResult() == TxValidationResult::TX_MISSING_INPUTS) {\n-            result_0.pushKV(\"reject-reason\", \"missing-inputs\");\n+        txns.emplace_back(MakeTransactionRef(std::move(mtx)));\n+    }\n+\n+    const PackageMempoolAcceptResult& validation_result =\n+        WITH_LOCK(cs_main, return ProcessNewPackage(::ChainstateActive(), mempool, txns, /* test_accept */ true));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r597567858",
      "id" : 597567858,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NzU2Nzg1OA==",
      "original_commit_id" : "917d4b7cc5347c2bc6f17acd267ea3cccd5f1b75",
      "original_line" : 952,
      "original_position" : 100,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : null,
      "pull_request_review_id" : 616250661,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597567858",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r597574361"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597574361"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No need to specify default initialization in the initializer list. It'll happen anyway:\r\n\r\n```suggestion\r\n        : m_tx_results{ {txid, result} } {}\r\n```",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-19T10:45:08Z",
      "diff_hunk" : "@@ -187,34 +188,68 @@ void PruneBlockFilesManual(CChainState& active_chainstate, int nManualPruneHeigh\n * Validation result for a single transaction mempool acceptance.\n */\n struct MempoolAcceptResult {\n-    /** Used to indicate the results of mempool validation,\n-    * including the possibility of unfinished validation.\n+    /** Used to indicate the results of mempool validation.\n+    * It's possible for a result to be unknown in the case of\n+    * package validation when an earlier tx fails and validation\n+    * is terminated early. See ResultType::UNFINISHED.\n     */\n     enum class ResultType {\n         VALID, //!> Fully validated, valid.\n         INVALID, //!> Invalid.\n     };\n-    ResultType m_result_type;\n-    TxValidationState m_state;\n+    const ResultType m_result_type;\n+    const TxValidationState m_state;\n \n     // The following fields are only present when m_result_type = ResultType::VALID\n     /** Mempool transactions replaced by the tx per BIP 125 rules. */\n-    std::optional<std::list<CTransactionRef>> m_replaced_transactions;\n-    /** Raw base fees. */\n-    std::optional<CAmount> m_base_fees;\n+    const std::optional<std::list<CTransactionRef>> m_replaced_transactions;\n+    /** Raw base fees in satoshis. */\n+    const std::optional<CAmount> m_base_fees;\n \n+    static MempoolAcceptResult Failure(const TxValidationState state) {\n+        return MempoolAcceptResult(state);\n+    }\n+\n+    static MempoolAcceptResult Success(std::list<CTransactionRef>&& replaced_txns, const CAmount fees) {\n+        return MempoolAcceptResult(std::move(replaced_txns), fees);\n+    }\n+\n+// Private constructors. Use static methods MempoolAcceptResult::Success, etc. to construct.\n+private:\n     /** Constructor for failure case */\n-    explicit MempoolAcceptResult(TxValidationState state)\n-        : m_result_type(ResultType::INVALID), m_state(state) {\n+    explicit MempoolAcceptResult(const TxValidationState state)\n+        : m_result_type{ResultType::INVALID}, m_state{state}, m_replaced_transactions(std::nullopt),\n+        m_base_fees{std::nullopt} {\n             Assume(!state.IsValid()); // Can be invalid or error\n         }\n \n     /** Constructor for success case */\n-    explicit MempoolAcceptResult(std::list<CTransactionRef>&& replaced_txns, CAmount fees)\n-        : m_result_type(ResultType::VALID), m_state(TxValidationState{}),\n+    explicit MempoolAcceptResult(std::list<CTransactionRef>&& replaced_txns, const CAmount fees)\n+        : m_result_type{ResultType::VALID}, m_state{},\n         m_replaced_transactions(std::move(replaced_txns)), m_base_fees(fees) {}\n };\n \n+/**\n+* Validation result for package mempool acceptance.\n+*/\n+struct PackageMempoolAcceptResult\n+{\n+    PackageValidationState m_state;\n+    /** Map from txid to finished MempoolAcceptResults. The client is responsible\n+    * for keeping track of the transaction objects themselves. If a result is not\n+    * present, it means the validation was unfinished for that transaction.\n+    */\n+    std::map<const uint256, const MempoolAcceptResult> m_tx_results;\n+\n+    explicit PackageMempoolAcceptResult(const PackageValidationState& state,\n+                                        std::map<const uint256, const MempoolAcceptResult>&& results)\n+        : m_state{state}, m_tx_results(std::move(results)) {}\n+\n+    /** Constructor to create a PackageMempoolAcceptResult from a single MempoolAcceptResult */\n+    explicit PackageMempoolAcceptResult(const uint256& txid, const MempoolAcceptResult& result)\n+        : m_state{}, m_tx_results{ {txid, result} } {}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r597574361",
      "id" : 597574361,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NzU3NDM2MQ==",
      "original_commit_id" : "917d4b7cc5347c2bc6f17acd267ea3cccd5f1b75",
      "original_line" : 250,
      "original_position" : 82,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 616250661,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597574361",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r597580310"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597580310"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Avoid the global `::ChainstateActive()` function:\r\n\r\n```suggestion\r\n    active_chainstate.FlushStateToDisk(chainparams, state_dummy, FlushStateMode::PERIODIC);\r\n```",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-19T10:50:41Z",
      "diff_hunk" : "@@ -1120,6 +1308,32 @@ MempoolAcceptResult AcceptToMemoryPool(CChainState& active_chainstate, CTxMemPoo\n     return AcceptToMemoryPoolWithTime(Params(), pool, active_chainstate, tx, GetTime(), bypass_limits, test_accept);\n }\n \n+PackageMempoolAcceptResult ProcessNewPackage(CChainState& active_chainstate, CTxMemPool& pool,\n+                                                   const Package& package, bool test_accept)\n+{\n+    AssertLockHeld(cs_main);\n+    assert(test_accept); // Only allow package accept dry-runs (testmempoolaccept RPC).\n+\n+    std::vector<COutPoint> coins_to_uncache;\n+    const CChainParams& chainparams = Params();\n+    MemPoolAccept::ATMPArgs args { chainparams, GetTime(), /* bypass_limits */ false, coins_to_uncache, test_accept };\n+    assert(std::addressof(::ChainstateActive()) == std::addressof(active_chainstate));\n+    const PackageMempoolAcceptResult& result = package.size() > 1\n+    ? MemPoolAccept(pool, active_chainstate).AcceptMultipleTransactions(package, args)\n+    : PackageMempoolAcceptResult(package[0]->GetHash(),\n+                                 MemPoolAccept(pool, active_chainstate).AcceptSingleTransaction(package[0], args));\n+\n+    // Uncache coins pertaining to transactions that were not submitted to the mempool.\n+    // Ensure the cache is still within its size limits.\n+    for (const COutPoint& hashTx : coins_to_uncache) {\n+        active_chainstate.CoinsTip().Uncache(hashTx);\n+    }\n+    BlockValidationState state_dummy;\n+    ::ChainstateActive().FlushStateToDisk(chainparams, state_dummy, FlushStateMode::PERIODIC);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r597580310",
      "id" : 597580310,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NzU4MDMxMA==",
      "original_commit_id" : "917d4b7cc5347c2bc6f17acd267ea3cccd5f1b75",
      "original_line" : 1332,
      "original_position" : 336,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 616250661,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597580310",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r597582750"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597582750"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This looks unsafe to me. You're taking a reference to a temporary (the return value from `AcceptMultipleTransactions()` or `PackageMempoolAcceptResult()`)",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-19T10:53:10Z",
      "diff_hunk" : "@@ -1120,6 +1308,32 @@ MempoolAcceptResult AcceptToMemoryPool(CChainState& active_chainstate, CTxMemPoo\n     return AcceptToMemoryPoolWithTime(Params(), pool, active_chainstate, tx, GetTime(), bypass_limits, test_accept);\n }\n \n+PackageMempoolAcceptResult ProcessNewPackage(CChainState& active_chainstate, CTxMemPool& pool,\n+                                                   const Package& package, bool test_accept)\n+{\n+    AssertLockHeld(cs_main);\n+    assert(test_accept); // Only allow package accept dry-runs (testmempoolaccept RPC).\n+\n+    std::vector<COutPoint> coins_to_uncache;\n+    const CChainParams& chainparams = Params();\n+    MemPoolAccept::ATMPArgs args { chainparams, GetTime(), /* bypass_limits */ false, coins_to_uncache, test_accept };\n+    assert(std::addressof(::ChainstateActive()) == std::addressof(active_chainstate));\n+    const PackageMempoolAcceptResult& result = package.size() > 1",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r597582750",
      "id" : 597582750,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NzU4Mjc1MA==",
      "original_commit_id" : "917d4b7cc5347c2bc6f17acd267ea3cccd5f1b75",
      "original_line" : 1321,
      "original_position" : 325,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 616250661,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597582750",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r597583016"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597583016"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What happens here if you always call `AcceptMultipleTransactions()` (even for a single transaction?)",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-19T10:53:25Z",
      "diff_hunk" : "@@ -1120,6 +1308,32 @@ MempoolAcceptResult AcceptToMemoryPool(CChainState& active_chainstate, CTxMemPoo\n     return AcceptToMemoryPoolWithTime(Params(), pool, active_chainstate, tx, GetTime(), bypass_limits, test_accept);\n }\n \n+PackageMempoolAcceptResult ProcessNewPackage(CChainState& active_chainstate, CTxMemPool& pool,\n+                                                   const Package& package, bool test_accept)\n+{\n+    AssertLockHeld(cs_main);\n+    assert(test_accept); // Only allow package accept dry-runs (testmempoolaccept RPC).\n+\n+    std::vector<COutPoint> coins_to_uncache;\n+    const CChainParams& chainparams = Params();\n+    MemPoolAccept::ATMPArgs args { chainparams, GetTime(), /* bypass_limits */ false, coins_to_uncache, test_accept };\n+    assert(std::addressof(::ChainstateActive()) == std::addressof(active_chainstate));\n+    const PackageMempoolAcceptResult& result = package.size() > 1",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r597583016",
      "id" : 597583016,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NzU4MzAxNg==",
      "original_commit_id" : "917d4b7cc5347c2bc6f17acd267ea3cccd5f1b75",
      "original_line" : 1321,
      "original_position" : 325,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 616250661,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597583016",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r597590521"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597590521"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is this needed?",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-19T11:01:53Z",
      "diff_hunk" : "@@ -1060,28 +1184,92 @@ MempoolAcceptResult MemPoolAccept::AcceptSingleTransaction(const CTransactionRef\n \n     Workspace ws(ptx);\n \n-    if (!PreChecks(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!PreChecks(args, ws)) return MempoolAcceptResult::Failure(ws.m_state);\n \n     // Only compute the precomputed transaction data if we need to verify\n     // scripts (ie, other policy checks pass). We perform the inexpensive\n     // checks first and avoid hashing and signature verification unless those\n     // checks pass, to mitigate CPU exhaustion denial-of-service attacks.\n     PrecomputedTransactionData txdata;\n \n-    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult::Failure(ws.m_state);\n \n-    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult::Failure(ws.m_state);\n \n     // Tx was accepted, but not added\n     if (args.m_test_accept) {\n-        return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+        return MempoolAcceptResult::Success(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n     }\n \n-    if (!Finalize(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!Finalize(args, ws)) return MempoolAcceptResult::Failure(ws.m_state);\n \n     GetMainSignals().TransactionAddedToMempool(ptx, m_pool.GetAndIncrementSequence());\n \n-    return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+    return MempoolAcceptResult::Success(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+}\n+\n+PackageMempoolAcceptResult MemPoolAccept::AcceptMultipleTransactions(const std::vector<CTransactionRef>& txns, ATMPArgs& args)\n+{\n+    AssertLockHeld(cs_main);\n+\n+    PackageValidationState package_state;\n+    // Check static package limits before taking the mempool lock.\n+    const unsigned int package_count = txns.size();\n+    if (package_count > MAX_PACKAGE_COUNT) {\n+        package_state.Invalid(PackageValidationResult::PCKG_POLICY, \"too-many-transactions\");\n+        return PackageMempoolAcceptResult(package_state, {});\n+    }\n+\n+    const int64_t total_size = std::accumulate(txns.cbegin(), txns.cend(), 0,\n+        [](int64_t sum, const auto& tx) { return sum + GetVirtualTransactionSize(*tx); });\n+    if (total_size > MAX_PACKAGE_SIZE * 1000) {\n+        package_state.Invalid(PackageValidationResult::PCKG_POLICY, \"too-large\");\n+        return PackageMempoolAcceptResult(package_state, {});\n+    }\n+\n+    std::vector<Workspace> workspaces{};\n+    workspaces.reserve(package_count);\n+    std::transform(txns.cbegin(), txns.cend(), std::back_inserter(workspaces), [](const auto& tx) {\n+        return Workspace(tx);\n+    });\n+\n+    LOCK(m_pool.cs);\n+\n+    std::map<const uint256, const MempoolAcceptResult> results;\n+    // Do all PreChecks first and fail fast to avoid running expensive script checks when unnecessary.\n+    for (Workspace& ws : workspaces) {\n+        if (!PreChecks(args, ws)) {\n+            package_state.Invalid(PackageValidationResult::PCKG_TX, \"transaction failed\");\n+            // Exit early to avoid doing pointless work. Update the failed tx result; the rest are unfinished.\n+            results.emplace(ws.m_ptx->GetHash(), MempoolAcceptResult::Failure(ws.m_state));\n+            return PackageMempoolAcceptResult(package_state, std::move(results));\n+        }\n+        m_view.PackageAddTransaction(ws.m_ptx);\n+    }\n+\n+    // We have now verified all inputs are available and there are no conflicts in the package by\n+    // marking coins (temporarily) spent in m_view. However, since script checks will assert that\n+    // each coin has not been spent as a sanity check, we need to clear m_view.m_temp_spent so that\n+    // script checks don't fail on those asserts.\n+    m_view.ClearTemporarySpends();\n+\n+    for (Workspace& ws : workspaces) {\n+        PrecomputedTransactionData txdata;\n+        if (!PolicyScriptChecks(args, ws, txdata)) {\n+            // Exit early to avoid doing pointless work. Update the failed tx result; the rest are unfinished.\n+            package_state.Invalid(PackageValidationResult::PCKG_TX, \"transaction failed\");\n+            results.emplace(ws.m_ptx->GetHash(), MempoolAcceptResult::Failure(ws.m_state));\n+            return PackageMempoolAcceptResult(package_state, std::move(results));\n+        }\n+        // When test_accept=true, transactions that pass PolicyScriptChecks are valid because there are\n+        // no further mempool checks (passing PolicyScriptChecks implies passing ConsensusScriptChecks).\n+        results.emplace(ws.m_ptx->GetHash(),\n+                        MempoolAcceptResult::Success(std::move(ws.m_replaced_transactions), ws.m_base_fees));\n+    }\n+\n+    m_view.ClearTemporaryCoins();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r597590521",
      "id" : 597590521,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NzU5MDUyMQ==",
      "original_commit_id" : "917d4b7cc5347c2bc6f17acd267ea3cccd5f1b75",
      "original_line" : 1270,
      "original_position" : 294,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 616250661,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597590521",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r597758740"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597758740"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The way I have it right now, it `AcceptMultipleTransactions()` should give an identical result to `AcceptSingleTransaction()` except that multiple allows 101KvB total size (so theoretically you could have 1 tx of size 101KvB)... can't think of any other differences. But should the rules diverge further for 1 tx vs package, it'll cause some of the current `testmempoolaccept` tests to fail. I was playing around with disabling RBF for packages and ran into that, so I wanted to separate the code paths",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-19T15:12:31Z",
      "diff_hunk" : "@@ -1120,6 +1308,32 @@ MempoolAcceptResult AcceptToMemoryPool(CChainState& active_chainstate, CTxMemPoo\n     return AcceptToMemoryPoolWithTime(Params(), pool, active_chainstate, tx, GetTime(), bypass_limits, test_accept);\n }\n \n+PackageMempoolAcceptResult ProcessNewPackage(CChainState& active_chainstate, CTxMemPool& pool,\n+                                                   const Package& package, bool test_accept)\n+{\n+    AssertLockHeld(cs_main);\n+    assert(test_accept); // Only allow package accept dry-runs (testmempoolaccept RPC).\n+\n+    std::vector<COutPoint> coins_to_uncache;\n+    const CChainParams& chainparams = Params();\n+    MemPoolAccept::ATMPArgs args { chainparams, GetTime(), /* bypass_limits */ false, coins_to_uncache, test_accept };\n+    assert(std::addressof(::ChainstateActive()) == std::addressof(active_chainstate));\n+    const PackageMempoolAcceptResult& result = package.size() > 1",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r597758740",
      "id" : 597758740,
      "in_reply_to_id" : 597583016,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5Nzc1ODc0MA==",
      "original_commit_id" : "917d4b7cc5347c2bc6f17acd267ea3cccd5f1b75",
      "original_line" : 1321,
      "original_position" : 325,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 616509254,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597758740",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r597759075"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597759075"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "gah of course, my bad ð¤¦ will do",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-19T15:12:58Z",
      "diff_hunk" : "@@ -923,59 +928,70 @@ static RPCHelpMan testmempoolaccept()\n         UniValueType(), // VNUM or VSTR, checked inside AmountFromValue()\n     });\n \n-    if (request.params[0].get_array().size() != 1) {\n-        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Array must contain exactly one raw transaction for now\");\n+    if (request.params[0].get_array().size() > MAX_PACKAGE_COUNT) {\n+        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Array cannot contain more than \" + ToString(MAX_PACKAGE_COUNT) + \" transactions.\");\n     }\n \n-    CMutableTransaction mtx;\n-    if (!DecodeHexTx(mtx, request.params[0].get_array()[0].get_str())) {\n-        throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed. Make sure the tx has at least one input.\");\n-    }\n-    CTransactionRef tx(MakeTransactionRef(std::move(mtx)));\n-\n+    const UniValue raw_transactions = request.params[0].get_array();\n     const CFeeRate max_raw_tx_fee_rate = request.params[1].isNull() ?\n                                              DEFAULT_MAX_RAW_TX_FEE_RATE :\n                                              CFeeRate(AmountFromValue(request.params[1]));\n \n     CTxMemPool& mempool = EnsureMemPool(request.context);\n-    int64_t virtual_size = GetVirtualTransactionSize(*tx);\n-    CAmount max_raw_tx_fee = max_raw_tx_fee_rate.GetFee(virtual_size);\n+    std::vector<CTransactionRef> txns;\n \n-    UniValue result(UniValue::VARR);\n-    UniValue result_0(UniValue::VOBJ);\n-    result_0.pushKV(\"txid\", tx->GetHash().GetHex());\n-    result_0.pushKV(\"wtxid\", tx->GetWitnessHash().GetHex());\n-\n-    const MempoolAcceptResult accept_result = WITH_LOCK(cs_main, return AcceptToMemoryPool(::ChainstateActive(), mempool, std::move(tx),\n-                                                  false /* bypass_limits */, /* test_accept */ true));\n-\n-    // Only return the fee and vsize if the transaction would pass ATMP.\n-    // These can be used to calculate the feerate.\n-    if (accept_result.m_result_type == MempoolAcceptResult::ResultType::VALID) {\n-        const CAmount fee = accept_result.m_base_fees.value();\n-        // Check that fee does not exceed maximum fee\n-        if (max_raw_tx_fee && fee > max_raw_tx_fee) {\n-            result_0.pushKV(\"allowed\", false);\n-            result_0.pushKV(\"reject-reason\", \"max-fee-exceeded\");\n-        } else {\n-            result_0.pushKV(\"allowed\", true);\n-            result_0.pushKV(\"vsize\", virtual_size);\n-            UniValue fees(UniValue::VOBJ);\n-            fees.pushKV(\"base\", ValueFromAmount(fee));\n-            result_0.pushKV(\"fees\", fees);\n+    for (unsigned int i = 0; i < raw_transactions.size(); ++i) {\n+        CMutableTransaction mtx;\n+        if (!DecodeHexTx(mtx, raw_transactions[i].get_str())) {\n+            throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed. Make sure the tx has at least one input.\");\n         }\n-        result.push_back(std::move(result_0));\n-    } else {\n-        result_0.pushKV(\"allowed\", false);\n-        const TxValidationState state = accept_result.m_state;\n-        if (state.GetResult() == TxValidationResult::TX_MISSING_INPUTS) {\n-            result_0.pushKV(\"reject-reason\", \"missing-inputs\");\n+        txns.emplace_back(MakeTransactionRef(std::move(mtx)));\n+    }\n+\n+    const PackageMempoolAcceptResult& validation_result =\n+        WITH_LOCK(cs_main, return ProcessNewPackage(::ChainstateActive(), mempool, txns, /* test_accept */ true));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r597759075",
      "id" : 597759075,
      "in_reply_to_id" : 597567858,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5Nzc1OTA3NQ==",
      "original_commit_id" : "917d4b7cc5347c2bc6f17acd267ea3cccd5f1b75",
      "original_line" : 952,
      "original_position" : 100,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : null,
      "pull_request_review_id" : 616509759,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597759075",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r597765318"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597765318"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> I think you're forgetting the mempool size check in Finalize\r\n\r\nWe have a feerate check against the mempool minimum fee in `CheckFeeRate()` (in `PreChecks()`). The trim to size is done after submitting to mempool just in case it wasn't accurate (and I suspect the mempool lock was perhaps not held the whole time in the past, so it was possible for the mempool to grow in the time we were doing script checks?). On master, a test_accept for one transaction stops short of calling `Finalize()` and doesn't do this check either. \r\n\r\nI prefer using `CheckFeeRate()` for a test_accept; there's no need to submit to mempool, update everything, and then remove it again and re-update everything, just to check size limits. Since we would release the lock at the end of the testmempoolaccept call, it's possible for the mempool to grow before the user submits it anyway, so it's not like we're guaranteed an accurate result by doing this.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-19T15:20:50Z",
      "diff_hunk" : "@@ -1060,28 +1176,93 @@ MempoolAcceptResult MemPoolAccept::AcceptSingleTransaction(const CTransactionRef\n \n     Workspace ws(ptx);\n \n-    if (!PreChecks(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!PreChecks(args, ws)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\n \n     // Only compute the precomputed transaction data if we need to verify\n     // scripts (ie, other policy checks pass). We perform the inexpensive\n     // checks first and avoid hashing and signature verification unless those\n     // checks pass, to mitigate CPU exhaustion denial-of-service attacks.\n     PrecomputedTransactionData txdata;\n \n-    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\n \n-    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\n \n     // Tx was accepted, but not added\n     if (args.m_test_accept) {\n-        return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+        return MempoolAcceptResult(*ws.m_ptx, std::move(ws.m_replaced_transactions), ws.m_base_fees);\n     }\n \n-    if (!Finalize(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!Finalize(args, ws)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\n \n     GetMainSignals().TransactionAddedToMempool(ptx, m_pool.GetAndIncrementSequence());\n \n-    return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+    return MempoolAcceptResult(*ws.m_ptx, std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+}\n+\n+std::vector<MempoolAcceptResult> MemPoolAccept::AcceptMultipleTransactions(std::vector<CTransactionRef>& txns, ATMPArgs& args)\n+{\n+    AssertLockHeld(cs_main);\n+    std::vector<Workspace> workspaces{};\n+    const int package_size = txns.size();\n+    workspaces.reserve(package_size);\n+    std::transform(txns.begin(), txns.end(), std::back_inserter(workspaces), [](CTransactionRef& tx) {\n+        return Workspace(tx);\n+    });\n+    std::vector<MempoolAcceptResult> results;\n+    results.reserve(package_size);\n+\n+    LOCK(m_pool.cs);\n+    // Do all PreChecks first and fail fast to avoid running expensive script checks when unnecessary.\n+    for (Workspace& ws : workspaces) {\n+        if (!PreChecks(args, ws)) {\n+            // Exit early to avoid doing pointless work. Return results in the same order as input txns.\n+            const auto failed_or_unfinished = [&, failed_ptx = ws.m_ptx](Workspace& ws) {\n+                                              return ws.m_ptx == failed_ptx\n+                                              ? MempoolAcceptResult(*ws.m_ptx, ws.m_state, /* finished */ true)\n+                                              : MempoolAcceptResult(*ws.m_ptx, ws.m_state, /* finished */ false);\n+            };\n+            std::transform(workspaces.begin(), workspaces.end(), std::back_inserter(results), failed_or_unfinished);\n+            return results;\n+        }\n+        m_view.PackageAddTransaction(ws.m_ptx);\n+    }\n+\n+    // Now that we have verified all inputs are available and there are no conflicts in the package,\n+    // clear the temporary coins (m_temp_added and m_temp_spent), otherwise script checks will error\n+    // on coins that are spent within the package.\n+    m_view.ClearTemporaryCoins();\n+\n+    for (Workspace& ws : workspaces) {\n+        PrecomputedTransactionData txdata;\n+        if (!PolicyScriptChecks(args, ws, txdata)) {\n+            // Exit early to avoid doing pointless work. Return results in the same order as input txns.\n+            CTransactionRef failed_ptx = ws.m_ptx;\n+            const auto failed_or_unfinished = [&failed_ptx](Workspace& ws) {\n+                                              return ws.m_ptx == failed_ptx\n+                                              ? MempoolAcceptResult(*ws.m_ptx, ws.m_state, /* finished */ true)\n+                                              : MempoolAcceptResult(*ws.m_ptx, ws.m_state, /* finished */ false);\n+            };\n+            auto it_curr = std::find_if(workspaces.begin(), workspaces.end(),\n+                                        [& failed_ptx](Workspace& ws) { return ws.m_ptx == failed_ptx; });\n+            // When test_accept=true, transactions that pass PolicyScriptChecks are valid because there are\n+            // no further mempool checks (passing PolicyScriptChecks implies passing ConsensusScriptChecks).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r597765318",
      "id" : 597765318,
      "in_reply_to_id" : 594502100,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5Nzc2NTMxOA==",
      "original_commit_id" : "06f8fce092edf62f5bbabc5de41b2b499046b965",
      "original_line" : 1249,
      "original_position" : 266,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 616517864,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597765318",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r597768912"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597768912"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> Beyond the fact that policy flags are a superset of the consensus ones, you could also recall that's running `ConsensusScriptChecks` isn't worthy here as we don't try to cache script results.\r\n\r\nYep, I agree! See also [this discussion](https://github.com/bitcoin/bitcoin/pull/20833#discussion_r552684985).",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-19T15:25:23Z",
      "diff_hunk" : "@@ -1060,28 +1176,93 @@ MempoolAcceptResult MemPoolAccept::AcceptSingleTransaction(const CTransactionRef\n \n     Workspace ws(ptx);\n \n-    if (!PreChecks(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!PreChecks(args, ws)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\n \n     // Only compute the precomputed transaction data if we need to verify\n     // scripts (ie, other policy checks pass). We perform the inexpensive\n     // checks first and avoid hashing and signature verification unless those\n     // checks pass, to mitigate CPU exhaustion denial-of-service attacks.\n     PrecomputedTransactionData txdata;\n \n-    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\n \n-    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\n \n     // Tx was accepted, but not added\n     if (args.m_test_accept) {\n-        return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+        return MempoolAcceptResult(*ws.m_ptx, std::move(ws.m_replaced_transactions), ws.m_base_fees);\n     }\n \n-    if (!Finalize(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!Finalize(args, ws)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\n \n     GetMainSignals().TransactionAddedToMempool(ptx, m_pool.GetAndIncrementSequence());\n \n-    return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+    return MempoolAcceptResult(*ws.m_ptx, std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+}\n+\n+std::vector<MempoolAcceptResult> MemPoolAccept::AcceptMultipleTransactions(std::vector<CTransactionRef>& txns, ATMPArgs& args)\n+{\n+    AssertLockHeld(cs_main);\n+    std::vector<Workspace> workspaces{};\n+    const int package_size = txns.size();\n+    workspaces.reserve(package_size);\n+    std::transform(txns.begin(), txns.end(), std::back_inserter(workspaces), [](CTransactionRef& tx) {\n+        return Workspace(tx);\n+    });\n+    std::vector<MempoolAcceptResult> results;\n+    results.reserve(package_size);\n+\n+    LOCK(m_pool.cs);\n+    // Do all PreChecks first and fail fast to avoid running expensive script checks when unnecessary.\n+    for (Workspace& ws : workspaces) {\n+        if (!PreChecks(args, ws)) {\n+            // Exit early to avoid doing pointless work. Return results in the same order as input txns.\n+            const auto failed_or_unfinished = [&, failed_ptx = ws.m_ptx](Workspace& ws) {\n+                                              return ws.m_ptx == failed_ptx\n+                                              ? MempoolAcceptResult(*ws.m_ptx, ws.m_state, /* finished */ true)\n+                                              : MempoolAcceptResult(*ws.m_ptx, ws.m_state, /* finished */ false);\n+            };\n+            std::transform(workspaces.begin(), workspaces.end(), std::back_inserter(results), failed_or_unfinished);\n+            return results;\n+        }\n+        m_view.PackageAddTransaction(ws.m_ptx);\n+    }\n+\n+    // Now that we have verified all inputs are available and there are no conflicts in the package,\n+    // clear the temporary coins (m_temp_added and m_temp_spent), otherwise script checks will error\n+    // on coins that are spent within the package.\n+    m_view.ClearTemporaryCoins();\n+\n+    for (Workspace& ws : workspaces) {\n+        PrecomputedTransactionData txdata;\n+        if (!PolicyScriptChecks(args, ws, txdata)) {\n+            // Exit early to avoid doing pointless work. Return results in the same order as input txns.\n+            CTransactionRef failed_ptx = ws.m_ptx;\n+            const auto failed_or_unfinished = [&failed_ptx](Workspace& ws) {\n+                                              return ws.m_ptx == failed_ptx\n+                                              ? MempoolAcceptResult(*ws.m_ptx, ws.m_state, /* finished */ true)\n+                                              : MempoolAcceptResult(*ws.m_ptx, ws.m_state, /* finished */ false);\n+            };\n+            auto it_curr = std::find_if(workspaces.begin(), workspaces.end(),\n+                                        [& failed_ptx](Workspace& ws) { return ws.m_ptx == failed_ptx; });\n+            // When test_accept=true, transactions that pass PolicyScriptChecks are valid because there are\n+            // no further mempool checks (passing PolicyScriptChecks implies passing ConsensusScriptChecks).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r597768912",
      "id" : 597768912,
      "in_reply_to_id" : 594502100,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5Nzc2ODkxMg==",
      "original_commit_id" : "06f8fce092edf62f5bbabc5de41b2b499046b965",
      "original_line" : 1249,
      "original_position" : 266,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 616522486,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597768912",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r597769305"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597769305"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Added a max size and max count in the latest push :)",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-19T15:25:51Z",
      "diff_hunk" : "@@ -1120,6 +1304,30 @@ MempoolAcceptResult AcceptToMemoryPool(CChainState& active_chainstate, CTxMemPoo\n     return AcceptToMemoryPoolWithTime(Params(), pool, active_chainstate, tx, GetTime(), bypass_limits, test_accept);\n }\n \n+std::vector<MempoolAcceptResult> ProcessNewPackage(CChainState& active_chainstate, CTxMemPool& pool,\n+                                                   std::vector<CTransactionRef>& txns, bool test_accept)\n+{\n+    AssertLockHeld(cs_main);\n+    assert(test_accept); // Only allow package accept dry-runs (testmempoolaccept RPC).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r597769305",
      "id" : 597769305,
      "in_reply_to_id" : 594447808,
      "line" : 1349,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5Nzc2OTMwNQ==",
      "original_commit_id" : "06f8fce092edf62f5bbabc5de41b2b499046b965",
      "original_line" : 1349,
      "original_position" : 304,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 363,
      "pull_request_review_id" : 616522992,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597769305",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r597855446"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597855446"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I was wrong. The lifetime of the temporary is extended by binding it to the const lvalue reference: https://en.cppreference.com/w/cpp/language/lifetime#Temporary_object_lifetime.\r\n\r\nStill, I think it'd be better to make `result` a `PackageMempoolAcceptResult`. I think RVO will mean it doesn't result in an extra copy.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-19T17:26:23Z",
      "diff_hunk" : "@@ -1120,6 +1308,32 @@ MempoolAcceptResult AcceptToMemoryPool(CChainState& active_chainstate, CTxMemPoo\n     return AcceptToMemoryPoolWithTime(Params(), pool, active_chainstate, tx, GetTime(), bypass_limits, test_accept);\n }\n \n+PackageMempoolAcceptResult ProcessNewPackage(CChainState& active_chainstate, CTxMemPool& pool,\n+                                                   const Package& package, bool test_accept)\n+{\n+    AssertLockHeld(cs_main);\n+    assert(test_accept); // Only allow package accept dry-runs (testmempoolaccept RPC).\n+\n+    std::vector<COutPoint> coins_to_uncache;\n+    const CChainParams& chainparams = Params();\n+    MemPoolAccept::ATMPArgs args { chainparams, GetTime(), /* bypass_limits */ false, coins_to_uncache, test_accept };\n+    assert(std::addressof(::ChainstateActive()) == std::addressof(active_chainstate));\n+    const PackageMempoolAcceptResult& result = package.size() > 1",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r597855446",
      "id" : 597855446,
      "in_reply_to_id" : 597582750,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5Nzg1NTQ0Ng==",
      "original_commit_id" : "917d4b7cc5347c2bc6f17acd267ea3cccd5f1b75",
      "original_line" : 1321,
      "original_position" : 325,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 616638517,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597855446",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r603685544"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603685544"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "![image](https://user-images.githubusercontent.com/25183001/112912067-8760af80-90ab-11eb-9967-97a6c6b3442d.png)\r\n\r\n(removed for now)",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-29T23:49:19Z",
      "diff_hunk" : "@@ -1060,28 +1184,92 @@ MempoolAcceptResult MemPoolAccept::AcceptSingleTransaction(const CTransactionRef\n \n     Workspace ws(ptx);\n \n-    if (!PreChecks(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!PreChecks(args, ws)) return MempoolAcceptResult::Failure(ws.m_state);\n \n     // Only compute the precomputed transaction data if we need to verify\n     // scripts (ie, other policy checks pass). We perform the inexpensive\n     // checks first and avoid hashing and signature verification unless those\n     // checks pass, to mitigate CPU exhaustion denial-of-service attacks.\n     PrecomputedTransactionData txdata;\n \n-    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult::Failure(ws.m_state);\n \n-    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult::Failure(ws.m_state);\n \n     // Tx was accepted, but not added\n     if (args.m_test_accept) {\n-        return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+        return MempoolAcceptResult::Success(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n     }\n \n-    if (!Finalize(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!Finalize(args, ws)) return MempoolAcceptResult::Failure(ws.m_state);\n \n     GetMainSignals().TransactionAddedToMempool(ptx, m_pool.GetAndIncrementSequence());\n \n-    return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+    return MempoolAcceptResult::Success(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+}\n+\n+PackageMempoolAcceptResult MemPoolAccept::AcceptMultipleTransactions(const std::vector<CTransactionRef>& txns, ATMPArgs& args)\n+{\n+    AssertLockHeld(cs_main);\n+\n+    PackageValidationState package_state;\n+    // Check static package limits before taking the mempool lock.\n+    const unsigned int package_count = txns.size();\n+    if (package_count > MAX_PACKAGE_COUNT) {\n+        package_state.Invalid(PackageValidationResult::PCKG_POLICY, \"too-many-transactions\");\n+        return PackageMempoolAcceptResult(package_state, {});\n+    }\n+\n+    const int64_t total_size = std::accumulate(txns.cbegin(), txns.cend(), 0,\n+        [](int64_t sum, const auto& tx) { return sum + GetVirtualTransactionSize(*tx); });\n+    if (total_size > MAX_PACKAGE_SIZE * 1000) {\n+        package_state.Invalid(PackageValidationResult::PCKG_POLICY, \"too-large\");\n+        return PackageMempoolAcceptResult(package_state, {});\n+    }\n+\n+    std::vector<Workspace> workspaces{};\n+    workspaces.reserve(package_count);\n+    std::transform(txns.cbegin(), txns.cend(), std::back_inserter(workspaces), [](const auto& tx) {\n+        return Workspace(tx);\n+    });\n+\n+    LOCK(m_pool.cs);\n+\n+    std::map<const uint256, const MempoolAcceptResult> results;\n+    // Do all PreChecks first and fail fast to avoid running expensive script checks when unnecessary.\n+    for (Workspace& ws : workspaces) {\n+        if (!PreChecks(args, ws)) {\n+            package_state.Invalid(PackageValidationResult::PCKG_TX, \"transaction failed\");\n+            // Exit early to avoid doing pointless work. Update the failed tx result; the rest are unfinished.\n+            results.emplace(ws.m_ptx->GetHash(), MempoolAcceptResult::Failure(ws.m_state));\n+            return PackageMempoolAcceptResult(package_state, std::move(results));\n+        }\n+        m_view.PackageAddTransaction(ws.m_ptx);\n+    }\n+\n+    // We have now verified all inputs are available and there are no conflicts in the package by\n+    // marking coins (temporarily) spent in m_view. However, since script checks will assert that\n+    // each coin has not been spent as a sanity check, we need to clear m_view.m_temp_spent so that\n+    // script checks don't fail on those asserts.\n+    m_view.ClearTemporarySpends();\n+\n+    for (Workspace& ws : workspaces) {\n+        PrecomputedTransactionData txdata;\n+        if (!PolicyScriptChecks(args, ws, txdata)) {\n+            // Exit early to avoid doing pointless work. Update the failed tx result; the rest are unfinished.\n+            package_state.Invalid(PackageValidationResult::PCKG_TX, \"transaction failed\");\n+            results.emplace(ws.m_ptx->GetHash(), MempoolAcceptResult::Failure(ws.m_state));\n+            return PackageMempoolAcceptResult(package_state, std::move(results));\n+        }\n+        // When test_accept=true, transactions that pass PolicyScriptChecks are valid because there are\n+        // no further mempool checks (passing PolicyScriptChecks implies passing ConsensusScriptChecks).\n+        results.emplace(ws.m_ptx->GetHash(),\n+                        MempoolAcceptResult::Success(std::move(ws.m_replaced_transactions), ws.m_base_fees));\n+    }\n+\n+    m_view.ClearTemporaryCoins();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r603685544",
      "id" : 603685544,
      "in_reply_to_id" : 597590521,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzY4NTU0NA==",
      "original_commit_id" : "917d4b7cc5347c2bc6f17acd267ea3cccd5f1b75",
      "original_line" : 1270,
      "original_position" : 294,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 623736179,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603685544",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r603686184"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603686184"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "chonged to be a `PackageMempoolAcceptResult`",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-29T23:51:11Z",
      "diff_hunk" : "@@ -1120,6 +1308,32 @@ MempoolAcceptResult AcceptToMemoryPool(CChainState& active_chainstate, CTxMemPoo\n     return AcceptToMemoryPoolWithTime(Params(), pool, active_chainstate, tx, GetTime(), bypass_limits, test_accept);\n }\n \n+PackageMempoolAcceptResult ProcessNewPackage(CChainState& active_chainstate, CTxMemPool& pool,\n+                                                   const Package& package, bool test_accept)\n+{\n+    AssertLockHeld(cs_main);\n+    assert(test_accept); // Only allow package accept dry-runs (testmempoolaccept RPC).\n+\n+    std::vector<COutPoint> coins_to_uncache;\n+    const CChainParams& chainparams = Params();\n+    MemPoolAccept::ATMPArgs args { chainparams, GetTime(), /* bypass_limits */ false, coins_to_uncache, test_accept };\n+    assert(std::addressof(::ChainstateActive()) == std::addressof(active_chainstate));\n+    const PackageMempoolAcceptResult& result = package.size() > 1",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r603686184",
      "id" : 603686184,
      "in_reply_to_id" : 597582750,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzY4NjE4NA==",
      "original_commit_id" : "917d4b7cc5347c2bc6f17acd267ea3cccd5f1b75",
      "original_line" : 1321,
      "original_position" : 325,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 623736858,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603686184",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r603688999"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603688999"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for the suggestion! I considered this when I first saw the comment, but since then, I've updated `AcceptMultipleTransactions()` to just remove `m_temp_spent` after all the `PreChecks()` so that the script checks can use coins from `m_temp_added`. That makes this suggestion no longer apply so I'm going to mark it as resolved.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-03-29T23:58:57Z",
      "diff_hunk" : "@@ -465,6 +463,114 @@ static bool CheckInputsFromMempoolAndCache(const CTransaction& tx, TxValidationS\n     return CheckInputScripts(tx, state, view, flags, /* cacheSigStore = */ true, /* cacheFullSciptStore = */ true, txdata);\n }\n \n+/** An empty coin used as a placeholder for a spent coin.*/\n+static const Coin coin_spent;\n+/**\n+ * A CoinsView that adds a memory cache to another CoinsView and serves as temporary scratch space.\n+ * Used by MemPoolAccept class to validate transactions and packages before submitting to mempool.\n+ * A backend can be set to provide read access to chainstate and/or mempool coins, but writing to\n+ * the backend is disabled. Avoid using a CCoinsViewTemporary in consensus-critical paths such\n+ * as writing to the script cache. See CheckInputsFromMempoolAndCache as an example. When not being\n+ * used to validate a package (m_temp_added and m_temp_spent are empty), a CCoinsViewTemporary\n+ * behaves exactly like a CCoinsViewCache.\n+ */\n+class CCoinsViewTemporary : public CCoinsViewCache\n+{\n+protected:\n+    /**\n+    * Coins made available by transactions being validated. Tracking these allows for package\n+    * validation, since we can access transaction outputs without submitting them to mempool.\n+    */\n+    std::map<COutPoint, Coin> m_temp_added;\n+\n+    /**\n+    * Coins spent by transactions being validated. When there are multiple, we need to track these\n+    * in order to distinguish between missing/spent coins and conflicts within a package.\n+    */\n+    std::set<COutPoint> m_temp_spent;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r603688999",
      "id" : 603688999,
      "in_reply_to_id" : 595922179,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzY4ODk5OQ==",
      "original_commit_id" : "06f8fce092edf62f5bbabc5de41b2b499046b965",
      "original_line" : 488,
      "original_position" : 52,
      "original_start_line" : 484,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 623739855,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603688999",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the update, I'll review back soon, especially the well-foundness of new packages limits (`MAX_PACKAGE_COUNT`/`MAX_PACKAGE_SIZE`). \r\n\r\nWhat do you think about disabling RBF logic for package-testmempoolaccept ? I.e returning a package failure if one utxo is already spent, no matter the signaling of the conflicting transaction. It would fix this current [issue](https://github.com/bitcoin/bitcoin/pull/20833/#discussion_r594478671) and I believe we'll need to rethink rbf-handling of package in future works anyway.\r\n\r\nAlso, as L2 protocols are in fine transactions caching layers, if while testing pre-signed transactions testmempool acceptance you already have a conflicting transactions, that's a hint something is wrong. Like either the off-chain contract is already broken or your private keys for the shared-utxo have already leaked.\r\n\r\nBeyond what do you think about auditing how current mempool logic is servicing L2s before to complexify further with this PR ? We might already have issues there.",
      "created_at" : "2021-04-02T03:12:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#issuecomment-812293370",
      "id" : 812293370,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20833",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxMjI5MzM3MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-02T03:14:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/812293370",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r606321612"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/606321612"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 78ab8b1da104e76445e65aa7e2db54d338e0b99a \"[validation] add CoinsViewTemporary for mempool validation\"\r\n\r\n`&& !spend_coin.IsSpent()` seems to be unnecessary as `GetCoin` returns `!coin.IsSpent()`.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-04-02T16:50:48Z",
      "diff_hunk" : "@@ -463,6 +463,111 @@ static bool CheckInputsFromMempoolAndCache(const CTransaction& tx, TxValidationS\n     return CheckInputScripts(tx, state, view, flags, /* cacheSigStore = */ true, /* cacheFullSciptStore = */ true, txdata);\n }\n \n+/**\n+ * A CoinsView that adds a memory cache to another CoinsView and serves as temporary scratch space.\n+ * Used by MemPoolAccept class to validate transactions and packages before submitting to mempool.\n+ * A backend can be set to provide read access to chainstate and/or mempool coins, but writing to\n+ * the backend is disabled. Avoid using a CoinsViewTemporary in consensus-critical paths such\n+ * as writing to the script cache. See CheckInputsFromMempoolAndCache as an example. When not being\n+ * used to validate a package (m_temp_added and m_temp_spent are empty), a CoinsViewTemporary\n+ * behaves exactly like a CCoinsViewCache.\n+ */\n+class CoinsViewTemporary : public CCoinsViewCache\n+{\n+    /**\n+    * Coins made available by transactions being validated. Tracking these allows for package\n+    * validation, since we can access transaction outputs without submitting them to mempool.\n+    */\n+    std::map<COutPoint, Coin> m_temp_added;\n+\n+    /**\n+    * Coins spent by transactions being validated. When validating a package, we need to track\n+    * these in order to distinguish between missing/spent coins and conflicts within a package.\n+    */\n+    std::set<COutPoint> m_temp_spent;\n+\n+    /** An empty coin used as a placeholder for a spent coin.*/\n+    inline static const Coin s_coin_spent;\n+\n+public:\n+\n+    CoinsViewTemporary(CCoinsView* baseIn) : CCoinsViewCache(baseIn) {}\n+\n+    // Delete the copy constructor to prevent accidentally using it when one intends to create a\n+    // CoinsViewTemporary on top of a base cache.\n+    CoinsViewTemporary(const CoinsViewTemporary &) = delete;\n+\n+    bool GetCoin(const COutPoint& outpoint, Coin& coin) const override {\n+        coin = AccessCoin(outpoint);\n+        return !coin.IsSpent();\n+    }\n+\n+    const Coin& AccessCoin(const COutPoint& outpoint) const override {\n+        // Check to see if another tx in the package has already spent this coin (conflict-in-package).\n+        // Coins spent by others in the package are only tracked in m_temp_spent.\n+        if (m_temp_spent.count(outpoint)) {\n+            return s_coin_spent;\n+        }\n+\n+        // Check to see if the inputs are made available by another tx in the package.\n+        // These Coins would not be available in the underlying CoinsView.\n+        if (auto it = m_temp_added.find(outpoint); it != m_temp_added.end()) {\n+            assert(!it->second.IsSpent());\n+            return it->second;\n+        }\n+        return CCoinsViewCache::AccessCoin(outpoint);\n+    }\n+\n+    bool HaveCoin(const COutPoint& outpoint) const override {\n+        Coin coin;\n+        return GetCoin(outpoint, coin);\n+    }\n+\n+    /**\n+    * Update with coins spent and created by a transaction.\n+    * Only used for package validation.\n+    */\n+    void PackageAddTransaction(const CTransactionRef& tx)\n+    {\n+        // Track Coins spent by this transaction. They must exist and not already be spent.\n+        for (auto input : tx->vin) {\n+            Coin spent_coin;\n+            Assume(GetCoin(input.prevout, spent_coin) && !spent_coin.IsSpent());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r606321612",
      "id" : 606321612,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNjMyMTYxMg==",
      "original_commit_id" : "78ab8b1da104e76445e65aa7e2db54d338e0b99a",
      "original_line" : 535,
      "original_position" : 73,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 627115608,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/606321612",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r606345705"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/606345705"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In f7880be \"[validation] package validation test_accept=true\"\r\n\r\nTo more accurately reflect mempool acceptance behavior, I think it would be better to be using the values for `-limitancestorcount`, `-limitdescendantcount`, `-limitancestorsize`, and `-limitdescendantsize` for these checks.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-04-02T17:46:45Z",
      "diff_hunk" : "@@ -1163,28 +1175,90 @@ MempoolAcceptResult MemPoolAccept::AcceptSingleTransaction(const CTransactionRef\n \n     Workspace ws(ptx);\n \n-    if (!PreChecks(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!PreChecks(args, ws)) return MempoolAcceptResult::Failure(ws.m_state);\n \n     // Only compute the precomputed transaction data if we need to verify\n     // scripts (ie, other policy checks pass). We perform the inexpensive\n     // checks first and avoid hashing and signature verification unless those\n     // checks pass, to mitigate CPU exhaustion denial-of-service attacks.\n     PrecomputedTransactionData txdata;\n \n-    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult::Failure(ws.m_state);\n \n-    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult::Failure(ws.m_state);\n \n     // Tx was accepted, but not added\n     if (args.m_test_accept) {\n-        return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+        return MempoolAcceptResult::Success(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n     }\n \n-    if (!Finalize(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!Finalize(args, ws)) return MempoolAcceptResult::Failure(ws.m_state);\n \n     GetMainSignals().TransactionAddedToMempool(ptx, m_pool.GetAndIncrementSequence());\n \n-    return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+    return MempoolAcceptResult::Success(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+}\n+\n+PackageMempoolAcceptResult MemPoolAccept::AcceptMultipleTransactions(const std::vector<CTransactionRef>& txns, ATMPArgs& args)\n+{\n+    AssertLockHeld(cs_main);\n+\n+    PackageValidationState package_state;\n+    // Check static package limits before taking the mempool lock.\n+    const unsigned int package_count = txns.size();\n+    if (package_count > MAX_PACKAGE_COUNT) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r606345705",
      "id" : 606345705,
      "line" : 1213,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNjM0NTcwNQ==",
      "original_commit_id" : "f7880be3cbe9d0937ee4df6d55eb93876bc5dd1a",
      "original_line" : 1213,
      "original_position" : 74,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 249,
      "pull_request_review_id" : 627115608,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/606345705",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r606347122"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/606347122"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 1bec7b18ab8a6e8993fcb6c19a0b13fb4df0eeeb \"[rpc] allow multiple txns in testmempoolaccept\"\r\n\r\nGenerally we want to do all of the transaction decoding before getting all of these mempool and chainstate things.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-04-02T17:50:01Z",
      "diff_hunk" : "@@ -923,59 +928,72 @@ static RPCHelpMan testmempoolaccept()\n         UniValueType(), // VNUM or VSTR, checked inside AmountFromValue()\n     });\n \n-    if (request.params[0].get_array().size() != 1) {\n-        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Array must contain exactly one raw transaction for now\");\n+    if (request.params[0].get_array().size() > MAX_PACKAGE_COUNT) {\n+        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Array cannot contain more than \" + ToString(MAX_PACKAGE_COUNT) + \" transactions.\");\n     }\n \n-    CMutableTransaction mtx;\n-    if (!DecodeHexTx(mtx, request.params[0].get_array()[0].get_str())) {\n-        throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed. Make sure the tx has at least one input.\");\n-    }\n-    CTransactionRef tx(MakeTransactionRef(std::move(mtx)));\n-\n+    const UniValue raw_transactions = request.params[0].get_array();\n     const CFeeRate max_raw_tx_fee_rate = request.params[1].isNull() ?\n                                              DEFAULT_MAX_RAW_TX_FEE_RATE :\n                                              CFeeRate(AmountFromValue(request.params[1]));\n \n     CTxMemPool& mempool = EnsureMemPool(request.context);\n-    int64_t virtual_size = GetVirtualTransactionSize(*tx);\n-    CAmount max_raw_tx_fee = max_raw_tx_fee_rate.GetFee(virtual_size);\n+    CChainState& chainstate = EnsureChainman(request.context).ActiveChainstate();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r606347122",
      "id" : 606347122,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNjM0NzEyMg==",
      "original_commit_id" : "1bec7b18ab8a6e8993fcb6c19a0b13fb4df0eeeb",
      "original_line" : 941,
      "original_position" : 61,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : null,
      "pull_request_review_id" : 627115608,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/606347122",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r606447491"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/606447491"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Descendant/ancestor limits will still be checked within validation (and are stricter than this check since this doesn't include in-mempool transactions). This is just preventing us from working on a really big package. And if/when we have p2p packages, we'd enforce `MAX_PACKAGE_COUNT` as a limit.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-04-02T22:07:04Z",
      "diff_hunk" : "@@ -1163,28 +1175,90 @@ MempoolAcceptResult MemPoolAccept::AcceptSingleTransaction(const CTransactionRef\n \n     Workspace ws(ptx);\n \n-    if (!PreChecks(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!PreChecks(args, ws)) return MempoolAcceptResult::Failure(ws.m_state);\n \n     // Only compute the precomputed transaction data if we need to verify\n     // scripts (ie, other policy checks pass). We perform the inexpensive\n     // checks first and avoid hashing and signature verification unless those\n     // checks pass, to mitigate CPU exhaustion denial-of-service attacks.\n     PrecomputedTransactionData txdata;\n \n-    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult::Failure(ws.m_state);\n \n-    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult::Failure(ws.m_state);\n \n     // Tx was accepted, but not added\n     if (args.m_test_accept) {\n-        return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+        return MempoolAcceptResult::Success(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n     }\n \n-    if (!Finalize(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!Finalize(args, ws)) return MempoolAcceptResult::Failure(ws.m_state);\n \n     GetMainSignals().TransactionAddedToMempool(ptx, m_pool.GetAndIncrementSequence());\n \n-    return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+    return MempoolAcceptResult::Success(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+}\n+\n+PackageMempoolAcceptResult MemPoolAccept::AcceptMultipleTransactions(const std::vector<CTransactionRef>& txns, ATMPArgs& args)\n+{\n+    AssertLockHeld(cs_main);\n+\n+    PackageValidationState package_state;\n+    // Check static package limits before taking the mempool lock.\n+    const unsigned int package_count = txns.size();\n+    if (package_count > MAX_PACKAGE_COUNT) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r606447491",
      "id" : 606447491,
      "in_reply_to_id" : 606345705,
      "line" : 1213,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNjQ0NzQ5MQ==",
      "original_commit_id" : "f7880be3cbe9d0937ee4df6d55eb93876bc5dd1a",
      "original_line" : 1213,
      "original_position" : 74,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 249,
      "pull_request_review_id" : 627387724,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/606447491",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> What do you think about disabling RBF logic for package-testmempoolaccept ? I.e returning a package failure if one utxo is already spent, no matter the signaling of the conflicting transaction. It would fix this current issue and I believe we'll need to rethink rbf-handling of package in future works anyway.\r\n\r\nYes, I'd prefer this. I don't think there's a use case for having RBFing in packages - if there is, we can add it later after thinking through the edge cases. Will update this to disable RBF.",
      "created_at" : "2021-04-02T22:47:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#issuecomment-812744661",
      "id" : 812744661,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20833",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxMjc0NDY2MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-02T22:48:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/812744661",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r606633360"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/606633360"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why? We can't do anything in this function if there isn't a mempool, so why not exit early if it doesn't exist?",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-04-03T07:45:42Z",
      "diff_hunk" : "@@ -923,59 +928,72 @@ static RPCHelpMan testmempoolaccept()\n         UniValueType(), // VNUM or VSTR, checked inside AmountFromValue()\n     });\n \n-    if (request.params[0].get_array().size() != 1) {\n-        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Array must contain exactly one raw transaction for now\");\n+    if (request.params[0].get_array().size() > MAX_PACKAGE_COUNT) {\n+        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Array cannot contain more than \" + ToString(MAX_PACKAGE_COUNT) + \" transactions.\");\n     }\n \n-    CMutableTransaction mtx;\n-    if (!DecodeHexTx(mtx, request.params[0].get_array()[0].get_str())) {\n-        throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed. Make sure the tx has at least one input.\");\n-    }\n-    CTransactionRef tx(MakeTransactionRef(std::move(mtx)));\n-\n+    const UniValue raw_transactions = request.params[0].get_array();\n     const CFeeRate max_raw_tx_fee_rate = request.params[1].isNull() ?\n                                              DEFAULT_MAX_RAW_TX_FEE_RATE :\n                                              CFeeRate(AmountFromValue(request.params[1]));\n \n     CTxMemPool& mempool = EnsureMemPool(request.context);\n-    int64_t virtual_size = GetVirtualTransactionSize(*tx);\n-    CAmount max_raw_tx_fee = max_raw_tx_fee_rate.GetFee(virtual_size);\n+    CChainState& chainstate = EnsureChainman(request.context).ActiveChainstate();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r606633360",
      "id" : 606633360,
      "in_reply_to_id" : 606347122,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNjYzMzM2MA==",
      "original_commit_id" : "1bec7b18ab8a6e8993fcb6c19a0b13fb4df0eeeb",
      "original_line" : 941,
      "original_position" : 61,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : null,
      "pull_request_review_id" : 627440396,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/606633360",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r606689520"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/606689520"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The pattern that we do in every other RPC that handles raw transactions (and most of the ones that take user input that needs to be parsed) is that the parsing/decoding is done first before acquiring anything internal needed for processing. After all, we can't do anything in this function if the transaction is malformed, so why not exit early if it can't be decoded?\r\n\r\nI also think that it would make the diff slightly easier to read since that is what the function did originally.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-04-03T17:31:13Z",
      "diff_hunk" : "@@ -923,59 +928,72 @@ static RPCHelpMan testmempoolaccept()\n         UniValueType(), // VNUM or VSTR, checked inside AmountFromValue()\n     });\n \n-    if (request.params[0].get_array().size() != 1) {\n-        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Array must contain exactly one raw transaction for now\");\n+    if (request.params[0].get_array().size() > MAX_PACKAGE_COUNT) {\n+        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Array cannot contain more than \" + ToString(MAX_PACKAGE_COUNT) + \" transactions.\");\n     }\n \n-    CMutableTransaction mtx;\n-    if (!DecodeHexTx(mtx, request.params[0].get_array()[0].get_str())) {\n-        throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed. Make sure the tx has at least one input.\");\n-    }\n-    CTransactionRef tx(MakeTransactionRef(std::move(mtx)));\n-\n+    const UniValue raw_transactions = request.params[0].get_array();\n     const CFeeRate max_raw_tx_fee_rate = request.params[1].isNull() ?\n                                              DEFAULT_MAX_RAW_TX_FEE_RATE :\n                                              CFeeRate(AmountFromValue(request.params[1]));\n \n     CTxMemPool& mempool = EnsureMemPool(request.context);\n-    int64_t virtual_size = GetVirtualTransactionSize(*tx);\n-    CAmount max_raw_tx_fee = max_raw_tx_fee_rate.GetFee(virtual_size);\n+    CChainState& chainstate = EnsureChainman(request.context).ActiveChainstate();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r606689520",
      "id" : 606689520,
      "in_reply_to_id" : 606347122,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNjY4OTUyMA==",
      "original_commit_id" : "1bec7b18ab8a6e8993fcb6c19a0b13fb4df0eeeb",
      "original_line" : 941,
      "original_position" : 61,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : null,
      "pull_request_review_id" : 627473692,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/606689520",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r610455249"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/610455249"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I see these `Assume` functions as essentially asserting entry conditions for the function. For rpc methods that require a component to exist in order to function at all (such as `testmempoolaccept`), then I think assume/exit at the top of the function makes most sense. Doing that has benefits:\r\n\r\n- avoids unexpected side-effects\r\n- avoid unnecessary lock-taking or resource usage\r\n- explicitly states assumptions up front\r\n\r\nThere are some rpc methods where components are optional or only required based on particular inputs (eg ` getrawtransaction` might not require a mempool if a blockhash is passed). For those, the `Assume()` function can be further down in the function, but again should be prominently displayed at the top of a code block to document assumptions.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-04-09T08:43:56Z",
      "diff_hunk" : "@@ -923,59 +928,72 @@ static RPCHelpMan testmempoolaccept()\n         UniValueType(), // VNUM or VSTR, checked inside AmountFromValue()\n     });\n \n-    if (request.params[0].get_array().size() != 1) {\n-        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Array must contain exactly one raw transaction for now\");\n+    if (request.params[0].get_array().size() > MAX_PACKAGE_COUNT) {\n+        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Array cannot contain more than \" + ToString(MAX_PACKAGE_COUNT) + \" transactions.\");\n     }\n \n-    CMutableTransaction mtx;\n-    if (!DecodeHexTx(mtx, request.params[0].get_array()[0].get_str())) {\n-        throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed. Make sure the tx has at least one input.\");\n-    }\n-    CTransactionRef tx(MakeTransactionRef(std::move(mtx)));\n-\n+    const UniValue raw_transactions = request.params[0].get_array();\n     const CFeeRate max_raw_tx_fee_rate = request.params[1].isNull() ?\n                                              DEFAULT_MAX_RAW_TX_FEE_RATE :\n                                              CFeeRate(AmountFromValue(request.params[1]));\n \n     CTxMemPool& mempool = EnsureMemPool(request.context);\n-    int64_t virtual_size = GetVirtualTransactionSize(*tx);\n-    CAmount max_raw_tx_fee = max_raw_tx_fee_rate.GetFee(virtual_size);\n+    CChainState& chainstate = EnsureChainman(request.context).ActiveChainstate();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r610455249",
      "id" : 610455249,
      "in_reply_to_id" : 606347122,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMDQ1NTI0OQ==",
      "original_commit_id" : "1bec7b18ab8a6e8993fcb6c19a0b13fb4df0eeeb",
      "original_line" : 941,
      "original_position" : 61,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : null,
      "pull_request_review_id" : 632182754,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/610455249",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r612411317"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612411317"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-04-13T12:44:49Z",
      "diff_hunk" : "@@ -463,6 +463,111 @@ static bool CheckInputsFromMempoolAndCache(const CTransaction& tx, TxValidationS\n     return CheckInputScripts(tx, state, view, flags, /* cacheSigStore = */ true, /* cacheFullSciptStore = */ true, txdata);\n }\n \n+/**\n+ * A CoinsView that adds a memory cache to another CoinsView and serves as temporary scratch space.\n+ * Used by MemPoolAccept class to validate transactions and packages before submitting to mempool.\n+ * A backend can be set to provide read access to chainstate and/or mempool coins, but writing to\n+ * the backend is disabled. Avoid using a CoinsViewTemporary in consensus-critical paths such\n+ * as writing to the script cache. See CheckInputsFromMempoolAndCache as an example. When not being\n+ * used to validate a package (m_temp_added and m_temp_spent are empty), a CoinsViewTemporary\n+ * behaves exactly like a CCoinsViewCache.\n+ */\n+class CoinsViewTemporary : public CCoinsViewCache\n+{\n+    /**\n+    * Coins made available by transactions being validated. Tracking these allows for package\n+    * validation, since we can access transaction outputs without submitting them to mempool.\n+    */\n+    std::map<COutPoint, Coin> m_temp_added;\n+\n+    /**\n+    * Coins spent by transactions being validated. When validating a package, we need to track\n+    * these in order to distinguish between missing/spent coins and conflicts within a package.\n+    */\n+    std::set<COutPoint> m_temp_spent;\n+\n+    /** An empty coin used as a placeholder for a spent coin.*/\n+    inline static const Coin s_coin_spent;\n+\n+public:\n+\n+    CoinsViewTemporary(CCoinsView* baseIn) : CCoinsViewCache(baseIn) {}\n+\n+    // Delete the copy constructor to prevent accidentally using it when one intends to create a\n+    // CoinsViewTemporary on top of a base cache.\n+    CoinsViewTemporary(const CoinsViewTemporary &) = delete;\n+\n+    bool GetCoin(const COutPoint& outpoint, Coin& coin) const override {\n+        coin = AccessCoin(outpoint);\n+        return !coin.IsSpent();\n+    }\n+\n+    const Coin& AccessCoin(const COutPoint& outpoint) const override {\n+        // Check to see if another tx in the package has already spent this coin (conflict-in-package).\n+        // Coins spent by others in the package are only tracked in m_temp_spent.\n+        if (m_temp_spent.count(outpoint)) {\n+            return s_coin_spent;\n+        }\n+\n+        // Check to see if the inputs are made available by another tx in the package.\n+        // These Coins would not be available in the underlying CoinsView.\n+        if (auto it = m_temp_added.find(outpoint); it != m_temp_added.end()) {\n+            assert(!it->second.IsSpent());\n+            return it->second;\n+        }\n+        return CCoinsViewCache::AccessCoin(outpoint);\n+    }\n+\n+    bool HaveCoin(const COutPoint& outpoint) const override {\n+        Coin coin;\n+        return GetCoin(outpoint, coin);\n+    }\n+\n+    /**\n+    * Update with coins spent and created by a transaction.\n+    * Only used for package validation.\n+    */\n+    void PackageAddTransaction(const CTransactionRef& tx)\n+    {\n+        // Track Coins spent by this transaction. They must exist and not already be spent.\n+        for (auto input : tx->vin) {\n+            Coin spent_coin;\n+            Assume(GetCoin(input.prevout, spent_coin) && !spent_coin.IsSpent());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r612411317",
      "id" : 612411317,
      "in_reply_to_id" : 606321612,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjQxMTMxNw==",
      "original_commit_id" : "78ab8b1da104e76445e65aa7e2db54d338e0b99a",
      "original_line" : 535,
      "original_position" : 73,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 634541687,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T12:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612411317",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for the reviews so far! Pushed a bunch of stuff (mostly tests):\r\n- Distinguishing package limits, sorting, and RBF stuff for packages as [policy] since they are opinionated.\r\n- Disallow any conflicts with mempool transactions (thereby disabling RBF) in packages.\r\n- Extended the mempool fuzzer to check that test accepting using ATMP and ProcessNewPackage (always just 1 transaction) should be identical. Will be sure to update with package submission when I add that (in a future PR).\r\n- Added some logic + tests for detecting mempool and package ancestor/descendant limits. I'm using a heuristic where I count every transaction in the package as each other's ancestor and descendant. The idea is that their total ancestor and descendant chains should never exceed what we'd allow for a single transaction without exhaustively checking every ancestor/descendant count. The heuristic can overestimate the \"family\" sizes for packages of size > 2 where not every transaction is interdependent, but I don't think it's significant for the use cases we care about (usually a package of parent + child).",
      "created_at" : "2021-04-13T12:57:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#issuecomment-818714189",
      "id" : 818714189,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20833",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxODcxNDE4OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-13T12:57:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/818714189",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r612426153"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612426153"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Current policy is they can be independent or dependent (although I don't think the user would get much use out of independent ones). Given that RBF is now disabled, hopefully this concern is resolved?",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-04-13T13:03:30Z",
      "diff_hunk" : "@@ -226,6 +230,18 @@ struct MempoolAcceptResult {\n MempoolAcceptResult AcceptToMemoryPool(CChainState& active_chainstate, CTxMemPool& pool, const CTransactionRef& tx,\n                                        bool bypass_limits, bool test_accept=false) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+/**\n+* Atomically test acceptance of multiple transactions.\n+* @param[in]    txns                Group of transactions which may be independent or contain",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r612426153",
      "id" : 612426153,
      "in_reply_to_id" : 594527279,
      "line" : 260,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjQyNjE1Mw==",
      "original_commit_id" : "06f8fce092edf62f5bbabc5de41b2b499046b965",
      "original_line" : 260,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 92,
      "pull_request_review_id" : 634560905,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-13T13:03:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612426153",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613594392"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613594392"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "suggestion: make Package a struct wrapper with private fields so that you have to go through a smart constructor?\r\n\r\nprevents API misuse",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-04-14T21:19:31Z",
      "diff_hunk" : "@@ -0,0 +1,33 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_PACKAGES_H\n+#define BITCOIN_PACKAGES_H\n+\n+#include <vector>\n+\n+#include <consensus/validation.h>\n+#include <primitives/transaction.h>\n+\n+/** Default maximum number of transactions in a package. */\n+static constexpr uint32_t MAX_PACKAGE_COUNT{25};\n+/** Default maximum total virtual size of transactions in a package in KvB. */\n+static constexpr uint32_t MAX_PACKAGE_SIZE{101};\n+\n+/** A \"reason\" why a package was invalid. It may be that one or more of the included\n+ * transactions is invalid or the package itself violates our rules.\n+ * We don't distinguish between consensus and policy validity right now.\n+ */\n+enum class PackageValidationResult {\n+    PCKG_RESULT_UNSET = 0,        //!< Initial value. The package has not yet been rejected.\n+    PCKG_POLICY,                  //!< The package itself is invalid (e.g. too many transactions).\n+    PCKG_TX,                      //!< At least one tx is invalid.\n+};\n+\n+/** A package is an ordered list of transactions. */\n+using Package = std::vector<CTransactionRef>;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613594392",
      "id" : 613594392,
      "line" : 29,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMzU5NDM5Mg==",
      "original_commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "original_line" : 29,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/packages.h",
      "position" : 29,
      "pull_request_review_id" : 636089652,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-14T21:19:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613594392",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613595514"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613595514"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: clarify which order that is (e.g., `if tx B and C are a child of A the order may be [A, B, C] or [A, C, B]`) ",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-04-14T21:21:25Z",
      "diff_hunk" : "@@ -879,7 +880,9 @@ static RPCHelpMan sendrawtransaction()\n static RPCHelpMan testmempoolaccept()\n {\n     return RPCHelpMan{\"testmempoolaccept\",\n-                \"\\nReturns result of mempool acceptance tests indicating if raw transaction (serialized, hex-encoded) would be accepted by mempool.\\n\"\n+                \"\\nReturns result of mempool acceptance tests indicating if raw transaction(s) (serialized, hex-encoded) would be accepted by mempool.\\n\"\n+                \"\\nIf multiple transactions are passed in, they must be sorted in order of dependency and not conflict with each other.\\n\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613595514",
      "id" : 613595514,
      "line" : 884,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMzU5NTUxNA==",
      "original_commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "original_line" : 884,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : 14,
      "pull_request_review_id" : 636091017,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-14T21:21:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613595514",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613595886"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613595886"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: clarify is duplicate transactions [A, A] are allowed",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-04-14T21:22:10Z",
      "diff_hunk" : "@@ -879,7 +880,9 @@ static RPCHelpMan sendrawtransaction()\n static RPCHelpMan testmempoolaccept()\n {\n     return RPCHelpMan{\"testmempoolaccept\",\n-                \"\\nReturns result of mempool acceptance tests indicating if raw transaction (serialized, hex-encoded) would be accepted by mempool.\\n\"\n+                \"\\nReturns result of mempool acceptance tests indicating if raw transaction(s) (serialized, hex-encoded) would be accepted by mempool.\\n\"\n+                \"\\nIf multiple transactions are passed in, they must be sorted in order of dependency and not conflict with each other.\\n\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613595886",
      "id" : 613595886,
      "in_reply_to_id" : 613595514,
      "line" : 884,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMzU5NTg4Ng==",
      "original_commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "original_line" : 884,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : 14,
      "pull_request_review_id" : 636091510,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-14T21:22:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613595886",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613602225"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613602225"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Not sure if we do this elsewhere, but would be nice to not take locks inside a ternary with returns in it.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-04-14T21:34:45Z",
      "diff_hunk" : "@@ -926,59 +931,73 @@ static RPCHelpMan testmempoolaccept()\n         UniValueType(), // VNUM or VSTR, checked inside AmountFromValue()\n     });\n \n-    if (request.params[0].get_array().size() != 1) {\n-        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Array must contain exactly one raw transaction for now\");\n+    if (request.params[0].get_array().size() > MAX_PACKAGE_COUNT) {\n+        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Array cannot contain more than \" + ToString(MAX_PACKAGE_COUNT) + \" transactions.\");\n     }\n \n-    CMutableTransaction mtx;\n-    if (!DecodeHexTx(mtx, request.params[0].get_array()[0].get_str())) {\n-        throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed. Make sure the tx has at least one input.\");\n-    }\n-    CTransactionRef tx(MakeTransactionRef(std::move(mtx)));\n-\n+    const UniValue raw_transactions = request.params[0].get_array();\n     const CFeeRate max_raw_tx_fee_rate = request.params[1].isNull() ?\n                                              DEFAULT_MAX_RAW_TX_FEE_RATE :\n                                              CFeeRate(AmountFromValue(request.params[1]));\n \n-    CTxMemPool& mempool = EnsureMemPool(request.context);\n-    int64_t virtual_size = GetVirtualTransactionSize(*tx);\n-    CAmount max_raw_tx_fee = max_raw_tx_fee_rate.GetFee(virtual_size);\n+    std::vector<CTransactionRef> txns;\n+    for (const auto& rawtx : raw_transactions.getValues()) {\n+        CMutableTransaction mtx;\n+        if (!DecodeHexTx(mtx, rawtx.get_str())) {\n+            throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed. Make sure the tx has at least one input.\");\n+        }\n+        txns.emplace_back(MakeTransactionRef(std::move(mtx)));\n+    }\n \n-    UniValue result(UniValue::VARR);\n-    UniValue result_0(UniValue::VOBJ);\n-    result_0.pushKV(\"txid\", tx->GetHash().GetHex());\n-    result_0.pushKV(\"wtxid\", tx->GetWitnessHash().GetHex());\n-\n-    const MempoolAcceptResult accept_result = WITH_LOCK(cs_main, return AcceptToMemoryPool(::ChainstateActive(), mempool, std::move(tx),\n-                                                  false /* bypass_limits */, /* test_accept */ true));\n-\n-    // Only return the fee and vsize if the transaction would pass ATMP.\n-    // These can be used to calculate the feerate.\n-    if (accept_result.m_result_type == MempoolAcceptResult::ResultType::VALID) {\n-        const CAmount fee = accept_result.m_base_fees.value();\n-        // Check that fee does not exceed maximum fee\n-        if (max_raw_tx_fee && fee > max_raw_tx_fee) {\n-            result_0.pushKV(\"allowed\", false);\n-            result_0.pushKV(\"reject-reason\", \"max-fee-exceeded\");\n-        } else {\n-            result_0.pushKV(\"allowed\", true);\n-            result_0.pushKV(\"vsize\", virtual_size);\n-            UniValue fees(UniValue::VOBJ);\n-            fees.pushKV(\"base\", ValueFromAmount(fee));\n-            result_0.pushKV(\"fees\", fees);\n+    CTxMemPool& mempool = EnsureMemPool(request.context);\n+    CChainState& chainstate = EnsureChainman(request.context).ActiveChainstate();\n+    const PackageMempoolAcceptResult validation_result = txns.size() > 1\n+        ? WITH_LOCK(cs_main, return ProcessNewPackage(chainstate, mempool, txns, /* test_accept */ true))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613602225",
      "id" : 613602225,
      "line" : 955,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMzYwMjIyNQ==",
      "original_commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "original_line" : 955,
      "original_position" : 95,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : 95,
      "pull_request_review_id" : 636099760,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-14T21:34:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613602225",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613603255"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613603255"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think we should use ProcessNewPackage here -- if this is done to avoid breaking RPC change, then I'd rather a new RPC call that consistently uses one call or the other.\r\n\r\nOtherwise how to test if a single tx as a package is accepted?",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-04-14T21:36:46Z",
      "diff_hunk" : "@@ -926,59 +931,73 @@ static RPCHelpMan testmempoolaccept()\n         UniValueType(), // VNUM or VSTR, checked inside AmountFromValue()\n     });\n \n-    if (request.params[0].get_array().size() != 1) {\n-        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Array must contain exactly one raw transaction for now\");\n+    if (request.params[0].get_array().size() > MAX_PACKAGE_COUNT) {\n+        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Array cannot contain more than \" + ToString(MAX_PACKAGE_COUNT) + \" transactions.\");\n     }\n \n-    CMutableTransaction mtx;\n-    if (!DecodeHexTx(mtx, request.params[0].get_array()[0].get_str())) {\n-        throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed. Make sure the tx has at least one input.\");\n-    }\n-    CTransactionRef tx(MakeTransactionRef(std::move(mtx)));\n-\n+    const UniValue raw_transactions = request.params[0].get_array();\n     const CFeeRate max_raw_tx_fee_rate = request.params[1].isNull() ?\n                                              DEFAULT_MAX_RAW_TX_FEE_RATE :\n                                              CFeeRate(AmountFromValue(request.params[1]));\n \n-    CTxMemPool& mempool = EnsureMemPool(request.context);\n-    int64_t virtual_size = GetVirtualTransactionSize(*tx);\n-    CAmount max_raw_tx_fee = max_raw_tx_fee_rate.GetFee(virtual_size);\n+    std::vector<CTransactionRef> txns;\n+    for (const auto& rawtx : raw_transactions.getValues()) {\n+        CMutableTransaction mtx;\n+        if (!DecodeHexTx(mtx, rawtx.get_str())) {\n+            throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed. Make sure the tx has at least one input.\");\n+        }\n+        txns.emplace_back(MakeTransactionRef(std::move(mtx)));\n+    }\n \n-    UniValue result(UniValue::VARR);\n-    UniValue result_0(UniValue::VOBJ);\n-    result_0.pushKV(\"txid\", tx->GetHash().GetHex());\n-    result_0.pushKV(\"wtxid\", tx->GetWitnessHash().GetHex());\n-\n-    const MempoolAcceptResult accept_result = WITH_LOCK(cs_main, return AcceptToMemoryPool(::ChainstateActive(), mempool, std::move(tx),\n-                                                  false /* bypass_limits */, /* test_accept */ true));\n-\n-    // Only return the fee and vsize if the transaction would pass ATMP.\n-    // These can be used to calculate the feerate.\n-    if (accept_result.m_result_type == MempoolAcceptResult::ResultType::VALID) {\n-        const CAmount fee = accept_result.m_base_fees.value();\n-        // Check that fee does not exceed maximum fee\n-        if (max_raw_tx_fee && fee > max_raw_tx_fee) {\n-            result_0.pushKV(\"allowed\", false);\n-            result_0.pushKV(\"reject-reason\", \"max-fee-exceeded\");\n-        } else {\n-            result_0.pushKV(\"allowed\", true);\n-            result_0.pushKV(\"vsize\", virtual_size);\n-            UniValue fees(UniValue::VOBJ);\n-            fees.pushKV(\"base\", ValueFromAmount(fee));\n-            result_0.pushKV(\"fees\", fees);\n+    CTxMemPool& mempool = EnsureMemPool(request.context);\n+    CChainState& chainstate = EnsureChainman(request.context).ActiveChainstate();\n+    const PackageMempoolAcceptResult validation_result = txns.size() > 1\n+        ? WITH_LOCK(cs_main, return ProcessNewPackage(chainstate, mempool, txns, /* test_accept */ true))\n+        : WITH_LOCK(cs_main, return PackageMempoolAcceptResult(txns[0]->GetHash(),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613603255",
      "id" : 613603255,
      "line" : 956,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMzYwMzI1NQ==",
      "original_commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "original_line" : 956,
      "original_position" : 96,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : 96,
      "pull_request_review_id" : 636101131,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-14T21:36:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613603255",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613604854"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613604854"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: can inherit from u8 to make smaller",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-04-14T21:39:59Z",
      "diff_hunk" : "@@ -187,34 +188,65 @@ void PruneBlockFilesManual(CChainState& active_chainstate, int nManualPruneHeigh\n * Validation result for a single transaction mempool acceptance.\n */\n struct MempoolAcceptResult {\n-    /** Used to indicate the results of mempool validation,\n-    * including the possibility of unfinished validation.\n-    */\n+    /** Used to indicate the results of mempool validation. */\n     enum class ResultType {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613604854",
      "id" : 613604854,
      "line" : 192,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMzYwNDg1NA==",
      "original_commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "original_line" : 192,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 16,
      "pull_request_review_id" : 636103144,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-14T21:39:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613604854",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613605097"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613605097"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "make sure to sort the m_result_type after m_state for packing rules.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-04-14T21:40:30Z",
      "diff_hunk" : "@@ -187,34 +188,65 @@ void PruneBlockFilesManual(CChainState& active_chainstate, int nManualPruneHeigh\n * Validation result for a single transaction mempool acceptance.\n */\n struct MempoolAcceptResult {\n-    /** Used to indicate the results of mempool validation,\n-    * including the possibility of unfinished validation.\n-    */\n+    /** Used to indicate the results of mempool validation. */\n     enum class ResultType {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613605097",
      "id" : 613605097,
      "in_reply_to_id" : 613604854,
      "line" : 192,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMzYwNTA5Nw==",
      "original_commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "original_line" : 192,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 16,
      "pull_request_review_id" : 636103471,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-14T21:40:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613605097",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613615583"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613615583"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah, there's a breaking RPC change if they try to testmempoolaccept on a tx that does an RBF (since we don't allow that in packages). I'm not really sure why a user would want to test a single tx as a package?",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-04-14T22:02:55Z",
      "diff_hunk" : "@@ -926,59 +931,73 @@ static RPCHelpMan testmempoolaccept()\n         UniValueType(), // VNUM or VSTR, checked inside AmountFromValue()\n     });\n \n-    if (request.params[0].get_array().size() != 1) {\n-        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Array must contain exactly one raw transaction for now\");\n+    if (request.params[0].get_array().size() > MAX_PACKAGE_COUNT) {\n+        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Array cannot contain more than \" + ToString(MAX_PACKAGE_COUNT) + \" transactions.\");\n     }\n \n-    CMutableTransaction mtx;\n-    if (!DecodeHexTx(mtx, request.params[0].get_array()[0].get_str())) {\n-        throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed. Make sure the tx has at least one input.\");\n-    }\n-    CTransactionRef tx(MakeTransactionRef(std::move(mtx)));\n-\n+    const UniValue raw_transactions = request.params[0].get_array();\n     const CFeeRate max_raw_tx_fee_rate = request.params[1].isNull() ?\n                                              DEFAULT_MAX_RAW_TX_FEE_RATE :\n                                              CFeeRate(AmountFromValue(request.params[1]));\n \n-    CTxMemPool& mempool = EnsureMemPool(request.context);\n-    int64_t virtual_size = GetVirtualTransactionSize(*tx);\n-    CAmount max_raw_tx_fee = max_raw_tx_fee_rate.GetFee(virtual_size);\n+    std::vector<CTransactionRef> txns;\n+    for (const auto& rawtx : raw_transactions.getValues()) {\n+        CMutableTransaction mtx;\n+        if (!DecodeHexTx(mtx, rawtx.get_str())) {\n+            throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed. Make sure the tx has at least one input.\");\n+        }\n+        txns.emplace_back(MakeTransactionRef(std::move(mtx)));\n+    }\n \n-    UniValue result(UniValue::VARR);\n-    UniValue result_0(UniValue::VOBJ);\n-    result_0.pushKV(\"txid\", tx->GetHash().GetHex());\n-    result_0.pushKV(\"wtxid\", tx->GetWitnessHash().GetHex());\n-\n-    const MempoolAcceptResult accept_result = WITH_LOCK(cs_main, return AcceptToMemoryPool(::ChainstateActive(), mempool, std::move(tx),\n-                                                  false /* bypass_limits */, /* test_accept */ true));\n-\n-    // Only return the fee and vsize if the transaction would pass ATMP.\n-    // These can be used to calculate the feerate.\n-    if (accept_result.m_result_type == MempoolAcceptResult::ResultType::VALID) {\n-        const CAmount fee = accept_result.m_base_fees.value();\n-        // Check that fee does not exceed maximum fee\n-        if (max_raw_tx_fee && fee > max_raw_tx_fee) {\n-            result_0.pushKV(\"allowed\", false);\n-            result_0.pushKV(\"reject-reason\", \"max-fee-exceeded\");\n-        } else {\n-            result_0.pushKV(\"allowed\", true);\n-            result_0.pushKV(\"vsize\", virtual_size);\n-            UniValue fees(UniValue::VOBJ);\n-            fees.pushKV(\"base\", ValueFromAmount(fee));\n-            result_0.pushKV(\"fees\", fees);\n+    CTxMemPool& mempool = EnsureMemPool(request.context);\n+    CChainState& chainstate = EnsureChainman(request.context).ActiveChainstate();\n+    const PackageMempoolAcceptResult validation_result = txns.size() > 1\n+        ? WITH_LOCK(cs_main, return ProcessNewPackage(chainstate, mempool, txns, /* test_accept */ true))\n+        : WITH_LOCK(cs_main, return PackageMempoolAcceptResult(txns[0]->GetHash(),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613615583",
      "id" : 613615583,
      "in_reply_to_id" : 613603255,
      "line" : 956,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMzYxNTU4Mw==",
      "original_commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "original_line" : 956,
      "original_position" : 96,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : 96,
      "pull_request_review_id" : 636116534,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-14T22:02:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613615583",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613616966"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613616966"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Since you're using a const vec ref here, may as well use the Span API.\r\n\r\nThis way you can construct a span from a single pointer to a CTxMemPoolEntry and avoid needing to allocate to call CalculateMempoolAncestors",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-04-14T22:05:59Z",
      "diff_hunk" : "@@ -150,33 +151,48 @@ void CTxMemPool::UpdateTransactionsFromBlock(const std::vector<uint256> &vHashes\n     }\n }\n \n-bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntries &setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string &errString, bool fSearchForParents /* = true */) const\n+bool CTxMemPool::CalculateMemPoolAncestors(const std::vector<CTxMemPoolEntry>& entries,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613616966",
      "id" : 613616966,
      "line" : 154,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMzYxNjk2Ng==",
      "original_commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "original_line" : 154,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 13,
      "pull_request_review_id" : 636118199,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-14T22:05:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613616966",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613618547"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613618547"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If you're touching this code you *could* update it to use Epoch Algorithms.\r\n\r\nEssentially all you need to do is get a new epoch, and then visit the txiters you are interested in and add them to a vec instead of a set.\r\n\r\nThis lets you get rid of the O(n^2)  potential of a merge call.\r\n\r\n",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-04-14T22:09:25Z",
      "diff_hunk" : "@@ -150,33 +151,48 @@ void CTxMemPool::UpdateTransactionsFromBlock(const std::vector<uint256> &vHashes\n     }\n }\n \n-bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntries &setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string &errString, bool fSearchForParents /* = true */) const\n+bool CTxMemPool::CalculateMemPoolAncestors(const std::vector<CTxMemPoolEntry>& entries,\n+                                           setEntries& setAncestors,\n+                                           const uint64_t limitAncestorCount,\n+                                           const uint64_t limitAncestorSize,\n+                                           const uint64_t limitDescendantCount,\n+                                           const uint64_t limitDescendantSize,\n+                                           std::string &errString,\n+                                           const bool fSearchForParents /*=true*/) const\n {\n-    CTxMemPoolEntry::Parents staged_ancestors;\n-    const CTransaction &tx = entry.GetTx();\n+    const size_t total_virtual_size = std::accumulate(entries.cbegin(), entries.cend(), 0,\n+                                      [](int64_t sum, const auto& entry)\n+                                      { return sum + GetVirtualTransactionSize(entry.GetTx()); });\n+    const size_t total_count = entries.size();\n \n+    CTxMemPoolEntry::Parents staged_ancestors;\n     if (fSearchForParents) {\n-        // Get parents of this transaction that are in the mempool\n-        // GetMemPoolParents() is only valid for entries in the mempool, so we\n-        // iterate mapTx to find parents.\n-        for (unsigned int i = 0; i < tx.vin.size(); i++) {\n-            std::optional<txiter> piter = GetIter(tx.vin[i].prevout.hash);\n-            if (piter) {\n-                staged_ancestors.insert(**piter);\n-                if (staged_ancestors.size() + 1 > limitAncestorCount) {\n-                    errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n-                    return false;\n+\n+        for (const auto& entry : entries) {\n+            // Get parents of this transaction that are in the mempool\n+            // GetMemPoolParents() is only valid for entries in the mempool, so we\n+            // iterate mapTx to find parents.\n+            for (const auto& input : entry.GetTx().vin) {\n+                std::optional<txiter> piter = GetIter(input.prevout.hash);\n+                if (piter) {\n+                    staged_ancestors.insert(**piter);\n+                    if (staged_ancestors.size() + 1 > limitAncestorCount) {\n+                        errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n+                        return false;\n+                    }\n                 }\n             }\n         }\n     } else {\n-        // If we're not searching for parents, we require this to be an\n-        // entry in the mempool already.\n-        txiter it = mapTx.iterator_to(entry);\n-        staged_ancestors = it->GetMemPoolParentsConst();\n+        // If we're not searching for parents, we require all entries to be in the mempool already.\n+        for (const auto& entry : entries) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613618547",
      "id" : 613618547,
      "line" : 188,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMzYxODU0Nw==",
      "original_commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "original_line" : 188,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 63,
      "pull_request_review_id" : 636120004,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-14T22:09:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613618547",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613618750"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613618750"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Alternatively, I can PR the epoch algorithm and you can rebase on it, or I can PR it before this code gets released.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-04-14T22:09:53Z",
      "diff_hunk" : "@@ -150,33 +151,48 @@ void CTxMemPool::UpdateTransactionsFromBlock(const std::vector<uint256> &vHashes\n     }\n }\n \n-bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntries &setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string &errString, bool fSearchForParents /* = true */) const\n+bool CTxMemPool::CalculateMemPoolAncestors(const std::vector<CTxMemPoolEntry>& entries,\n+                                           setEntries& setAncestors,\n+                                           const uint64_t limitAncestorCount,\n+                                           const uint64_t limitAncestorSize,\n+                                           const uint64_t limitDescendantCount,\n+                                           const uint64_t limitDescendantSize,\n+                                           std::string &errString,\n+                                           const bool fSearchForParents /*=true*/) const\n {\n-    CTxMemPoolEntry::Parents staged_ancestors;\n-    const CTransaction &tx = entry.GetTx();\n+    const size_t total_virtual_size = std::accumulate(entries.cbegin(), entries.cend(), 0,\n+                                      [](int64_t sum, const auto& entry)\n+                                      { return sum + GetVirtualTransactionSize(entry.GetTx()); });\n+    const size_t total_count = entries.size();\n \n+    CTxMemPoolEntry::Parents staged_ancestors;\n     if (fSearchForParents) {\n-        // Get parents of this transaction that are in the mempool\n-        // GetMemPoolParents() is only valid for entries in the mempool, so we\n-        // iterate mapTx to find parents.\n-        for (unsigned int i = 0; i < tx.vin.size(); i++) {\n-            std::optional<txiter> piter = GetIter(tx.vin[i].prevout.hash);\n-            if (piter) {\n-                staged_ancestors.insert(**piter);\n-                if (staged_ancestors.size() + 1 > limitAncestorCount) {\n-                    errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n-                    return false;\n+\n+        for (const auto& entry : entries) {\n+            // Get parents of this transaction that are in the mempool\n+            // GetMemPoolParents() is only valid for entries in the mempool, so we\n+            // iterate mapTx to find parents.\n+            for (const auto& input : entry.GetTx().vin) {\n+                std::optional<txiter> piter = GetIter(input.prevout.hash);\n+                if (piter) {\n+                    staged_ancestors.insert(**piter);\n+                    if (staged_ancestors.size() + 1 > limitAncestorCount) {\n+                        errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n+                        return false;\n+                    }\n                 }\n             }\n         }\n     } else {\n-        // If we're not searching for parents, we require this to be an\n-        // entry in the mempool already.\n-        txiter it = mapTx.iterator_to(entry);\n-        staged_ancestors = it->GetMemPoolParentsConst();\n+        // If we're not searching for parents, we require all entries to be in the mempool already.\n+        for (const auto& entry : entries) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613618750",
      "id" : 613618750,
      "in_reply_to_id" : 613618547,
      "line" : 188,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMzYxODc1MA==",
      "original_commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "original_line" : 188,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 63,
      "pull_request_review_id" : 636120242,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-14T22:09:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613618750",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613623223"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613623223"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think staged ancestors is possibly overcounting here, need to run through if there are circumstances where we'd trigger early here.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-04-14T22:19:29Z",
      "diff_hunk" : "@@ -205,7 +222,7 @@ bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntr\n             if (setAncestors.count(parent_it) == 0) {\n                 staged_ancestors.insert(parent);\n             }\n-            if (staged_ancestors.size() + setAncestors.size() + 1 > limitAncestorCount) {\n+            if (staged_ancestors.size() + setAncestors.size() + total_count > limitAncestorCount) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613623223",
      "id" : 613623223,
      "line" : 225,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMzYyMzIyMw==",
      "original_commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "original_line" : 225,
      "original_position" : 94,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 94,
      "pull_request_review_id" : 636125639,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-14T22:19:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613623223",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613624063"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613624063"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "When you do the span you'd do `std::span(&entry, 1)` I think",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-04-14T22:21:30Z",
      "diff_hunk" : "@@ -215,6 +232,13 @@ bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntr\n     return true;\n }\n \n+bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntries &setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string &errString, bool fSearchForParents /* = true */) const\n+{\n+    return CalculateMemPoolAncestors(std::vector<CTxMemPoolEntry>{entry}, setAncestors,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613624063",
      "id" : 613624063,
      "line" : 237,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMzYyNDA2Mw==",
      "original_commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "original_line" : 237,
      "original_position" : 104,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 104,
      "pull_request_review_id" : 636126651,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-14T22:21:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613624063",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613625630"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613625630"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes, it's certainly overestimating for every case except for a package of parent + child. But I assume that's the vast majority of cases for a package.\r\n\r\nI did just notice that we're double-counting the current tx though, so I'll update to do `staged_ancestors.size() + setAncestors.size() + total count - 1 > limitAncestorCount`",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-04-14T22:25:21Z",
      "diff_hunk" : "@@ -205,7 +222,7 @@ bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntr\n             if (setAncestors.count(parent_it) == 0) {\n                 staged_ancestors.insert(parent);\n             }\n-            if (staged_ancestors.size() + setAncestors.size() + 1 > limitAncestorCount) {\n+            if (staged_ancestors.size() + setAncestors.size() + total_count > limitAncestorCount) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613625630",
      "id" : 613625630,
      "in_reply_to_id" : 613623223,
      "line" : 225,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMzYyNTYzMA==",
      "original_commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "original_line" : 225,
      "original_position" : 94,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 94,
      "pull_request_review_id" : 636128610,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-14T22:25:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613625630",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613635484"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613635484"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Can this not be a vector of equal length to the package sent and index it by index?\r\n\r\nThis will most likely save memory & less work.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-04-14T22:49:54Z",
      "diff_hunk" : "@@ -187,34 +188,65 @@ void PruneBlockFilesManual(CChainState& active_chainstate, int nManualPruneHeigh\n * Validation result for a single transaction mempool acceptance.\n */\n struct MempoolAcceptResult {\n-    /** Used to indicate the results of mempool validation,\n-    * including the possibility of unfinished validation.\n-    */\n+    /** Used to indicate the results of mempool validation. */\n     enum class ResultType {\n         VALID, //!> Fully validated, valid.\n         INVALID, //!> Invalid.\n     };\n-    ResultType m_result_type;\n-    TxValidationState m_state;\n+    const ResultType m_result_type;\n+    const TxValidationState m_state;\n \n     // The following fields are only present when m_result_type = ResultType::VALID\n     /** Mempool transactions replaced by the tx per BIP 125 rules. */\n-    std::optional<std::list<CTransactionRef>> m_replaced_transactions;\n-    /** Raw base fees. */\n-    std::optional<CAmount> m_base_fees;\n+    const std::optional<std::list<CTransactionRef>> m_replaced_transactions;\n+    /** Raw base fees in satoshis. */\n+    const std::optional<CAmount> m_base_fees;\n+\n+    static MempoolAcceptResult Failure(const TxValidationState state) {\n+        return MempoolAcceptResult(state);\n+    }\n+\n+    static MempoolAcceptResult Success(std::list<CTransactionRef>&& replaced_txns, const CAmount fees) {\n+        return MempoolAcceptResult(std::move(replaced_txns), fees);\n+    }\n \n+// Private constructors. Use static methods MempoolAcceptResult::Success, etc. to construct.\n+private:\n     /** Constructor for failure case */\n-    explicit MempoolAcceptResult(TxValidationState state)\n-        : m_result_type(ResultType::INVALID), m_state(state) {\n+    explicit MempoolAcceptResult(const TxValidationState state)\n+        : m_result_type{ResultType::INVALID}, m_state{state}, m_replaced_transactions(std::nullopt),\n+        m_base_fees{std::nullopt} {\n             Assume(!state.IsValid()); // Can be invalid or error\n         }\n \n     /** Constructor for success case */\n-    explicit MempoolAcceptResult(std::list<CTransactionRef>&& replaced_txns, CAmount fees)\n-        : m_result_type(ResultType::VALID), m_state(TxValidationState{}),\n+    explicit MempoolAcceptResult(std::list<CTransactionRef>&& replaced_txns, const CAmount fees)\n+        : m_result_type{ResultType::VALID},\n         m_replaced_transactions(std::move(replaced_txns)), m_base_fees(fees) {}\n };\n \n+/**\n+* Validation result for package mempool acceptance.\n+*/\n+struct PackageMempoolAcceptResult\n+{\n+    PackageValidationState m_state;\n+    /**\n+    * Map from txid to finished MempoolAcceptResults. The client is responsible\n+    * for keeping track of the transaction objects themselves. If a result is not\n+    * present, it means validation was unfinished for that transaction.\n+    */\n+    std::map<const uint256, const MempoolAcceptResult> m_tx_results;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613635484",
      "id" : 613635484,
      "line" : 239,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMzYzNTQ4NA==",
      "original_commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "original_line" : 239,
      "original_position" : 72,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 72,
      "pull_request_review_id" : 636140114,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-14T22:49:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613635484",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613637283"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613637283"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "maybe bench using unordered_set here",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-04-14T22:54:56Z",
      "diff_hunk" : "@@ -465,6 +464,111 @@ static bool CheckInputsFromMempoolAndCache(const CTransaction& tx, TxValidationS\n     return CheckInputScripts(tx, state, view, flags, /* cacheSigStore = */ true, /* cacheFullSciptStore = */ true, txdata);\n }\n \n+/**\n+ * A CoinsView that adds a memory cache to another CoinsView and serves as temporary scratch space.\n+ * Used by MemPoolAccept class to validate transactions and packages before submitting to mempool.\n+ * A backend can be set to provide read access to chainstate and/or mempool coins, but writing to\n+ * the backend is disabled. Avoid using a CoinsViewTemporary in consensus-critical paths such\n+ * as writing to the script cache. See CheckInputsFromMempoolAndCache as an example. When not being\n+ * used to validate a package (m_temp_added and m_temp_spent are empty), a CoinsViewTemporary\n+ * behaves exactly like a CCoinsViewCache.\n+ */\n+class CoinsViewTemporary : public CCoinsViewCache\n+{\n+    /**\n+    * Coins made available by transactions being validated. Tracking these allows for package\n+    * validation, since we can access transaction outputs without submitting them to mempool.\n+    */\n+    std::map<COutPoint, Coin> m_temp_added;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613637283",
      "id" : 613637283,
      "line" : 482,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMzYzNzI4Mw==",
      "original_commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "original_line" : 482,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 51,
      "pull_request_review_id" : 636142309,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-14T22:54:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613637283",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613645936"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613645936"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "ibid",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-04-14T23:18:35Z",
      "diff_hunk" : "@@ -465,6 +464,111 @@ static bool CheckInputsFromMempoolAndCache(const CTransaction& tx, TxValidationS\n     return CheckInputScripts(tx, state, view, flags, /* cacheSigStore = */ true, /* cacheFullSciptStore = */ true, txdata);\n }\n \n+/**\n+ * A CoinsView that adds a memory cache to another CoinsView and serves as temporary scratch space.\n+ * Used by MemPoolAccept class to validate transactions and packages before submitting to mempool.\n+ * A backend can be set to provide read access to chainstate and/or mempool coins, but writing to\n+ * the backend is disabled. Avoid using a CoinsViewTemporary in consensus-critical paths such\n+ * as writing to the script cache. See CheckInputsFromMempoolAndCache as an example. When not being\n+ * used to validate a package (m_temp_added and m_temp_spent are empty), a CoinsViewTemporary\n+ * behaves exactly like a CCoinsViewCache.\n+ */\n+class CoinsViewTemporary : public CCoinsViewCache\n+{\n+    /**\n+    * Coins made available by transactions being validated. Tracking these allows for package\n+    * validation, since we can access transaction outputs without submitting them to mempool.\n+    */\n+    std::map<COutPoint, Coin> m_temp_added;\n+\n+    /**\n+    * Coins spent by transactions being validated. When validating a package, we need to track\n+    * these in order to distinguish between missing/spent coins and conflicts within a package.\n+    */\n+    std::set<COutPoint> m_temp_spent;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613645936",
      "id" : 613645936,
      "line" : 488,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMzY0NTkzNg==",
      "original_commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "original_line" : 488,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 57,
      "pull_request_review_id" : 636153480,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-14T23:18:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613645936",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613646867"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613646867"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: Hmmm... I know GetCoin is perf sensitive but do we do this placeholder coin often?\r\n\r\nWould optional coin be cleaner?\r\n\r\n",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-04-14T23:21:14Z",
      "diff_hunk" : "@@ -465,6 +464,111 @@ static bool CheckInputsFromMempoolAndCache(const CTransaction& tx, TxValidationS\n     return CheckInputScripts(tx, state, view, flags, /* cacheSigStore = */ true, /* cacheFullSciptStore = */ true, txdata);\n }\n \n+/**\n+ * A CoinsView that adds a memory cache to another CoinsView and serves as temporary scratch space.\n+ * Used by MemPoolAccept class to validate transactions and packages before submitting to mempool.\n+ * A backend can be set to provide read access to chainstate and/or mempool coins, but writing to\n+ * the backend is disabled. Avoid using a CoinsViewTemporary in consensus-critical paths such\n+ * as writing to the script cache. See CheckInputsFromMempoolAndCache as an example. When not being\n+ * used to validate a package (m_temp_added and m_temp_spent are empty), a CoinsViewTemporary\n+ * behaves exactly like a CCoinsViewCache.\n+ */\n+class CoinsViewTemporary : public CCoinsViewCache\n+{\n+    /**\n+    * Coins made available by transactions being validated. Tracking these allows for package\n+    * validation, since we can access transaction outputs without submitting them to mempool.\n+    */\n+    std::map<COutPoint, Coin> m_temp_added;\n+\n+    /**\n+    * Coins spent by transactions being validated. When validating a package, we need to track\n+    * these in order to distinguish between missing/spent coins and conflicts within a package.\n+    */\n+    std::set<COutPoint> m_temp_spent;\n+\n+    /** An empty coin used as a placeholder for a spent coin.*/\n+    inline static const Coin s_coin_spent;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613646867",
      "id" : 613646867,
      "line" : 491,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMzY0Njg2Nw==",
      "original_commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "original_line" : 491,
      "original_position" : 60,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 60,
      "pull_request_review_id" : 636154571,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-14T23:21:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613646867",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613648523"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613648523"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: would be shorter to write `!AccessCoin(outpoint).IsSpent()`",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-04-14T23:25:51Z",
      "diff_hunk" : "@@ -465,6 +464,111 @@ static bool CheckInputsFromMempoolAndCache(const CTransaction& tx, TxValidationS\n     return CheckInputScripts(tx, state, view, flags, /* cacheSigStore = */ true, /* cacheFullSciptStore = */ true, txdata);\n }\n \n+/**\n+ * A CoinsView that adds a memory cache to another CoinsView and serves as temporary scratch space.\n+ * Used by MemPoolAccept class to validate transactions and packages before submitting to mempool.\n+ * A backend can be set to provide read access to chainstate and/or mempool coins, but writing to\n+ * the backend is disabled. Avoid using a CoinsViewTemporary in consensus-critical paths such\n+ * as writing to the script cache. See CheckInputsFromMempoolAndCache as an example. When not being\n+ * used to validate a package (m_temp_added and m_temp_spent are empty), a CoinsViewTemporary\n+ * behaves exactly like a CCoinsViewCache.\n+ */\n+class CoinsViewTemporary : public CCoinsViewCache\n+{\n+    /**\n+    * Coins made available by transactions being validated. Tracking these allows for package\n+    * validation, since we can access transaction outputs without submitting them to mempool.\n+    */\n+    std::map<COutPoint, Coin> m_temp_added;\n+\n+    /**\n+    * Coins spent by transactions being validated. When validating a package, we need to track\n+    * these in order to distinguish between missing/spent coins and conflicts within a package.\n+    */\n+    std::set<COutPoint> m_temp_spent;\n+\n+    /** An empty coin used as a placeholder for a spent coin.*/\n+    inline static const Coin s_coin_spent;\n+\n+public:\n+\n+    CoinsViewTemporary(CCoinsView* baseIn) : CCoinsViewCache(baseIn) {}\n+\n+    // Delete the copy constructor to prevent accidentally using it when one intends to create a\n+    // CoinsViewTemporary on top of a base cache.\n+    CoinsViewTemporary(const CoinsViewTemporary &) = delete;\n+\n+    bool GetCoin(const COutPoint& outpoint, Coin& coin) const override {\n+        coin = AccessCoin(outpoint);\n+        return !coin.IsSpent();\n+    }\n+\n+    const Coin& AccessCoin(const COutPoint& outpoint) const override {\n+        // Check to see if another tx in the package has already spent this coin (conflict-in-package).\n+        // Coins spent by others in the package are only tracked in m_temp_spent.\n+        if (m_temp_spent.count(outpoint)) {\n+            return s_coin_spent;\n+        }\n+\n+        // Check to see if the inputs are made available by another tx in the package.\n+        // These Coins would not be available in the underlying CoinsView.\n+        if (auto it = m_temp_added.find(outpoint); it != m_temp_added.end()) {\n+            assert(!it->second.IsSpent());\n+            return it->second;\n+        }\n+        return CCoinsViewCache::AccessCoin(outpoint);\n+    }\n+\n+    bool HaveCoin(const COutPoint& outpoint) const override {\n+        Coin coin;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613648523",
      "id" : 613648523,
      "line" : 523,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMzY0ODUyMw==",
      "original_commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "original_line" : 523,
      "original_position" : 92,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 92,
      "pull_request_review_id" : 636156477,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-14T23:25:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613648523",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613653530"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613653530"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "this should be documented in the function doc that this must be true.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-04-14T23:40:50Z",
      "diff_hunk" : "@@ -465,6 +464,111 @@ static bool CheckInputsFromMempoolAndCache(const CTransaction& tx, TxValidationS\n     return CheckInputScripts(tx, state, view, flags, /* cacheSigStore = */ true, /* cacheFullSciptStore = */ true, txdata);\n }\n \n+/**\n+ * A CoinsView that adds a memory cache to another CoinsView and serves as temporary scratch space.\n+ * Used by MemPoolAccept class to validate transactions and packages before submitting to mempool.\n+ * A backend can be set to provide read access to chainstate and/or mempool coins, but writing to\n+ * the backend is disabled. Avoid using a CoinsViewTemporary in consensus-critical paths such\n+ * as writing to the script cache. See CheckInputsFromMempoolAndCache as an example. When not being\n+ * used to validate a package (m_temp_added and m_temp_spent are empty), a CoinsViewTemporary\n+ * behaves exactly like a CCoinsViewCache.\n+ */\n+class CoinsViewTemporary : public CCoinsViewCache\n+{\n+    /**\n+    * Coins made available by transactions being validated. Tracking these allows for package\n+    * validation, since we can access transaction outputs without submitting them to mempool.\n+    */\n+    std::map<COutPoint, Coin> m_temp_added;\n+\n+    /**\n+    * Coins spent by transactions being validated. When validating a package, we need to track\n+    * these in order to distinguish between missing/spent coins and conflicts within a package.\n+    */\n+    std::set<COutPoint> m_temp_spent;\n+\n+    /** An empty coin used as a placeholder for a spent coin.*/\n+    inline static const Coin s_coin_spent;\n+\n+public:\n+\n+    CoinsViewTemporary(CCoinsView* baseIn) : CCoinsViewCache(baseIn) {}\n+\n+    // Delete the copy constructor to prevent accidentally using it when one intends to create a\n+    // CoinsViewTemporary on top of a base cache.\n+    CoinsViewTemporary(const CoinsViewTemporary &) = delete;\n+\n+    bool GetCoin(const COutPoint& outpoint, Coin& coin) const override {\n+        coin = AccessCoin(outpoint);\n+        return !coin.IsSpent();\n+    }\n+\n+    const Coin& AccessCoin(const COutPoint& outpoint) const override {\n+        // Check to see if another tx in the package has already spent this coin (conflict-in-package).\n+        // Coins spent by others in the package are only tracked in m_temp_spent.\n+        if (m_temp_spent.count(outpoint)) {\n+            return s_coin_spent;\n+        }\n+\n+        // Check to see if the inputs are made available by another tx in the package.\n+        // These Coins would not be available in the underlying CoinsView.\n+        if (auto it = m_temp_added.find(outpoint); it != m_temp_added.end()) {\n+            assert(!it->second.IsSpent());\n+            return it->second;\n+        }\n+        return CCoinsViewCache::AccessCoin(outpoint);\n+    }\n+\n+    bool HaveCoin(const COutPoint& outpoint) const override {\n+        Coin coin;\n+        return GetCoin(outpoint, coin);\n+    }\n+\n+    /**\n+    * Update with coins spent and created by a transaction.\n+    * Only used for package validation.\n+    */\n+    void PackageAddTransaction(const CTransactionRef& tx)\n+    {\n+        // Track Coins spent by this transaction. They must exist and not already be spent.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613653530",
      "id" : 613653530,
      "line" : 533,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMzY1MzUzMA==",
      "original_commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "original_line" : 533,
      "original_position" : 102,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 102,
      "pull_request_review_id" : 636162504,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-14T23:40:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613653530",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613653851"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613653851"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "HaveCoin?",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-04-14T23:41:57Z",
      "diff_hunk" : "@@ -465,6 +464,111 @@ static bool CheckInputsFromMempoolAndCache(const CTransaction& tx, TxValidationS\n     return CheckInputScripts(tx, state, view, flags, /* cacheSigStore = */ true, /* cacheFullSciptStore = */ true, txdata);\n }\n \n+/**\n+ * A CoinsView that adds a memory cache to another CoinsView and serves as temporary scratch space.\n+ * Used by MemPoolAccept class to validate transactions and packages before submitting to mempool.\n+ * A backend can be set to provide read access to chainstate and/or mempool coins, but writing to\n+ * the backend is disabled. Avoid using a CoinsViewTemporary in consensus-critical paths such\n+ * as writing to the script cache. See CheckInputsFromMempoolAndCache as an example. When not being\n+ * used to validate a package (m_temp_added and m_temp_spent are empty), a CoinsViewTemporary\n+ * behaves exactly like a CCoinsViewCache.\n+ */\n+class CoinsViewTemporary : public CCoinsViewCache\n+{\n+    /**\n+    * Coins made available by transactions being validated. Tracking these allows for package\n+    * validation, since we can access transaction outputs without submitting them to mempool.\n+    */\n+    std::map<COutPoint, Coin> m_temp_added;\n+\n+    /**\n+    * Coins spent by transactions being validated. When validating a package, we need to track\n+    * these in order to distinguish between missing/spent coins and conflicts within a package.\n+    */\n+    std::set<COutPoint> m_temp_spent;\n+\n+    /** An empty coin used as a placeholder for a spent coin.*/\n+    inline static const Coin s_coin_spent;\n+\n+public:\n+\n+    CoinsViewTemporary(CCoinsView* baseIn) : CCoinsViewCache(baseIn) {}\n+\n+    // Delete the copy constructor to prevent accidentally using it when one intends to create a\n+    // CoinsViewTemporary on top of a base cache.\n+    CoinsViewTemporary(const CoinsViewTemporary &) = delete;\n+\n+    bool GetCoin(const COutPoint& outpoint, Coin& coin) const override {\n+        coin = AccessCoin(outpoint);\n+        return !coin.IsSpent();\n+    }\n+\n+    const Coin& AccessCoin(const COutPoint& outpoint) const override {\n+        // Check to see if another tx in the package has already spent this coin (conflict-in-package).\n+        // Coins spent by others in the package are only tracked in m_temp_spent.\n+        if (m_temp_spent.count(outpoint)) {\n+            return s_coin_spent;\n+        }\n+\n+        // Check to see if the inputs are made available by another tx in the package.\n+        // These Coins would not be available in the underlying CoinsView.\n+        if (auto it = m_temp_added.find(outpoint); it != m_temp_added.end()) {\n+            assert(!it->second.IsSpent());\n+            return it->second;\n+        }\n+        return CCoinsViewCache::AccessCoin(outpoint);\n+    }\n+\n+    bool HaveCoin(const COutPoint& outpoint) const override {\n+        Coin coin;\n+        return GetCoin(outpoint, coin);\n+    }\n+\n+    /**\n+    * Update with coins spent and created by a transaction.\n+    * Only used for package validation.\n+    */\n+    void PackageAddTransaction(const CTransactionRef& tx)\n+    {\n+        // Track Coins spent by this transaction. They must exist and not already be spent.\n+        for (auto input : tx->vin) {\n+            Coin spent_coin;\n+            Assume(GetCoin(input.prevout, spent_coin));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613653851",
      "id" : 613653851,
      "line" : 536,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMzY1Mzg1MQ==",
      "original_commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "original_line" : 536,
      "original_position" : 105,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 105,
      "pull_request_review_id" : 636162946,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-14T23:41:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613653851",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613672128"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613672128"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think you should just return false here maybe? would need to check the API but that should tell you that it failed (otherwise change the API to be nothrow)\r\n\r\n",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-04-15T00:40:47Z",
      "diff_hunk" : "@@ -465,6 +464,111 @@ static bool CheckInputsFromMempoolAndCache(const CTransaction& tx, TxValidationS\n     return CheckInputScripts(tx, state, view, flags, /* cacheSigStore = */ true, /* cacheFullSciptStore = */ true, txdata);\n }\n \n+/**\n+ * A CoinsView that adds a memory cache to another CoinsView and serves as temporary scratch space.\n+ * Used by MemPoolAccept class to validate transactions and packages before submitting to mempool.\n+ * A backend can be set to provide read access to chainstate and/or mempool coins, but writing to\n+ * the backend is disabled. Avoid using a CoinsViewTemporary in consensus-critical paths such\n+ * as writing to the script cache. See CheckInputsFromMempoolAndCache as an example. When not being\n+ * used to validate a package (m_temp_added and m_temp_spent are empty), a CoinsViewTemporary\n+ * behaves exactly like a CCoinsViewCache.\n+ */\n+class CoinsViewTemporary : public CCoinsViewCache\n+{\n+    /**\n+    * Coins made available by transactions being validated. Tracking these allows for package\n+    * validation, since we can access transaction outputs without submitting them to mempool.\n+    */\n+    std::map<COutPoint, Coin> m_temp_added;\n+\n+    /**\n+    * Coins spent by transactions being validated. When validating a package, we need to track\n+    * these in order to distinguish between missing/spent coins and conflicts within a package.\n+    */\n+    std::set<COutPoint> m_temp_spent;\n+\n+    /** An empty coin used as a placeholder for a spent coin.*/\n+    inline static const Coin s_coin_spent;\n+\n+public:\n+\n+    CoinsViewTemporary(CCoinsView* baseIn) : CCoinsViewCache(baseIn) {}\n+\n+    // Delete the copy constructor to prevent accidentally using it when one intends to create a\n+    // CoinsViewTemporary on top of a base cache.\n+    CoinsViewTemporary(const CoinsViewTemporary &) = delete;\n+\n+    bool GetCoin(const COutPoint& outpoint, Coin& coin) const override {\n+        coin = AccessCoin(outpoint);\n+        return !coin.IsSpent();\n+    }\n+\n+    const Coin& AccessCoin(const COutPoint& outpoint) const override {\n+        // Check to see if another tx in the package has already spent this coin (conflict-in-package).\n+        // Coins spent by others in the package are only tracked in m_temp_spent.\n+        if (m_temp_spent.count(outpoint)) {\n+            return s_coin_spent;\n+        }\n+\n+        // Check to see if the inputs are made available by another tx in the package.\n+        // These Coins would not be available in the underlying CoinsView.\n+        if (auto it = m_temp_added.find(outpoint); it != m_temp_added.end()) {\n+            assert(!it->second.IsSpent());\n+            return it->second;\n+        }\n+        return CCoinsViewCache::AccessCoin(outpoint);\n+    }\n+\n+    bool HaveCoin(const COutPoint& outpoint) const override {\n+        Coin coin;\n+        return GetCoin(outpoint, coin);\n+    }\n+\n+    /**\n+    * Update with coins spent and created by a transaction.\n+    * Only used for package validation.\n+    */\n+    void PackageAddTransaction(const CTransactionRef& tx)\n+    {\n+        // Track Coins spent by this transaction. They must exist and not already be spent.\n+        for (auto input : tx->vin) {\n+            Coin spent_coin;\n+            Assume(GetCoin(input.prevout, spent_coin));\n+            m_temp_spent.insert(input.prevout);\n+        }\n+        // Track Coins added by this transaction.\n+        for (unsigned int n = 0; n < tx->vout.size(); ++n) {\n+            m_temp_added.emplace(COutPoint(tx->GetHash(), n), Coin(tx->vout[n], MEMPOOL_HEIGHT, false));\n+        }\n+    }\n+\n+    /**\n+    * Returns whether an outpoint is spent by a transaction in the package being validated.\n+    * Only used for package validation.\n+    */\n+    bool PackageSpends(const COutPoint& outpoint) const {\n+        return m_temp_spent.count(outpoint);\n+    }\n+\n+    /**\n+    * Clear our knowledge of which coins have been spent so far during validation.\n+    * Only used for package validation.\n+    */\n+    void ClearTemporarySpends() {\n+        m_temp_spent.clear();\n+    }\n+\n+    // A CoinsViewTemporary is for temporary scratch space only; it should not write to its backend.\n+    bool Flush() override {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613672128",
      "id" : 613672128,
      "line" : 562,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMzY3MjEyOA==",
      "original_commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "original_line" : 562,
      "original_position" : 131,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 131,
      "pull_request_review_id" : 636183952,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-15T00:40:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613672128",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613682979"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613682979"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "would prolly be faster to build a hashset as you go thru here.\r\n\r\nIf not, you can transform the top for loop to scan the txiters and just scan the txns txids after the current one for a small performance bump.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-04-15T01:03:25Z",
      "diff_hunk" : "@@ -1061,28 +1178,131 @@ MempoolAcceptResult MemPoolAccept::AcceptSingleTransaction(const CTransactionRef\n \n     Workspace ws(ptx);\n \n-    if (!PreChecks(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!PreChecks(args, ws)) return MempoolAcceptResult::Failure(ws.m_state);\n \n     // Only compute the precomputed transaction data if we need to verify\n     // scripts (ie, other policy checks pass). We perform the inexpensive\n     // checks first and avoid hashing and signature verification unless those\n     // checks pass, to mitigate CPU exhaustion denial-of-service attacks.\n     PrecomputedTransactionData txdata;\n \n-    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult::Failure(ws.m_state);\n \n-    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult::Failure(ws.m_state);\n \n     // Tx was accepted, but not added\n     if (args.m_test_accept) {\n-        return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+        return MempoolAcceptResult::Success(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n     }\n \n-    if (!Finalize(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!Finalize(args, ws)) return MempoolAcceptResult::Failure(ws.m_state);\n \n     GetMainSignals().TransactionAddedToMempool(ptx, m_pool.GetAndIncrementSequence());\n \n-    return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+    return MempoolAcceptResult::Success(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+}\n+\n+PackageMempoolAcceptResult MemPoolAccept::AcceptMultipleTransactions(const std::vector<CTransactionRef>& txns, ATMPArgs& args)\n+{\n+    AssertLockHeld(cs_main);\n+\n+    PackageValidationState package_state;\n+    const unsigned int package_count = txns.size();\n+\n+    // These context-free package limits can be checked before taking the mempool lock.\n+    if (package_count > MAX_PACKAGE_COUNT) {\n+        package_state.Invalid(PackageValidationResult::PCKG_POLICY, \"too-many-transactions\");\n+        return PackageMempoolAcceptResult(package_state, {});\n+    }\n+\n+    const int64_t total_size = std::accumulate(txns.cbegin(), txns.cend(), 0,\n+                               [](int64_t sum, const auto& tx) { return sum + GetVirtualTransactionSize(*tx); });\n+    if (total_size > MAX_PACKAGE_SIZE * 1000) {\n+        package_state.Invalid(PackageValidationResult::PCKG_POLICY, \"too-large\");\n+        return PackageMempoolAcceptResult(package_state, {});\n+    }\n+\n+    std::vector<Workspace> workspaces{};\n+    workspaces.reserve(package_count);\n+\n+    // Require the package to be sorted in order of dependency, i.e. parents appear before children.\n+    // An unsorted package will fail anyway on missing-inputs, but it's better to quit earlier and\n+    // fail on something less ambiguous (missing-inputs could also be an orphan or trying to\n+    // spend nonexistent coins).\n+    for (const auto& tx : txns) {\n+        Workspace workspace(tx);\n+        for (const auto& input : tx->vin) {\n+            if (std::find_if(workspaces.begin(), workspaces.end(),\n+                             [&, txid = input.prevout.hash](const auto& preceding_ws)\n+                             { return preceding_ws.m_ptx->GetHash() == txid; }) == workspaces.end() &&\n+                std::find_if(txns.begin(), txns.end(),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613682979",
      "id" : 613682979,
      "line" : 1238,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMzY4Mjk3OQ==",
      "original_commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "original_line" : 1238,
      "original_position" : 274,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 274,
      "pull_request_review_id" : 636191699,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-15T01:03:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613682979",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613689838"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613689838"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "note that this is not canonically ordered. \r\n\r\nOne way to do this is to add a new field \"rank\" in the workspace. For each tx, it's rank is max(parent rank) + 1. Therefore no tx has a lower rank than it's parent. Then you can verify sorted by rank, and then verify sorted by hash. \r\n\r\nThis lets you verify that you have received the package in canonical order. This is useful if you later want package IDs.\r\n\r\nTo generate a canonically ordered package, you can sort by rank, and then stable sort by hash.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-04-15T01:13:59Z",
      "diff_hunk" : "@@ -1061,28 +1178,131 @@ MempoolAcceptResult MemPoolAccept::AcceptSingleTransaction(const CTransactionRef\n \n     Workspace ws(ptx);\n \n-    if (!PreChecks(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!PreChecks(args, ws)) return MempoolAcceptResult::Failure(ws.m_state);\n \n     // Only compute the precomputed transaction data if we need to verify\n     // scripts (ie, other policy checks pass). We perform the inexpensive\n     // checks first and avoid hashing and signature verification unless those\n     // checks pass, to mitigate CPU exhaustion denial-of-service attacks.\n     PrecomputedTransactionData txdata;\n \n-    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult::Failure(ws.m_state);\n \n-    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult::Failure(ws.m_state);\n \n     // Tx was accepted, but not added\n     if (args.m_test_accept) {\n-        return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+        return MempoolAcceptResult::Success(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n     }\n \n-    if (!Finalize(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!Finalize(args, ws)) return MempoolAcceptResult::Failure(ws.m_state);\n \n     GetMainSignals().TransactionAddedToMempool(ptx, m_pool.GetAndIncrementSequence());\n \n-    return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+    return MempoolAcceptResult::Success(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+}\n+\n+PackageMempoolAcceptResult MemPoolAccept::AcceptMultipleTransactions(const std::vector<CTransactionRef>& txns, ATMPArgs& args)\n+{\n+    AssertLockHeld(cs_main);\n+\n+    PackageValidationState package_state;\n+    const unsigned int package_count = txns.size();\n+\n+    // These context-free package limits can be checked before taking the mempool lock.\n+    if (package_count > MAX_PACKAGE_COUNT) {\n+        package_state.Invalid(PackageValidationResult::PCKG_POLICY, \"too-many-transactions\");\n+        return PackageMempoolAcceptResult(package_state, {});\n+    }\n+\n+    const int64_t total_size = std::accumulate(txns.cbegin(), txns.cend(), 0,\n+                               [](int64_t sum, const auto& tx) { return sum + GetVirtualTransactionSize(*tx); });\n+    if (total_size > MAX_PACKAGE_SIZE * 1000) {\n+        package_state.Invalid(PackageValidationResult::PCKG_POLICY, \"too-large\");\n+        return PackageMempoolAcceptResult(package_state, {});\n+    }\n+\n+    std::vector<Workspace> workspaces{};\n+    workspaces.reserve(package_count);\n+\n+    // Require the package to be sorted in order of dependency, i.e. parents appear before children.\n+    // An unsorted package will fail anyway on missing-inputs, but it's better to quit earlier and\n+    // fail on something less ambiguous (missing-inputs could also be an orphan or trying to\n+    // spend nonexistent coins).\n+    for (const auto& tx : txns) {\n+        Workspace workspace(tx);\n+        for (const auto& input : tx->vin) {\n+            if (std::find_if(workspaces.begin(), workspaces.end(),\n+                             [&, txid = input.prevout.hash](const auto& preceding_ws)\n+                             { return preceding_ws.m_ptx->GetHash() == txid; }) == workspaces.end() &&\n+                std::find_if(txns.begin(), txns.end(),\n+                             [&, txid = input.prevout.hash](const auto& tx)\n+                             { return tx->GetHash() == txid; }) != txns.end()) {\n+                // If we don't find the parent in workspaces but we do find it in txns,\n+                // then it must be a subsequent transaction in the package.\n+                package_state.Invalid(PackageValidationResult::PCKG_POLICY, \"package-not-sorted\");\n+                return PackageMempoolAcceptResult(package_state, {});\n+            }\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613689838",
      "id" : 613689838,
      "line" : 1246,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMzY4OTgzOA==",
      "original_commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "original_line" : 1246,
      "original_position" : 282,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 282,
      "pull_request_review_id" : 636195304,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-15T01:14:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613689838",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613690286"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613690286"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "To do this change I'd get rid of the find_if's and make them for loops it will be easier to code.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-04-15T01:14:36Z",
      "diff_hunk" : "@@ -1061,28 +1178,131 @@ MempoolAcceptResult MemPoolAccept::AcceptSingleTransaction(const CTransactionRef\n \n     Workspace ws(ptx);\n \n-    if (!PreChecks(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!PreChecks(args, ws)) return MempoolAcceptResult::Failure(ws.m_state);\n \n     // Only compute the precomputed transaction data if we need to verify\n     // scripts (ie, other policy checks pass). We perform the inexpensive\n     // checks first and avoid hashing and signature verification unless those\n     // checks pass, to mitigate CPU exhaustion denial-of-service attacks.\n     PrecomputedTransactionData txdata;\n \n-    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult::Failure(ws.m_state);\n \n-    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult::Failure(ws.m_state);\n \n     // Tx was accepted, but not added\n     if (args.m_test_accept) {\n-        return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+        return MempoolAcceptResult::Success(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n     }\n \n-    if (!Finalize(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!Finalize(args, ws)) return MempoolAcceptResult::Failure(ws.m_state);\n \n     GetMainSignals().TransactionAddedToMempool(ptx, m_pool.GetAndIncrementSequence());\n \n-    return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+    return MempoolAcceptResult::Success(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+}\n+\n+PackageMempoolAcceptResult MemPoolAccept::AcceptMultipleTransactions(const std::vector<CTransactionRef>& txns, ATMPArgs& args)\n+{\n+    AssertLockHeld(cs_main);\n+\n+    PackageValidationState package_state;\n+    const unsigned int package_count = txns.size();\n+\n+    // These context-free package limits can be checked before taking the mempool lock.\n+    if (package_count > MAX_PACKAGE_COUNT) {\n+        package_state.Invalid(PackageValidationResult::PCKG_POLICY, \"too-many-transactions\");\n+        return PackageMempoolAcceptResult(package_state, {});\n+    }\n+\n+    const int64_t total_size = std::accumulate(txns.cbegin(), txns.cend(), 0,\n+                               [](int64_t sum, const auto& tx) { return sum + GetVirtualTransactionSize(*tx); });\n+    if (total_size > MAX_PACKAGE_SIZE * 1000) {\n+        package_state.Invalid(PackageValidationResult::PCKG_POLICY, \"too-large\");\n+        return PackageMempoolAcceptResult(package_state, {});\n+    }\n+\n+    std::vector<Workspace> workspaces{};\n+    workspaces.reserve(package_count);\n+\n+    // Require the package to be sorted in order of dependency, i.e. parents appear before children.\n+    // An unsorted package will fail anyway on missing-inputs, but it's better to quit earlier and\n+    // fail on something less ambiguous (missing-inputs could also be an orphan or trying to\n+    // spend nonexistent coins).\n+    for (const auto& tx : txns) {\n+        Workspace workspace(tx);\n+        for (const auto& input : tx->vin) {\n+            if (std::find_if(workspaces.begin(), workspaces.end(),\n+                             [&, txid = input.prevout.hash](const auto& preceding_ws)\n+                             { return preceding_ws.m_ptx->GetHash() == txid; }) == workspaces.end() &&\n+                std::find_if(txns.begin(), txns.end(),\n+                             [&, txid = input.prevout.hash](const auto& tx)\n+                             { return tx->GetHash() == txid; }) != txns.end()) {\n+                // If we don't find the parent in workspaces but we do find it in txns,\n+                // then it must be a subsequent transaction in the package.\n+                package_state.Invalid(PackageValidationResult::PCKG_POLICY, \"package-not-sorted\");\n+                return PackageMempoolAcceptResult(package_state, {});\n+            }\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613690286",
      "id" : 613690286,
      "in_reply_to_id" : 613689838,
      "line" : 1246,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMzY5MDI4Ng==",
      "original_commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "original_line" : 1246,
      "original_position" : 282,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 282,
      "pull_request_review_id" : 636195520,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-15T01:14:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613690286",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613691916"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613691916"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: you can directly construct the workspace on the back of workspaces ",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-04-15T01:17:09Z",
      "diff_hunk" : "@@ -1061,28 +1178,131 @@ MempoolAcceptResult MemPoolAccept::AcceptSingleTransaction(const CTransactionRef\n \n     Workspace ws(ptx);\n \n-    if (!PreChecks(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!PreChecks(args, ws)) return MempoolAcceptResult::Failure(ws.m_state);\n \n     // Only compute the precomputed transaction data if we need to verify\n     // scripts (ie, other policy checks pass). We perform the inexpensive\n     // checks first and avoid hashing and signature verification unless those\n     // checks pass, to mitigate CPU exhaustion denial-of-service attacks.\n     PrecomputedTransactionData txdata;\n \n-    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult::Failure(ws.m_state);\n \n-    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult::Failure(ws.m_state);\n \n     // Tx was accepted, but not added\n     if (args.m_test_accept) {\n-        return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+        return MempoolAcceptResult::Success(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n     }\n \n-    if (!Finalize(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!Finalize(args, ws)) return MempoolAcceptResult::Failure(ws.m_state);\n \n     GetMainSignals().TransactionAddedToMempool(ptx, m_pool.GetAndIncrementSequence());\n \n-    return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+    return MempoolAcceptResult::Success(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+}\n+\n+PackageMempoolAcceptResult MemPoolAccept::AcceptMultipleTransactions(const std::vector<CTransactionRef>& txns, ATMPArgs& args)\n+{\n+    AssertLockHeld(cs_main);\n+\n+    PackageValidationState package_state;\n+    const unsigned int package_count = txns.size();\n+\n+    // These context-free package limits can be checked before taking the mempool lock.\n+    if (package_count > MAX_PACKAGE_COUNT) {\n+        package_state.Invalid(PackageValidationResult::PCKG_POLICY, \"too-many-transactions\");\n+        return PackageMempoolAcceptResult(package_state, {});\n+    }\n+\n+    const int64_t total_size = std::accumulate(txns.cbegin(), txns.cend(), 0,\n+                               [](int64_t sum, const auto& tx) { return sum + GetVirtualTransactionSize(*tx); });\n+    if (total_size > MAX_PACKAGE_SIZE * 1000) {\n+        package_state.Invalid(PackageValidationResult::PCKG_POLICY, \"too-large\");\n+        return PackageMempoolAcceptResult(package_state, {});\n+    }\n+\n+    std::vector<Workspace> workspaces{};\n+    workspaces.reserve(package_count);\n+\n+    // Require the package to be sorted in order of dependency, i.e. parents appear before children.\n+    // An unsorted package will fail anyway on missing-inputs, but it's better to quit earlier and\n+    // fail on something less ambiguous (missing-inputs could also be an orphan or trying to\n+    // spend nonexistent coins).\n+    for (const auto& tx : txns) {\n+        Workspace workspace(tx);\n+        for (const auto& input : tx->vin) {\n+            if (std::find_if(workspaces.begin(), workspaces.end(),\n+                             [&, txid = input.prevout.hash](const auto& preceding_ws)\n+                             { return preceding_ws.m_ptx->GetHash() == txid; }) == workspaces.end() &&\n+                std::find_if(txns.begin(), txns.end(),\n+                             [&, txid = input.prevout.hash](const auto& tx)\n+                             { return tx->GetHash() == txid; }) != txns.end()) {\n+                // If we don't find the parent in workspaces but we do find it in txns,\n+                // then it must be a subsequent transaction in the package.\n+                package_state.Invalid(PackageValidationResult::PCKG_POLICY, \"package-not-sorted\");\n+                return PackageMempoolAcceptResult(package_state, {});\n+            }\n+        }\n+        workspaces.emplace_back(std::move(workspace));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613691916",
      "id" : 613691916,
      "line" : 1247,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMzY5MTkxNg==",
      "original_commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "original_line" : 1247,
      "original_position" : 283,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 283,
      "pull_request_review_id" : 636196417,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-15T01:17:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613691916",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613692663"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613692663"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "altho then you want to go to end-1 if you do that.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-04-15T01:18:11Z",
      "diff_hunk" : "@@ -1061,28 +1178,131 @@ MempoolAcceptResult MemPoolAccept::AcceptSingleTransaction(const CTransactionRef\n \n     Workspace ws(ptx);\n \n-    if (!PreChecks(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!PreChecks(args, ws)) return MempoolAcceptResult::Failure(ws.m_state);\n \n     // Only compute the precomputed transaction data if we need to verify\n     // scripts (ie, other policy checks pass). We perform the inexpensive\n     // checks first and avoid hashing and signature verification unless those\n     // checks pass, to mitigate CPU exhaustion denial-of-service attacks.\n     PrecomputedTransactionData txdata;\n \n-    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult::Failure(ws.m_state);\n \n-    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult::Failure(ws.m_state);\n \n     // Tx was accepted, but not added\n     if (args.m_test_accept) {\n-        return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+        return MempoolAcceptResult::Success(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n     }\n \n-    if (!Finalize(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!Finalize(args, ws)) return MempoolAcceptResult::Failure(ws.m_state);\n \n     GetMainSignals().TransactionAddedToMempool(ptx, m_pool.GetAndIncrementSequence());\n \n-    return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+    return MempoolAcceptResult::Success(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+}\n+\n+PackageMempoolAcceptResult MemPoolAccept::AcceptMultipleTransactions(const std::vector<CTransactionRef>& txns, ATMPArgs& args)\n+{\n+    AssertLockHeld(cs_main);\n+\n+    PackageValidationState package_state;\n+    const unsigned int package_count = txns.size();\n+\n+    // These context-free package limits can be checked before taking the mempool lock.\n+    if (package_count > MAX_PACKAGE_COUNT) {\n+        package_state.Invalid(PackageValidationResult::PCKG_POLICY, \"too-many-transactions\");\n+        return PackageMempoolAcceptResult(package_state, {});\n+    }\n+\n+    const int64_t total_size = std::accumulate(txns.cbegin(), txns.cend(), 0,\n+                               [](int64_t sum, const auto& tx) { return sum + GetVirtualTransactionSize(*tx); });\n+    if (total_size > MAX_PACKAGE_SIZE * 1000) {\n+        package_state.Invalid(PackageValidationResult::PCKG_POLICY, \"too-large\");\n+        return PackageMempoolAcceptResult(package_state, {});\n+    }\n+\n+    std::vector<Workspace> workspaces{};\n+    workspaces.reserve(package_count);\n+\n+    // Require the package to be sorted in order of dependency, i.e. parents appear before children.\n+    // An unsorted package will fail anyway on missing-inputs, but it's better to quit earlier and\n+    // fail on something less ambiguous (missing-inputs could also be an orphan or trying to\n+    // spend nonexistent coins).\n+    for (const auto& tx : txns) {\n+        Workspace workspace(tx);\n+        for (const auto& input : tx->vin) {\n+            if (std::find_if(workspaces.begin(), workspaces.end(),\n+                             [&, txid = input.prevout.hash](const auto& preceding_ws)\n+                             { return preceding_ws.m_ptx->GetHash() == txid; }) == workspaces.end() &&\n+                std::find_if(txns.begin(), txns.end(),\n+                             [&, txid = input.prevout.hash](const auto& tx)\n+                             { return tx->GetHash() == txid; }) != txns.end()) {\n+                // If we don't find the parent in workspaces but we do find it in txns,\n+                // then it must be a subsequent transaction in the package.\n+                package_state.Invalid(PackageValidationResult::PCKG_POLICY, \"package-not-sorted\");\n+                return PackageMempoolAcceptResult(package_state, {});\n+            }\n+        }\n+        workspaces.emplace_back(std::move(workspace));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613692663",
      "id" : 613692663,
      "in_reply_to_id" : 613691916,
      "line" : 1247,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMzY5MjY2Mw==",
      "original_commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "original_line" : 1247,
      "original_position" : 283,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 283,
      "pull_request_review_id" : 636196759,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-15T01:18:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613692663",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613693573"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613693573"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think this is intended and was out of scope of this PR -- this is just setup for later expanding what can be accepted",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-04-15T01:20:14Z",
      "diff_hunk" : "@@ -1060,28 +1176,93 @@ MempoolAcceptResult MemPoolAccept::AcceptSingleTransaction(const CTransactionRef\n \n     Workspace ws(ptx);\n \n-    if (!PreChecks(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!PreChecks(args, ws)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\n \n     // Only compute the precomputed transaction data if we need to verify\n     // scripts (ie, other policy checks pass). We perform the inexpensive\n     // checks first and avoid hashing and signature verification unless those\n     // checks pass, to mitigate CPU exhaustion denial-of-service attacks.\n     PrecomputedTransactionData txdata;\n \n-    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\n \n-    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\n \n     // Tx was accepted, but not added\n     if (args.m_test_accept) {\n-        return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+        return MempoolAcceptResult(*ws.m_ptx, std::move(ws.m_replaced_transactions), ws.m_base_fees);\n     }\n \n-    if (!Finalize(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!Finalize(args, ws)) return MempoolAcceptResult(*ws.m_ptx, ws.m_state);\n \n     GetMainSignals().TransactionAddedToMempool(ptx, m_pool.GetAndIncrementSequence());\n \n-    return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+    return MempoolAcceptResult(*ws.m_ptx, std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+}\n+\n+std::vector<MempoolAcceptResult> MemPoolAccept::AcceptMultipleTransactions(std::vector<CTransactionRef>& txns, ATMPArgs& args)\n+{\n+    AssertLockHeld(cs_main);\n+    std::vector<Workspace> workspaces{};\n+    const int package_size = txns.size();\n+    workspaces.reserve(package_size);\n+    std::transform(txns.begin(), txns.end(), std::back_inserter(workspaces), [](CTransactionRef& tx) {\n+        return Workspace(tx);\n+    });\n+    std::vector<MempoolAcceptResult> results;\n+    results.reserve(package_size);\n+\n+    LOCK(m_pool.cs);\n+    // Do all PreChecks first and fail fast to avoid running expensive script checks when unnecessary.\n+    for (Workspace& ws : workspaces) {\n+        if (!PreChecks(args, ws)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613693573",
      "id" : 613693573,
      "in_reply_to_id" : 594478671,
      "line" : 1255,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMzY5MzU3Mw==",
      "original_commit_id" : "06f8fce092edf62f5bbabc5de41b2b499046b965",
      "original_line" : 1255,
      "original_position" : 235,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 291,
      "pull_request_review_id" : 636197451,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-15T01:20:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613693573",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613695175"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613695175"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "separately -- is it true that PreChecks is not entirely stateless? On edge condition, 2 separate ATMPs could have different minfees & therefore this package code is a little different than separate submissions.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-04-15T01:26:13Z",
      "diff_hunk" : "@@ -1061,28 +1178,131 @@ MempoolAcceptResult MemPoolAccept::AcceptSingleTransaction(const CTransactionRef\n \n     Workspace ws(ptx);\n \n-    if (!PreChecks(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!PreChecks(args, ws)) return MempoolAcceptResult::Failure(ws.m_state);\n \n     // Only compute the precomputed transaction data if we need to verify\n     // scripts (ie, other policy checks pass). We perform the inexpensive\n     // checks first and avoid hashing and signature verification unless those\n     // checks pass, to mitigate CPU exhaustion denial-of-service attacks.\n     PrecomputedTransactionData txdata;\n \n-    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult::Failure(ws.m_state);\n \n-    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult::Failure(ws.m_state);\n \n     // Tx was accepted, but not added\n     if (args.m_test_accept) {\n-        return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+        return MempoolAcceptResult::Success(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n     }\n \n-    if (!Finalize(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!Finalize(args, ws)) return MempoolAcceptResult::Failure(ws.m_state);\n \n     GetMainSignals().TransactionAddedToMempool(ptx, m_pool.GetAndIncrementSequence());\n \n-    return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+    return MempoolAcceptResult::Success(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+}\n+\n+PackageMempoolAcceptResult MemPoolAccept::AcceptMultipleTransactions(const std::vector<CTransactionRef>& txns, ATMPArgs& args)\n+{\n+    AssertLockHeld(cs_main);\n+\n+    PackageValidationState package_state;\n+    const unsigned int package_count = txns.size();\n+\n+    // These context-free package limits can be checked before taking the mempool lock.\n+    if (package_count > MAX_PACKAGE_COUNT) {\n+        package_state.Invalid(PackageValidationResult::PCKG_POLICY, \"too-many-transactions\");\n+        return PackageMempoolAcceptResult(package_state, {});\n+    }\n+\n+    const int64_t total_size = std::accumulate(txns.cbegin(), txns.cend(), 0,\n+                               [](int64_t sum, const auto& tx) { return sum + GetVirtualTransactionSize(*tx); });\n+    if (total_size > MAX_PACKAGE_SIZE * 1000) {\n+        package_state.Invalid(PackageValidationResult::PCKG_POLICY, \"too-large\");\n+        return PackageMempoolAcceptResult(package_state, {});\n+    }\n+\n+    std::vector<Workspace> workspaces{};\n+    workspaces.reserve(package_count);\n+\n+    // Require the package to be sorted in order of dependency, i.e. parents appear before children.\n+    // An unsorted package will fail anyway on missing-inputs, but it's better to quit earlier and\n+    // fail on something less ambiguous (missing-inputs could also be an orphan or trying to\n+    // spend nonexistent coins).\n+    for (const auto& tx : txns) {\n+        Workspace workspace(tx);\n+        for (const auto& input : tx->vin) {\n+            if (std::find_if(workspaces.begin(), workspaces.end(),\n+                             [&, txid = input.prevout.hash](const auto& preceding_ws)\n+                             { return preceding_ws.m_ptx->GetHash() == txid; }) == workspaces.end() &&\n+                std::find_if(txns.begin(), txns.end(),\n+                             [&, txid = input.prevout.hash](const auto& tx)\n+                             { return tx->GetHash() == txid; }) != txns.end()) {\n+                // If we don't find the parent in workspaces but we do find it in txns,\n+                // then it must be a subsequent transaction in the package.\n+                package_state.Invalid(PackageValidationResult::PCKG_POLICY, \"package-not-sorted\");\n+                return PackageMempoolAcceptResult(package_state, {});\n+            }\n+        }\n+        workspaces.emplace_back(std::move(workspace));\n+    }\n+\n+    LOCK(m_pool.cs);\n+\n+    std::map<const uint256, const MempoolAcceptResult> results;\n+    // Do all PreChecks first and fail fast to avoid running expensive script checks when unnecessary.\n+    for (Workspace& ws : workspaces) {\n+        if (!PreChecks(args, ws)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613695175",
      "id" : 613695175,
      "line" : 1255,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMzY5NTE3NQ==",
      "original_commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "original_line" : 1255,
      "original_position" : 291,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 291,
      "pull_request_review_id" : 636199424,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-15T01:26:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613695175",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613697232"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613697232"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "maybe add a forceaspackage param bool? Would be good to be able to test the single tx as a package code path to test your PR, and a user would want to the same behavior call independent.\r\n\r\nEventually I think all relay should be going through the package path so I like to minimize special casing :)",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-04-15T01:33:06Z",
      "diff_hunk" : "@@ -926,59 +931,73 @@ static RPCHelpMan testmempoolaccept()\n         UniValueType(), // VNUM or VSTR, checked inside AmountFromValue()\n     });\n \n-    if (request.params[0].get_array().size() != 1) {\n-        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Array must contain exactly one raw transaction for now\");\n+    if (request.params[0].get_array().size() > MAX_PACKAGE_COUNT) {\n+        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Array cannot contain more than \" + ToString(MAX_PACKAGE_COUNT) + \" transactions.\");\n     }\n \n-    CMutableTransaction mtx;\n-    if (!DecodeHexTx(mtx, request.params[0].get_array()[0].get_str())) {\n-        throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed. Make sure the tx has at least one input.\");\n-    }\n-    CTransactionRef tx(MakeTransactionRef(std::move(mtx)));\n-\n+    const UniValue raw_transactions = request.params[0].get_array();\n     const CFeeRate max_raw_tx_fee_rate = request.params[1].isNull() ?\n                                              DEFAULT_MAX_RAW_TX_FEE_RATE :\n                                              CFeeRate(AmountFromValue(request.params[1]));\n \n-    CTxMemPool& mempool = EnsureMemPool(request.context);\n-    int64_t virtual_size = GetVirtualTransactionSize(*tx);\n-    CAmount max_raw_tx_fee = max_raw_tx_fee_rate.GetFee(virtual_size);\n+    std::vector<CTransactionRef> txns;\n+    for (const auto& rawtx : raw_transactions.getValues()) {\n+        CMutableTransaction mtx;\n+        if (!DecodeHexTx(mtx, rawtx.get_str())) {\n+            throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed. Make sure the tx has at least one input.\");\n+        }\n+        txns.emplace_back(MakeTransactionRef(std::move(mtx)));\n+    }\n \n-    UniValue result(UniValue::VARR);\n-    UniValue result_0(UniValue::VOBJ);\n-    result_0.pushKV(\"txid\", tx->GetHash().GetHex());\n-    result_0.pushKV(\"wtxid\", tx->GetWitnessHash().GetHex());\n-\n-    const MempoolAcceptResult accept_result = WITH_LOCK(cs_main, return AcceptToMemoryPool(::ChainstateActive(), mempool, std::move(tx),\n-                                                  false /* bypass_limits */, /* test_accept */ true));\n-\n-    // Only return the fee and vsize if the transaction would pass ATMP.\n-    // These can be used to calculate the feerate.\n-    if (accept_result.m_result_type == MempoolAcceptResult::ResultType::VALID) {\n-        const CAmount fee = accept_result.m_base_fees.value();\n-        // Check that fee does not exceed maximum fee\n-        if (max_raw_tx_fee && fee > max_raw_tx_fee) {\n-            result_0.pushKV(\"allowed\", false);\n-            result_0.pushKV(\"reject-reason\", \"max-fee-exceeded\");\n-        } else {\n-            result_0.pushKV(\"allowed\", true);\n-            result_0.pushKV(\"vsize\", virtual_size);\n-            UniValue fees(UniValue::VOBJ);\n-            fees.pushKV(\"base\", ValueFromAmount(fee));\n-            result_0.pushKV(\"fees\", fees);\n+    CTxMemPool& mempool = EnsureMemPool(request.context);\n+    CChainState& chainstate = EnsureChainman(request.context).ActiveChainstate();\n+    const PackageMempoolAcceptResult validation_result = txns.size() > 1\n+        ? WITH_LOCK(cs_main, return ProcessNewPackage(chainstate, mempool, txns, /* test_accept */ true))\n+        : WITH_LOCK(cs_main, return PackageMempoolAcceptResult(txns[0]->GetHash(),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r613697232",
      "id" : 613697232,
      "in_reply_to_id" : 613603255,
      "line" : 956,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMzY5NzIzMg==",
      "original_commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "original_line" : 956,
      "original_position" : 96,
      "original_start_line" : null,
      "path" : "src/rpc/rawtransaction.cpp",
      "position" : 96,
      "pull_request_review_id" : 636201798,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-15T01:33:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613697232",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r614060709"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/614060709"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`PreChecks` is not stateless, no. Maybe you're thinking of `CheckTransaction`?\r\nThere's no way to make separate mempool accepts identical unless we hold cs_main the entire time - you can just as well have different results from the inputs getting spent in between calls.",
      "commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "created_at" : "2021-04-15T13:17:42Z",
      "diff_hunk" : "@@ -1061,28 +1178,131 @@ MempoolAcceptResult MemPoolAccept::AcceptSingleTransaction(const CTransactionRef\n \n     Workspace ws(ptx);\n \n-    if (!PreChecks(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!PreChecks(args, ws)) return MempoolAcceptResult::Failure(ws.m_state);\n \n     // Only compute the precomputed transaction data if we need to verify\n     // scripts (ie, other policy checks pass). We perform the inexpensive\n     // checks first and avoid hashing and signature verification unless those\n     // checks pass, to mitigate CPU exhaustion denial-of-service attacks.\n     PrecomputedTransactionData txdata;\n \n-    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!PolicyScriptChecks(args, ws, txdata)) return MempoolAcceptResult::Failure(ws.m_state);\n \n-    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult(ws.m_state);\n+    if (!ConsensusScriptChecks(args, ws, txdata)) return MempoolAcceptResult::Failure(ws.m_state);\n \n     // Tx was accepted, but not added\n     if (args.m_test_accept) {\n-        return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+        return MempoolAcceptResult::Success(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n     }\n \n-    if (!Finalize(args, ws)) return MempoolAcceptResult(ws.m_state);\n+    if (!Finalize(args, ws)) return MempoolAcceptResult::Failure(ws.m_state);\n \n     GetMainSignals().TransactionAddedToMempool(ptx, m_pool.GetAndIncrementSequence());\n \n-    return MempoolAcceptResult(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+    return MempoolAcceptResult::Success(std::move(ws.m_replaced_transactions), ws.m_base_fees);\n+}\n+\n+PackageMempoolAcceptResult MemPoolAccept::AcceptMultipleTransactions(const std::vector<CTransactionRef>& txns, ATMPArgs& args)\n+{\n+    AssertLockHeld(cs_main);\n+\n+    PackageValidationState package_state;\n+    const unsigned int package_count = txns.size();\n+\n+    // These context-free package limits can be checked before taking the mempool lock.\n+    if (package_count > MAX_PACKAGE_COUNT) {\n+        package_state.Invalid(PackageValidationResult::PCKG_POLICY, \"too-many-transactions\");\n+        return PackageMempoolAcceptResult(package_state, {});\n+    }\n+\n+    const int64_t total_size = std::accumulate(txns.cbegin(), txns.cend(), 0,\n+                               [](int64_t sum, const auto& tx) { return sum + GetVirtualTransactionSize(*tx); });\n+    if (total_size > MAX_PACKAGE_SIZE * 1000) {\n+        package_state.Invalid(PackageValidationResult::PCKG_POLICY, \"too-large\");\n+        return PackageMempoolAcceptResult(package_state, {});\n+    }\n+\n+    std::vector<Workspace> workspaces{};\n+    workspaces.reserve(package_count);\n+\n+    // Require the package to be sorted in order of dependency, i.e. parents appear before children.\n+    // An unsorted package will fail anyway on missing-inputs, but it's better to quit earlier and\n+    // fail on something less ambiguous (missing-inputs could also be an orphan or trying to\n+    // spend nonexistent coins).\n+    for (const auto& tx : txns) {\n+        Workspace workspace(tx);\n+        for (const auto& input : tx->vin) {\n+            if (std::find_if(workspaces.begin(), workspaces.end(),\n+                             [&, txid = input.prevout.hash](const auto& preceding_ws)\n+                             { return preceding_ws.m_ptx->GetHash() == txid; }) == workspaces.end() &&\n+                std::find_if(txns.begin(), txns.end(),\n+                             [&, txid = input.prevout.hash](const auto& tx)\n+                             { return tx->GetHash() == txid; }) != txns.end()) {\n+                // If we don't find the parent in workspaces but we do find it in txns,\n+                // then it must be a subsequent transaction in the package.\n+                package_state.Invalid(PackageValidationResult::PCKG_POLICY, \"package-not-sorted\");\n+                return PackageMempoolAcceptResult(package_state, {});\n+            }\n+        }\n+        workspaces.emplace_back(std::move(workspace));\n+    }\n+\n+    LOCK(m_pool.cs);\n+\n+    std::map<const uint256, const MempoolAcceptResult> results;\n+    // Do all PreChecks first and fail fast to avoid running expensive script checks when unnecessary.\n+    for (Workspace& ws : workspaces) {\n+        if (!PreChecks(args, ws)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20833#discussion_r614060709",
      "id" : 614060709,
      "in_reply_to_id" : 613695175,
      "line" : 1255,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNDA2MDcwOQ==",
      "original_commit_id" : "cc00a859deef3701f5d9fb8e7076a074b26f7892",
      "original_line" : 1255,
      "original_position" : 291,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 291,
      "pull_request_review_id" : 636674634,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20833",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-15T13:17:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/614060709",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   }
]
