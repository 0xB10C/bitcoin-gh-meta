[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "The problem was discovered by @MarcoFalke.",
      "created_at" : "2021-01-04T16:27:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20849#issuecomment-754075051",
      "id" : 754075051,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20849",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1NDA3NTA1MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-04T16:27:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/754075051",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "tested-only ACK 5fd2cee7fbc38c677d08a1545770156cc061833e did not review the code ð®\r\n\r\n<details><summary>Show signature and timestamp</summary>\r\n\r\nSignature:\r\n\r\n```\r\n-----BEGIN PGP SIGNED MESSAGE-----\r\nHash: SHA512\r\n\r\ntested-only ACK 5fd2cee7fbc38c677d08a1545770156cc061833e did not review the code ð®\r\n-----BEGIN PGP SIGNATURE-----\r\n\r\niQGzBAEBCgAdFiEE+rVPoUahrI9sLGYTzit1aX5ppUgFAlwqrYAACgkQzit1aX5p\r\npUh/Sgv/W9d+TPMjSm+JqcwJBW7n3wmto0PDu+CvGkHSwHJaoLU7toj8W1y6Ohfz\r\nCDKRGq2ZG+VnxSbKRhItSeaWqleHfAJ0Ns1xZNbDudAw7/IrLMsvNd7+/apFgpUT\r\niM1ytrZMRRLqoPdRVgpzkamKMUyPTPzzXzGQoH6xdxSjMuKbJ69DVzg4d0DuAmH+\r\ny+ZP85yi7KDq5YvS25JUaOpZg4m9UnwTHctL1+hMeIWBtxlx3pFohExswbUC28xz\r\nytN4dWFxyQXC/t3i3fY3AiLiHZZ0frxHTd26sL/vqj935MWnH3SsIpIwm57kl1v2\r\nvHR7yakgWEcDF5qEQHa1+wYi1p26BgYQYjlPqYCM4fp+0MBg6lPpggthZkYVKTXI\r\nJg2mxdUl/kuFDA8Xy9u00uQj6BOWJfshBuClQkxf5184qTcMdQ6SwxagpfDGHEjn\r\nJDHbX+djj8+CfR6CVc3P7MWP1UxnuFI8NWiyMI6KrcEH3ESw16LmcrS3KOeLLI4Q\r\n5IVN+71Z\r\n=kXbR\r\n-----END PGP SIGNATURE-----\r\n```\r\n\r\n[Timestamp of file with hash `ffb08779a664f7e34db6952de6f0948d1fb8eeb7089b81525f9ffde67a8ac202  -`](https://opentimestamps.org/info/?004f70656e54696d657374616d7073000050726f6f6600bf89e2e884e892940108ffb08779a664f7e34db6952de6f0948d1fb8eeb7089b81525f9ffde67a8ac202f010ba914ef96fcd58dcf7ef97e69507f30f08fff01001ca557449cdd59ee8a489fa048bb29a08f1045ff343ccf0088c83c2e0c2202b560083dfe30d2ef90c8e232268747470733a2f2f6274632e63616c656e6461722e636174616c6c6178792e636f6dfff01004a917a47de2960e291f72db62a88de908f020750bb0dd61da48daa72731e0113a36703767a6b3fa7aedbd93d981a8f0b83d2008f020552fdc0c24dad87b2a713d4c04937ee0f5bbcd61bb355994634f12a8e8c28cdc08f1045ff343ccf00861a940fef48bc4080083dfe30d2ef90c8e2c2b68747470733a2f2f626f622e6274632e63616c656e6461722e6f70656e74696d657374616d70732e6f7267fff01016190e20a52f4e363ae04d98e1a52d8a08f020cd808e86f44edce43d5e8b4acfb96b5f61594caba830320a4d1be42eb59ebf1708f02022722abb7230b220a5da7037cd78b817045cf688c776916a9e38b955dc9a124608f02050b970d8126c0f5156e36ddb8b6f7d12297ee07c6860729af27d60d4df312ed908f1045ff343ccf0088f329964afa83b3d0083dfe30d2ef90c8e292868747470733a2f2f66696e6e65792e63616c656e6461722e657465726e69747977616c6c2e636f6df010dce13a9487c5c580d62df60b7705cc0d08f020b00c82767aafbe20855a385ea3e94bc9d48475c132a5000324b368a74520fba808f020ce0e21933b7b4cf9b6f557430dc02455a94ae6c0e85cee26ded22d0094a9dad408f1045ff343ccf00850484396068324400083dfe30d2ef90c8e2e2d68747470733a2f2f616c6963652e6274632e63616c656e6461722e6f70656e74696d657374616d70732e6f7267)\r\n\r\n</details>\r\n",
      "created_at" : "2021-01-04T16:35:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20849#issuecomment-754079617",
      "id" : 754079617,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20849",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1NDA3OTYxNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-04T16:35:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/754079617",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "https://github.com/bitcoin/bitcoin/pull/20852 contains a fix for this issue + it also fixes a similar issue in `BanMan`. If it is merged, then this can be closed without merge. They do not conflict in any way. Both can go in.",
      "created_at" : "2021-01-04T17:57:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20849#issuecomment-754122796",
      "id" : 754122796,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20849",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1NDEyMjc5Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-04T17:57:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/754122796",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Any tips how to test this manually? Disconnecting outbound onion peers with `disconnectnode` works for me on both master and this PR and in #20852.",
      "created_at" : "2021-01-05T12:20:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20849#issuecomment-754602325",
      "id" : 754602325,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20849",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1NDYwMjMyNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-05T12:20:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/754602325",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@jonatack yes, the `disconnectnode` RPC uses either `DisconnectNode(std::string)` or `DisconnectNode(NodeId)` and the problem is in `DisconnectNode(CNetAddr)`.\r\n\r\n`bitcoin-cli setban foo.onion add` will do the job.",
      "created_at" : "2021-01-05T16:21:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20849#issuecomment-754740638",
      "id" : 754740638,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20849",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1NDc0MDYzOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-05T16:21:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/754740638",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Ð²Ñ, 5 ÑÐ½Ð². 2021 Ð³. Ð² 19:24, Vasil Dimov <notifications@github.com>:\n\n> @jonatack <https://github.com/jonatack> yes, the disconnectnode RPC uses\n> either DisconnectNode(std::string) or DisconnectNode(NodeId) and the\n> problem is in DisconnectNode(CNetAddr).\n>\n> bitcoin-cli setban foo.onion add will do the job.\n>\n> â\n> You are receiving this because you are subscribed to this thread.\n> Reply to this email directly, view it on GitHub\n> <https://github.com/bitcoin/bitcoin/pull/20849#issuecomment-754740638>,\n> or unsubscribe\n> <https://github.com/notifications/unsubscribe-auth/AK4ZHQKMTWFQ66BD3TC7WTLSYM4J7ANCNFSM4VTHTMFA>\n> .\n>\n-- \nNik\n",
      "created_at" : "2021-01-05T16:26:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20849#issuecomment-754743895",
      "id" : 754743895,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20849",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1NDc0Mzg5NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-05T17:00:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/754743895",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/45716417?v=4",
         "events_url" : "https://api.github.com/users/taurus228/events{/privacy}",
         "followers_url" : "https://api.github.com/users/taurus228/followers",
         "following_url" : "https://api.github.com/users/taurus228/following{/other_user}",
         "gists_url" : "https://api.github.com/users/taurus228/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/taurus228",
         "id" : 45716417,
         "login" : "taurus228",
         "node_id" : "MDQ6VXNlcjQ1NzE2NDE3",
         "organizations_url" : "https://api.github.com/users/taurus228/orgs",
         "received_events_url" : "https://api.github.com/users/taurus228/received_events",
         "repos_url" : "https://api.github.com/users/taurus228/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/taurus228/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/taurus228/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/taurus228"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK 5fd2cee7fbc38c677d08a1545770156cc061833e\r\n\r\nLet's get this merged so the path forward for 0.21 is clear (we can still do #20852, but it's no longer critical then).",
      "created_at" : "2021-01-05T18:06:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20849#issuecomment-754803214",
      "id" : 754803214,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20849",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1NDgwMzIxNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-05T18:06:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/754803214",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Adding logging to the code path and verified that `setban <onion> add` disconnects peers with this patch and fails to do so on master @ 68196a891056f, with both tor v2 and v3 peers.\r\n\r\nLogging added to master and to this patch:\r\n```diff\r\n@@ -2805,6 +2805,7 @@ bool CConnman::DisconnectNode(const CSubNet& subnet)\r\n     LOCK(cs_vNodes);\r\n     for (CNode* pnode : vNodes) {\r\n         if (subnet.Match(pnode->addr)) {\r\n+            LogPrintf(\"Disconnecting %s via subnet peer=%d address=%s network=%s\\n\",\r\n+                      pnode->ConnectionTypeAsString(), pnode->GetId(),\r\n+                      pnode->addr.ToString(), GetNetworkName(pnode->ConnectedThroughNetwork()));\r\n             pnode->fDisconnect = true;\r\n             disconnected = true;\r\n         }\r\n```\r\nLogging also added to this patch:\r\n```diff\r\n@@ -2818,6 +2819,7 @@ bool CConnman::DisconnectNode(const CNetAddr& addr)\r\n     LOCK(cs_vNodes);\r\n     for (CNode* pnode : vNodes) {\r\n         if (addr == pnode->addr) {\r\n+            LogPrintf(\"Disconnecting %s via addr peer=%d address=%s network=%s\\n\",\r\n+                      pnode->ConnectionTypeAsString(), pnode->GetId(),\r\n+                      pnode->addr.ToString(), GetNetworkName(pnode->ConnectedThroughNetwork()));\r\n             pnode->fDisconnect = true;\r\n             disconnected = true;\r\n         }\r\n```\r\n\r\nOn master, disconnection fails and nothing is logged. With this patch, the peer is immediately removed from the -netinfo 4 peers dashboard and the log shows:\r\n```\r\n2021-01-06T11:47:36Z Disconnecting manual via addr peer=5 address=TOR_V3_PEER network=onion\r\n2021-01-06T11:54:30Z Disconnecting manual via addr peer=25 address=TOR_V2_PEER network=onion\r\n2021-01-06T11:54:49Z Disconnecting outbound-full-relay via addr peer=16 address=TOR_V2_PEER:8333 network=onion\r\n```\r\n\r\nUpgrading to tested ACK 5fd2cee7fbc38c677d08a1545770156cc061833e",
      "created_at" : "2021-01-06T12:06:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20849#issuecomment-755261977",
      "id" : 755261977,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20849",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1NTI2MTk3Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-06T12:31:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/755261977",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Appended an extra commit with unit test that fails on `master` and passes on this PR.\r\n\r\nIf it does not get re-ACKs or if it turns out to be problematic I will remove it, restoring the already ACK'ed commit id.",
      "created_at" : "2021-01-06T14:55:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20849#issuecomment-755345783",
      "id" : 755345783,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20849",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1NTM0NTc4Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-06T14:55:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/755345783",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   }
]
