[
   {
      "body" : "These RPCs happen to also wait for wallet processing at this point, but that will change if wallet processing becomes asynchronous.\r\n\r\nACK on this as a stopgap measure to prevent the synchronization issues.\r\n\r\nBut I think there should be a warning in their help to not rely on this behavior \"as the tests do\".\r\n",
      "created_at" : "2016-09-09T05:21:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8680#issuecomment-245822058",
      "id" : 245822058,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8680",
      "updated_at" : "2016-09-09T05:21:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/245822058",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8680#discussion_r78133809"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8680"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/78133809"
         }
      },
      "body" : "nit: `s/waitforblock/waitforblock <blockhash> <timeout>`\r\nI guess most commands help have it like this.",
      "commit_id" : "d6a5dc4a2eaa0d7348804254ca09e75fc3a858ab",
      "created_at" : "2016-09-09T06:24:07Z",
      "diff_hunk" : "@@ -168,6 +180,138 @@ UniValue getbestblockhash(const UniValue& params, bool fHelp)\n     return chainActive.Tip()->GetBlockHash().GetHex();\n }\n \n+void RPCNotifyBlockChange(bool ibd, const CBlockIndex * pindex)\n+{\n+    if(pindex) {\n+        std::lock_guard<std::mutex> lock(cs_blockchange);\n+        latestblock.hash = pindex->GetBlockHash();\n+        latestblock.height = pindex->nHeight;\n+    }\n+\tcond_blockchange.notify_all();\n+}\n+\n+UniValue waitfornewblock(const UniValue& params, bool fHelp)\n+{\n+    if (fHelp || params.size() > 1)\n+        throw runtime_error(\n+            \"waitfornewblock\\n\"\n+            \"\\nWaits for a specific new block and returns useful info about it.\\n\"\n+            \"\\nReturns the current block on timeout or exit.\\n\"\n+            \"\\nArguments:\\n\"\n+            \"1. timeout (milliseconds) (int, optional, default=false)\\n\"\n+            \"\\nResult::\\n\"\n+            \"{                           (json object)\\n\"\n+            \"  \\\"hash\\\" : {       (string) The blockhash\\n\"\n+            \"  \\\"height\\\" : {     (int) Block height\\n\"\n+            \"}\\n\"\n+            \"\\nExamples\\n\"\n+            + HelpExampleCli(\"waitfornewblock\", \"1000\")\n+            + HelpExampleRpc(\"waitfornewblock\", \"1000\")\n+        );\n+    int timeout = 0;\n+    if (params.size() > 0)\n+        timeout = params[0].get_int();\n+\n+    CUpdatedBlock block;\n+    {\n+        std::unique_lock<std::mutex> lock(cs_blockchange);\n+        block = latestblock;\n+        if(timeout)\n+            cond_blockchange.wait_for(lock, std::chrono::milliseconds(timeout), [&block]{return latestblock.height != block.height || latestblock.hash != block.hash || !IsRPCRunning(); });\n+        else\n+            cond_blockchange.wait(lock, [&block]{return latestblock.height != block.height || latestblock.hash != block.hash || !IsRPCRunning(); });\n+        block = latestblock;\n+    }\n+    UniValue ret(UniValue::VOBJ);\n+    ret.push_back(Pair(\"hash\", block.hash.GetHex()));\n+    ret.push_back(Pair(\"height\", block.height));\n+    return ret;\n+}\n+\n+UniValue waitforblock(const UniValue& params, bool fHelp)\n+{\n+    if (fHelp || params.size() < 1 || params.size() > 2)\n+        throw runtime_error(\n+            \"waitforblock\\n\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8680#discussion_r78133809",
      "id" : 78133809,
      "original_commit_id" : "d6a5dc4a2eaa0d7348804254ca09e75fc3a858ab",
      "original_position" : 77,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 77,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8680",
      "updated_at" : "2016-09-09T06:24:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/78133809",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "Concept ACK.\r\nI like this approach. Also, it's a preform of longpoll RPC notifications proposed in https://github.com/bitcoin/bitcoin/pull/7949 which I think are generally useful.",
      "created_at" : "2016-09-09T06:26:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8680#issuecomment-245830060",
      "id" : 245830060,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8680",
      "updated_at" : "2016-09-09T06:26:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/245830060",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   }
]
