[
   {
      "author_association" : "MEMBER",
      "body" : "ACK 23db26fc6263e501312bc015d288f502d40cf0c3 -- this change was entirely authored by Pieter Wuille (i only patched `CheckDuplicateKey` and added a trivial unit test). I reviewed and tested it by rebasing #24148 and #24149 on top of it, checking the runtime of the fuzz targets and adapting the targets creating \"random\" nodes.\r\n\r\nAs a mean of comparison here are the runtime of the `miniscript_string` and `miniscript_script` targets on my machine\r\nwith the corpus from `qa-assets` at commit 1e3c7cd69fc06fda49a5286b98069ee5b0d64edc:\r\n- Before: `Done 1046 runs in 10 second(s)` and `Done 2908 runs in 13 second(s)`\r\n- After: `Done 1046 runs in 0 second(s)` and `Done 2908 runs in 6 second(s)`\r\n\r\nThis also made the two targets from #24149 twice as fast on average.",
      "created_at" : "2022-07-04T13:22:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25540#issuecomment-1173816991",
      "id" : 1173816991,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25540",
      "node_id" : "IC_kwDOABII585F9waf",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1173816991/reactions"
      },
      "updated_at" : "2022-07-04T13:23:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1173816991",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I think we should also have a limit on the maximum number of nodes we want to tolerate when parsing. For instance we would happily parse at this moment a string so long that i can't upload it on 0bin, and run out of memory. This can be the reason for fuzz crashes too.\r\n\r\nEDIT: added a commit for this, and changed the OP.",
      "created_at" : "2022-07-04T17:26:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25540#issuecomment-1174022857",
      "id" : 1174022857,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25540",
      "node_id" : "IC_kwDOABII585F-irJ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1174022857/reactions"
      },
      "updated_at" : "2022-07-05T10:06:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1174022857",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#24149](https://github.com/bitcoin/bitcoin/pull/24149) (Signing support for Miniscript Descriptors by darosior)\n* [#24148](https://github.com/bitcoin/bitcoin/pull/24148) (Miniscript support in Output Descriptors by darosior)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-07-04T17:27:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25540#issuecomment-1174023533",
      "id" : 1174023533,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25540",
      "node_id" : "IC_kwDOABII585F-i1t",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1174023533/reactions"
      },
      "updated_at" : "2022-07-14T20:06:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1174023533",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-07-14T19:42:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25540#issuecomment-1184829985",
      "id" : 1184829985,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25540",
      "node_id" : "IC_kwDOABII585GnxIh",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1184829985/reactions"
      },
      "updated_at" : "2022-07-14T19:42:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1184829985",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased after #24148 was merged.",
      "created_at" : "2022-07-15T08:48:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25540#issuecomment-1185324206",
      "id" : 1185324206,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25540",
      "node_id" : "IC_kwDOABII585Gppyu",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1185324206/reactions"
      },
      "updated_at" : "2022-07-15T08:48:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1185324206",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25540#discussion_r922679146"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25540"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922679146"
         }
      },
      "author_association" : "MEMBER",
      "body" : "IIUC this limit is specific to Miniscript inside P2WSH. That's the case now for our descriptor implementation. Maybe use `MAX_SCRIPT_SIZE` (10,000) instead? \r\n\r\nSee also Resource Limitations under https://bitcoin.sipa.be/miniscript/",
      "commit_id" : "088e5b0b9317bd1d7c9755fb839b7326d99bc910",
      "created_at" : "2022-07-16T13:15:08Z",
      "diff_hunk" : "@@ -1030,29 +1030,39 @@ inline NodeRef<Key> Parse(Span<const char> in, const Ctx& ctx)\n {\n     using namespace spanparsing;\n \n+    // Account for the number of fragments we started to parse. Any fragment is at least one byte\n+    // long. If we started to parse more than 3600 of them, don't bother continuing: the resulting\n+    // Miniscript would be invalid.\n+    size_t opened_frags = 0;\n+\n     // The two integers are used to hold state for thresh()\n     std::vector<std::tuple<ParseContext, int64_t, int64_t>> to_parse;\n     std::vector<NodeRef<Key>> constructed;\n \n     to_parse.emplace_back(ParseContext::WRAPPED_EXPR, -1, -1);\n \n     while (!to_parse.empty()) {\n+        if (opened_frags > MAX_STANDARD_P2WSH_SCRIPT_SIZE) return {};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25540#discussion_r922679146",
      "id" : 922679146,
      "line" : 1045,
      "node_id" : "PRRC_kwDOABII5842_vdq",
      "original_commit_id" : "088e5b0b9317bd1d7c9755fb839b7326d99bc910",
      "original_line" : 1045,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/script/miniscript.h",
      "position" : 16,
      "pull_request_review_id" : 1040993087,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25540",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922679146/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-16T13:15:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922679146",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25540#discussion_r922679472"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25540"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922679472"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm assuming this is useful because it allows performing other checks (like size limit) _before_ checking for duplicates? Is so, maybe say that in the comment.",
      "commit_id" : "088e5b0b9317bd1d7c9755fb839b7326d99bc910",
      "created_at" : "2022-07-16T13:18:25Z",
      "diff_hunk" : "@@ -301,8 +303,13 @@ struct Node {\n     const Type typ;\n     //! Cached script length (computed by CalcScriptLen).\n     const size_t scriptlen;\n-    //! Whether a public key appears more than once in this node.\n-    const bool duplicate_key;\n+    //! Whether a public key appears more than once in this node. This value is initialized\n+    //! by all constructors except the NoDupCheck ones. The NoDupCheck ones skip the\n+    //! computation, requiring it to be done manually by invoking DuplicateKeyCheck().\n+    //! DuplicateKeyCheck(), or a non-NoDupCheck constructor, will compute has_duplicate_keys\n+    //! for all subnodes as well.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25540#discussion_r922679472",
      "id" : 922679472,
      "line" : 310,
      "node_id" : "PRRC_kwDOABII5842_viw",
      "original_commit_id" : "6705b9cb02a9b8340440dfdf460eb5b44bcf3d9f",
      "original_line" : 310,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/script/miniscript.h",
      "position" : 19,
      "pull_request_review_id" : 1040993300,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25540",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922679472/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-16T13:18:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922679472",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   }
]
