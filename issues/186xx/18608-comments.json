[
   {
      "author_association" : "MEMBER",
      "body" : "Concept NACK. This completely breaks down the layering/abstraction here... Simply adding new metadata shouldn't require touching the db layer, and the db layer shouldn't have visibility into stuff like `CTxDestination`",
      "created_at" : "2020-04-12T20:02:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18608#issuecomment-612668486",
      "id" : 612668486,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18608",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxMjY2ODQ4Ng==",
      "updated_at" : "2020-04-12T20:02:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/612668486",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Simply adding new metadata shouldn't require touching the db layer\r\n\r\nAdding new metadata should touch the walletdb layer because it changes the database format. The reason why #13756 introduced a bug is no one understood how it was changing the database format. I try to look at format changes very closely and I didn't pay any attention at all to that PR because it wasn't modifying walletdb. (Implementation of #13756 would also have been smaller and simpler if it was adding a new walletdb key, in addition to avoiding the bug.)\r\n\r\n> the db layer shouldn't have visibility into stuff like `CTxDestination`\r\n\r\nWhere's this coming from? I could pretty easily move the EncodeDestination/DecodeDestination calls out of walletdb, but it's already accepting and returning CKeyMetadata, CPubKey, CKeyMetadata, CMasterKey, CWalletTx values so CTxDestination hardly seems like a bridge too far.\r\n\r\n> Concept NACK. This completely breaks down the layering/abstraction here... \r\n\r\nLet me know specifically what's broken. This PR gets rid of complexity and code and should make it safer and easier to make changes extending the database format in the future.",
      "created_at" : "2020-04-12T21:12:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18608#issuecomment-612676590",
      "id" : 612676590,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18608",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxMjY3NjU5MA==",
      "updated_at" : "2020-04-12T21:12:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/612676590",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #18699 (wallet: Avoid translating RPC errors by MarcoFalke)\n* #18655 (gui: Add bumpFeePSBT action instead of changing normal bumpfee behavior by achow101)\n* #18432 (util: Make our stringstream usage locale independent by practicalswift)\n* #16549 ([WIP] UI external signer support (e.g. hardware wallet) by Sjors)\n* #16546 ([WIP] External signer support - Wallet Box edition by Sjors)\n* #16528 (Native Descriptor Wallets using DescriptorScriptPubKeyMan by achow101)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-04-12T22:08:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18608#issuecomment-612683473",
      "id" : 612683473,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18608",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxMjY4MzQ3Mw==",
      "updated_at" : "2020-04-24T13:14:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/612683473",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18608#discussion_r407273795"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18608"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407273795"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Should `#include <interfaces/wallet.h>`.",
      "commit_id" : "02c9d2c78d8c361f247b33f4f09d0277ee8565c6",
      "created_at" : "2020-04-13T00:46:32Z",
      "diff_hunk" : "@@ -141,7 +142,7 @@ bool RecentRequestsTableModel::removeRows(int row, int count, const QModelIndex\n         for (int i = 0; i < count; ++i)\n         {\n             const RecentRequestEntry* rec = &list[row+i];\n-            if (!walletModel->saveReceiveRequest(rec->recipient.address.toStdString(), rec->id, \"\"))\n+            if (!walletModel->wallet().saveReceiveRequest(DecodeDestination(rec->recipient.address.toStdString()), ToString(rec->id), \"\"))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18608#discussion_r407273795",
      "id" : 407273795,
      "line" : 145,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI3Mzc5NQ==",
      "original_commit_id" : "02c9d2c78d8c361f247b33f4f09d0277ee8565c6",
      "original_line" : 145,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/qt/recentrequeststablemodel.cpp",
      "position" : 28,
      "pull_request_review_id" : 391910274,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18608",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-13T00:46:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407273795",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This approach makes it easy to remove circular dependency recentrequeststablemodel -> walletmodel -> recentrequeststablemodel, see 452ecd7c6048e2799d8ba0dedf6e41843e397614 (https://github.com/promag/bitcoin/tree/2020-04-review-18608).",
      "created_at" : "2020-04-13T00:59:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18608#issuecomment-612703456",
      "id" : 612703456,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18608",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxMjcwMzQ1Ng==",
      "updated_at" : "2020-04-13T00:59:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/612703456",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Adding new metadata should touch the walletdb layer because it changes the database format.\r\n\r\nNot usually, no.\r\n\r\nAnd do we really want db-level wrapper functions for every single piece of metadata?? That's exactly the kind of thing destdata was supposed to help avoid...\r\n\r\n>The reason why #13756 introduced a bug is no one understood how it was changing the database format. I try to look at format changes very closely and I didn't pay any attention at all to that PR because it wasn't modifying walletdb. (Implementation of #13756 would also have been smaller and simpler if it was adding a new walletdb key, in addition to avoiding the bug.)\r\n\r\nThe bug was completely unrelated to the database format. Even if the wallet was left in RAM, and never written to a database (not possible with our code, just hypothetical), the bug would have remained...\r\nAnd simply using a new database key would not have fixed it either...\r\n",
      "created_at" : "2020-04-13T03:45:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18608#issuecomment-612736594",
      "id" : 612736594,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18608",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxMjczNjU5NA==",
      "updated_at" : "2020-04-13T03:45:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/612736594",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> > Adding new metadata should touch the walletdb layer because it changes the database format.\r\n\r\n> Not usually, no.\r\n\r\nThis discussion is too handwavy and general to be productive, but if you believe the PR creates problems here, you should be able to provide examples of database format changes that _should_ bypass walletdb and that this PR will make more difficult.\r\n\r\n> And do we really want db-level wrapper functions for every single piece of metadata?? That's exactly the kind of thing destdata was supposed to help avoid...\r\n\r\nThere are various extension points in the wallet for metadata, and this PR doesn't remove them. This PR removes the `CAddressBookData::destdata` extension point because it was badly implemented and misused, already caused a bug, and is a loaded gun waiting to cause more bugs. Your PR #18550 removes the loaded gun by complicating the destdata implementation. But I objected to #18550 because of other changes it bundles, and the complexity it adds turns out not to be necessary here because we can just get rid of the destdata field while simplifying code and not changing behavior.\r\n\r\n> > The reason why #13756 introduced a bug is no one understood how it was changing the database format. I try to look at format changes very closely and I didn't pay any attention at all to that PR because it wasn't modifying walletdb. (Implementation of #13756 would also have been smaller and simpler if it was adding a new walletdb key, in addition to avoiding the bug.)\r\n\r\n> The bug was completely unrelated to the database format. Even if the wallet was left in RAM, and never written to a database (not possible with our code, just hypothetical), the bug would have remained...\r\n\r\nI'd like to interpret this charitably since it is vague and talking about a hypothetical alternate implementation of #13756, but I think this is basically nonsense. If `CAddressBookData::destdata` field didn't exist, #13756 wouldn't have store used data in `CAddressBookData`. It would have added something like `(\"useddata\" << EncodeDestionation(dest))` rows and a `std::set<CTxDestination> m_used_dests` `CWallet` member, avoiding the bug and requiring less code to implement.\r\n\r\n> And simply using a new database key would not have fixed it either...\r\n\r\nNot only would using a non-DESTDATA database key have been _sufficient_ to fix it in the most likely scenario (described above) for the 0.19 release, but using a non-DESTDATA key would have been _necessary_ to fix it for all pre-0.19 releases, because they treat addresses with DESTDATA rows as non-change.\r\n\r\nReally, Luke, DESTDATA is garbage. This PR isolates it to the lowest layer of walletdb, reducing complexity in upper layers and preventing them from misusing it again.\r\n\r\nIf you want to add new metadata fields, even new extensible metadata fields, nothing in the PR prevents it or makes it more difficult. I know you're claiming otherwise, but it's not true and you haven't provided plausible examples or specifics to back up your assertions. I promise this PR isn't trying to rain on your metadata parade.",
      "created_at" : "2020-04-13T05:13:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18608#issuecomment-612753612",
      "id" : 612753612,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18608",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxMjc1MzYxMg==",
      "updated_at" : "2020-04-13T05:13:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/612753612",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-04-27T00:34:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18608#issuecomment-619650646",
      "id" : 619650646,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18608",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxOTY1MDY0Ng==",
      "updated_at" : "2020-04-27T00:34:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/619650646",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   }
]
