[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18685#discussion_r410270513"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18685"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/410270513"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    PerBlockConnectTrace(CBlockIndex* index, const std::shared_ptr<const CBlock>& block) : pindex(index), pblock(block) {}\r\n```\r\n\r\nstyle nit to avoid shared_ptr increment/decrement",
      "commit_id" : "a9f84cc3d05f1807bb37ce8d1fdb9ba5ff491e64",
      "created_at" : "2020-04-17T14:43:45Z",
      "diff_hunk" : "@@ -2512,45 +2512,20 @@ static int64_t nTimeFlush = 0;\n static int64_t nTimeChainState = 0;\n static int64_t nTimePostConnect = 0;\n \n+//! A single block and block index pointer.\n struct PerBlockConnectTrace {\n     CBlockIndex* pindex = nullptr;\n     std::shared_ptr<const CBlock> pblock;\n-    PerBlockConnectTrace() {}\n+    PerBlockConnectTrace(CBlockIndex* index, std::shared_ptr<const CBlock> block) : pindex(index), pblock(block) {}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18685#discussion_r410270513",
      "id" : 410270513,
      "line" : 2519,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI3MDUxMw==",
      "original_commit_id" : "a9f84cc3d05f1807bb37ce8d1fdb9ba5ff491e64",
      "original_line" : 2519,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 9,
      "pull_request_review_id" : 395517042,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18685",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-17T14:47:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/410270513",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18685#discussion_r410271078"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18685"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/410271078"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why is this needed?",
      "commit_id" : "a9f84cc3d05f1807bb37ce8d1fdb9ba5ff491e64",
      "created_at" : "2020-04-17T14:44:40Z",
      "diff_hunk" : "@@ -2512,45 +2512,20 @@ static int64_t nTimeFlush = 0;\n static int64_t nTimeChainState = 0;\n static int64_t nTimePostConnect = 0;\n \n+//! A single block and block index pointer.\n struct PerBlockConnectTrace {\n     CBlockIndex* pindex = nullptr;\n     std::shared_ptr<const CBlock> pblock;\n-    PerBlockConnectTrace() {}\n+    PerBlockConnectTrace(CBlockIndex* index, std::shared_ptr<const CBlock> block) : pindex(index), pblock(block) {}\n };\n+\n /**\n- * Used to track blocks whose transactions were applied to the UTXO state as a\n- * part of a single ActivateBestChainStep call.\n- *\n- * This class is single-use, once you call GetBlocksConnected() you have to throw\n- * it away and make a new one.\n+ * Used to track blocks that were connected as part of a single\n+ * ActivateBestChainStep call. The BlockConnected validationinterface signal is\n+ * fired after a single ABCS call for all blocks that were connected in that\n+ * ABCS call.\n  */\n-class ConnectTrace {\n-private:\n-    std::vector<PerBlockConnectTrace> blocksConnected;\n-\n-public:\n-    explicit ConnectTrace() : blocksConnected(1) {}\n-\n-    void BlockConnected(CBlockIndex* pindex, std::shared_ptr<const CBlock> pblock) {\n-        assert(!blocksConnected.back().pindex);\n-        assert(pindex);\n-        assert(pblock);\n-        blocksConnected.back().pindex = pindex;\n-        blocksConnected.back().pblock = std::move(pblock);\n-        blocksConnected.emplace_back();\n-    }\n-\n-    std::vector<PerBlockConnectTrace>& GetBlocksConnected() {\n-        // We always keep one extra block at the end of our list because\n-        // blocks are added after all the conflicted transactions have\n-        // been filled in. Thus, the last entry should always be an empty\n-        // one waiting for the transactions from the next block. We pop\n-        // the last entry here to make sure the list we return is sane.\n-        assert(!blocksConnected.back().pindex);\n-        blocksConnected.pop_back();\n-        return blocksConnected;\n-    }\n-};\n+typedef std::vector<PerBlockConnectTrace> ConnectTrace;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18685#discussion_r410271078",
      "id" : 410271078,
      "line" : 2528,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI3MTA3OA==",
      "original_commit_id" : "a9f84cc3d05f1807bb37ce8d1fdb9ba5ff491e64",
      "original_line" : 2528,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 50,
      "pull_request_review_id" : 395517042,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18685",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-17T14:47:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/410271078",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18685#discussion_r410272193"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18685"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/410272193"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why is this change to auto? `auto` shouldn't be used in consensus code unless there is a reason ",
      "commit_id" : "a9f84cc3d05f1807bb37ce8d1fdb9ba5ff491e64",
      "created_at" : "2020-04-17T14:46:26Z",
      "diff_hunk" : "@@ -2868,7 +2843,7 @@ bool CChainState::ActivateBestChain(BlockValidationState &state, const CChainPar\n                 }\n                 pindexNewTip = m_chain.Tip();\n \n-                for (const PerBlockConnectTrace& trace : connectTrace.GetBlocksConnected()) {\n+                for (auto& trace : connectTrace) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18685#discussion_r410272193",
      "id" : 410272193,
      "line" : 2846,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI3MjE5Mw==",
      "original_commit_id" : "a9f84cc3d05f1807bb37ce8d1fdb9ba5ff491e64",
      "original_line" : 2846,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 68,
      "pull_request_review_id" : 395517042,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18685",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-17T14:47:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/410272193",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18685#discussion_r410272555"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18685"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/410272555"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\nusing ConnectTrace = std::vector<PerBlockConnectTrace>;\r\n```\r\n\r\nstyle nit for C++11",
      "commit_id" : "a9f84cc3d05f1807bb37ce8d1fdb9ba5ff491e64",
      "created_at" : "2020-04-17T14:46:59Z",
      "diff_hunk" : "@@ -409,7 +409,9 @@ enum DisconnectResult\n     DISCONNECT_FAILED   // Something else went wrong.\n };\n \n-class ConnectTrace;\n+// forward declaration for ActivateBestChainStep and ConnectTip\n+struct PerBlockConnectTrace;\n+typedef std::vector<PerBlockConnectTrace> ConnectTrace;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18685#discussion_r410272555",
      "id" : 410272555,
      "line" : 414,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI3MjU1NQ==",
      "original_commit_id" : "a9f84cc3d05f1807bb37ce8d1fdb9ba5ff491e64",
      "original_line" : 414,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 7,
      "pull_request_review_id" : 395517042,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18685",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-17T14:47:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/410272555",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18685#discussion_r410307560"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18685"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/410307560"
         }
      },
      "author_association" : "MEMBER",
      "body" : "\r\n\r\nNote to other reviewers: This comment obviously no longer applies after 312d27b\r\n",
      "commit_id" : "a9f84cc3d05f1807bb37ce8d1fdb9ba5ff491e64",
      "created_at" : "2020-04-17T15:43:17Z",
      "diff_hunk" : "@@ -2512,45 +2512,20 @@ static int64_t nTimeFlush = 0;\n static int64_t nTimeChainState = 0;\n static int64_t nTimePostConnect = 0;\n \n+//! A single block and block index pointer.\n struct PerBlockConnectTrace {\n     CBlockIndex* pindex = nullptr;\n     std::shared_ptr<const CBlock> pblock;\n-    PerBlockConnectTrace() {}\n+    PerBlockConnectTrace(CBlockIndex* index, std::shared_ptr<const CBlock> block) : pindex(index), pblock(block) {}\n };\n+\n /**\n- * Used to track blocks whose transactions were applied to the UTXO state as a\n- * part of a single ActivateBestChainStep call.\n- *\n- * This class is single-use, once you call GetBlocksConnected() you have to throw\n- * it away and make a new one.\n+ * Used to track blocks that were connected as part of a single\n+ * ActivateBestChainStep call. The BlockConnected validationinterface signal is\n+ * fired after a single ABCS call for all blocks that were connected in that\n+ * ABCS call.\n  */\n-class ConnectTrace {\n-private:\n-    std::vector<PerBlockConnectTrace> blocksConnected;\n-\n-public:\n-    explicit ConnectTrace() : blocksConnected(1) {}\n-\n-    void BlockConnected(CBlockIndex* pindex, std::shared_ptr<const CBlock> pblock) {\n-        assert(!blocksConnected.back().pindex);\n-        assert(pindex);\n-        assert(pblock);\n-        blocksConnected.back().pindex = pindex;\n-        blocksConnected.back().pblock = std::move(pblock);\n-        blocksConnected.emplace_back();\n-    }\n-\n-    std::vector<PerBlockConnectTrace>& GetBlocksConnected() {\n-        // We always keep one extra block at the end of our list because\n-        // blocks are added after all the conflicted transactions have\n-        // been filled in. Thus, the last entry should always be an empty\n-        // one waiting for the transactions from the next block. We pop\n-        // the last entry here to make sure the list we return is sane.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18685#discussion_r410307560",
      "id" : 410307560,
      "line" : 2548,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDMwNzU2MA==",
      "original_commit_id" : "a9f84cc3d05f1807bb37ce8d1fdb9ba5ff491e64",
      "original_line" : 2548,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 44,
      "pull_request_review_id" : 395566048,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18685",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-17T15:43:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/410307560",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
