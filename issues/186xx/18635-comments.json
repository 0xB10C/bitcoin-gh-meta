[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18635#discussion_r421218027"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18635"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421218027"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Rather than duplicating the function, you can use a template:\r\n\r\n```c++\r\ntemplate<typename PARENT>\r\nvoid AssertLockHeldInternal(const char* pszName, const char* pszFile, int nLine, AnnotatedMixin<PARENT>* cs)\r\n{ ... }\r\n\r\ntemplate void AssertLockHeldInternal(const char*, const char*, int, Mutex*);\r\ntemplate void AssertLockHeldInternal(const char*, const char*, int, RecursiveMutex*);\r\n```\r\n\r\nThat means changing the header to:\r\n\r\n```c++\r\ntemplate<typename PARENT>\r\nvoid AssertLockHeldInternal(const char* pszName, const char* pszFile, int nLine, AnnotatedMixin<PARENT>* cs) ASSERT_EXCLUSIVE_LOCK(cs);\r\n```\r\n\r\nto match.\r\n\r\nOr alternatively, don't touch sync.cpp file at all, drop the `ASSERT_EXCLUSIVE_LOCK(cs)` from `AssertLockHeldInternal` and change `AssertLockHeld` to:\r\n\r\n```c++\r\ntemplate<typename PARENT>\r\nvoid static inline AssertLockHeldInternalTyped(const char* pszName, const char* pszFile, int nLine, AnnotatedMixin<PARENT>* cs) ASSERT_EXCLUSIVE_LOCK(cs) { AssertLockHeldInternal(pszName, pszFile, nLine, (void*)cs); };\r\n\r\n#define AssertLockHeld(cs) AssertLockHeldInternalTyped(#cs, __FILE__, __LINE__, &cs)\r\n```\r\n\r\n",
      "commit_id" : "b6e44c3fd4c41a89bd9392c720b856a1a67c0e0a",
      "created_at" : "2020-05-07T03:30:00Z",
      "diff_hunk" : "@@ -185,7 +185,16 @@ std::string LocksHeld()\n     return result;\n }\n \n-void AssertLockHeldInternal(const char* pszName, const char* pszFile, int nLine, void* cs)\n+void AssertLockHeldInternal(const char* pszName, const char* pszFile, int nLine, RecursiveMutex* cs)\n+{\n+    for (const std::pair<void*, CLockLocation>& i : g_lockstack)\n+        if (i.first == cs)\n+            return;\n+    tfm::format(std::cerr, \"Assertion failed: lock %s not held in %s:%i; locks held:\\n%s\", pszName, pszFile, nLine, LocksHeld());\n+    abort();\n+}\n+\n+void AssertLockHeldInternal(const char* pszName, const char* pszFile, int nLine, Mutex* cs)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18635#discussion_r421218027",
      "id" : 421218027,
      "line" : 197,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTIxODAyNw==",
      "original_commit_id" : "b6e44c3fd4c41a89bd9392c720b856a1a67c0e0a",
      "original_line" : 197,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/sync.cpp",
      "position" : 14,
      "pull_request_review_id" : 407126753,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18635",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-07T04:37:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421218027",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18635#discussion_r421218377"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18635"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421218377"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "No need to repeat the definitions of `Mutex` and `RecursiveMutex` after you added the definitions above.",
      "commit_id" : "b6e44c3fd4c41a89bd9392c720b856a1a67c0e0a",
      "created_at" : "2020-05-07T03:31:25Z",
      "diff_hunk" : "@@ -110,7 +117,7 @@ class LOCKABLE AnnotatedMixin : public PARENT\n using RecursiveMutex = AnnotatedMixin<std::recursive_mutex>;\n \n /** Wrapped mutex: supports waiting but not recursive locking */\n-typedef AnnotatedMixin<std::mutex> Mutex;\n+using Mutex = AnnotatedMixin<std::mutex>;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18635#discussion_r421218377",
      "id" : 421218377,
      "line" : 120,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTIxODM3Nw==",
      "original_commit_id" : "b6e44c3fd4c41a89bd9392c720b856a1a67c0e0a",
      "original_line" : 120,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/sync.h",
      "position" : 37,
      "pull_request_review_id" : 407126753,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18635",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-07T04:37:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421218377",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ajtowns \r\n> It's not clear to me what the value of adding `-Wthread-safety-attributes` is, but better typing makes sense in general to me.\r\n\r\nFrom the Thread Safety Analysis [docs](https://clang.llvm.org/docs/ThreadSafetyAnalysis.html#warning-flags):\r\n> `-Wthread-safety-attributes`: Sanity checks on attribute syntax.",
      "created_at" : "2020-05-07T07:47:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18635#issuecomment-625090321",
      "id" : 625090321,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18635",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyNTA5MDMyMQ==",
      "updated_at" : "2020-05-07T07:47:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/625090321",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   }
]
