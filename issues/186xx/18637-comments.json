[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #17487 (coins: allow write to disk without cache drop by jamesob)\n* #15606 ([experimental] UTXO snapshots by jamesob)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-04-14T21:10:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#issuecomment-613683149",
      "id" : 613683149,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18637",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxMzY4MzE0OQ==",
      "updated_at" : "2020-04-14T21:10:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/613683149",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r408954497"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/408954497"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This will need to be modified with the change that @MarcoFalke has made in https://github.com/bitcoin/bitcoin/pull/18615.",
      "commit_id" : "03e5fe6ee3cc44f8a2b27de31e3fcd9612f907b5",
      "created_at" : "2020-04-15T15:57:58Z",
      "diff_hunk" : "@@ -0,0 +1,76 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <random.h>\n+#include <uint256.h>\n+#include <consensus/validation.h>\n+#include <sync.h>\n+#include <test/util/setup_common.h>\n+#include <validation.h>\n+\n+#include <vector>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_FIXTURE_TEST_SUITE(validation_chainstate_tests, TestingSetup)\n+\n+//! Test resizing coins-related CChainState caches during runtime.\n+//!\n+BOOST_AUTO_TEST_CASE(validation_chainstate_resize_caches)\n+{\n+    ChainstateManager manager;\n+\n+    //! Create and add a Coin with DynamicMemoryUsage of 80 bytes to the given view.\n+    auto add_coin = [](CCoinsViewCache& coins_view) -> COutPoint {\n+        Coin newcoin;\n+        uint256 txid = InsecureRand256();\n+        COutPoint outp{txid, 0};\n+        newcoin.nHeight = 1;\n+        newcoin.out.nValue = InsecureRand32();\n+        newcoin.out.scriptPubKey.assign((uint32_t)56, 1);\n+        coins_view.AddCoin(outp, std::move(newcoin), false);\n+\n+        return outp;\n+    };\n+\n+    ENTER_CRITICAL_SECTION(cs_main);\n+    CChainState& c1 = manager.InitializeChainstate();\n+    LEAVE_CRITICAL_SECTION(cs_main);\n+    c1.InitCoinsDB(\n+        /* cache_size_bytes */ 1 << 23, /* in_memory */ true, /* should_wipe */ false);\n+    WITH_LOCK(::cs_main, c1.InitCoinsCache(1 << 23));\n+\n+    // Add a coin to the in-memory cache, upsize once, then downsize.\n+    {\n+        LOCK(::cs_main);\n+        auto outpoint = add_coin(c1.CoinsTip());\n+\n+        // Set a meaningless bestblock value in the coinsview cache - otherwise we won't\n+        // flush during ResizecoinsCaches() and will subsequently hit an assertion.\n+        c1.CoinsTip().SetBestBlock(InsecureRand256());\n+\n+        BOOST_CHECK(c1.CoinsTip().HaveCoinInCache(outpoint));\n+\n+        c1.ResizeCoinsCaches(\n+            1 << 24,  // upsizing the coinsview cache\n+            1 << 22  // downsizing the coinsdb cache\n+        );\n+\n+        // View should still have the coin cached, since we haven't destructed the cache on upsize.\n+        BOOST_CHECK(c1.CoinsTip().HaveCoinInCache(outpoint));\n+\n+        c1.ResizeCoinsCaches(\n+            1 << 22,  // downsizing the coinsview cache\n+            1 << 23  // upsizing the coinsdb cache\n+        );\n+\n+        // The view cache should be empty since we had to destruct to downsize.\n+        BOOST_CHECK(!c1.CoinsTip().HaveCoinInCache(outpoint));\n+    }\n+\n+    // Avoid triggering the address sanitizer.\n+    WITH_LOCK(::cs_main, manager.Unload());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r408954497",
      "id" : 408954497,
      "line" : 73,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODk1NDQ5Nw==",
      "original_commit_id" : "03e5fe6ee3cc44f8a2b27de31e3fcd9612f907b5",
      "original_line" : 73,
      "original_position" : 73,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstate_tests.cpp",
      "position" : 73,
      "pull_request_review_id" : 393914341,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-15T15:58:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/408954497",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r409694987"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/409694987"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"coins: add Sync() method to allow flush without cacheCoins drop\" (b2abb396c64e96585a0c38a269372b35cced08bd)\r\n\r\nAssertLockHeld would be one option",
      "commit_id" : "03e5fe6ee3cc44f8a2b27de31e3fcd9612f907b5",
      "created_at" : "2020-04-16T16:36:13Z",
      "diff_hunk" : "@@ -53,35 +53,50 @@ struct CoinEntry {\n \n }\n \n-CCoinsViewDB::CCoinsViewDB(fs::path ldb_path, size_t nCacheSize, bool fMemory, bool fWipe) : db(ldb_path, nCacheSize, fMemory, fWipe, true)\n+CCoinsViewDB::CCoinsViewDB(fs::path ldb_path, size_t nCacheSize, bool fMemory, bool fWipe) :\n+    m_ldb_path(ldb_path),\n+    m_is_memory(fMemory)\n {\n+    db.reset(new CDBWrapper(ldb_path, nCacheSize, fMemory, fWipe, true));\n+}\n+\n+// XXX this should never be called without holding cs_main. Maybe figure out\n+// a better way of articulating this (lock annotations can't be used due to\n+// circular dep. with validation).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r409694987",
      "id" : 409694987,
      "line" : 65,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY5NDk4Nw==",
      "original_commit_id" : "565a4b5c659038bf2e0a24f3d9dca32aef402df6",
      "original_line" : 65,
      "original_position" : 14,
      "original_start_line" : 63,
      "path" : "src/txdb.cpp",
      "position" : 14,
      "pull_request_review_id" : 394808868,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "RIGHT",
      "start_line" : 63,
      "start_side" : "RIGHT",
      "updated_at" : "2020-04-16T17:29:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/409694987",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r409697186"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/409697186"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"coins: add Sync() method to allow flush without cacheCoins drop\" (b2abb396c64e96585a0c38a269372b35cced08bd)\r\n\r\nWould be nice to stick to member initialization and keep empty constructor body `db(MakeUnique<CDBWrapper>(...)))`",
      "commit_id" : "03e5fe6ee3cc44f8a2b27de31e3fcd9612f907b5",
      "created_at" : "2020-04-16T16:39:29Z",
      "diff_hunk" : "@@ -53,35 +53,50 @@ struct CoinEntry {\n \n }\n \n-CCoinsViewDB::CCoinsViewDB(fs::path ldb_path, size_t nCacheSize, bool fMemory, bool fWipe) : db(ldb_path, nCacheSize, fMemory, fWipe, true)\n+CCoinsViewDB::CCoinsViewDB(fs::path ldb_path, size_t nCacheSize, bool fMemory, bool fWipe) :\n+    m_ldb_path(ldb_path),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r409697186",
      "id" : 409697186,
      "line" : 57,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY5NzE4Ng==",
      "original_commit_id" : "565a4b5c659038bf2e0a24f3d9dca32aef402df6",
      "original_line" : 57,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/txdb.cpp",
      "position" : 6,
      "pull_request_review_id" : 394808868,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-16T17:29:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/409697186",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r409699250"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/409699250"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"coins: add Sync() method to allow flush without cacheCoins drop\" (b2abb396c64e96585a0c38a269372b35cced08bd)\r\n\r\nDoesn't really matter but general better to avoid `new` with `MakeUnique`\r\nhttps://isocpp.org/blog/2019/06/quick-q-differences-between-stdmake-unique-and-stdunique-ptr-with-new",
      "commit_id" : "03e5fe6ee3cc44f8a2b27de31e3fcd9612f907b5",
      "created_at" : "2020-04-16T16:42:36Z",
      "diff_hunk" : "@@ -53,35 +53,50 @@ struct CoinEntry {\n \n }\n \n-CCoinsViewDB::CCoinsViewDB(fs::path ldb_path, size_t nCacheSize, bool fMemory, bool fWipe) : db(ldb_path, nCacheSize, fMemory, fWipe, true)\n+CCoinsViewDB::CCoinsViewDB(fs::path ldb_path, size_t nCacheSize, bool fMemory, bool fWipe) :\n+    m_ldb_path(ldb_path),\n+    m_is_memory(fMemory)\n {\n+    db.reset(new CDBWrapper(ldb_path, nCacheSize, fMemory, fWipe, true));\n+}\n+\n+// XXX this should never be called without holding cs_main. Maybe figure out\n+// a better way of articulating this (lock annotations can't be used due to\n+// circular dep. with validation).\n+void CCoinsViewDB::ResizeCache(size_t new_cache_size)\n+{\n+    // Have to do a reset first to get the original `db` state to release its\n+    // filesystem lock.\n+    db.reset();\n+    db.reset(new CDBWrapper(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r409699250",
      "id" : 409699250,
      "line" : 71,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY5OTI1MA==",
      "original_commit_id" : "565a4b5c659038bf2e0a24f3d9dca32aef402df6",
      "original_line" : 71,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/txdb.cpp",
      "position" : 20,
      "pull_request_review_id" : 394808868,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-16T17:29:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/409699250",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r409701315"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/409701315"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"coins: add Sync() method to allow flush without cacheCoins drop\" (b2abb396c64e96585a0c38a269372b35cced08bd)\r\n\r\nSince this commit is already changing the type of `db` and updating every single line where it's referenced, it'd be nice to rename it to `m_db` at the same time",
      "commit_id" : "03e5fe6ee3cc44f8a2b27de31e3fcd9612f907b5",
      "created_at" : "2020-04-16T16:45:45Z",
      "diff_hunk" : "@@ -43,7 +43,9 @@ static const int64_t nMaxCoinsDBCache = 8;\n class CCoinsViewDB final : public CCoinsView\n {\n protected:\n-    CDBWrapper db;\n+    std::unique_ptr<CDBWrapper> db;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r409701315",
      "id" : 409701315,
      "line" : 46,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcwMTMxNQ==",
      "original_commit_id" : "565a4b5c659038bf2e0a24f3d9dca32aef402df6",
      "original_line" : 46,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/txdb.h",
      "position" : 5,
      "pull_request_review_id" : 394808868,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-16T17:29:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/409701315",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r409705135"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/409705135"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"test: add test for CChainState::ResizeCoinsCaches()\" (03e5fe6ee3cc44f8a2b27de31e3fcd9612f907b5)\r\n\r\nNice test!",
      "commit_id" : "03e5fe6ee3cc44f8a2b27de31e3fcd9612f907b5",
      "created_at" : "2020-04-16T16:51:46Z",
      "diff_hunk" : "@@ -0,0 +1,76 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#include <random.h>\n+#include <uint256.h>\n+#include <consensus/validation.h>\n+#include <sync.h>\n+#include <test/util/setup_common.h>\n+#include <validation.h>\n+\n+#include <vector>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+BOOST_FIXTURE_TEST_SUITE(validation_chainstate_tests, TestingSetup)\n+\n+//! Test resizing coins-related CChainState caches during runtime.\n+//!\n+BOOST_AUTO_TEST_CASE(validation_chainstate_resize_caches)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r409705135",
      "id" : 409705135,
      "line" : 20,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcwNTEzNQ==",
      "original_commit_id" : "03e5fe6ee3cc44f8a2b27de31e3fcd9612f907b5",
      "original_line" : 20,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstate_tests.cpp",
      "position" : 20,
      "pull_request_review_id" : 394808868,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-16T17:29:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/409705135",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r409709750"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/409709750"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Add CChainState::ResizeCoinsCaches\" (df0f720cfdcc1ad70d5ef2656039f008b3bc4bba)\r\n\r\nWould be good to pass along false return value to caller in case this fails",
      "commit_id" : "03e5fe6ee3cc44f8a2b27de31e3fcd9612f907b5",
      "created_at" : "2020-04-16T16:59:10Z",
      "diff_hunk" : "@@ -4924,6 +4924,36 @@ std::string CChainState::ToString()\n         tip ? tip->nHeight : -1, tip ? tip->GetBlockHash().ToString() : \"null\");\n }\n \n+void CChainState::ResizeCoinsCaches(size_t coinstip_size, size_t coinsdb_size)\n+{\n+    if (coinstip_size == m_coinstip_cache_size_bytes &&\n+            coinsdb_size == m_coinsdb_cache_size_bytes) {\n+        // Cache sizes are unchanged, no need to continue.\n+        return;\n+    }\n+    int old_coinstip_size = m_coinstip_cache_size_bytes;\n+    m_coinstip_cache_size_bytes = coinstip_size;\n+    m_coinsdb_cache_size_bytes = coinsdb_size;\n+    CoinsDB().ResizeCache(coinsdb_size);\n+\n+    LogPrintf(\"[%s] resized coinsdb cache to %.1f MiB\\n\",\n+        this->ToString(), coinsdb_size * (1.0 / 1024 / 1024));\n+    LogPrintf(\"[%s] resized coinstip cache to %.1f MiB\\n\",\n+        this->ToString(), coinstip_size * (1.0 / 1024 / 1024));\n+\n+    BlockValidationState state;\n+    const CChainParams& chainparams = Params();\n+\n+    if (coinstip_size > old_coinstip_size) {\n+        // Likely no need to flush if cache sizes have grown.\n+        FlushStateToDisk(chainparams, state, FlushStateMode::IF_NEEDED);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r409709750",
      "id" : 409709750,
      "line" : 4949,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcwOTc1MA==",
      "original_commit_id" : "df0f720cfdcc1ad70d5ef2656039f008b3bc4bba",
      "original_line" : 4949,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 64,
      "pull_request_review_id" : 394808868,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-16T17:29:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/409709750",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r409714771"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/409714771"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Add CChainState::ResizeCoinsCaches\" (df0f720cfdcc1ad70d5ef2656039f008b3bc4bba)\r\n\r\nJust confirming but looks like this 1.5MB default cache size was only used by test cases previously, which are now using 8MB or 1KB caches depending on the case.",
      "commit_id" : "03e5fe6ee3cc44f8a2b27de31e3fcd9612f907b5",
      "created_at" : "2020-04-16T17:07:19Z",
      "diff_hunk" : "@@ -116,7 +116,6 @@ bool fPruneMode = false;\n bool fRequireStandard = true;\n bool fCheckBlockIndex = false;\n bool fCheckpointsEnabled = DEFAULT_CHECKPOINTS_ENABLED;\n-size_t nCoinCacheUsage = 5000 * 300;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r409714771",
      "id" : 409714771,
      "line" : 119,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcxNDc3MQ==",
      "original_commit_id" : "df0f720cfdcc1ad70d5ef2656039f008b3bc4bba",
      "original_line" : 119,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 4,
      "pull_request_review_id" : 394808868,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-16T17:29:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/409714771",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r409719460"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/409719460"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Add CChainState::ResizeCoinsCaches\" (df0f720cfdcc1ad70d5ef2656039f008b3bc4bba)\r\n\r\nJust curious, but would it make sense to call FlushStateToDisk before resetting CoinsDB instead of after? Thought would be that maybe live CDBWrapper object has cached state that would make the flush faster, or maybe it could be good to start with a new CDBWrapper after the flush",
      "commit_id" : "03e5fe6ee3cc44f8a2b27de31e3fcd9612f907b5",
      "created_at" : "2020-04-16T17:15:24Z",
      "diff_hunk" : "@@ -4924,6 +4924,36 @@ std::string CChainState::ToString()\n         tip ? tip->nHeight : -1, tip ? tip->GetBlockHash().ToString() : \"null\");\n }\n \n+void CChainState::ResizeCoinsCaches(size_t coinstip_size, size_t coinsdb_size)\n+{\n+    if (coinstip_size == m_coinstip_cache_size_bytes &&\n+            coinsdb_size == m_coinsdb_cache_size_bytes) {\n+        // Cache sizes are unchanged, no need to continue.\n+        return;\n+    }\n+    int old_coinstip_size = m_coinstip_cache_size_bytes;\n+    m_coinstip_cache_size_bytes = coinstip_size;\n+    m_coinsdb_cache_size_bytes = coinsdb_size;\n+    CoinsDB().ResizeCache(coinsdb_size);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r409719460",
      "id" : 409719460,
      "line" : 4937,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcxOTQ2MA==",
      "original_commit_id" : "df0f720cfdcc1ad70d5ef2656039f008b3bc4bba",
      "original_line" : 4937,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 52,
      "pull_request_review_id" : 394808868,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-16T17:29:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/409719460",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r409723518"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/409723518"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"add ChainstateManager::MaybeRebalanceCaches()\" (69514bd9fce0f867256bd08ec9f1b616a3ece573)\r\n\r\nCould probably write a short unit test exercising this (checking m_coins{tip,db}_cache_size_bytes)",
      "commit_id" : "03e5fe6ee3cc44f8a2b27de31e3fcd9612f907b5",
      "created_at" : "2020-04-16T17:22:01Z",
      "diff_hunk" : "@@ -5237,3 +5237,33 @@ void ChainstateManager::Reset()\n     m_active_chainstate = nullptr;\n     m_snapshot_validated = false;\n }\n+\n+void ChainstateManager::MaybeRebalanceCaches()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18637#discussion_r409723518",
      "id" : 409723518,
      "line" : 5241,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTcyMzUxOA==",
      "original_commit_id" : "69514bd9fce0f867256bd08ec9f1b616a3ece573",
      "original_line" : 5241,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 80,
      "pull_request_review_id" : 394808868,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18637",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-16T17:29:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/409723518",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   }
]
