[
   {
      "body" : "Automatic sanity-testing: PASSED, see http://jenkins.bluematt.me/pull-tester/p4873_89d91f6aa74da5e3fb1bbd08ce20ab3b9d593abd/ for binaries and test log.\nThis test script verifies pulls every time they are updated. It, however, dies sometimes and fails to test properly.  If you are waiting on a test, please check timestamps to verify that the test.log is moving at http://jenkins.bluematt.me/pull-tester/current/\nContact BlueMatt on freenode if something looks broken.",
      "created_at" : "2014-09-08T16:04:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4873#issuecomment-54843687",
      "id" : 54843687,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4873",
      "updated_at" : "2014-09-08T16:04:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/54843687",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2110907?v=3",
         "events_url" : "https://api.github.com/users/BitcoinPullTester/events{/privacy}",
         "followers_url" : "https://api.github.com/users/BitcoinPullTester/followers",
         "following_url" : "https://api.github.com/users/BitcoinPullTester/following{/other_user}",
         "gists_url" : "https://api.github.com/users/BitcoinPullTester/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/BitcoinPullTester",
         "id" : 2110907,
         "login" : "BitcoinPullTester",
         "organizations_url" : "https://api.github.com/users/BitcoinPullTester/orgs",
         "received_events_url" : "https://api.github.com/users/BitcoinPullTester/received_events",
         "repos_url" : "https://api.github.com/users/BitcoinPullTester/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/BitcoinPullTester/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/BitcoinPullTester/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/BitcoinPullTester"
      }
   },
   {
      "body" : "Tested ACK.\r\n",
      "created_at" : "2014-09-08T16:36:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4873#issuecomment-54848531",
      "id" : 54848531,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4873",
      "updated_at" : "2014-09-08T16:36:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/54848531",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "body" : "Untested ACK",
      "created_at" : "2014-09-08T21:32:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4873#issuecomment-54890616",
      "id" : 54890616,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4873",
      "updated_at" : "2014-09-08T21:32:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/54890616",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "ACK.\r\n",
      "created_at" : "2014-09-08T23:14:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4873#issuecomment-54901493",
      "id" : 54901493,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4873",
      "updated_at" : "2014-09-08T23:14:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/54901493",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "Bah: did some more testing today with MAX_ORPHAN_TRANSACTIONS = 4 and got a core dump.\r\n\r\nI'm running with this fix; so far so good:\r\n```\r\ndiff --git a/src/main.cpp b/src/main.cpp\r\nindex 2e24eb9..10f9ba9 100644\r\n--- a/src/main.cpp\r\n+++ b/src/main.cpp\r\n@@ -498,6 +498,8 @@ void static EraseOrphanTx(uint256 hash)\r\n     BOOST_FOREACH(const CTxIn& txin, it->second.vin)\r\n     {\r\n         map<uint256, set<uint256> >::iterator itPrev = mapOrphanTransactionsByPrev.find(txin.prevout.hash);\r\n+        if (itPrev == mapOrphanTransactionsByPrev.end())\r\n+            continue;\r\n         itPrev->second.erase(hash);\r\n         if (itPrev->second.empty())\r\n             mapOrphanTransactionsByPrev.erase(itPrev);\r\n```\r\n",
      "created_at" : "2014-09-09T15:47:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4873#issuecomment-54990399",
      "id" : 54990399,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4873",
      "updated_at" : "2014-09-09T15:47:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/54990399",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "body" : "@gavinandresen Ugh, that's not good. That means the orphan pool is inconsistent.",
      "created_at" : "2014-09-09T15:51:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4873#issuecomment-54991041",
      "id" : 54991041,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4873",
      "updated_at" : "2014-09-09T15:51:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/54991041",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Good sanity check to add, but indeed in principle it shouldn't happen.\r\n",
      "created_at" : "2014-09-09T15:53:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4873#issuecomment-54991396",
      "id" : 54991396,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4873",
      "updated_at" : "2014-09-09T15:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/54991396",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "If we don't understand why the orphan pool is getting inconsistent, I think we should revert instead of patching it up (an assert would be fine, though).",
      "created_at" : "2014-09-09T16:02:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4873#issuecomment-54992838",
      "id" : 54992838,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4873",
      "updated_at" : "2014-09-09T16:07:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/54992838",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "We have no reason to think that this is caused by this change. Before, this problem would not have been caught (or have resulted in a crash) because the record was created every time.\r\n\r\n    mapOrphanTransactionsByPrev[txin.prevout.hash].erase(hash);\r\n\r\nSo all that @gavinandresen's patch would do is restore the old behavior. But indeed, that would ignore the inconsistency.\r\n",
      "created_at" : "2014-09-09T16:09:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4873#issuecomment-54993937",
      "id" : 54993937,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4873",
      "updated_at" : "2014-09-09T16:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/54993937",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Looking at this more closely, I'm confident my proposed fix is correct.\r\n\r\nScenario 1 that tickles the bug:  Orphan transaction that spends two inputs of the same transaction.\r\nI think two orphan transactions that spend the same output of a parent transaction would also cause the crash.\r\n\r\nThe memory pool is consistent-- mapOrphanTransactions/mapOrphanTransactionsByPrev is just a big bag of transactions that can be inconsistent (may contain double-spends or invalid transactions), and that is OK, transactions are checked before moving from mapOrphanTransactions into the memory pool.",
      "created_at" : "2014-09-09T17:32:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4873#issuecomment-55006205",
      "id" : 55006205,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4873",
      "updated_at" : "2014-09-09T17:32:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/55006205",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "body" : "By inconsistent I just meant a discrepance between mapOrphanTransactions and mapOrphanTransactionsByPrev. But indeed, as they're identified by txid and not txid:index, a transaction spending two outputs from the same transactions does explain it. ACK on the change.",
      "created_at" : "2014-09-09T18:11:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4873#issuecomment-55010930",
      "id" : 55010930,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4873",
      "updated_at" : "2014-09-09T18:11:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/55010930",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   }
]
