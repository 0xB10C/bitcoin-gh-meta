[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#25308](https://github.com/bitcoin/bitcoin/pull/25308) (refactor: Reduce number of LoadChainstate parameters and return values by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-06-29T12:03:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25491#issuecomment-1169897159",
      "id" : 1169897159,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25491",
      "node_id" : "IC_kwDOABII585FuzbH",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1169897159/reactions"
      },
      "updated_at" : "2022-06-29T12:03:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1169897159",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I tried to see if this made any difference in practice, but it didn't. Annotations are disabled for con-/de-structors:\r\n\r\n\r\n```diff\r\ndiff --git a/src/wallet/sqlite.cpp b/src/wallet/sqlite.cpp\r\nindex 5d81af2fbf..c8a9262150 100644\r\n--- a/src/wallet/sqlite.cpp\r\n+++ b/src/wallet/sqlite.cpp\r\n@@ -113,7 +113,6 @@ SQLiteDatabase::SQLiteDatabase(const fs::path& dir_path, const fs::path& file_pa\r\n         if (ret != SQLITE_OK) {\r\n             throw std::runtime_error(strprintf(\"SQLiteDatabase: Failed to initialize SQLite: %s\\n\", sqlite3_errstr(ret)));\r\n         }\r\n-    }\r\n \r\n     try {\r\n         Open();\r\n@@ -122,6 +121,7 @@ SQLiteDatabase::SQLiteDatabase(const fs::path& dir_path, const fs::path& file_pa\r\n         Cleanup();\r\n         throw;\r\n     }\r\n+    }\r\n }\r\n \r\n void SQLiteBatch::SetupSQLStatements()\r\n```\r\n\r\nAlso, it is annotated in the implementation only (not the definition), (for obvious reasons, though).\r\n\r\nHowever, it does add a hint for developer reading the code, so lgtm.",
      "created_at" : "2022-06-29T13:36:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25491#issuecomment-1169990668",
      "id" : 1169990668,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25491",
      "node_id" : "IC_kwDOABII585FvKQM",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1169990668/reactions"
      },
      "updated_at" : "2022-06-29T13:36:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1169990668",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25491#discussion_r909654640"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25491"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/909654640"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm not sure what you meant with this sentence. `g_sqlite_count` can be higher than one.",
      "commit_id" : "83074b11653533fd932b2a0b806884f7ab8c7b29",
      "created_at" : "2022-06-29T13:45:07Z",
      "diff_hunk" : "@@ -23,7 +23,13 @@\n namespace wallet {\n static constexpr int32_t WALLET_SCHEMA_VERSION = 0;\n \n-static GlobalMutex g_sqlite_mutex;\n+/**\n+ * This mutex protects SQLite initialization and shutdown.\n+ * sqlite3_config() and sqlite3_shutdown() are not threadsafe (sqlite3_initialize() is).\n+ * Concurrent threads that execute SQLiteDatabase::SQLiteDatabase() should have just one",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25491#discussion_r909654640",
      "id" : 909654640,
      "line" : 29,
      "node_id" : "PRRC_kwDOABII5842ODpw",
      "original_commit_id" : "83074b11653533fd932b2a0b806884f7ab8c7b29",
      "original_line" : 29,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/wallet/sqlite.cpp",
      "position" : 8,
      "pull_request_review_id" : 1023392442,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25491",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/909654640/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-29T13:45:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/909654640",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25491#discussion_r909674530"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25491"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/909674530"
         }
      },
      "author_association" : "MEMBER",
      "body" : "\"one\" refers to \"concurrent threads\"",
      "commit_id" : "83074b11653533fd932b2a0b806884f7ab8c7b29",
      "created_at" : "2022-06-29T14:01:05Z",
      "diff_hunk" : "@@ -23,7 +23,13 @@\n namespace wallet {\n static constexpr int32_t WALLET_SCHEMA_VERSION = 0;\n \n-static GlobalMutex g_sqlite_mutex;\n+/**\n+ * This mutex protects SQLite initialization and shutdown.\n+ * sqlite3_config() and sqlite3_shutdown() are not threadsafe (sqlite3_initialize() is).\n+ * Concurrent threads that execute SQLiteDatabase::SQLiteDatabase() should have just one",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25491#discussion_r909674530",
      "id" : 909674530,
      "in_reply_to_id" : 909654640,
      "line" : 29,
      "node_id" : "PRRC_kwDOABII5842OIgi",
      "original_commit_id" : "83074b11653533fd932b2a0b806884f7ab8c7b29",
      "original_line" : 29,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/wallet/sqlite.cpp",
      "position" : 8,
      "pull_request_review_id" : 1023422143,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25491",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/909674530/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-29T14:01:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/909674530",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25491#discussion_r918455707"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25491"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/918455707"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "from developer-notes: \"In functions that are declared separately from where they are defined, \r\nthe thread safety annotations should be added exclusively to the function declaration.\"\r\n\r\nCould move `g_sqlite_mutex` and `g_sqlite_count` to be static members of SQLiteDatabase` though I think.",
      "commit_id" : "83074b11653533fd932b2a0b806884f7ab8c7b29",
      "created_at" : "2022-07-12T00:53:19Z",
      "diff_hunk" : "@@ -144,7 +150,7 @@ SQLiteDatabase::~SQLiteDatabase()\n     Cleanup();\n }\n \n-void SQLiteDatabase::Cleanup() noexcept\n+void SQLiteDatabase::Cleanup() noexcept EXCLUSIVE_LOCKS_REQUIRED(!g_sqlite_mutex)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25491#discussion_r918455707",
      "id" : 918455707,
      "line" : 153,
      "node_id" : "PRRC_kwDOABII5842voWb",
      "original_commit_id" : "83074b11653533fd932b2a0b806884f7ab8c7b29",
      "original_line" : 153,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/wallet/sqlite.cpp",
      "position" : 20,
      "pull_request_review_id" : 1035090174,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25491",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/918455707/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-12T00:53:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/918455707",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   }
]
