[
   {
      "author_association" : "MEMBER",
      "body" : "@ajtowns This should fix the issue you've seen in functional tests, where generating a bunch of blocks at once can result in O(n^2) headers downloads.",
      "created_at" : "2022-06-22T20:26:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25454#issuecomment-1163567385",
      "id" : 1163567385,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25454",
      "node_id" : "IC_kwDOABII585FWqEZ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1163567385/reactions"
      },
      "updated_at" : "2022-06-22T20:26:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1163567385",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#25404](https://github.com/bitcoin/bitcoin/pull/25404) (p2p, doc: Use MAX_BLOCKS_TO_ANNOUNCE consistently by mzumsande)\n* [#25268](https://github.com/bitcoin/bitcoin/pull/25268) (refactor: Introduce EvictionManager by dergoegge)\n* [#25144](https://github.com/bitcoin/bitcoin/pull/25144) (refactor: Pass Peer& to Misbehaving() by MarcoFalke)\n* [#24571](https://github.com/bitcoin/bitcoin/pull/24571) (p2p: Prevent block index fingerprinting by sending additional getheaders messages by dergoegge)\n* [#24008](https://github.com/bitcoin/bitcoin/pull/24008) (assumeutxo: net_processing changes by jamesob)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-06-23T03:37:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25454#issuecomment-1163888510",
      "id" : 1163888510,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25454",
      "node_id" : "IC_kwDOABII585FX4d-",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1163888510/reactions"
      },
      "updated_at" : "2022-06-23T03:37:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1163888510",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK, great catch",
      "created_at" : "2022-06-23T07:56:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25454#issuecomment-1164079513",
      "id" : 1164079513,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25454",
      "node_id" : "IC_kwDOABII585FYnGZ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1164079513/reactions"
      },
      "updated_at" : "2022-06-23T07:56:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1164079513",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25454#discussion_r905373582"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25454"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/905373582"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe change this log message? because now we send something in response instead of ignoring",
      "commit_id" : "f757d2a471f806a384a60f8783ccdebdb25cd403",
      "created_at" : "2022-06-23T19:13:10Z",
      "diff_hunk" : "@@ -3403,6 +3412,9 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         if (m_chainman.ActiveTip() == nullptr ||\n                 (m_chainman.ActiveTip()->nChainWork < nMinimumChainWork && !pfrom.HasPermission(NetPermissionFlags::Download))) {\n             LogPrint(BCLog::NET, \"Ignoring getheaders from peer=%d because active chain has too little work\\n\", pfrom.GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25454#discussion_r905373582",
      "id" : 905373582,
      "line" : 3414,
      "node_id" : "PRRC_kwDOABII58419ueO",
      "original_commit_id" : "f757d2a471f806a384a60f8783ccdebdb25cd403",
      "original_line" : 3414,
      "original_position" : 169,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 169,
      "pull_request_review_id" : 1017522335,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25454",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/905373582/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-23T19:37:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/905373582",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25454#discussion_r905376797"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25454"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/905376797"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: this looks like an accidental change, or do you have a reasoning for this?",
      "commit_id" : "f757d2a471f806a384a60f8783ccdebdb25cd403",
      "created_at" : "2022-06-23T19:17:46Z",
      "diff_hunk" : "@@ -355,8 +357,11 @@ struct Peer {\n     /** Work queue of items requested by this peer **/\n     std::deque<CInv> m_getdata_requests GUARDED_BY(m_getdata_requests_mutex);\n \n+    /** Time of the last getheaders message to this peer */\n+    std::atomic<std::chrono::seconds> m_last_getheaders_timestamp{0s};\n+\n     Peer(NodeId id)\n-        : m_id{id}\n+        : m_id(id)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25454#discussion_r905376797",
      "id" : 905376797,
      "line" : 364,
      "node_id" : "PRRC_kwDOABII58419vQd",
      "original_commit_id" : "f757d2a471f806a384a60f8783ccdebdb25cd403",
      "original_line" : 364,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 18,
      "pull_request_review_id" : 1017522335,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25454",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/905376797/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-23T19:37:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/905376797",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25454#discussion_r905386665"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25454"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/905386665"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why did you change it to receive a `CBlockLocator`? I don't think we ever create locators that are not part of the main chain. Also (maybe a bit nitpicky) we dont need to compute the locator if we don't send the `getheaders` message, so doing that inside of `MaybeSendGetHeaders` makes more sense to me.",
      "commit_id" : "f757d2a471f806a384a60f8783ccdebdb25cd403",
      "created_at" : "2022-06-23T19:31:45Z",
      "diff_hunk" : "@@ -2258,23 +2265,19 @@ bool PeerManagerImpl::CheckHeadersAreContinuous(const std::vector<CBlockHeader>&\n     return true;\n }\n \n-/*\n- * Continue fetching headers from a given point.\n- * pindexLast should be the last header we learned from a peer in their prior\n- * headers message.\n- *\n- * This is used for headers sync with a peer; even if pindexLast is an ancestor\n- * of a known chain (such as our tip) we don't yet know where the peer's chain\n- * might fork from what we know, so we continue exactly from where the peer\n- * left off.\n- */\n-void PeerManagerImpl::FetchMoreHeaders(CNode& pfrom, const CBlockIndex *pindexLast, const Peer& peer)\n+bool PeerManagerImpl::MaybeSendGetHeaders(CNode& pfrom, const CBlockLocator& locator, Peer& peer)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25454#discussion_r905386665",
      "id" : 905386665,
      "line" : 2268,
      "node_id" : "PRRC_kwDOABII58419xqp",
      "original_commit_id" : "f757d2a471f806a384a60f8783ccdebdb25cd403",
      "original_line" : 2268,
      "original_position" : 103,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 103,
      "pull_request_review_id" : 1017522335,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25454",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/905386665/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-23T19:37:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/905386665",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25454#discussion_r905542853"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25454"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/905542853"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: could just use `bool received_new_header  = ...` , remove the initialization a few lines above and move this down a few lines to where it is used.",
      "commit_id" : "af850df4093cb4472d0597858bcf9561ff88973f",
      "created_at" : "2022-06-23T22:13:29Z",
      "diff_hunk" : "@@ -2443,15 +2443,9 @@ void PeerManagerImpl::ProcessHeadersMessage(CNode& pfrom, const Peer& peer,\n         return;\n     }\n \n-    {\n-        LOCK(cs_main);\n-\n-        // If we don't have the last header, then they'll have given us\n-        // something new (if these headers are valid).\n-        if (!m_chainman.m_blockman.LookupBlockIndex(headers.back().GetHash())) {\n-            received_new_header = true;\n-        }\n-    }\n+    // If we don't have the last header, then this peer will have given us\n+    // something new (if these headers are valid).\n+    received_new_header = WITH_LOCK(::cs_main, return m_chainman.m_blockman.LookupBlockIndex(headers.back().GetHash()) == nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25454#discussion_r905542853",
      "id" : 905542853,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5841-XzF",
      "original_commit_id" : "64deef68be5afe2161079b7e52d48f43311df0ed",
      "original_line" : 2448,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1017752385,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25454",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/905542853/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-24T16:20:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/905542853",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25454#discussion_r906001551"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25454"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/906001551"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The reason I introduced this interface change here is that this branch is a precursor to another change I will be proposing to the headers sync logic, in which we might send getheaders messages based on locators that are not calculated from a single CBlockIndex entry. ",
      "commit_id" : "f2e3f6d732c13faff9de165044ae11e374f0ba0f",
      "created_at" : "2022-06-24T12:10:45Z",
      "diff_hunk" : "@@ -2258,23 +2265,19 @@ bool PeerManagerImpl::CheckHeadersAreContinuous(const std::vector<CBlockHeader>&\n     return true;\n }\n \n-/*\n- * Continue fetching headers from a given point.\n- * pindexLast should be the last header we learned from a peer in their prior\n- * headers message.\n- *\n- * This is used for headers sync with a peer; even if pindexLast is an ancestor\n- * of a known chain (such as our tip) we don't yet know where the peer's chain\n- * might fork from what we know, so we continue exactly from where the peer\n- * left off.\n- */\n-void PeerManagerImpl::FetchMoreHeaders(CNode& pfrom, const CBlockIndex *pindexLast, const Peer& peer)\n+bool PeerManagerImpl::MaybeSendGetHeaders(CNode& pfrom, const CBlockLocator& locator, Peer& peer)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25454#discussion_r906001551",
      "id" : 906001551,
      "in_reply_to_id" : 905386665,
      "line" : 2268,
      "node_id" : "PRRC_kwDOABII5842AHyP",
      "original_commit_id" : "f757d2a471f806a384a60f8783ccdebdb25cd403",
      "original_line" : 2268,
      "original_position" : 103,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 115,
      "pull_request_review_id" : 1018387319,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25454",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/906001551/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-24T12:10:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/906001551",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25454#discussion_r906010773"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25454"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/906010773"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yep this was a rebase error, fixed!",
      "commit_id" : "f2e3f6d732c13faff9de165044ae11e374f0ba0f",
      "created_at" : "2022-06-24T12:22:49Z",
      "diff_hunk" : "@@ -355,8 +357,11 @@ struct Peer {\n     /** Work queue of items requested by this peer **/\n     std::deque<CInv> m_getdata_requests GUARDED_BY(m_getdata_requests_mutex);\n \n+    /** Time of the last getheaders message to this peer */\n+    std::atomic<std::chrono::seconds> m_last_getheaders_timestamp{0s};\n+\n     Peer(NodeId id)\n-        : m_id{id}\n+        : m_id(id)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25454#discussion_r906010773",
      "id" : 906010773,
      "in_reply_to_id" : 905376797,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5842AKCV",
      "original_commit_id" : "f757d2a471f806a384a60f8783ccdebdb25cd403",
      "original_line" : 364,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1018402364,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25454",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/906010773/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-24T12:22:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/906010773",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25454#discussion_r906010899"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25454"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/906010899"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "f2e3f6d732c13faff9de165044ae11e374f0ba0f",
      "created_at" : "2022-06-24T12:23:00Z",
      "diff_hunk" : "@@ -3403,6 +3412,9 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         if (m_chainman.ActiveTip() == nullptr ||\n                 (m_chainman.ActiveTip()->nChainWork < nMinimumChainWork && !pfrom.HasPermission(NetPermissionFlags::Download))) {\n             LogPrint(BCLog::NET, \"Ignoring getheaders from peer=%d because active chain has too little work\\n\", pfrom.GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25454#discussion_r906010899",
      "id" : 906010899,
      "in_reply_to_id" : 905373582,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5842AKET",
      "original_commit_id" : "f757d2a471f806a384a60f8783ccdebdb25cd403",
      "original_line" : 3414,
      "original_position" : 169,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1018402553,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25454",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/906010899/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-24T12:23:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/906010899",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25454#discussion_r906192500"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25454"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/906192500"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Could this be abused by a peer to evade eviction by making us send `GetHeaders()` from other places (e.g. sending unconnecting CMPCTBLOCK messages) and sometimes sending stale headers? That might restart the `m_last_getheaders_timestamp` timer so that we never get to set `state.m_chain_sync.m_sent_getheaders` and `state.m_chain_sync.m_timeout` here and therefore won't disconnect.",
      "commit_id" : "af850df4093cb4472d0597858bcf9561ff88973f",
      "created_at" : "2022-06-24T15:51:18Z",
      "diff_hunk" : "@@ -4423,16 +4443,17 @@ void PeerManagerImpl::ConsiderEviction(CNode& pto, std::chrono::seconds time_in_\n                 pto.fDisconnect = true;\n             } else {\n                 assert(state.m_chain_sync.m_work_header);\n-                LogPrint(BCLog::NET, \"sending getheaders to outbound peer=%d to verify chain work (current best known block:%s, benchmark blockhash: %s)\\n\", pto.GetId(), state.pindexBestKnownBlock != nullptr ? state.pindexBestKnownBlock->GetBlockHash().ToString() : \"<none>\", state.m_chain_sync.m_work_header->GetBlockHash().ToString());\n-                m_connman.PushMessage(&pto, msgMaker.Make(NetMsgType::GETHEADERS, m_chainman.ActiveChain().GetLocator(state.m_chain_sync.m_work_header->pprev), uint256()));\n-                state.m_chain_sync.m_sent_getheaders = true;\n-                constexpr auto HEADERS_RESPONSE_TIME{2min};\n-                // Bump the timeout to allow a response, which could clear the timeout\n-                // (if the response shows the peer has synced), reset the timeout (if\n-                // the peer syncs to the required work but not to our tip), or result\n-                // in disconnect (if we advance to the timeout and pindexBestKnownBlock\n-                // has not sufficiently progressed)\n-                state.m_chain_sync.m_timeout = time_in_seconds + HEADERS_RESPONSE_TIME;\n+                if (MaybeSendGetHeaders(pto,\n+                            m_chainman.ActiveChain().GetLocator(state.m_chain_sync.m_work_header->pprev), *peer)) {\n+                    LogPrint(BCLog::NET, \"sending getheaders to outbound peer=%d to verify chain work (current best known block:%s, benchmark blockhash: %s)\\n\", pto.GetId(), state.pindexBestKnownBlock != nullptr ? state.pindexBestKnownBlock->GetBlockHash().ToString() : \"<none>\", state.m_chain_sync.m_work_header->GetBlockHash().ToString());\n+                    state.m_chain_sync.m_sent_getheaders = true;\n+                    // Bump the timeout to allow a response, which could clear the timeout\n+                    // (if the response shows the peer has synced), reset the timeout (if\n+                    // the peer syncs to the required work but not to our tip), or result\n+                    // in disconnect (if we advance to the timeout and pindexBestKnownBlock\n+                    // has not sufficiently progressed)\n+                    state.m_chain_sync.m_timeout = time_in_seconds + HEADERS_RESPONSE_TIME;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25454#discussion_r906192500",
      "id" : 906192500,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5842A2Z0",
      "original_commit_id" : "f2e3f6d732c13faff9de165044ae11e374f0ba0f",
      "original_line" : 4455,
      "original_position" : 231,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1017752385,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25454",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/906192500/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-24T16:20:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/906192500",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25454#discussion_r906221757"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25454"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/906221757"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We need to do the calculation here before invoking `ProcessNewBlockHeaders()` because that will cause headers to be added to the block index, but I'll get rid of the declaration at line 2423, as we can just declare and initialize here instead.",
      "commit_id" : "af850df4093cb4472d0597858bcf9561ff88973f",
      "created_at" : "2022-06-24T16:29:52Z",
      "diff_hunk" : "@@ -2443,15 +2443,9 @@ void PeerManagerImpl::ProcessHeadersMessage(CNode& pfrom, const Peer& peer,\n         return;\n     }\n \n-    {\n-        LOCK(cs_main);\n-\n-        // If we don't have the last header, then they'll have given us\n-        // something new (if these headers are valid).\n-        if (!m_chainman.m_blockman.LookupBlockIndex(headers.back().GetHash())) {\n-            received_new_header = true;\n-        }\n-    }\n+    // If we don't have the last header, then this peer will have given us\n+    // something new (if these headers are valid).\n+    received_new_header = WITH_LOCK(::cs_main, return m_chainman.m_blockman.LookupBlockIndex(headers.back().GetHash()) == nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25454#discussion_r906221757",
      "id" : 906221757,
      "in_reply_to_id" : 905542853,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5842A9i9",
      "original_commit_id" : "64deef68be5afe2161079b7e52d48f43311df0ed",
      "original_line" : 2448,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1018711161,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25454",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/906221757/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-24T16:29:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/906221757",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25454#discussion_r906228594"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25454"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/906228594"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks for thinking about this.  I think you're right to raise this concern, and after re-reviewing this logic, I think the best course of action is to just have this call-site assume the `getheaders` message goes out (rather than branch on the return value) -- because if it doesn't, it means we've already sent a `getheaders`, and so the peer should have provided us with a sufficiently high work chain anyway. \r\n\r\nDoes that reasoning sound right to you as well?\r\n\r\n(Edit: I guess a downside to this is that if a peer is in the middle of big reorg, that this logic might cause them to be evicted, because our timeouts aren't long enough to necessarily deliver a huge reorg -- however that is a pre-existing issue with this strategy, and we have other mitigations in place like protecting some of our outbound peers from eviction under this logic.)",
      "commit_id" : "af850df4093cb4472d0597858bcf9561ff88973f",
      "created_at" : "2022-06-24T16:38:25Z",
      "diff_hunk" : "@@ -4423,16 +4443,17 @@ void PeerManagerImpl::ConsiderEviction(CNode& pto, std::chrono::seconds time_in_\n                 pto.fDisconnect = true;\n             } else {\n                 assert(state.m_chain_sync.m_work_header);\n-                LogPrint(BCLog::NET, \"sending getheaders to outbound peer=%d to verify chain work (current best known block:%s, benchmark blockhash: %s)\\n\", pto.GetId(), state.pindexBestKnownBlock != nullptr ? state.pindexBestKnownBlock->GetBlockHash().ToString() : \"<none>\", state.m_chain_sync.m_work_header->GetBlockHash().ToString());\n-                m_connman.PushMessage(&pto, msgMaker.Make(NetMsgType::GETHEADERS, m_chainman.ActiveChain().GetLocator(state.m_chain_sync.m_work_header->pprev), uint256()));\n-                state.m_chain_sync.m_sent_getheaders = true;\n-                constexpr auto HEADERS_RESPONSE_TIME{2min};\n-                // Bump the timeout to allow a response, which could clear the timeout\n-                // (if the response shows the peer has synced), reset the timeout (if\n-                // the peer syncs to the required work but not to our tip), or result\n-                // in disconnect (if we advance to the timeout and pindexBestKnownBlock\n-                // has not sufficiently progressed)\n-                state.m_chain_sync.m_timeout = time_in_seconds + HEADERS_RESPONSE_TIME;\n+                if (MaybeSendGetHeaders(pto,\n+                            m_chainman.ActiveChain().GetLocator(state.m_chain_sync.m_work_header->pprev), *peer)) {\n+                    LogPrint(BCLog::NET, \"sending getheaders to outbound peer=%d to verify chain work (current best known block:%s, benchmark blockhash: %s)\\n\", pto.GetId(), state.pindexBestKnownBlock != nullptr ? state.pindexBestKnownBlock->GetBlockHash().ToString() : \"<none>\", state.m_chain_sync.m_work_header->GetBlockHash().ToString());\n+                    state.m_chain_sync.m_sent_getheaders = true;\n+                    // Bump the timeout to allow a response, which could clear the timeout\n+                    // (if the response shows the peer has synced), reset the timeout (if\n+                    // the peer syncs to the required work but not to our tip), or result\n+                    // in disconnect (if we advance to the timeout and pindexBestKnownBlock\n+                    // has not sufficiently progressed)\n+                    state.m_chain_sync.m_timeout = time_in_seconds + HEADERS_RESPONSE_TIME;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25454#discussion_r906228594",
      "id" : 906228594,
      "in_reply_to_id" : 906192500,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5842A_Ny",
      "original_commit_id" : "f2e3f6d732c13faff9de165044ae11e374f0ba0f",
      "original_line" : 4455,
      "original_position" : 231,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1018720526,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25454",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/906228594/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-24T16:44:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/906228594",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25454#discussion_r906264070"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25454"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/906264070"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> Does that reasoning sound right to you as well?\r\n\r\nYes, that's also the solution I had thought of. ",
      "commit_id" : "af850df4093cb4472d0597858bcf9561ff88973f",
      "created_at" : "2022-06-24T17:29:31Z",
      "diff_hunk" : "@@ -4423,16 +4443,17 @@ void PeerManagerImpl::ConsiderEviction(CNode& pto, std::chrono::seconds time_in_\n                 pto.fDisconnect = true;\n             } else {\n                 assert(state.m_chain_sync.m_work_header);\n-                LogPrint(BCLog::NET, \"sending getheaders to outbound peer=%d to verify chain work (current best known block:%s, benchmark blockhash: %s)\\n\", pto.GetId(), state.pindexBestKnownBlock != nullptr ? state.pindexBestKnownBlock->GetBlockHash().ToString() : \"<none>\", state.m_chain_sync.m_work_header->GetBlockHash().ToString());\n-                m_connman.PushMessage(&pto, msgMaker.Make(NetMsgType::GETHEADERS, m_chainman.ActiveChain().GetLocator(state.m_chain_sync.m_work_header->pprev), uint256()));\n-                state.m_chain_sync.m_sent_getheaders = true;\n-                constexpr auto HEADERS_RESPONSE_TIME{2min};\n-                // Bump the timeout to allow a response, which could clear the timeout\n-                // (if the response shows the peer has synced), reset the timeout (if\n-                // the peer syncs to the required work but not to our tip), or result\n-                // in disconnect (if we advance to the timeout and pindexBestKnownBlock\n-                // has not sufficiently progressed)\n-                state.m_chain_sync.m_timeout = time_in_seconds + HEADERS_RESPONSE_TIME;\n+                if (MaybeSendGetHeaders(pto,\n+                            m_chainman.ActiveChain().GetLocator(state.m_chain_sync.m_work_header->pprev), *peer)) {\n+                    LogPrint(BCLog::NET, \"sending getheaders to outbound peer=%d to verify chain work (current best known block:%s, benchmark blockhash: %s)\\n\", pto.GetId(), state.pindexBestKnownBlock != nullptr ? state.pindexBestKnownBlock->GetBlockHash().ToString() : \"<none>\", state.m_chain_sync.m_work_header->GetBlockHash().ToString());\n+                    state.m_chain_sync.m_sent_getheaders = true;\n+                    // Bump the timeout to allow a response, which could clear the timeout\n+                    // (if the response shows the peer has synced), reset the timeout (if\n+                    // the peer syncs to the required work but not to our tip), or result\n+                    // in disconnect (if we advance to the timeout and pindexBestKnownBlock\n+                    // has not sufficiently progressed)\n+                    state.m_chain_sync.m_timeout = time_in_seconds + HEADERS_RESPONSE_TIME;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25454#discussion_r906264070",
      "id" : 906264070,
      "in_reply_to_id" : 906192500,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5842BH4G",
      "original_commit_id" : "f2e3f6d732c13faff9de165044ae11e374f0ba0f",
      "original_line" : 4455,
      "original_position" : 231,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1018773248,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25454",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/906264070/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-24T17:29:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/906264070",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   }
]
