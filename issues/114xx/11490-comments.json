[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r144443566"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/144443566"
         }
      },
      "author_association" : "OWNER",
      "body" : "Unused variable",
      "commit_id" : "0a7bf445b61f8b160d644127a593a590844aee8d",
      "created_at" : "2017-10-13T00:40:18Z",
      "diff_hunk" : "@@ -502,7 +517,7 @@ void PeerLogicValidation::InitializeNode(CNode *pnode) {\n     NodeId nodeid = pnode->GetId();\n     {\n         LOCK(cs_main);\n-        mapNodeState.emplace_hint(mapNodeState.end(), std::piecewise_construct, std::forward_as_tuple(nodeid), std::forward_as_tuple(addr, std::move(addrName)));\n+        auto it = mapNodeState.emplace_hint(mapNodeState.end(), std::piecewise_construct, std::forward_as_tuple(nodeid), std::forward_as_tuple(addr, std::move(addrName)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r144443566",
      "id" : 144443566,
      "original_commit_id" : "d5b4bf323f743f521c93d18b20eaa6355a9e54d7",
      "original_position" : 41,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 69102056,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-13T13:14:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/144443566",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r144444476"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/144444476"
         }
      },
      "author_association" : "OWNER",
      "body" : "Nit: same line",
      "commit_id" : "0a7bf445b61f8b160d644127a593a590844aee8d",
      "created_at" : "2017-10-13T00:48:50Z",
      "diff_hunk" : "@@ -3244,6 +3272,56 @@ bool PeerLogicValidation::SendMessages(CNode* pto, std::atomic<bool>& interruptM\n             }\n         }\n \n+        // Check that outbound peers have reasonable chains\n+        if (!(state.fProtectFromDisconnect || pto->fInbound || pto->fAddnode || pto->fFeeler || pto->fOneShot) && state.fSyncStarted) {\n+            // This is an outbound peer subject to disconnection if their chain\n+            // lags behind ours (note: if their chain has more work than ours,\n+            // we should sync to it, unless it's invalid, in which case we\n+            // should find that out and disconnect from them elsewhere).\n+            if (state.pindexBestKnownBlock != nullptr && state.pindexBestKnownBlock->nChainWork >= chainActive.Tip()->nChainWork)\n+            {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r144444476",
      "id" : 144444476,
      "original_commit_id" : "d5b4bf323f743f521c93d18b20eaa6355a9e54d7",
      "original_position" : 94,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 69102056,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-13T13:14:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/144444476",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "I've spent some time verifying the logic, and it looks very good.\r\n\r\nI briefly misunderstood it to mean that if a peer makes _progress_ during the 20 minute window, it would be extended. That would have been a problem (an incompatible chain that has less work but does grow continuously), but it's not what happens (it requires reaching the same amount of work as we had at the beginning of the window).\r\n\r\nA test for the second commit would be great.",
      "created_at" : "2017-10-13T01:55:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#issuecomment-336328641",
      "id" : 336328641,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11490",
      "updated_at" : "2017-10-13T01:55:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/336328641",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r144503759"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/144503759"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this needs to be backed off a bit:  Consider-- imagine we start and are fully synced up, but we are still in IsInitialBlockDownload because the network has been slow and so the tip's timestamp is a ways back.  Then we have a peer we get headers from who is a single block behind us.   This would disconnect them, and I think that is probably undesirable.\r\n\r\nIt's probably a good idea to review all code as if IsInitialBlockDownload() were just return true; and if there would be misbehavior in that case, then the usage is perhaps suboptimal.\r\nAn obvious conservative thing to do would be to just use the nMinimumChainWork ... though perhaps too conservative.  It might also be reasonable to use a GetBlockProofEquivalentTime like test, or just the work several blocks back from chainactive tip.   I think if it was conservative enough it could apply at all times, not just IsIninitialBlockDownload().  \r\n\r\nMaybe the existence of the second commit means that it would be okay for this one to be less aggressive?",
      "commit_id" : "0a7bf445b61f8b160d644127a593a590844aee8d",
      "created_at" : "2017-10-13T09:17:39Z",
      "diff_hunk" : "@@ -2363,6 +2363,23 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                 }\n             }\n         }\n+        // If we're in IBD, we want outbound peers that will serve us a useful\n+        // chain.  Disconnect peers that are behind us or on chains with\n+        // insufficient work.\n+        if (IsInitialBlockDownload() && nCount != MAX_HEADERS_RESULTS) {\n+            // When nCount < MAX_HEADERS_RESULTS, we know we have no more\n+            // headers to fetch from this peer.\n+            const arith_uint256 &peer_chainwork = nodestate->pindexBestKnownBlock->nChainWork;\n+            const arith_uint256 &our_chainwork = std::max(chainActive.Tip()->nChainWork, nMinimumChainWork);\n+            if (peer_chainwork < our_chainwork) {\n+                // This peer has too little work on their headers chain to help\n+                // us sync -- disconnect if using an outbound slot (unless\n+                // whitelisted).\n+                if (!(pfrom->fInbound || pfrom->fWhitelisted || pfrom->fAddnode)) {\n+                    pfrom->fDisconnect = true;\n+                }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r144503759",
      "id" : 144503759,
      "original_commit_id" : "3203afcc7a42aa69b2d444e0322eb746e73fc361",
      "original_position" : 18,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 69169105,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-13T13:14:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/144503759",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r144549214"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/144549214"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I guess with the second commit, we will eventually disconnect some peers if they stay on chains with less work than our tip.  So I think we could just leave this as nMinimumChainWork, to protect against the case that all our peers only have incomplete/bogus chains (which wouldn't be prevented by the second commit).",
      "commit_id" : "0a7bf445b61f8b160d644127a593a590844aee8d",
      "created_at" : "2017-10-13T13:14:27Z",
      "diff_hunk" : "@@ -2363,6 +2363,23 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                 }\n             }\n         }\n+        // If we're in IBD, we want outbound peers that will serve us a useful\n+        // chain.  Disconnect peers that are behind us or on chains with\n+        // insufficient work.\n+        if (IsInitialBlockDownload() && nCount != MAX_HEADERS_RESULTS) {\n+            // When nCount < MAX_HEADERS_RESULTS, we know we have no more\n+            // headers to fetch from this peer.\n+            const arith_uint256 &peer_chainwork = nodestate->pindexBestKnownBlock->nChainWork;\n+            const arith_uint256 &our_chainwork = std::max(chainActive.Tip()->nChainWork, nMinimumChainWork);\n+            if (peer_chainwork < our_chainwork) {\n+                // This peer has too little work on their headers chain to help\n+                // us sync -- disconnect if using an outbound slot (unless\n+                // whitelisted).\n+                if (!(pfrom->fInbound || pfrom->fWhitelisted || pfrom->fAddnode)) {\n+                    pfrom->fDisconnect = true;\n+                }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r144549214",
      "id" : 144549214,
      "in_reply_to_id" : 144503759,
      "original_commit_id" : "3203afcc7a42aa69b2d444e0322eb746e73fc361",
      "original_position" : 18,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 69222114,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-13T13:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/144549214",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review.  I've pushed up a couple quick fixes for the nits.  Will work on a test, as well as trying to implement a suggestion @gmaxwell gave me offline for improving the behavior in the situation where none of our peers are giving us any block announcements.",
      "created_at" : "2017-10-13T13:16:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#issuecomment-336449305",
      "id" : 336449305,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11490",
      "updated_at" : "2017-10-13T13:16:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/336449305",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   }
]
