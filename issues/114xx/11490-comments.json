[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r144443566"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/144443566"
         }
      },
      "author_association" : "OWNER",
      "body" : "Unused variable",
      "commit_id" : "0a3d957935727025c340e856b3f91f73745ec6c3",
      "created_at" : "2017-10-13T00:40:18Z",
      "diff_hunk" : "@@ -502,7 +517,7 @@ void PeerLogicValidation::InitializeNode(CNode *pnode) {\n     NodeId nodeid = pnode->GetId();\n     {\n         LOCK(cs_main);\n-        mapNodeState.emplace_hint(mapNodeState.end(), std::piecewise_construct, std::forward_as_tuple(nodeid), std::forward_as_tuple(addr, std::move(addrName)));\n+        auto it = mapNodeState.emplace_hint(mapNodeState.end(), std::piecewise_construct, std::forward_as_tuple(nodeid), std::forward_as_tuple(addr, std::move(addrName)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r144443566",
      "id" : 144443566,
      "original_commit_id" : "d5b4bf323f743f521c93d18b20eaa6355a9e54d7",
      "original_position" : 41,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 69102056,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-19T20:49:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/144443566",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r144444476"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/144444476"
         }
      },
      "author_association" : "OWNER",
      "body" : "Nit: same line",
      "commit_id" : "0a3d957935727025c340e856b3f91f73745ec6c3",
      "created_at" : "2017-10-13T00:48:50Z",
      "diff_hunk" : "@@ -3244,6 +3272,56 @@ bool PeerLogicValidation::SendMessages(CNode* pto, std::atomic<bool>& interruptM\n             }\n         }\n \n+        // Check that outbound peers have reasonable chains\n+        if (!(state.fProtectFromDisconnect || pto->fInbound || pto->fAddnode || pto->fFeeler || pto->fOneShot) && state.fSyncStarted) {\n+            // This is an outbound peer subject to disconnection if their chain\n+            // lags behind ours (note: if their chain has more work than ours,\n+            // we should sync to it, unless it's invalid, in which case we\n+            // should find that out and disconnect from them elsewhere).\n+            if (state.pindexBestKnownBlock != nullptr && state.pindexBestKnownBlock->nChainWork >= chainActive.Tip()->nChainWork)\n+            {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r144444476",
      "id" : 144444476,
      "original_commit_id" : "d5b4bf323f743f521c93d18b20eaa6355a9e54d7",
      "original_position" : 94,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 69102056,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-19T20:49:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/144444476",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "I've spent some time verifying the logic, and it looks very good.\r\n\r\nI briefly misunderstood it to mean that if a peer makes _progress_ during the 20 minute window, it would be extended. That would have been a problem (an incompatible chain that has less work but does grow continuously), but it's not what happens (it requires reaching the same amount of work as we had at the beginning of the window).\r\n\r\nA test for the second commit would be great.",
      "created_at" : "2017-10-13T01:55:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#issuecomment-336328641",
      "id" : 336328641,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11490",
      "updated_at" : "2017-10-13T01:55:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/336328641",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r144503759"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/144503759"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this needs to be backed off a bit:  Consider-- imagine we start and are fully synced up, but we are still in IsInitialBlockDownload because the network has been slow and so the tip's timestamp is a ways back.  Then we have a peer we get headers from who is a single block behind us.   This would disconnect them, and I think that is probably undesirable.\r\n\r\nIt's probably a good idea to review all code as if IsInitialBlockDownload() were just return true; and if there would be misbehavior in that case, then the usage is perhaps suboptimal.\r\nAn obvious conservative thing to do would be to just use the nMinimumChainWork ... though perhaps too conservative.  It might also be reasonable to use a GetBlockProofEquivalentTime like test, or just the work several blocks back from chainactive tip.   I think if it was conservative enough it could apply at all times, not just IsIninitialBlockDownload().  \r\n\r\nMaybe the existence of the second commit means that it would be okay for this one to be less aggressive?",
      "commit_id" : "0a3d957935727025c340e856b3f91f73745ec6c3",
      "created_at" : "2017-10-13T09:17:39Z",
      "diff_hunk" : "@@ -2363,6 +2363,23 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                 }\n             }\n         }\n+        // If we're in IBD, we want outbound peers that will serve us a useful\n+        // chain.  Disconnect peers that are behind us or on chains with\n+        // insufficient work.\n+        if (IsInitialBlockDownload() && nCount != MAX_HEADERS_RESULTS) {\n+            // When nCount < MAX_HEADERS_RESULTS, we know we have no more\n+            // headers to fetch from this peer.\n+            const arith_uint256 &peer_chainwork = nodestate->pindexBestKnownBlock->nChainWork;\n+            const arith_uint256 &our_chainwork = std::max(chainActive.Tip()->nChainWork, nMinimumChainWork);\n+            if (peer_chainwork < our_chainwork) {\n+                // This peer has too little work on their headers chain to help\n+                // us sync -- disconnect if using an outbound slot (unless\n+                // whitelisted).\n+                if (!(pfrom->fInbound || pfrom->fWhitelisted || pfrom->fAddnode)) {\n+                    pfrom->fDisconnect = true;\n+                }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r144503759",
      "id" : 144503759,
      "original_commit_id" : "3203afcc7a42aa69b2d444e0322eb746e73fc361",
      "original_position" : 18,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 69169105,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-19T20:49:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/144503759",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r144549214"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/144549214"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I guess with the second commit, we will eventually disconnect some peers if they stay on chains with less work than our tip.  So I think we could just leave this as nMinimumChainWork, to protect against the case that all our peers only have incomplete/bogus chains (which wouldn't be prevented by the second commit).",
      "commit_id" : "0a3d957935727025c340e856b3f91f73745ec6c3",
      "created_at" : "2017-10-13T13:14:27Z",
      "diff_hunk" : "@@ -2363,6 +2363,23 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                 }\n             }\n         }\n+        // If we're in IBD, we want outbound peers that will serve us a useful\n+        // chain.  Disconnect peers that are behind us or on chains with\n+        // insufficient work.\n+        if (IsInitialBlockDownload() && nCount != MAX_HEADERS_RESULTS) {\n+            // When nCount < MAX_HEADERS_RESULTS, we know we have no more\n+            // headers to fetch from this peer.\n+            const arith_uint256 &peer_chainwork = nodestate->pindexBestKnownBlock->nChainWork;\n+            const arith_uint256 &our_chainwork = std::max(chainActive.Tip()->nChainWork, nMinimumChainWork);\n+            if (peer_chainwork < our_chainwork) {\n+                // This peer has too little work on their headers chain to help\n+                // us sync -- disconnect if using an outbound slot (unless\n+                // whitelisted).\n+                if (!(pfrom->fInbound || pfrom->fWhitelisted || pfrom->fAddnode)) {\n+                    pfrom->fDisconnect = true;\n+                }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r144549214",
      "id" : 144549214,
      "in_reply_to_id" : 144503759,
      "original_commit_id" : "3203afcc7a42aa69b2d444e0322eb746e73fc361",
      "original_position" : 18,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 69222114,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-19T20:49:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/144549214",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review.  I've pushed up a couple quick fixes for the nits.  Will work on a test, as well as trying to implement a suggestion @gmaxwell gave me offline for improving the behavior in the situation where none of our peers are giving us any block announcements.",
      "created_at" : "2017-10-13T13:16:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#issuecomment-336449305",
      "id" : 336449305,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11490",
      "updated_at" : "2017-10-13T13:16:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/336449305",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145531028"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145531028"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I believe this adds a new invariant (currently true), that we shall never send a GETHEADERS or do something which expects, as a result, a HEADERS message, which is not MAX_HEADERS_RESULT if it doesn't end with the peer's tip (ie no GETHEADERS with hashStop of not-their-tip, or at least not when in IBD/before we've finished syncing the state of another peer). I don't think this is bad, but it should be documented somewhere explicitly.\r\n\r\nEventually I really think we need to have peers in a \"mode\" which describes were we are 1. connect-handshake (version/verack/sendcmpct/sendheaders/feefilter/etc) 2. header-chain-sync (slightly complicated by the fact that we want to block all peers but one during ibd until we've finished one) 3. normal operation and then we can simplify and document strange things like this significantly instead of making everything yet more of a mess.",
      "commit_id" : "0a3d957935727025c340e856b3f91f73745ec6c3",
      "created_at" : "2017-10-18T20:23:32Z",
      "diff_hunk" : "@@ -2383,6 +2383,21 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                 }\n             }\n         }\n+        // If we're in IBD, we want outbound peers that will serve us a useful\n+        // chain.  Disconnect peers that are behind us or on chains with\n+        // insufficient work.\n+        if (IsInitialBlockDownload() && nCount != MAX_HEADERS_RESULTS) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145531028",
      "id" : 145531028,
      "original_commit_id" : "6e21a4a7935108aed6cb8b7528a5e30ae71f63eb",
      "original_position" : 7,
      "path" : "src/net_processing.cpp",
      "position" : 60,
      "pull_request_review_id" : 70345107,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-19T20:49:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145531028",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145557409"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145557409"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "new code should have the m_ prefix here (and other places), and probably drop the hungarian type prefix.",
      "commit_id" : "0a3d957935727025c340e856b3f91f73745ec6c3",
      "created_at" : "2017-10-18T22:13:07Z",
      "diff_hunk" : "@@ -200,6 +203,14 @@ struct CNodeState {\n      * otherwise: whether this peer sends non-witnesses in cmpctblocks/blocktxns.\n      */\n     bool fSupportsDesiredCmpctVersion;\n+    //! Whether this peer is protected from disconnection due to a bad/slow chain\n+    bool fProtectFromDisconnect;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145557409",
      "id" : 145557409,
      "original_commit_id" : "4b8a4bd29cd5550f808a04f5ad10bcafd495f877",
      "original_position" : 15,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 70345107,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-19T20:49:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145557409",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145568180"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145568180"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ugh, just for a print?",
      "commit_id" : "0a3d957935727025c340e856b3f91f73745ec6c3",
      "created_at" : "2017-10-18T23:21:17Z",
      "diff_hunk" : "@@ -3247,6 +3290,55 @@ bool PeerLogicValidation::SendMessages(CNode* pto, std::atomic<bool>& interruptM\n             }\n         }\n \n+        // Check that outbound peers have reasonable chains\n+        if (!(state.fProtectFromDisconnect || pto->fInbound || pto->m_manual_connection || pto->fFeeler || pto->fOneShot) && state.fSyncStarted) {\n+            // This is an outbound peer subject to disconnection if their chain\n+            // lags behind ours (note: if their chain has more work than ours,\n+            // we should sync to it, unless it's invalid, in which case we\n+            // should find that out and disconnect from them elsewhere).\n+            if (state.pindexBestKnownBlock != nullptr && state.pindexBestKnownBlock->nChainWork >= chainActive.Tip()->nChainWork) {\n+                if (state.nHeadersChainTimeout != 0) {\n+                    state.nHeadersChainTimeout = 0;\n+                    state.header_with_required_work = nullptr;\n+                    state.fSentGetHeadersToCheckChainSync = false;\n+                }\n+            } else if (state.nHeadersChainTimeout == 0 || (state.header_with_required_work != nullptr && state.pindexBestKnownBlock != nullptr && state.pindexBestKnownBlock->nChainWork >= state.header_with_required_work->nChainWork)) {\n+                // Our best block known by this peer is behind our tip, and we're either noticing\n+                // that for the first time, OR this peer was able to catch up to some earlier point\n+                // where we checked against our tip.\n+                // Either way, set a new timeout based on current tip.\n+                state.nHeadersChainTimeout = nNow + CHAIN_SYNC_TIMEOUT;\n+                state.header_with_required_work = chainActive.Tip();\n+                state.fSentGetHeadersToCheckChainSync = false;\n+            } else if (state.nHeadersChainTimeout > 0 && nNow > state.nHeadersChainTimeout) {\n+                // No evidence yet that our peer has synced to a chain with work equal to that\n+                // of our tip, when we first detected it was behind.  Send a single getheaders\n+                // message to give the peer a chance to update us.\n+                if (state.fSentGetHeadersToCheckChainSync) {\n+                    // They've run out of time to catch up!\n+                    LogPrintf(\"Disconnecting outbound peer %d for old chain, best known block = %s\\n\", pto->GetId(), state.pindexBestKnownBlock != nullptr ? state.pindexBestKnownBlock->GetBlockHash().ToString() : \"<none>\");\n+                    pto->fDisconnect = true;\n+                } else {\n+                    const CBlockIndex *pindexStart = state.header_with_required_work;\n+                    assert (pindexStart != nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145568180",
      "id" : 145568180,
      "original_commit_id" : "b44013e9e71ad9f1aaa146edfece1cd84b2f4361",
      "original_position" : 119,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 70345107,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-19T20:49:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145568180",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145744064"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145744064"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> I believe this adds a new invariant (currently true), that we shall never send a GETHEADERS or do something which expects, as a result, a HEADERS message, which is not MAX_HEADERS_RESULT if it doesn't end with the peer's tip (ie no GETHEADERS with hashStop of not-their-tip, or at least not when in IBD/before we've finished syncing the state of another peer). I don't think this is bad, but it should be documented somewhere explicitly.\r\n\r\nI don't think this is precisely correct.  What we are assuming is the same thing we use for headers sync (eg on initial connection) -- if we receive fewer than MAX_HEADERS_RESULTS, then we have no reason to request more headers _in order to update pindexBestKnownBlock_.  Note that in the logic below, we are using pindexBestKnownBlock, not pindexLast.\r\n\r\nIn other words, if we did add a reason for requesting a single header to a random location in the chain, I think this logic would still be correct.",
      "commit_id" : "0a3d957935727025c340e856b3f91f73745ec6c3",
      "created_at" : "2017-10-19T15:54:48Z",
      "diff_hunk" : "@@ -2383,6 +2383,21 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                 }\n             }\n         }\n+        // If we're in IBD, we want outbound peers that will serve us a useful\n+        // chain.  Disconnect peers that are behind us or on chains with\n+        // insufficient work.\n+        if (IsInitialBlockDownload() && nCount != MAX_HEADERS_RESULTS) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145744064",
      "id" : 145744064,
      "in_reply_to_id" : 145531028,
      "original_commit_id" : "6e21a4a7935108aed6cb8b7528a5e30ae71f63eb",
      "original_position" : 7,
      "path" : "src/net_processing.cpp",
      "position" : 60,
      "pull_request_review_id" : 70589798,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-19T20:49:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145744064",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145761027"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145761027"
         }
      },
      "author_association" : "MEMBER",
      "body" : "agreed, chucking it",
      "commit_id" : "0a3d957935727025c340e856b3f91f73745ec6c3",
      "created_at" : "2017-10-19T16:59:09Z",
      "diff_hunk" : "@@ -3247,6 +3290,55 @@ bool PeerLogicValidation::SendMessages(CNode* pto, std::atomic<bool>& interruptM\n             }\n         }\n \n+        // Check that outbound peers have reasonable chains\n+        if (!(state.fProtectFromDisconnect || pto->fInbound || pto->m_manual_connection || pto->fFeeler || pto->fOneShot) && state.fSyncStarted) {\n+            // This is an outbound peer subject to disconnection if their chain\n+            // lags behind ours (note: if their chain has more work than ours,\n+            // we should sync to it, unless it's invalid, in which case we\n+            // should find that out and disconnect from them elsewhere).\n+            if (state.pindexBestKnownBlock != nullptr && state.pindexBestKnownBlock->nChainWork >= chainActive.Tip()->nChainWork) {\n+                if (state.nHeadersChainTimeout != 0) {\n+                    state.nHeadersChainTimeout = 0;\n+                    state.header_with_required_work = nullptr;\n+                    state.fSentGetHeadersToCheckChainSync = false;\n+                }\n+            } else if (state.nHeadersChainTimeout == 0 || (state.header_with_required_work != nullptr && state.pindexBestKnownBlock != nullptr && state.pindexBestKnownBlock->nChainWork >= state.header_with_required_work->nChainWork)) {\n+                // Our best block known by this peer is behind our tip, and we're either noticing\n+                // that for the first time, OR this peer was able to catch up to some earlier point\n+                // where we checked against our tip.\n+                // Either way, set a new timeout based on current tip.\n+                state.nHeadersChainTimeout = nNow + CHAIN_SYNC_TIMEOUT;\n+                state.header_with_required_work = chainActive.Tip();\n+                state.fSentGetHeadersToCheckChainSync = false;\n+            } else if (state.nHeadersChainTimeout > 0 && nNow > state.nHeadersChainTimeout) {\n+                // No evidence yet that our peer has synced to a chain with work equal to that\n+                // of our tip, when we first detected it was behind.  Send a single getheaders\n+                // message to give the peer a chance to update us.\n+                if (state.fSentGetHeadersToCheckChainSync) {\n+                    // They've run out of time to catch up!\n+                    LogPrintf(\"Disconnecting outbound peer %d for old chain, best known block = %s\\n\", pto->GetId(), state.pindexBestKnownBlock != nullptr ? state.pindexBestKnownBlock->GetBlockHash().ToString() : \"<none>\");\n+                    pto->fDisconnect = true;\n+                } else {\n+                    const CBlockIndex *pindexStart = state.header_with_required_work;\n+                    assert (pindexStart != nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145761027",
      "id" : 145761027,
      "in_reply_to_id" : 145568180,
      "original_commit_id" : "b44013e9e71ad9f1aaa146edfece1cd84b2f4361",
      "original_position" : 119,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 70589798,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-19T20:49:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145761027",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Squashed (https://github.com/sdaftuar/bitcoin/commits/11490.1 -> 032dc531b911a0c0ea570aa74531508f54a36073)",
      "created_at" : "2017-10-19T17:23:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#issuecomment-337978038",
      "id" : 337978038,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11490",
      "updated_at" : "2017-10-19T17:23:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/337978038",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Travis found:\r\n```\r\ntest/DoS_tests.cpp(80): error in \"outbound_slow_chain_eviction\": check dummyNode1.fDisconnect == true failed\r\n```",
      "created_at" : "2017-10-19T19:03:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#issuecomment-338005968",
      "id" : 338005968,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11490",
      "updated_at" : "2017-10-19T19:03:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/338005968",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Unit test issue should be fixed now.",
      "created_at" : "2017-10-19T21:02:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#issuecomment-338037130",
      "id" : 338037130,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11490",
      "updated_at" : "2017-10-19T21:02:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/338037130",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145845983"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145845983"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`int -= bool`?",
      "commit_id" : "0a3d957935727025c340e856b3f91f73745ec6c3",
      "created_at" : "2017-10-19T23:07:59Z",
      "diff_hunk" : "@@ -534,6 +549,8 @@ void PeerLogicValidation::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTim\n     nPreferredDownload -= state->fPreferredDownload;\n     nPeersWithValidatedDownloads -= (state->nBlocksInFlightValidHeaders != 0);\n     assert(nPeersWithValidatedDownloads >= 0);\n+    g_outbound_peers_with_protect_from_disconnect -= state->m_protect_from_disconnect;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145845983",
      "id" : 145845983,
      "original_commit_id" : "0a3d957935727025c340e856b3f91f73745ec6c3",
      "original_position" : 40,
      "path" : "src/net_processing.cpp",
      "position" : 40,
      "pull_request_review_id" : 70707937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-19T23:34:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145845983",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145846296"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145846296"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Remove since this is easily calculated by counting nodes with `m_protect_from_disconnect`?",
      "commit_id" : "0a3d957935727025c340e856b3f91f73745ec6c3",
      "created_at" : "2017-10-19T23:10:16Z",
      "diff_hunk" : "@@ -124,6 +124,9 @@ namespace {\n     /** Number of peers from which we're downloading blocks. */\n     int nPeersWithValidatedDownloads = 0;\n \n+    /** Number of outbound peers with m_protect_from_disconnect. */\n+    int g_outbound_peers_with_protect_from_disconnect = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145846296",
      "id" : 145846296,
      "original_commit_id" : "0a3d957935727025c340e856b3f91f73745ec6c3",
      "original_position" : 5,
      "path" : "src/net_processing.cpp",
      "position" : 5,
      "pull_request_review_id" : 70707937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-19T23:34:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145846296",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145846645"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145846645"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`_FROM_DISCONNECT`?",
      "commit_id" : "0a3d957935727025c340e856b3f91f73745ec6c3",
      "created_at" : "2017-10-19T23:12:44Z",
      "diff_hunk" : "@@ -21,6 +21,12 @@ static const unsigned int DEFAULT_BLOCK_RECONSTRUCTION_EXTRA_TXN = 100;\n  *  Timeout = base + per_header * (expected number of headers) */\n static constexpr int64_t HEADERS_DOWNLOAD_TIMEOUT_BASE = 15 * 60 * 1000000; // 15 minutes\n static constexpr int64_t HEADERS_DOWNLOAD_TIMEOUT_PER_HEADER = 1000; // 1ms/header\n+/** Protect at least this many outbound peers from disconnection due to slow/\n+ * behind headers chain.\n+ */\n+static constexpr int32_t MAX_OUTBOUND_PEERS_TO_PROTECT = 4;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145846645",
      "id" : 145846645,
      "original_commit_id" : "0a3d957935727025c340e856b3f91f73745ec6c3",
      "original_position" : 7,
      "path" : "src/net_processing.h",
      "position" : 7,
      "pull_request_review_id" : 70707937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-19T23:34:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145846645",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145848428"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145848428"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "More verbose but IMO more clear:\r\n```cpp\r\nif (state->m_protect_from_disconnect) {\r\n    assert(g_outbound_peers_with_protect_from_disconnect > 0);\r\n    --g_outbound_peers_with_protect_from_disconnect;\r\n}\r\n```",
      "commit_id" : "0a3d957935727025c340e856b3f91f73745ec6c3",
      "created_at" : "2017-10-19T23:26:27Z",
      "diff_hunk" : "@@ -534,6 +549,8 @@ void PeerLogicValidation::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTim\n     nPreferredDownload -= state->fPreferredDownload;\n     nPeersWithValidatedDownloads -= (state->nBlocksInFlightValidHeaders != 0);\n     assert(nPeersWithValidatedDownloads >= 0);\n+    g_outbound_peers_with_protect_from_disconnect -= state->m_protect_from_disconnect;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145848428",
      "id" : 145848428,
      "in_reply_to_id" : 145845983,
      "original_commit_id" : "0a3d957935727025c340e856b3f91f73745ec6c3",
      "original_position" : 40,
      "path" : "src/net_processing.cpp",
      "position" : 40,
      "pull_request_review_id" : 70707937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-19T23:34:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145848428",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145848655"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145848655"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Swap conditions as the second is faster?",
      "commit_id" : "0a3d957935727025c340e856b3f91f73745ec6c3",
      "created_at" : "2017-10-19T23:28:11Z",
      "diff_hunk" : "@@ -2383,6 +2383,21 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                 }\n             }\n         }\n+        // If we're in IBD, we want outbound peers that will serve us a useful\n+        // chain.  Disconnect peers that are behind us or on chains with\n+        // insufficient work.\n+        if (IsInitialBlockDownload() && nCount != MAX_HEADERS_RESULTS) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145848655",
      "id" : 145848655,
      "in_reply_to_id" : 145531028,
      "original_commit_id" : "6e21a4a7935108aed6cb8b7528a5e30ae71f63eb",
      "original_position" : 7,
      "path" : "src/net_processing.cpp",
      "position" : 60,
      "pull_request_review_id" : 70707937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-19T23:34:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145848655",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145848695"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145848695"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Remove extra space.",
      "commit_id" : "0a3d957935727025c340e856b3f91f73745ec6c3",
      "created_at" : "2017-10-19T23:28:26Z",
      "diff_hunk" : "@@ -2383,6 +2401,31 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                 }\n             }\n         }\n+        // If we're in IBD, we want outbound peers that will serve us a useful\n+        // chain.  Disconnect peers that are behind us or on chains with",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145848695",
      "id" : 145848695,
      "original_commit_id" : "0a3d957935727025c340e856b3f91f73745ec6c3",
      "original_position" : 58,
      "path" : "src/net_processing.cpp",
      "position" : 58,
      "pull_request_review_id" : 70707937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-19T23:34:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145848695",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145849488"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145849488"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Remove extra space.",
      "commit_id" : "0a3d957935727025c340e856b3f91f73745ec6c3",
      "created_at" : "2017-10-19T23:34:18Z",
      "diff_hunk" : "@@ -3247,6 +3290,52 @@ bool PeerLogicValidation::SendMessages(CNode* pto, std::atomic<bool>& interruptM\n             }\n         }\n \n+        // Check that outbound peers have reasonable chains\n+        // GetTime() is used by this anti-DoS logic so we can test this using mocktime\n+        int64_t time_in_seconds = GetTime();\n+        if (!(state.m_protect_from_disconnect || pto->fInbound || pto->m_manual_connection || pto->fFeeler || pto->fOneShot) && state.fSyncStarted) {\n+            // This is an outbound peer subject to disconnection if their chain\n+            // lags behind ours (note: if their chain has more work than ours,\n+            // we should sync to it, unless it's invalid, in which case we\n+            // should find that out and disconnect from them elsewhere).\n+            if (state.pindexBestKnownBlock != nullptr && state.pindexBestKnownBlock->nChainWork >= chainActive.Tip()->nChainWork) {\n+                if (state.m_headers_chain_timeout != 0) {\n+                    state.m_headers_chain_timeout = 0;\n+                    state.m_header_with_required_work = nullptr;\n+                    state.m_sent_getheaders_to_check_chain_sync = false;\n+                }\n+            } else if (state.m_headers_chain_timeout == 0 || (state.m_header_with_required_work != nullptr && state.pindexBestKnownBlock != nullptr && state.pindexBestKnownBlock->nChainWork >= state.m_header_with_required_work->nChainWork)) {\n+                // Our best block known by this peer is behind our tip, and we're either noticing\n+                // that for the first time, OR this peer was able to catch up to some earlier point\n+                // where we checked against our tip.\n+                // Either way, set a new timeout based on current tip.\n+                state.m_headers_chain_timeout = time_in_seconds + CHAIN_SYNC_TIMEOUT;\n+                state.m_header_with_required_work = chainActive.Tip();\n+                state.m_sent_getheaders_to_check_chain_sync = false;\n+            } else if (state.m_headers_chain_timeout > 0 && time_in_seconds > state.m_headers_chain_timeout) {\n+                // No evidence yet that our peer has synced to a chain with work equal to that\n+                // of our tip, when we first detected it was behind.  Send a single getheaders",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11490#discussion_r145849488",
      "id" : 145849488,
      "original_commit_id" : "0a3d957935727025c340e856b3f91f73745ec6c3",
      "original_position" : 113,
      "path" : "src/net_processing.cpp",
      "position" : 113,
      "pull_request_review_id" : 70707937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11490",
      "updated_at" : "2017-10-19T23:34:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145849488",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   }
]
