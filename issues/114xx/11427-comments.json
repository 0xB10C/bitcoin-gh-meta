[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11427#discussion_r142008315"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11427"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/142008315"
         }
      },
      "author_association" : "MEMBER",
      "body" : "should be `pindex->nHeight < chainparams.GetConsensus().BIP34Height;` ?",
      "commit_id" : "912b1a12c2fabaf384e704076ecb9358377c900b",
      "created_at" : "2017-09-30T15:24:58Z",
      "diff_hunk" : "@@ -1712,10 +1712,7 @@ static bool ConnectBlock(const CBlock& block, CValidationState& state, CBlockInd\n     // before the first had been spent.  Since those coinbases are sufficiently buried its no longer possible to create further\n     // duplicate transactions descending from the known pairs either.\n     // If we're on the known chain at height greater than where BIP34 activated, we can save the db accesses needed for the BIP30 check.\n-    assert(pindex->pprev);\n-    CBlockIndex *pindexBIP34height = pindex->pprev->GetAncestor(chainparams.GetConsensus().BIP34Height);\n-    //Only continue to enforce if we're below BIP34 activation height or the block hash at that height doesn't correspond.\n-    fEnforceBIP30 = fEnforceBIP30 && (!pindexBIP34height || !(pindexBIP34height->GetBlockHash() == chainparams.GetConsensus().BIP34Hash));\n+    fEnforceBIP30 = fEnforceBIP30 && pindex->nHeight > chainparams.GetConsensus().BIP34Height;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11427#discussion_r142008315",
      "id" : 142008315,
      "original_commit_id" : "2d438b3f10f568764671ff227c1fc48de4071c0c",
      "original_position" : 8,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 66315507,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11427",
      "updated_at" : "2017-09-30T18:04:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/142008315",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/8403418?v=4",
         "events_url" : "https://api.github.com/users/jl2012/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jl2012/followers",
         "following_url" : "https://api.github.com/users/jl2012/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jl2012/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jl2012",
         "id" : 8403418,
         "login" : "jl2012",
         "organizations_url" : "https://api.github.com/users/jl2012/orgs",
         "received_events_url" : "https://api.github.com/users/jl2012/received_events",
         "repos_url" : "https://api.github.com/users/jl2012/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jl2012/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jl2012/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jl2012"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11427#discussion_r142011574"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11427"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/142011574"
         }
      },
      "author_association" : "MEMBER",
      "body" : "oops, yeah it's bip34 that we need to enforce it after BIP34Height but not before, not bip30. bip30b is the opposite. Thanks!",
      "commit_id" : "912b1a12c2fabaf384e704076ecb9358377c900b",
      "created_at" : "2017-09-30T17:53:56Z",
      "diff_hunk" : "@@ -1712,10 +1712,7 @@ static bool ConnectBlock(const CBlock& block, CValidationState& state, CBlockInd\n     // before the first had been spent.  Since those coinbases are sufficiently buried its no longer possible to create further\n     // duplicate transactions descending from the known pairs either.\n     // If we're on the known chain at height greater than where BIP34 activated, we can save the db accesses needed for the BIP30 check.\n-    assert(pindex->pprev);\n-    CBlockIndex *pindexBIP34height = pindex->pprev->GetAncestor(chainparams.GetConsensus().BIP34Height);\n-    //Only continue to enforce if we're below BIP34 activation height or the block hash at that height doesn't correspond.\n-    fEnforceBIP30 = fEnforceBIP30 && (!pindexBIP34height || !(pindexBIP34height->GetBlockHash() == chainparams.GetConsensus().BIP34Hash));\n+    fEnforceBIP30 = fEnforceBIP30 && pindex->nHeight > chainparams.GetConsensus().BIP34Height;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11427#discussion_r142011574",
      "id" : 142011574,
      "in_reply_to_id" : 142008315,
      "original_commit_id" : "2d438b3f10f568764671ff227c1fc48de4071c0c",
      "original_position" : 8,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 66318775,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11427",
      "updated_at" : "2017-09-30T18:04:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/142011574",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1008458?v=4",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11427#discussion_r142019645"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11427"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/142019645"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think we could make this an `if` condition before any BIP30 code, and skip all BIP30 codes after BIP34Height. Therefore, we don't need to compare the block hash of every blocks with the BIP30 special cases",
      "commit_id" : "912b1a12c2fabaf384e704076ecb9358377c900b",
      "created_at" : "2017-10-01T03:14:53Z",
      "diff_hunk" : "@@ -1712,10 +1712,7 @@ static bool ConnectBlock(const CBlock& block, CValidationState& state, CBlockInd\n     // before the first had been spent.  Since those coinbases are sufficiently buried its no longer possible to create further\n     // duplicate transactions descending from the known pairs either.\n     // If we're on the known chain at height greater than where BIP34 activated, we can save the db accesses needed for the BIP30 check.\n-    assert(pindex->pprev);\n-    CBlockIndex *pindexBIP34height = pindex->pprev->GetAncestor(chainparams.GetConsensus().BIP34Height);\n-    //Only continue to enforce if we're below BIP34 activation height or the block hash at that height doesn't correspond.\n-    fEnforceBIP30 = fEnforceBIP30 && (!pindexBIP34height || !(pindexBIP34height->GetBlockHash() == chainparams.GetConsensus().BIP34Hash));\n+    fEnforceBIP30 = fEnforceBIP30 && pindex->nHeight < chainparams.GetConsensus().BIP34Height;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11427#discussion_r142019645",
      "id" : 142019645,
      "original_commit_id" : "912b1a12c2fabaf384e704076ecb9358377c900b",
      "original_position" : 8,
      "path" : "src/validation.cpp",
      "position" : 8,
      "pull_request_review_id" : 66326892,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11427",
      "updated_at" : "2017-10-01T03:14:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/142019645",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/8403418?v=4",
         "events_url" : "https://api.github.com/users/jl2012/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jl2012/followers",
         "following_url" : "https://api.github.com/users/jl2012/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jl2012/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jl2012",
         "id" : 8403418,
         "login" : "jl2012",
         "organizations_url" : "https://api.github.com/users/jl2012/orgs",
         "received_events_url" : "https://api.github.com/users/jl2012/received_events",
         "repos_url" : "https://api.github.com/users/jl2012/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jl2012/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jl2012/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jl2012"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This is incorrect -- on a random chain, we can't disable BIP30 merely because BIP34 has activated.  It's possible to have a chain where there are multiple coinbases with the same txid (mined pre-bip34), where the first bip30 violation would be after the bip34 activation height, because the coinbases didn't overwrite each other.  This in turn could prevent reorging back to the honest chain.  NACK.",
      "created_at" : "2017-10-01T18:30:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11427#issuecomment-333396501",
      "id" : 333396501,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11427",
      "updated_at" : "2017-10-01T18:30:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/333396501",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I don't follow. In a \"random chain\", let's say testnet where bip34 is\nburied in the past, the situation is similar to bitcoin main. On a newly\ncreated \"random chain\", bip34 (or a hf equivalent) can be validated from\nblock 1.\n\nOn 1 Oct 2017 8:31 pm, \"Suhas Daftuar\" <notifications@github.com> wrote:\n\n> This is incorrect -- on a random chain, we can't disable BIP30 merely\n> because BIP34 has activated. It's possible to have a chain where there are\n> multiple coinbases with the same txid (mined pre-bip34), where the first\n> bip30 violation would be after the bip34 activation height, because the\n> coinbases didn't overwrite each other. This in turn could prevent reorging\n> back to the honest chain. NACK.\n>\n> Ã¢ÂÂ\n> You are receiving this because you authored the thread.\n> Reply to this email directly, view it on GitHub\n> <https://github.com/bitcoin/bitcoin/pull/11427#issuecomment-333396501>,\n> or mute the thread\n> <https://github.com/notifications/unsubscribe-auth/AA9jSkF5wksLWayT_gw9awHBpyTdZX8fks5sn9qLgaJpZM4PpjbI>\n> .\n>\n",
      "created_at" : "2017-10-02T09:25:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11427#issuecomment-333483647",
      "id" : 333483647,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11427",
      "updated_at" : "2017-10-02T09:25:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/333483647",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1008458?v=4",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@jtimon , say I start from genesis block. Since BIP34 is not checked before BIP34Height, I could make a pre-BIP34 coinbase transaction that includes a post-BIP34Height value in scriptSig, and is perfectly valid. After BIP34Height, with this PR, BIP30 is disabled, so I could replay the same pre-BIP34 coinbase tx.\r\n\r\n@sdaftuar thanks for pointing out. I missed it.",
      "created_at" : "2017-10-02T10:21:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11427#issuecomment-333495761",
      "id" : 333495761,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11427",
      "updated_at" : "2017-10-02T10:21:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/333495761",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/8403418?v=4",
         "events_url" : "https://api.github.com/users/jl2012/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jl2012/followers",
         "following_url" : "https://api.github.com/users/jl2012/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jl2012/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jl2012",
         "id" : 8403418,
         "login" : "jl2012",
         "organizations_url" : "https://api.github.com/users/jl2012/orgs",
         "received_events_url" : "https://api.github.com/users/jl2012/received_events",
         "repos_url" : "https://api.github.com/users/jl2012/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jl2012/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jl2012/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jl2012"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> say I start from genesis block\r\n\r\nThe genesis block never needs to be checked.\r\n\r\n> After BIP34Height, with this PR, BIP30 is disabled, so I could replay the same pre-BIP34 coinbase tx.\r\n\r\nNot after this PR, after BIP34Height bip30 is always disabled (assuming no huge reorg, an assumption buried deployments is doing for bip34 already anyway).\r\n\r\n> Since BIP34 is not checked before BIP34Height, I could make a pre-BIP34 coinbase transaction that includes a post-BIP34Height value in scriptSig, and is perfectly valid. \r\n\r\nThis is assuming a huge reorg. Otherwise, how can you do this if all pre-bip34 blocks were mined long ago?\r\n\r\n",
      "created_at" : "2017-10-02T10:46:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11427#issuecomment-333500428",
      "id" : 333500428,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11427",
      "updated_at" : "2017-10-02T10:46:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/333500428",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1008458?v=4",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@jtimon : I mean I start from block 1. Say I make a new block 1 with a post-BIP34 height written in the coinbase. It is valid. Now with this PR this tx could be replayed after BIP34 height. Of course I need a quantum computer to rewrite the chain. But the point is this PR is redefining the consensus and could create a situation where BIP30 is bypassed.",
      "created_at" : "2017-10-02T10:53:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11427#issuecomment-333501712",
      "id" : 333501712,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11427",
      "updated_at" : "2017-10-02T10:53:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/333501712",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/8403418?v=4",
         "events_url" : "https://api.github.com/users/jl2012/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jl2012/followers",
         "following_url" : "https://api.github.com/users/jl2012/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jl2012/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jl2012",
         "id" : 8403418,
         "login" : "jl2012",
         "organizations_url" : "https://api.github.com/users/jl2012/orgs",
         "received_events_url" : "https://api.github.com/users/jl2012/received_events",
         "repos_url" : "https://api.github.com/users/jl2012/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jl2012/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jl2012/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jl2012"
      }
   }
]
