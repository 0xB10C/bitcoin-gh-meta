[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Ping @jnewbery, @ryanofsky and @TheBlueMatt.",
      "created_at" : "2017-10-04T22:38:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11452#issuecomment-334309961",
      "id" : 334309961,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11452",
      "updated_at" : "2017-10-04T22:38:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/334309961",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11452#discussion_r142842750"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11452"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/142842750"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I found 'subscribe' a bit misleading here, though it could be that I'm thinking too much.\r\nIt's not merely a standard ZeroMQ subscription; the ZMQSubscriber class created tracks sequence. As it's written, my immediate thought was 'why aren't we just doing `self.subscribe(\"\")`' (pre this commit, the four setsockopt calls could have been replaced with just one).\r\nPerhaps 'create_subscriber' or fluffing up the comment a bit.",
      "commit_id" : "db3b646bac37a54cb09f121b048fcfbb6d522808",
      "created_at" : "2017-10-05T03:48:15Z",
      "diff_hunk" : "@@ -33,121 +57,68 @@ def setup_nodes(self):\n         if not config[\"components\"].getboolean(\"ENABLE_ZMQ\"):\n             raise SkipTest(\"bitcoind has not been built with zmq enabled.\")\n \n-        self.zmqContext = zmq.Context()\n-        self.zmqSubSocket = self.zmqContext.socket(zmq.SUB)\n-        self.zmqSubSocket.set(zmq.RCVTIMEO, 60000)\n-        self.zmqSubSocket.setsockopt(zmq.SUBSCRIBE, b\"hashblock\")\n-        self.zmqSubSocket.setsockopt(zmq.SUBSCRIBE, b\"hashtx\")\n-        self.zmqSubSocket.setsockopt(zmq.SUBSCRIBE, b\"rawblock\")\n-        self.zmqSubSocket.setsockopt(zmq.SUBSCRIBE, b\"rawtx\")\n-        ip_address = \"tcp://127.0.0.1:28332\"\n-        self.zmqSubSocket.connect(ip_address)\n-        self.extra_args = [['-zmqpubhashblock=%s' % ip_address, '-zmqpubhashtx=%s' % ip_address,\n-                       '-zmqpubrawblock=%s' % ip_address, '-zmqpubrawtx=%s' % ip_address], []]\n+        # Initialize ZMQ context and socket.\n+        # At the moment all messages are received in the same socket which means\n+        # that this test fails if the publishing order changes.\n+        # Note that the publishing order is not defined in the documentation and\n+        # is subject to change.\n+        self.zmq_context = zmq.Context()\n+        self.socket = self.zmq_context.socket(zmq.SUB)\n+        self.socket.set(zmq.RCVTIMEO, 60000)\n+        self.socket.connect(self.address)\n+\n+        # Subscribe to all available topics.\n+        self.subscribe(\"hashblock\")\n+        self.subscribe(\"hashtx\")\n+        self.subscribe(\"rawblock\")\n+        self.subscribe(\"rawtx\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11452#discussion_r142842750",
      "id" : 142842750,
      "original_commit_id" : "db3b646bac37a54cb09f121b048fcfbb6d522808",
      "original_position" : 81,
      "path" : "test/functional/zmq_test.py",
      "position" : 81,
      "pull_request_review_id" : 67263302,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11452",
      "updated_at" : "2017-10-05T04:00:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/142842750",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7999704?v=4",
         "events_url" : "https://api.github.com/users/esotericnonsense/events{/privacy}",
         "followers_url" : "https://api.github.com/users/esotericnonsense/followers",
         "following_url" : "https://api.github.com/users/esotericnonsense/following{/other_user}",
         "gists_url" : "https://api.github.com/users/esotericnonsense/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/esotericnonsense",
         "id" : 7999704,
         "login" : "esotericnonsense",
         "organizations_url" : "https://api.github.com/users/esotericnonsense/orgs",
         "received_events_url" : "https://api.github.com/users/esotericnonsense/received_events",
         "repos_url" : "https://api.github.com/users/esotericnonsense/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/esotericnonsense/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/esotericnonsense/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/esotericnonsense"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11452#discussion_r142842981"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11452"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/142842981"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The subscribers don't actually have independent sockets, perhaps just use self.socket?",
      "commit_id" : "db3b646bac37a54cb09f121b048fcfbb6d522808",
      "created_at" : "2017-10-05T03:51:12Z",
      "diff_hunk" : "@@ -13,9 +13,33 @@\n                                  hash256,\n                                 )\n \n+class ZMQSubscriber:\n+    def __init__(self, socket, address):\n+        self.address = address\n+        self.socket = socket\n+        self.sequence = 0\n+\n class ZMQTest (BitcoinTestFramework):\n     def set_test_params(self):\n+        self.address = \"tcp://127.0.0.1:28332\"\n+        self.num_blocks = 5\n         self.num_nodes = 2\n+        self.subscribers = {}\n+\n+    def subscribe(self, type):\n+        import zmq\n+        self.socket.setsockopt(zmq.SUBSCRIBE, type.encode('latin-1'))\n+        self.subscribers[type] = ZMQSubscriber(self.socket, self.address)\n+\n+    def receive(self, type):\n+        subscriber = self.subscribers[type]\n+        topic, body, seq = subscriber.socket.recv_multipart()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11452#discussion_r142842981",
      "id" : 142842981,
      "original_commit_id" : "db3b646bac37a54cb09f121b048fcfbb6d522808",
      "original_position" : 33,
      "path" : "test/functional/zmq_test.py",
      "position" : 33,
      "pull_request_review_id" : 67263302,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11452",
      "updated_at" : "2017-10-05T04:00:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/142842981",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7999704?v=4",
         "events_url" : "https://api.github.com/users/esotericnonsense/events{/privacy}",
         "followers_url" : "https://api.github.com/users/esotericnonsense/followers",
         "following_url" : "https://api.github.com/users/esotericnonsense/following{/other_user}",
         "gists_url" : "https://api.github.com/users/esotericnonsense/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/esotericnonsense",
         "id" : 7999704,
         "login" : "esotericnonsense",
         "organizations_url" : "https://api.github.com/users/esotericnonsense/orgs",
         "received_events_url" : "https://api.github.com/users/esotericnonsense/received_events",
         "repos_url" : "https://api.github.com/users/esotericnonsense/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/esotericnonsense/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/esotericnonsense/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/esotericnonsense"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11452#discussion_r142843513"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11452"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/142843513"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: assert_receive? My initial thought was that you're selectively receiving a type (which makes sense if different sockets, but if the sockets are all identical, you get what you're given, as this code tests)",
      "commit_id" : "db3b646bac37a54cb09f121b048fcfbb6d522808",
      "created_at" : "2017-10-05T03:58:18Z",
      "diff_hunk" : "@@ -13,9 +13,33 @@\n                                  hash256,\n                                 )\n \n+class ZMQSubscriber:\n+    def __init__(self, socket, address):\n+        self.address = address\n+        self.socket = socket\n+        self.sequence = 0\n+\n class ZMQTest (BitcoinTestFramework):\n     def set_test_params(self):\n+        self.address = \"tcp://127.0.0.1:28332\"\n+        self.num_blocks = 5\n         self.num_nodes = 2\n+        self.subscribers = {}\n+\n+    def subscribe(self, type):\n+        import zmq\n+        self.socket.setsockopt(zmq.SUBSCRIBE, type.encode('latin-1'))\n+        self.subscribers[type] = ZMQSubscriber(self.socket, self.address)\n+\n+    def receive(self, type):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11452#discussion_r142843513",
      "id" : 142843513,
      "original_commit_id" : "db3b646bac37a54cb09f121b048fcfbb6d522808",
      "original_position" : 31,
      "path" : "test/functional/zmq_test.py",
      "position" : 31,
      "pull_request_review_id" : 67263302,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11452",
      "updated_at" : "2017-10-05T04:00:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/142843513",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7999704?v=4",
         "events_url" : "https://api.github.com/users/esotericnonsense/events{/privacy}",
         "followers_url" : "https://api.github.com/users/esotericnonsense/followers",
         "following_url" : "https://api.github.com/users/esotericnonsense/following{/other_user}",
         "gists_url" : "https://api.github.com/users/esotericnonsense/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/esotericnonsense",
         "id" : 7999704,
         "login" : "esotericnonsense",
         "organizations_url" : "https://api.github.com/users/esotericnonsense/orgs",
         "received_events_url" : "https://api.github.com/users/esotericnonsense/received_events",
         "repos_url" : "https://api.github.com/users/esotericnonsense/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/esotericnonsense/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/esotericnonsense/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/esotericnonsense"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11452#discussion_r142843905"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11452"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/142843905"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Likely a pre-existing issue, on my box this prevents `python zmq_test.py` running in isolation (works through test_runner because the option already exists). If you wrap it e.g. `os.path.abspath(os.path.dirname(__file__))` (as test_runner.py does) it works.",
      "commit_id" : "db3b646bac37a54cb09f121b048fcfbb6d522808",
      "created_at" : "2017-10-05T04:03:39Z",
      "diff_hunk" : "@@ -24,7 +48,7 @@ def setup_nodes(self):\n         except ImportError:\n             raise SkipTest(\"python3-zmq module not available.\")\n \n-        # Check that bitcoin has been built with ZMQ enabled\n+        # Check that bitcoin has been built with ZMQ enabled.\n         config = configparser.ConfigParser()\n         if not self.options.configfile:\n             self.options.configfile = os.path.dirname(__file__) + \"/../config.ini\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11452#discussion_r142843905",
      "id" : 142843905,
      "original_commit_id" : "db3b646bac37a54cb09f121b048fcfbb6d522808",
      "original_position" : 51,
      "path" : "test/functional/zmq_test.py",
      "position" : 51,
      "pull_request_review_id" : 67264458,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11452",
      "updated_at" : "2017-10-05T04:05:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/142843905",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7999704?v=4",
         "events_url" : "https://api.github.com/users/esotericnonsense/events{/privacy}",
         "followers_url" : "https://api.github.com/users/esotericnonsense/followers",
         "following_url" : "https://api.github.com/users/esotericnonsense/following{/other_user}",
         "gists_url" : "https://api.github.com/users/esotericnonsense/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/esotericnonsense",
         "id" : 7999704,
         "login" : "esotericnonsense",
         "organizations_url" : "https://api.github.com/users/esotericnonsense/orgs",
         "received_events_url" : "https://api.github.com/users/esotericnonsense/received_events",
         "repos_url" : "https://api.github.com/users/esotericnonsense/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/esotericnonsense/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/esotericnonsense/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/esotericnonsense"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Tested ACK db3b646bac37a54cb09f121b048fcfbb6d522808, few nits above.",
      "created_at" : "2017-10-05T04:05:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11452#issuecomment-334353048",
      "id" : 334353048,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11452",
      "updated_at" : "2017-10-05T04:05:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/334353048",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7999704?v=4",
         "events_url" : "https://api.github.com/users/esotericnonsense/events{/privacy}",
         "followers_url" : "https://api.github.com/users/esotericnonsense/followers",
         "following_url" : "https://api.github.com/users/esotericnonsense/following{/other_user}",
         "gists_url" : "https://api.github.com/users/esotericnonsense/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/esotericnonsense",
         "id" : 7999704,
         "login" : "esotericnonsense",
         "organizations_url" : "https://api.github.com/users/esotericnonsense/orgs",
         "received_events_url" : "https://api.github.com/users/esotericnonsense/received_events",
         "repos_url" : "https://api.github.com/users/esotericnonsense/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/esotericnonsense/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/esotericnonsense/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/esotericnonsense"
      }
   }
]
