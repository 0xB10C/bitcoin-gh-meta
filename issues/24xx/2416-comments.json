[
   {
      "body" : "Did you use a clean datadir or an old 0.7 datadir with the old block-storage? Perhaps there is problem with upgrading to 0.8 format?",
      "created_at" : "2013-03-28T08:06:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/2416#issuecomment-15572824",
      "id" : 15572824,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2416",
      "updated_at" : "2013-03-28T08:06:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/15572824",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "body" : "As bitcoin doesn't upgrade database by default (without -loadblock= arguments), this shouldn't be an issue IMO.\r\n\r\nI just tried with ~/.bitcoin moved out of the way, but I'm still hitting the same assertion.  Are there any other leftovers from 0.7 other than ~/.bitcoin that need to be taken care of?\r\n",
      "created_at" : "2013-03-28T08:50:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/2416#issuecomment-15573986",
      "id" : 15573986,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2416",
      "updated_at" : "2013-03-28T08:50:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/15573986",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/665506?v=3",
         "events_url" : "https://api.github.com/users/dvdkhlng/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dvdkhlng/followers",
         "following_url" : "https://api.github.com/users/dvdkhlng/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dvdkhlng/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dvdkhlng",
         "id" : 665506,
         "login" : "dvdkhlng",
         "organizations_url" : "https://api.github.com/users/dvdkhlng/orgs",
         "received_events_url" : "https://api.github.com/users/dvdkhlng/received_events",
         "repos_url" : "https://api.github.com/users/dvdkhlng/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dvdkhlng/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dvdkhlng/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dvdkhlng"
      }
   },
   {
      "body" : "@sipa Can you have a look at that seems LevelDB related.",
      "created_at" : "2013-04-02T15:49:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/2416#issuecomment-15783617",
      "id" : 15783617,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2416",
      "updated_at" : "2013-04-02T15:49:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/15783617",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "body" : "Same problem with bitcoin 0.8.3\r\n\r\nbitcoind: ./db/skiplist.h:152: leveldb::SkipList<Key, Comparator>::Node* leveldb::SkipList<Key, Comparator>::Node::Next(int) [with Key = const char*, Comparator = leveldb::MemTable::KeyComparator]: Assertion `n >= 0' failed.\r\n\r\nI'd really like to eventually upgrade to to the 0.8 branch... :/",
      "created_at" : "2013-08-19T07:13:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/2416#issuecomment-22854361",
      "id" : 22854361,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2416",
      "updated_at" : "2013-08-19T07:13:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/22854361",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/665506?v=3",
         "events_url" : "https://api.github.com/users/dvdkhlng/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dvdkhlng/followers",
         "following_url" : "https://api.github.com/users/dvdkhlng/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dvdkhlng/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dvdkhlng",
         "id" : 665506,
         "login" : "dvdkhlng",
         "organizations_url" : "https://api.github.com/users/dvdkhlng/orgs",
         "received_events_url" : "https://api.github.com/users/dvdkhlng/received_events",
         "repos_url" : "https://api.github.com/users/dvdkhlng/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dvdkhlng/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dvdkhlng/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dvdkhlng"
      }
   },
   {
      "body" : "This is almost certainly due to missing mips atomics in leveldb: https://code.google.com/p/leveldb/issues/detail?id=104&q=mips\r\n\r\nFrom the looks, Debian attempted to patch some in, but didn't fare so well. Seems the gcc intrinsics should suffice for a hammer solution.",
      "created_at" : "2013-09-16T22:48:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/2416#issuecomment-24551220",
      "id" : 24551220,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2416",
      "updated_at" : "2013-09-16T22:48:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/24551220",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "That thought already crossed my mind, but then looking at atomic_pointer.h, it seems the CPU-specific implementations only deal with memory ordering semantics.  On my _single-core_ MIPS system, there should be no problems WRT memory ordering when accessing the same 4-byte quantity from different threads.  The only problem could be GCC introducing memory ordering issues due to read/write reordering on code optimization.  But compiling with -Os should have removed any such issues for class AtomicPointer (by keeping all accesses cleanly in non-inlined functions).  \r\n\r\nNote that compiliation is already setting -DLEVELDB_CSTDATOMIC_PRESENT, how likely is it that <cstdatomic> is broken on MIPS? \r\n\r\nStill, going to run some more tests...",
      "created_at" : "2013-09-16T23:23:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/2416#issuecomment-24552992",
      "id" : 24552992,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2416",
      "updated_at" : "2013-09-16T23:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/24552992",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/665506?v=3",
         "events_url" : "https://api.github.com/users/dvdkhlng/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dvdkhlng/followers",
         "following_url" : "https://api.github.com/users/dvdkhlng/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dvdkhlng/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dvdkhlng",
         "id" : 665506,
         "login" : "dvdkhlng",
         "organizations_url" : "https://api.github.com/users/dvdkhlng/orgs",
         "received_events_url" : "https://api.github.com/users/dvdkhlng/received_events",
         "repos_url" : "https://api.github.com/users/dvdkhlng/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dvdkhlng/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dvdkhlng/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dvdkhlng"
      }
   },
   {
      "body" : "@dvdkhlng I was under the assumption that stdatomic wasn't present in your toolchain and you took the debian patch, sounds like that's not the case. Either way, I think skiplist_test would be a good next step, if you haven't tried that already.",
      "created_at" : "2013-09-16T23:27:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/2416#issuecomment-24553230",
      "id" : 24553230,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2416",
      "updated_at" : "2013-09-16T23:27:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/24553230",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "@theuni: looks like you are right, it's a atomic operations problem.  cstdatomic is either broken with the Debian Mipsel Squeeze toolchain or the leveldb code does uses it in a broken way.\r\n\r\nImplementing MemoryBarrier as \r\n\r\n  __asm__ volatile (\"\" : : : \"memory\");\r\n\r\nmakes bitcoin work for me.  The proper implementation for those newer multi-core MIPSes (Loongson 3A, Octeon etc.) should be :\r\n\r\n  __asm__ volatile (\"sync\" : : : \"memory\");\r\n\r\nThis version is curently running here, though on a single-core system there shouldn't be any perceivable difference.\r\n\r\nTo make the implementation somewhat portable across Linux distributions, we might have to change that into:\r\n\r\n  __asm__ volatile (\".int 0x0f\" : : : \"memory\");\r\n\r\nThis generates the same code, but doesn't rely on GNU As to parse the 'sync' mnemonic.  GNU As will only allow sync opcode assembly when MIPS III or newer architecture was specified via GCC march= switch.  However on Debian Mips, default settings compile for Mips1 only, to support all the older gear.\r\n\r\nNow on old Mips1 CPUs, leveldb would SIGILL at runtime, but then those old CPUs may not be capable to keep up with the Bitcoin network's load anyways.  All recently manufactured MIPS CPUs/SoCs I know of support at least the MIPS III instructions (most should do MIPS32r2, Loongson 2f is very backwards in only supporting MIPS III, but that's due to patents).\r\n\r\nA proper patch would look like this:\r\n\r\n```diff\r\nIndex: bitcoin-0.8.5-linux/src/src/leveldb/port/atomic_pointer.h\r\n===================================================================\r\n--- bitcoin-0.8.5-linux.orig/src/src/leveldb/port/atomic_pointer.h      2013-09-12 12:43:31.000000000 +0200\r\n+++ bitcoin-0.8.5-linux/src/src/leveldb/port/atomic_pointer.h   2013-09-18 04:24:17.358004348 +0200\r\n@@ -68,6 +68,18 @@\r\n }\r\n #define LEVELDB_HAVE_MEMORY_BARRIER\r\n \r\n+// Gcc on MIPS\r\n+#elif defined(__mips) && defined(__GNUC__)\r\n+inline void MemoryBarrier() {\r\n+   /* Actually a 'sync' instruction, though that can only be assembled\r\n+      with the right -march= switch present, so compilation would fail with\r\n+      default GCC options on Debian-Mipsel (which compiles for Mips1 per\r\n+      default) */\r\n+  __asm__ __volatile__(\".int 0x0000000f\" : : : \"memory\");\r\n+}\r\n+#warning \"Mips detected\"\r\n+#define LEVELDB_HAVE_MEMORY_BARRIER\r\n+\r\n // Mac OS\r\n #elif defined(OS_MACOSX)\r\n inline void MemoryBarrier() {\r\n```",
      "created_at" : "2013-09-18T02:50:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/2416#issuecomment-24637669",
      "id" : 24637669,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2416",
      "updated_at" : "2013-09-18T02:50:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/24637669",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/665506?v=3",
         "events_url" : "https://api.github.com/users/dvdkhlng/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dvdkhlng/followers",
         "following_url" : "https://api.github.com/users/dvdkhlng/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dvdkhlng/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dvdkhlng",
         "id" : 665506,
         "login" : "dvdkhlng",
         "organizations_url" : "https://api.github.com/users/dvdkhlng/orgs",
         "received_events_url" : "https://api.github.com/users/dvdkhlng/received_events",
         "repos_url" : "https://api.github.com/users/dvdkhlng/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dvdkhlng/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dvdkhlng/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dvdkhlng"
      }
   },
   {
      "body" : "Note WRT my comment above: Markdown ate the underscores around th asm keywords.  Should be\r\n\r\n    __asm__\r\n\r\n(somehow Github doesn't allow me to edit my comment above, maybe Debian Mipsel's Firefox is too old ? :)",
      "created_at" : "2013-09-18T02:53:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/2416#issuecomment-24637747",
      "id" : 24637747,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2416",
      "updated_at" : "2013-09-18T02:53:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/24637747",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/665506?v=3",
         "events_url" : "https://api.github.com/users/dvdkhlng/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dvdkhlng/followers",
         "following_url" : "https://api.github.com/users/dvdkhlng/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dvdkhlng/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dvdkhlng",
         "id" : 665506,
         "login" : "dvdkhlng",
         "organizations_url" : "https://api.github.com/users/dvdkhlng/orgs",
         "received_events_url" : "https://api.github.com/users/dvdkhlng/received_events",
         "repos_url" : "https://api.github.com/users/dvdkhlng/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dvdkhlng/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dvdkhlng/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dvdkhlng"
      }
   },
   {
      "body" : "@dvdkhlng Nice sleuthing. Though now that the issue is nailed down, I'd suggest taking it upstream. I'm not sure that the bitcoin devs would be interested in carrying this.\r\n\r\nPerhaps you could ping the leveldb devs on the bug report above?",
      "created_at" : "2013-09-18T06:38:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/2416#issuecomment-24643934",
      "id" : 24643934,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2416",
      "updated_at" : "2013-09-18T06:38:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/24643934",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "Agree with @theuni, this issue should be taken upstream. We use libraries such as boost and leveldb to not have to bother with architecture-specific details, and going into mips assembly is just a step to far.\r\nWe don't have any way to test this either.\r\n",
      "created_at" : "2013-10-24T11:03:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/2416#issuecomment-26983308",
      "id" : 26983308,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2416",
      "updated_at" : "2013-10-24T11:03:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/26983308",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   }
]
