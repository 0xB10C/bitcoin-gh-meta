[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5863#discussion_r25995924"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5863"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/25995924"
         }
      },
      "body" : "Comment is outdated now.",
      "commit_id" : "715bc7a244fa6b1bbfb2554d295f07c5de016ecf",
      "created_at" : "2015-03-07T13:17:45Z",
      "diff_hunk" : "@@ -2132,15 +2137,21 @@ static CBlockIndex* FindMostWorkChain() {\n         CBlockIndex *pindexTest = pindexNew;\n         bool fInvalidAncestor = false;\n         while (pindexTest && !chainActive.Contains(pindexTest)) {\n-            assert(pindexTest->nStatus & BLOCK_HAVE_DATA);\n             assert(pindexTest->nChainTx || pindexTest->nHeight == 0);\n-            if (pindexTest->nStatus & BLOCK_FAILED_MASK) {\n+\n+            // Pruned nodes may have entries in setBlockIndexCandidates for\n+            // which block files have been deleted.  Remove those as candidates\n+            // for the most work chain if we come across them; we can't switch\n+            // to a chain unless we have all the non-active-chain parent blocks.\n+            bool fFailedChain = pindexTest->nStatus & BLOCK_FAILED_MASK;\n+            if (fFailedChain || !(pindexTest->nStatus & BLOCK_HAVE_DATA)) {\n                 // Candidate has an invalid ancestor, remove entire chain from the set.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5863#discussion_r25995924",
      "id" : 25995924,
      "original_commit_id" : "715bc7a244fa6b1bbfb2554d295f07c5de016ecf",
      "original_position" : 45,
      "path" : "src/main.cpp",
      "position" : 45,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5863",
      "updated_at" : "2015-03-07T13:17:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/25995924",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5863#discussion_r25995941"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5863"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/25995941"
         }
      },
      "body" : "Style nit: { on the same line.",
      "commit_id" : "715bc7a244fa6b1bbfb2554d295f07c5de016ecf",
      "created_at" : "2015-03-07T13:20:06Z",
      "diff_hunk" : "@@ -2268,6 +2279,9 @@ bool ActivateBestChain(CValidationState &state, CBlock *pblock) {\n             uint256 hashNewTip = pindexNewTip->GetBlockHash();\n             // Relay inventory, but don't relay old inventory during initial block download.\n             int nBlockEstimate = Checkpoints::GetTotalBlocksEstimate();\n+            // Don't relay blocks if autopruning -- could cause a peer to try to download, resulting\n+            // in a stalled download if the block file is pruned before the request.\n+            if (nLocalServices & NODE_NETWORK)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5863#discussion_r25995941",
      "id" : 25995941,
      "original_commit_id" : "715bc7a244fa6b1bbfb2554d295f07c5de016ecf",
      "original_position" : 63,
      "path" : "src/main.cpp",
      "position" : 63,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5863",
      "updated_at" : "2015-03-07T13:20:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/25995941",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5863#discussion_r25995943"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5863"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/25995943"
         }
      },
      "body" : "Style nit: spaces around =",
      "commit_id" : "715bc7a244fa6b1bbfb2554d295f07c5de016ecf",
      "created_at" : "2015-03-07T13:20:20Z",
      "diff_hunk" : "@@ -2826,6 +2848,102 @@ bool AbortNode(const std::string &strMessage, const std::string &userMessage) {\n     return false;\n }\n \n+\n+/**\n+ * BLOCK PRUNING CODE (\"Autoprune\")\n+ */\n+\n+/* Calculate the amount of disk space the block & undo files currently use */\n+uint64_t CalculateCurrentUsage()\n+{\n+    uint64_t retval=0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5863#discussion_r25995943",
      "id" : 25995943,
      "original_commit_id" : "715bc7a244fa6b1bbfb2554d295f07c5de016ecf",
      "original_position" : 110,
      "path" : "src/main.cpp",
      "position" : 110,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5863",
      "updated_at" : "2015-03-07T13:20:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/25995943",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5863#discussion_r25995955"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5863"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/25995955"
         }
      },
      "body" : "This seems like a pretty normal condition during initial sync; does that require an unconditional log message?",
      "commit_id" : "715bc7a244fa6b1bbfb2554d295f07c5de016ecf",
      "created_at" : "2015-03-07T13:22:20Z",
      "diff_hunk" : "@@ -2826,6 +2848,102 @@ bool AbortNode(const std::string &strMessage, const std::string &userMessage) {\n     return false;\n }\n \n+\n+/**\n+ * BLOCK PRUNING CODE (\"Autoprune\")\n+ */\n+\n+/* Calculate the amount of disk space the block & undo files currently use */\n+uint64_t CalculateCurrentUsage()\n+{\n+    uint64_t retval=0;\n+    BOOST_FOREACH(const CBlockFileInfo &file, vinfoBlockFile) {\n+        retval += file.nSize + file.nUndoSize;\n+    }\n+    return retval;\n+}\n+\n+/* Prune (delete) a block file.  Returns true if a file was deleted, else false */\n+void PruneOneBlockFile(const int fileNumber)\n+{\n+    if (!fHavePruned) {\n+        AssertLockHeld(cs_main);\n+        pblocktree->WriteFlag(\"prunedblockfiles\", true);\n+        fHavePruned = true;\n+    }\n+    for (BlockMap::iterator it = mapBlockIndex.begin(); it != mapBlockIndex.end(); ++it) {\n+        CBlockIndex* pindex = it->second;\n+        if (pindex->nFile == fileNumber){\n+            pindex->nStatus &= ~BLOCK_HAVE_DATA;\n+            pindex->nStatus &= ~BLOCK_HAVE_UNDO;\n+            pindex->nFile = 0;\n+            pindex->nDataPos = 0;\n+            pindex->nUndoPos = 0;\n+            setDirtyBlockIndex.insert(pindex);\n+        }\n+    }\n+    CDiskBlockPos pos(fileNumber, 0);\n+    try \n+    {\n+        boost::filesystem::remove(GetBlockPosFilename(pos, \"blk\"));\n+        boost::filesystem::remove(GetBlockPosFilename(pos, \"rev\"));\n+    }\n+    catch (const std::runtime_error& e)\n+    {\n+        AbortNode(\"Fatal error removing block/undo file. Try running with -reindex\");\n+    }\n+\n+    vinfoBlockFile[fileNumber].SetNull();\n+    setDirtyFileInfo.insert(fileNumber);\n+}\n+\n+/**\n+ * Autoprune()\n+ *\n+ * nAdditionalBytes, if supplied, is the number of bytes that\n+ * are about to be allocated to write new blocks to disk.\n+ */\n+void Autoprune(uint64_t nAdditionalBytes)\n+{\n+    LOCK(cs_main);\n+    if (chainActive.Tip() == NULL || nAutopruneTarget == 0) {\n+        LogPrintf(\"Autoprune: No chain, or called when target=0.\\n\");\n+        return;\n+    }\n+    if (chainActive.Tip()->nHeight <= Params().AutopruneAfterHeight()) {\n+        LogPrintf(\"Autoprune: current height less than minimum height for pruning (%d).\\n\", Params().AutopruneAfterHeight());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5863#discussion_r25995955",
      "id" : 25995955,
      "original_commit_id" : "715bc7a244fa6b1bbfb2554d295f07c5de016ecf",
      "original_position" : 165,
      "path" : "src/main.cpp",
      "position" : 165,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5863",
      "updated_at" : "2015-03-07T13:22:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/25995955",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Looks good, overall. I wouldn't worry about the inefficient mapBlockIndex iteration for now, that can be improved later. I haven't tested yet.",
      "created_at" : "2015-03-07T13:30:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5863#issuecomment-77689327",
      "id" : 77689327,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5863",
      "updated_at" : "2015-03-07T13:30:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/77689327",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   }
]
