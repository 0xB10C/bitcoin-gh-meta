[
   {
      "body" : "What is a good way to test this in isolation, sans autoprune?\r\n",
      "created_at" : "2015-03-11T13:52:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5875#issuecomment-78266182",
      "id" : 78266182,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5875",
      "updated_at" : "2015-03-11T13:52:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/78266182",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "body" : "I don't know of a great answer to that question...  I have been separately working on creating a python p2p framework for testing, and I have a test coded up in that framework that exercises this code for blocks received on the network (I manually tested the -reindex case of reading blocks from disk).  If you'd like to take a look, you can see it in my repo at:\r\n\r\nhttps://github.com/sdaftuar/bitcoin/commit/9a013ed41fd07217675b78bbb55e13575f0bb4e1\r\n\r\nThe test is called accept-block-test.py (run it with \"--testbinary=path-to-bitcoind\", with and without the \"--whitelist\" argument, to cover both cases).\r\n\r\nI think the test itself is a reasonable length but it builds on a lot of code that is still a work in progress, so I'm not sure how useful this is as a reference.  But if you do take a look at this, I'd certainly welcome any feedback you have on the testing framework itself.",
      "created_at" : "2015-03-11T19:52:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5875#issuecomment-78357016",
      "id" : 78357016,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5875",
      "updated_at" : "2015-03-11T19:52:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/78357016",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5875#discussion_r26299197"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5875"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/26299197"
         }
      },
      "body" : "I think the BLOCK_HAVE_DATA test can remain here: there's no point storing a block for which we already have the data.",
      "commit_id" : "53a39c5f9b43ba56dfaae0f86b0971389ffdc3b3",
      "created_at" : "2015-03-12T13:08:41Z",
      "diff_hunk" : "@@ -2706,9 +2709,9 @@ bool AcceptBlock(CBlock& block, CValidationState& state, CBlockIndex** ppindex,\n     if (!AcceptBlockHeader(block, state, &pindex))\n         return false;\n \n-    if (pindex->nStatus & BLOCK_HAVE_DATA) {\n-        // TODO: deal better with duplicate blocks.\n-        // return state.DoS(20, error(\"AcceptBlock(): already have block %d %s\", pindex->nHeight, pindex->GetBlockHash().ToString()), REJECT_DUPLICATE, \"duplicate\");\n+    if (!fRequested && (pindex->nTx != 0 || pindex->nChainWork <= chainActive.Tip()->nChainWork)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5875#discussion_r26299197",
      "id" : 26299197,
      "original_commit_id" : "f0d6cef4821ad718579ece5a47f22c1ed78eb024",
      "original_position" : 36,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5875",
      "updated_at" : "2015-03-12T16:02:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/26299197",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Concept ACK. I think it should be safe to even never process unrequested blocks, but things like @TheBlueMatt's fast relayer would probably stop working without it.",
      "created_at" : "2015-03-12T13:14:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5875#issuecomment-78476572",
      "id" : 78476572,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5875",
      "updated_at" : "2015-03-12T13:14:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/78476572",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Fixed to re-include the BLOCK_HAVE_DATA check as well.",
      "created_at" : "2015-03-12T16:02:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5875#issuecomment-78510610",
      "id" : 78510610,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5875",
      "updated_at" : "2015-03-12T16:02:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/78510610",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5875#discussion_r26692454"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5875"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/26692454"
         }
      },
      "body" : "Can this be rewritten to make the logic clearer?  Something like:\r\n```\r\nbool fAlreadyHave = (pindex->nStatus & BLOCK_HAVE_DATA);\r\nbool fHasMoreWork = (pindex->nChainWork > chainActive.Tip()->nChainWork);\r\n\r\nif (fAlreadyHave) return true;\r\nif (!fRequested) { // If we didn't ask for it:\r\n   if (pindex->nTx != 0) return true; <-- what is this condition?\r\n   if (!fHasMoreWork) return true; // don't process less-work chains.\r\n}\r\n```\r\n",
      "commit_id" : "53a39c5f9b43ba56dfaae0f86b0971389ffdc3b3",
      "created_at" : "2015-03-18T18:27:39Z",
      "diff_hunk" : "@@ -2706,9 +2709,11 @@ bool AcceptBlock(CBlock& block, CValidationState& state, CBlockIndex** ppindex,\n     if (!AcceptBlockHeader(block, state, &pindex))\n         return false;\n \n-    if (pindex->nStatus & BLOCK_HAVE_DATA) {\n-        // TODO: deal better with duplicate blocks.\n-        // return state.DoS(20, error(\"AcceptBlock(): already have block %d %s\", pindex->nHeight, pindex->GetBlockHash().ToString()), REJECT_DUPLICATE, \"duplicate\");\n+    if ((pindex->nStatus & BLOCK_HAVE_DATA) ||\n+            (!fRequested && (pindex->nTx != 0 || pindex->nChainWork <= chainActive.Tip()->nChainWork))) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5875#discussion_r26692454",
      "id" : 26692454,
      "original_commit_id" : "53a39c5f9b43ba56dfaae0f86b0971389ffdc3b3",
      "original_position" : 37,
      "path" : "src/main.cpp",
      "position" : 37,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5875",
      "updated_at" : "2015-03-18T18:27:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/26692454",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "body" : "@sipa If the relayer is whitelisted it should still work?  I see this treats blocks from whitelisted peers as if they were requested.",
      "created_at" : "2015-03-25T10:39:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5875#issuecomment-85976773",
      "id" : 85976773,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5875",
      "updated_at" : "2015-03-25T10:39:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/85976773",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3501598?v=3",
         "events_url" : "https://api.github.com/users/spinza/events{/privacy}",
         "followers_url" : "https://api.github.com/users/spinza/followers",
         "following_url" : "https://api.github.com/users/spinza/following{/other_user}",
         "gists_url" : "https://api.github.com/users/spinza/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/spinza",
         "id" : 3501598,
         "login" : "spinza",
         "organizations_url" : "https://api.github.com/users/spinza/orgs",
         "received_events_url" : "https://api.github.com/users/spinza/received_events",
         "repos_url" : "https://api.github.com/users/spinza/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/spinza/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/spinza/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/spinza"
      }
   },
   {
      "body" : "Is there no better way to check if we would want to request this block before we just ignore it? It seems to me that it is not ideal that we would jsut ignore data we get from a peer because they're using a /very/ loose interpretation of the protocol.",
      "created_at" : "2015-03-26T10:48:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5875#issuecomment-86449470",
      "id" : 86449470,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5875",
      "updated_at" : "2015-03-26T10:48:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/86449470",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "@TheBlueMatt I've thought about that a bit; I was concerned about that as well.  I believe the test we'd like to perform is whether the block we're processing is on some headers chain that is further along than our tip -- if so, we should process it (because this is a block that we'd like to download).  The options I could think of to try calculating that, using our existing data structures, are:\r\n\r\n1) Walk every entry in mapBlockIndex and calculate exactly whether this block is the ancestor of a header with more work than our tip.\r\n2) Loop over all our peers to see if we would try to download this block from one of them (using what we know about each peer's headers chain).\r\n3) Look specifically at the one peer who sent us this block to see if we would try to download this from them \r\n\r\nI didn't think any of these solutions really made sense.  1 seems too slow, and both 2 and 3 are approximations for what we're interested in to begin with, so iterating over all peers as in 2 seemed too costly to me for this approximate optimization.  3 seems to catch too narrow a case to be worth it.  If we had a data structure that was already keeping track of headers that are further along than our tip, then that would be nice to use here...  Not sure it would make sense to create and maintain such a structure solely for this though.\r\n\r\nRegarding peers that are only loosely respecting the network protocol -- that's why I thought adding an allowance for whitelisted peers made sense, so that unusual peers that are known to you can still have their blocks processed.  On the other hand, if we're connecting to an unknown peer that is behaving oddly, how much effort should we expend to differentiate that peer's behavior from an attacker's?",
      "created_at" : "2015-03-26T17:20:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5875#issuecomment-86630759",
      "id" : 86630759,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5875",
      "updated_at" : "2015-03-26T17:20:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/86630759",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   }
]
