[
   {
      "body" : "I've also noticed this. There seems to be heavy lock contention during some of the synchronization phases. This causes e.g. RPC to react slowly. Also other peers sometimes completely time out. Not only during initial sync, but also when catching up a significant number of blocks.\r\n",
      "created_at" : "2015-05-18T09:00:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/5851#issuecomment-102981306",
      "id" : 102981306,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5851",
      "updated_at" : "2015-05-18T10:01:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/102981306",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Made a little progress on finding out why the GUI hangs during intensive catch-up phases. Indeed, `cs_main` is held for a longer time. The GUI does not wait on `cs_main` during normal operation, however when it receives a new transaction\r\n\r\n    2015-05-29 06:48:46 AddToWallet xxx  new\r\n\r\nIt will try to get the transaction information from the wallet in `qt/transactiontablemodel.cpp:130`, which takes both a `cs_main` and wallet lock. It can stay stuck there for minutes at a time. A possible solution is to copy the relevant data in the notification function.\r\n\r\nThis is fighting symptoms, but will lead to a more responsive UI. The root cause would be mitigated by changing `ActivateBestChain`/`ActivateBestChainStep`/`ConnectTip` logic to release the cs_main lock between attaching blocks.\r\n\r\n**Edit:** another consequence is that the block number and progress in the UI is not updated, as it never manages to get the `cs_main` lock (it polls a few times per second, with `TRY_LOCK`). The new-block notification path (`NotifyBlockTip` Ã¢ÂÂ `ClientModel`) should be restored, with rate limiting.\r\n\r\n",
      "created_at" : "2015-05-29T06:56:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/5851#issuecomment-106713148",
      "id" : 106713148,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5851",
      "updated_at" : "2015-05-29T07:06:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/106713148",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "ActivateBestChain releases cs_main between blocks, except during a reorg,\nto avoid exposing a worse state than before.\n",
      "created_at" : "2015-05-29T14:38:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/5851#issuecomment-106829957",
      "id" : 106829957,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5851",
      "updated_at" : "2015-05-29T14:38:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/106829957",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "I think the `cs_main` LOCK at `qt/transactiontablemodel.cpp:130` can be avoided.\r\n\r\nWhile re-writing most parts of the `CWalletTx` i think the problematic points are `CWalletTx::GetCredit()` mainly the `GetBlocksToMaturity()` which needs the chainActive (lock on cs_main) to get the current height. But only for coinbase wtxs.\r\n\r\nThe rest of `decomposeTransaction()` needs no cs_main locking IMO.",
      "created_at" : "2015-07-01T06:52:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/5851#issuecomment-117481924",
      "id" : 117481924,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5851",
      "updated_at" : "2015-07-01T06:52:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/117481924",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "Probably makes sense to store a copy of the best chain's tip CBlockIndex* pointer in the CWallet object, and update it through a signal mechanism. Credit/confirmation querying can then use the cached version instead of needing a lock every time",
      "created_at" : "2015-07-01T12:41:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/5851#issuecomment-117645095",
      "id" : 117645095,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5851",
      "updated_at" : "2015-07-01T12:41:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/117645095",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Yes. This would be a good way.\r\nThe new wallet does interact over a extra interface with main/mempool (https://github.com/jonasschnelli/bitcoin/blob/2015/05/corewallet/src/corewallet/coreinterface.cpp). This would be a starting point for optimizing locks and later separation into a own process.",
      "created_at" : "2015-07-01T13:06:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/5851#issuecomment-117658742",
      "id" : 117658742,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5851",
      "updated_at" : "2015-07-01T13:06:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/117658742",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "@MrKrzYch00 could you test if the problem still exists in the `0.11`?",
      "created_at" : "2015-07-08T19:46:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/5851#issuecomment-119710456",
      "id" : 119710456,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5851",
      "updated_at" : "2015-07-08T19:46:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/119710456",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7275704?v=3",
         "events_url" : "https://api.github.com/users/btcdrak/events{/privacy}",
         "followers_url" : "https://api.github.com/users/btcdrak/followers",
         "following_url" : "https://api.github.com/users/btcdrak/following{/other_user}",
         "gists_url" : "https://api.github.com/users/btcdrak/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/btcdrak",
         "id" : 7275704,
         "login" : "btcdrak",
         "organizations_url" : "https://api.github.com/users/btcdrak/orgs",
         "received_events_url" : "https://api.github.com/users/btcdrak/received_events",
         "repos_url" : "https://api.github.com/users/btcdrak/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/btcdrak/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/btcdrak/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/btcdrak"
      }
   },
   {
      "body" : "I will give it a try after I build myself newest commit. My latest build bases on d0a10c1959176eb40c0ec47a56de00820c59066d , which, I'm pretty sure, was still slowing down RPC (when I was 15h behind and run my PHP script to manually connect to selected IPs, after 3rd connection it started to response very sluggish). However to confirm loosing connections I would need to re-download block chain (I think?).\r\n\r\nAlso to be 100% sure I would need to note that I have one small error when building with gcc 4.9.4 (20150630 - prerelease; windows mingw) on /leveldb/util/env_win.cc file which tells me that _beginthread is undefined until I compile the file manually while omitting D_REENTRANT. Not sure what causes it and if it could have any impact on tests being correct... btw. my build is x64, uses Ofast and AVX instruction set tuning (including all dependencies, with one exception being O3 due to Ofast failing).\r\n\r\nEDIT: when I reported this issue I was using standard mingw toolchain with default build optimization but due to linker issues on other program being compiled I was forced to change gcc versions over time. The above gcc version and altered gcc switches were used only in my latest build based on commit mentioned above...",
      "created_at" : "2015-07-08T20:58:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/5851#issuecomment-119729102",
      "id" : 119729102,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5851",
      "updated_at" : "2015-07-08T21:08:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/119729102",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/11292594?v=3",
         "events_url" : "https://api.github.com/users/MrKrzYch00/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MrKrzYch00/followers",
         "following_url" : "https://api.github.com/users/MrKrzYch00/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MrKrzYch00/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MrKrzYch00",
         "id" : 11292594,
         "login" : "MrKrzYch00",
         "organizations_url" : "https://api.github.com/users/MrKrzYch00/orgs",
         "received_events_url" : "https://api.github.com/users/MrKrzYch00/received_events",
         "repos_url" : "https://api.github.com/users/MrKrzYch00/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MrKrzYch00/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MrKrzYch00/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MrKrzYch00"
      }
   },
   {
      "body" : "![bitcoin_core_first_synchronisation](https://cloud.githubusercontent.com/assets/11292594/8753863/51225d52-2cbf-11e5-935c-63d7ed4ba6b5.png)\r\n\r\n^ this is what happens when Bitcoin Core is checking blocks, the ping times raise a lot. My speed is ~1.5MB/s download and ~70KB/s upload (bytes).\r\n\r\nI will provide more detailed text log with php script I'm running to get current height, num of connections and time it took to get reply with this data from bitcoin core during first synchronization.",
      "created_at" : "2015-07-17T18:07:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/5851#issuecomment-122361025",
      "id" : 122361025,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5851",
      "updated_at" : "2015-07-17T18:07:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/122361025",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/11292594?v=3",
         "events_url" : "https://api.github.com/users/MrKrzYch00/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MrKrzYch00/followers",
         "following_url" : "https://api.github.com/users/MrKrzYch00/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MrKrzYch00/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MrKrzYch00",
         "id" : 11292594,
         "login" : "MrKrzYch00",
         "organizations_url" : "https://api.github.com/users/MrKrzYch00/orgs",
         "received_events_url" : "https://api.github.com/users/MrKrzYch00/received_events",
         "repos_url" : "https://api.github.com/users/MrKrzYch00/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MrKrzYch00/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MrKrzYch00/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MrKrzYch00"
      }
   },
   {
      "body" : "Full log at: http://4my.eu/first_synchronization_log.txt\r\nPHP-CLI script run for testing: http://4my.eu/bitcoin_core_test.txt\r\n\r\nUsing 2GB db cache, built with: Ofast, AVX and core i7 tuning, without debug. x64 build.\r\nRunning on core i7-3630QM 2.7Ghz, 8GB RAM. ~1.5MB/s download, ~70KB/s upload. Windows 8.1\r\nBuild last commit: fe3fe547f747b909f66a28cef6addfea3e1606e2.\r\nRPC Keep-alive connection with 60s timeout.\r\nThe connections were estabilished to 38 pool IPs and Core was set to not allow to/from other nodes connections.\r\n\r\nStarted with 38 connections, dropped to 14 soon after (guess to network lag) and finally ended up with 8. So I think it's not that bad, however, response times from RPC were exceeding 60s sometimes - two commands total as seen in php script. During very high response times BitCoin Core was using 60~80% CPU (counting usage for all cores).",
      "created_at" : "2015-07-18T14:58:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/5851#issuecomment-122550823",
      "id" : 122550823,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5851",
      "updated_at" : "2015-07-18T15:07:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/122550823",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/11292594?v=3",
         "events_url" : "https://api.github.com/users/MrKrzYch00/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MrKrzYch00/followers",
         "following_url" : "https://api.github.com/users/MrKrzYch00/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MrKrzYch00/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MrKrzYch00",
         "id" : 11292594,
         "login" : "MrKrzYch00",
         "organizations_url" : "https://api.github.com/users/MrKrzYch00/orgs",
         "received_events_url" : "https://api.github.com/users/MrKrzYch00/received_events",
         "repos_url" : "https://api.github.com/users/MrKrzYch00/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MrKrzYch00/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MrKrzYch00/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MrKrzYch00"
      }
   },
   {
      "body" : "@laanwj That also happens if you load an old wallet file and trigger a rescan, it will take longer than the ping message timeout and on completion all peers will have dropped you. Not an issue under any circumstance but it might explain why I've seen peers on the network not responding to messages occasionally. ",
      "created_at" : "2015-07-21T15:03:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/5851#issuecomment-123361995",
      "id" : 123361995,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5851",
      "updated_at" : "2015-07-21T15:03:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/123361995",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/13410470?v=3",
         "events_url" : "https://api.github.com/users/2083236893/events{/privacy}",
         "followers_url" : "https://api.github.com/users/2083236893/followers",
         "following_url" : "https://api.github.com/users/2083236893/following{/other_user}",
         "gists_url" : "https://api.github.com/users/2083236893/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/2083236893",
         "id" : 13410470,
         "login" : "2083236893",
         "organizations_url" : "https://api.github.com/users/2083236893/orgs",
         "received_events_url" : "https://api.github.com/users/2083236893/received_events",
         "repos_url" : "https://api.github.com/users/2083236893/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/2083236893/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/2083236893/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/2083236893"
      }
   },
   {
      "body" : "Partially addresses in #7112. Still, AddToWallet needs better lock handling.",
      "created_at" : "2015-11-27T10:37:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/5851#issuecomment-160109310",
      "id" : 160109310,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5851",
      "updated_at" : "2015-11-27T10:37:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/160109310",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   }
]
