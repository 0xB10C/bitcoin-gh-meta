[
   {
      "body" : "I've also noticed this. There seems to be heavy lock contention during some of the synchronization phases. This causes e.g. RPC to react slowly. Also other peers sometimes completely time out. Not only during initial sync, but also when catching up a significant number of blocks.\r\n",
      "created_at" : "2015-05-18T09:00:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/5851#issuecomment-102981306",
      "id" : 102981306,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5851",
      "updated_at" : "2015-05-18T10:01:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/102981306",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Made a little progress on finding out why the GUI hangs during intensive catch-up phases. Indeed, `cs_main` is held for a longer time. The GUI does not wait on `cs_main` during normal operation, however when it receives a new transaction\r\n\r\n    2015-05-29 06:48:46 AddToWallet xxx  new\r\n\r\nIt will try to get the transaction information from the wallet in `qt/transactiontablemodel.cpp:130`, which takes both a `cs_main` and wallet lock. It can stay stuck there for minutes at a time. A possible solution is to copy the relevant data in the notification function.\r\n\r\nThis is fighting symptoms, but will lead to a more responsive UI. The root cause would be mitigated by changing `ActivateBestChain`/`ActivateBestChainStep`/`ConnectTip` logic to release the cs_main lock between attaching blocks.\r\n\r\n**Edit:** another consequence is that the block number and progress in the UI is not updated, as it never manages to get the `cs_main` lock (it polls a few times per second, with `TRY_LOCK`). The new-block notification path (`NotifyBlockTip` Ã¢ÂÂ `ClientModel`) should be restored, with rate limiting.\r\n\r\n",
      "created_at" : "2015-05-29T06:56:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/5851#issuecomment-106713148",
      "id" : 106713148,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5851",
      "updated_at" : "2015-05-29T07:06:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/106713148",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "ActivateBestChain releases cs_main between blocks, except during a reorg,\nto avoid exposing a worse state than before.\n",
      "created_at" : "2015-05-29T14:38:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/5851#issuecomment-106829957",
      "id" : 106829957,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5851",
      "updated_at" : "2015-05-29T14:38:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/106829957",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "I think the `cs_main` LOCK at `qt/transactiontablemodel.cpp:130` can be avoided.\r\n\r\nWhile re-writing most parts of the `CWalletTx` i think the problematic points are `CWalletTx::GetCredit()` mainly the `GetBlocksToMaturity()` which needs the chainActive (lock on cs_main) to get the current height. But only for coinbase wtxs.\r\n\r\nThe rest of `decomposeTransaction()` needs no cs_main locking IMO.",
      "created_at" : "2015-07-01T06:52:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/5851#issuecomment-117481924",
      "id" : 117481924,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5851",
      "updated_at" : "2015-07-01T06:52:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/117481924",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "Probably makes sense to store a copy of the best chain's tip CBlockIndex* pointer in the CWallet object, and update it through a signal mechanism. Credit/confirmation querying can then use the cached version instead of needing a lock every time",
      "created_at" : "2015-07-01T12:41:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/5851#issuecomment-117645095",
      "id" : 117645095,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5851",
      "updated_at" : "2015-07-01T12:41:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/117645095",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Yes. This would be a good way.\r\nThe new wallet does interact over a extra interface with main/mempool (https://github.com/jonasschnelli/bitcoin/blob/2015/05/corewallet/src/corewallet/coreinterface.cpp). This would be a starting point for optimizing locks and later separation into a own process.",
      "created_at" : "2015-07-01T13:06:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/5851#issuecomment-117658742",
      "id" : 117658742,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5851",
      "updated_at" : "2015-07-01T13:06:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/117658742",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   }
]
