[
   {
      "author_association" : "MEMBER",
      "body" : "`./src/test/test_bitcoin -t net_peer_eviction_tests/peer_protection_test` runs about 10% faster for me on this branch, though it is a debug build and the unit tests use very low numbers of eviction candidates (between 4 and 24).  I'll write a test with higher numbers of eviction candidates and benchmark with optimized builds (and fix the fuzzer CI failure).",
      "created_at" : "2021-06-19T17:40:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22284#issuecomment-864441022",
      "id" : 864441022,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22284",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2NDQ0MTAyMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-19T17:40:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/864441022",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Added benchmarks. This pull speeds up `ProtectEvictionCandidatesByRatio()` between 2x and 6x for the benchmarked cases. It's not a hotspot, but the improvement is significant.\r\n\r\n\r\n```\r\n$ ./src/bench/bench_bitcoin -filter=EvictionProtection*.*\r\n```\r\n\r\nmaster\r\n\r\n```rake\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|    5,403,043,444.00 |                0.19 |    1.8% |     59.74 | `EvictionProtection1Network250Candidates`\r\n|    2,946,547,379.00 |                0.34 |    2.7% |     33.45 | `EvictionProtection3Networks050Candidates`\r\n|    2,798,691,071.00 |                0.36 |    2.2% |     30.79 | `EvictionProtection3Networks100Candidates`\r\n|    7,288,364,370.00 |                0.14 |    0.7% |     80.16 | `EvictionProtection3Networks250Candidates`\r\n```\r\n\r\nthis PR\r\n\r\n```rake\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|    1,183,198,205.00 |                0.85 |    1.2% |     13.12 | `EvictionProtection1Network250Candidates`\r\n|    1,151,709,186.00 |                0.87 |    1.7% |     12.67 | `EvictionProtection3Networks050Candidates`\r\n|    1,261,170,266.00 |                0.79 |    2.9% |     14.26 | `EvictionProtection3Networks100Candidates`\r\n|    1,157,625,808.00 |                0.86 |    1.0% |     12.95 | `EvictionProtection3Networks250Candidates`\r\n```\r\n\r\n------\r\n\r\n(intermediate commits)\r\n\r\n*p2p: iterate over eviction candidates once instead of thrice*\r\n\r\n```rake\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|    3,952,529,089.00 |                0.25 |    1.8% |     43.47 | `EvictionProtection1Network250Candidates`\r\n|    2,239,435,919.00 |                0.45 |    3.8% |     25.85 | `EvictionProtection3Networks050Candidates`\r\n|    2,060,389,113.00 |                0.49 |    1.9% |     22.85 | `EvictionProtection3Networks100Candidates`\r\n|    5,258,681,959.00 |                0.19 |    1.0% |     58.26 | `EvictionProtection3Networks250Candidates`\r\n```\r\n\r\n*p2p: iterate eviction protection only on networks having candidates*\r\n\r\n```rake\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|    1,224,597,989.00 |                0.82 |    2.2% |     13.60 | `EvictionProtection1Network250Candidates`\r\n```\r\n",
      "created_at" : "2021-06-20T14:39:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22284#issuecomment-864564794",
      "id" : 864564794,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22284",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2NDU2NDc5NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-20T15:26:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/864564794",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Tested on macOs 11.4 and this PR indeed optimize it by 1.3x to 5x. \r\n\r\n<details> \r\n<summary> Test result </summary>\r\n\r\nOn 272f327fbfcb8bb61f8e1c9d65c665372cd60976(master with benchmarks):\r\n```\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|      756,331,588.00 |                1.32 |    1.2% |      8.38 | `EvictionProtection1Network250Candidates`\r\n|    1,579,971,776.00 |                0.63 |    1.1% |     17.45 | `EvictionProtection3Networks050Candidates`\r\n|    1,395,431,168.00 |                0.72 |    1.0% |     15.70 | `EvictionProtection3Networks100Candidates`\r\n|    3,716,091,921.00 |                0.27 |    1.0% |     41.32 | `EvictionProtection3Networks250Candidates`\r\n```\r\nThis PR:\r\n```          \r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|      492,425,456.00 |                2.03 |    0.9% |      5.45 | `EvictionProtection1Network250Candidates`\r\n|      739,073,603.00 |                1.35 |    1.3% |      8.13 | `EvictionProtection3Networks050Candidates`\r\n|      937,281,186.00 |                1.07 |    0.7% |     10.38 | `EvictionProtection3Networks100Candidates`\r\n|      828,820,224.00 |                1.21 |    1.6% |      9.10 | `EvictionProtection3Networks250Candidates`\r\n```\r\n</details>\r\n\r\nNot sure if it is an issue on my side but I had to test with `./src/bench/bench_bitcoin -filter=\"EvictionProtection*.*\"`(quotes around regex) instead of the command provided by the PR description. ",
      "created_at" : "2021-06-20T15:18:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22284#issuecomment-864569995",
      "id" : 864569995,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22284",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2NDU2OTk5NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-20T15:18:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/864569995",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/49265907?v=4",
         "events_url" : "https://api.github.com/users/klementtan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/klementtan/followers",
         "following_url" : "https://api.github.com/users/klementtan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/klementtan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/klementtan",
         "id" : 49265907,
         "login" : "klementtan",
         "node_id" : "MDQ6VXNlcjQ5MjY1OTA3",
         "organizations_url" : "https://api.github.com/users/klementtan/orgs",
         "received_events_url" : "https://api.github.com/users/klementtan/received_events",
         "repos_url" : "https://api.github.com/users/klementtan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/klementtan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/klementtan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/klementtan"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #19377 by hebasto\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-06-20T17:24:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22284#issuecomment-864586340",
      "id" : 864586340,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22284",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2NDU4NjM0MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-24T13:40:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/864586340",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2021-06-22T16:22:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22284#issuecomment-866133352",
      "id" : 866133352,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22284",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2NjEzMzM1Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-22T16:22:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/866133352",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review @jarolrod!  If anyone else would like to review or ACK that would be great as this completes merged PR #21261.",
      "created_at" : "2021-06-26T18:18:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22284#issuecomment-869042211",
      "id" : 869042211,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22284",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2OTA0MjIxMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-26T18:18:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/869042211",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22284#discussion_r661275001"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22284"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/661275001"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This function already exists in `src/test/net_peer_eviction_tests.cpp`. Dedup:\r\n\r\n```diff\r\n    test: make GetRandomNodeEvictionCandidates() reusable\r\n\r\n    Move `GetRandomNodeEvictionCandidates()` from\r\n    `src/test/net_peer_eviction_tests.cpp` to `src/test/util/net.h` and\r\n    `src/test/util/net.cpp` so that it can be reused by other tests.\r\n\r\ndiff --git a/src/test/net_peer_eviction_tests.cpp b/src/test/net_peer_eviction_tests.cpp\r\nindex 4bfd487b86..5eb280b498 100644\r\n--- a/src/test/net_peer_eviction_tests.cpp\r\n+++ b/src/test/net_peer_eviction_tests.cpp\r\n@@ -14,34 +14,12 @@\r\n #include <optional>\r\n #include <unordered_set>\r\n #include <vector>\r\n\r\n BOOST_FIXTURE_TEST_SUITE(net_peer_eviction_tests, BasicTestingSetup)\r\n\r\n-std::vector<NodeEvictionCandidate> GetRandomNodeEvictionCandidates(const int n_candidates, FastRandomContext& random_context)\r\n-{\r\n-    std::vector<NodeEvictionCandidate> candidates;\r\n-    for (int id = 0; id < n_candidates; ++id) {\r\n-        candidates.push_back({\r\n-            /* id */ id,\r\n-            /* nTimeConnected */ static_cast<int64_t>(random_context.randrange(100)),\r\n-            /* m_min_ping_time */ std::chrono::microseconds{random_context.randrange(100)},\r\n-            /* nLastBlockTime */ static_cast<int64_t>(random_context.randrange(100)),\r\n-            /* nLastTXTime */ static_cast<int64_t>(random_context.randrange(100)),\r\n-            /* fRelevantServices */ random_context.randbool(),\r\n-            /* fRelayTxes */ random_context.randbool(),\r\n-            /* fBloomFilter */ random_context.randbool(),\r\n-            /* nKeyedNetGroup */ random_context.randrange(100),\r\n-            /* prefer_evict */ random_context.randbool(),\r\n-            /* m_is_local */ random_context.randbool(),\r\n-            /* m_network */ ALL_NETWORKS[random_context.randrange(ALL_NETWORKS.size())],\r\n-        });\r\n-    }\r\n-    return candidates;\r\n-}\r\n-\r\n // Create `num_peers` random nodes, apply setup function `candidate_setup_fn`,\r\n // call ProtectEvictionCandidatesByRatio() to apply protection logic, and then\r\n // return true if all of `protected_peer_ids` and none of `unprotected_peer_ids`\r\n // are protected from eviction, i.e. removed from the eviction candidates.\r\n bool IsProtected(int num_peers,\r\n                  std::function<void(NodeEvictionCandidate&)> candidate_setup_fn,\r\ndiff --git a/src/test/util/net.cpp b/src/test/util/net.cpp\r\nindex 847a490e03..64b70a61f0 100644\r\n--- a/src/test/util/net.cpp\r\n+++ b/src/test/util/net.cpp\r\n@@ -34,6 +34,28 @@ bool ConnmanTestMsg::ReceiveMsgFrom(CNode& node, CSerializedNetMsg& ser_msg) con\r\n\r\n     bool complete;\r\n     NodeReceiveMsgBytes(node, ser_msg_header, complete);\r\n     NodeReceiveMsgBytes(node, ser_msg.data, complete);\r\n     return complete;\r\n }\r\n+\r\n+std::vector<NodeEvictionCandidate> GetRandomNodeEvictionCandidates(const int n_candidates, FastRandomContext& random_context)\r\n+{\r\n+    std::vector<NodeEvictionCandidate> candidates;\r\n+    for (int id = 0; id < n_candidates; ++id) {\r\n+        candidates.push_back({\r\n+            /* id */ id,\r\n+            /* nTimeConnected */ static_cast<int64_t>(random_context.randrange(100)),\r\n+            /* m_min_ping_time */ std::chrono::microseconds{random_context.randrange(100)},\r\n+            /* nLastBlockTime */ static_cast<int64_t>(random_context.randrange(100)),\r\n+            /* nLastTXTime */ static_cast<int64_t>(random_context.randrange(100)),\r\n+            /* fRelevantServices */ random_context.randbool(),\r\n+            /* fRelayTxes */ random_context.randbool(),\r\n+            /* fBloomFilter */ random_context.randbool(),\r\n+            /* nKeyedNetGroup */ random_context.randrange(100),\r\n+            /* prefer_evict */ random_context.randbool(),\r\n+            /* m_is_local */ random_context.randbool(),\r\n+            /* m_network */ ALL_NETWORKS[random_context.randrange(ALL_NETWORKS.size())],\r\n+        });\r\n+    }\r\n+    return candidates;\r\n+}\r\ndiff --git a/src/test/util/net.h b/src/test/util/net.h\r\nindex 1b49a671bd..66f6cc61b8 100644\r\n--- a/src/test/util/net.h\r\n+++ b/src/test/util/net.h\r\n@@ -138,7 +138,9 @@ public:\r\n\r\n private:\r\n     const std::string m_contents;\r\n     mutable size_t m_consumed;\r\n };\r\n\r\n+std::vector<NodeEvictionCandidate> GetRandomNodeEvictionCandidates(const int n_candidates, FastRandomContext& random_context);\r\n+\r\n #endif // BITCOIN_TEST_UTIL_NET_H\r\n```\r\n",
      "commit_id" : "ab2993336fbdff72d125f906c2baec4c5dcb79e3",
      "created_at" : "2021-06-30T09:09:09Z",
      "diff_hunk" : "@@ -0,0 +1,169 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <random.h>\n+#include <test/util/net.h>\n+#include <test/util/setup_common.h>\n+\n+#include <algorithm>\n+#include <functional>\n+#include <vector>\n+\n+std::vector<NodeEvictionCandidate> GetRandomNodeEvictionCandidates(int num_peers, FastRandomContext& random_context)\n+{\n+    std::vector<NodeEvictionCandidate> candidates;\n+    for (int id = 0; id < num_peers; ++id) {\n+        candidates.push_back({\n+            /* id */ id,\n+            /* nTimeConnected */ static_cast<int64_t>(random_context.randrange(100)),\n+            /* m_min_ping_time */ std::chrono::microseconds{random_context.randrange(100)},\n+            /* nLastBlockTime */ static_cast<int64_t>(random_context.randrange(100)),\n+            /* nLastTXTime */ static_cast<int64_t>(random_context.randrange(100)),\n+            /* fRelevantServices */ random_context.randbool(),\n+            /* fRelayTxes */ random_context.randbool(),\n+            /* fBloomFilter */ random_context.randbool(),\n+            /* nKeyedNetGroup */ random_context.randrange(100),\n+            /* prefer_evict */ random_context.randbool(),\n+            /* m_is_local */ random_context.randbool(),\n+            /* m_network */ ALL_NETWORKS[random_context.randrange(ALL_NETWORKS.size())],\n+        });\n+    }\n+    return candidates;\n+}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22284#discussion_r661275001",
      "id" : 661275001,
      "line" : 36,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MTI3NTAwMQ==",
      "original_commit_id" : "ab2993336fbdff72d125f906c2baec4c5dcb79e3",
      "original_line" : 36,
      "original_position" : 36,
      "original_start_line" : 16,
      "path" : "src/bench/peer_eviction.cpp",
      "position" : 36,
      "pull_request_review_id" : 695881962,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22284",
      "side" : "RIGHT",
      "start_line" : 16,
      "start_side" : "RIGHT",
      "updated_at" : "2021-06-30T09:48:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/661275001",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22284#discussion_r661285594"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22284"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/661285594"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think [nanobench](https://nanobench.ankerl.com/reference.html#_CPPv4N6ankerl9nanobench5Bench6epochsE6size_t) is designed to make such loops unnecessary. It can provide stable results even if the test function is very fast/short, no need to loop 60k times.\r\n\r\nAlso, the above benchmarks the copying of the data which could add noise to the test. Given that the input is not huge we can create a separate copy for each iteration of the test, this consumes a few tens of megabytes which is ok. Here is an example (that also uses the de-duplicated `GetRandomNodeEvictionCandidates()` from `test/util/net.h`):\r\n\r\n```cpp\r\n// Copyright (c) 2021 The Bitcoin Core developers\r\n// Distributed under the MIT software license, see the accompanying\r\n// file COPYING or http://www.opensource.org/licenses/mit-license.php.\r\n\r\n#include <bench/bench.h>\r\n#include <net.h>\r\n#include <netaddress.h>\r\n#include <random.h>\r\n#include <test/util/net.h>\r\n#include <test/util/setup_common.h>\r\n\r\n#include <algorithm>\r\n#include <functional>\r\n#include <vector>\r\n\r\nstatic void EvictionProtectionCommon(\r\n    benchmark::Bench& bench,\r\n    int num_candidates,\r\n    std::function<void(NodeEvictionCandidate&)> candidate_setup_fn,\r\n    size_t epochs,\r\n    uint64_t epoch_iterations)\r\n{\r\n    using Candidates = std::vector<NodeEvictionCandidate>;\r\n\r\n    FastRandomContext random_context{true};\r\n\r\n    bench.epochs(epochs).epochIterations(epoch_iterations);\r\n\r\n    Candidates candidates{GetRandomNodeEvictionCandidates(num_candidates, random_context)};\r\n    for (auto& c : candidates) {\r\n        candidate_setup_fn(c);\r\n    }\r\n\r\n    std::vector<Candidates> copies{bench.epochs() * bench.epochIterations(), candidates};\r\n    size_t i{0};\r\n    bench.run([&] {\r\n        ProtectEvictionCandidatesByRatio(copies.at(i));\r\n        ++i;\r\n    });\r\n}\r\n\r\n/* Benchmarks */\r\n\r\nstatic void EvictionProtection1Network250Candidates(benchmark::Bench& bench)\r\n{\r\n    EvictionProtectionCommon(\r\n        bench,\r\n        250 /* num_candidates */,\r\n        [](NodeEvictionCandidate& c) {\r\n            c.nTimeConnected = c.id;\r\n            c.m_is_local = false;\r\n            if (c.id >= 130 && c.id < 240) { // 110 Tor\r\n                c.m_network = NET_ONION;\r\n            } else {\r\n                c.m_network = NET_IPV6;\r\n            }\r\n        },\r\n        10 /* epochs */,\r\n        100 /* epoch_iterations */);\r\n}\r\n\r\nstatic void EvictionProtection3Networks050Candidates(benchmark::Bench& bench)\r\n{\r\n    EvictionProtectionCommon(\r\n        bench,\r\n        50 /* num_candidates */,\r\n        [](NodeEvictionCandidate& c) {\r\n            c.nTimeConnected = c.id;\r\n            c.m_is_local = (c.id == 28 || c.id == 47); //  2 localhost\r\n            if (c.id >= 30 && c.id < 47) {             // 17 I2P\r\n                c.m_network = NET_I2P;\r\n            } else if (c.id >= 24 && c.id < 28) { //  4 Tor\r\n                c.m_network = NET_ONION;\r\n            } else {\r\n                c.m_network = NET_IPV4;\r\n            }\r\n        },\r\n        10 /* epochs */,\r\n        100 /* epoch_iterations */);\r\n}\r\n\r\nstatic void EvictionProtection3Networks100Candidates(benchmark::Bench& bench)\r\n{\r\n    EvictionProtectionCommon(\r\n        bench,\r\n        100 /* num_candidates */,\r\n        [](NodeEvictionCandidate& c) {\r\n            c.nTimeConnected = c.id;\r\n            c.m_is_local = (c.id >= 55 && c.id < 60); //  5 localhost\r\n            if (c.id >= 70 && c.id < 80) {            // 10 I2P\r\n                c.m_network = NET_I2P;\r\n            } else if (c.id >= 80 && c.id < 96) { // 16 Tor\r\n                c.m_network = NET_ONION;\r\n            } else {\r\n                c.m_network = NET_IPV4;\r\n            }\r\n        },\r\n        10 /* epochs */,\r\n        100 /* epoch_iterations */);\r\n}\r\n\r\nstatic void EvictionProtection3Networks250Candidates(benchmark::Bench& bench)\r\n{\r\n    EvictionProtectionCommon(\r\n        bench,\r\n        250 /* num_candidates */,\r\n        [](NodeEvictionCandidate& c) {\r\n            c.nTimeConnected = c.id;\r\n            c.m_is_local = (c.id >= 140 && c.id < 160); // 20 localhost\r\n            if (c.id >= 170 && c.id < 180) {            // 10 I2P\r\n                c.m_network = NET_I2P;\r\n            } else if (c.id >= 190 && c.id < 240) { // 50 Tor\r\n                c.m_network = NET_ONION;\r\n            } else {\r\n                c.m_network = NET_IPV4;\r\n            }\r\n        },\r\n        10 /* epochs */,\r\n        100 /* epoch_iterations */);\r\n}\r\n\r\n// 1 disadvantaged network (Tor) with 250 eviction candidates.\r\nBENCHMARK(EvictionProtection1Network250Candidates);\r\n\r\n// 3 disadvantaged networks (I2P/localhost/Tor) with 50/100/250 eviction candidates.\r\nBENCHMARK(EvictionProtection3Networks050Candidates);\r\nBENCHMARK(EvictionProtection3Networks100Candidates);\r\nBENCHMARK(EvictionProtection3Networks250Candidates);\r\n```",
      "commit_id" : "ab2993336fbdff72d125f906c2baec4c5dcb79e3",
      "created_at" : "2021-06-30T09:23:24Z",
      "diff_hunk" : "@@ -0,0 +1,169 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <random.h>\n+#include <test/util/net.h>\n+#include <test/util/setup_common.h>\n+\n+#include <algorithm>\n+#include <functional>\n+#include <vector>\n+\n+std::vector<NodeEvictionCandidate> GetRandomNodeEvictionCandidates(int num_peers, FastRandomContext& random_context)\n+{\n+    std::vector<NodeEvictionCandidate> candidates;\n+    for (int id = 0; id < num_peers; ++id) {\n+        candidates.push_back({\n+            /* id */ id,\n+            /* nTimeConnected */ static_cast<int64_t>(random_context.randrange(100)),\n+            /* m_min_ping_time */ std::chrono::microseconds{random_context.randrange(100)},\n+            /* nLastBlockTime */ static_cast<int64_t>(random_context.randrange(100)),\n+            /* nLastTXTime */ static_cast<int64_t>(random_context.randrange(100)),\n+            /* fRelevantServices */ random_context.randbool(),\n+            /* fRelayTxes */ random_context.randbool(),\n+            /* fBloomFilter */ random_context.randbool(),\n+            /* nKeyedNetGroup */ random_context.randrange(100),\n+            /* prefer_evict */ random_context.randbool(),\n+            /* m_is_local */ random_context.randbool(),\n+            /* m_network */ ALL_NETWORKS[random_context.randrange(ALL_NETWORKS.size())],\n+        });\n+    }\n+    return candidates;\n+}\n+\n+static std::vector<NodeEvictionCandidate> CreateEvictionCandidates(int num_peers, std::function<void(NodeEvictionCandidate&)> candidate_setup_fn, FastRandomContext& random_context)\n+{\n+    std::vector<NodeEvictionCandidate> candidates{GetRandomNodeEvictionCandidates(num_peers, random_context)};\n+    for (NodeEvictionCandidate& candidate : candidates) {\n+        candidate_setup_fn(candidate);\n+    }\n+    return candidates;\n+}\n+\n+/* Benchmarks */\n+\n+static void EvictionProtection1Network250Candidates(benchmark::Bench& bench)\n+{\n+    const int num_peers{250};\n+    FastRandomContext random_context{true};\n+\n+    const std::vector<NodeEvictionCandidate> eviction_candidates{\n+        CreateEvictionCandidates(\n+            num_peers, [](NodeEvictionCandidate& c) {\n+                c.nTimeConnected = c.id;\n+                c.m_is_local = false;\n+                if (c.id >= 130 && c.id < 240) { // 110 Tor\n+                    c.m_network = NET_ONION;\n+                } else {\n+                    c.m_network = NET_IPV6;\n+                }\n+            },\n+            random_context)};\n+\n+    bench.run([&] {\n+        std::vector<NodeEvictionCandidate> candidates;\n+        for (int id = 0; id < 60000; ++id) {\n+            candidates = eviction_candidates;\n+            ProtectEvictionCandidatesByRatio(candidates);\n+        }\n+    });",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22284#discussion_r661285594",
      "id" : 661285594,
      "line" : 73,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MTI4NTU5NA==",
      "original_commit_id" : "ab2993336fbdff72d125f906c2baec4c5dcb79e3",
      "original_line" : 73,
      "original_position" : 73,
      "original_start_line" : 67,
      "path" : "src/bench/peer_eviction.cpp",
      "position" : 73,
      "pull_request_review_id" : 695881962,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22284",
      "side" : "RIGHT",
      "start_line" : 67,
      "start_side" : "RIGHT",
      "updated_at" : "2021-06-30T09:48:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/661285594",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22284#discussion_r661294200"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22284"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/661294200"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "99a25fb393 `p2p: iterate over eviction candidates once instead of thrice`\r\n\r\nI did not observe any difference in performance due to this commit.\r\n\r\nIt changes the complexity from `O(num networks * num candidates)` to `O(num candidates * num networks)`. The early `break` optimization maybe makes it `O(num candidates * num networks * 0.5)` on average, but that is equal to `O(num candidates * num networks)`.\r\n\r\nJust to experiment I made this `O(num candidates)` which is as fast as it could be (unfortunately a bit hackish due to the hardcoded indexes):\r\n\r\n```diff\r\n--- a/src/net.cpp\r\n+++ b/src/net.cpp\r\n@@ -918,18 +918,26 @@ void ProtectEvictionCandidatesByRatio(std::vector<NodeEvictionCandidate>& evicti\r\n     // array members have first opportunity to recover unused slots from the previous iteration.\r\n     struct Net { bool is_local; Network id; size_t count; };\r\n     std::array<Net, 3> networks{\r\n         {{false, NET_I2P, 0}, {/* localhost */ true, NET_MAX, 0}, {false, NET_ONION, 0}}};\r\n \r\n     // Count and store the number of eviction candidates per network.\r\n-    for (auto& c : eviction_candidates) {\r\n-        for (int i{networks.size() - 1}; i >= 0; --i) {\r\n-            if (networks[i].is_local ? c.m_is_local : c.m_network == networks[i].id) {\r\n-                ++networks[i].count;\r\n-                break;\r\n-            }\r\n+    for (const auto& c : eviction_candidates) {\r\n+        const Network net = c.m_is_local ? NET_MAX : c.m_network;\r\n+        switch (net) {\r\n+        case NET_I2P:\r\n+            ++networks[0].count;\r\n+            break;\r\n+        case NET_MAX:\r\n+            ++networks[1].count;\r\n+            break;\r\n+        case NET_ONION:\r\n+            ++networks[2].count;\r\n+            break;\r\n+        default:\r\n+            break;\r\n         }\r\n     }\r\n     // Sort `networks` by ascending candidate count, to give networks having fewer candidates\r\n     // the first opportunity to recover unused protected slots from the previous iteration.\r\n```\r\n\r\nNo difference in performance either. I guess this is operating on too small amount of data to make any performance impact and so this commit can be dropped if its purpose is to improve performance and we can't observe any changes.",
      "commit_id" : "ab2993336fbdff72d125f906c2baec4c5dcb79e3",
      "created_at" : "2021-06-30T09:34:42Z",
      "diff_hunk" : "@@ -921,11 +921,13 @@ void ProtectEvictionCandidatesByRatio(std::vector<NodeEvictionCandidate>& evicti\n         {{false, NET_I2P, 0}, {/* localhost */ true, NET_MAX, 0}, {false, NET_ONION, 0}}};\n \n     // Count and store the number of eviction candidates per network.\n-    for (Net& n : networks) {\n-        n.count = std::count_if(eviction_candidates.cbegin(), eviction_candidates.cend(),\n-                                [&n](const NodeEvictionCandidate& c) {\n-                                    return n.is_local ? c.m_is_local : c.m_network == n.id;\n-                                });\n+    for (auto& c : eviction_candidates) {\n+        for (int i{networks.size() - 1}; i >= 0; --i) {\n+            if (networks[i].is_local ? c.m_is_local : c.m_network == networks[i].id) {\n+                ++networks[i].count;\n+                break;\n+            }\n+        }\n     }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22284#discussion_r661294200",
      "id" : 661294200,
      "line" : 931,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MTI5NDIwMA==",
      "original_commit_id" : "ab2993336fbdff72d125f906c2baec4c5dcb79e3",
      "original_line" : 931,
      "original_position" : 16,
      "original_start_line" : 924,
      "path" : "src/net.cpp",
      "position" : 16,
      "pull_request_review_id" : 695881962,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22284",
      "side" : "RIGHT",
      "start_line" : 924,
      "start_side" : "LEFT",
      "updated_at" : "2021-06-30T09:48:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/661294200",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22284#discussion_r661302739"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22284"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/661302739"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "06b898c3e1 `p2p: iterate eviction protection only on networks having candidates`\r\n\r\nLooking at this commit - there is no need to re-calculate `num_networks` inside the loop because `networks` is not changed in the loop. It can be calculated just once before the loop:\r\n\r\n```cpp\r\nauto num_networks = std::count_if(networks.begin(), networks.end(), [](const Net& n) { return n.count; });\r\nif (networks > 0) {\r\n    while (num_protected < max_protect_by_network) {\r\n        ...\r\n```\r\n\r\nI did not observe any performance change due to this commit.\r\n\r\nBut considering the subsequent ab2993336f `p2p: earlier continuation when no remaining eviction candidates` (this one brings pefromance boost!) it should be inside the loop because then we change `networks[].count` in the loop. Maybe squash both commits into one?",
      "commit_id" : "ab2993336fbdff72d125f906c2baec4c5dcb79e3",
      "created_at" : "2021-06-30T09:46:31Z",
      "diff_hunk" : "@@ -936,27 +938,34 @@ void ProtectEvictionCandidatesByRatio(std::vector<NodeEvictionCandidate>& evicti\n     size_t num_protected{0};\n \n     while (num_protected < max_protect_by_network) {\n+        // Count the number of disadvantaged networks from which we have peers to protect.\n+        auto num_networks = std::count_if(networks.begin(), networks.end(), [](const Net& n) { return n.count; });\n+        if (num_networks == 0) {\n+            break;\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22284#discussion_r661302739",
      "id" : 661302739,
      "line" : 945,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MTMwMjczOQ==",
      "original_commit_id" : "ab2993336fbdff72d125f906c2baec4c5dcb79e3",
      "original_line" : 945,
      "original_position" : 27,
      "original_start_line" : 940,
      "path" : "src/net.cpp",
      "position" : 27,
      "pull_request_review_id" : 695881962,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22284",
      "side" : "RIGHT",
      "start_line" : 940,
      "start_side" : "RIGHT",
      "updated_at" : "2021-06-30T09:48:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/661302739",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22284#discussion_r661341225"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22284"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/661341225"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> I did not observe any difference in performance due to this commit.\r\n\r\nHere are the results I get:\r\n\r\n272f327fbf `bench: add peer eviction protection benchmarks`\r\n```\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|      706,673,971.00 |                1.42 |    1.7% |      7.79 | `EvictionProtection1Network250Candidates`\r\n|    1,299,063,388.00 |                0.77 |    0.7% |     14.30 | `EvictionProtection3Networks050Candidates`\r\n|    1,155,171,747.00 |                0.87 |    0.5% |     12.73 | `EvictionProtection3Networks100Candidates`\r\n|    2,900,919,398.00 |                0.34 |    1.3% |     31.93 | `EvictionProtection3Networks250Candidates`\r\n\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|      714,684,192.00 |                1.40 |    1.0% |      7.91 | `EvictionProtection1Network250Candidates`\r\n|    1,296,579,234.00 |                0.77 |    0.5% |     14.22 | `EvictionProtection3Networks050Candidates`\r\n|    1,159,393,440.00 |                0.86 |    0.7% |     12.71 | `EvictionProtection3Networks100Candidates`\r\n|    2,854,527,930.00 |                0.35 |    0.7% |     31.44 | `EvictionProtection3Networks250Candidates`\r\n```\r\n\r\n99a25fb393 `p2p: iterate over eviction candidates once instead of thrice`\r\n```\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|      709,622,212.00 |                1.41 |    1.0% |      7.79 | `EvictionProtection1Network250Candidates`\r\n|    1,310,376,054.00 |                0.76 |    1.2% |     14.39 | `EvictionProtection3Networks050Candidates`\r\n|    1,160,800,660.00 |                0.86 |    0.4% |     12.72 | `EvictionProtection3Networks100Candidates`\r\n|    2,983,258,845.00 |                0.34 |    0.5% |     32.71 | `EvictionProtection3Networks250Candidates`\r\n\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|      711,091,374.00 |                1.41 |    0.5% |      7.82 | `EvictionProtection1Network250Candidates`\r\n|    1,318,781,548.00 |                0.76 |    0.3% |     14.38 | `EvictionProtection3Networks050Candidates`\r\n|    1,142,837,118.00 |                0.88 |    0.2% |     12.40 | `EvictionProtection3Networks100Candidates`\r\n|    2,943,154,182.00 |                0.34 |    0.4% |     32.22 | `EvictionProtection3Networks250Candidates`\r\n```",
      "commit_id" : "ab2993336fbdff72d125f906c2baec4c5dcb79e3",
      "created_at" : "2021-06-30T10:44:33Z",
      "diff_hunk" : "@@ -921,11 +921,13 @@ void ProtectEvictionCandidatesByRatio(std::vector<NodeEvictionCandidate>& evicti\n         {{false, NET_I2P, 0}, {/* localhost */ true, NET_MAX, 0}, {false, NET_ONION, 0}}};\n \n     // Count and store the number of eviction candidates per network.\n-    for (Net& n : networks) {\n-        n.count = std::count_if(eviction_candidates.cbegin(), eviction_candidates.cend(),\n-                                [&n](const NodeEvictionCandidate& c) {\n-                                    return n.is_local ? c.m_is_local : c.m_network == n.id;\n-                                });\n+    for (auto& c : eviction_candidates) {\n+        for (int i{networks.size() - 1}; i >= 0; --i) {\n+            if (networks[i].is_local ? c.m_is_local : c.m_network == networks[i].id) {\n+                ++networks[i].count;\n+                break;\n+            }\n+        }\n     }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22284#discussion_r661341225",
      "id" : 661341225,
      "in_reply_to_id" : 661294200,
      "line" : 931,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MTM0MTIyNQ==",
      "original_commit_id" : "ab2993336fbdff72d125f906c2baec4c5dcb79e3",
      "original_line" : 931,
      "original_position" : 16,
      "original_start_line" : 924,
      "path" : "src/net.cpp",
      "position" : 16,
      "pull_request_review_id" : 695969918,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22284",
      "side" : "RIGHT",
      "start_line" : 924,
      "start_side" : "LEFT",
      "updated_at" : "2021-06-30T10:44:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/661341225",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   }
]
