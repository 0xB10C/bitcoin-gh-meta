[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#22564](https://github.com/bitcoin/bitcoin/pull/22564) ([WIP] refactor: Move mutable globals cleared in `::UnloadBlockIndex` to `BlockManager` by dongcarl)\n* [#19888](https://github.com/bitcoin/bitcoin/pull/19888) (rpc, test: Improve getblockstats for unspendables by fjahr)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-10-05T11:40:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23174#issuecomment-934329907",
      "id" : 934329907,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23174",
      "node_id" : "IC_kwDOABII5843sL4z",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/934329907/reactions"
      },
      "updated_at" : "2021-10-07T18:39:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/934329907",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "(this PR is missing in the Assume UTXO project)",
      "created_at" : "2021-10-07T08:42:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23174#issuecomment-937580719",
      "id" : 937580719,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23174",
      "node_id" : "IC_kwDOABII58434liv",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/937580719/reactions"
      },
      "updated_at" : "2021-10-07T08:42:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/937580719",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2021-10-07T19:43:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23174#issuecomment-938101140",
      "id" : 938101140,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23174",
      "node_id" : "IC_kwDOABII58436kmU",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/938101140/reactions"
      },
      "updated_at" : "2021-10-07T19:43:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/938101140",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r725089856"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725089856"
         }
      },
      "author_association" : "MEMBER",
      "body" : "For `std::tie`\r\n```diff\r\n+++ b/src/validation.cpp\r\n@@ -58,6 +58,7 @@\r\n #include <numeric>\r\n #include <optional>\r\n #include <string>\r\n+#include <tuple>\r\n```\r\n",
      "commit_id" : "51e614fdbc6a23ade324e9bd01228bf97df9bc5d",
      "created_at" : "2021-10-08T15:02:56Z",
      "diff_hunk" : "@@ -3631,17 +3631,50 @@ bool BlockManager::LoadBlockIndex(\n         vSortedByHeight.push_back(std::make_pair(pindex->nHeight, pindex));\n     }\n     sort(vSortedByHeight.begin(), vSortedByHeight.end());\n+\n+    // If we have a historical region of the chain that is assumed-valid, we should\n+    // mark the last assumed-valid block that we see, since we then have to populate\n+    // the final nChainTx as well as prevent inclusion of blocks after that in the\n+    // setBlockIndexCandidates of the background chainstate.\n+    bool saw_end_of_assumedvalid{false};\n+\n+    std::optional<uint256> assumedvalid_end_blockhash;\n+    unsigned int assumedvalid_end_nchaintx;\n+    std::tie(assumedvalid_end_blockhash, assumedvalid_end_nchaintx) =",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r725089856",
      "id" : 725089856,
      "line" : 3643,
      "node_id" : "PRRC_kwDOABII584rN_5A",
      "original_commit_id" : "51e614fdbc6a23ade324e9bd01228bf97df9bc5d",
      "original_line" : 3643,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 22,
      "pull_request_review_id" : 775125236,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725089856/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-08T15:28:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725089856",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r725093367"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725093367"
         }
      },
      "author_association" : "MEMBER",
      "body" : "- s/an block/a block/\r\n- s/passed the end/past the end/?\r\n\r\nmy editor auto-proposes this\r\n```diff\r\n-                // If we're on an block index entry that is passed the end of the\r\n-                // assumed-valid region of the chain, avoid\r\n-                // adding this as a candidate tip to the background validation\r\n-                // chain, since that would prevent background IBD from happening.\r\n+                // If we're on a block index entry that is past the end of the\r\n+                // assumed-valid region of the chain, avoid adding this as a\r\n+                // candidate tip to the background validation chain, since that\r\n+                // would prevent background IBD from happening.\r\n```\r\n",
      "commit_id" : "51e614fdbc6a23ade324e9bd01228bf97df9bc5d",
      "created_at" : "2021-10-08T15:07:35Z",
      "diff_hunk" : "@@ -3658,7 +3691,18 @@ bool BlockManager::LoadBlockIndex(\n         if (pindex->IsAssumedValid() ||\n                 (pindex->IsValid(BLOCK_VALID_TRANSACTIONS) &&\n                  (pindex->HaveTxsDownloaded() || pindex->pprev == nullptr))) {\n-            block_index_candidates.insert(pindex);\n+            for (CChainState* chainstate : chainman.GetAll()) {\n+                // If we're on an block index entry that is passed the end of the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r725093367",
      "id" : 725093367,
      "line" : 3695,
      "node_id" : "PRRC_kwDOABII584rOAv3",
      "original_commit_id" : "51e614fdbc6a23ade324e9bd01228bf97df9bc5d",
      "original_line" : 3695,
      "original_position" : 67,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 67,
      "pull_request_review_id" : 775125236,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725093367/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-08T15:28:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725093367",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r725093792"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725093792"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n                const bool is_assumedvalid_end =\r\n```",
      "commit_id" : "51e614fdbc6a23ade324e9bd01228bf97df9bc5d",
      "created_at" : "2021-10-08T15:08:04Z",
      "diff_hunk" : "@@ -3631,17 +3631,50 @@ bool BlockManager::LoadBlockIndex(\n         vSortedByHeight.push_back(std::make_pair(pindex->nHeight, pindex));\n     }\n     sort(vSortedByHeight.begin(), vSortedByHeight.end());\n+\n+    // If we have a historical region of the chain that is assumed-valid, we should\n+    // mark the last assumed-valid block that we see, since we then have to populate\n+    // the final nChainTx as well as prevent inclusion of blocks after that in the\n+    // setBlockIndexCandidates of the background chainstate.\n+    bool saw_end_of_assumedvalid{false};\n+\n+    std::optional<uint256> assumedvalid_end_blockhash;\n+    unsigned int assumedvalid_end_nchaintx;\n+    std::tie(assumedvalid_end_blockhash, assumedvalid_end_nchaintx) =\n+        chainman.getAssumedValidEnd();\n+\n     for (const std::pair<int, CBlockIndex*>& item : vSortedByHeight)\n     {\n         if (ShutdownRequested()) return false;\n         CBlockIndex* pindex = item.second;\n         pindex->nChainWork = (pindex->pprev ? pindex->pprev->nChainWork : 0) + GetBlockProof(*pindex);\n         pindex->nTimeMax = (pindex->pprev ? std::max(pindex->pprev->nTimeMax, pindex->nTime) : pindex->nTime);\n+\n         // We can link the chain of blocks for which we've received transactions at some point.\n         // Pruned nodes may have deleted the block.\n+        //\n+        // Do not expect assumed-valid blocks to have nTx.\n         if (pindex->nTx > 0) {\n             if (pindex->pprev) {\n-                if (pindex->pprev->HaveTxsDownloaded()) {\n+                bool is_assumedvalid_end =",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r725093792",
      "id" : 725093792,
      "line" : 3659,
      "node_id" : "PRRC_kwDOABII584rOA2g",
      "original_commit_id" : "51e614fdbc6a23ade324e9bd01228bf97df9bc5d",
      "original_line" : 3659,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 39,
      "pull_request_review_id" : 775125236,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725093792/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-08T15:28:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725093792",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r725101183"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725101183"
         }
      },
      "author_association" : "MEMBER",
      "body" : "style nit, PascalCase unless there is some reason I'm not aware of here (same for the other `get...` functions introduced here) \r\n ```suggestion\r\n     std::pair<std::optional<uint256>, unsigned int> GetAssumedValidEnd()\r\n```",
      "commit_id" : "51e614fdbc6a23ade324e9bd01228bf97df9bc5d",
      "created_at" : "2021-10-08T15:18:03Z",
      "diff_hunk" : "@@ -1010,6 +1014,12 @@ class ChainstateManager\n     //! ResizeCoinsCaches() as needed.\n     void MaybeRebalanceCaches() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! If some region of the block index is assumed to be valid (as in the case of\n+    //! UTXO snapshot usage), return the last blockhash to be assumed valid (i.e. the\n+    //! base of the snapshot) and the correspondent nChainTx value associated with it.\n+    std::pair<std::optional<uint256>, unsigned int> getAssumedValidEnd()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r725101183",
      "id" : 725101183,
      "line" : 1020,
      "node_id" : "PRRC_kwDOABII584rOCp_",
      "original_commit_id" : "51e614fdbc6a23ade324e9bd01228bf97df9bc5d",
      "original_line" : 1020,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 52,
      "pull_request_review_id" : 775125236,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725101183/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-08T15:30:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725101183",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   }
]
