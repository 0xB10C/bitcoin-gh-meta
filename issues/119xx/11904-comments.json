[
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2017-12-15T00:20:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11904#issuecomment-351876406",
      "id" : 351876406,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11904",
      "updated_at" : "2017-12-15T00:20:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/351876406",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1008458?v=4",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Suggest moving LockWalletDirectory to wallet/db.cpp and calling it from CDBEnv::Open instead of VerifyWallets. That way this will be compatible with #11687. Also would suggest renaming LockWalletDirectory to LockEnvDirectory to be a little more consistent with terminology used in that file (even though the file isn't totally consistent right now).",
      "created_at" : "2017-12-15T02:43:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11904#issuecomment-351897871",
      "id" : 351897871,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11904",
      "updated_at" : "2017-12-15T02:45:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/351897871",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ryanofsky something like this? I had to probe the lock before calling open because of the weird database log backup thing when open fails, perhaps there is a cleaner way to do it e.g. returning different errors from open rather than just true/false. But I think this is ok",
      "created_at" : "2017-12-16T19:14:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11904#issuecomment-352204896",
      "id" : 352204896,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11904",
      "updated_at" : "2017-12-16T19:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/352204896",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/3211283?v=4",
         "events_url" : "https://api.github.com/users/MeshCollider/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MeshCollider/followers",
         "following_url" : "https://api.github.com/users/MeshCollider/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MeshCollider/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MeshCollider",
         "id" : 3211283,
         "login" : "MeshCollider",
         "organizations_url" : "https://api.github.com/users/MeshCollider/orgs",
         "received_events_url" : "https://api.github.com/users/MeshCollider/received_events",
         "repos_url" : "https://api.github.com/users/MeshCollider/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MeshCollider/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MeshCollider/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MeshCollider"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11904#discussion_r157355132"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11904"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/157355132"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Nit, missing space after `catch`.",
      "commit_id" : "edf5a3fd56100120de968f08f75b142f042a13d9",
      "created_at" : "2017-12-17T00:45:25Z",
      "diff_hunk" : "@@ -52,6 +53,27 @@ void CheckUniqueFileid(const CDBEnv& env, const std::string& filename, Db& db)\n         }\n     }\n }\n+\n+bool LockEnvDirectory(const fs::path& env_path, bool probe_only)\n+{\n+    // Make sure only a single Bitcoin process is using the wallet directory.\n+    fs::path lock_file_path = env_path / \".lock\";\n+    FILE* file = fsbridge::fopen(lock_file_path, \"a\"); // empty lock file; created if it doesn't exist.\n+    if (file) fclose(file);\n+\n+    try {\n+        static boost::interprocess::file_lock lock(lock_file_path.string().c_str());\n+        if (!lock.try_lock()) {\n+            return false;\n+        }\n+        if (probe_only) {\n+            lock.unlock();\n+        }\n+    } catch(const boost::interprocess::interprocess_exception& e) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11904#discussion_r157355132",
      "id" : 157355132,
      "original_commit_id" : "94be65ea6d4149a50854b342fdaddb8363b9a0a0",
      "original_position" : 28,
      "path" : "src/wallet/db.cpp",
      "position" : null,
      "pull_request_review_id" : 83987481,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11904",
      "updated_at" : "2017-12-24T00:08:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/157355132",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11904#discussion_r157355161"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11904"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/157355161"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Use `restart_node`, and remove `stop_node` above?",
      "commit_id" : "edf5a3fd56100120de968f08f75b142f042a13d9",
      "created_at" : "2017-12-17T00:47:52Z",
      "diff_hunk" : "@@ -58,7 +58,12 @@ def run_test(self):\n         w5 = self.nodes[0].get_wallet_rpc(\"w5\")\n         w5_info = w5.getwalletinfo()\n         assert_equal(w5_info['immature_balance'], 50)\n+        self.stop_node(0)\n \n+        competing_wallet_dir = os.path.join(self.options.tmpdir, 'competing_walletdir')\n+        os.mkdir(competing_wallet_dir)\n+        self.start_node(0, ['-walletdir='+competing_wallet_dir])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11904#discussion_r157355161",
      "id" : 157355161,
      "original_commit_id" : "94be65ea6d4149a50854b342fdaddb8363b9a0a0",
      "original_position" : 25,
      "path" : "test/functional/multiwallet.py",
      "position" : null,
      "pull_request_review_id" : 83987481,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11904",
      "updated_at" : "2017-12-24T00:08:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/157355161",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Removed the probing with a bit of a rework",
      "created_at" : "2017-12-17T07:42:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11904#issuecomment-352237886",
      "id" : 352237886,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11904",
      "updated_at" : "2017-12-17T07:42:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/352237886",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/3211283?v=4",
         "events_url" : "https://api.github.com/users/MeshCollider/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MeshCollider/followers",
         "following_url" : "https://api.github.com/users/MeshCollider/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MeshCollider/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MeshCollider",
         "id" : 3211283,
         "login" : "MeshCollider",
         "organizations_url" : "https://api.github.com/users/MeshCollider/orgs",
         "received_events_url" : "https://api.github.com/users/MeshCollider/received_events",
         "repos_url" : "https://api.github.com/users/MeshCollider/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MeshCollider/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MeshCollider/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MeshCollider"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11904#discussion_r157363498"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11904"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/157363498"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "How about `bool Open(const fs::path& path, bool* is_locked = 0)`?",
      "commit_id" : "edf5a3fd56100120de968f08f75b142f042a13d9",
      "created_at" : "2017-12-17T09:48:55Z",
      "diff_hunk" : "@@ -68,7 +68,10 @@ class CDBEnv\n     typedef std::pair<std::vector<unsigned char>, std::vector<unsigned char> > KeyValPair;\n     bool Salvage(const std::string& strFile, bool fAggressive, std::vector<KeyValPair>& vResult);\n \n-    bool Open(const fs::path& path);\n+    enum OpenResult { OPEN_OK,\n+                        ENV_LOCKED,\n+                        OPEN_FAIL };\n+    OpenResult Open(const fs::path& path);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11904#discussion_r157363498",
      "id" : 157363498,
      "original_commit_id" : "8020abc808cbf8e0b8db24f92eafbf3262ea9163",
      "original_position" : 8,
      "path" : "src/wallet/db.h",
      "position" : null,
      "pull_request_review_id" : 83995746,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11904",
      "updated_at" : "2017-12-24T00:08:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/157363498",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11904#discussion_r157364001"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11904"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/157364001"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Could do, but IMO doesn't simplify the code much, if we're returning something why not use return :)",
      "commit_id" : "edf5a3fd56100120de968f08f75b142f042a13d9",
      "created_at" : "2017-12-17T10:14:46Z",
      "diff_hunk" : "@@ -68,7 +68,10 @@ class CDBEnv\n     typedef std::pair<std::vector<unsigned char>, std::vector<unsigned char> > KeyValPair;\n     bool Salvage(const std::string& strFile, bool fAggressive, std::vector<KeyValPair>& vResult);\n \n-    bool Open(const fs::path& path);\n+    enum OpenResult { OPEN_OK,\n+                        ENV_LOCKED,\n+                        OPEN_FAIL };\n+    OpenResult Open(const fs::path& path);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11904#discussion_r157364001",
      "id" : 157364001,
      "in_reply_to_id" : 157363498,
      "original_commit_id" : "8020abc808cbf8e0b8db24f92eafbf3262ea9163",
      "original_position" : 8,
      "path" : "src/wallet/db.h",
      "position" : null,
      "pull_request_review_id" : 83996260,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11904",
      "updated_at" : "2017-12-24T00:08:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/157364001",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/3211283?v=4",
         "events_url" : "https://api.github.com/users/MeshCollider/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MeshCollider/followers",
         "following_url" : "https://api.github.com/users/MeshCollider/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MeshCollider/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MeshCollider",
         "id" : 3211283,
         "login" : "MeshCollider",
         "organizations_url" : "https://api.github.com/users/MeshCollider/orgs",
         "received_events_url" : "https://api.github.com/users/MeshCollider/received_events",
         "repos_url" : "https://api.github.com/users/MeshCollider/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MeshCollider/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MeshCollider/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MeshCollider"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11904#discussion_r157364106"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11904"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/157364106"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Because you only care of `is_locked` when `Open` fails. For me `ENV_LOCKED` is the *reason* `Open` failed.\r\n\r\nAlso, you can avoid those `!= OPEN_OK` conditions.\r\n\r\nBut sure, consider my suggestion a nit.",
      "commit_id" : "edf5a3fd56100120de968f08f75b142f042a13d9",
      "created_at" : "2017-12-17T10:19:55Z",
      "diff_hunk" : "@@ -68,7 +68,10 @@ class CDBEnv\n     typedef std::pair<std::vector<unsigned char>, std::vector<unsigned char> > KeyValPair;\n     bool Salvage(const std::string& strFile, bool fAggressive, std::vector<KeyValPair>& vResult);\n \n-    bool Open(const fs::path& path);\n+    enum OpenResult { OPEN_OK,\n+                        ENV_LOCKED,\n+                        OPEN_FAIL };\n+    OpenResult Open(const fs::path& path);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11904#discussion_r157364106",
      "id" : 157364106,
      "in_reply_to_id" : 157363498,
      "original_commit_id" : "8020abc808cbf8e0b8db24f92eafbf3262ea9163",
      "original_position" : 8,
      "path" : "src/wallet/db.h",
      "position" : null,
      "pull_request_review_id" : 83996361,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11904",
      "updated_at" : "2017-12-24T00:08:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/157364106",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11904#discussion_r157364214"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11904"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/157364214"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah that's true, ok :+1:",
      "commit_id" : "edf5a3fd56100120de968f08f75b142f042a13d9",
      "created_at" : "2017-12-17T10:23:35Z",
      "diff_hunk" : "@@ -68,7 +68,10 @@ class CDBEnv\n     typedef std::pair<std::vector<unsigned char>, std::vector<unsigned char> > KeyValPair;\n     bool Salvage(const std::string& strFile, bool fAggressive, std::vector<KeyValPair>& vResult);\n \n-    bool Open(const fs::path& path);\n+    enum OpenResult { OPEN_OK,\n+                        ENV_LOCKED,\n+                        OPEN_FAIL };\n+    OpenResult Open(const fs::path& path);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11904#discussion_r157364214",
      "id" : 157364214,
      "in_reply_to_id" : 157363498,
      "original_commit_id" : "8020abc808cbf8e0b8db24f92eafbf3262ea9163",
      "original_position" : 8,
      "path" : "src/wallet/db.h",
      "position" : null,
      "pull_request_review_id" : 83996451,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11904",
      "updated_at" : "2017-12-24T00:08:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/157364214",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/3211283?v=4",
         "events_url" : "https://api.github.com/users/MeshCollider/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MeshCollider/followers",
         "following_url" : "https://api.github.com/users/MeshCollider/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MeshCollider/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MeshCollider",
         "id" : 3211283,
         "login" : "MeshCollider",
         "organizations_url" : "https://api.github.com/users/MeshCollider/orgs",
         "received_events_url" : "https://api.github.com/users/MeshCollider/received_events",
         "repos_url" : "https://api.github.com/users/MeshCollider/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MeshCollider/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MeshCollider/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MeshCollider"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11904#discussion_r157484972"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11904"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/157484972"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "https://github.com/bitcoin/bitcoin/pull/11904/files#r157363498\r\n\r\nSeems fine to use either an enum or a bool, whichever you prefer. The real problem is that VerifyEnvironment is the wrong place for the rename/retry code to live. It creates a bizarre API because you can't reliably open an environment without making two different calls and pointlessly closing and reopening. It's also a bad division of code because the verify function has to make assumptions about what the open function is doing internally.\r\n\r\nA better way to organize the code would be to have a single `bool CDBEnv::Open(fs::path, bool retry=false)` function, where setting the `retry` parameter to true renames the log directory and reopens if the initial open fails. Verifying would then just call `Open(path, true)` followed by a `Close`. Anyway this would be nice to clean up, but no need to do it here as part of fixing the lock issue.",
      "commit_id" : "edf5a3fd56100120de968f08f75b142f042a13d9",
      "created_at" : "2017-12-18T13:35:39Z",
      "diff_hunk" : "@@ -68,7 +68,10 @@ class CDBEnv\n     typedef std::pair<std::vector<unsigned char>, std::vector<unsigned char> > KeyValPair;\n     bool Salvage(const std::string& strFile, bool fAggressive, std::vector<KeyValPair>& vResult);\n \n-    bool Open(const fs::path& path);\n+    enum OpenResult { OPEN_OK,\n+                        ENV_LOCKED,\n+                        OPEN_FAIL };\n+    OpenResult Open(const fs::path& path);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11904#discussion_r157484972",
      "id" : 157484972,
      "in_reply_to_id" : 157363498,
      "original_commit_id" : "8020abc808cbf8e0b8db24f92eafbf3262ea9163",
      "original_position" : 8,
      "path" : "src/wallet/db.h",
      "position" : null,
      "pull_request_review_id" : 84133083,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11904",
      "updated_at" : "2017-12-24T00:08:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/157484972",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11904#discussion_r157908232"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11904"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/157908232"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Something wrong here, missing `}`?",
      "commit_id" : "edf5a3fd56100120de968f08f75b142f042a13d9",
      "created_at" : "2017-12-20T00:04:33Z",
      "diff_hunk" : "@@ -134,7 +157,22 @@ bool CDBEnv::Open(const fs::path& pathIn)\n                          S_IRUSR | S_IWUSR);\n     if (ret != 0) {\n         dbenv->close(0);\n-        return error(\"CDBEnv::Open: Error %d opening database environment: %s\\n\", ret, DbEnv::strerror(ret));\n+        LogPrintf(\"CDBEnv::Open: Error %d opening database environment: %s\\n\", ret, DbEnv::strerror(ret));\n+        if (retry) {\n+            // try moving the database env out of the way\n+            fs::path pathDatabaseBak = pathIn / strprintf(\"database.%d.bak\", GetTime());\n+            try {\n+                fs::rename(pathLogDir, pathDatabaseBak);\n+                LogPrintf(\"Moved old %s to %s. Retrying.\\n\", pathDatabase.string(), pathDatabaseBak.string());\n+            } catch (const fs::filesystem_error&) {\n+                // failure is ok (well, not really, but it's not worse than what we started with)\n+            }\n+            // try opening it again one more time\n+            if (!Open(walletDir, false)) {\n+                // if it still fails, it probably means we can't even create the database env\n+                return false;\n+            }\n+        return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11904#discussion_r157908232",
      "id" : 157908232,
      "original_commit_id" : "6ff6b2fba71a0f89011bc999de441b5074ff1d4e",
      "original_position" : 72,
      "path" : "src/wallet/db.cpp",
      "position" : null,
      "pull_request_review_id" : 84630121,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11904",
      "updated_at" : "2017-12-24T00:08:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/157908232",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11904#discussion_r157912347"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11904"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/157912347"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yep oops, bad code move. Fixed.",
      "commit_id" : "edf5a3fd56100120de968f08f75b142f042a13d9",
      "created_at" : "2017-12-20T00:35:56Z",
      "diff_hunk" : "@@ -134,7 +157,22 @@ bool CDBEnv::Open(const fs::path& pathIn)\n                          S_IRUSR | S_IWUSR);\n     if (ret != 0) {\n         dbenv->close(0);\n-        return error(\"CDBEnv::Open: Error %d opening database environment: %s\\n\", ret, DbEnv::strerror(ret));\n+        LogPrintf(\"CDBEnv::Open: Error %d opening database environment: %s\\n\", ret, DbEnv::strerror(ret));\n+        if (retry) {\n+            // try moving the database env out of the way\n+            fs::path pathDatabaseBak = pathIn / strprintf(\"database.%d.bak\", GetTime());\n+            try {\n+                fs::rename(pathLogDir, pathDatabaseBak);\n+                LogPrintf(\"Moved old %s to %s. Retrying.\\n\", pathDatabase.string(), pathDatabaseBak.string());\n+            } catch (const fs::filesystem_error&) {\n+                // failure is ok (well, not really, but it's not worse than what we started with)\n+            }\n+            // try opening it again one more time\n+            if (!Open(walletDir, false)) {\n+                // if it still fails, it probably means we can't even create the database env\n+                return false;\n+            }\n+        return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11904#discussion_r157912347",
      "id" : 157912347,
      "in_reply_to_id" : 157908232,
      "original_commit_id" : "6ff6b2fba71a0f89011bc999de441b5074ff1d4e",
      "original_position" : 72,
      "path" : "src/wallet/db.cpp",
      "position" : null,
      "pull_request_review_id" : 84634932,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11904",
      "updated_at" : "2017-12-24T00:08:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/157912347",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/3211283?v=4",
         "events_url" : "https://api.github.com/users/MeshCollider/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MeshCollider/followers",
         "following_url" : "https://api.github.com/users/MeshCollider/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MeshCollider/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MeshCollider",
         "id" : 3211283,
         "login" : "MeshCollider",
         "organizations_url" : "https://api.github.com/users/MeshCollider/orgs",
         "received_events_url" : "https://api.github.com/users/MeshCollider/received_events",
         "repos_url" : "https://api.github.com/users/MeshCollider/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MeshCollider/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MeshCollider/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MeshCollider"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11904#discussion_r157912763"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11904"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/157912763"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`= false`?",
      "commit_id" : "edf5a3fd56100120de968f08f75b142f042a13d9",
      "created_at" : "2017-12-20T00:38:54Z",
      "diff_hunk" : "@@ -68,7 +68,7 @@ class CDBEnv\n     typedef std::pair<std::vector<unsigned char>, std::vector<unsigned char> > KeyValPair;\n     bool Salvage(const std::string& strFile, bool fAggressive, std::vector<KeyValPair>& vResult);\n \n-    bool Open(const fs::path& path);\n+    bool Open(const fs::path& path, bool retry = 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11904#discussion_r157912763",
      "id" : 157912763,
      "original_commit_id" : "d421c4bb7fc2156e6f6591152b5a610550cb5478",
      "original_position" : 5,
      "path" : "src/wallet/db.h",
      "position" : 5,
      "pull_request_review_id" : 84635332,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11904",
      "updated_at" : "2017-12-24T00:08:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/157912763",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11904#discussion_r157912908"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11904"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/157912908"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "BTW, how about:\r\n```cpp\r\nprivate:\r\n    bool Open(const fs::path& path, bool retry);\r\n\r\npublic:\r\n    bool Open(const fs::path& path) { return Open(path, true); }\r\n```\r\nthis way the *public* API remains, for instance, https://github.com/bitcoin/bitcoin/pull/11904/files#diff-5cd083d2c34da5f0ac380011f7b725d2R312 goes away.",
      "commit_id" : "edf5a3fd56100120de968f08f75b142f042a13d9",
      "created_at" : "2017-12-20T00:40:08Z",
      "diff_hunk" : "@@ -68,7 +68,7 @@ class CDBEnv\n     typedef std::pair<std::vector<unsigned char>, std::vector<unsigned char> > KeyValPair;\n     bool Salvage(const std::string& strFile, bool fAggressive, std::vector<KeyValPair>& vResult);\n \n-    bool Open(const fs::path& path);\n+    bool Open(const fs::path& path, bool retry = 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11904#discussion_r157912908",
      "id" : 157912908,
      "in_reply_to_id" : 157912763,
      "original_commit_id" : "d421c4bb7fc2156e6f6591152b5a610550cb5478",
      "original_position" : 5,
      "path" : "src/wallet/db.h",
      "position" : 5,
      "pull_request_review_id" : 84635332,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11904",
      "updated_at" : "2017-12-24T00:08:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/157912908",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11904#discussion_r157914236"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11904"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/157914236"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'd prefer to leave it explicit I think, is there any other benefit to hiding the retry parameter?",
      "commit_id" : "edf5a3fd56100120de968f08f75b142f042a13d9",
      "created_at" : "2017-12-20T00:49:39Z",
      "diff_hunk" : "@@ -68,7 +68,7 @@ class CDBEnv\n     typedef std::pair<std::vector<unsigned char>, std::vector<unsigned char> > KeyValPair;\n     bool Salvage(const std::string& strFile, bool fAggressive, std::vector<KeyValPair>& vResult);\n \n-    bool Open(const fs::path& path);\n+    bool Open(const fs::path& path, bool retry = 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11904#discussion_r157914236",
      "id" : 157914236,
      "in_reply_to_id" : 157912763,
      "original_commit_id" : "d421c4bb7fc2156e6f6591152b5a610550cb5478",
      "original_position" : 5,
      "path" : "src/wallet/db.h",
      "position" : 5,
      "pull_request_review_id" : 84636940,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11904",
      "updated_at" : "2017-12-24T00:08:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/157914236",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/3211283?v=4",
         "events_url" : "https://api.github.com/users/MeshCollider/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MeshCollider/followers",
         "following_url" : "https://api.github.com/users/MeshCollider/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MeshCollider/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MeshCollider",
         "id" : 3211283,
         "login" : "MeshCollider",
         "organizations_url" : "https://api.github.com/users/MeshCollider/orgs",
         "received_events_url" : "https://api.github.com/users/MeshCollider/received_events",
         "repos_url" : "https://api.github.com/users/MeshCollider/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MeshCollider/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MeshCollider/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MeshCollider"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11904#discussion_r157914686"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11904"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/157914686"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It's an internal detail, you should not be able to call `Open(path, false)`, it's only there for the 2nd attempt.",
      "commit_id" : "edf5a3fd56100120de968f08f75b142f042a13d9",
      "created_at" : "2017-12-20T00:53:27Z",
      "diff_hunk" : "@@ -68,7 +68,7 @@ class CDBEnv\n     typedef std::pair<std::vector<unsigned char>, std::vector<unsigned char> > KeyValPair;\n     bool Salvage(const std::string& strFile, bool fAggressive, std::vector<KeyValPair>& vResult);\n \n-    bool Open(const fs::path& path);\n+    bool Open(const fs::path& path, bool retry = 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11904#discussion_r157914686",
      "id" : 157914686,
      "in_reply_to_id" : 157912763,
      "original_commit_id" : "d421c4bb7fc2156e6f6591152b5a610550cb5478",
      "original_position" : 5,
      "path" : "src/wallet/db.h",
      "position" : 5,
      "pull_request_review_id" : 84637425,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11904",
      "updated_at" : "2017-12-24T00:08:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/157914686",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11904#discussion_r157916549"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11904"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/157916549"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Its also called without retry here: \r\nhttps://github.com/MeshCollider/bitcoin/blob/f70ce89806a7f0ce1755e7d074f6e07753a85694/src/wallet/db.cpp#L436",
      "commit_id" : "edf5a3fd56100120de968f08f75b142f042a13d9",
      "created_at" : "2017-12-20T01:08:54Z",
      "diff_hunk" : "@@ -68,7 +68,7 @@ class CDBEnv\n     typedef std::pair<std::vector<unsigned char>, std::vector<unsigned char> > KeyValPair;\n     bool Salvage(const std::string& strFile, bool fAggressive, std::vector<KeyValPair>& vResult);\n \n-    bool Open(const fs::path& path);\n+    bool Open(const fs::path& path, bool retry = 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11904#discussion_r157916549",
      "id" : 157916549,
      "in_reply_to_id" : 157912763,
      "original_commit_id" : "d421c4bb7fc2156e6f6591152b5a610550cb5478",
      "original_position" : 5,
      "path" : "src/wallet/db.h",
      "position" : 5,
      "pull_request_review_id" : 84639566,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11904",
      "updated_at" : "2017-12-24T00:08:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/157916549",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/3211283?v=4",
         "events_url" : "https://api.github.com/users/MeshCollider/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MeshCollider/followers",
         "following_url" : "https://api.github.com/users/MeshCollider/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MeshCollider/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MeshCollider",
         "id" : 3211283,
         "login" : "MeshCollider",
         "organizations_url" : "https://api.github.com/users/MeshCollider/orgs",
         "received_events_url" : "https://api.github.com/users/MeshCollider/received_events",
         "repos_url" : "https://api.github.com/users/MeshCollider/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MeshCollider/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MeshCollider/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MeshCollider"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11904#discussion_r158247611"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11904"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/158247611"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ok, missed that.",
      "commit_id" : "edf5a3fd56100120de968f08f75b142f042a13d9",
      "created_at" : "2017-12-21T10:49:42Z",
      "diff_hunk" : "@@ -68,7 +68,7 @@ class CDBEnv\n     typedef std::pair<std::vector<unsigned char>, std::vector<unsigned char> > KeyValPair;\n     bool Salvage(const std::string& strFile, bool fAggressive, std::vector<KeyValPair>& vResult);\n \n-    bool Open(const fs::path& path);\n+    bool Open(const fs::path& path, bool retry = 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11904#discussion_r158247611",
      "id" : 158247611,
      "in_reply_to_id" : 157912763,
      "original_commit_id" : "d421c4bb7fc2156e6f6591152b5a610550cb5478",
      "original_position" : 5,
      "path" : "src/wallet/db.h",
      "position" : 5,
      "pull_request_review_id" : 85026528,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11904",
      "updated_at" : "2017-12-24T00:08:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/158247611",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Tested ACK. Needs squash.",
      "created_at" : "2017-12-21T15:23:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11904#issuecomment-353377831",
      "id" : 353377831,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11904",
      "updated_at" : "2017-12-21T15:23:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/353377831",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11904#discussion_r158317339"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11904"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/158317339"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Didn't notice this before, and no need for a change now, but just in case #11687 is somehow merged before this PR, static variable here should move to CDBEnv instance variable. (A single static variable can't guard different database directories if different database directories may be opened during the lifetime of the process.)",
      "commit_id" : "edf5a3fd56100120de968f08f75b142f042a13d9",
      "created_at" : "2017-12-21T16:16:16Z",
      "diff_hunk" : "@@ -52,6 +53,24 @@ void CheckUniqueFileid(const CDBEnv& env, const std::string& filename, Db& db)\n         }\n     }\n }\n+\n+bool LockEnvDirectory(const fs::path& env_path)\n+{\n+    // Make sure only a single Bitcoin process is using the wallet directory.\n+    fs::path lock_file_path = env_path / \".lock\";\n+    FILE* file = fsbridge::fopen(lock_file_path, \"a\"); // empty lock file; created if it doesn't exist.\n+    if (file) fclose(file);\n+\n+    try {\n+        static boost::interprocess::file_lock lock(lock_file_path.string().c_str());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11904#discussion_r158317339",
      "id" : 158317339,
      "original_commit_id" : "f70ce89806a7f0ce1755e7d074f6e07753a85694",
      "original_position" : 21,
      "path" : "src/wallet/db.cpp",
      "position" : 21,
      "pull_request_review_id" : 85109570,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11904",
      "updated_at" : "2017-12-24T00:08:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/158317339",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11904#discussion_r158318929"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11904"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/158318929"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Might want to keep the previous generic error here (\"Error initializing wallet database environment\") since this can happen in other conditions than failing to obtain the lock.",
      "commit_id" : "edf5a3fd56100120de968f08f75b142f042a13d9",
      "created_at" : "2017-12-21T16:22:32Z",
      "diff_hunk" : "@@ -269,25 +309,11 @@ bool CDB::VerifyEnvironment(const std::string& walletFile, const fs::path& walle\n         return false;\n     }\n \n-    if (!bitdb.Open(walletDir))\n-    {\n-        // try moving the database env out of the way\n-        fs::path pathDatabase = walletDir / \"database\";\n-        fs::path pathDatabaseBak = walletDir / strprintf(\"database.%d.bak\", GetTime());\n-        try {\n-            fs::rename(pathDatabase, pathDatabaseBak);\n-            LogPrintf(\"Moved old %s to %s. Retrying.\\n\", pathDatabase.string(), pathDatabaseBak.string());\n-        } catch (const fs::filesystem_error&) {\n-            // failure is ok (well, not really, but it's not worse than what we started with)\n-        }\n-\n-        // try again\n-        if (!bitdb.Open(walletDir)) {\n-            // if it still fails, it probably means we can't even create the database env\n-            errorStr = strprintf(_(\"Error initializing wallet database environment %s!\"), walletDir);\n-            return false;\n-        }\n+    if (!bitdb.Open(walletDir, true)) {\n+        errorStr = strprintf(_(\"Cannot obtain a lock on wallet directory %s. Another instance of bitcoin may be using it.\"), walletDir);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11904#discussion_r158318929",
      "id" : 158318929,
      "original_commit_id" : "f70ce89806a7f0ce1755e7d074f6e07753a85694",
      "original_position" : 101,
      "path" : "src/wallet/db.cpp",
      "position" : null,
      "pull_request_review_id" : 85109570,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11904",
      "updated_at" : "2017-12-24T00:08:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/158318929",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Squashed and added a commit to modify the error message as suggested.\r\n\r\nNote travis failure on second commit is just because the last three tests were cancelled due to third commit being pushed before they started",
      "created_at" : "2017-12-23T23:46:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11904#issuecomment-353754724",
      "id" : 353754724,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11904",
      "updated_at" : "2017-12-24T00:10:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/353754724",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/3211283?v=4",
         "events_url" : "https://api.github.com/users/MeshCollider/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MeshCollider/followers",
         "following_url" : "https://api.github.com/users/MeshCollider/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MeshCollider/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MeshCollider",
         "id" : 3211283,
         "login" : "MeshCollider",
         "organizations_url" : "https://api.github.com/users/MeshCollider/orgs",
         "received_events_url" : "https://api.github.com/users/MeshCollider/received_events",
         "repos_url" : "https://api.github.com/users/MeshCollider/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MeshCollider/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MeshCollider/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MeshCollider"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11904#discussion_r158646847"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11904"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/158646847"
         }
      },
      "author_association" : "OWNER",
      "body" : "What if the walletdir is the same as the datadir? Won't there be a problem if both use the same lockfile? I would consider renaming this to `\".walletlock\"` perhaps (which is also clearer to people who see the file).",
      "commit_id" : "edf5a3fd56100120de968f08f75b142f042a13d9",
      "created_at" : "2017-12-25T14:51:56Z",
      "diff_hunk" : "@@ -52,6 +53,24 @@ void CheckUniqueFileid(const CDBEnv& env, const std::string& filename, Db& db)\n         }\n     }\n }\n+\n+bool LockEnvDirectory(const fs::path& env_path)\n+{\n+    // Make sure only a single Bitcoin process is using the wallet directory.\n+    fs::path lock_file_path = env_path / \".lock\";",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11904#discussion_r158646847",
      "id" : 158646847,
      "original_commit_id" : "edf5a3fd56100120de968f08f75b142f042a13d9",
      "original_position" : 16,
      "path" : "src/wallet/db.cpp",
      "position" : 16,
      "pull_request_review_id" : 85489103,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11904",
      "updated_at" : "2017-12-25T14:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/158646847",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11904#discussion_r158646896"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11904"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/158646896"
         }
      },
      "author_association" : "OWNER",
      "body" : "A lot in this function seems to be a duplication from `LockDataDirectory` in `init.cpp`. What do you think about abstracting them out to a utility function in `util.cpp` instead?",
      "commit_id" : "edf5a3fd56100120de968f08f75b142f042a13d9",
      "created_at" : "2017-12-25T14:53:02Z",
      "diff_hunk" : "@@ -52,6 +53,24 @@ void CheckUniqueFileid(const CDBEnv& env, const std::string& filename, Db& db)\n         }\n     }\n }\n+\n+bool LockEnvDirectory(const fs::path& env_path)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11904#discussion_r158646896",
      "id" : 158646896,
      "original_commit_id" : "edf5a3fd56100120de968f08f75b142f042a13d9",
      "original_position" : 13,
      "path" : "src/wallet/db.cpp",
      "position" : 13,
      "pull_request_review_id" : 85489103,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11904",
      "updated_at" : "2017-12-25T14:53:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/158646896",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11904#discussion_r158647046"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11904"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/158647046"
         }
      },
      "author_association" : "OWNER",
      "body" : "Reading more, I think this is indeed advisable:\r\n\r\nFrom http://www.boost.org/doc/libs/1_55_0/doc/html/interprocess/synchronization_mechanisms.html#interprocess.synchronization_mechanisms.file_lock:\r\n> * It's unspecified if a file_lock synchronizes two threads from the same process.\r\n> * It's unspecified if a process can use two file_lock objects pointing to the same file.\r\n",
      "commit_id" : "edf5a3fd56100120de968f08f75b142f042a13d9",
      "created_at" : "2017-12-25T14:58:07Z",
      "diff_hunk" : "@@ -52,6 +53,24 @@ void CheckUniqueFileid(const CDBEnv& env, const std::string& filename, Db& db)\n         }\n     }\n }\n+\n+bool LockEnvDirectory(const fs::path& env_path)\n+{\n+    // Make sure only a single Bitcoin process is using the wallet directory.\n+    fs::path lock_file_path = env_path / \".lock\";",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11904#discussion_r158647046",
      "id" : 158647046,
      "in_reply_to_id" : 158646847,
      "original_commit_id" : "edf5a3fd56100120de968f08f75b142f042a13d9",
      "original_position" : 16,
      "path" : "src/wallet/db.cpp",
      "position" : 16,
      "pull_request_review_id" : 85489319,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11904",
      "updated_at" : "2017-12-25T14:58:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/158647046",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   }
]
