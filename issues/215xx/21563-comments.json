[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #21527 (NOMERGE: net_processing: orphan handling changes by ajtowns)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-04-01T04:24:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21563#issuecomment-811627872",
      "id" : 811627872,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21563",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxMTYyNzg3Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-20T08:37:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/811627872",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "EDIT: This PR has substantially changed. The comment below refers to the old branch.\r\n\r\nThis does indeed seem useless. The mutex was added by @TheBlueMatt in commit d7c58ad514ee00db00589216166808258bc16b60:\r\n\r\n>    Split CNode::cs_vSend: message processing and message sending\r\n>    \r\n>    cs_vSend is used for two purposes - to lock the datastructures used\r\n>    to queue messages to place on the wire and to only call\r\n>    SendMessages once at a time per-node. I believe SendMessages used\r\n>    to access some of the vSendMsg stuff, but it doesn't anymore, so\r\n>    these locks do not need to be on the same mutex, and also make\r\n>    deadlocking much more likely.\r\n\r\nWe're implicitly guaranteed to only call `SendMessages()` serially since it's only ever called by message handler thread. If we want to be explicit about it, it'd be better to add a global lock to `PeerManagerImpl` (or per-`Peer` object), so that net_processing is enforcing its own synchronization internally.",
      "created_at" : "2021-04-02T11:04:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21563#issuecomment-812483710",
      "id" : 812483710,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21563",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxMjQ4MzcxMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-20T14:03:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/812483710",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-04-06T09:42:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21563#issuecomment-813983421",
      "id" : 813983421,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21563",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxMzk4MzQyMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-06T09:42:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/813983421",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased 8ca2ee6377f534b15b47440b819b1564c9c06b88 -> b58097facb4fec80df8fa140dfefd9c461c93832 ([pr21563.02](https://github.com/hebasto/bitcoin/commits/pr21563.02) -> [pr21563.03](https://github.com/hebasto/bitcoin/commits/pr21563.03)) due to the conflict with #21571.",
      "created_at" : "2021-04-07T12:11:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21563#issuecomment-814863105",
      "id" : 814863105,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21563",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxNDg2MzEwNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-07T12:11:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/814863105",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This seems safe to me. The only thing that `CNode.cs_sendProcessing` enforces is preventing `SendMessages()` from being called for the same `CNode` concurrently. However, `SendMessages()` can only be called by `threadMessageHandler`, so there's no possibility of it being called concurrently.\r\n\r\nI wonder if instead of simply removing this, we should replace it with something that more closely documents our expectations. I think that calling any of the `NetEventsInterface` methods (`InitializeNode`, `FinalizeNode`, `SendMessages`, `ProcessMessages`) in `PeerManagerImpl` concurrently could lead to problems, so perhaps a global mutex in `PeerManagerImpl` should be added that's taken whenever any of those functions are called? If we ever want to add concurrency to `PeerManagerImpl`, we could look at loosening that restriction.",
      "created_at" : "2021-04-09T09:04:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21563#issuecomment-816538311",
      "id" : 816538311,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21563",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxNjUzODMxMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-09T09:04:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/816538311",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@jnewbery \r\n> I wonder if instead of simply removing this, we should replace it with something that more closely documents our expectations. I think that calling any of the `NetEventsInterface` methods (`InitializeNode`, `FinalizeNode`, `SendMessages`, `ProcessMessages`) in `PeerManagerImpl` concurrently could lead to problems, so perhaps a global mutex in `PeerManagerImpl` should be added that's taken whenever any of those functions are called? If we ever want to add concurrency to `PeerManagerImpl`, we could look at loosening that restriction.\r\n\r\nMaybe postpone it until #19398 is fulfilled?",
      "created_at" : "2021-04-09T10:00:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21563#issuecomment-816571392",
      "id" : 816571392,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21563",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxNjU3MTM5Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-09T10:00:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/816571392",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Maybe postpone it until #19398 is fulfilled?\r\n\r\nI think they can be done independently. But I think I'd like to see the new internal PeerManagerImpl lock being introduced in the same PR that removes cs_sendProcessing.",
      "created_at" : "2021-04-09T17:53:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21563#issuecomment-816853404",
      "id" : 816853404,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21563",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxNjg1MzQwNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-09T17:53:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/816853404",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Updated b58097facb4fec80df8fa140dfefd9c461c93832 -> 4de76058f8c3150de07d7a02faaceb261d732499 ([pr21563.03](https://github.com/hebasto/bitcoin/commits/pr21563.03) -> [pr21563.04](https://github.com/hebasto/bitcoin/commits/pr21563.04)):\r\n\r\n- rebased on top of the recent changes in CI\r\n- addressed @jnewbery's [comment](https://github.com/bitcoin/bitcoin/pull/21563#issuecomment-816538311)",
      "created_at" : "2021-04-12T12:42:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21563#issuecomment-817778741",
      "id" : 817778741,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21563",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxNzc3ODc0MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-12T12:42:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/817778741",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "```\r\n node0 stderr libc++abi.dylib: terminating with uncaught exception of type std::__1::system_error: mutex lock failed: Invalid argument \r\n```\r\n\r\nhttps://cirrus-ci.com/task/5038649289998336?logs=ci#L3615",
      "created_at" : "2021-04-12T13:54:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21563#issuecomment-817832368",
      "id" : 817832368,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21563",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxNzgzMjM2OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-12T13:54:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/817832368",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> ```\r\n>  node0 stderr libc++abi.dylib: terminating with uncaught exception of type std::__1::system_error: mutex lock failed: Invalid argument \r\n> ```\r\n> \r\n> https://cirrus-ci.com/task/5038649289998336?logs=ci#L3615\r\n\r\nLooks like a mutex is prematurely destroyed. Weird.",
      "created_at" : "2021-04-12T14:11:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21563#issuecomment-817845316",
      "id" : 817845316,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21563",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxNzg0NTMxNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-12T14:11:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/817845316",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Updated 4de76058f8c3150de07d7a02faaceb261d732499 -> b1e5ca217c3557ed89d985c7e8ea28c2b9ed303b ([pr21563.04](https://github.com/hebasto/bitcoin/commits/pr21563.04) -> [pr21563.05](https://github.com/hebasto/bitcoin/commits/pr21563.05), [diff](https://github.com/hebasto/bitcoin/compare/pr21563.04..pr21563.05)):\r\n\r\n- fixed bug\r\n",
      "created_at" : "2021-04-12T19:54:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21563#issuecomment-818107599",
      "id" : 818107599,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21563",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxODEwNzU5OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-12T19:54:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/818107599",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21563#discussion_r612311671"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21563"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612311671"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This can now be replaced with `if (node.connman) node.connman->Stop()`.",
      "commit_id" : "9766b7f43d4fedd1740f4444689b6ba2ff33d12d",
      "created_at" : "2021-04-13T10:07:29Z",
      "diff_hunk" : "@@ -200,18 +200,8 @@ void Shutdown(NodeContext& node)\n     // Because these depend on each-other, we make sure that neither can be\n     // using the other before destroying them.\n     if (node.peerman) UnregisterValidationInterface(node.peerman.get());\n-    // Follow the lock order requirements:\n-    // * CheckForStaleTipAndEvictPeers locks cs_main before indirectly calling GetExtraFullOutboundCount\n-    //   which locks cs_vNodes.\n-    // * ProcessMessage locks cs_main and g_cs_orphans before indirectly calling ForEachNode which\n-    //   locks cs_vNodes.\n-    // * CConnman::Stop calls DeleteNode, which calls FinalizeNode, which locks cs_main and calls\n-    //   EraseOrphansFor, which locks g_cs_orphans.\n-    //\n-    // Thus the implicit locking order requirement is: (1) cs_main, (2) g_cs_orphans, (3) cs_vNodes.\n     if (node.connman) {\n         node.connman->StopThreads();\n-        LOCK2(::cs_main, ::g_cs_orphans);\n         node.connman->StopNodes();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21563#discussion_r612311671",
      "id" : 612311671,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjMxMTY3MQ==",
      "original_commit_id" : "b1e5ca217c3557ed89d985c7e8ea28c2b9ed303b",
      "original_line" : 205,
      "original_position" : 16,
      "original_start_line" : 204,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 634409957,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21563",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-20T13:49:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612311671",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21563#discussion_r612312840"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21563"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612312840"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this lock can be held for much less time:\r\n\r\n```c++\r\n    // Delete peer connections\r\n    std::vector<CNode*> nodes;\r\n    {\r\n        LOCK(cs_vNodes);\r\n        nodes = std::move(vNodes);\r\n        vNodes.clear();\r\n    }\r\n\r\n    for (CNode* pnode : nodes) {\r\n        pnode->CloseSocketDisconnect();\r\n        DeleteNode(pnode);\r\n    }\r\n\r\n    for (CNode* pnode : vNodesDisconnected) {\r\n        DeleteNode(pnode);\r\n    }\r\n    vNodesDisconnected.clear();\r\n\r\n    // Close listening sockets\r\n    for (ListenSocket& hListenSocket : vhListenSocket) {\r\n        if (hListenSocket.socket != INVALID_SOCKET) {\r\n            if (!CloseSocket(hListenSocket.socket)) {\r\n                LogPrintf(\"CloseSocket(hListenSocket) failed with error %s\\n\", NetworkErrorString(WSAGetLastError()));\r\n            }\r\n        }\r\n    }\r\n    vhListenSocket.clear();\r\n\r\n    semOutbound.reset();\r\n    semAddnode.reset();\r\n```",
      "commit_id" : "9766b7f43d4fedd1740f4444689b6ba2ff33d12d",
      "created_at" : "2021-04-13T10:09:15Z",
      "diff_hunk" : "@@ -2636,6 +2633,9 @@ void CConnman::StopNodes()\n     }\n \n     // Close sockets\n+    std::vector<CNode*> nodes;\n+    std::list<CNode*> nodes_disconnected;\n+    {\n     LOCK(cs_vNodes);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21563#discussion_r612312840",
      "id" : 612312840,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjMxMjg0MA==",
      "original_commit_id" : "b1e5ca217c3557ed89d985c7e8ea28c2b9ed303b",
      "original_line" : 2639,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 634409957,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21563",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-20T13:49:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612312840",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21563#discussion_r612313941"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21563"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612313941"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What do you think about excluding holding `cs_main` when calling into a NetEventsInterface method?",
      "commit_id" : "9766b7f43d4fedd1740f4444689b6ba2ff33d12d",
      "created_at" : "2021-04-13T10:11:04Z",
      "diff_hunk" : "@@ -238,10 +238,10 @@ class PeerManagerImpl final : public PeerManager\n     void NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock) override;\n \n     /** Implement NetEventsInterface */\n-    void InitializeNode(CNode* pnode) override;\n-    void FinalizeNode(const CNode& node) override;\n-    bool ProcessMessages(CNode* pfrom, std::atomic<bool>& interrupt) override;\n-    bool SendMessages(CNode* pto) override EXCLUSIVE_LOCKS_REQUIRED(pto->cs_sendProcessing);\n+    void InitializeNode(CNode* pnode) override EXCLUSIVE_LOCKS_REQUIRED(!m_net_events_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21563#discussion_r612313941",
      "id" : 612313941,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjMxMzk0MQ==",
      "original_commit_id" : "b1e5ca217c3557ed89d985c7e8ea28c2b9ed303b",
      "original_line" : 241,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 634409957,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21563",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-20T13:49:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612313941",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21563#discussion_r612314992"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21563"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612314992"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You can also remove the `LOCK2(::cs_main, g_cs_orphans);` from `fuzz/process_message.cpp` and `fuzz/process_messages.cpp`.",
      "commit_id" : "9766b7f43d4fedd1740f4444689b6ba2ff33d12d",
      "created_at" : "2021-04-13T10:12:49Z",
      "diff_hunk" : "@@ -200,18 +200,8 @@ void Shutdown(NodeContext& node)\n     // Because these depend on each-other, we make sure that neither can be\n     // using the other before destroying them.\n     if (node.peerman) UnregisterValidationInterface(node.peerman.get());\n-    // Follow the lock order requirements:\n-    // * CheckForStaleTipAndEvictPeers locks cs_main before indirectly calling GetExtraFullOutboundCount\n-    //   which locks cs_vNodes.\n-    // * ProcessMessage locks cs_main and g_cs_orphans before indirectly calling ForEachNode which\n-    //   locks cs_vNodes.\n-    // * CConnman::Stop calls DeleteNode, which calls FinalizeNode, which locks cs_main and calls\n-    //   EraseOrphansFor, which locks g_cs_orphans.\n-    //\n-    // Thus the implicit locking order requirement is: (1) cs_main, (2) g_cs_orphans, (3) cs_vNodes.\n     if (node.connman) {\n         node.connman->StopThreads();\n-        LOCK2(::cs_main, ::g_cs_orphans);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21563#discussion_r612314992",
      "id" : 612314992,
      "line" : 214,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjMxNDk5Mg==",
      "original_commit_id" : "b1e5ca217c3557ed89d985c7e8ea28c2b9ed303b",
      "original_line" : 214,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 15,
      "pull_request_review_id" : 634409957,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21563",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-20T13:49:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612314992",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Updated b1e5ca217c3557ed89d985c7e8ea28c2b9ed303b -> a3663329ad1899cc012437167a316040d77e00bc ([pr21563.05](https://github.com/hebasto/bitcoin/commits/pr21563.05) -> [pr21563.06](https://github.com/hebasto/bitcoin/commits/pr21563.06)):\r\n\r\n- rebased on top of the recent CI changes\r\n- addressed @jnewbery's comments ",
      "created_at" : "2021-04-13T12:50:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21563#issuecomment-818709445",
      "id" : 818709445,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21563",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxODcwOTQ0NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-13T12:50:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/818709445",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21563#discussion_r612415999"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21563"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612415999"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks! [Updated](https://github.com/bitcoin/bitcoin/pull/21563#issuecomment-818709445).",
      "commit_id" : "9766b7f43d4fedd1740f4444689b6ba2ff33d12d",
      "created_at" : "2021-04-13T12:50:47Z",
      "diff_hunk" : "@@ -200,18 +200,8 @@ void Shutdown(NodeContext& node)\n     // Because these depend on each-other, we make sure that neither can be\n     // using the other before destroying them.\n     if (node.peerman) UnregisterValidationInterface(node.peerman.get());\n-    // Follow the lock order requirements:\n-    // * CheckForStaleTipAndEvictPeers locks cs_main before indirectly calling GetExtraFullOutboundCount\n-    //   which locks cs_vNodes.\n-    // * ProcessMessage locks cs_main and g_cs_orphans before indirectly calling ForEachNode which\n-    //   locks cs_vNodes.\n-    // * CConnman::Stop calls DeleteNode, which calls FinalizeNode, which locks cs_main and calls\n-    //   EraseOrphansFor, which locks g_cs_orphans.\n-    //\n-    // Thus the implicit locking order requirement is: (1) cs_main, (2) g_cs_orphans, (3) cs_vNodes.\n     if (node.connman) {\n         node.connman->StopThreads();\n-        LOCK2(::cs_main, ::g_cs_orphans);\n         node.connman->StopNodes();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21563#discussion_r612415999",
      "id" : 612415999,
      "in_reply_to_id" : 612311671,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjQxNTk5OQ==",
      "original_commit_id" : "b1e5ca217c3557ed89d985c7e8ea28c2b9ed303b",
      "original_line" : 205,
      "original_position" : 16,
      "original_start_line" : 204,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 634547684,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21563",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-20T13:49:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612415999",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21563#discussion_r612416239"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21563"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612416239"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks! [Updated](https://github.com/bitcoin/bitcoin/pull/21563#issuecomment-818709445).",
      "commit_id" : "9766b7f43d4fedd1740f4444689b6ba2ff33d12d",
      "created_at" : "2021-04-13T12:51:05Z",
      "diff_hunk" : "@@ -2636,6 +2633,9 @@ void CConnman::StopNodes()\n     }\n \n     // Close sockets\n+    std::vector<CNode*> nodes;\n+    std::list<CNode*> nodes_disconnected;\n+    {\n     LOCK(cs_vNodes);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21563#discussion_r612416239",
      "id" : 612416239,
      "in_reply_to_id" : 612312840,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjQxNjIzOQ==",
      "original_commit_id" : "b1e5ca217c3557ed89d985c7e8ea28c2b9ed303b",
      "original_line" : 2639,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 634547987,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21563",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-20T13:49:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612416239",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21563#discussion_r612416480"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21563"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612416480"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks! [Updated](https://github.com/bitcoin/bitcoin/pull/21563#issuecomment-818709445).",
      "commit_id" : "9766b7f43d4fedd1740f4444689b6ba2ff33d12d",
      "created_at" : "2021-04-13T12:51:24Z",
      "diff_hunk" : "@@ -200,18 +200,8 @@ void Shutdown(NodeContext& node)\n     // Because these depend on each-other, we make sure that neither can be\n     // using the other before destroying them.\n     if (node.peerman) UnregisterValidationInterface(node.peerman.get());\n-    // Follow the lock order requirements:\n-    // * CheckForStaleTipAndEvictPeers locks cs_main before indirectly calling GetExtraFullOutboundCount\n-    //   which locks cs_vNodes.\n-    // * ProcessMessage locks cs_main and g_cs_orphans before indirectly calling ForEachNode which\n-    //   locks cs_vNodes.\n-    // * CConnman::Stop calls DeleteNode, which calls FinalizeNode, which locks cs_main and calls\n-    //   EraseOrphansFor, which locks g_cs_orphans.\n-    //\n-    // Thus the implicit locking order requirement is: (1) cs_main, (2) g_cs_orphans, (3) cs_vNodes.\n     if (node.connman) {\n         node.connman->StopThreads();\n-        LOCK2(::cs_main, ::g_cs_orphans);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21563#discussion_r612416480",
      "id" : 612416480,
      "in_reply_to_id" : 612314992,
      "line" : 214,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjQxNjQ4MA==",
      "original_commit_id" : "b1e5ca217c3557ed89d985c7e8ea28c2b9ed303b",
      "original_line" : 214,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 15,
      "pull_request_review_id" : 634548303,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21563",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-20T13:49:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612416480",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21563#discussion_r612418192"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21563"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612418192"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It is not trivial due to the https://github.com/bitcoin/bitcoin/blob/c1f480fb234856a60e9b1f4bf97114bfd9b3d0b0/src/net_processing.cpp#L662\r\n\r\nGoing to keep the scope of this PR tight.",
      "commit_id" : "9766b7f43d4fedd1740f4444689b6ba2ff33d12d",
      "created_at" : "2021-04-13T12:53:42Z",
      "diff_hunk" : "@@ -238,10 +238,10 @@ class PeerManagerImpl final : public PeerManager\n     void NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock) override;\n \n     /** Implement NetEventsInterface */\n-    void InitializeNode(CNode* pnode) override;\n-    void FinalizeNode(const CNode& node) override;\n-    bool ProcessMessages(CNode* pfrom, std::atomic<bool>& interrupt) override;\n-    bool SendMessages(CNode* pto) override EXCLUSIVE_LOCKS_REQUIRED(pto->cs_sendProcessing);\n+    void InitializeNode(CNode* pnode) override EXCLUSIVE_LOCKS_REQUIRED(!m_net_events_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21563#discussion_r612418192",
      "id" : 612418192,
      "in_reply_to_id" : 612313941,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjQxODE5Mg==",
      "original_commit_id" : "b1e5ca217c3557ed89d985c7e8ea28c2b9ed303b",
      "original_line" : 241,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 634550530,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21563",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-20T13:49:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612418192",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This seems good to me.\r\n\r\n@MarcoFalke - you introduced the `LOCK2(::cs_main, ::g_cs_orphans);` in #18458. Do you see any problem with locking `cs_vNodes`, grabbing a copy of `vNodes`, releasing the lock and then deleting the nodes in `CConnman::Stop()`? This is similar to what happens in the socket handler and message handler threads?",
      "created_at" : "2021-04-13T12:55:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21563#issuecomment-818713120",
      "id" : 818713120,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21563",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxODcxMzEyMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-13T12:55:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/818713120",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Removing a mutex that guards nothing then adding a mutex that also doesn't actually guard anything seems a bit backwards...\r\n\r\n#21527 has it guarding the extratxns data structures (as part of getting rid of g_cs_orphans). It would be good for it to be able to guard the address data structures in struct Peer, but without it being a global, that will probably be awkward at best, since Peer doesn't have a reference back to PeerManagerImpl.\r\n\r\nThe cs_vNodes changes don't seem to be mentioned in the title or PR description?",
      "created_at" : "2021-04-20T07:37:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21563#issuecomment-823051060",
      "id" : 823051060,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21563",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyMzA1MTA2MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-20T07:37:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/823051060",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "The fist commit seems separate from the other changes?",
      "created_at" : "2021-04-20T07:49:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21563#issuecomment-823059284",
      "id" : 823059284,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21563",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyMzA1OTI4NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-20T07:49:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/823059284",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Updated a3663329ad1899cc012437167a316040d77e00bc -> 9766b7f43d4fedd1740f4444689b6ba2ff33d12d ([pr21563.06](https://github.com/hebasto/bitcoin/commits/pr21563.06) -> [pr21563.07](https://github.com/hebasto/bitcoin/commits/pr21563.07)):\r\n\r\n- dropped all commits but the first one in favor of #21527\r\n\r\n> The cs_vNodes changes don't seem to be mentioned in the title or PR description?\r\n\r\nThe PR description updated.\r\n",
      "created_at" : "2021-04-20T14:02:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21563#issuecomment-823299566",
      "id" : 823299566,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21563",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyMzI5OTU2Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-20T14:04:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/823299566",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I think this change is fine. It steals the `CNode*`s from `vNodes`, releases the mutex and then cleans up the nodes. That's very similar to the pattern in `SocketHandler()`:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/018045347110d76cfc1f89a79fb49a867e3b8449/src/net.cpp#L1481-L1487\r\n\r\nand in `ThreadMessageHandler()`:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/018045347110d76cfc1f89a79fb49a867e3b8449/src/net.cpp#L2185-L2192\r\n\r\nThe difference being that in those cases, an extra reference is taken and `nRefCount` is incremented. Here, the reference count is not incremented since the pointer is stolen from `vNodes` before clearing that vector.\r\n\r\nPerhaps we could document our assumptions by calling `Release()` on the `CNode` object when stealing it from `vNodes` or immediately before calling `DeleteNode()`, and then asserting that `nRefCount == 0` in the `CNode` destructor? Maybe in a follow up.",
      "created_at" : "2021-04-20T14:18:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21563#issuecomment-823312404",
      "id" : 823312404,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21563",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyMzMxMjQwNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-20T14:18:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/823312404",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21563#discussion_r617079727"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21563"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617079727"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Could write this as:\r\n\r\n```c++\r\ncs_vNodes.lock();\r\nstd::vector<CNode*> nodes(std::move(vNodes)); // move constructor clears vNodes\r\ncs_vNodes.unlock();\r\n``` \r\n\r\nIf I'm reading the spec right, the move constructor is guaranteed to be constant time, while `operator=` is linear time; and the move constructor also guarantees the original ends up cleared. Since C++17 the move constructor is also marked noexcept, so `lock` and `unlock` in place of RAII locks should be sound. Alternatively, could use `WAIT_LOCK(cs_vNodes, lock); ...; REVERSE_LOCK(lock);`.",
      "commit_id" : "9766b7f43d4fedd1740f4444689b6ba2ff33d12d",
      "created_at" : "2021-04-20T22:45:08Z",
      "diff_hunk" : "@@ -2635,25 +2635,34 @@ void CConnman::StopNodes()\n         }\n     }\n \n-    // Close sockets\n-    LOCK(cs_vNodes);\n-    for (CNode* pnode : vNodes)\n-        pnode->CloseSocketDisconnect();\n-    for (ListenSocket& hListenSocket : vhListenSocket)\n-        if (hListenSocket.socket != INVALID_SOCKET)\n-            if (!CloseSocket(hListenSocket.socket))\n-                LogPrintf(\"CloseSocket(hListenSocket) failed with error %s\\n\", NetworkErrorString(WSAGetLastError()));\n+    // Delete peer connections\n+    std::vector<CNode*> nodes;\n+    {\n+        LOCK(cs_vNodes);\n+        nodes = std::move(vNodes);\n+        vNodes.clear();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21563#discussion_r617079727",
      "id" : 617079727,
      "line" : 2643,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzA3OTcyNw==",
      "original_commit_id" : "9766b7f43d4fedd1740f4444689b6ba2ff33d12d",
      "original_line" : 2643,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 17,
      "pull_request_review_id" : 640481202,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21563",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-20T22:58:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617079727",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   }
]
