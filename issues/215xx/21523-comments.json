[
   {
      "author_association" : "MEMBER",
      "body" : "I guess after rebasing on top of 2bdf37fe187ba6f090a0f5299b74d5d82cde4697, most of this is just a name change. But there are still a few changes of substance and the rename is probably worth doing.",
      "created_at" : "2021-03-24T16:40:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21523#issuecomment-805980810",
      "id" : 805980810,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21523",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwNTk4MDgxMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-24T16:40:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/805980810",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #21463 (doc: Address feedback from Transifex translator community by hebasto)\n* #21391 ([Bundle 5/n] Prune g_chainman usage in RPC modules by dongcarl)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-03-24T21:40:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21523#issuecomment-806203880",
      "id" : 806203880,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21523",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwNjIwMzg4MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-24T21:40:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/806203880",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21523#discussion_r610078206"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21523"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/610078206"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: parameterize VerifyDB by chainstate\" (cd93f827eb1178c3b001b45af5c062bf0be2cf05)\r\n\r\nCould comment below be updated to explain the `g_chainman` check?\r\n\r\nAlso could logprint below be updated to not mention pruning if block isn't pruned?\r\n\r\nAlso it would seem more direct and less likely to hide errors to check here if `chainstate` specifically is an unvalidated snapshot, instead of checking if there is just any snapshot. This would avoid hiding legitimate errors if the background chainstate is missing blocks.",
      "commit_id" : "cd93f827eb1178c3b001b45af5c062bf0be2cf05",
      "created_at" : "2021-04-08T20:31:45Z",
      "diff_hunk" : "@@ -4247,37 +4247,40 @@ CVerifyDB::~CVerifyDB()\n     uiInterface.ShowProgress(\"\", 100, false);\n }\n \n-bool CVerifyDB::VerifyDB(const CChainParams& chainparams, CChainState& active_chainstate, CCoinsView *coinsview, int nCheckLevel, int nCheckDepth)\n+bool CVerifyDB::VerifyDB(\n+    CChainState& chainstate,\n+    const CChainParams& chainparams,\n+    CCoinsView& coinsview,\n+    int nCheckLevel, int nCheckDepth)\n {\n     AssertLockHeld(cs_main);\n \n-    assert(std::addressof(::ChainstateActive()) == std::addressof(active_chainstate));\n-    if (active_chainstate.m_chain.Tip() == nullptr || active_chainstate.m_chain.Tip()->pprev == nullptr)\n+    if (chainstate.m_chain.Tip() == nullptr || chainstate.m_chain.Tip()->pprev == nullptr)\n         return true;\n \n     // Verify blocks in the best chain\n-    if (nCheckDepth <= 0 || nCheckDepth > active_chainstate.m_chain.Height())\n-        nCheckDepth = active_chainstate.m_chain.Height();\n+    if (nCheckDepth <= 0 || nCheckDepth > chainstate.m_chain.Height())\n+        nCheckDepth = chainstate.m_chain.Height();\n     nCheckLevel = std::max(0, std::min(4, nCheckLevel));\n     LogPrintf(\"Verifying last %i blocks at level %i\\n\", nCheckDepth, nCheckLevel);\n-    CCoinsViewCache coins(coinsview);\n+    CCoinsViewCache coins(&coinsview);\n     CBlockIndex* pindex;\n     CBlockIndex* pindexFailure = nullptr;\n     int nGoodTransactions = 0;\n     BlockValidationState state;\n     int reportDone = 0;\n     LogPrintf(\"[0%%]...\"); /* Continued */\n-    for (pindex = active_chainstate.m_chain.Tip(); pindex && pindex->pprev; pindex = pindex->pprev) {\n-        const int percentageDone = std::max(1, std::min(99, (int)(((double)(active_chainstate.m_chain.Height() - pindex->nHeight)) / (double)nCheckDepth * (nCheckLevel >= 4 ? 50 : 100))));\n+    for (pindex = chainstate.m_chain.Tip(); pindex && pindex->pprev; pindex = pindex->pprev) {\n+        const int percentageDone = std::max(1, std::min(99, (int)(((double)(chainstate.m_chain.Height() - pindex->nHeight)) / (double)nCheckDepth * (nCheckLevel >= 4 ? 50 : 100))));\n         if (reportDone < percentageDone/10) {\n             // report every 10% step\n             LogPrintf(\"[%d%%]...\", percentageDone); /* Continued */\n             reportDone = percentageDone/10;\n         }\n         uiInterface.ShowProgress(_(\"Verifying blocks...\").translated, percentageDone, false);\n-        if (pindex->nHeight <= active_chainstate.m_chain.Height()-nCheckDepth)\n+        if (pindex->nHeight <= chainstate.m_chain.Height()-nCheckDepth)\n             break;\n-        if (fPruneMode && !(pindex->nStatus & BLOCK_HAVE_DATA)) {\n+        if ((fPruneMode || g_chainman.IsSnapshotActive()) && !(pindex->nStatus & BLOCK_HAVE_DATA)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21523#discussion_r610078206",
      "id" : 610078206,
      "line" : 4283,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMDA3ODIwNg==",
      "original_commit_id" : "cd93f827eb1178c3b001b45af5c062bf0be2cf05",
      "original_line" : 4283,
      "original_position" : 47,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 47,
      "pull_request_review_id" : 631807406,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21523",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-08T20:39:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/610078206",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   }
]
