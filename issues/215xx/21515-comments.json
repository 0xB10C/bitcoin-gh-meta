[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r599969335"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/599969335"
         }
      },
      "author_association" : "MEMBER",
      "body" : "8110da8b1b8bc83fa7fd2b76f9cc4688a7a02623\r\n\r\nnit `#include <memory>` for `std::unique_ptr`.",
      "commit_id" : "b3362c332deee8f15e830ac7554fd70951f2b263",
      "created_at" : "2021-03-23T21:34:00Z",
      "diff_hunk" : "@@ -0,0 +1,57 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXRECONCILIATION_H\n+#define BITCOIN_TXRECONCILIATION_H\n+\n+#include <net.h>\n+#include <sync.h>\n+\n+#include <tuple>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r599969335",
      "id" : 599969335,
      "line" : 12,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5OTk2OTMzNQ==",
      "original_commit_id" : "8110da8b1b8bc83fa7fd2b76f9cc4688a7a02623",
      "original_line" : 12,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/txreconciliation.h",
      "position" : 12,
      "pull_request_review_id" : 619102655,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-23T22:30:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/599969335",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r599974713"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/599974713"
         }
      },
      "author_association" : "MEMBER",
      "body" : "8110da8b1b8bc83fa7fd2b76f9cc4688a7a02623\r\n\r\nMove to txreconciliation.cpp",
      "commit_id" : "b3362c332deee8f15e830ac7554fd70951f2b263",
      "created_at" : "2021-03-23T21:39:09Z",
      "diff_hunk" : "@@ -0,0 +1,57 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXRECONCILIATION_H\n+#define BITCOIN_TXRECONCILIATION_H\n+\n+#include <net.h>\n+#include <sync.h>\n+\n+#include <tuple>\n+#include <unordered_map>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r599974713",
      "id" : 599974713,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5OTk3NDcxMw==",
      "original_commit_id" : "8110da8b1b8bc83fa7fd2b76f9cc4688a7a02623",
      "original_line" : 12,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/txreconciliation.h",
      "position" : null,
      "pull_request_review_id" : 619102655,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-23T22:30:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/599974713",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r599979335"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/599979335"
         }
      },
      "author_association" : "MEMBER",
      "body" : "8110da8b1b8bc83fa7fd2b76f9cc4688a7a02623\r\n\r\nLooks like insertion should always happen? If so you could assert `.second` of `emplace()` result. If not, then `GetRand()` could be avoided in case it exists, and below it should return the existing salt.",
      "commit_id" : "b3362c332deee8f15e830ac7554fd70951f2b263",
      "created_at" : "2021-03-23T21:47:10Z",
      "diff_hunk" : "@@ -0,0 +1,59 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <txreconciliation.h>\n+\n+namespace {\n+\n+/** Current protocol version */\n+constexpr uint32_t RECON_VERSION = 1;\n+\n+} // namespace\n+\n+/** Actual implementation for TxReconciliationTracker's data structure. */\n+class TxReconciliationTracker::Impl {\n+\n+    mutable Mutex m_mutex;\n+\n+    /**\n+     * Per-peer salt is used to compute transaction short IDs, which will be later used to\n+     * construct reconciliation sketches.\n+     * Salt is generated randomly per-peer to prevent:\n+     * - linking of network nodes belonging to the same physical node\n+     * - halting of relay of particular transactions due to short ID collisions (DoS)\n+     */\n+    std::unordered_map<NodeId, uint64_t> m_local_salts GUARDED_BY(m_mutex);\n+\n+    public:\n+\n+    std::tuple<bool, bool, uint32_t, uint64_t> SuggestReconciling(NodeId peer_id, bool inbound)\n+    {\n+        LogPrint(BCLog::NET, \"Prepare to announce reconciliation support to peer=%d\\n\", peer_id);\n+        bool we_initiate_recon, we_respond_recon;\n+        // Currently reconciliation roles are defined by the connection direction: only the inbound\n+        // peer initiate reconciliations and the outbound peer is supposed to only respond.\n+        if (inbound) {\n+            we_initiate_recon = false;\n+            we_respond_recon = true;\n+        } else {\n+            we_initiate_recon = true;\n+            we_respond_recon = false;\n+        }\n+\n+        uint64_t m_local_recon_salt(GetRand(UINT64_MAX));\n+        WITH_LOCK(m_mutex, m_local_salts.emplace(peer_id, m_local_recon_salt));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r599979335",
      "id" : 599979335,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5OTk3OTMzNQ==",
      "original_commit_id" : "8110da8b1b8bc83fa7fd2b76f9cc4688a7a02623",
      "original_line" : 45,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/txreconciliation.cpp",
      "position" : null,
      "pull_request_review_id" : 619102655,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-23T22:30:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/599979335",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   }
]
