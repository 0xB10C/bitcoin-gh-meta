[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r599969335"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/599969335"
         }
      },
      "author_association" : "MEMBER",
      "body" : "8110da8b1b8bc83fa7fd2b76f9cc4688a7a02623\r\n\r\nnit `#include <memory>` for `std::unique_ptr`.",
      "commit_id" : "baa461151d9f5377aaa5b40bf05290d3c320d38e",
      "created_at" : "2021-03-23T21:34:00Z",
      "diff_hunk" : "@@ -0,0 +1,57 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXRECONCILIATION_H\n+#define BITCOIN_TXRECONCILIATION_H\n+\n+#include <net.h>\n+#include <sync.h>\n+\n+#include <tuple>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r599969335",
      "id" : 599969335,
      "line" : 12,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5OTk2OTMzNQ==",
      "original_commit_id" : "8110da8b1b8bc83fa7fd2b76f9cc4688a7a02623",
      "original_line" : 12,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/txreconciliation.h",
      "position" : 12,
      "pull_request_review_id" : 619102655,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-02T20:27:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/599969335",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r599974713"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/599974713"
         }
      },
      "author_association" : "MEMBER",
      "body" : "8110da8b1b8bc83fa7fd2b76f9cc4688a7a02623\r\n\r\nMove to txreconciliation.cpp",
      "commit_id" : "baa461151d9f5377aaa5b40bf05290d3c320d38e",
      "created_at" : "2021-03-23T21:39:09Z",
      "diff_hunk" : "@@ -0,0 +1,57 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXRECONCILIATION_H\n+#define BITCOIN_TXRECONCILIATION_H\n+\n+#include <net.h>\n+#include <sync.h>\n+\n+#include <tuple>\n+#include <unordered_map>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r599974713",
      "id" : 599974713,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5OTk3NDcxMw==",
      "original_commit_id" : "8110da8b1b8bc83fa7fd2b76f9cc4688a7a02623",
      "original_line" : 12,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/txreconciliation.h",
      "position" : null,
      "pull_request_review_id" : 619102655,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-02T20:27:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/599974713",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r599979335"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/599979335"
         }
      },
      "author_association" : "MEMBER",
      "body" : "8110da8b1b8bc83fa7fd2b76f9cc4688a7a02623\r\n\r\nLooks like insertion should always happen? If so you could assert `.second` of `emplace()` result. If not, then `GetRand()` could be avoided in case it exists, and below it should return the existing salt.",
      "commit_id" : "baa461151d9f5377aaa5b40bf05290d3c320d38e",
      "created_at" : "2021-03-23T21:47:10Z",
      "diff_hunk" : "@@ -0,0 +1,59 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <txreconciliation.h>\n+\n+namespace {\n+\n+/** Current protocol version */\n+constexpr uint32_t RECON_VERSION = 1;\n+\n+} // namespace\n+\n+/** Actual implementation for TxReconciliationTracker's data structure. */\n+class TxReconciliationTracker::Impl {\n+\n+    mutable Mutex m_mutex;\n+\n+    /**\n+     * Per-peer salt is used to compute transaction short IDs, which will be later used to\n+     * construct reconciliation sketches.\n+     * Salt is generated randomly per-peer to prevent:\n+     * - linking of network nodes belonging to the same physical node\n+     * - halting of relay of particular transactions due to short ID collisions (DoS)\n+     */\n+    std::unordered_map<NodeId, uint64_t> m_local_salts GUARDED_BY(m_mutex);\n+\n+    public:\n+\n+    std::tuple<bool, bool, uint32_t, uint64_t> SuggestReconciling(NodeId peer_id, bool inbound)\n+    {\n+        LogPrint(BCLog::NET, \"Prepare to announce reconciliation support to peer=%d\\n\", peer_id);\n+        bool we_initiate_recon, we_respond_recon;\n+        // Currently reconciliation roles are defined by the connection direction: only the inbound\n+        // peer initiate reconciliations and the outbound peer is supposed to only respond.\n+        if (inbound) {\n+            we_initiate_recon = false;\n+            we_respond_recon = true;\n+        } else {\n+            we_initiate_recon = true;\n+            we_respond_recon = false;\n+        }\n+\n+        uint64_t m_local_recon_salt(GetRand(UINT64_MAX));\n+        WITH_LOCK(m_mutex, m_local_salts.emplace(peer_id, m_local_recon_salt));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r599979335",
      "id" : 599979335,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5OTk3OTMzNQ==",
      "original_commit_id" : "8110da8b1b8bc83fa7fd2b76f9cc4688a7a02623",
      "original_line" : 45,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/txreconciliation.cpp",
      "position" : null,
      "pull_request_review_id" : 619102655,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-02T20:27:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/599979335",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #21160 (Net/Net processing: Move tx inventory into net_processing by jnewbery)\n* #21061 ([p2p] Introduce node rebroadcast module by amitiuttarwar)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-03-24T09:59:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21515#issuecomment-805662879",
      "id" : 805662879,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21515",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwNTY2Mjg3OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-24T09:59:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/805662879",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r602929047"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602929047"
         }
      },
      "author_association" : "MEMBER",
      "body" : "3e4022a4a87c91b4b671ab4b71ccbd6d7136bade\r\n\r\nCould make this log conditional to whether `peer_id` was erased from `m_local_salts`.",
      "commit_id" : "baa461151d9f5377aaa5b40bf05290d3c320d38e",
      "created_at" : "2021-03-28T20:35:51Z",
      "diff_hunk" : "@@ -52,6 +52,14 @@ class TxReconciliationTracker::Impl {\n \n         return std::make_tuple(we_initiate_recon, we_respond_recon, RECON_VERSION, m_local_recon_salt);\n     }\n+\n+    void RemovePeer(NodeId peer_id)\n+    {\n+        LOCK(m_mutex);\n+        m_local_salts.erase(peer_id);\n+        LogPrint(BCLog::NET, \"Stop tracking reconciliation state for peer=%d.\\n\", peer_id);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r602929047",
      "id" : 602929047,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjkyOTA0Nw==",
      "original_commit_id" : "3e4022a4a87c91b4b671ab4b71ccbd6d7136bade",
      "original_line" : 60,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/txreconciliation.cpp",
      "position" : null,
      "pull_request_review_id" : 619157940,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-02T20:27:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602929047",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r602930818"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602930818"
         }
      },
      "author_association" : "MEMBER",
      "body" : "8cdaf385aee34a9a10406eef73d6dcae74b5a2c4\r\n\r\nShould be \"SuggestReconciling\"?",
      "commit_id" : "baa461151d9f5377aaa5b40bf05290d3c320d38e",
      "created_at" : "2021-03-28T20:50:59Z",
      "diff_hunk" : "@@ -68,10 +111,48 @@ class TxReconciliationTracker::Impl {\n         return std::make_tuple(we_initiate_recon, we_respond_recon, RECON_VERSION, m_local_recon_salt);\n     }\n \n+    void EnableReconciliationSupport(NodeId peer_id, bool inbound,\n+        bool they_may_initiate, bool they_may_respond, uint32_t recon_version, uint64_t remote_salt)\n+    {\n+        // We do not support reconciliation salt/version updates, so receiving this message\n+        // for the second time should not happen\n+        LOCK(m_mutex);\n+        auto recon_state = m_states.find(peer_id);\n+        if (recon_state != m_states.end()) return;\n+\n+        recon_version = std::min(recon_version, RECON_VERSION);\n+        if (recon_version < 1) return;\n+\n+        // Must match SuggestReconciliation logic.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r602930818",
      "id" : 602930818,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjkzMDgxOA==",
      "original_commit_id" : "8cdaf385aee34a9a10406eef73d6dcae74b5a2c4",
      "original_line" : 126,
      "original_position" : 73,
      "original_start_line" : null,
      "path" : "src/txreconciliation.cpp",
      "position" : null,
      "pull_request_review_id" : 619157940,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-02T20:27:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602930818",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r602941978"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602941978"
         }
      },
      "author_association" : "MEMBER",
      "body" : "49108e38941f7136fafdbfc64a989aba0f1cc99f\r\n\r\nnit, `->second`.",
      "commit_id" : "baa461151d9f5377aaa5b40bf05290d3c320d38e",
      "created_at" : "2021-03-28T22:26:29Z",
      "diff_hunk" : "@@ -161,6 +161,17 @@ class TxReconciliationTracker::Impl {\n         LOCK(m_mutex);\n         return m_states.find(peer_id) != m_states.end();\n     }\n+\n+    std::optional<bool> IsPeerChosenForFlooding(NodeId peer_id) const\n+    {\n+        LOCK(m_mutex);\n+        auto recon_state = m_states.find(peer_id);\n+        if (recon_state == m_states.end()) {\n+            return std::nullopt;\n+        }\n+        return (*recon_state).second.m_flood_to;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r602941978",
      "id" : 602941978,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjk0MTk3OA==",
      "original_commit_id" : "49108e38941f7136fafdbfc64a989aba0f1cc99f",
      "original_line" : 172,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/txreconciliation.cpp",
      "position" : null,
      "pull_request_review_id" : 619157940,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-02T20:27:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602941978",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r602943795"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602943795"
         }
      },
      "author_association" : "MEMBER",
      "body" : "99906e0c3399225ee361ce85291074971d2025e1\r\n\r\n`IsPeerRegistered` is not needed since `IsPeerChosenForFlooding` returns `nullopt`. Maybe:\r\n```cpp\r\nif (pfrom.MightSupportTransactionRelay()) {\r\n    we_may_flood_to = m_reconciliation.IsPeerChosenForFlooding(pfrom.GetId()).value_or(true);\r\n}\r\n```",
      "commit_id" : "baa461151d9f5377aaa5b40bf05290d3c320d38e",
      "created_at" : "2021-03-28T22:39:57Z",
      "diff_hunk" : "@@ -2539,6 +2547,28 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                       pfrom.nVersion.load(), peer->m_starting_height,\n                       pfrom.GetId(), (fLogIPs ? strprintf(\", peeraddr=%s\", pfrom.addr.ToString()) : \"\"),\n                       pfrom.ConnectionTypeAsString());\n+\n+            // Keep track of the number of outbound flooding peers.\n+            bool we_may_flood_to = false;\n+            if (pfrom.MightSupportTransactionRelay()) {\n+                if (m_reconciliation.IsPeerRegistered(pfrom.GetId())) {\n+                    if (*m_reconciliation.IsPeerChosenForFlooding(pfrom.GetId())) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r602943795",
      "id" : 602943795,
      "line" : 2651,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjk0Mzc5NQ==",
      "original_commit_id" : "99906e0c3399225ee361ce85291074971d2025e1",
      "original_line" : 2651,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 249,
      "pull_request_review_id" : 619157940,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-02T20:27:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602943795",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r603143723"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603143723"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I agree this is way cleaner, but I think the current code is easier to understand, so I'm leaning towards my approach.",
      "commit_id" : "baa461151d9f5377aaa5b40bf05290d3c320d38e",
      "created_at" : "2021-03-29T09:27:57Z",
      "diff_hunk" : "@@ -2539,6 +2547,28 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                       pfrom.nVersion.load(), peer->m_starting_height,\n                       pfrom.GetId(), (fLogIPs ? strprintf(\", peeraddr=%s\", pfrom.addr.ToString()) : \"\"),\n                       pfrom.ConnectionTypeAsString());\n+\n+            // Keep track of the number of outbound flooding peers.\n+            bool we_may_flood_to = false;\n+            if (pfrom.MightSupportTransactionRelay()) {\n+                if (m_reconciliation.IsPeerRegistered(pfrom.GetId())) {\n+                    if (*m_reconciliation.IsPeerChosenForFlooding(pfrom.GetId())) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r603143723",
      "id" : 603143723,
      "in_reply_to_id" : 602943795,
      "line" : 2651,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzE0MzcyMw==",
      "original_commit_id" : "99906e0c3399225ee361ce85291074971d2025e1",
      "original_line" : 2651,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 249,
      "pull_request_review_id" : 623031306,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-02T20:27:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603143723",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r603144648"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603144648"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The problem is that you can hit undefined behavior with the current code - assuming peer can be disconnected between `IsPeerRegistered` and  `IsPeerChosenForFlooding`.\r\n\r\nEdit: Looks like the above is not possible.",
      "commit_id" : "baa461151d9f5377aaa5b40bf05290d3c320d38e",
      "created_at" : "2021-03-29T09:29:16Z",
      "diff_hunk" : "@@ -2539,6 +2547,28 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                       pfrom.nVersion.load(), peer->m_starting_height,\n                       pfrom.GetId(), (fLogIPs ? strprintf(\", peeraddr=%s\", pfrom.addr.ToString()) : \"\"),\n                       pfrom.ConnectionTypeAsString());\n+\n+            // Keep track of the number of outbound flooding peers.\n+            bool we_may_flood_to = false;\n+            if (pfrom.MightSupportTransactionRelay()) {\n+                if (m_reconciliation.IsPeerRegistered(pfrom.GetId())) {\n+                    if (*m_reconciliation.IsPeerChosenForFlooding(pfrom.GetId())) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r603144648",
      "id" : 603144648,
      "in_reply_to_id" : 602943795,
      "line" : 2651,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzE0NDY0OA==",
      "original_commit_id" : "99906e0c3399225ee361ce85291074971d2025e1",
      "original_line" : 2651,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 249,
      "pull_request_review_id" : 623032451,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-02T20:27:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603144648",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r603200987"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603200987"
         }
      },
      "author_association" : "MEMBER",
      "body" : "3692db74f86186789c9dad4005f7b768721d5afe\r\n\r\nnit, could move to inner scope.",
      "commit_id" : "baa461151d9f5377aaa5b40bf05290d3c320d38e",
      "created_at" : "2021-03-29T11:01:03Z",
      "diff_hunk" : "@@ -4552,15 +4554,19 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n             }\n             peer->m_blocks_for_inv_relay.clear();\n \n+            const bool supports_recon = m_reconciliation.IsPeerRegistered(pto->GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r603200987",
      "id" : 603200987,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzIwMDk4Nw==",
      "original_commit_id" : "3692db74f86186789c9dad4005f7b768721d5afe",
      "original_line" : 4557,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 623106592,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-02T20:27:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603200987",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r603202580"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603202580"
         }
      },
      "author_association" : "MEMBER",
      "body" : "83a08c5ea07f7f7e3e67501ac8666521427ae9d3\r\n\r\nnit, `assert(txs_to_reconcile.size() > 0)`",
      "commit_id" : "baa461151d9f5377aaa5b40bf05290d3c320d38e",
      "created_at" : "2021-03-29T11:04:13Z",
      "diff_hunk" : "@@ -154,6 +178,19 @@ class TxReconciliationTracker::Impl {\n             full_salt.GetUint64(1), we_initiate, flood_to));\n     }\n \n+    void AddToReconSet(NodeId peer_id, const std::vector<uint256>& txs_to_reconcile)\n+    {\n+        LOCK(m_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r603202580",
      "id" : 603202580,
      "line" : 660,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzIwMjU4MA==",
      "original_commit_id" : "83a08c5ea07f7f7e3e67501ac8666521427ae9d3",
      "original_line" : 660,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "src/txreconciliation.cpp",
      "position" : 660,
      "pull_request_review_id" : 623106592,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-02T20:27:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603202580",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r603203867"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603203867"
         }
      },
      "author_association" : "MEMBER",
      "body" : "83a08c5ea07f7f7e3e67501ac8666521427ae9d3\r\n\r\nCould `m_local_set already` have some of `txs_to_reconcile`? If so maybe we should count successful `.insert()` and log that?",
      "commit_id" : "baa461151d9f5377aaa5b40bf05290d3c320d38e",
      "created_at" : "2021-03-29T11:06:33Z",
      "diff_hunk" : "@@ -154,6 +178,19 @@ class TxReconciliationTracker::Impl {\n             full_salt.GetUint64(1), we_initiate, flood_to));\n     }\n \n+    void AddToReconSet(NodeId peer_id, const std::vector<uint256>& txs_to_reconcile)\n+    {\n+        LOCK(m_mutex);\n+        auto recon_state = m_states.find(peer_id);\n+        assert(recon_state != m_states.end());\n+        for (auto& wtxid: txs_to_reconcile) {\n+            recon_state->second.m_local_set.m_wtxids.insert(wtxid);\n+        }\n+\n+        LogPrint(BCLog::NET, \"Added %i transactions to the reconciliation set for peer=%d.\\n\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r603203867",
      "id" : 603203867,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzIwMzg2Nw==",
      "original_commit_id" : "83a08c5ea07f7f7e3e67501ac8666521427ae9d3",
      "original_line" : 190,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/txreconciliation.cpp",
      "position" : null,
      "pull_request_review_id" : 623106592,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-02T20:27:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603203867",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r603206903"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603206903"
         }
      },
      "author_association" : "MEMBER",
      "body" : "3692db74f86186789c9dad4005f7b768721d5afe\r\n\r\nMove to inner scope, make const.",
      "commit_id" : "baa461151d9f5377aaa5b40bf05290d3c320d38e",
      "created_at" : "2021-03-29T11:12:08Z",
      "diff_hunk" : "@@ -4622,6 +4629,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                         // Fetch the top element from the heap\n                         std::pop_heap(vInvTx.begin(), vInvTx.end(), compareInvMempoolOrder);\n                         uint256 hash = vInvTx.back();\n+                        bool flood_tx = pto->m_tx_relay->m_txs_to_announce.at(hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r603206903",
      "id" : 603206903,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzIwNjkwMw==",
      "original_commit_id" : "3692db74f86186789c9dad4005f7b768721d5afe",
      "original_line" : 4632,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 623106592,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-02T20:27:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603206903",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r603207731"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603207731"
         }
      },
      "author_association" : "MEMBER",
      "body" : "05ac9dc21e5697a1e0261909b64de4f7d6e21eb1\r\n\r\ntypo \"differene\"",
      "commit_id" : "baa461151d9f5377aaa5b40bf05290d3c320d38e",
      "created_at" : "2021-03-29T11:13:40Z",
      "diff_hunk" : "@@ -120,6 +120,13 @@ class TxReconciliationTracker::Impl {\n      */\n     std::unordered_map<NodeId, ReconciliationState> m_states GUARDED_BY(m_mutex);\n \n+    /**\n+     * Maintains a queue of reconciliations we should initiate. To achieve higher bandwidth\n+     * conservation and avoid overflows, we should reconcile in the same order, because then itâs\n+     * easier to estimate set differene size.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r603207731",
      "id" : 603207731,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzIwNzczMQ==",
      "original_commit_id" : "05ac9dc21e5697a1e0261909b64de4f7d6e21eb1",
      "original_line" : 126,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/txreconciliation.cpp",
      "position" : null,
      "pull_request_review_id" : 623106592,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-02T20:27:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603207731",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r603210177"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603210177"
         }
      },
      "author_association" : "MEMBER",
      "body" : "e854bcf5391d02a28690f7eedad8382cbb05f85b\r\n\r\nAdd TSAN annotation?",
      "commit_id" : "baa461151d9f5377aaa5b40bf05290d3c320d38e",
      "created_at" : "2021-03-29T11:17:55Z",
      "diff_hunk" : "@@ -127,6 +135,16 @@ class TxReconciliationTracker::Impl {\n      */\n     std::deque<NodeId> m_queue GUARDED_BY(m_mutex);\n \n+    /**\n+     * Reconciliations are requested periodically:\n+     * every RECON_REQUEST_INTERVAL seconds we pick a peer from the queue.\n+     */\n+    std::chrono::microseconds m_next_recon_request{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r603210177",
      "id" : 603210177,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzIxMDE3Nw==",
      "original_commit_id" : "e854bcf5391d02a28690f7eedad8382cbb05f85b",
      "original_line" : 142,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/txreconciliation.cpp",
      "position" : null,
      "pull_request_review_id" : 623106592,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-02T20:27:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603210177",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r603210815"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603210815"
         }
      },
      "author_association" : "MEMBER",
      "body" : "e854bcf5391d02a28690f7eedad8382cbb05f85b\r\n\r\nnit `assert(m_queue.size() > 0)`",
      "commit_id" : "baa461151d9f5377aaa5b40bf05290d3c320d38e",
      "created_at" : "2021-03-29T11:19:03Z",
      "diff_hunk" : "@@ -127,6 +135,16 @@ class TxReconciliationTracker::Impl {\n      */\n     std::deque<NodeId> m_queue GUARDED_BY(m_mutex);\n \n+    /**\n+     * Reconciliations are requested periodically:\n+     * every RECON_REQUEST_INTERVAL seconds we pick a peer from the queue.\n+     */\n+    std::chrono::microseconds m_next_recon_request{0};\n+    void UpdateNextReconRequest(std::chrono::microseconds now) EXCLUSIVE_LOCKS_REQUIRED(m_mutex)\n+    {\n+        m_next_recon_request = now + RECON_REQUEST_INTERVAL / m_queue.size();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r603210815",
      "id" : 603210815,
      "line" : 448,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzIxMDgxNQ==",
      "original_commit_id" : "e854bcf5391d02a28690f7eedad8382cbb05f85b",
      "original_line" : 448,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/txreconciliation.cpp",
      "position" : 448,
      "pull_request_review_id" : 623106592,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-02T20:27:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603210815",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r603214394"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603214394"
         }
      },
      "author_association" : "MEMBER",
      "body" : "476ced6df27c13fd8d1dae46d09b91549977cac1\r\n\r\nnit, enum class and use as `ReconciliationPhase::NONE`?",
      "commit_id" : "baa461151d9f5377aaa5b40bf05290d3c320d38e",
      "created_at" : "2021-03-29T11:25:31Z",
      "diff_hunk" : "@@ -27,6 +34,14 @@ constexpr uint32_t MAX_OUTBOUND_FLOOD_TO = 8;\n  */\n constexpr std::chrono::microseconds RECON_REQUEST_INTERVAL{16s};\n \n+/**\n+ * Represents phase of the current reconciliation round with a peer.\n+ */\n+enum ReconciliationPhase {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r603214394",
      "id" : 603214394,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzIxNDM5NA==",
      "original_commit_id" : "476ced6df27c13fd8d1dae46d09b91549977cac1",
      "original_line" : 40,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/txreconciliation.cpp",
      "position" : null,
      "pull_request_review_id" : 623106592,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-02T20:27:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603214394",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r603219571"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603219571"
         }
      },
      "author_association" : "MEMBER",
      "body" : "There's no need to update this public interface method. The only users of this method outside net_processing will _always_ call `RelayTransaction()` without a `from` parameter.\r\n\r\n(it's also unnecessary to wrap an optional parameter in a `std::optional` since the fact that it's an optional parameter already gives you a way to indicate no value)",
      "commit_id" : "baa461151d9f5377aaa5b40bf05290d3c320d38e",
      "created_at" : "2021-03-29T11:34:44Z",
      "diff_hunk" : "@@ -47,8 +47,12 @@ class PeerManager : public CValidationInterface, public NetEventsInterface\n     /** Whether this node ignores txs received over p2p. */\n     virtual bool IgnoresIncomingTxs() = 0;\n \n-    /** Relay transaction to all peers. */\n-    virtual void RelayTransaction(const uint256& txid, const uint256& wtxid)\n+    /**\n+     * Relay transaction to every node.\n+     * The announcement protocol (flooding or reconciliation) will be chosen based on from which\n+     * peer the transaction came to us. For transactions originated locally, pass from=nullopt.\n+     */\n+    virtual void RelayTransaction(const uint256& txid, const uint256& wtxid, std::optional<NodeId> from=std::nullopt)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r603219571",
      "id" : 603219571,
      "line" : 56,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzIxOTU3MQ==",
      "original_commit_id" : "272b3b2db9f941b5784024983b9152dfccc5aebe",
      "original_line" : 56,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 11,
      "pull_request_review_id" : 623130809,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-02T20:27:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603219571",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r603221491"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603221491"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No need to protect this with `cs_main`. You can just make it atomic.",
      "commit_id" : "baa461151d9f5377aaa5b40bf05290d3c320d38e",
      "created_at" : "2021-03-29T11:38:10Z",
      "diff_hunk" : "@@ -365,6 +372,9 @@ class PeerManagerImpl final : public PeerManager\n     /** Number of peers with wtxid relay. */\n     int m_wtxid_relay_peers GUARDED_BY(cs_main) = 0;\n \n+    /** Number of outbound peers we may flood transactions to. */\n+    int m_out_flood_to GUARDED_BY(cs_main) = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r603221491",
      "id" : 603221491,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzIyMTQ5MQ==",
      "original_commit_id" : "272b3b2db9f941b5784024983b9152dfccc5aebe",
      "original_line" : 376,
      "original_position" : 80,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 623133260,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-02T20:27:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603221491",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r603221670"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603221670"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Again, no need for this to be protected by main. I think it can easily live in `Peer`.",
      "commit_id" : "baa461151d9f5377aaa5b40bf05290d3c320d38e",
      "created_at" : "2021-03-29T11:38:34Z",
      "diff_hunk" : "@@ -597,6 +607,9 @@ struct CNodeState {\n     //! Whether this peer relays txs via wtxid\n     bool m_wtxid_relay{false};\n \n+    //! Whether this peer may be used by us for flooding txs.\n+    bool m_we_may_flood_to{false};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r603221670",
      "id" : 603221670,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzIyMTY3MA==",
      "original_commit_id" : "272b3b2db9f941b5784024983b9152dfccc5aebe",
      "original_line" : 611,
      "original_position" : 90,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 623133260,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-02T20:27:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603221670",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r603223119"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603223119"
         }
      },
      "author_association" : "MEMBER",
      "body" : "New `from` parameter is unused.",
      "commit_id" : "baa461151d9f5377aaa5b40bf05290d3c320d38e",
      "created_at" : "2021-03-29T11:41:12Z",
      "diff_hunk" : "@@ -2017,8 +2063,9 @@ void PeerManagerImpl::ProcessHeadersMessage(CNode& pfrom, const Peer& peer,\n  *                                  orphan will be reconsidered on each call of this function. This set\n  *                                  may be added to if accepting an orphan causes its children to be\n  *                                  reconsidered.\n+ * @param           from            The peer for which we are processing the orphan set.\n  */\n-void PeerManagerImpl::ProcessOrphanTx(std::set<uint256>& orphan_work_set)\n+void PeerManagerImpl::ProcessOrphanTx(std::set<uint256>& orphan_work_set, NodeId from)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r603223119",
      "id" : 603223119,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzIyMzExOQ==",
      "original_commit_id" : "272b3b2db9f941b5784024983b9152dfccc5aebe",
      "original_line" : 2068,
      "original_position" : 171,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 623133260,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-02T20:27:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603223119",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r606384776"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/606384776"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Making const. Can't move because it's erased in two lines after, so it won't be accessible in the inner scope.\r\nAnd I can't call `.second` on `.erase`, because it returns a number of erased elements.\r\n\r\nOne alternative could be to use `txid_to_ann_protocol` in `vInvTx` (instead of uint256). But then I won't be able to reuse `CompareInvMempoolOrder` in `AnnounceTxs`.",
      "commit_id" : "baa461151d9f5377aaa5b40bf05290d3c320d38e",
      "created_at" : "2021-04-02T19:26:16Z",
      "diff_hunk" : "@@ -4622,6 +4629,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                         // Fetch the top element from the heap\n                         std::pop_heap(vInvTx.begin(), vInvTx.end(), compareInvMempoolOrder);\n                         uint256 hash = vInvTx.back();\n+                        bool flood_tx = pto->m_tx_relay->m_txs_to_announce.at(hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r606384776",
      "id" : 606384776,
      "in_reply_to_id" : 603206903,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNjM4NDc3Ng==",
      "original_commit_id" : "3692db74f86186789c9dad4005f7b768721d5afe",
      "original_line" : 4632,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 627222659,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-02T20:27:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/606384776",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r606389480"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/606389480"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Sorry I don't understand this comment, despite your elaborate explanation. Probably my lack of C++ expertise.\r\n\r\nIf I remove just this change in the `virtual void` line, I get a compilation error.",
      "commit_id" : "baa461151d9f5377aaa5b40bf05290d3c320d38e",
      "created_at" : "2021-04-02T19:39:35Z",
      "diff_hunk" : "@@ -47,8 +47,12 @@ class PeerManager : public CValidationInterface, public NetEventsInterface\n     /** Whether this node ignores txs received over p2p. */\n     virtual bool IgnoresIncomingTxs() = 0;\n \n-    /** Relay transaction to all peers. */\n-    virtual void RelayTransaction(const uint256& txid, const uint256& wtxid)\n+    /**\n+     * Relay transaction to every node.\n+     * The announcement protocol (flooding or reconciliation) will be chosen based on from which\n+     * peer the transaction came to us. For transactions originated locally, pass from=nullopt.\n+     */\n+    virtual void RelayTransaction(const uint256& txid, const uint256& wtxid, std::optional<NodeId> from=std::nullopt)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r606389480",
      "id" : 606389480,
      "in_reply_to_id" : 603219571,
      "line" : 56,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNjM4OTQ4MA==",
      "original_commit_id" : "272b3b2db9f941b5784024983b9152dfccc5aebe",
      "original_line" : 56,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 11,
      "pull_request_review_id" : 627228209,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-02T20:27:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/606389480",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r613595312"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613595312"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks for the clear write-up, may a suggest to insert a stable link to the paper ?",
      "commit_id" : "baa461151d9f5377aaa5b40bf05290d3c320d38e",
      "created_at" : "2021-04-14T21:21:06Z",
      "diff_hunk" : "@@ -0,0 +1,163 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXRECONCILIATION_H\n+#define BITCOIN_TXRECONCILIATION_H\n+\n+#include <net.h>\n+#include <sync.h>\n+\n+#include <memory>\n+#include <tuple>\n+\n+/**\n+ * Transaction reconciliation is a way for nodes to efficiently announce transactions.\n+ * This object keeps track of all reconciliation-related communications with the peers.\n+ * The high-level protocol is:\n+ * 0. Reconciliation protocol handshake.\n+ * 1. Once we receive a new transaction, add it to the set instead of announcing immediately\n+ * 2. When the time comes, a reconciliation initiator requests a sketch from the peer, where a sketch\n+ *    is a compressed representation of their set\n+ * 3. Once the initiator received a sketch from the peer, the initiator computes a local sketch,\n+ *    and combines the two skethes to find the difference in *sets*.\n+ * 4. Now the initiator knows full symmetrical difference and can request what the initiator is\n+ *    missing and announce to the peer what the peer is missing. For the former, an extra round is\n+ *    required because the initiator knows only short IDs of those transactions.\n+ * 5. Sometimes reconciliation fails if the difference is larger than the parties estimated,\n+ *    then there is one sketch extension round, in which the initiator requests for extra data.\n+ * 6. If extension succeeds, go to step 4.\n+ * 7. If extension fails, the initiator notifies the peer\n+ */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r613595312",
      "id" : 613595312,
      "line" : 31,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMzU5NTMxMg==",
      "original_commit_id" : "baa461151d9f5377aaa5b40bf05290d3c320d38e",
      "original_line" : 31,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/txreconciliation.h",
      "position" : 31,
      "pull_request_review_id" : 636090761,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-14T21:32:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613595312",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r613599268"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613599268"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think one obvious extension of the test coverage would be to join basic fuzz coverage of `TxReconciliationTracker` interface to assert its robustness. Have a look on `src/test/fuzz/addrman.cpp` or `src/test/fuzz/banman.cpp`.\r\n\r\nFuzz coverage might test further sanity of `TxReconciliationTracker` after each call or in function of `m_we_initiate` or `m_flood_to`. Still thinking about concrete suggestions there.",
      "commit_id" : "baa461151d9f5377aaa5b40bf05290d3c320d38e",
      "created_at" : "2021-04-14T21:28:34Z",
      "diff_hunk" : "@@ -0,0 +1,163 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXRECONCILIATION_H\n+#define BITCOIN_TXRECONCILIATION_H\n+\n+#include <net.h>\n+#include <sync.h>\n+\n+#include <memory>\n+#include <tuple>\n+\n+/**\n+ * Transaction reconciliation is a way for nodes to efficiently announce transactions.\n+ * This object keeps track of all reconciliation-related communications with the peers.\n+ * The high-level protocol is:\n+ * 0. Reconciliation protocol handshake.\n+ * 1. Once we receive a new transaction, add it to the set instead of announcing immediately\n+ * 2. When the time comes, a reconciliation initiator requests a sketch from the peer, where a sketch\n+ *    is a compressed representation of their set\n+ * 3. Once the initiator received a sketch from the peer, the initiator computes a local sketch,\n+ *    and combines the two skethes to find the difference in *sets*.\n+ * 4. Now the initiator knows full symmetrical difference and can request what the initiator is\n+ *    missing and announce to the peer what the peer is missing. For the former, an extra round is\n+ *    required because the initiator knows only short IDs of those transactions.\n+ * 5. Sometimes reconciliation fails if the difference is larger than the parties estimated,\n+ *    then there is one sketch extension round, in which the initiator requests for extra data.\n+ * 6. If extension succeeds, go to step 4.\n+ * 7. If extension fails, the initiator notifies the peer\n+ */\n+class TxReconciliationTracker {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r613599268",
      "id" : 613599268,
      "line" : 32,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMzU5OTI2OA==",
      "original_commit_id" : "baa461151d9f5377aaa5b40bf05290d3c320d38e",
      "original_line" : 32,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/txreconciliation.h",
      "position" : 32,
      "pull_request_review_id" : 636090761,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-14T21:32:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613599268",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r613926434"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613926434"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, you'll need to change the function signature in `PeerManagerImpl()` as well. An `override` function must have the same signature as the function it's overriding.",
      "commit_id" : "baa461151d9f5377aaa5b40bf05290d3c320d38e",
      "created_at" : "2021-04-15T09:50:05Z",
      "diff_hunk" : "@@ -47,8 +47,12 @@ class PeerManager : public CValidationInterface, public NetEventsInterface\n     /** Whether this node ignores txs received over p2p. */\n     virtual bool IgnoresIncomingTxs() = 0;\n \n-    /** Relay transaction to all peers. */\n-    virtual void RelayTransaction(const uint256& txid, const uint256& wtxid)\n+    /**\n+     * Relay transaction to every node.\n+     * The announcement protocol (flooding or reconciliation) will be chosen based on from which\n+     * peer the transaction came to us. For transactions originated locally, pass from=nullopt.\n+     */\n+    virtual void RelayTransaction(const uint256& txid, const uint256& wtxid, std::optional<NodeId> from=std::nullopt)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21515#discussion_r613926434",
      "id" : 613926434,
      "in_reply_to_id" : 603219571,
      "line" : 56,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMzkyNjQzNA==",
      "original_commit_id" : "272b3b2db9f941b5784024983b9152dfccc5aebe",
      "original_line" : 56,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 11,
      "pull_request_review_id" : 636493106,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21515",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-15T09:50:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/613926434",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   }
]
