[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #21767 ([Bundle 6/n] Prune g_chainman usage in auxiliary modules by dongcarl)\n* #21061 ([p2p] Introduce node rebroadcast module by amitiuttarwar)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-03-24T21:36:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#issuecomment-806201724",
      "id" : 806201724,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21526",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwNjIwMTcyNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-24T02:17:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/806201724",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/21526#issue-600020266\r\n\r\n> * Don't run `UpdateTip` for background validation chainstates.\r\n\r\nDoes this prevent bugs in the future when there can be a background validation chainstate? It would help to say what would happen without this change. It could also be helpful to say more about the motivation for this set of changes, and maybe summarize the current state of things for forgetful people like me who somewhat lost the thread on assumeutxo :tropical_fish: \r\n\r\n> * Modify `LoadBlockIndex()` to populate the \"faked\" nChainTx value when using a yet-unvalidated snapshot chainstate. This allows assumeutxo sync-to-tip to offer normal progress estimates on the basis of having nChainTx without the associated block data.\r\n\r\nIIUC, the faking isn't new, and the value was faked before this change, but startup code is now fixed  so things work if the node is restarted before the assumeutxo snapshot is validated? Again could help to say what bad things would happen without this.\r\n\r\n> * In `LoadBlockIndex()`, ensure that assumed-valid CBlockIndex entries aren't added to the background validation chainstate's setBlockIndexCandidates (since we want that chainstate to actually validate those entries at some point).\r\n\r\nWondering also what bad things happen without this change, and why it's in the same commit as the last change. Is it just that both changes affect the `LoadBlockIndex()` function?\r\n\r\n> * Prevent `RewindBlockIndex()` from rewinding past the assumeutxo base on the snapshot chainstate.\r\n\r\nI'm a little confused by this code (also the existing pruning code here). It says the purpose of the break is to prevent the DisconnectTip call immediately below from failing. But don't we want to fail in these cases? It seems like now if rewind isn't possible, this just flushes some things and returns true. I'm also wondering if there's a reason this change is in the same commit as the other changes, which seem tangentially related.\r\n\r\nAlso, there's no test coverage here. Maybe is the best we can do when adding dead code to older functions that weren't really designed to be unit-tested. But are there at least future tests in #15606 that would fail without these different fixes?\r\n\r\nThanks for any clarifications, and great to see assumeutxo work moving along again!",
      "created_at" : "2021-03-29T01:41:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#issuecomment-809009595",
      "id" : 809009595,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21526",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwOTAwOTU5NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-29T01:43:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/809009595",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ryanofsky thanks for the thorough look! I agree that I should take a look at writing unittests for these changes and do so if practical. Also appreciate your questions on the logic - I'll get together some responses for those and either adjust the code (especially since `RewindBlockIndex()` is probably going away in #21009) or add some motivating documentation. ",
      "created_at" : "2021-03-30T15:22:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#issuecomment-810351331",
      "id" : 810351331,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21526",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxMDM1MTMzMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-30T15:23:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/810351331",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Okay, after taking @ryanofsky's advice, I sat down to write some unittests for the chainstate-dependent UpdateTip() behavior. It turns out that in the process, trying to get those tests to work uncovered a number of changes that needed to be made to other test-related stuff, including slightly modifying `CheckBlockIndex()` to account for the specific nature of the background validation chainstate. Additionally I've added some unittesting utils that help with testing multiple chainstates.\r\n\r\nBecause that's dragged in so much new code, I've narrowed the scope of this PR to the above and I'll deal with the other BlockIndex-related changes in a follow-up PR.\r\n\r\nSo all the logic changes in this are now tested (and this actually adds unit-level coverage of the `UpdateTip()` behvaior that we didn't have previously). So hopefully that entices people to review, because testing future assumeutxo-related changes will probably depend on some of the unittest utils added here.\r\n\r\nAlso worth mentioning is that I had to remove some of the active chainstate assertions that @dongcarl added for the sake of his work in #20158. This should all be okay because those assertions are actually made obsolete by assumeutxo functionality. ",
      "created_at" : "2021-04-08T14:58:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#issuecomment-815893602",
      "id" : 815893602,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21526",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxNTg5MzYwMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-08T14:58:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/815893602",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r615054872"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615054872"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: fix CheckBlockIndex for multiple chainstates\" (d3cec2a5b3febd091b8002e39f8b7431b7e99c4a)\r\n\r\nThis is ok, but it seems to avoid other checks below besides the `setBlockIndexCandidates` checks. And if more checks are added below in the future they could be bypassed unnecessarily. I wonder if it might be more straightforward and futureproof just to add `&& is_active_chain` or `|| !is_active_chain` to the specific assertions below which are failing instead of pruning branches off this tree.",
      "commit_id" : "eb9623d690e6f390a5f6a8b30763374b72aee282",
      "created_at" : "2021-04-16T18:43:24Z",
      "diff_hunk" : "@@ -4821,11 +4823,27 @@ void CChainState::CheckBlockIndex(const Consensus::Params& consensusParams)\n \n     // Build forward-pointing map of the entire block tree.\n     std::multimap<CBlockIndex*,CBlockIndex*> forward;\n-    for (const std::pair<const uint256, CBlockIndex*>& entry : m_blockman.m_block_index) {\n-        forward.insert(std::make_pair(entry.second->pprev, entry.second));\n-    }\n \n-    assert(forward.size() == m_blockman.m_block_index.size());\n+    if (is_active_chain) {\n+        for (const std::pair<const uint256, CBlockIndex*>& entry : m_blockman.m_block_index) {\n+            forward.insert(std::make_pair(entry.second->pprev, entry.second));\n+        }\n+\n+        assert(forward.size() == m_blockman.m_block_index.size());\n+    } else {\n+        // For the background validation chainstate, don't consider the full block tree -\n+        // only consider headers on the IBD chain. Otherwise, we will fail assertions\n+        // related to `setBlockIndexCandidates` below, which corresponds to this subset of\n+        // the block tree for this chainstate.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r615054872",
      "id" : 615054872,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTA1NDg3Mg==",
      "original_commit_id" : "d3cec2a5b3febd091b8002e39f8b7431b7e99c4a",
      "original_line" : 4686,
      "original_position" : 28,
      "original_start_line" : 4834,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 637995324,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-23T18:36:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615054872",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r615063212"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615063212"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"test: refactor: separate CreateBlock in TestChain100Setup\" (6e5871c0c7b7d7b27b56df4f2c0705921025a6d5)\r\n\r\nIMO, it is reasonable for `CreateAndProcessBlock` to have a default-active chainstate pointer for backwards compatibility, but it might be better for this new `CreateBlock` method to take an explicit `CChainState&` reference for more clarity in test code and to prevent mistakes forgetting to specify it.",
      "commit_id" : "eb9623d690e6f390a5f6a8b30763374b72aee282",
      "created_at" : "2021-04-16T18:59:01Z",
      "diff_hunk" : "@@ -117,9 +117,20 @@ struct TestChain100Setup : public RegTestingSetup {\n     /**\n      * Create a new block with just given transactions, coinbase paying to\n      * scriptPubKey, and try to add it to the current chain.\n+     * If no chainstate is specified, default to the active.\n      */\n     CBlock CreateAndProcessBlock(const std::vector<CMutableTransaction>& txns,\n-                                 const CScript& scriptPubKey);\n+                                 const CScript& scriptPubKey,\n+                                 CChainState* chainstate = nullptr);\n+\n+    /**\n+     * Create a new block with just given transactions, coinbase paying to\n+     * scriptPubKey. If no chainstate is specified, default to the active.\n+     */\n+    CBlock CreateBlock(\n+        const std::vector<CMutableTransaction>& txns,\n+        const CScript& scriptPubKey,\n+        CChainState* chainstate = nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r615063212",
      "id" : 615063212,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTA2MzIxMg==",
      "original_commit_id" : "6e5871c0c7b7d7b27b56df4f2c0705921025a6d5",
      "original_line" : 135,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/test/util/setup_common.h",
      "position" : null,
      "pull_request_review_id" : 637995324,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-23T18:36:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615063212",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r615074725"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615074725"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"test: validation: add unittest for UpdateTip behavior\" (3f1346a0178afef20db3599cc545dbc54200d635)\r\n\r\nSince this test is designed to check `UpdateTip` background behavior, but the test doesn't call `UpdateTip` directly, it may be good to add a comment saying this line is what calls `UpdateTip`.\r\n\r\nAlso could maybe a simple check could be added here to verify the new background tip hash?\r\n\r\nAlso curious if there's an existing test (or a planned one) to cover the background chain catching up to the activated snapshot.",
      "commit_id" : "eb9623d690e6f390a5f6a8b30763374b72aee282",
      "created_at" : "2021-04-16T19:21:47Z",
      "diff_hunk" : "@@ -72,4 +75,66 @@ BOOST_AUTO_TEST_CASE(validation_chainstate_resize_caches)\n     WITH_LOCK(::cs_main, manager.Unload());\n }\n \n+//! Test UpdateTip behavior for both active and background chainstates.\n+//!\n+//! When run on the background chainstate, UpdateTip should do a subset\n+//! of what it does for the active chainstate.\n+BOOST_FIXTURE_TEST_CASE(chainstate_update_tip, TestChain100Setup)\n+{\n+    ChainstateManager& chainman = *Assert(m_node.chainman);\n+    uint256 curr_tip = ::g_best_block;\n+\n+    // Mine 10 more blocks, putting at us height 110 where a valid assumeutxo value can\n+    // be found.\n+    mineBlocks(10);\n+\n+    // After adding some blocks to the tip, best block should have changed.\n+    BOOST_CHECK(::g_best_block != curr_tip);\n+\n+    BOOST_REQUIRE(CreateAndActivateUTXOSnapshot(m_node, m_path_root));\n+\n+    // Ensure our active chain is the snapshot chainstate.\n+    BOOST_CHECK(chainman.IsSnapshotActive());\n+\n+    curr_tip = ::g_best_block;\n+\n+    // Mine a new block on top of the activated snapshot chainstate.\n+    mineBlocks(1);  // Defined in TestChain100Setup.\n+\n+    // After adding some blocks to the snapshot tip, best block should have changed.\n+    BOOST_CHECK(::g_best_block != curr_tip);\n+\n+    curr_tip = ::g_best_block;\n+\n+    CChainState& background_cs = m_node.chainman->ValidatedChainstate();\n+    BOOST_CHECK(m_node.chainman->IsBackgroundIBD(&background_cs));\n+\n+    // Create a block to append to the validation chain.\n+    std::vector<CMutableTransaction> noTxns;\n+    CScript scriptPubKey = CScript() << ToByteVector(coinbaseKey.GetPubKey()) << OP_CHECKSIG;\n+    CBlock validation_block = this->CreateBlock(noTxns, scriptPubKey, &background_cs);\n+    auto pblock = std::make_shared<const CBlock>(validation_block);\n+    BlockValidationState state;\n+    CBlockIndex* pindex = nullptr;\n+    const CChainParams& chainparams = Params();\n+    bool newblock = false;\n+\n+    // TODO: much of this is inlined from ProcessNewBlock(); just reuse PNB()\n+    // once it is changed to support multiple chainstates.\n+    {\n+        LOCK(::cs_main);\n+        bool checked = CheckBlock(*pblock, state, chainparams.GetConsensus());\n+        BOOST_CHECK(checked);\n+        bool accepted = background_cs.AcceptBlock(\n+            pblock, state, chainparams, &pindex, true, nullptr, &newblock);\n+        BOOST_CHECK(accepted);\n+    }\n+    bool block_added = background_cs.ActivateBestChain(state, chainparams, pblock);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r615074725",
      "id" : 615074725,
      "line" : 133,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTA3NDcyNQ==",
      "original_commit_id" : "3f1346a0178afef20db3599cc545dbc54200d635",
      "original_line" : 133,
      "original_position" : 73,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstate_tests.cpp",
      "position" : 74,
      "pull_request_review_id" : 637995324,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-23T18:36:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615074725",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-04-17T16:26:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#issuecomment-821849296",
      "id" : 821849296,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21526",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyMTg0OTI5Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-17T16:26:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/821849296",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r619424621"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/619424621"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good call, fixed.",
      "commit_id" : "eb9623d690e6f390a5f6a8b30763374b72aee282",
      "created_at" : "2021-04-23T18:36:51Z",
      "diff_hunk" : "@@ -4821,11 +4823,27 @@ void CChainState::CheckBlockIndex(const Consensus::Params& consensusParams)\n \n     // Build forward-pointing map of the entire block tree.\n     std::multimap<CBlockIndex*,CBlockIndex*> forward;\n-    for (const std::pair<const uint256, CBlockIndex*>& entry : m_blockman.m_block_index) {\n-        forward.insert(std::make_pair(entry.second->pprev, entry.second));\n-    }\n \n-    assert(forward.size() == m_blockman.m_block_index.size());\n+    if (is_active_chain) {\n+        for (const std::pair<const uint256, CBlockIndex*>& entry : m_blockman.m_block_index) {\n+            forward.insert(std::make_pair(entry.second->pprev, entry.second));\n+        }\n+\n+        assert(forward.size() == m_blockman.m_block_index.size());\n+    } else {\n+        // For the background validation chainstate, don't consider the full block tree -\n+        // only consider headers on the IBD chain. Otherwise, we will fail assertions\n+        // related to `setBlockIndexCandidates` below, which corresponds to this subset of\n+        // the block tree for this chainstate.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r619424621",
      "id" : 619424621,
      "in_reply_to_id" : 615054872,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxOTQyNDYyMQ==",
      "original_commit_id" : "d3cec2a5b3febd091b8002e39f8b7431b7e99c4a",
      "original_line" : 4686,
      "original_position" : 28,
      "original_start_line" : 4834,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 643569615,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-23T18:36:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/619424621",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r619424718"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/619424718"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "eb9623d690e6f390a5f6a8b30763374b72aee282",
      "created_at" : "2021-04-23T18:36:58Z",
      "diff_hunk" : "@@ -117,9 +117,20 @@ struct TestChain100Setup : public RegTestingSetup {\n     /**\n      * Create a new block with just given transactions, coinbase paying to\n      * scriptPubKey, and try to add it to the current chain.\n+     * If no chainstate is specified, default to the active.\n      */\n     CBlock CreateAndProcessBlock(const std::vector<CMutableTransaction>& txns,\n-                                 const CScript& scriptPubKey);\n+                                 const CScript& scriptPubKey,\n+                                 CChainState* chainstate = nullptr);\n+\n+    /**\n+     * Create a new block with just given transactions, coinbase paying to\n+     * scriptPubKey. If no chainstate is specified, default to the active.\n+     */\n+    CBlock CreateBlock(\n+        const std::vector<CMutableTransaction>& txns,\n+        const CScript& scriptPubKey,\n+        CChainState* chainstate = nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r619424718",
      "id" : 619424718,
      "in_reply_to_id" : 615063212,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxOTQyNDcxOA==",
      "original_commit_id" : "6e5871c0c7b7d7b27b56df4f2c0705921025a6d5",
      "original_line" : 135,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/test/util/setup_common.h",
      "position" : null,
      "pull_request_review_id" : 643569705,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-23T18:36:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/619424718",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r619425233"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/619425233"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done. \r\n\r\n> Also curious if there's an existing test (or a planned one) to cover the background chain catching up to the activated snapshot.\r\n\r\nYes; I'll look at writing a test for this sometime today in addition to some chainstate-concurrency torture tests.",
      "commit_id" : "eb9623d690e6f390a5f6a8b30763374b72aee282",
      "created_at" : "2021-04-23T18:37:48Z",
      "diff_hunk" : "@@ -72,4 +75,66 @@ BOOST_AUTO_TEST_CASE(validation_chainstate_resize_caches)\n     WITH_LOCK(::cs_main, manager.Unload());\n }\n \n+//! Test UpdateTip behavior for both active and background chainstates.\n+//!\n+//! When run on the background chainstate, UpdateTip should do a subset\n+//! of what it does for the active chainstate.\n+BOOST_FIXTURE_TEST_CASE(chainstate_update_tip, TestChain100Setup)\n+{\n+    ChainstateManager& chainman = *Assert(m_node.chainman);\n+    uint256 curr_tip = ::g_best_block;\n+\n+    // Mine 10 more blocks, putting at us height 110 where a valid assumeutxo value can\n+    // be found.\n+    mineBlocks(10);\n+\n+    // After adding some blocks to the tip, best block should have changed.\n+    BOOST_CHECK(::g_best_block != curr_tip);\n+\n+    BOOST_REQUIRE(CreateAndActivateUTXOSnapshot(m_node, m_path_root));\n+\n+    // Ensure our active chain is the snapshot chainstate.\n+    BOOST_CHECK(chainman.IsSnapshotActive());\n+\n+    curr_tip = ::g_best_block;\n+\n+    // Mine a new block on top of the activated snapshot chainstate.\n+    mineBlocks(1);  // Defined in TestChain100Setup.\n+\n+    // After adding some blocks to the snapshot tip, best block should have changed.\n+    BOOST_CHECK(::g_best_block != curr_tip);\n+\n+    curr_tip = ::g_best_block;\n+\n+    CChainState& background_cs = m_node.chainman->ValidatedChainstate();\n+    BOOST_CHECK(m_node.chainman->IsBackgroundIBD(&background_cs));\n+\n+    // Create a block to append to the validation chain.\n+    std::vector<CMutableTransaction> noTxns;\n+    CScript scriptPubKey = CScript() << ToByteVector(coinbaseKey.GetPubKey()) << OP_CHECKSIG;\n+    CBlock validation_block = this->CreateBlock(noTxns, scriptPubKey, &background_cs);\n+    auto pblock = std::make_shared<const CBlock>(validation_block);\n+    BlockValidationState state;\n+    CBlockIndex* pindex = nullptr;\n+    const CChainParams& chainparams = Params();\n+    bool newblock = false;\n+\n+    // TODO: much of this is inlined from ProcessNewBlock(); just reuse PNB()\n+    // once it is changed to support multiple chainstates.\n+    {\n+        LOCK(::cs_main);\n+        bool checked = CheckBlock(*pblock, state, chainparams.GetConsensus());\n+        BOOST_CHECK(checked);\n+        bool accepted = background_cs.AcceptBlock(\n+            pblock, state, chainparams, &pindex, true, nullptr, &newblock);\n+        BOOST_CHECK(accepted);\n+    }\n+    bool block_added = background_cs.ActivateBestChain(state, chainparams, pblock);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r619425233",
      "id" : 619425233,
      "in_reply_to_id" : 615074725,
      "line" : 133,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxOTQyNTIzMw==",
      "original_commit_id" : "3f1346a0178afef20db3599cc545dbc54200d635",
      "original_line" : 133,
      "original_position" : 73,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstate_tests.cpp",
      "position" : 74,
      "pull_request_review_id" : 643570275,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-23T18:37:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/619425233",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the great feedback, @ryanofsky!",
      "created_at" : "2021-04-23T18:38:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#issuecomment-825847464",
      "id" : 825847464,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21526",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyNTg0NzQ2NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-23T18:38:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/825847464",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--4a62be1de6b64f3ed646cdc7932c8cf5-->\nðµï¸ @sipa has been requested to review this pull request as specified in the REVIEWERS file.",
      "created_at" : "2021-05-03T09:32:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#issuecomment-831142104",
      "id" : 831142104,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21526",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgzMTE0MjEwNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-03T09:32:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/831142104",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r625442975"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/625442975"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"test: refactor: separate CreateBlock in TestChain100Setup\" (6d5d09634ac354c16c298c83d7b699b2147a98b3)\r\n\r\nWould be nice to make the last argument a `CChainState&` reference instead of a pointer since it isn't allowed to be null (and it's a new method so there's no backward compatility concern)",
      "commit_id" : "eb9623d690e6f390a5f6a8b30763374b72aee282",
      "created_at" : "2021-05-04T00:16:15Z",
      "diff_hunk" : "@@ -234,21 +234,38 @@ void TestChain100Setup::mineBlocks(int num_blocks)\n     }\n }\n \n-CBlock TestChain100Setup::CreateAndProcessBlock(const std::vector<CMutableTransaction>& txns, const CScript& scriptPubKey)\n+CBlock TestChain100Setup::CreateBlock(\n+    const std::vector<CMutableTransaction>& txns,\n+    const CScript& scriptPubKey,\n+    CChainState* chainstate)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r625442975",
      "id" : 625442975,
      "line" : 240,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNTQ0Mjk3NQ==",
      "original_commit_id" : "6d5d09634ac354c16c298c83d7b699b2147a98b3",
      "original_line" : 240,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 8,
      "pull_request_review_id" : 650813361,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-04T00:30:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/625442975",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r626767940"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/626767940"
         }
      },
      "author_association" : "MEMBER",
      "body" : "23c2d26d424e5a8b523f7210653958eff10db0f2: given the above `return`, you don't have to drop this assert",
      "commit_id" : "eb9623d690e6f390a5f6a8b30763374b72aee282",
      "created_at" : "2021-05-05T17:36:33Z",
      "diff_hunk" : "@@ -2321,8 +2355,7 @@ static void UpdateTip(CTxMemPool& mempool, const CBlockIndex* pindexNew, const C\n     }\n \n     bilingual_str warning_messages;\n-    assert(std::addressof(::ChainstateActive()) == std::addressof(active_chainstate));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r626767940",
      "id" : 626767940,
      "line" : 2324,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNjc2Nzk0MA==",
      "original_commit_id" : "23c2d26d424e5a8b523f7210653958eff10db0f2",
      "original_line" : 2324,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 59,
      "pull_request_review_id" : 652577266,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T18:18:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/626767940",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r626774638"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/626774638"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```\r\nvalidation.cpp:2321:38: warning: lambda capture 'func_name' is not required to be captured for this use [-Wunused-lambda-capture]\r\n    auto log_progress = [pindexNew, &func_name, &coins_view, &chainParams](\r\n                                  ~~~^~~~~~~~~\r\n1 warning generated.\r\n```",
      "commit_id" : "eb9623d690e6f390a5f6a8b30763374b72aee282",
      "created_at" : "2021-05-05T17:46:46Z",
      "diff_hunk" : "@@ -2307,10 +2307,44 @@ static void AppendWarning(bilingual_str& res, const bilingual_str& warn)\n     res += warn;\n }\n \n-/** Check warning conditions and do some notifications on new chain tip set. */\n-static void UpdateTip(CTxMemPool& mempool, const CBlockIndex* pindexNew, const CChainParams& chainParams, CChainState& active_chainstate)\n+/** Check warning conditions and do some notifications on new chain tip set.\n+ *\n+ * Only perform certain functions when the active chainstate is passed, e.g.\n+ * notifying getblocktemplate RPC of a new block (`g_best_block` and\n+ * `mempool.AddTransactionsUpdated`). Doing this for the background\n+ * chainstate would cause incorrect behavior.\n+ */\n+static void UpdateTip(CTxMemPool& mempool, const CBlockIndex* pindexNew, const CChainParams& chainParams, CChainState& chainstate)\n     EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n {\n+    auto& func_name = __func__;\n+    auto& coins_view = chainstate.CoinsTip();\n+    auto log_progress = [pindexNew, &func_name, &coins_view, &chainParams](",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r626774638",
      "id" : 626774638,
      "line" : 2321,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNjc3NDYzOA==",
      "original_commit_id" : "23c2d26d424e5a8b523f7210653958eff10db0f2",
      "original_line" : 2322,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 26,
      "pull_request_review_id" : 652577266,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T18:18:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/626774638",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r626791045"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/626791045"
         }
      },
      "author_association" : "MEMBER",
      "body" : "23b5ebd02e584c7bb982ccbc28bbabd927b9c57e  why would `CreateNewBlock` ever be called on the background chainstate?",
      "commit_id" : "eb9623d690e6f390a5f6a8b30763374b72aee282",
      "created_at" : "2021-05-05T18:11:11Z",
      "diff_hunk" : "@@ -116,7 +116,6 @@ std::unique_ptr<CBlockTemplate> BlockAssembler::CreateNewBlock(const CScript& sc\n     pblocktemplate->vTxSigOpsCost.push_back(-1); // updated at end\n \n     LOCK2(cs_main, m_mempool.cs);\n-    assert(std::addressof(*::ChainActive().Tip()) == std::addressof(*m_chainstate.m_chain.Tip()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r626791045",
      "id" : 626791045,
      "line" : 119,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNjc5MTA0NQ==",
      "original_commit_id" : "23b5ebd02e584c7bb982ccbc28bbabd927b9c57e",
      "original_line" : 119,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/miner.cpp",
      "position" : 4,
      "pull_request_review_id" : 652577266,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T18:18:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/626791045",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r626792949"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/626792949"
         }
      },
      "author_association" : "MEMBER",
      "body" : "23b5ebd02e584c7bb982ccbc28bbabd927b9c57e: I thought the background chain didn't have a mempool? Or it had a dummy mempool. I guess it's fine to remove this assert though.",
      "commit_id" : "eb9623d690e6f390a5f6a8b30763374b72aee282",
      "created_at" : "2021-05-05T18:14:08Z",
      "diff_hunk" : "@@ -635,7 +635,6 @@ void CTxMemPool::check(CChainState& active_chainstate) const\n     uint64_t innerUsage = 0;\n \n     CCoinsViewCache& active_coins_tip = active_chainstate.CoinsTip();\n-    assert(std::addressof(::ChainstateActive().CoinsTip()) == std::addressof(active_coins_tip)); // TODO: REVIEW-ONLY, REMOVE IN FUTURE COMMIT",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r626792949",
      "id" : 626792949,
      "line" : 638,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNjc5Mjk0OQ==",
      "original_commit_id" : "23b5ebd02e584c7bb982ccbc28bbabd927b9c57e",
      "original_line" : 638,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 4,
      "pull_request_review_id" : 652577266,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T18:18:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/626792949",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r627181867"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/627181867"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fails CI when addressing this warning.",
      "commit_id" : "eb9623d690e6f390a5f6a8b30763374b72aee282",
      "created_at" : "2021-05-06T08:14:00Z",
      "diff_hunk" : "@@ -2307,10 +2307,44 @@ static void AppendWarning(bilingual_str& res, const bilingual_str& warn)\n     res += warn;\n }\n \n-/** Check warning conditions and do some notifications on new chain tip set. */\n-static void UpdateTip(CTxMemPool& mempool, const CBlockIndex* pindexNew, const CChainParams& chainParams, CChainState& active_chainstate)\n+/** Check warning conditions and do some notifications on new chain tip set.\n+ *\n+ * Only perform certain functions when the active chainstate is passed, e.g.\n+ * notifying getblocktemplate RPC of a new block (`g_best_block` and\n+ * `mempool.AddTransactionsUpdated`). Doing this for the background\n+ * chainstate would cause incorrect behavior.\n+ */\n+static void UpdateTip(CTxMemPool& mempool, const CBlockIndex* pindexNew, const CChainParams& chainParams, CChainState& chainstate)\n     EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n {\n+    auto& func_name = __func__;\n+    auto& coins_view = chainstate.CoinsTip();\n+    auto log_progress = [pindexNew, &func_name, &coins_view, &chainParams](",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r627181867",
      "id" : 627181867,
      "in_reply_to_id" : 626774638,
      "line" : 2321,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNzE4MTg2Nw==",
      "original_commit_id" : "23c2d26d424e5a8b523f7210653958eff10db0f2",
      "original_line" : 2322,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 26,
      "pull_request_review_id" : 653088362,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-06T08:14:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/627181867",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r627182208"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/627182208"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Gets called during unittests.",
      "commit_id" : "eb9623d690e6f390a5f6a8b30763374b72aee282",
      "created_at" : "2021-05-06T08:14:26Z",
      "diff_hunk" : "@@ -116,7 +116,6 @@ std::unique_ptr<CBlockTemplate> BlockAssembler::CreateNewBlock(const CScript& sc\n     pblocktemplate->vTxSigOpsCost.push_back(-1); // updated at end\n \n     LOCK2(cs_main, m_mempool.cs);\n-    assert(std::addressof(*::ChainActive().Tip()) == std::addressof(*m_chainstate.m_chain.Tip()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r627182208",
      "id" : 627182208,
      "in_reply_to_id" : 626791045,
      "line" : 119,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNzE4MjIwOA==",
      "original_commit_id" : "23b5ebd02e584c7bb982ccbc28bbabd927b9c57e",
      "original_line" : 119,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/miner.cpp",
      "position" : 4,
      "pull_request_review_id" : 653088826,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-06T08:14:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/627182208",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r627182479"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/627182479"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Same as above; called during unittests.",
      "commit_id" : "eb9623d690e6f390a5f6a8b30763374b72aee282",
      "created_at" : "2021-05-06T08:14:47Z",
      "diff_hunk" : "@@ -635,7 +635,6 @@ void CTxMemPool::check(CChainState& active_chainstate) const\n     uint64_t innerUsage = 0;\n \n     CCoinsViewCache& active_coins_tip = active_chainstate.CoinsTip();\n-    assert(std::addressof(::ChainstateActive().CoinsTip()) == std::addressof(active_coins_tip)); // TODO: REVIEW-ONLY, REMOVE IN FUTURE COMMIT",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r627182479",
      "id" : 627182479,
      "in_reply_to_id" : 626792949,
      "line" : 638,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNzE4MjQ3OQ==",
      "original_commit_id" : "23b5ebd02e584c7bb982ccbc28bbabd927b9c57e",
      "original_line" : 638,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 4,
      "pull_request_review_id" : 653089206,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-06T08:14:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/627182479",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r627241697"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/627241697"
         }
      },
      "author_association" : "MEMBER",
      "body" : "But why?",
      "commit_id" : "eb9623d690e6f390a5f6a8b30763374b72aee282",
      "created_at" : "2021-05-06T09:18:27Z",
      "diff_hunk" : "@@ -116,7 +116,6 @@ std::unique_ptr<CBlockTemplate> BlockAssembler::CreateNewBlock(const CScript& sc\n     pblocktemplate->vTxSigOpsCost.push_back(-1); // updated at end\n \n     LOCK2(cs_main, m_mempool.cs);\n-    assert(std::addressof(*::ChainActive().Tip()) == std::addressof(*m_chainstate.m_chain.Tip()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r627241697",
      "id" : 627241697,
      "in_reply_to_id" : 626791045,
      "line" : 119,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNzI0MTY5Nw==",
      "original_commit_id" : "23b5ebd02e584c7bb982ccbc28bbabd927b9c57e",
      "original_line" : 119,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/miner.cpp",
      "position" : 4,
      "pull_request_review_id" : 653189189,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-06T09:18:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/627241697",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r631230573"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631230573"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Because (unlike in actual snapshot usage) we don't have pre-prepared snapshots to use from within unittests, we have to use the same chainstate objects that we ultimately test on to generate snapshots for use during the test. As a result, the background validation chainstate is already at the snapshot base block, so in order to test appending to the bg chainstate, we have to call `CreateNewBlock` with it.\r\n\r\nWhile I agree this usage isn't realistic, we don't have great alternatives within tests. I guess another option would involve using a temporary chainstate to generate the snapshot and then loading it into a new chainstatemanager object, but that sounds even hairier than what we're doing here, and much more code.",
      "commit_id" : "eb9623d690e6f390a5f6a8b30763374b72aee282",
      "created_at" : "2021-05-12T17:01:08Z",
      "diff_hunk" : "@@ -116,7 +116,6 @@ std::unique_ptr<CBlockTemplate> BlockAssembler::CreateNewBlock(const CScript& sc\n     pblocktemplate->vTxSigOpsCost.push_back(-1); // updated at end\n \n     LOCK2(cs_main, m_mempool.cs);\n-    assert(std::addressof(*::ChainActive().Tip()) == std::addressof(*m_chainstate.m_chain.Tip()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r631230573",
      "id" : 631230573,
      "in_reply_to_id" : 626791045,
      "line" : 119,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMTIzMDU3Mw==",
      "original_commit_id" : "23b5ebd02e584c7bb982ccbc28bbabd927b9c57e",
      "original_line" : 119,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/miner.cpp",
      "position" : 4,
      "pull_request_review_id" : 658151566,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-12T17:01:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631230573",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   }
]
