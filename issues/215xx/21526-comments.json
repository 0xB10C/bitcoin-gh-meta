[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#21603](https://github.com/bitcoin/bitcoin/pull/21603) (log: Mitigate disk filling attacks by rate limiting LogPrintf by dergoegge)\n* [#19790](https://github.com/bitcoin/bitcoin/pull/19790) (Flag when blocks have had their scripts checked instead of skipped by luke-jr)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-03-24T21:36:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#issuecomment-806201724",
      "id" : 806201724,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21526",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwNjIwMTcyNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-04T00:07:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/806201724",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/21526#issue-600020266\r\n\r\n> * Don't run `UpdateTip` for background validation chainstates.\r\n\r\nDoes this prevent bugs in the future when there can be a background validation chainstate? It would help to say what would happen without this change. It could also be helpful to say more about the motivation for this set of changes, and maybe summarize the current state of things for forgetful people like me who somewhat lost the thread on assumeutxo :tropical_fish: \r\n\r\n> * Modify `LoadBlockIndex()` to populate the \"faked\" nChainTx value when using a yet-unvalidated snapshot chainstate. This allows assumeutxo sync-to-tip to offer normal progress estimates on the basis of having nChainTx without the associated block data.\r\n\r\nIIUC, the faking isn't new, and the value was faked before this change, but startup code is now fixed  so things work if the node is restarted before the assumeutxo snapshot is validated? Again could help to say what bad things would happen without this.\r\n\r\n> * In `LoadBlockIndex()`, ensure that assumed-valid CBlockIndex entries aren't added to the background validation chainstate's setBlockIndexCandidates (since we want that chainstate to actually validate those entries at some point).\r\n\r\nWondering also what bad things happen without this change, and why it's in the same commit as the last change. Is it just that both changes affect the `LoadBlockIndex()` function?\r\n\r\n> * Prevent `RewindBlockIndex()` from rewinding past the assumeutxo base on the snapshot chainstate.\r\n\r\nI'm a little confused by this code (also the existing pruning code here). It says the purpose of the break is to prevent the DisconnectTip call immediately below from failing. But don't we want to fail in these cases? It seems like now if rewind isn't possible, this just flushes some things and returns true. I'm also wondering if there's a reason this change is in the same commit as the other changes, which seem tangentially related.\r\n\r\nAlso, there's no test coverage here. Maybe is the best we can do when adding dead code to older functions that weren't really designed to be unit-tested. But are there at least future tests in #15606 that would fail without these different fixes?\r\n\r\nThanks for any clarifications, and great to see assumeutxo work moving along again!",
      "created_at" : "2021-03-29T01:41:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#issuecomment-809009595",
      "id" : 809009595,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21526",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwOTAwOTU5NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-29T01:43:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/809009595",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ryanofsky thanks for the thorough look! I agree that I should take a look at writing unittests for these changes and do so if practical. Also appreciate your questions on the logic - I'll get together some responses for those and either adjust the code (especially since `RewindBlockIndex()` is probably going away in #21009) or add some motivating documentation. ",
      "created_at" : "2021-03-30T15:22:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#issuecomment-810351331",
      "id" : 810351331,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21526",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxMDM1MTMzMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-30T15:23:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/810351331",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Okay, after taking @ryanofsky's advice, I sat down to write some unittests for the chainstate-dependent UpdateTip() behavior. It turns out that in the process, trying to get those tests to work uncovered a number of changes that needed to be made to other test-related stuff, including slightly modifying `CheckBlockIndex()` to account for the specific nature of the background validation chainstate. Additionally I've added some unittesting utils that help with testing multiple chainstates.\r\n\r\nBecause that's dragged in so much new code, I've narrowed the scope of this PR to the above and I'll deal with the other BlockIndex-related changes in a follow-up PR.\r\n\r\nSo all the logic changes in this are now tested (and this actually adds unit-level coverage of the `UpdateTip()` behvaior that we didn't have previously). So hopefully that entices people to review, because testing future assumeutxo-related changes will probably depend on some of the unittest utils added here.\r\n\r\nAlso worth mentioning is that I had to remove some of the active chainstate assertions that @dongcarl added for the sake of his work in #20158. This should all be okay because those assertions are actually made obsolete by assumeutxo functionality. ",
      "created_at" : "2021-04-08T14:58:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#issuecomment-815893602",
      "id" : 815893602,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21526",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxNTg5MzYwMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-08T14:58:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/815893602",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r615054872"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615054872"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: fix CheckBlockIndex for multiple chainstates\" (d3cec2a5b3febd091b8002e39f8b7431b7e99c4a)\r\n\r\nThis is ok, but it seems to avoid other checks below besides the `setBlockIndexCandidates` checks. And if more checks are added below in the future they could be bypassed unnecessarily. I wonder if it might be more straightforward and futureproof just to add `&& is_active_chain` or `|| !is_active_chain` to the specific assertions below which are failing instead of pruning branches off this tree.",
      "commit_id" : "eb9623d690e6f390a5f6a8b30763374b72aee282",
      "created_at" : "2021-04-16T18:43:24Z",
      "diff_hunk" : "@@ -4821,11 +4823,27 @@ void CChainState::CheckBlockIndex(const Consensus::Params& consensusParams)\n \n     // Build forward-pointing map of the entire block tree.\n     std::multimap<CBlockIndex*,CBlockIndex*> forward;\n-    for (const std::pair<const uint256, CBlockIndex*>& entry : m_blockman.m_block_index) {\n-        forward.insert(std::make_pair(entry.second->pprev, entry.second));\n-    }\n \n-    assert(forward.size() == m_blockman.m_block_index.size());\n+    if (is_active_chain) {\n+        for (const std::pair<const uint256, CBlockIndex*>& entry : m_blockman.m_block_index) {\n+            forward.insert(std::make_pair(entry.second->pprev, entry.second));\n+        }\n+\n+        assert(forward.size() == m_blockman.m_block_index.size());\n+    } else {\n+        // For the background validation chainstate, don't consider the full block tree -\n+        // only consider headers on the IBD chain. Otherwise, we will fail assertions\n+        // related to `setBlockIndexCandidates` below, which corresponds to this subset of\n+        // the block tree for this chainstate.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r615054872",
      "id" : 615054872,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTA1NDg3Mg==",
      "original_commit_id" : "d3cec2a5b3febd091b8002e39f8b7431b7e99c4a",
      "original_line" : 4686,
      "original_position" : 28,
      "original_start_line" : 4834,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 637995324,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-23T18:36:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615054872",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r615063212"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615063212"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"test: refactor: separate CreateBlock in TestChain100Setup\" (6e5871c0c7b7d7b27b56df4f2c0705921025a6d5)\r\n\r\nIMO, it is reasonable for `CreateAndProcessBlock` to have a default-active chainstate pointer for backwards compatibility, but it might be better for this new `CreateBlock` method to take an explicit `CChainState&` reference for more clarity in test code and to prevent mistakes forgetting to specify it.",
      "commit_id" : "eb9623d690e6f390a5f6a8b30763374b72aee282",
      "created_at" : "2021-04-16T18:59:01Z",
      "diff_hunk" : "@@ -117,9 +117,20 @@ struct TestChain100Setup : public RegTestingSetup {\n     /**\n      * Create a new block with just given transactions, coinbase paying to\n      * scriptPubKey, and try to add it to the current chain.\n+     * If no chainstate is specified, default to the active.\n      */\n     CBlock CreateAndProcessBlock(const std::vector<CMutableTransaction>& txns,\n-                                 const CScript& scriptPubKey);\n+                                 const CScript& scriptPubKey,\n+                                 CChainState* chainstate = nullptr);\n+\n+    /**\n+     * Create a new block with just given transactions, coinbase paying to\n+     * scriptPubKey. If no chainstate is specified, default to the active.\n+     */\n+    CBlock CreateBlock(\n+        const std::vector<CMutableTransaction>& txns,\n+        const CScript& scriptPubKey,\n+        CChainState* chainstate = nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r615063212",
      "id" : 615063212,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTA2MzIxMg==",
      "original_commit_id" : "6e5871c0c7b7d7b27b56df4f2c0705921025a6d5",
      "original_line" : 135,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/test/util/setup_common.h",
      "position" : null,
      "pull_request_review_id" : 637995324,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-23T18:36:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615063212",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r615074725"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615074725"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"test: validation: add unittest for UpdateTip behavior\" (3f1346a0178afef20db3599cc545dbc54200d635)\r\n\r\nSince this test is designed to check `UpdateTip` background behavior, but the test doesn't call `UpdateTip` directly, it may be good to add a comment saying this line is what calls `UpdateTip`.\r\n\r\nAlso could maybe a simple check could be added here to verify the new background tip hash?\r\n\r\nAlso curious if there's an existing test (or a planned one) to cover the background chain catching up to the activated snapshot.",
      "commit_id" : "eb9623d690e6f390a5f6a8b30763374b72aee282",
      "created_at" : "2021-04-16T19:21:47Z",
      "diff_hunk" : "@@ -72,4 +75,66 @@ BOOST_AUTO_TEST_CASE(validation_chainstate_resize_caches)\n     WITH_LOCK(::cs_main, manager.Unload());\n }\n \n+//! Test UpdateTip behavior for both active and background chainstates.\n+//!\n+//! When run on the background chainstate, UpdateTip should do a subset\n+//! of what it does for the active chainstate.\n+BOOST_FIXTURE_TEST_CASE(chainstate_update_tip, TestChain100Setup)\n+{\n+    ChainstateManager& chainman = *Assert(m_node.chainman);\n+    uint256 curr_tip = ::g_best_block;\n+\n+    // Mine 10 more blocks, putting at us height 110 where a valid assumeutxo value can\n+    // be found.\n+    mineBlocks(10);\n+\n+    // After adding some blocks to the tip, best block should have changed.\n+    BOOST_CHECK(::g_best_block != curr_tip);\n+\n+    BOOST_REQUIRE(CreateAndActivateUTXOSnapshot(m_node, m_path_root));\n+\n+    // Ensure our active chain is the snapshot chainstate.\n+    BOOST_CHECK(chainman.IsSnapshotActive());\n+\n+    curr_tip = ::g_best_block;\n+\n+    // Mine a new block on top of the activated snapshot chainstate.\n+    mineBlocks(1);  // Defined in TestChain100Setup.\n+\n+    // After adding some blocks to the snapshot tip, best block should have changed.\n+    BOOST_CHECK(::g_best_block != curr_tip);\n+\n+    curr_tip = ::g_best_block;\n+\n+    CChainState& background_cs = m_node.chainman->ValidatedChainstate();\n+    BOOST_CHECK(m_node.chainman->IsBackgroundIBD(&background_cs));\n+\n+    // Create a block to append to the validation chain.\n+    std::vector<CMutableTransaction> noTxns;\n+    CScript scriptPubKey = CScript() << ToByteVector(coinbaseKey.GetPubKey()) << OP_CHECKSIG;\n+    CBlock validation_block = this->CreateBlock(noTxns, scriptPubKey, &background_cs);\n+    auto pblock = std::make_shared<const CBlock>(validation_block);\n+    BlockValidationState state;\n+    CBlockIndex* pindex = nullptr;\n+    const CChainParams& chainparams = Params();\n+    bool newblock = false;\n+\n+    // TODO: much of this is inlined from ProcessNewBlock(); just reuse PNB()\n+    // once it is changed to support multiple chainstates.\n+    {\n+        LOCK(::cs_main);\n+        bool checked = CheckBlock(*pblock, state, chainparams.GetConsensus());\n+        BOOST_CHECK(checked);\n+        bool accepted = background_cs.AcceptBlock(\n+            pblock, state, chainparams, &pindex, true, nullptr, &newblock);\n+        BOOST_CHECK(accepted);\n+    }\n+    bool block_added = background_cs.ActivateBestChain(state, chainparams, pblock);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r615074725",
      "id" : 615074725,
      "line" : 133,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTA3NDcyNQ==",
      "original_commit_id" : "3f1346a0178afef20db3599cc545dbc54200d635",
      "original_line" : 133,
      "original_position" : 73,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstate_tests.cpp",
      "position" : 74,
      "pull_request_review_id" : 637995324,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-23T18:36:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615074725",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-04-17T16:26:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#issuecomment-821849296",
      "id" : 821849296,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21526",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyMTg0OTI5Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-17T16:26:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/821849296",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r619424621"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/619424621"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good call, fixed.",
      "commit_id" : "eb9623d690e6f390a5f6a8b30763374b72aee282",
      "created_at" : "2021-04-23T18:36:51Z",
      "diff_hunk" : "@@ -4821,11 +4823,27 @@ void CChainState::CheckBlockIndex(const Consensus::Params& consensusParams)\n \n     // Build forward-pointing map of the entire block tree.\n     std::multimap<CBlockIndex*,CBlockIndex*> forward;\n-    for (const std::pair<const uint256, CBlockIndex*>& entry : m_blockman.m_block_index) {\n-        forward.insert(std::make_pair(entry.second->pprev, entry.second));\n-    }\n \n-    assert(forward.size() == m_blockman.m_block_index.size());\n+    if (is_active_chain) {\n+        for (const std::pair<const uint256, CBlockIndex*>& entry : m_blockman.m_block_index) {\n+            forward.insert(std::make_pair(entry.second->pprev, entry.second));\n+        }\n+\n+        assert(forward.size() == m_blockman.m_block_index.size());\n+    } else {\n+        // For the background validation chainstate, don't consider the full block tree -\n+        // only consider headers on the IBD chain. Otherwise, we will fail assertions\n+        // related to `setBlockIndexCandidates` below, which corresponds to this subset of\n+        // the block tree for this chainstate.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r619424621",
      "id" : 619424621,
      "in_reply_to_id" : 615054872,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxOTQyNDYyMQ==",
      "original_commit_id" : "d3cec2a5b3febd091b8002e39f8b7431b7e99c4a",
      "original_line" : 4686,
      "original_position" : 28,
      "original_start_line" : 4834,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 643569615,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-04-23T18:36:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/619424621",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r619424718"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/619424718"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "eb9623d690e6f390a5f6a8b30763374b72aee282",
      "created_at" : "2021-04-23T18:36:58Z",
      "diff_hunk" : "@@ -117,9 +117,20 @@ struct TestChain100Setup : public RegTestingSetup {\n     /**\n      * Create a new block with just given transactions, coinbase paying to\n      * scriptPubKey, and try to add it to the current chain.\n+     * If no chainstate is specified, default to the active.\n      */\n     CBlock CreateAndProcessBlock(const std::vector<CMutableTransaction>& txns,\n-                                 const CScript& scriptPubKey);\n+                                 const CScript& scriptPubKey,\n+                                 CChainState* chainstate = nullptr);\n+\n+    /**\n+     * Create a new block with just given transactions, coinbase paying to\n+     * scriptPubKey. If no chainstate is specified, default to the active.\n+     */\n+    CBlock CreateBlock(\n+        const std::vector<CMutableTransaction>& txns,\n+        const CScript& scriptPubKey,\n+        CChainState* chainstate = nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r619424718",
      "id" : 619424718,
      "in_reply_to_id" : 615063212,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxOTQyNDcxOA==",
      "original_commit_id" : "6e5871c0c7b7d7b27b56df4f2c0705921025a6d5",
      "original_line" : 135,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/test/util/setup_common.h",
      "position" : null,
      "pull_request_review_id" : 643569705,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-23T18:36:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/619424718",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r619425233"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/619425233"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done. \r\n\r\n> Also curious if there's an existing test (or a planned one) to cover the background chain catching up to the activated snapshot.\r\n\r\nYes; I'll look at writing a test for this sometime today in addition to some chainstate-concurrency torture tests.",
      "commit_id" : "eb9623d690e6f390a5f6a8b30763374b72aee282",
      "created_at" : "2021-04-23T18:37:48Z",
      "diff_hunk" : "@@ -72,4 +75,66 @@ BOOST_AUTO_TEST_CASE(validation_chainstate_resize_caches)\n     WITH_LOCK(::cs_main, manager.Unload());\n }\n \n+//! Test UpdateTip behavior for both active and background chainstates.\n+//!\n+//! When run on the background chainstate, UpdateTip should do a subset\n+//! of what it does for the active chainstate.\n+BOOST_FIXTURE_TEST_CASE(chainstate_update_tip, TestChain100Setup)\n+{\n+    ChainstateManager& chainman = *Assert(m_node.chainman);\n+    uint256 curr_tip = ::g_best_block;\n+\n+    // Mine 10 more blocks, putting at us height 110 where a valid assumeutxo value can\n+    // be found.\n+    mineBlocks(10);\n+\n+    // After adding some blocks to the tip, best block should have changed.\n+    BOOST_CHECK(::g_best_block != curr_tip);\n+\n+    BOOST_REQUIRE(CreateAndActivateUTXOSnapshot(m_node, m_path_root));\n+\n+    // Ensure our active chain is the snapshot chainstate.\n+    BOOST_CHECK(chainman.IsSnapshotActive());\n+\n+    curr_tip = ::g_best_block;\n+\n+    // Mine a new block on top of the activated snapshot chainstate.\n+    mineBlocks(1);  // Defined in TestChain100Setup.\n+\n+    // After adding some blocks to the snapshot tip, best block should have changed.\n+    BOOST_CHECK(::g_best_block != curr_tip);\n+\n+    curr_tip = ::g_best_block;\n+\n+    CChainState& background_cs = m_node.chainman->ValidatedChainstate();\n+    BOOST_CHECK(m_node.chainman->IsBackgroundIBD(&background_cs));\n+\n+    // Create a block to append to the validation chain.\n+    std::vector<CMutableTransaction> noTxns;\n+    CScript scriptPubKey = CScript() << ToByteVector(coinbaseKey.GetPubKey()) << OP_CHECKSIG;\n+    CBlock validation_block = this->CreateBlock(noTxns, scriptPubKey, &background_cs);\n+    auto pblock = std::make_shared<const CBlock>(validation_block);\n+    BlockValidationState state;\n+    CBlockIndex* pindex = nullptr;\n+    const CChainParams& chainparams = Params();\n+    bool newblock = false;\n+\n+    // TODO: much of this is inlined from ProcessNewBlock(); just reuse PNB()\n+    // once it is changed to support multiple chainstates.\n+    {\n+        LOCK(::cs_main);\n+        bool checked = CheckBlock(*pblock, state, chainparams.GetConsensus());\n+        BOOST_CHECK(checked);\n+        bool accepted = background_cs.AcceptBlock(\n+            pblock, state, chainparams, &pindex, true, nullptr, &newblock);\n+        BOOST_CHECK(accepted);\n+    }\n+    bool block_added = background_cs.ActivateBestChain(state, chainparams, pblock);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r619425233",
      "id" : 619425233,
      "in_reply_to_id" : 615074725,
      "line" : 133,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxOTQyNTIzMw==",
      "original_commit_id" : "3f1346a0178afef20db3599cc545dbc54200d635",
      "original_line" : 133,
      "original_position" : 73,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstate_tests.cpp",
      "position" : 74,
      "pull_request_review_id" : 643570275,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-23T18:37:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/619425233",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the great feedback, @ryanofsky!",
      "created_at" : "2021-04-23T18:38:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#issuecomment-825847464",
      "id" : 825847464,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21526",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyNTg0NzQ2NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-23T18:38:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/825847464",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--4a62be1de6b64f3ed646cdc7932c8cf5-->\nðµï¸ @sipa has been requested to review this pull request as specified in the REVIEWERS file.",
      "created_at" : "2021-05-03T09:32:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#issuecomment-831142104",
      "id" : 831142104,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21526",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgzMTE0MjEwNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-03T09:32:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/831142104",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r625442975"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/625442975"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"test: refactor: separate CreateBlock in TestChain100Setup\" (6d5d09634ac354c16c298c83d7b699b2147a98b3)\r\n\r\nWould be nice to make the last argument a `CChainState&` reference instead of a pointer since it isn't allowed to be null (and it's a new method so there's no backward compatility concern)",
      "commit_id" : "eb9623d690e6f390a5f6a8b30763374b72aee282",
      "created_at" : "2021-05-04T00:16:15Z",
      "diff_hunk" : "@@ -234,21 +234,38 @@ void TestChain100Setup::mineBlocks(int num_blocks)\n     }\n }\n \n-CBlock TestChain100Setup::CreateAndProcessBlock(const std::vector<CMutableTransaction>& txns, const CScript& scriptPubKey)\n+CBlock TestChain100Setup::CreateBlock(\n+    const std::vector<CMutableTransaction>& txns,\n+    const CScript& scriptPubKey,\n+    CChainState* chainstate)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r625442975",
      "id" : 625442975,
      "line" : 240,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNTQ0Mjk3NQ==",
      "original_commit_id" : "6d5d09634ac354c16c298c83d7b699b2147a98b3",
      "original_line" : 240,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 8,
      "pull_request_review_id" : 650813361,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-04T00:30:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/625442975",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r626767940"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/626767940"
         }
      },
      "author_association" : "MEMBER",
      "body" : "23c2d26d424e5a8b523f7210653958eff10db0f2: given the above `return`, you don't have to drop this assert",
      "commit_id" : "eb9623d690e6f390a5f6a8b30763374b72aee282",
      "created_at" : "2021-05-05T17:36:33Z",
      "diff_hunk" : "@@ -2321,8 +2355,7 @@ static void UpdateTip(CTxMemPool& mempool, const CBlockIndex* pindexNew, const C\n     }\n \n     bilingual_str warning_messages;\n-    assert(std::addressof(::ChainstateActive()) == std::addressof(active_chainstate));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r626767940",
      "id" : 626767940,
      "line" : 2324,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNjc2Nzk0MA==",
      "original_commit_id" : "23c2d26d424e5a8b523f7210653958eff10db0f2",
      "original_line" : 2324,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 59,
      "pull_request_review_id" : 652577266,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T18:18:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/626767940",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r626774638"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/626774638"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```\r\nvalidation.cpp:2321:38: warning: lambda capture 'func_name' is not required to be captured for this use [-Wunused-lambda-capture]\r\n    auto log_progress = [pindexNew, &func_name, &coins_view, &chainParams](\r\n                                  ~~~^~~~~~~~~\r\n1 warning generated.\r\n```",
      "commit_id" : "eb9623d690e6f390a5f6a8b30763374b72aee282",
      "created_at" : "2021-05-05T17:46:46Z",
      "diff_hunk" : "@@ -2307,10 +2307,44 @@ static void AppendWarning(bilingual_str& res, const bilingual_str& warn)\n     res += warn;\n }\n \n-/** Check warning conditions and do some notifications on new chain tip set. */\n-static void UpdateTip(CTxMemPool& mempool, const CBlockIndex* pindexNew, const CChainParams& chainParams, CChainState& active_chainstate)\n+/** Check warning conditions and do some notifications on new chain tip set.\n+ *\n+ * Only perform certain functions when the active chainstate is passed, e.g.\n+ * notifying getblocktemplate RPC of a new block (`g_best_block` and\n+ * `mempool.AddTransactionsUpdated`). Doing this for the background\n+ * chainstate would cause incorrect behavior.\n+ */\n+static void UpdateTip(CTxMemPool& mempool, const CBlockIndex* pindexNew, const CChainParams& chainParams, CChainState& chainstate)\n     EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n {\n+    auto& func_name = __func__;\n+    auto& coins_view = chainstate.CoinsTip();\n+    auto log_progress = [pindexNew, &func_name, &coins_view, &chainParams](",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r626774638",
      "id" : 626774638,
      "line" : 2321,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNjc3NDYzOA==",
      "original_commit_id" : "23c2d26d424e5a8b523f7210653958eff10db0f2",
      "original_line" : 2322,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 26,
      "pull_request_review_id" : 652577266,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T18:18:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/626774638",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r626791045"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/626791045"
         }
      },
      "author_association" : "MEMBER",
      "body" : "23b5ebd02e584c7bb982ccbc28bbabd927b9c57e  why would `CreateNewBlock` ever be called on the background chainstate?",
      "commit_id" : "eb9623d690e6f390a5f6a8b30763374b72aee282",
      "created_at" : "2021-05-05T18:11:11Z",
      "diff_hunk" : "@@ -116,7 +116,6 @@ std::unique_ptr<CBlockTemplate> BlockAssembler::CreateNewBlock(const CScript& sc\n     pblocktemplate->vTxSigOpsCost.push_back(-1); // updated at end\n \n     LOCK2(cs_main, m_mempool.cs);\n-    assert(std::addressof(*::ChainActive().Tip()) == std::addressof(*m_chainstate.m_chain.Tip()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r626791045",
      "id" : 626791045,
      "line" : 119,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNjc5MTA0NQ==",
      "original_commit_id" : "23b5ebd02e584c7bb982ccbc28bbabd927b9c57e",
      "original_line" : 119,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/miner.cpp",
      "position" : 4,
      "pull_request_review_id" : 652577266,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T18:18:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/626791045",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r626792949"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/626792949"
         }
      },
      "author_association" : "MEMBER",
      "body" : "23b5ebd02e584c7bb982ccbc28bbabd927b9c57e: I thought the background chain didn't have a mempool? Or it had a dummy mempool. I guess it's fine to remove this assert though.",
      "commit_id" : "eb9623d690e6f390a5f6a8b30763374b72aee282",
      "created_at" : "2021-05-05T18:14:08Z",
      "diff_hunk" : "@@ -635,7 +635,6 @@ void CTxMemPool::check(CChainState& active_chainstate) const\n     uint64_t innerUsage = 0;\n \n     CCoinsViewCache& active_coins_tip = active_chainstate.CoinsTip();\n-    assert(std::addressof(::ChainstateActive().CoinsTip()) == std::addressof(active_coins_tip)); // TODO: REVIEW-ONLY, REMOVE IN FUTURE COMMIT",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r626792949",
      "id" : 626792949,
      "line" : 638,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNjc5Mjk0OQ==",
      "original_commit_id" : "23b5ebd02e584c7bb982ccbc28bbabd927b9c57e",
      "original_line" : 638,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 4,
      "pull_request_review_id" : 652577266,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T18:18:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/626792949",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r627181867"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/627181867"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fails CI when addressing this warning.",
      "commit_id" : "eb9623d690e6f390a5f6a8b30763374b72aee282",
      "created_at" : "2021-05-06T08:14:00Z",
      "diff_hunk" : "@@ -2307,10 +2307,44 @@ static void AppendWarning(bilingual_str& res, const bilingual_str& warn)\n     res += warn;\n }\n \n-/** Check warning conditions and do some notifications on new chain tip set. */\n-static void UpdateTip(CTxMemPool& mempool, const CBlockIndex* pindexNew, const CChainParams& chainParams, CChainState& active_chainstate)\n+/** Check warning conditions and do some notifications on new chain tip set.\n+ *\n+ * Only perform certain functions when the active chainstate is passed, e.g.\n+ * notifying getblocktemplate RPC of a new block (`g_best_block` and\n+ * `mempool.AddTransactionsUpdated`). Doing this for the background\n+ * chainstate would cause incorrect behavior.\n+ */\n+static void UpdateTip(CTxMemPool& mempool, const CBlockIndex* pindexNew, const CChainParams& chainParams, CChainState& chainstate)\n     EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n {\n+    auto& func_name = __func__;\n+    auto& coins_view = chainstate.CoinsTip();\n+    auto log_progress = [pindexNew, &func_name, &coins_view, &chainParams](",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r627181867",
      "id" : 627181867,
      "in_reply_to_id" : 626774638,
      "line" : 2321,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNzE4MTg2Nw==",
      "original_commit_id" : "23c2d26d424e5a8b523f7210653958eff10db0f2",
      "original_line" : 2322,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 26,
      "pull_request_review_id" : 653088362,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-06T08:14:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/627181867",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r627182208"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/627182208"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Gets called during unittests.",
      "commit_id" : "eb9623d690e6f390a5f6a8b30763374b72aee282",
      "created_at" : "2021-05-06T08:14:26Z",
      "diff_hunk" : "@@ -116,7 +116,6 @@ std::unique_ptr<CBlockTemplate> BlockAssembler::CreateNewBlock(const CScript& sc\n     pblocktemplate->vTxSigOpsCost.push_back(-1); // updated at end\n \n     LOCK2(cs_main, m_mempool.cs);\n-    assert(std::addressof(*::ChainActive().Tip()) == std::addressof(*m_chainstate.m_chain.Tip()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r627182208",
      "id" : 627182208,
      "in_reply_to_id" : 626791045,
      "line" : 119,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNzE4MjIwOA==",
      "original_commit_id" : "23b5ebd02e584c7bb982ccbc28bbabd927b9c57e",
      "original_line" : 119,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/miner.cpp",
      "position" : 4,
      "pull_request_review_id" : 653088826,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-06T08:14:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/627182208",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r627182479"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/627182479"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Same as above; called during unittests.",
      "commit_id" : "eb9623d690e6f390a5f6a8b30763374b72aee282",
      "created_at" : "2021-05-06T08:14:47Z",
      "diff_hunk" : "@@ -635,7 +635,6 @@ void CTxMemPool::check(CChainState& active_chainstate) const\n     uint64_t innerUsage = 0;\n \n     CCoinsViewCache& active_coins_tip = active_chainstate.CoinsTip();\n-    assert(std::addressof(::ChainstateActive().CoinsTip()) == std::addressof(active_coins_tip)); // TODO: REVIEW-ONLY, REMOVE IN FUTURE COMMIT",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r627182479",
      "id" : 627182479,
      "in_reply_to_id" : 626792949,
      "line" : 638,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNzE4MjQ3OQ==",
      "original_commit_id" : "23b5ebd02e584c7bb982ccbc28bbabd927b9c57e",
      "original_line" : 638,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 4,
      "pull_request_review_id" : 653089206,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-06T08:14:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/627182479",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r627241697"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/627241697"
         }
      },
      "author_association" : "MEMBER",
      "body" : "But why?",
      "commit_id" : "eb9623d690e6f390a5f6a8b30763374b72aee282",
      "created_at" : "2021-05-06T09:18:27Z",
      "diff_hunk" : "@@ -116,7 +116,6 @@ std::unique_ptr<CBlockTemplate> BlockAssembler::CreateNewBlock(const CScript& sc\n     pblocktemplate->vTxSigOpsCost.push_back(-1); // updated at end\n \n     LOCK2(cs_main, m_mempool.cs);\n-    assert(std::addressof(*::ChainActive().Tip()) == std::addressof(*m_chainstate.m_chain.Tip()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r627241697",
      "id" : 627241697,
      "in_reply_to_id" : 626791045,
      "line" : 119,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNzI0MTY5Nw==",
      "original_commit_id" : "23b5ebd02e584c7bb982ccbc28bbabd927b9c57e",
      "original_line" : 119,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/miner.cpp",
      "position" : 4,
      "pull_request_review_id" : 653189189,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-06T09:18:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/627241697",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r631230573"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631230573"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Because (unlike in actual snapshot usage) we don't have pre-prepared snapshots to use from within unittests, we have to use the same chainstate objects that we ultimately test on to generate snapshots for use during the test. As a result, the background validation chainstate is already at the snapshot base block, so in order to test appending to the bg chainstate, we have to call `CreateNewBlock` with it.\r\n\r\nWhile I agree this usage isn't realistic, we don't have great alternatives within tests. I guess another option would involve using a temporary chainstate to generate the snapshot and then loading it into a new chainstatemanager object, but that sounds even hairier than what we're doing here, and much more code.",
      "commit_id" : "eb9623d690e6f390a5f6a8b30763374b72aee282",
      "created_at" : "2021-05-12T17:01:08Z",
      "diff_hunk" : "@@ -116,7 +116,6 @@ std::unique_ptr<CBlockTemplate> BlockAssembler::CreateNewBlock(const CScript& sc\n     pblocktemplate->vTxSigOpsCost.push_back(-1); // updated at end\n \n     LOCK2(cs_main, m_mempool.cs);\n-    assert(std::addressof(*::ChainActive().Tip()) == std::addressof(*m_chainstate.m_chain.Tip()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r631230573",
      "id" : 631230573,
      "in_reply_to_id" : 626791045,
      "line" : 119,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMTIzMDU3Mw==",
      "original_commit_id" : "23b5ebd02e584c7bb982ccbc28bbabd927b9c57e",
      "original_line" : 119,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/miner.cpp",
      "position" : 4,
      "pull_request_review_id" : 658151566,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-12T17:01:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631230573",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Would be good to see this PR move ahead. Has 2 ACKs. There are a few simple code changes, and most of the PR is adding tests. People interested in assumeutxo should take a look.",
      "created_at" : "2021-05-24T21:41:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#issuecomment-847354627",
      "id" : 847354627,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21526",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0NzM1NDYyNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-24T21:41:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/847354627",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "tACK eb9623d690e6f390a5f6a8b30763374b72aee282",
      "created_at" : "2021-05-27T08:05:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#issuecomment-849428519",
      "id" : 849428519,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21526",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0OTQyODUxOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-27T08:06:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/849428519",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15256660?v=4",
         "events_url" : "https://api.github.com/users/benthecarman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/benthecarman/followers",
         "following_url" : "https://api.github.com/users/benthecarman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/benthecarman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/benthecarman",
         "id" : 15256660,
         "login" : "benthecarman",
         "node_id" : "MDQ6VXNlcjE1MjU2NjYw",
         "organizations_url" : "https://api.github.com/users/benthecarman/orgs",
         "received_events_url" : "https://api.github.com/users/benthecarman/received_events",
         "repos_url" : "https://api.github.com/users/benthecarman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/benthecarman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/benthecarman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/benthecarman"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-06-01T12:10:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#issuecomment-852072979",
      "id" : 852072979,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21526",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1MjA3Mjk3OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-01T12:10:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/852072979",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased to fix small conflict. \r\n[`au.multi-chainstates.pt1.8`](https://github.com/jamesob/bitcoin/tree/au.multi-chainstates.pt1.8) -> [`au.multi-chainstates.pt1.9`](https://github.com/jamesob/bitcoin/tree/au.multi-chainstates.pt1.9)\r\n\r\n<details><summary>Show range-diff</summary>\r\n\r\n```sh\r\n$ git range-diff master au.multi-chainstates.pt1.8 au.multi-chainstates.pt1.9\r\n\r\n1:  23c2d26d4 ! 1:  28f800ba6 validation: change UpdateTip for multiple chainstates\r\n    @@ -91,5 +91,5 @@\r\n      extern std::condition_variable g_best_block_cv;\r\n     +/** Used to notify getblocktemplate RPC of new tips. */\r\n      extern uint256 g_best_block;\r\n    - extern std::atomic_bool fImporting;\r\n    - extern std::atomic_bool fReindex;\r\n    + /** Whether there are dedicated script-checking threads running.\r\n    +  * False indicates all script checking is done on the main threadMessageHandler thread.\r\n2:  4600865b4 = 2:  ea5fe5a50 validation: fix CheckBlockIndex for multiple chainstates\r\n3:  5fa0b0437 = 3:  f049daf72 move-only: unittest: add test/util/chainstate.h\r\n4:  6d5d09634 ! 4:  87e872c5b test: refactor: separate CreateBlock in TestChain100Setup\r\n    @@ -26,11 +26,7 @@\r\n\r\n          Assert(block.vtx.size() == 1);\r\n          for (const CMutableTransaction& tx : txns) {\r\n    -         block.vtx.push_back(MakeTransactionRef(tx));\r\n    -     }\r\n    --    CBlockIndex* prev_block = WITH_LOCK(::cs_main, return g_chainman.m_blockman.LookupBlockIndex(block.hashPrevBlock));\r\n    -+    CBlockIndex* prev_block = WITH_LOCK(::cs_main, return chainstate->m_blockman.LookupBlockIndex(block.hashPrevBlock));\r\n    -     RegenerateCommitments(block, prev_block);\r\n    +@@\r\n\r\n          while (!CheckProofOfWork(block.GetHash(), block.nBits, chainparams.GetConsensus())) ++block.nNonce;\r\n\r\n5:  23b5ebd02 = 5:  fc73625bd refactor: remove assertions preventing multiple chainstates\r\n6:  eb9623d69 = 6:  adb0e5a67 test: validation: add unittest for UpdateTip behavior\r\n```\r\n\r\n</details>",
      "created_at" : "2021-06-10T13:13:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#issuecomment-858611266",
      "id" : 858611266,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21526",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1ODYxMTI2Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-10T13:13:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/858611266",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-06-12T04:41:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#issuecomment-859997377",
      "id" : 859997377,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21526",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1OTk5NzM3Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-12T04:41:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/859997377",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "[`au.multi-chainstates.pt1.9`](https://github.com/jamesob/bitcoin/tree/au.multi-chainstates.pt1.9) -> [`au.multi-chainstates.pt1.10`](https://github.com/jamesob/bitcoin/tree/au.multi-chainstates.pt1.10)\r\n\r\nI've rebased on top of master (made necessary after the merge of #21866 :tada:). This branch now includes an additional commit (https://github.com/bitcoin/bitcoin/pull/21526/commits/acb5215743de11df5aef519260521e2b17c5b40d) necessitated by the fact that the chainstate manager is no longer a global; the commit attaches a chainman reference to each owned chainstate instance. The alternative would be to change a whole bunch of function signatures and thread a ChainstateManager argument deep through call stacks. I think this approach makes more sense.\r\n\r\n<details><summary>Show range-diff</summary>\r\n\r\n```sh\r\n$ git range-diff master au.multi-chainstates.pt1.9 au.multi-chainstates.pt1.10\r\n\r\n-:  ---------- > 1:  acb5215743 validation: add chainman ref to CChainState\r\n1:  28f800ba60 ! 2:  0589bf841f validation: change UpdateTip for multiple chainstates\r\n    @@ -44,7 +44,7 @@\r\n     +\r\n     +    // The contents of this function are either not relevant if we're not\r\n     +    // given the active chainstate, so return otherwise.\r\n    -+    if (&chainstate != &::g_chainman.ActiveChainstate()) {\r\n    ++    if (&chainstate != &chainstate.m_chainman.ActiveChainstate()) {\r\n     +        // Only log every so often so that we don't bury log messages at the tip.\r\n     +        constexpr int BACKGROUND_LOG_INTERVAL = 2000;\r\n     +        if (pindexNew->nHeight % BACKGROUND_LOG_INTERVAL == 0) {\r\n    @@ -60,7 +60,6 @@\r\n          }\r\n\r\n          bilingual_str warning_messages;\r\n    --    assert(std::addressof(::ChainstateActive()) == std::addressof(active_chainstate));\r\n     -    if (!active_chainstate.IsInitialBlockDownload()) {\r\n     +    if (!chainstate.IsInitialBlockDownload()) {\r\n              const CBlockIndex* pindex = pindexNew;\r\n    @@ -70,7 +69,6 @@\r\n                  }\r\n              }\r\n          }\r\n    --    assert(std::addressof(::ChainstateActive()) == std::addressof(active_chainstate));\r\n     -    LogPrintf(\"%s: new best=%s height=%d version=0x%08x log2_work=%f tx=%lu date='%s' progress=%f cache=%.1fMiB(%utxo)%s\\n\", __func__,\r\n     -      pindexNew->GetBlockHash().ToString(), pindexNew->nHeight, pindexNew->nVersion,\r\n     -      log(pindexNew->nChainWork.getdouble())/log(2.0), (unsigned long)pindexNew->nChainTx,\r\n2:  ea5fe5a504 ! 3:  929de6413c validation: fix CheckBlockIndex for multiple chainstates\r\n    @@ -15,7 +15,7 @@\r\n\r\n          LOCK(cs_main);\r\n\r\n    -+    bool is_active_chain = this == &::g_chainman.ActiveChainstate();\r\n    ++    bool is_active_chain = this == &m_chainman.ActiveChainstate();\r\n     +\r\n          // During a reindex, we read the genesis block and call CheckBlockIndex before ActivateBestChain,\r\n          // so we have the genesis block in m_blockman.m_block_index but no active chain. (A few of the\r\n3:  f049daf72a = 4:  3a6899f468 move-only: unittest: add test/util/chainstate.h\r\n4:  87e872c5b2 ! 5:  b6ddc34706 test: refactor: separate CreateBlock in TestChain100Setup\r\n    @@ -21,7 +21,7 @@\r\n      {\r\n          const CChainParams& chainparams = Params();\r\n          CTxMemPool empty_pool;\r\n    --    CBlock block = BlockAssembler(::ChainstateActive(), empty_pool, chainparams).CreateNewBlock(scriptPubKey)->block;\r\n    +-    CBlock block = BlockAssembler(m_node.chainman->ActiveChainstate(), empty_pool, chainparams).CreateNewBlock(scriptPubKey)->block;\r\n     +    CBlock block = BlockAssembler(*chainstate, empty_pool, chainparams).CreateNewBlock(scriptPubKey)->block;\r\n\r\n          Assert(block.vtx.size() == 1);\r\n5:  fc73625bd3 < -:  ---------- refactor: remove assertions preventing multiple chainstates\r\n6:  adb0e5a67e = 6:  f14c68ac6d test: validation: add unittest for UpdateTip behavior\r\n```\r\n\r\n</details>",
      "created_at" : "2021-06-15T13:28:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#issuecomment-861498058",
      "id" : 861498058,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21526",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2MTQ5ODA1OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-15T13:28:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/861498058",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "\r\n[`au.multi-chainstates.pt1.11`](https://github.com/jamesob/bitcoin/tree/au.multi-chainstates.pt1.11) -> [`au.multi-chainstates.pt1.12`](https://github.com/jamesob/bitcoin/tree/au.multi-chainstates.pt1.12)\r\n\r\nThe functional test I recently added in the parent branch (https://github.com/bitcoin/bitcoin/pull/15606/commits/aa65b21d79d9cc0d79925879bc62e1c240a1cf59) has uncovered some cases I hadn't previously considered in `CheckBlockIndex()`, so I've pushed fixes for those, as well as some corequisite ChainstateManager methods for easily getting the snapshot height.\r\n\r\n<details><summary>Show range-diff</summary>\r\n\r\n```sh\r\n$ git range-diff master au.multi-chainstates.pt1.11 au.multi-chainstates.pt1.12\r\n\r\n1:  e5e1d49cc = 1:  e5e1d49cc validation: add chainman ref to CChainState\r\n2:  4a836f708 = 2:  4cf9de9d7 validation: change UpdateTip for multiple chainstates\r\n3:  7377caacd ! 3:  7ff4c234e validation: fix CheckBlockIndex for multiple chainstates\r\n    @@ -16,6 +16,7 @@\r\n          LOCK(cs_main);\r\n\r\n     +    bool is_active_chain = this == &m_chainman.ActiveChainstate();\r\n    ++    int snapshot_height = m_chainman.GetSnapshotHeight().value_or(-1);\r\n     +\r\n          // During a reindex, we read the genesis block and call CheckBlockIndex before ActivateBestChain,\r\n          // so we have the genesis block in m_blockman.m_block_index but no active chain. (A few of the\r\n    @@ -28,6 +29,29 @@\r\n          for (const std::pair<const uint256, CBlockIndex*>& entry : m_blockman.m_block_index) {\r\n              forward.insert(std::make_pair(entry.second->pprev, entry.second));\r\n          }\r\n    +@@\r\n    +     while (pindex != nullptr) {\r\n    +         nNodes++;\r\n    +         if (pindexFirstInvalid == nullptr && pindex->nStatus & BLOCK_FAILED_VALID) pindexFirstInvalid = pindex;\r\n    +-        if (pindexFirstMissing == nullptr && !(pindex->nStatus & BLOCK_HAVE_DATA)) pindexFirstMissing = pindex;\r\n    +-        if (pindexFirstNeverProcessed == nullptr && pindex->nTx == 0) pindexFirstNeverProcessed = pindex;\r\n    ++        // Don't start being rigorous about missing block data if we're within a utxo snapshot\r\n    ++        if (pindex->nHeight > snapshot_height) {\r\n    ++            if (pindexFirstMissing == nullptr && !(pindex->nStatus & BLOCK_HAVE_DATA)) pindexFirstMissing = pindex;\r\n    ++            if (pindexFirstNeverProcessed == nullptr && pindex->nTx == 0) pindexFirstNeverProcessed = pindex;\r\n    ++        }\r\n    +         if (pindex->pprev != nullptr && pindexFirstNotTreeValid == nullptr && (pindex->nStatus & BLOCK_VALID_MASK) < BLOCK_VALID_TREE) pindexFirstNotTreeValid = pindex;\r\n    +         if (pindex->pprev != nullptr && pindexFirstNotTransactionsValid == nullptr && (pindex->nStatus & BLOCK_VALID_MASK) < BLOCK_VALID_TRANSACTIONS) pindexFirstNotTransactionsValid = pindex;\r\n    +         if (pindex->pprev != nullptr && pindexFirstNotChainValid == nullptr && (pindex->nStatus & BLOCK_VALID_MASK) < BLOCK_VALID_CHAIN) pindexFirstNotChainValid = pindex;\r\n    +@@\r\n    +         if (!pindex->HaveTxsDownloaded()) assert(pindex->nSequenceId <= 0); // nSequenceId can't be set positive for blocks that aren't linked (negative is used for preciousblock)\r\n    +         // VALID_TRANSACTIONS is equivalent to nTx > 0 for all nodes (whether or not pruning has occurred).\r\n    +         // HAVE_DATA is only equivalent to nTx > 0 (or VALID_TRANSACTIONS) if no pruning has occurred.\r\n    +-        if (!fHavePruned) {\r\n    ++        if (!fHavePruned && (pindex->nHeight > snapshot_height)) {\r\n    +             // If we've never pruned, then HAVE_DATA should be equivalent to nTx > 0\r\n    +             assert(!(pindex->nStatus & BLOCK_HAVE_DATA) == (pindex->nTx == 0));\r\n    +             assert(pindexFirstMissing == pindexFirstNeverProcessed);\r\n     @@\r\n                      // is valid and we have all data for its parents, it must be in\r\n                      // setBlockIndexCandidates.  m_chain.Tip() must also be there\r\n    @@ -53,3 +77,52 @@\r\n              }\r\n              // Check whether this block is in m_blocks_unlinked.\r\n              std::pair<std::multimap<CBlockIndex*,CBlockIndex*>::iterator,std::multimap<CBlockIndex*,CBlockIndex*>::iterator> rangeUnlinked = m_blockman.m_blocks_unlinked.equal_range(pindex->pprev);\r\n    +@@\r\n    +         // Fake nChainTx so that GuessVerificationProgress reports accurately\r\n    +         index->nChainTx = index->pprev ? index->pprev->nChainTx + index->nTx : 1;\r\n    +\r\n    ++        // Since this block is assumed-valid, set nStatus accordingly.\r\n    ++        index->nStatus |= BLOCK_VALID_MASK;\r\n    ++\r\n    +         // Fake BLOCK_OPT_WITNESS so that CChainState::NeedsRedownload()\r\n    +         // won't ask to rewind the entire assumed-valid chain on startup.\r\n    +         if (index->pprev && ::IsWitnessEnabled(index->pprev, ::Params().GetConsensus())) {\r\n    +@@\r\n    +         }\r\n    +     }\r\n    + }\r\n    ++\r\n    ++std::optional<CBlockIndex*> ChainstateManager::GetSnapshotBaseBlock()\r\n    ++{\r\n    ++    auto blockhash_op = SnapshotBlockhash();\r\n    ++    if (!blockhash_op) {\r\n    ++        return std::nullopt;\r\n    ++    }\r\n    ++    return m_blockman.LookupBlockIndex(*blockhash_op);\r\n    ++}\r\n    ++\r\n    ++std::optional<int> ChainstateManager::GetSnapshotHeight()\r\n    ++{\r\n    ++    std::optional<CBlockIndex*> base = this->GetSnapshotBaseBlock();\r\n    ++    if (!base) {\r\n    ++        return std::nullopt;\r\n    ++    }\r\n    ++    return (*base)->nHeight;\r\n    ++}\r\n    +\r\n    + diff --git a/src/validation.h b/src/validation.h\r\n    + --- a/src/validation.h\r\n    + +++ b/src/validation.h\r\n    +@@\r\n    +     //! ResizeCoinsCaches() as needed.\r\n    +     void MaybeRebalanceCaches() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\r\n    +\r\n    ++    //! @returns height at which the active UTXO snapshot was taken, if applicable.\r\n    ++    std::optional<CBlockIndex*> GetSnapshotBaseBlock() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\r\n    ++\r\n    ++    //! @returns height at which the active UTXO snapshot was taken, if a snapshot is being used.\r\n    ++    std::optional<int> GetSnapshotHeight() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\r\n    ++\r\n    +     ~ChainstateManager() {\r\n    +         LOCK(::cs_main);\r\n    +         UnloadBlockIndex(/* mempool */ nullptr, *this);\r\n4:  d3e949fb8 ! 4:  c9d332d03 move-only: unittest: add test/util/chainstate.h\r\n    @@ -33,6 +33,7 @@\r\n     +#include <fs.h>\r\n     +#include <node/context.h>\r\n     +#include <node/utxo_snapshot.h>\r\n    ++#include <rpc/blockchain.h>\r\n     +#include <validation.h>\r\n     +\r\n     +#include <univalue.h>\r\n5:  b75e71c7c = 5:  d20161e9c test: refactor: separate CreateBlock in TestChain100Setup\r\n6:  ede45e203 = 6:  881150900 test: validation: add unittest for UpdateTip behavior\r\n```\r\n\r\n</details>\r\n\r\n",
      "created_at" : "2021-06-17T21:34:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#issuecomment-863579751",
      "id" : 863579751,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21526",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2MzU3OTc1MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-17T21:34:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/863579751",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "[`au.multi-chainstates.pt1.12`](https://github.com/jamesob/bitcoin/tree/au.multi-chainstates.pt1.12) -> [`au.multi-chainstates.pt1.13`](https://github.com/jamesob/bitcoin/tree/au.multi-chainstates.pt1.13)\r\n\r\nArgh sorry for the churn; botched rebase pushed some old code that caused segfault in unittests. Fixed.\r\n\r\n<details><summary>Show range-diff</summary>\r\n\r\n```sh\r\n$ git range-diff master au.multi-chainstates.pt1.12 au.multi-chainstates.pt1.13\r\n\r\n1:  e5e1d49cc = 1:  e5e1d49cc validation: add chainman ref to CChainState\r\n2:  4cf9de9d7 = 2:  4cf9de9d7 validation: change UpdateTip for multiple chainstates\r\n3:  7ff4c234e ! 3:  cf7afe34c validation: fix CheckBlockIndex for multiple chainstates\r\n    @@ -96,9 +96,13 @@\r\n     +{\r\n     +    auto blockhash_op = SnapshotBlockhash();\r\n     +    if (!blockhash_op) {\r\n    -+        return std::nullopt;\r\n    ++  return std::nullopt;\r\n    ++    }\r\n    ++    CBlockIndex* pindex = m_blockman.LookupBlockIndex(*blockhash_op);\r\n    ++    if (pindex == nullptr) {\r\n    ++  return std::nullopt;\r\n     +    }\r\n    -+    return m_blockman.LookupBlockIndex(*blockhash_op);\r\n    ++    return pindex;\r\n     +}\r\n     +\r\n     +std::optional<int> ChainstateManager::GetSnapshotHeight()\r\n4:  c9d332d03 = 4:  c1c1f95a0 move-only: unittest: add test/util/chainstate.h\r\n5:  d20161e9c = 5:  1c4d35b06 test: refactor: separate CreateBlock in TestChain100Setup\r\n6:  881150900 = 6:  5a3ed1ae0 test: validation: add unittest for UpdateTip behavior\r\n```\r\n\r\n</details>\r\n",
      "created_at" : "2021-06-18T19:05:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#issuecomment-864224100",
      "id" : 864224100,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21526",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2NDIyNDEwMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-18T19:05:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/864224100",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "```\r\nThis diff appears to have added new lines with tab characters instead of spaces.\r\nThe following changes were suspected:\r\n\r\ndiff --git a/src/validation.cpp b/src/validation.cpp\r\n@@ -5083,0 +5136,22 @@ void ChainstateManager::MaybeRebalanceCaches()\r\n+\treturn std::nullopt;\r\n+\treturn std::nullopt;\r\n^---- failure generated from test/lint/lint-whitespace.sh",
      "created_at" : "2021-06-21T09:28:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#issuecomment-864883356",
      "id" : 864883356,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21526",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2NDg4MzM1Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-21T09:28:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/864883356",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "[`au.multi-chainstates.pt1.13`](https://github.com/jamesob/bitcoin/tree/au.multi-chainstates.pt1.13) -> [`au.multi-chainstates.pt1.14`](https://github.com/jamesob/bitcoin/tree/au.multi-chainstates.pt1.14)\r\n\r\nPushed whitespace fix; sorry for the holdup.\r\n\r\n<details><summary>Show range-diff</summary>\r\n\r\n```sh\r\n$ git range-diff master au.multi-chainstates.pt1.13 au.multi-chainstates.pt1.14\r\n\r\n1:  e5e1d49cc = 1:  e5e1d49cc validation: add chainman ref to CChainState\r\n2:  4cf9de9d7 = 2:  4cf9de9d7 validation: change UpdateTip for multiple chainstates\r\n3:  cf7afe34c ! 3:  0dd5757fd validation: fix CheckBlockIndex for multiple chainstates\r\n    @@ -96,11 +96,11 @@\r\n     +{\r\n     +    auto blockhash_op = SnapshotBlockhash();\r\n     +    if (!blockhash_op) {\r\n    -+  return std::nullopt;\r\n    ++        return std::nullopt;\r\n     +    }\r\n     +    CBlockIndex* pindex = m_blockman.LookupBlockIndex(*blockhash_op);\r\n     +    if (pindex == nullptr) {\r\n    -+  return std::nullopt;\r\n    ++        return std::nullopt;\r\n     +    }\r\n     +    return pindex;\r\n     +}\r\n4:  c1c1f95a0 = 4:  c7b47bf9c move-only: unittest: add test/util/chainstate.h\r\n5:  1c4d35b06 = 5:  e06183769 test: refactor: separate CreateBlock in TestChain100Setup\r\n6:  5a3ed1ae0 = 6:  b6dffada1 test: validation: add unittest for UpdateTip behavior\r\n```\r\n\r\n</details>\r\n\r\n",
      "created_at" : "2021-06-21T13:43:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#issuecomment-865043913",
      "id" : 865043913,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21526",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2NTA0MzkxMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-21T13:43:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/865043913",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r655399169"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/655399169"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: fix CheckBlockIndex for multiple chainstates\" (0dd5757fd7c5b1d151abe45843711780a4b3885b)\r\n\r\nCommit message could be updated. It's still only referring to setBlockIndexCandidates checks, but commit was later extended to skip more checks https://github.com/bitcoin/bitcoin/pull/21526#issuecomment-863579751",
      "commit_id" : "b6dffada18bf874c619d17baf9df45346e52b871",
      "created_at" : "2021-06-21T13:55:55Z",
      "diff_hunk" : "@@ -4375,8 +4379,11 @@ void CChainState::CheckBlockIndex(const Consensus::Params& consensusParams)\n     while (pindex != nullptr) {\n         nNodes++;\n         if (pindexFirstInvalid == nullptr && pindex->nStatus & BLOCK_FAILED_VALID) pindexFirstInvalid = pindex;\n-        if (pindexFirstMissing == nullptr && !(pindex->nStatus & BLOCK_HAVE_DATA)) pindexFirstMissing = pindex;\n-        if (pindexFirstNeverProcessed == nullptr && pindex->nTx == 0) pindexFirstNeverProcessed = pindex;\n+        // Don't start being rigorous about missing block data if we're within a utxo snapshot",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r655399169",
      "id" : 655399169,
      "line" : 4382,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NTM5OTE2OQ==",
      "original_commit_id" : "0dd5757fd7c5b1d151abe45843711780a4b3885b",
      "original_line" : 4382,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 110,
      "pull_request_review_id" : 688453572,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-21T15:47:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/655399169",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r655484970"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/655484970"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: fix CheckBlockIndex for multiple chainstates\" (0dd5757fd7c5b1d151abe45843711780a4b3885b)\r\n\r\nNot very important since this function is only called one place, but it seems like it would be nicer to just return `CBlockIndex*` instead of `std::optional<CBlockIndex*>`. This way callers don't need to double-dereference, and can just check whether this is null or not null, instead having to check for three states (`nullopt`, `nullptr`, or block), or having to ignore the `nullptr` case (which I assume is not currently possible)",
      "commit_id" : "b6dffada18bf874c619d17baf9df45346e52b871",
      "created_at" : "2021-06-21T15:28:13Z",
      "diff_hunk" : "@@ -1024,6 +1024,12 @@ class ChainstateManager\n     //! ResizeCoinsCaches() as needed.\n     void MaybeRebalanceCaches() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! @returns height at which the active UTXO snapshot was taken, if applicable.\n+    std::optional<CBlockIndex*> GetSnapshotBaseBlock() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r655484970",
      "id" : 655484970,
      "line" : 1028,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NTQ4NDk3MA==",
      "original_commit_id" : "0dd5757fd7c5b1d151abe45843711780a4b3885b",
      "original_line" : 1028,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 31,
      "pull_request_review_id" : 688453572,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-21T15:47:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/655484970",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r655490762"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/655490762"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"test: refactor: separate CreateBlock in TestChain100Setup\" (e061837697ed8ebf8d5443478829b48f3fe0e8db)\r\n\r\n> Would be nice to make the last argument a `CChainState&` reference instead of a pointer since it isn't allowed to be null (and it's a new method so there's no backward compatility concern)\r\n\r\n(This is still applicable, in case the PR gets another update)",
      "commit_id" : "b6dffada18bf874c619d17baf9df45346e52b871",
      "created_at" : "2021-06-21T15:35:01Z",
      "diff_hunk" : "@@ -234,21 +234,38 @@ void TestChain100Setup::mineBlocks(int num_blocks)\n     }\n }\n \n-CBlock TestChain100Setup::CreateAndProcessBlock(const std::vector<CMutableTransaction>& txns, const CScript& scriptPubKey)\n+CBlock TestChain100Setup::CreateBlock(\n+    const std::vector<CMutableTransaction>& txns,\n+    const CScript& scriptPubKey,\n+    CChainState* chainstate)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r655490762",
      "id" : 655490762,
      "in_reply_to_id" : 625442975,
      "line" : 243,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NTQ5MDc2Mg==",
      "original_commit_id" : "6d5d09634ac354c16c298c83d7b699b2147a98b3",
      "original_line" : 243,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 8,
      "pull_request_review_id" : 688453572,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-21T15:47:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/655490762",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r658163708"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/658163708"
         }
      },
      "author_association" : "MEMBER",
      "body" : "IIUC this log warns node operator about new consensus rules activated through the BIP9 logic. In case of the assumed-utxo-set being dated after either the locked-in or activation, your foreground validation is going to be blinded and your background validation is going to skim over this warning ? Thus you might have a client not fully-validating the chain, or at least with a set of consensus rules you might be interested with.\r\n\r\nI don't think this is impossible in case of contentious softfork locked-in, for e.g a minor release with activation logic feature-gated by a node operator setting followed by a major release with a newer hardcoded assumed-utxo ?",
      "commit_id" : "b6dffada18bf874c619d17baf9df45346e52b871",
      "created_at" : "2021-06-24T17:53:25Z",
      "diff_hunk" : "@@ -2245,7 +2284,7 @@ static void UpdateTip(CTxMemPool& mempool, const CBlockIndex* pindexNew, const C\n     }\n \n     bilingual_str warning_messages;\n-    if (!active_chainstate.IsInitialBlockDownload()) {\n+    if (!chainstate.IsInitialBlockDownload()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r658163708",
      "id" : 658163708,
      "line" : 2287,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODE2MzcwOA==",
      "original_commit_id" : "b6dffada18bf874c619d17baf9df45346e52b871",
      "original_line" : 2287,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 68,
      "pull_request_review_id" : 692059584,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-24T18:17:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/658163708",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r658173137"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/658173137"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Once the background validation has catched up with the snapshot_height, is `GetSnapshotHeight` going to return `std::nullopt` and those checks play out ?",
      "commit_id" : "b6dffada18bf874c619d17baf9df45346e52b871",
      "created_at" : "2021-06-24T18:06:45Z",
      "diff_hunk" : "@@ -4341,8 +4379,11 @@ void CChainState::CheckBlockIndex(const Consensus::Params& consensusParams)\n     while (pindex != nullptr) {\n         nNodes++;\n         if (pindexFirstInvalid == nullptr && pindex->nStatus & BLOCK_FAILED_VALID) pindexFirstInvalid = pindex;\n-        if (pindexFirstMissing == nullptr && !(pindex->nStatus & BLOCK_HAVE_DATA)) pindexFirstMissing = pindex;\n-        if (pindexFirstNeverProcessed == nullptr && pindex->nTx == 0) pindexFirstNeverProcessed = pindex;\n+        // Don't start being rigorous about missing block data if we're within a utxo snapshot\n+        if (pindex->nHeight > snapshot_height) {\n+            if (pindexFirstMissing == nullptr && !(pindex->nStatus & BLOCK_HAVE_DATA)) pindexFirstMissing = pindex;\n+            if (pindexFirstNeverProcessed == nullptr && pindex->nTx == 0) pindexFirstNeverProcessed = pindex;\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r658173137",
      "id" : 658173137,
      "line" : 4386,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODE3MzEzNw==",
      "original_commit_id" : "b6dffada18bf874c619d17baf9df45346e52b871",
      "original_line" : 4386,
      "original_position" : 114,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 114,
      "pull_request_review_id" : 692059584,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-24T18:17:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/658173137",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r658175063"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/658175063"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: \"// Don't start being rigorous about missing block data if we've never pruned and we're within a utxo snapshot\" ?",
      "commit_id" : "b6dffada18bf874c619d17baf9df45346e52b871",
      "created_at" : "2021-06-24T18:09:41Z",
      "diff_hunk" : "@@ -4357,7 +4398,7 @@ void CChainState::CheckBlockIndex(const Consensus::Params& consensusParams)\n         if (!pindex->HaveTxsDownloaded()) assert(pindex->nSequenceId <= 0); // nSequenceId can't be set positive for blocks that aren't linked (negative is used for preciousblock)\n         // VALID_TRANSACTIONS is equivalent to nTx > 0 for all nodes (whether or not pruning has occurred).\n         // HAVE_DATA is only equivalent to nTx > 0 (or VALID_TRANSACTIONS) if no pruning has occurred.\n-        if (!fHavePruned) {\n+        if (!fHavePruned && (pindex->nHeight > snapshot_height)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r658175063",
      "id" : 658175063,
      "line" : 4401,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODE3NTA2Mw==",
      "original_commit_id" : "b6dffada18bf874c619d17baf9df45346e52b871",
      "original_line" : 4401,
      "original_position" : 123,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 123,
      "pull_request_review_id" : 692059584,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-24T18:17:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/658175063",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r658175967"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/658175967"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: s/height/block metadata/g ?",
      "commit_id" : "b6dffada18bf874c619d17baf9df45346e52b871",
      "created_at" : "2021-06-24T18:11:03Z",
      "diff_hunk" : "@@ -1014,6 +1024,12 @@ class ChainstateManager\n     //! ResizeCoinsCaches() as needed.\n     void MaybeRebalanceCaches() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! @returns height at which the active UTXO snapshot was taken, if applicable.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r658175967",
      "id" : 658175967,
      "line" : 1027,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODE3NTk2Nw==",
      "original_commit_id" : "b6dffada18bf874c619d17baf9df45346e52b871",
      "original_line" : 1027,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 30,
      "pull_request_review_id" : 692059584,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-24T18:17:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/658175967",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r658198383"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/658198383"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/21526#discussion_r658163708\r\n\r\n> IIUC this log warns node operator about new consensus rules activated through the BIP9 logic. In case of the assumed-utxo-set being dated after either the locked-in or activation, your foreground validation is going to be blinded and your background validation is going to skim over this warning ?\r\n\r\nI don't think this is a change because the warning is skipped anyway in IBD. So loading a snapshot doesn't skip this warning because it would be skipped anyway. Loading a snapshot just makes the node more usable while blocks are still being downloaded.",
      "commit_id" : "b6dffada18bf874c619d17baf9df45346e52b871",
      "created_at" : "2021-06-24T18:45:41Z",
      "diff_hunk" : "@@ -2245,7 +2284,7 @@ static void UpdateTip(CTxMemPool& mempool, const CBlockIndex* pindexNew, const C\n     }\n \n     bilingual_str warning_messages;\n-    if (!active_chainstate.IsInitialBlockDownload()) {\n+    if (!chainstate.IsInitialBlockDownload()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r658198383",
      "id" : 658198383,
      "in_reply_to_id" : 658163708,
      "line" : 2287,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODE5ODM4Mw==",
      "original_commit_id" : "b6dffada18bf874c619d17baf9df45346e52b871",
      "original_line" : 2287,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 68,
      "pull_request_review_id" : 692109753,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-24T18:45:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/658198383",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r662628271"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662628271"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I agree it's not a change, my point is more about how assume-utxo is breaking the notion of a sequential IBD and introducing out-of-order validation which might invite us to reconsider the design purpose of such warning.\r\n\r\n`IsInitialBlockDownload`'s last check relies on our chain tip being older than DEFAULT_MAX_TIP_AGE (24h) and i think that's a reasonable assumption than hardcoded assumed-utxo will be always older than 24h. So background chainstate is always going to be considered as IBD, and such warning skipped, without giving a _chance_ to flag out during foreground chainstate processing if it did start after the locked-in period, and let user react in consequence. For e.g, stop a Bitcoin merchant stopping trade, or increasing number of required confs during softforks activation, if it's a contentious one.\r\n\r\nThough I concede, it's tangential to this PR and belong more to a wider discussion on how assume-utxo is interacting with softfork deployments.",
      "commit_id" : "b6dffada18bf874c619d17baf9df45346e52b871",
      "created_at" : "2021-07-01T22:31:59Z",
      "diff_hunk" : "@@ -2245,7 +2284,7 @@ static void UpdateTip(CTxMemPool& mempool, const CBlockIndex* pindexNew, const C\n     }\n \n     bilingual_str warning_messages;\n-    if (!active_chainstate.IsInitialBlockDownload()) {\n+    if (!chainstate.IsInitialBlockDownload()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r662628271",
      "id" : 662628271,
      "in_reply_to_id" : 658163708,
      "line" : 2287,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MjYyODI3MQ==",
      "original_commit_id" : "b6dffada18bf874c619d17baf9df45346e52b871",
      "original_line" : 2287,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 68,
      "pull_request_review_id" : 697700181,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-01T22:57:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662628271",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Code Review ACK b6dffad\r\n\r\nStill feel free to take my minor comments if you retouch the branch :)",
      "created_at" : "2021-07-01T22:56:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#issuecomment-872597591",
      "id" : 872597591,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21526",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3MjU5NzU5MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-01T22:56:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/872597591",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-07-15T11:51:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#issuecomment-880631236",
      "id" : 880631236,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21526",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg4MDYzMTIzNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-15T11:51:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/880631236",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r671481714"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/671481714"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed, thanks!",
      "commit_id" : "1ffc89e1192089aca8cdb0de80305d24f943ebfe",
      "created_at" : "2021-07-16T19:30:54Z",
      "diff_hunk" : "@@ -1014,6 +1024,12 @@ class ChainstateManager\n     //! ResizeCoinsCaches() as needed.\n     void MaybeRebalanceCaches() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! @returns height at which the active UTXO snapshot was taken, if applicable.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r671481714",
      "id" : 671481714,
      "in_reply_to_id" : 658175967,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3MTQ4MTcxNA==",
      "original_commit_id" : "b6dffada18bf874c619d17baf9df45346e52b871",
      "original_line" : 1027,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 708692580,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-16T19:30:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/671481714",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r671490286"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/671490286"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'll make a note to ensure that `CompleteSnapshotValidation()` (in #15606) nulls out `m_snapshot_blockhash` so that what you're saying here is actually what happens. Otherwise we would just run the full suite of checks after restart when (what was previously) the snapshot chainstate gets loaded in as a \"regular\" IBD'd chainstate.",
      "commit_id" : "1ffc89e1192089aca8cdb0de80305d24f943ebfe",
      "created_at" : "2021-07-16T19:49:25Z",
      "diff_hunk" : "@@ -4341,8 +4379,11 @@ void CChainState::CheckBlockIndex(const Consensus::Params& consensusParams)\n     while (pindex != nullptr) {\n         nNodes++;\n         if (pindexFirstInvalid == nullptr && pindex->nStatus & BLOCK_FAILED_VALID) pindexFirstInvalid = pindex;\n-        if (pindexFirstMissing == nullptr && !(pindex->nStatus & BLOCK_HAVE_DATA)) pindexFirstMissing = pindex;\n-        if (pindexFirstNeverProcessed == nullptr && pindex->nTx == 0) pindexFirstNeverProcessed = pindex;\n+        // Don't start being rigorous about missing block data if we're within a utxo snapshot\n+        if (pindex->nHeight > snapshot_height) {\n+            if (pindexFirstMissing == nullptr && !(pindex->nStatus & BLOCK_HAVE_DATA)) pindexFirstMissing = pindex;\n+            if (pindexFirstNeverProcessed == nullptr && pindex->nTx == 0) pindexFirstNeverProcessed = pindex;\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r671490286",
      "id" : 671490286,
      "in_reply_to_id" : 658173137,
      "line" : 4356,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3MTQ5MDI4Ng==",
      "original_commit_id" : "b6dffada18bf874c619d17baf9df45346e52b871",
      "original_line" : 4356,
      "original_position" : 114,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 93,
      "pull_request_review_id" : 708703732,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-16T19:49:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/671490286",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r671500822"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/671500822"
         }
      },
      "author_association" : "MEMBER",
      "body" : "94e67d6 This comment seems unclear to me; remove \"either\" and s/otherwise/in that case/? (not sure)\r\n```suggestion\r\n    // The contents of this function are not relevant if we're not\r\n```",
      "commit_id" : "1ffc89e1192089aca8cdb0de80305d24f943ebfe",
      "created_at" : "2021-07-16T20:12:03Z",
      "diff_hunk" : "@@ -2205,6 +2210,33 @@ static void AppendWarning(bilingual_str& res, const bilingual_str& warn)\n \n void CChainState::UpdateTip(const CBlockIndex* pindexNew)\n {\n+    auto& func_name = __func__;\n+    auto log_progress = [this, pindexNew](\n+            const std::string& prefix,\n+            const std::string& warning_messages) EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n+    {\n+        LogPrintf(\"%s%s: new best=%s height=%d version=0x%08x log2_work=%f tx=%lu date='%s' progress=%f cache=%.1fMiB(%utxo)%s\\n\",\n+            prefix, func_name,\n+            pindexNew->GetBlockHash().ToString(), pindexNew->nHeight, pindexNew->nVersion,\n+            log(pindexNew->nChainWork.getdouble())/log(2.0), (unsigned long)pindexNew->nChainTx,\n+            FormatISO8601DateTime(pindexNew->GetBlockTime()),\n+            GuessVerificationProgress(m_params.TxData(), pindexNew),\n+            this->CoinsTip().DynamicMemoryUsage() * (1.0 / (1<<20)),\n+            this->CoinsTip().GetCacheSize(),\n+            !warning_messages.empty() ? strprintf(\" warning='%s'\", warning_messages) : \"\");\n+    };\n+\n+    // The contents of this function are either not relevant if we're not",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r671500822",
      "id" : 671500822,
      "line" : 2229,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3MTUwMDgyMg==",
      "original_commit_id" : "1ffc89e1192089aca8cdb0de80305d24f943ebfe",
      "original_line" : 2229,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 37,
      "pull_request_review_id" : 708717465,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-16T20:36:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/671500822",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r671503219"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/671503219"
         }
      },
      "author_association" : "MEMBER",
      "body" : "86e996aaef89 can be const, which seems good/useful in a function as long as `CChainState::CheckBlockIndex()`\r\n```diff\r\n-    bool is_active_chain = this == &m_chainman.ActiveChainstate();\r\n-    int snapshot_height = m_chainman.GetSnapshotHeight().value_or(-1);\r\n+    const bool is_active_chain{this == &m_chainman.ActiveChainstate()};\r\n+    const int snapshot_height{m_chainman.GetSnapshotHeight().value_or(-1)};\r\n```\r\n",
      "commit_id" : "1ffc89e1192089aca8cdb0de80305d24f943ebfe",
      "created_at" : "2021-07-16T20:17:12Z",
      "diff_hunk" : "@@ -4282,6 +4309,9 @@ void CChainState::CheckBlockIndex()\n \n     LOCK(cs_main);\n \n+    bool is_active_chain = this == &m_chainman.ActiveChainstate();\n+    int snapshot_height = m_chainman.GetSnapshotHeight().value_or(-1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r671503219",
      "id" : 671503219,
      "line" : 4313,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3MTUwMzIxOQ==",
      "original_commit_id" : "1ffc89e1192089aca8cdb0de80305d24f943ebfe",
      "original_line" : 4313,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 70,
      "pull_request_review_id" : 708717465,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-16T20:36:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/671503219",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r671509172"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/671509172"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ef47823cbec0a9600\r\n```suggestion\r\n    const CBlock block = this->CreateBlock(txns, scriptPubKey, chainstate);\r\n```",
      "commit_id" : "1ffc89e1192089aca8cdb0de80305d24f943ebfe",
      "created_at" : "2021-07-16T20:30:07Z",
      "diff_hunk" : "@@ -251,6 +254,20 @@ CBlock TestChain100Setup::CreateAndProcessBlock(const std::vector<CMutableTransa\n \n     while (!CheckProofOfWork(block.GetHash(), block.nBits, chainparams.GetConsensus())) ++block.nNonce;\n \n+    return block;\n+}\n+\n+CBlock TestChain100Setup::CreateAndProcessBlock(\n+    const std::vector<CMutableTransaction>& txns,\n+    const CScript& scriptPubKey,\n+    CChainState* chainstate)\n+{\n+    if (!chainstate) {\n+        chainstate = &Assert(m_node.chainman)->ActiveChainstate();\n+    }\n+\n+    const CChainParams& chainparams = Params();\n+    CBlock block = this->CreateBlock(txns, scriptPubKey, chainstate);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r671509172",
      "id" : 671509172,
      "line" : 270,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3MTUwOTE3Mg==",
      "original_commit_id" : "1ffc89e1192089aca8cdb0de80305d24f943ebfe",
      "original_line" : 270,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/test/util/setup_common.cpp",
      "position" : 34,
      "pull_request_review_id" : 708717465,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-16T20:36:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/671509172",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r671704184"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/671704184"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done, thanks.",
      "commit_id" : "1901a9819d507425f9a2ea440d78892acbbb0e7f",
      "created_at" : "2021-07-17T14:31:24Z",
      "diff_hunk" : "@@ -2205,6 +2210,33 @@ static void AppendWarning(bilingual_str& res, const bilingual_str& warn)\n \n void CChainState::UpdateTip(const CBlockIndex* pindexNew)\n {\n+    auto& func_name = __func__;\n+    auto log_progress = [this, pindexNew](\n+            const std::string& prefix,\n+            const std::string& warning_messages) EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n+    {\n+        LogPrintf(\"%s%s: new best=%s height=%d version=0x%08x log2_work=%f tx=%lu date='%s' progress=%f cache=%.1fMiB(%utxo)%s\\n\",\n+            prefix, func_name,\n+            pindexNew->GetBlockHash().ToString(), pindexNew->nHeight, pindexNew->nVersion,\n+            log(pindexNew->nChainWork.getdouble())/log(2.0), (unsigned long)pindexNew->nChainTx,\n+            FormatISO8601DateTime(pindexNew->GetBlockTime()),\n+            GuessVerificationProgress(m_params.TxData(), pindexNew),\n+            this->CoinsTip().DynamicMemoryUsage() * (1.0 / (1<<20)),\n+            this->CoinsTip().GetCacheSize(),\n+            !warning_messages.empty() ? strprintf(\" warning='%s'\", warning_messages) : \"\");\n+    };\n+\n+    // The contents of this function are either not relevant if we're not",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r671704184",
      "id" : 671704184,
      "in_reply_to_id" : 671500822,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3MTcwNDE4NA==",
      "original_commit_id" : "1ffc89e1192089aca8cdb0de80305d24f943ebfe",
      "original_line" : 2229,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 708946226,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-17T14:31:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/671704184",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r671704203"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/671704203"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done, thanks.",
      "commit_id" : "1901a9819d507425f9a2ea440d78892acbbb0e7f",
      "created_at" : "2021-07-17T14:31:36Z",
      "diff_hunk" : "@@ -4282,6 +4309,9 @@ void CChainState::CheckBlockIndex()\n \n     LOCK(cs_main);\n \n+    bool is_active_chain = this == &m_chainman.ActiveChainstate();\n+    int snapshot_height = m_chainman.GetSnapshotHeight().value_or(-1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r671704203",
      "id" : 671704203,
      "in_reply_to_id" : 671503219,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3MTcwNDIwMw==",
      "original_commit_id" : "1ffc89e1192089aca8cdb0de80305d24f943ebfe",
      "original_line" : 4313,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 708946242,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-17T14:31:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/671704203",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r671704229"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/671704229"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "1901a9819d507425f9a2ea440d78892acbbb0e7f",
      "created_at" : "2021-07-17T14:31:46Z",
      "diff_hunk" : "@@ -251,6 +254,20 @@ CBlock TestChain100Setup::CreateAndProcessBlock(const std::vector<CMutableTransa\n \n     while (!CheckProofOfWork(block.GetHash(), block.nBits, chainparams.GetConsensus())) ++block.nNonce;\n \n+    return block;\n+}\n+\n+CBlock TestChain100Setup::CreateAndProcessBlock(\n+    const std::vector<CMutableTransaction>& txns,\n+    const CScript& scriptPubKey,\n+    CChainState* chainstate)\n+{\n+    if (!chainstate) {\n+        chainstate = &Assert(m_node.chainman)->ActiveChainstate();\n+    }\n+\n+    const CChainParams& chainparams = Params();\n+    CBlock block = this->CreateBlock(txns, scriptPubKey, chainstate);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r671704229",
      "id" : 671704229,
      "in_reply_to_id" : 671509172,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3MTcwNDIyOQ==",
      "original_commit_id" : "1ffc89e1192089aca8cdb0de80305d24f943ebfe",
      "original_line" : 270,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/test/util/setup_common.cpp",
      "position" : null,
      "pull_request_review_id" : 708946254,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-17T14:31:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/671704229",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "[`au.multi-chainstates.pt1.14`](https://github.com/jamesob/bitcoin/tree/au.multi-chainstates.pt1.14) -> [`au.multi-chainstates.pt1.16`](https://github.com/jamesob/bitcoin/tree/au.multi-chainstates.pt1.16)\r\n\r\nAfter looking into @ryanofsky's feedback on #15606, I found that there were some parts of the ChainstateManager interface that were ultimately unused (and probably confusing), so I've removed them here in https://github.com/bitcoin/bitcoin/pull/21526/commits/ac4051d891e2d5c8ac130da16b85b9d880b44720. All other changes are either rebasing onto #22415 or responding to feedback.\r\n\r\nTo check the range-diff, run:\r\n```sh\r\ngit remote add jamesob https://github.com/jamesob/bitcoin.git\r\ngit fetch jamesob\r\ngit range-diff master au.multi-chainstates.pt1.14 au.multi-chainstates.pt1.16\r\n```",
      "created_at" : "2021-07-17T14:37:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#issuecomment-881908599",
      "id" : 881908599,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21526",
      "node_id" : "IC_kwDOABII5840kNt3",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-17T14:37:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/881908599",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r671734817"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/671734817"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "is this necessary? Can we declare NoMalleation the old fashioned way?",
      "commit_id" : "1901a9819d507425f9a2ea440d78892acbbb0e7f",
      "created_at" : "2021-07-17T19:29:47Z",
      "diff_hunk" : "@@ -0,0 +1,54 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#ifndef BITCOIN_TEST_UTIL_CHAINSTATE_H\n+#define BITCOIN_TEST_UTIL_CHAINSTATE_H\n+\n+#include <clientversion.h>\n+#include <fs.h>\n+#include <node/context.h>\n+#include <node/utxo_snapshot.h>\n+#include <rpc/blockchain.h>\n+#include <validation.h>\n+\n+#include <univalue.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+auto NoMalleation = [](CAutoFile& file, SnapshotMetadata& meta){};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r671734817",
      "id" : 671734817,
      "line" : 19,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3MTczNDgxNw==",
      "original_commit_id" : "1901a9819d507425f9a2ea440d78892acbbb0e7f",
      "original_line" : 19,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/test/util/chainstate.h",
      "position" : 19,
      "pull_request_review_id" : 708964765,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-17T19:29:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/671734817",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r671736102"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/671736102"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I was going to suggest changing to std::optional<CBlockIndex&> since the inner type is not nullable. If you want rebindable, reference_wrapper.",
      "commit_id" : "1901a9819d507425f9a2ea440d78892acbbb0e7f",
      "created_at" : "2021-07-17T19:44:14Z",
      "diff_hunk" : "@@ -1024,6 +1024,12 @@ class ChainstateManager\n     //! ResizeCoinsCaches() as needed.\n     void MaybeRebalanceCaches() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! @returns height at which the active UTXO snapshot was taken, if applicable.\n+    std::optional<CBlockIndex*> GetSnapshotBaseBlock() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r671736102",
      "id" : 671736102,
      "in_reply_to_id" : 655484970,
      "line" : 1032,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3MTczNjEwMg==",
      "original_commit_id" : "0dd5757fd7c5b1d151abe45843711780a4b3885b",
      "original_line" : 1032,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 62,
      "pull_request_review_id" : 708965449,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-17T19:44:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/671736102",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r671736221"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/671736221"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "(it's just a test, and it's moveonly, so NBD)",
      "commit_id" : "1901a9819d507425f9a2ea440d78892acbbb0e7f",
      "created_at" : "2021-07-17T19:45:44Z",
      "diff_hunk" : "@@ -0,0 +1,54 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+//\n+#ifndef BITCOIN_TEST_UTIL_CHAINSTATE_H\n+#define BITCOIN_TEST_UTIL_CHAINSTATE_H\n+\n+#include <clientversion.h>\n+#include <fs.h>\n+#include <node/context.h>\n+#include <node/utxo_snapshot.h>\n+#include <rpc/blockchain.h>\n+#include <validation.h>\n+\n+#include <univalue.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+auto NoMalleation = [](CAutoFile& file, SnapshotMetadata& meta){};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r671736221",
      "id" : 671736221,
      "in_reply_to_id" : 671734817,
      "line" : 19,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3MTczNjIyMQ==",
      "original_commit_id" : "1901a9819d507425f9a2ea440d78892acbbb0e7f",
      "original_line" : 19,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/test/util/chainstate.h",
      "position" : 19,
      "pull_request_review_id" : 708965531,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-17T19:45:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/671736221",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "did some lite code review; generally looks OK but I'm not super familiar with this part of the code so an ACK from me wouldn't count for much.",
      "created_at" : "2021-07-17T19:47:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#issuecomment-881950913",
      "id" : 881950913,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21526",
      "node_id" : "IC_kwDOABII5840kYDB",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-17T19:47:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/881950913",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r672599645"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/672599645"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: change UpdateTip for multiple chainstates\" (daa6902795b082832734b084a6c118eb8c682c3d)\r\n\r\nIt seems like a more natural place for this log print would be line 2239 right next to the background validation log print so logging code here is more consolidated and straightforward. It would be a minor change in logging behavior though, logging at beginning instead of end of this function.",
      "commit_id" : "1901a9819d507425f9a2ea440d78892acbbb0e7f",
      "created_at" : "2021-07-19T20:14:42Z",
      "diff_hunk" : "@@ -2237,12 +2264,7 @@ void CChainState::UpdateTip(const CBlockIndex* pindexNew)\n             }\n         }\n     }\n-    LogPrintf(\"%s: new best=%s height=%d version=0x%08x log2_work=%f tx=%lu date='%s' progress=%f cache=%.1fMiB(%utxo)%s\\n\", __func__,\n-      pindexNew->GetBlockHash().ToString(), pindexNew->nHeight, pindexNew->nVersion,\n-      log(pindexNew->nChainWork.getdouble())/log(2.0), (unsigned long)pindexNew->nChainTx,\n-      FormatISO8601DateTime(pindexNew->GetBlockTime()),\n-      GuessVerificationProgress(m_params.TxData(), pindexNew), this->CoinsTip().DynamicMemoryUsage() * (1.0 / (1<<20)), this->CoinsTip().GetCacheSize(),\n-      !warning_messages.empty() ? strprintf(\" warning='%s'\", warning_messages.original) : \"\");\n+    log_progress(\"\", warning_messages.original);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r672599645",
      "id" : 672599645,
      "line" : 2267,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3MjU5OTY0NQ==",
      "original_commit_id" : "daa6902795b082832734b084a6c118eb8c682c3d",
      "original_line" : 2267,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 61,
      "pull_request_review_id" : 709939303,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-19T22:27:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/672599645",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r672607413"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/672607413"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: change UpdateTip for multiple chainstates\" (daa6902795b082832734b084a6c118eb8c682c3d)\r\n\r\nQuestions about previous code I guess, but why is `BACKGROUND_LOG_INTERVAL` rate limiting code is needed for this function in the `this != active` background case, but it is not needed in the `this->IsInitialBlockDownload` background case? I'd expect you'd want the same rate limiting both cases.\r\n\r\nAlso, it's kind of weird that in the `this != active` case, this function does nothing other than optionally print a log statement and return. It could make sense to move `m_chain.SetTip` calls into this function to dedup call sites and make this do more real work.",
      "commit_id" : "1901a9819d507425f9a2ea440d78892acbbb0e7f",
      "created_at" : "2021-07-19T20:27:11Z",
      "diff_hunk" : "@@ -2237,12 +2264,7 @@ void CChainState::UpdateTip(const CBlockIndex* pindexNew)\n             }\n         }\n     }\n-    LogPrintf(\"%s: new best=%s height=%d version=0x%08x log2_work=%f tx=%lu date='%s' progress=%f cache=%.1fMiB(%utxo)%s\\n\", __func__,\n-      pindexNew->GetBlockHash().ToString(), pindexNew->nHeight, pindexNew->nVersion,\n-      log(pindexNew->nChainWork.getdouble())/log(2.0), (unsigned long)pindexNew->nChainTx,\n-      FormatISO8601DateTime(pindexNew->GetBlockTime()),\n-      GuessVerificationProgress(m_params.TxData(), pindexNew), this->CoinsTip().DynamicMemoryUsage() * (1.0 / (1<<20)), this->CoinsTip().GetCacheSize(),\n-      !warning_messages.empty() ? strprintf(\" warning='%s'\", warning_messages.original) : \"\");\n+    log_progress(\"\", warning_messages.original);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r672607413",
      "id" : 672607413,
      "line" : 2267,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3MjYwNzQxMw==",
      "original_commit_id" : "daa6902795b082832734b084a6c118eb8c682c3d",
      "original_line" : 2267,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 61,
      "pull_request_review_id" : 709939303,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-19T22:27:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/672607413",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r672649191"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/672649191"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: change UpdateTip for multiple chainstates\" (daa6902795b082832734b084a6c118eb8c682c3d)\r\n\r\nIf going to use EXCLUSIVE_LOCKS_REQUIRED on a lambda right now, should actually use AssertLockHeld inside the lambda as well, because just adding the REQUIRED to a lambda does not actually require anything. (It just makes the analysis assume that the lock is held with no enforcement. Offtopic: I think this is bad and previously argued against using REQUIRED annotations to make unenforced assumptions in favor of adding a better assert with enforced assumptions, but I couldn't convince reviewers about it in #19918.)",
      "commit_id" : "1901a9819d507425f9a2ea440d78892acbbb0e7f",
      "created_at" : "2021-07-19T21:37:12Z",
      "diff_hunk" : "@@ -2210,6 +2210,33 @@ static void AppendWarning(bilingual_str& res, const bilingual_str& warn)\n \n void CChainState::UpdateTip(const CBlockIndex* pindexNew)\n {\n+    auto& func_name = __func__;\n+    auto log_progress = [this, pindexNew, &func_name](\n+            const std::string& prefix,\n+            const std::string& warning_messages) EXCLUSIVE_LOCKS_REQUIRED(::cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r672649191",
      "id" : 672649191,
      "line" : 2216,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3MjY0OTE5MQ==",
      "original_commit_id" : "daa6902795b082832734b084a6c118eb8c682c3d",
      "original_line" : 2216,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 24,
      "pull_request_review_id" : 709939303,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-19T22:27:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/672649191",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r672653163"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/672653163"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: fix CheckBlockIndex for multiple chainstates\" (d7804383748e85bda1be40cf0782a3ca2e457066)\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/21526#discussion_r671736102\r\n\r\n> I was going to suggest changing to std::optional<CBlockIndex&> since the inner type is not nullable. If you want rebindable, reference_wrapper.\r\n\r\nI'm probably missing a subtlety but I don't know what reason you'd prefer `optional<T&>` to `T*`. It seems like just reinventing a pointer without using a pointer.",
      "commit_id" : "1901a9819d507425f9a2ea440d78892acbbb0e7f",
      "created_at" : "2021-07-19T21:44:41Z",
      "diff_hunk" : "@@ -1024,6 +1024,12 @@ class ChainstateManager\n     //! ResizeCoinsCaches() as needed.\n     void MaybeRebalanceCaches() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! @returns height at which the active UTXO snapshot was taken, if applicable.\n+    std::optional<CBlockIndex*> GetSnapshotBaseBlock() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r672653163",
      "id" : 672653163,
      "in_reply_to_id" : 655484970,
      "line" : 1032,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3MjY1MzE2Mw==",
      "original_commit_id" : "0dd5757fd7c5b1d151abe45843711780a4b3885b",
      "original_line" : 1032,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 62,
      "pull_request_review_id" : 709939303,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-19T22:27:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/672653163",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r672666902"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/672666902"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: fix CheckBlockIndex for multiple chainstates\" (d7804383748e85bda1be40cf0782a3ca2e457066)\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/21526#discussion_r671490286\r\n\r\n> I'll make a note to ensure that `CompleteSnapshotValidation()` (in #15606) nulls out `m_snapshot_blockhash` so that what you're saying here is actually what happens. Otherwise we would just run the full suite of checks after restart when (what was previously) the snapshot chainstate gets loaded in as a \"regular\" IBD'd chainstate.\r\n\r\nThis would be good to do but it does seem fragile that you have to clear a `CChainState` atttribute to make more checking happen. I think (again) more ideally in the future assumeutxo snapshot logic would be limited to `ChainStateManager`. Chain state objects could have a `CChainState::m_validation_starting_height` member that could be used here instead of `snapshot_height` and `ChainStateManager` could set, so this code doesn't have to know about `ChainStateManager` and ask it about snapshots.",
      "commit_id" : "1901a9819d507425f9a2ea440d78892acbbb0e7f",
      "created_at" : "2021-07-19T22:12:04Z",
      "diff_hunk" : "@@ -4341,8 +4379,11 @@ void CChainState::CheckBlockIndex(const Consensus::Params& consensusParams)\n     while (pindex != nullptr) {\n         nNodes++;\n         if (pindexFirstInvalid == nullptr && pindex->nStatus & BLOCK_FAILED_VALID) pindexFirstInvalid = pindex;\n-        if (pindexFirstMissing == nullptr && !(pindex->nStatus & BLOCK_HAVE_DATA)) pindexFirstMissing = pindex;\n-        if (pindexFirstNeverProcessed == nullptr && pindex->nTx == 0) pindexFirstNeverProcessed = pindex;\n+        // Don't start being rigorous about missing block data if we're within a utxo snapshot\n+        if (pindex->nHeight > snapshot_height) {\n+            if (pindexFirstMissing == nullptr && !(pindex->nStatus & BLOCK_HAVE_DATA)) pindexFirstMissing = pindex;\n+            if (pindexFirstNeverProcessed == nullptr && pindex->nTx == 0) pindexFirstNeverProcessed = pindex;\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r672666902",
      "id" : 672666902,
      "in_reply_to_id" : 658173137,
      "line" : 4356,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3MjY2NjkwMg==",
      "original_commit_id" : "b6dffada18bf874c619d17baf9df45346e52b871",
      "original_line" : 4356,
      "original_position" : 114,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 93,
      "pull_request_review_id" : 709939303,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-19T22:27:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/672666902",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r673457466"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/673457466"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Still not fixed?",
      "commit_id" : "1901a9819d507425f9a2ea440d78892acbbb0e7f",
      "created_at" : "2021-07-20T20:14:53Z",
      "diff_hunk" : "@@ -1040,6 +1028,12 @@ class ChainstateManager\n     //! ResizeCoinsCaches() as needed.\n     void MaybeRebalanceCaches() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! @returns block metadata for the base block of the active UTXO snapshot, if applicable.\n+    std::optional<CBlockIndex*> GetSnapshotBaseBlock() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r673457466",
      "id" : 673457466,
      "line" : 1032,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3MzQ1NzQ2Ng==",
      "original_commit_id" : "1901a9819d507425f9a2ea440d78892acbbb0e7f",
      "original_line" : 1032,
      "original_position" : 62,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 62,
      "pull_request_review_id" : 711025359,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-20T20:14:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/673457466",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r674024789"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/674024789"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Totally agree @ryanofsky, and I've got some changes coming that will attempt to limit the degree to which the notion of snapshots leak out of ChainstateManager, but I want to point out two things:\r\n- having an `m_validation_starting_height` member on CChainState would still have to be toggled after snapshot validation completes, so the fragility you rightfully point out would still be there, and\r\n- whether we call it \"snapshot_height\" or \"m_validation_starting_height\" or \"assumed_valid_before\", we're going to have some notion of an assumed-valid region of the chain that parts of the system have to kind of know about to a certain extent. I think it's a legitimate argument that \"assmed-valid\" is maybe a more appropriate, general label than talking about snapshots, but fundamentally they're isomorphic at the moment AFAICT.\r\n\r\nI think the only real way to avoid the fragility of the checks here is to, instead of relying on CChainState member variables, introduce a new block index status flag, `BLOCK_ASSUMED_VALID`, and have CheckBlockIndex et al gate on that. I'm going to look at potentially doing this in a future changeset because this involves to some extent revamping the assumeutxo changes more generally.",
      "commit_id" : "1901a9819d507425f9a2ea440d78892acbbb0e7f",
      "created_at" : "2021-07-21T14:27:38Z",
      "diff_hunk" : "@@ -4341,8 +4379,11 @@ void CChainState::CheckBlockIndex(const Consensus::Params& consensusParams)\n     while (pindex != nullptr) {\n         nNodes++;\n         if (pindexFirstInvalid == nullptr && pindex->nStatus & BLOCK_FAILED_VALID) pindexFirstInvalid = pindex;\n-        if (pindexFirstMissing == nullptr && !(pindex->nStatus & BLOCK_HAVE_DATA)) pindexFirstMissing = pindex;\n-        if (pindexFirstNeverProcessed == nullptr && pindex->nTx == 0) pindexFirstNeverProcessed = pindex;\n+        // Don't start being rigorous about missing block data if we're within a utxo snapshot\n+        if (pindex->nHeight > snapshot_height) {\n+            if (pindexFirstMissing == nullptr && !(pindex->nStatus & BLOCK_HAVE_DATA)) pindexFirstMissing = pindex;\n+            if (pindexFirstNeverProcessed == nullptr && pindex->nTx == 0) pindexFirstNeverProcessed = pindex;\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r674024789",
      "id" : 674024789,
      "in_reply_to_id" : 658173137,
      "line" : 4356,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NDAyNDc4OQ==",
      "original_commit_id" : "b6dffada18bf874c619d17baf9df45346e52b871",
      "original_line" : 4356,
      "original_position" : 114,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 93,
      "pull_request_review_id" : 711724756,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-21T14:27:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/674024789",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r674198521"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/674198521"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> having an `m_validation_starting_height` member on CChainState would still have to be toggled after snapshot validation completes, so the fragility you rightfully point out would still be there\r\n\r\nRight, but the point for me is to just locate the complexity in chainstatemanager instead of having it exposed to other parts of the code. I think in this case complexity is like a conserved quantity, you can't get rid of it but you can move it from one place to another. If complexity is encapsulated one place and not exposed other places that's the best outcome.\r\n\r\nAlso I guess I personally have a bias to wanting to name things after _how they are used_ or _what they mean_, not _where they came from_. Data can come from lots of places, and snapshots are a new source of data. But it adds mental overhead for pruning, indexing, and other validation code to know about the snapshot lifecycle or care where blocks came from when they don't need to, so something like \"validated_starting_height\" or \"locally_validated_starting_height\" seems easier to understand and reason about than \"snapshot_height\" in code that doesn't otherwise have to deal with snapshots.\r\n\r\n`BLOCK_ASSUMED_VALID` could be good too. (I do have some skepticism that it conveys similar information, but not the same information, so might leave code making unclear assumptions like every block before the last assume valid block has the flag, and every block after doesn't have it. Also it would seem more natural to have a flag indicating what kind of validation was done, instead of what kind of validation was skipped, so maybe BLOCK_VALIDATED_FROM_GENESIS, BLOCK_VALIDATED_FROM_SNAPSHOT could be more descriptive.)\r\n\r\nBut everything after the first paragraph here is just differences of opinion about naming, and you should chose the names you like and ignore the feedback you don't like. I'm not trying to play architect here, just say what things I'm thinking and maybe generate some useful ideas.",
      "commit_id" : "1901a9819d507425f9a2ea440d78892acbbb0e7f",
      "created_at" : "2021-07-21T17:40:52Z",
      "diff_hunk" : "@@ -4341,8 +4379,11 @@ void CChainState::CheckBlockIndex(const Consensus::Params& consensusParams)\n     while (pindex != nullptr) {\n         nNodes++;\n         if (pindexFirstInvalid == nullptr && pindex->nStatus & BLOCK_FAILED_VALID) pindexFirstInvalid = pindex;\n-        if (pindexFirstMissing == nullptr && !(pindex->nStatus & BLOCK_HAVE_DATA)) pindexFirstMissing = pindex;\n-        if (pindexFirstNeverProcessed == nullptr && pindex->nTx == 0) pindexFirstNeverProcessed = pindex;\n+        // Don't start being rigorous about missing block data if we're within a utxo snapshot\n+        if (pindex->nHeight > snapshot_height) {\n+            if (pindexFirstMissing == nullptr && !(pindex->nStatus & BLOCK_HAVE_DATA)) pindexFirstMissing = pindex;\n+            if (pindexFirstNeverProcessed == nullptr && pindex->nTx == 0) pindexFirstNeverProcessed = pindex;\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r674198521",
      "id" : 674198521,
      "in_reply_to_id" : 658173137,
      "line" : 4356,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NDE5ODUyMQ==",
      "original_commit_id" : "b6dffada18bf874c619d17baf9df45346e52b871",
      "original_line" : 4356,
      "original_position" : 114,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 93,
      "pull_request_review_id" : 711976343,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-21T17:40:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/674198521",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r675715549"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/675715549"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed, thanks.",
      "commit_id" : "3a9ce0e2d41cac3b072225aa1ed34caca4191392",
      "created_at" : "2021-07-23T17:13:27Z",
      "diff_hunk" : "@@ -2210,6 +2210,33 @@ static void AppendWarning(bilingual_str& res, const bilingual_str& warn)\n \n void CChainState::UpdateTip(const CBlockIndex* pindexNew)\n {\n+    auto& func_name = __func__;\n+    auto log_progress = [this, pindexNew, &func_name](\n+            const std::string& prefix,\n+            const std::string& warning_messages) EXCLUSIVE_LOCKS_REQUIRED(::cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r675715549",
      "id" : 675715549,
      "in_reply_to_id" : 672649191,
      "line" : 2216,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NTcxNTU0OQ==",
      "original_commit_id" : "daa6902795b082832734b084a6c118eb8c682c3d",
      "original_line" : 2216,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 24,
      "pull_request_review_id" : 713927792,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-23T17:13:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/675715549",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r675716972"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/675716972"
         }
      },
      "author_association" : "MEMBER",
      "body" : "\"Snapshot height\" has now been completely removed as something this code is concerned about; I'll post a longer comment summarizing the changes, but we now rely on a block index flag called `BLOCK_ASSUMED_VALID` to change CheckBlockIndex() behavior as necessary. We now no longer have to worry about ChainstateManager variables to bring this behavior \"back to normal,\" since `BLOCK_ASSUMED_VALID` is removed from the corresponding pindex as blocks are validated.",
      "commit_id" : "3a9ce0e2d41cac3b072225aa1ed34caca4191392",
      "created_at" : "2021-07-23T17:16:15Z",
      "diff_hunk" : "@@ -4341,8 +4379,11 @@ void CChainState::CheckBlockIndex(const Consensus::Params& consensusParams)\n     while (pindex != nullptr) {\n         nNodes++;\n         if (pindexFirstInvalid == nullptr && pindex->nStatus & BLOCK_FAILED_VALID) pindexFirstInvalid = pindex;\n-        if (pindexFirstMissing == nullptr && !(pindex->nStatus & BLOCK_HAVE_DATA)) pindexFirstMissing = pindex;\n-        if (pindexFirstNeverProcessed == nullptr && pindex->nTx == 0) pindexFirstNeverProcessed = pindex;\n+        // Don't start being rigorous about missing block data if we're within a utxo snapshot\n+        if (pindex->nHeight > snapshot_height) {\n+            if (pindexFirstMissing == nullptr && !(pindex->nStatus & BLOCK_HAVE_DATA)) pindexFirstMissing = pindex;\n+            if (pindexFirstNeverProcessed == nullptr && pindex->nTx == 0) pindexFirstNeverProcessed = pindex;\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#discussion_r675716972",
      "id" : 675716972,
      "in_reply_to_id" : 658173137,
      "line" : 4354,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NTcxNjk3Mg==",
      "original_commit_id" : "b6dffada18bf874c619d17baf9df45346e52b871",
      "original_line" : 4354,
      "original_position" : 114,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 92,
      "pull_request_review_id" : 713929749,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21526",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-23T17:16:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/675716972",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "[`au.multi-chainstates.pt1.16`](https://github.com/jamesob/bitcoin/tree/au.multi-chainstates.pt1.16) -> [`au.multi-chainstates.pt1.18`](https://github.com/jamesob/bitcoin/tree/au.multi-chainstates.pt1.18)\r\n\r\nAfter spending some time slightly reworking #15606 to incorporate good design feedback from @ryanofsky, I've pushed some fairly substantive changes here. Sorry, of course, for these changes so late in the game on this PR - but better to make them now than post-merge. \r\n\r\nIn a nutshell, I've reworked assumeutxo so that the notion of a \"UTXO snapshot\" is basically an implementation detail of ChainstateManager and doesn't leak out from behind it. Other parts of validation and the system at large deal with more general concepts like assumed-valid block index entries, and aren't concerned with things like what height the base block of the snapshot is at.\r\n\r\nThis is described in [an assumeutxo design document (docs/assumeutxo.md)](https://github.com/bitcoin/bitcoin/blob/d575d2b45fa33c0e88b3060309795d4a386bf1ce/doc/assumeutxo.md#design-notes) I've added in the parent PR. The immediate changes here are \r\n- introduction of a new block index `nStatus` flag: `BLOCK_ASSUMED_VALID`, which marks block entries that are for the moment assumed to be valid and are pending asynchronous validation,\r\n- use of this new flag to modify `CheckBlockIndex()` logic as needed - which is more resilient than the previous approach because as assumd-valid index entries are marked as valid, the CheckBlockIndex() checks gradually return to \"normal\" operation (instead of having to wait on complete snapshot validation, and hoping that we set ChainstateManager state correctly).\r\n\r\nI think these changes not only represent a better design for the assumeutxo implementation, but they address all pending feedback here in this PR.\r\n\r\nThanks again for bearing with the changes and continuing to help with review. Once we get this merged, there are a number of other (smaller) assumeutxo PRs I can open.",
      "created_at" : "2021-07-24T13:37:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#issuecomment-886054862",
      "id" : 886054862,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21526",
      "node_id" : "IC_kwDOABII58400B_O",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-24T13:37:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/886054862",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Anyone have any advice on what's needed to move this forward? I think it's in pretty good shape.",
      "created_at" : "2021-08-05T19:25:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#issuecomment-893724818",
      "id" : 893724818,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21526",
      "node_id" : "IC_kwDOABII5841RSiS",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-05T19:25:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/893724818",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Anyone have any advice on what's needed to move this forward? I think it's in pretty good shape.\r\n\r\nMy bad! I reviewed most of the new changes here while I was going through the larger PR #15606, but I forgot to come back and re-ack. \r\n\r\nAside from me, some previous reviewers might be interested to continue review or re-ack:\r\n\r\n- @sjors https://github.com/bitcoin/bitcoin/pull/21526#pullrequestreview-652577266\r\n- @benthecarman https://github.com/bitcoin/bitcoin/pull/21526#pullrequestreview-689166399\r\n- @ariard https://github.com/bitcoin/bitcoin/pull/21526#issuecomment-872597591\r\n- @jonatack https://github.com/bitcoin/bitcoin/pull/21526#pullrequestreview-708717465\r\n- JeremyRubin https://github.com/bitcoin/bitcoin/pull/21526#issuecomment-881950913",
      "created_at" : "2021-08-05T21:25:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21526#issuecomment-893819553",
      "id" : 893819553,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21526",
      "node_id" : "IC_kwDOABII5841Rpqh",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-05T21:25:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/893819553",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   }
]
