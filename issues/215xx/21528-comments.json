[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r601057629"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601057629"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't think there's any need to `SetupAddressRelay` here, and doing so would cause you to continue choosing inbounds that are treating you as block-relay-only instead of ignoring them as a black hole.",
      "commit_id" : "ea30030216e1a3456ff609bba7c4d2087940478a",
      "created_at" : "2021-03-25T05:32:50Z",
      "diff_hunk" : "@@ -2625,7 +2625,11 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             pfrom.fDisconnect = true;\n             return;\n         }\n-        pfrom.m_wants_addrv2 = true;\n+\n+        if (SetupAddressRelay(pfrom)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r601057629",
      "id" : 601057629,
      "line" : 2631,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMTA1NzYyOQ==",
      "original_commit_id" : "cd55b53800ec63b516bdca46bfee0d57e34e3af6",
      "original_line" : 2629,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 53,
      "pull_request_review_id" : 620728925,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-25T05:32:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601057629",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #21236 (Net processing: Extract `addr` send functionality into MaybeSendAddr() by jnewbery)\n* #19460 (multiprocess: Add bitcoin-wallet -ipcconnect option by ryanofsky)\n* #10102 ([experimental] Multiprocess bitcoin by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-03-25T08:54:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-806477418",
      "id" : 806477418,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwNjQ3NzQxOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-25T08:54:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/806477418",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r601317221"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601317221"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This isn't thread safe. By accessing `m_addr_known` from outside the message handler thread (eg an rpc worker thread or qt), this opens race conditions where `m_addr_known` is being set by the message handler thread and read by an rpc thread concurrently. In such cases, the thread reading the value could see the old value, the new value or garbage.",
      "commit_id" : "ea30030216e1a3456ff609bba7c4d2087940478a",
      "created_at" : "2021-03-25T10:21:59Z",
      "diff_hunk" : "@@ -611,6 +611,8 @@ void CNode::copyStats(CNodeStats &stats, const std::vector<bool> &m_asmap)\n     stats.addrLocal = addrLocalUnlocked.IsValid() ? addrLocalUnlocked.ToString() : \"\";\n \n     X(m_conn_type);\n+\n+    stats.addr_relay_enabled = RelayAddrsWithConn();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r601317221",
      "id" : 601317221,
      "line" : 615,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMTMxNzIyMQ==",
      "original_commit_id" : "ea30030216e1a3456ff609bba7c4d2087940478a",
      "original_line" : 615,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 5,
      "pull_request_review_id" : 620941721,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-25T10:32:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601317221",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r601327487"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601327487"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think it matters much either way. The only peers this affects are inbound block-relay-only connections from v0.21 peers, which (incorrectly) send `sendaddrv2` to us. Inbound block-relay-only peers on v22 won't send `sendaddrv2` because of the change in commit _Stop sending SENDADDRV2 message to block relay only peers_.",
      "commit_id" : "ea30030216e1a3456ff609bba7c4d2087940478a",
      "created_at" : "2021-03-25T10:30:26Z",
      "diff_hunk" : "@@ -2625,7 +2625,11 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             pfrom.fDisconnect = true;\n             return;\n         }\n-        pfrom.m_wants_addrv2 = true;\n+\n+        if (SetupAddressRelay(pfrom)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r601327487",
      "id" : 601327487,
      "in_reply_to_id" : 601057629,
      "line" : 2631,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMTMyNzQ4Nw==",
      "original_commit_id" : "cd55b53800ec63b516bdca46bfee0d57e34e3af6",
      "original_line" : 2629,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 53,
      "pull_request_review_id" : 620941721,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-25T10:32:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601327487",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r601328295"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601328295"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I suggest you drop these tidy-up changes in _Add some documentation and small style fixes_. They don't seem very related to the rest of the PR :see_no_evil: ",
      "commit_id" : "ea30030216e1a3456ff609bba7c4d2087940478a",
      "created_at" : "2021-03-25T10:31:11Z",
      "diff_hunk" : "@@ -4243,12 +4279,17 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                     }\n                 }\n             }\n+\n             pto->vAddrToSend.clear();\n-            if (!vAddr.empty())\n+\n+            if (!vAddr.empty()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r601328295",
      "id" : 601328295,
      "line" : 4285,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMTMyODI5NQ==",
      "original_commit_id" : "ea30030216e1a3456ff609bba7c4d2087940478a",
      "original_line" : 4285,
      "original_position" : 121,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 121,
      "pull_request_review_id" : 620941721,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-25T10:32:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601328295",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I think that an approach like this was first suggested by AJ in https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-527012757:\r\n\r\n> I think since we AdvertiseLocal regularly to our non-block-relay peers, we could just set a flag on the peer if we've ever seen an ADDR message from them, and only choose nodes with that flag in RelayAddress?\r\n\r\nI think it's a good idea, since it stops us relaying addrs to both inbound block-relay-only peers _and_ other kinds of black holes.",
      "created_at" : "2021-03-25T10:36:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-806541067",
      "id" : 806541067,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwNjU0MTA2Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-25T10:36:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/806541067",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   }
]
