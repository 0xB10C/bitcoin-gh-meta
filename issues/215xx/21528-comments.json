[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r601057629"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601057629"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't think there's any need to `SetupAddressRelay` here, and doing so would cause you to continue choosing inbounds that are treating you as block-relay-only instead of ignoring them as a black hole.",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-25T05:32:50Z",
      "diff_hunk" : "@@ -2625,7 +2625,11 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             pfrom.fDisconnect = true;\n             return;\n         }\n-        pfrom.m_wants_addrv2 = true;\n+\n+        if (SetupAddressRelay(pfrom)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r601057629",
      "id" : 601057629,
      "line" : 2629,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMTA1NzYyOQ==",
      "original_commit_id" : "cd55b53800ec63b516bdca46bfee0d57e34e3af6",
      "original_line" : 2629,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 52,
      "pull_request_review_id" : 620728925,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-30T21:03:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601057629",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #15606 ([experimental] UTXO snapshots by jamesob)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-03-25T08:54:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-806477418",
      "id" : 806477418,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwNjQ3NzQxOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-15T07:51:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/806477418",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r601317221"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601317221"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This isn't thread safe. By accessing `m_addr_known` from outside the message handler thread (eg an rpc worker thread or qt), this opens race conditions where `m_addr_known` is being set by the message handler thread and read by an rpc thread concurrently. In such cases, the thread reading the value could see the old value, the new value or garbage.",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-25T10:21:59Z",
      "diff_hunk" : "@@ -611,6 +611,8 @@ void CNode::copyStats(CNodeStats &stats, const std::vector<bool> &m_asmap)\n     stats.addrLocal = addrLocalUnlocked.IsValid() ? addrLocalUnlocked.ToString() : \"\";\n \n     X(m_conn_type);\n+\n+    stats.addr_relay_enabled = RelayAddrsWithConn();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r601317221",
      "id" : 601317221,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMTMxNzIyMQ==",
      "original_commit_id" : "ea30030216e1a3456ff609bba7c4d2087940478a",
      "original_line" : 615,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 620941721,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-30T21:03:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601317221",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r601327487"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601327487"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think it matters much either way. The only peers this affects are inbound block-relay-only connections from v0.21 peers, which (incorrectly) send `sendaddrv2` to us. Inbound block-relay-only peers on v22 won't send `sendaddrv2` because of the change in commit _Stop sending SENDADDRV2 message to block relay only peers_.",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-25T10:30:26Z",
      "diff_hunk" : "@@ -2625,7 +2625,11 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             pfrom.fDisconnect = true;\n             return;\n         }\n-        pfrom.m_wants_addrv2 = true;\n+\n+        if (SetupAddressRelay(pfrom)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r601327487",
      "id" : 601327487,
      "in_reply_to_id" : 601057629,
      "line" : 2629,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMTMyNzQ4Nw==",
      "original_commit_id" : "cd55b53800ec63b516bdca46bfee0d57e34e3af6",
      "original_line" : 2629,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 52,
      "pull_request_review_id" : 620941721,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-30T21:03:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601327487",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r601328295"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601328295"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I suggest you drop these tidy-up changes in _Add some documentation and small style fixes_. They don't seem very related to the rest of the PR :see_no_evil: ",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-25T10:31:11Z",
      "diff_hunk" : "@@ -4243,12 +4279,17 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                     }\n                 }\n             }\n+\n             pto->vAddrToSend.clear();\n-            if (!vAddr.empty())\n+\n+            if (!vAddr.empty()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r601328295",
      "id" : 601328295,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMTMyODI5NQ==",
      "original_commit_id" : "ea30030216e1a3456ff609bba7c4d2087940478a",
      "original_line" : 4285,
      "original_position" : 121,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 620941721,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-30T21:03:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601328295",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I think that an approach like this was first suggested by AJ in https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-527012757:\r\n\r\n> I think since we AdvertiseLocal regularly to our non-block-relay peers, we could just set a flag on the peer if we've ever seen an ADDR message from them, and only choose nodes with that flag in RelayAddress?\r\n\r\nI think it's a good idea, since it stops us relaying addrs to both inbound block-relay-only peers _and_ other kinds of black holes.",
      "created_at" : "2021-03-25T10:36:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-806541067",
      "id" : 806541067,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwNjU0MTA2Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-25T10:36:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/806541067",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r603710494"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603710494"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ergh, its annoying that v0.21 peers will send us the `sendaddrv2` message, but I'm not sure if this warrants removing this conditional. some thoughts:\r\n- in terms of protocol & logical coherence, I'd expect `sendaddrv2` to indicate desire that the node wants to participate in addr relay\r\n- in this patch, calling `SetupAddressRelay` for the node mimics the behavior of current master. so I think of calling as the default (rather than the other way around)\r\n- in terms of safety, it seems better to have a blackhole than exclude a peer from address relay.   I think... a blackhole means an address, or set of addresses will not propagate as well this time, but excluding a peer from address relay (esp if programmatically / many peers exclude) means that peer could be at a higher risk of being eclipsed? \r\n\r\nI thought I was on the fence, but writing out this reasoning makes me realize I'd like to leave as is.\r\n\r\nthoughts? ",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-30T01:05:47Z",
      "diff_hunk" : "@@ -2625,7 +2625,11 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             pfrom.fDisconnect = true;\n             return;\n         }\n-        pfrom.m_wants_addrv2 = true;\n+\n+        if (SetupAddressRelay(pfrom)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r603710494",
      "id" : 603710494,
      "in_reply_to_id" : 601057629,
      "line" : 2629,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzcxMDQ5NA==",
      "original_commit_id" : "cd55b53800ec63b516bdca46bfee0d57e34e3af6",
      "original_line" : 2629,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 52,
      "pull_request_review_id" : 623763694,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-30T21:03:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603710494",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r603711802"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603711802"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ayo, good catch. it feels like overkill to introduce a lock just to expose a boolean, so I've dropped this commit for now. will some of your addr-in-net-processing refactor will make it so we can do this safely? ",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-30T01:09:14Z",
      "diff_hunk" : "@@ -611,6 +611,8 @@ void CNode::copyStats(CNodeStats &stats, const std::vector<bool> &m_asmap)\n     stats.addrLocal = addrLocalUnlocked.IsValid() ? addrLocalUnlocked.ToString() : \"\";\n \n     X(m_conn_type);\n+\n+    stats.addr_relay_enabled = RelayAddrsWithConn();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r603711802",
      "id" : 603711802,
      "in_reply_to_id" : 601317221,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzcxMTgwMg==",
      "original_commit_id" : "ea30030216e1a3456ff609bba7c4d2087940478a",
      "original_line" : 615,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 623764905,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-30T21:03:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603711802",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r603713142"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603713142"
         }
      },
      "author_association" : "MEMBER",
      "body" : "sorry I'm not sorry!! I abhor two line if statements, they are great footguns. these changes are pretty trivial, I don't think they would make sense as a stand-alone PR, or that they increase the complexity of review, so I'd rather leave them in.",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-30T01:13:48Z",
      "diff_hunk" : "@@ -4243,12 +4279,17 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                     }\n                 }\n             }\n+\n             pto->vAddrToSend.clear();\n-            if (!vAddr.empty())\n+\n+            if (!vAddr.empty()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r603713142",
      "id" : 603713142,
      "in_reply_to_id" : 601328295,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzcxMzE0Mg==",
      "original_commit_id" : "ea30030216e1a3456ff609bba7c4d2087940478a",
      "original_line" : 4285,
      "original_position" : 121,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 623766503,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-30T21:03:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603713142",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "fixed tests & added a test. patch is ready, but leaving as a draft until I gain more confidence that this would not break any other software on the network. \r\n\r\ncompiling a list of other clients & compatibility with this patch: \r\n\r\n<table>\r\n<tr>\r\n\t<td> breadwallet\r\n\t<td> â\r\n\t<td> \r\n\r\nSends `getaddr` & only accepts `addr` messages afterwards ([link](https://github.com/breadwallet/breadwallet-core/blob/develop/bitcoin/BRPeer.c#L283))\r\n\r\n<tr>\r\n\t<td> btcd\r\n\t<td> \r\n\r\nâ waiting for confirmation ([issue](https://github.com/btcsuite/btcd/issues/1709))\r\n\r\n<td> \r\n\r\nAfter connecting to a new outbound peer, sends `addr` self advertisement, and sometimes sends `getaddr`. Relevant code linked in the issue. \r\n\r\n<tr>\r\n\r\n\r\n<td> libbitcoin \r\n\r\n<td>\r\n\r\nâ Confirmed by @evoskuil ([issue](https://github.com/libbitcoin/libbitcoin-network/issues/251))\r\n\r\n<td>\r\n\r\nWhen connecting to an outbound peer, sends a `getaddr` message. \r\n\r\n\r\n<tr> \r\n\r\n<td> bitcoin knots\r\n\r\n<td> â\r\n\r\n<td> \r\n\r\n\r\nSame behavior as Bitcoin Core, upon receiving a `version` message, sends a `getaddr` to outbound connections unless they are block-relay only, usually also self-advertises. ([link](https://github.com/bitcoinknots/bitcoin/blob/0.21.x-knots/src/net_processing.cpp#L2488))\r\n\r\n<tr>\r\n\r\n<td> bcoin \r\n\r\n<td> \r\n\r\nâ Confirmed by @pinheadmz ([issue](https://github.com/bcoin-org/bcoin/issues/1012)).\r\n\r\n<td>\r\n\r\nUpon opening a connection, node will self-advertise & usually send a `getaddr` message ([link](https://github.com/bcoin-org/bcoin/blob/f1abba52eda16d3981039651d0e0407e0c7fc778/lib/net/pool.js#L1269)).\r\n\r\n<tr>\r\n\r\n<td> gocoin\r\n\r\n<td>\r\n\r\nâ Confirmed by @piotrnar ([issue](https://github.com/piotrnar/gocoin/issues/57))\r\n\r\n<td>\r\n\r\nUpon receipt of a `version` message, node will self-advertise. Node will usually also send a `getaddr` message to peers.\r\n\r\n<tr> \r\n\r\n<td> bitcore\r\n\r\n<td>\r\n\r\nâ Confirmed by @micahriggan ([issue](https://github.com/bitpay/bitcore/issues/3140))\r\n\r\n<td>\r\n\r\nBitcore nodes typically have dedicated bitcoin node(s) and the addresses are passed in via config.\r\n\r\n<tr>\r\n\r\n<td> bitcoinj\r\n\r\n<td>\r\n\r\nâ waiting for confirmation ([issue](https://github.com/bitcoinj/bitcoinj/issues/2123))\r\n\r\n<td> As part of connecting to a peer, the node will send a `getaddr` message on the link. \r\n\r\n</table>",
      "created_at" : "2021-03-30T04:53:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-809906430",
      "id" : 809906430,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwOTkwNjQzMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-11T01:14:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/809906430",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r603867126"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603867126"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> will some of your addr-in-net-processing refactor will make it so we can do this safely?\r\n\r\nHopefully, yes!",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-30T07:56:46Z",
      "diff_hunk" : "@@ -611,6 +611,8 @@ void CNode::copyStats(CNodeStats &stats, const std::vector<bool> &m_asmap)\n     stats.addrLocal = addrLocalUnlocked.IsValid() ? addrLocalUnlocked.ToString() : \"\";\n \n     X(m_conn_type);\n+\n+    stats.addr_relay_enabled = RelayAddrsWithConn();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r603867126",
      "id" : 603867126,
      "in_reply_to_id" : 601317221,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzg2NzEyNg==",
      "original_commit_id" : "ea30030216e1a3456ff609bba7c4d2087940478a",
      "original_line" : 615,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 623952119,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-30T21:03:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603867126",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r603872782"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603872782"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I agree that two line if statements are undesirable. If you were already touching these lines, then I'd agree that you should improve them. However, these are the only changes you make to `SendMessages()` and are unrelated to the rest of the changes in this PR.\r\n\r\nI refactor this entire chunk of logic in #21236. Without this tidy-up commit, the two PRs don't conflict and can be merged in either order. If you include these changes, then the PRs conflict and one will have to be rebased when the other is merged.",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-30T08:05:19Z",
      "diff_hunk" : "@@ -4243,12 +4279,17 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                     }\n                 }\n             }\n+\n             pto->vAddrToSend.clear();\n-            if (!vAddr.empty())\n+\n+            if (!vAddr.empty()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r603872782",
      "id" : 603872782,
      "in_reply_to_id" : 601328295,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzg3Mjc4Mg==",
      "original_commit_id" : "ea30030216e1a3456ff609bba7c4d2087940478a",
      "original_line" : 4285,
      "original_position" : 121,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 623959766,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-30T21:03:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603872782",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r603974606"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603974606"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: is it worth replacing `if (... && !pfrom.IsBlockOnlyConn())` with `if (... && SetupAddrssRelay(pfrom))` since it already checks if the peer is block-relay-only?",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-30T10:27:09Z",
      "diff_hunk" : "@@ -2437,6 +2437,8 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n \n         if (!pfrom.IsInboundConn() && !pfrom.IsBlockOnlyConn()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r603974606",
      "id" : 603974606,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzk3NDYwNg==",
      "original_commit_id" : "9db8ab25b0aee97cad56e98200918fdf3cf849fb",
      "original_line" : 2439,
      "original_position" : 3,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 624095110,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-30T21:03:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603974606",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/18324680?v=4",
         "events_url" : "https://api.github.com/users/ccdle12/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ccdle12/followers",
         "following_url" : "https://api.github.com/users/ccdle12/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ccdle12/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ccdle12",
         "id" : 18324680,
         "login" : "ccdle12",
         "node_id" : "MDQ6VXNlcjE4MzI0Njgw",
         "organizations_url" : "https://api.github.com/users/ccdle12/orgs",
         "received_events_url" : "https://api.github.com/users/ccdle12/received_events",
         "repos_url" : "https://api.github.com/users/ccdle12/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ccdle12/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ccdle12/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ccdle12"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r603974781"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603974781"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nice tests, would it would be overkill to also test for the outbound case?",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-30T10:27:23Z",
      "diff_hunk" : "@@ -101,6 +115,25 @@ def relay_tests(self):\n \n         self.nodes[0].disconnect_p2ps()\n \n+    def blackhole_tests(self):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r603974781",
      "id" : 603974781,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzk3NDc4MQ==",
      "original_commit_id" : "8e2bcc0cb68ef2f43c22d686010fde2c2b54080a",
      "original_line" : 118,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : null,
      "pull_request_review_id" : 624095310,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-30T21:03:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603974781",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/18324680?v=4",
         "events_url" : "https://api.github.com/users/ccdle12/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ccdle12/followers",
         "following_url" : "https://api.github.com/users/ccdle12/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ccdle12/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ccdle12",
         "id" : 18324680,
         "login" : "ccdle12",
         "node_id" : "MDQ6VXNlcjE4MzI0Njgw",
         "organizations_url" : "https://api.github.com/users/ccdle12/orgs",
         "received_events_url" : "https://api.github.com/users/ccdle12/received_events",
         "repos_url" : "https://api.github.com/users/ccdle12/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ccdle12/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ccdle12/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ccdle12"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604430768"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604430768"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ok! reverted :) ",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-30T21:04:33Z",
      "diff_hunk" : "@@ -4243,12 +4279,17 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                     }\n                 }\n             }\n+\n             pto->vAddrToSend.clear();\n-            if (!vAddr.empty())\n+\n+            if (!vAddr.empty()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604430768",
      "id" : 604430768,
      "in_reply_to_id" : 601328295,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDQzMDc2OA==",
      "original_commit_id" : "ea30030216e1a3456ff609bba7c4d2087940478a",
      "original_line" : 4285,
      "original_position" : 121,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 624702659,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-30T21:04:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604430768",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604431246"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604431246"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nice idea, done!",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-30T21:05:24Z",
      "diff_hunk" : "@@ -2437,6 +2437,8 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n \n         if (!pfrom.IsInboundConn() && !pfrom.IsBlockOnlyConn()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604431246",
      "id" : 604431246,
      "in_reply_to_id" : 603974606,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDQzMTI0Ng==",
      "original_commit_id" : "9db8ab25b0aee97cad56e98200918fdf3cf849fb",
      "original_line" : 2439,
      "original_position" : 3,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 624703297,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-30T21:05:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604431246",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604432892"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604432892"
         }
      },
      "author_association" : "MEMBER",
      "body" : "definitely not overkill, the inbound vs outbound behavior is different- inbounds we wait to hear an `addr` message before considering the peer eligible for relay, but with outbounds we setup relay, send `getaddr` & self-announce (unless its a block-relay-only connection). I added some tests to check these behaviors. ",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-30T21:08:17Z",
      "diff_hunk" : "@@ -101,6 +115,25 @@ def relay_tests(self):\n \n         self.nodes[0].disconnect_p2ps()\n \n+    def blackhole_tests(self):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604432892",
      "id" : 604432892,
      "in_reply_to_id" : 603974781,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDQzMjg5Mg==",
      "original_commit_id" : "8e2bcc0cb68ef2f43c22d686010fde2c2b54080a",
      "original_line" : 118,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : null,
      "pull_request_review_id" : 624705469,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-30T21:08:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604432892",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604439165"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604439165"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n     *  announcements. Reasons peers might not support addr relay on the link\r\n     *  include that they connected to us as a block-relay-only peer or they are\r\n     *  a light client.\r\n```",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-30T21:19:40Z",
      "diff_hunk" : "@@ -546,6 +543,20 @@ class CNode\n \n     // flood relay\n     std::vector<CAddress> vAddrToSend;\n+\n+    /** Bloom filter to track recent addr messages relayed with this peer.\n+     *\n+     *  We initialize this filter for outbound peers (other than\n+     *  block-relay-only connections) or when an inbound peer sends us an\n+     *  address related message (ADDR, ADDRV2, GETADDR, SENDADDRV2).\n+     *\n+     *  We use the presence of this filter to decide whether a peer is eligible\n+     *  for trickle relay of addr messages. This avoids relaying to peers that\n+     *  are unlikely to forward them, effectively blackholing self\n+     *  announcements. Reasons peers might not support addr relay on the link\n+     *  is if they connected to us as a block-relay-only peer or as a light\n+     *  client.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604439165",
      "id" : 604439165,
      "line" : 558,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDQzOTE2NQ==",
      "original_commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "original_line" : 558,
      "original_position" : 32,
      "original_start_line" : 556,
      "path" : "src/net.h",
      "position" : 32,
      "pull_request_review_id" : 624713468,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : 556,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-31T00:24:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604439165",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604450797"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604450797"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Since peers are chosen randomly, does it make sense to run `self.inbound_blackhole_tests()` a few extra times, just to assert it's not because the node didn't pick `blackhole_peer` by chance?",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-30T21:41:49Z",
      "diff_hunk" : "@@ -82,6 +130,49 @@ def run_test(self):\n         ipv4_branching_factor = 2\n         assert_equal(total_ipv4_received, num_ipv4_addrs * ipv4_branching_factor)\n \n+        self.nodes[0].disconnect_p2ps()\n+\n+    def inbound_blackhole_tests(self):\n+        self.log.info('Check that we only relay addresses to inbound peers who have previously sent us addr related messages')\n+\n+        addr_source = self.nodes[0].add_p2p_connection(P2PInterface())\n+        receiver_peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+        blackhole_peer = self.nodes[0].add_p2p_connection(AddrBlackhole())\n+\n+        msg = self.setup_addr_msg(2)\n+        self.send_addr_msg(addr_source, msg, [receiver_peer, blackhole_peer])\n+\n+        assert_equal(receiver_peer.num_ipv4_received, 2)\n+        assert_equal(blackhole_peer.num_ipv4_received, 0)\n+\n+        self.nodes[0].disconnect_p2ps()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604450797",
      "id" : 604450797,
      "line" : 148,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDQ1MDc5Nw==",
      "original_commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "original_line" : 148,
      "original_position" : 153,
      "original_start_line" : 135,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 153,
      "pull_request_review_id" : 624713468,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : 135,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-30T22:57:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604450797",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604456653"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604456653"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think this test could also be improved by asserting that, after `blackhole_peer` does send an `addr`/`addrv2`/`getaddrs`/`sendaddrv2` message, it can get selected for addr propagation.",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-30T21:53:40Z",
      "diff_hunk" : "@@ -82,6 +130,49 @@ def run_test(self):\n         ipv4_branching_factor = 2\n         assert_equal(total_ipv4_received, num_ipv4_addrs * ipv4_branching_factor)\n \n+        self.nodes[0].disconnect_p2ps()\n+\n+    def inbound_blackhole_tests(self):\n+        self.log.info('Check that we only relay addresses to inbound peers who have previously sent us addr related messages')\n+\n+        addr_source = self.nodes[0].add_p2p_connection(P2PInterface())\n+        receiver_peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+        blackhole_peer = self.nodes[0].add_p2p_connection(AddrBlackhole())\n+\n+        msg = self.setup_addr_msg(2)\n+        self.send_addr_msg(addr_source, msg, [receiver_peer, blackhole_peer])\n+\n+        assert_equal(receiver_peer.num_ipv4_received, 2)\n+        assert_equal(blackhole_peer.num_ipv4_received, 0)\n+\n+        self.nodes[0].disconnect_p2ps()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604456653",
      "id" : 604456653,
      "in_reply_to_id" : 604450797,
      "line" : 148,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDQ1NjY1Mw==",
      "original_commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "original_line" : 148,
      "original_position" : 153,
      "original_start_line" : 135,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 153,
      "pull_request_review_id" : 624713468,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : 135,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-30T22:57:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604456653",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604458405"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604458405"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Another thought - for the blackhole peer, I think could be helpful to assert bytes received for addr-related messages = 0 using `getpeerinfo()`",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-30T21:57:04Z",
      "diff_hunk" : "@@ -82,6 +130,49 @@ def run_test(self):\n         ipv4_branching_factor = 2\n         assert_equal(total_ipv4_received, num_ipv4_addrs * ipv4_branching_factor)\n \n+        self.nodes[0].disconnect_p2ps()\n+\n+    def inbound_blackhole_tests(self):\n+        self.log.info('Check that we only relay addresses to inbound peers who have previously sent us addr related messages')\n+\n+        addr_source = self.nodes[0].add_p2p_connection(P2PInterface())\n+        receiver_peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+        blackhole_peer = self.nodes[0].add_p2p_connection(AddrBlackhole())\n+\n+        msg = self.setup_addr_msg(2)\n+        self.send_addr_msg(addr_source, msg, [receiver_peer, blackhole_peer])\n+\n+        assert_equal(receiver_peer.num_ipv4_received, 2)\n+        assert_equal(blackhole_peer.num_ipv4_received, 0)\n+\n+        self.nodes[0].disconnect_p2ps()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604458405",
      "id" : 604458405,
      "in_reply_to_id" : 604450797,
      "line" : 148,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDQ1ODQwNQ==",
      "original_commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "original_line" : 148,
      "original_position" : 153,
      "original_start_line" : 135,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 153,
      "pull_request_review_id" : 624713468,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : 135,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-30T22:57:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604458405",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604477534"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604477534"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Side question: why do we clear this list here instead of appending to it, given that `PushAddress` and `SendMessages` filter for duplicates?",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-30T22:41:05Z",
      "diff_hunk" : "@@ -3569,6 +3584,8 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n         pfrom.fSentAddr = true;\n \n+        SetupAddressRelay(pfrom);\n+\n         pfrom.vAddrToSend.clear();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604477534",
      "id" : 604477534,
      "line" : 3589,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDQ3NzUzNA==",
      "original_commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "original_line" : 3589,
      "original_position" : 78,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 78,
      "pull_request_review_id" : 624713468,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-30T22:57:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604477534",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604497976"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604497976"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Since peers are chosen randomly..\r\n\r\nyes, peers are chosen randomly, but this test is set up to not be random- ipv4 addresses will be relayed to 2 peers that are not the source of the addr message. so both `receiver_peer` and `blackhole_peer` would receive the addr if they were eligible. definitely wouldn't want a flaky test there :) \r\n\r\n> I think this test could also be improved.. \r\n\r\nthats a great idea! I've added locally, will include in next push. \r\n\r\n> assert bytes received for addr-related messages = 0\r\n\r\nhm, `blackhole_peer` is a p2p connection, so we can't call `getpeerinfo()` on it to get the bytes received directly. that said, we could check `bytessent_per_msg` on the node to see that no bytes have been sent for an `addr` message. however, I its a bit brittle & the p2p connection is capturing directly receiving the addr message, so I don't think that's adding much value to the test. let me know if you think it'd add test coverage :) ",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-30T23:35:10Z",
      "diff_hunk" : "@@ -82,6 +130,49 @@ def run_test(self):\n         ipv4_branching_factor = 2\n         assert_equal(total_ipv4_received, num_ipv4_addrs * ipv4_branching_factor)\n \n+        self.nodes[0].disconnect_p2ps()\n+\n+    def inbound_blackhole_tests(self):\n+        self.log.info('Check that we only relay addresses to inbound peers who have previously sent us addr related messages')\n+\n+        addr_source = self.nodes[0].add_p2p_connection(P2PInterface())\n+        receiver_peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+        blackhole_peer = self.nodes[0].add_p2p_connection(AddrBlackhole())\n+\n+        msg = self.setup_addr_msg(2)\n+        self.send_addr_msg(addr_source, msg, [receiver_peer, blackhole_peer])\n+\n+        assert_equal(receiver_peer.num_ipv4_received, 2)\n+        assert_equal(blackhole_peer.num_ipv4_received, 0)\n+\n+        self.nodes[0].disconnect_p2ps()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604497976",
      "id" : 604497976,
      "in_reply_to_id" : 604450797,
      "line" : 148,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDQ5Nzk3Ng==",
      "original_commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "original_line" : 148,
      "original_position" : 153,
      "original_start_line" : 135,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 153,
      "pull_request_review_id" : 624783523,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : 135,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-30T23:35:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604497976",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604518862"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604518862"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> yes, peers are chosen randomly, but this test is set up to not be random- ipv4 addresses will be relayed to 2 peers that are not the source of the addr message. so both receiver_peer and blackhole_peer would receive the addr if they were eligible. definitely wouldn't want a flaky test there :)\r\n\r\nOh right it's always going to be the same one. That makes sense then, that the node has 2 options but doesn't send it to a peer that hasn't established addr relay. But wait I'm confused why it would be flaky, I thought `blackhole_peer` would never get the addr because it hasn't sent any addr-related messages?\r\n\r\n> hm, blackhole_peer is a p2p connection, so we can't call getpeerinfo() on it to get the bytes received directly.\r\n\r\nEr I mean, call `getpeerinfo()` on the node to see bytes received, kinda like this:\r\n\r\n```py\r\ndef sum_addr_messages(msgs):\r\n    return msgs['addr'] + msgs['addrv2'] + msgs['getaddr'] + msgs['sendaddrv2']\r\n...\r\n\r\npeerinfo = self.nodes[0].getpeerinfo()\r\n# receiver_peer sent us its own addr and a getaddr after the VERSION message, so we relay\r\nassert sum_addr_messages(peerinfo[1]['bytesrecv_per_msg']) > 0\r\nassert_equal(receiver_peer.num_ipv4_received, 2)\r\n\r\n# blackhole_peer should not have sent us any addr-related messages, so we don't relay\r\nassert sum_addr_messages(peerinfo[2]['bytesrecv_per_msg']) == 0\r\nassert_equal(blackhole_peer.num_ipv4_received, 0)\r\n```\r\nI just thought it'd be a more precise test, asserting that the addrs aren't relayed because no addr messages have been received. ð nbd",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-31T00:39:13Z",
      "diff_hunk" : "@@ -82,6 +130,49 @@ def run_test(self):\n         ipv4_branching_factor = 2\n         assert_equal(total_ipv4_received, num_ipv4_addrs * ipv4_branching_factor)\n \n+        self.nodes[0].disconnect_p2ps()\n+\n+    def inbound_blackhole_tests(self):\n+        self.log.info('Check that we only relay addresses to inbound peers who have previously sent us addr related messages')\n+\n+        addr_source = self.nodes[0].add_p2p_connection(P2PInterface())\n+        receiver_peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+        blackhole_peer = self.nodes[0].add_p2p_connection(AddrBlackhole())\n+\n+        msg = self.setup_addr_msg(2)\n+        self.send_addr_msg(addr_source, msg, [receiver_peer, blackhole_peer])\n+\n+        assert_equal(receiver_peer.num_ipv4_received, 2)\n+        assert_equal(blackhole_peer.num_ipv4_received, 0)\n+\n+        self.nodes[0].disconnect_p2ps()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604518862",
      "id" : 604518862,
      "in_reply_to_id" : 604450797,
      "line" : 148,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDUxODg2Mg==",
      "original_commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "original_line" : 148,
      "original_position" : 153,
      "original_start_line" : 135,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 153,
      "pull_request_review_id" : 624806781,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : 135,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-31T00:45:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604518862",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604526797"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604526797"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> But wait I'm confused why it would be flaky, I thought blackhole_peer would never get the addr because it hasn't sent any addr-related messages?\r\n\r\nyes yes, it would be flaky if it wasn't deterministic / `blackhole_peer` was being skipped by chance. I think we're on the same page, just confusion of my language now. \r\n\r\n> Er I mean, call getpeerinfo() on the node to see bytes received, kinda like this\r\n\r\noh I get it now, you're suggesting additional coverage to test the setup, not another way to test the `addr` relayed. that's a cool idea! sure, I'll add it :) \r\n\r\nsmol note: \r\n> receiver_peer sent us its own addr and a getaddr after the VERSION message, so we relay\r\n\r\nsince `receiver_peer` is essentially a `P2PInterface` object, it actually won't self announce upon receiving `version` message. I added  that it will send out a `getaddr` so tests wouldn't unexpectedly break  in this patch. but I think that highlights why this suggested coverage is useful, at the very least it communicates the relevant setup that's otherwise \"invisible\" from the POV of this test file. ",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-31T01:06:30Z",
      "diff_hunk" : "@@ -82,6 +130,49 @@ def run_test(self):\n         ipv4_branching_factor = 2\n         assert_equal(total_ipv4_received, num_ipv4_addrs * ipv4_branching_factor)\n \n+        self.nodes[0].disconnect_p2ps()\n+\n+    def inbound_blackhole_tests(self):\n+        self.log.info('Check that we only relay addresses to inbound peers who have previously sent us addr related messages')\n+\n+        addr_source = self.nodes[0].add_p2p_connection(P2PInterface())\n+        receiver_peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+        blackhole_peer = self.nodes[0].add_p2p_connection(AddrBlackhole())\n+\n+        msg = self.setup_addr_msg(2)\n+        self.send_addr_msg(addr_source, msg, [receiver_peer, blackhole_peer])\n+\n+        assert_equal(receiver_peer.num_ipv4_received, 2)\n+        assert_equal(blackhole_peer.num_ipv4_received, 0)\n+\n+        self.nodes[0].disconnect_p2ps()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604526797",
      "id" : 604526797,
      "in_reply_to_id" : 604450797,
      "line" : 148,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDUyNjc5Nw==",
      "original_commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "original_line" : 148,
      "original_position" : 153,
      "original_start_line" : 135,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 153,
      "pull_request_review_id" : 624815696,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : 135,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-31T01:06:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604526797",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@glozow The concern would be other Bitcoin node implementations which don't send addr/getaddr, but do care about receiving them. I don't think that's particularly likely, but it's also hard to be sure there are none.",
      "created_at" : "2021-03-31T05:01:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-810762563",
      "id" : 810762563,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxMDc2MjU2Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-31T05:01:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/810762563",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Concept ACK ",
      "created_at" : "2021-03-31T16:06:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-811184984",
      "id" : 811184984,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxMTE4NDk4NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-31T16:06:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/811184984",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/16559?v=4",
         "events_url" : "https://api.github.com/users/ivanacostarubio/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ivanacostarubio/followers",
         "following_url" : "https://api.github.com/users/ivanacostarubio/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ivanacostarubio/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ivanacostarubio",
         "id" : 16559,
         "login" : "ivanacostarubio",
         "node_id" : "MDQ6VXNlcjE2NTU5",
         "organizations_url" : "https://api.github.com/users/ivanacostarubio/orgs",
         "received_events_url" : "https://api.github.com/users/ivanacostarubio/received_events",
         "repos_url" : "https://api.github.com/users/ivanacostarubio/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ivanacostarubio/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ivanacostarubio/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ivanacostarubio"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r605058607"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/605058607"
         }
      },
      "author_association" : "NONE",
      "body" : "```suggestion\r\n    std::unique_ptr<CRollingBloomFilter> m_addr_known GUARDED_BY(cs_addrKnown){nullptr};\r\n```\r\nand add `cs_addrKnown` as a private member:\r\n\r\n```\r\nmutable RecursiveMutex cs_addrKnown;\r\n```\r\n\r\nto address the point about race conditions mentioned by @jnewbery ",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-31T16:46:07Z",
      "diff_hunk" : "@@ -546,6 +543,20 @@ class CNode\n \n     // flood relay\n     std::vector<CAddress> vAddrToSend;\n+\n+    /** Bloom filter to track recent addr messages relayed with this peer.\n+     *\n+     *  We initialize this filter for outbound peers (other than\n+     *  block-relay-only connections) or when an inbound peer sends us an\n+     *  address related message (ADDR, ADDRV2, GETADDR, SENDADDRV2).\n+     *\n+     *  We use the presence of this filter to decide whether a peer is eligible\n+     *  for trickle relay of addr messages. This avoids relaying to peers that\n+     *  are unlikely to forward them, effectively blackholing self\n+     *  announcements. Reasons peers might not support addr relay on the link\n+     *  is if they connected to us as a block-relay-only peer or as a light\n+     *  client.\n+     * */\n     std::unique_ptr<CRollingBloomFilter> m_addr_known{nullptr};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r605058607",
      "id" : 605058607,
      "line" : 560,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNTA1ODYwNw==",
      "original_commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "original_line" : 560,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 34,
      "pull_request_review_id" : 625507909,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-31T16:46:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/605058607",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/80422284?v=4",
         "events_url" : "https://api.github.com/users/GeneFerneau/events{/privacy}",
         "followers_url" : "https://api.github.com/users/GeneFerneau/followers",
         "following_url" : "https://api.github.com/users/GeneFerneau/following{/other_user}",
         "gists_url" : "https://api.github.com/users/GeneFerneau/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/GeneFerneau",
         "id" : 80422284,
         "login" : "GeneFerneau",
         "node_id" : "MDQ6VXNlcjgwNDIyMjg0",
         "organizations_url" : "https://api.github.com/users/GeneFerneau/orgs",
         "received_events_url" : "https://api.github.com/users/GeneFerneau/received_events",
         "repos_url" : "https://api.github.com/users/GeneFerneau/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/GeneFerneau/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/GeneFerneau/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/GeneFerneau"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Concept ACK\r\n\r\nNeed to review surrounding code more, and run the tests. Looks good so far!",
      "created_at" : "2021-03-31T16:49:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-811245866",
      "id" : 811245866,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxMTI0NTg2Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-31T16:49:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/811245866",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/80422284?v=4",
         "events_url" : "https://api.github.com/users/GeneFerneau/events{/privacy}",
         "followers_url" : "https://api.github.com/users/GeneFerneau/followers",
         "following_url" : "https://api.github.com/users/GeneFerneau/following{/other_user}",
         "gists_url" : "https://api.github.com/users/GeneFerneau/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/GeneFerneau",
         "id" : 80422284,
         "login" : "GeneFerneau",
         "node_id" : "MDQ6VXNlcjgwNDIyMjg0",
         "organizations_url" : "https://api.github.com/users/GeneFerneau/orgs",
         "received_events_url" : "https://api.github.com/users/GeneFerneau/received_events",
         "repos_url" : "https://api.github.com/users/GeneFerneau/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/GeneFerneau/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/GeneFerneau/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/GeneFerneau"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Reiterating my concept ACK on this. Reducing the number of addr black holes seems like a good win for addr gossipping across the network.\r\n\r\nThis branch needs rebase now that the addr data has been moved up into net_processing. I'd be very happy to help with that if you need a hand.",
      "created_at" : "2021-06-09T10:49:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-857592679",
      "id" : 857592679,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1NzU5MjY3OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-09T10:49:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/857592679",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Reiterating my concept ACK on this. Reducing the number of addr black holes seems like a good win for addr gossipping across the network.\r\n\r\nI think this was somewhat pending being sure it wouldn't break bitcore (see https://github.com/bitpay/bitcore/issues/3140) which now looks like it's now resolved.",
      "created_at" : "2021-06-09T11:39:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-857622218",
      "id" : 857622218,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1NzYyMjIxOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-09T11:39:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/857622218",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Reiterating my concept ACK on this\r\n\r\nThanks! \r\n\r\n> I think this was somewhat pending being sure it wouldn't break bitcore (see bitpay/bitcore#3140) which now looks like it's now resolved.\r\n\r\nIndeed. I'm now working to rebase & bring this PR out of draft. I've rebased locally but am working through some test failures, I hope to have this ready for review by early next week. \r\n\r\nPS: I also investigated bitcoinj & opened an issue on their repo, they also seem compatible ð. ",
      "created_at" : "2021-06-12T00:58:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-859973340",
      "id" : 859973340,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1OTk3MzM0MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-12T00:58:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/859973340",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r651383772"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/651383772"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Leaving this as is - I find it most logically consistent for `sendaddrv2` to indicate \"interested in addresses\". Opened #22245 to change the behavior for inbound block-relay-only v22.0 peers.",
      "commit_id" : "78e45d901ace269534a3bd3a86b5d2389f983aaa",
      "created_at" : "2021-06-15T01:34:48Z",
      "diff_hunk" : "@@ -2625,7 +2625,11 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             pfrom.fDisconnect = true;\n             return;\n         }\n-        pfrom.m_wants_addrv2 = true;\n+\n+        if (SetupAddressRelay(pfrom)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r651383772",
      "id" : 651383772,
      "in_reply_to_id" : 601057629,
      "line" : 2751,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MTM4Mzc3Mg==",
      "original_commit_id" : "cd55b53800ec63b516bdca46bfee0d57e34e3af6",
      "original_line" : 2751,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 110,
      "pull_request_review_id" : 683482383,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-15T01:34:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/651383772",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r651388591"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/651388591"
         }
      },
      "author_association" : "MEMBER",
      "body" : "updated language ",
      "commit_id" : "78e45d901ace269534a3bd3a86b5d2389f983aaa",
      "created_at" : "2021-06-15T01:49:53Z",
      "diff_hunk" : "@@ -546,6 +543,20 @@ class CNode\n \n     // flood relay\n     std::vector<CAddress> vAddrToSend;\n+\n+    /** Bloom filter to track recent addr messages relayed with this peer.\n+     *\n+     *  We initialize this filter for outbound peers (other than\n+     *  block-relay-only connections) or when an inbound peer sends us an\n+     *  address related message (ADDR, ADDRV2, GETADDR, SENDADDRV2).\n+     *\n+     *  We use the presence of this filter to decide whether a peer is eligible\n+     *  for trickle relay of addr messages. This avoids relaying to peers that\n+     *  are unlikely to forward them, effectively blackholing self\n+     *  announcements. Reasons peers might not support addr relay on the link\n+     *  is if they connected to us as a block-relay-only peer or as a light\n+     *  client.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r651388591",
      "id" : 651388591,
      "in_reply_to_id" : 604439165,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MTM4ODU5MQ==",
      "original_commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "original_line" : 558,
      "original_position" : 32,
      "original_start_line" : 556,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 683487797,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-06-15T01:49:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/651388591",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r651389080"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/651389080"
         }
      },
      "author_association" : "MEMBER",
      "body" : "based on this convo, I've updated the tests to assert that `blackhole_peer` starts receiving addr messages after sending one. I've also added `getpeerinfo` for the node to verify the test setup of which peers have sent addr related messages. \r\n\r\nthanks!   ",
      "commit_id" : "78e45d901ace269534a3bd3a86b5d2389f983aaa",
      "created_at" : "2021-06-15T01:51:21Z",
      "diff_hunk" : "@@ -82,6 +130,49 @@ def run_test(self):\n         ipv4_branching_factor = 2\n         assert_equal(total_ipv4_received, num_ipv4_addrs * ipv4_branching_factor)\n \n+        self.nodes[0].disconnect_p2ps()\n+\n+    def inbound_blackhole_tests(self):\n+        self.log.info('Check that we only relay addresses to inbound peers who have previously sent us addr related messages')\n+\n+        addr_source = self.nodes[0].add_p2p_connection(P2PInterface())\n+        receiver_peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+        blackhole_peer = self.nodes[0].add_p2p_connection(AddrBlackhole())\n+\n+        msg = self.setup_addr_msg(2)\n+        self.send_addr_msg(addr_source, msg, [receiver_peer, blackhole_peer])\n+\n+        assert_equal(receiver_peer.num_ipv4_received, 2)\n+        assert_equal(blackhole_peer.num_ipv4_received, 0)\n+\n+        self.nodes[0].disconnect_p2ps()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r651389080",
      "id" : 651389080,
      "in_reply_to_id" : 604450797,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MTM4OTA4MA==",
      "original_commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "original_line" : 212,
      "original_position" : 153,
      "original_start_line" : 135,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : null,
      "pull_request_review_id" : 683488319,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-06-15T01:51:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/651389080",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r651389788"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/651389788"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Holding off on this to try to figure out if there's a better way I can expose this value through the `getpeerinfo` RPC than having to introduce a mutex for this one hyper-specific use case. Ideas welcome! ",
      "commit_id" : "78e45d901ace269534a3bd3a86b5d2389f983aaa",
      "created_at" : "2021-06-15T01:53:26Z",
      "diff_hunk" : "@@ -546,6 +543,20 @@ class CNode\n \n     // flood relay\n     std::vector<CAddress> vAddrToSend;\n+\n+    /** Bloom filter to track recent addr messages relayed with this peer.\n+     *\n+     *  We initialize this filter for outbound peers (other than\n+     *  block-relay-only connections) or when an inbound peer sends us an\n+     *  address related message (ADDR, ADDRV2, GETADDR, SENDADDRV2).\n+     *\n+     *  We use the presence of this filter to decide whether a peer is eligible\n+     *  for trickle relay of addr messages. This avoids relaying to peers that\n+     *  are unlikely to forward them, effectively blackholing self\n+     *  announcements. Reasons peers might not support addr relay on the link\n+     *  is if they connected to us as a block-relay-only peer or as a light\n+     *  client.\n+     * */\n     std::unique_ptr<CRollingBloomFilter> m_addr_known{nullptr};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r651389788",
      "id" : 651389788,
      "in_reply_to_id" : 605058607,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MTM4OTc4OA==",
      "original_commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "original_line" : 560,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 683489100,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-15T01:53:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/651389788",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "My [research](https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-809906430) indicates that these changes would not break any clients, I've opened issues trying to confirm my understand on all the repos, and I have not heard any opposition from the mailing list or on IRC. This seems like the extent of what I can do to make sure these changes are compatible with alternative clients ð\r\n\r\nI've also broken out the commit to \"stop sending sendaddrv2 messages to block-relay-only peers\" into #22245. \r\n\r\nSo I'm bringing this PR out of draft. I have rebased it on top of #21236 and #21707. They were both pretty involved, so I recommend reviewing from scratch. The `p2p_addr_relay.py` functional test is getting pretty big & hits a fair amount of behind-the-scenes p2p mechanisms. I tried to improve the clarity & document relevant mechanisms, but open to suggestions if anything is still unclear. ",
      "created_at" : "2021-06-15T02:04:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-861114349",
      "id" : 861114349,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2MTExNDM0OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-15T02:05:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/861114349",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK. Impressively thorough investigation of impact on alternative clients :)",
      "created_at" : "2021-06-16T11:35:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-862305024",
      "id" : 862305024,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2MjMwNTAyNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-16T11:35:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/862305024",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/16323900?v=4",
         "events_url" : "https://api.github.com/users/michaelfolkson/events{/privacy}",
         "followers_url" : "https://api.github.com/users/michaelfolkson/followers",
         "following_url" : "https://api.github.com/users/michaelfolkson/following{/other_user}",
         "gists_url" : "https://api.github.com/users/michaelfolkson/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/michaelfolkson",
         "id" : 16323900,
         "login" : "michaelfolkson",
         "node_id" : "MDQ6VXNlcjE2MzIzOTAw",
         "organizations_url" : "https://api.github.com/users/michaelfolkson/orgs",
         "received_events_url" : "https://api.github.com/users/michaelfolkson/received_events",
         "repos_url" : "https://api.github.com/users/michaelfolkson/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/michaelfolkson/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/michaelfolkson/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/michaelfolkson"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> For inbound peers, we initialize the filter if/when we get an addr related message (ADDR, ADDRV2, GETADDR, SENDADDRV2).\r\n\r\nSo it may happen that a light client who does not participate in address relay connects to us and sends us `getaddr` in order to learn some peers and we (mis)interpret that and start sending unrequested addresses to that peer in the hopes of further relay. Black hole again.\r\n\r\nOr a peer that does not participate in address relay replies to our `getaddr` with `addr` and we (mis)interpret that as \"the peer participates in address relay\"?\r\n\r\nDo we have any estimates of how severe the black holes problem is? I think that currently address relay works, so maybe it is not a \"big\" problem, or not a problem at all?\r\n\r\nWhat if we relay to 3 instead of 2 random peers? Has that been considered? I would not require protocol changes. Would it solve the black holes problem or diminish it to such extend that it can be ignored?",
      "created_at" : "2021-06-16T11:48:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-862312851",
      "id" : 862312851,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2MjMxMjg1MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-16T11:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/862312851",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@vasild\r\n\r\n> So it may happen that a light client who does not participate in address relay connects to us and sends us getaddr in order to learn some peers and we (mis)interpret that and start sending unrequested addresses to that peer in the hopes of further relay. Black hole again.\r\nOr a peer that does not participate in address relay replies to our getaddr with addr and we (mis)interpret that as \"the peer participates in address relay\"?\r\n\r\nI believe this question is addressed in the OP- \"Although we cannot prevent this in a malicious case, we can improve it for the normal, honest cases, and reduce the overall likelihood of occurrence.\" \r\n\r\nIncase that is unclear, let me try to provide some additional context- the goal of this PR is not to ensure perfect accuracy of whether or not the receiving peer would forward the addresses. In fact, I don't think we could ever ensure such accuracy- even if we had a p2p message that said \"I will forward addresses you send me\", that could easily be abused by a peer who doesn't actually follow through. \r\n\r\nThe goal of this PR is to _reduce the frequency_ of sending addresses to nodes who have no interest in them & will certainly not forward those along. For example, we know that an honest node who is running the latest version of bitcoin core will have block-relay-only connections where it will drop any addresses sent over that connection.\r\n\r\n> Do we have any estimates of how severe the black holes problem is? I think that currently address relay works, so maybe it is not a \"big\" problem, or not a problem at all? \r\n\r\nWhile I do think this PR offers an improvement to address relay, the end goal is to increase the number of block-relay-only connections created by a bitcoin node (also goal of the `DISABLETX` work in #20726). Even if the number of black holes are not currently a problem, fixing them are a prerequisite to being able to increase the number of block-relay-only connections. For more context on this conversation, please see https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-480868516 & the surrounding discussion. \r\n\r\n> What if we relay to 3 instead of 2 random peers? Has that been considered? I would not require protocol changes. Would it solve the black holes problem or diminish it to such extend that it can be ignored?\r\n\r\nRelaying addresses to 3 rather than 2 random peers could be possible, but I think it would require in-depth research to ensure there wouldn't be any negative bandwidth or privacy impact. One of the alternative approaches that has been considered is to mark \"potential blackholes\" and then increase redundancy if they have been selected in `RelayAddress`. A downside of that approach is it's hard to build confidence that such approach wouldn't lead to network-wide biases of certain addresses or certain peers. \r\n\r\nI agree with what @sdaftuar said in https://github.com/bitcoin/bitcoin/pull/22245#issuecomment-862839610: \r\n> I donât think anyone believes that implicit behavior (that is undocumented in any BIP) is the right way for protocol development to proceed if starting from a clean slate â so eventually I think weâll rewrite things.\r\n\r\nThe current state of `addr` propagation relies heavily on assumptions & is poorly understood and poorly documented. In the long term, I hope to work towards a shared set of design goals & more explicit expectations that are well documented. However, this PR is coming from the hope that we don't have to gate making progress towards increasing block-relay-only connections on a fundamental redesign of `addr` relay. ",
      "created_at" : "2021-06-18T05:50:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-863775060",
      "id" : 863775060,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2Mzc3NTA2MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-21T04:35:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/863775060",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "If the focus is on avoiding gossip to peers that connected to us in block-only mode, then isn't the absence of `getaddr` enough to recognize that? That is, a peer who connected to us and did not send us `getaddr` must be in blocks-only mode / is a black hole? No need to involve `addr` and `addrv2`? I.e. only for inbound connections, delay initializing `Peer::m_addr_known` for until after `getaddr` is received.\r\n\r\nGiven that \"when\" and \"to whom\" to relay addresses is not mandated by any specification and is up to each peer to decide, and one may as well decide to relay only on full moon on odd months or if the peer's address ends in `7`, then deciding to skip relay to peers that did not send `getaddr` is not a protocol change.\r\n\r\nI see the assumption \"the peer did not send us `messageX` => they must be a black hole\" as flawed. More like a hack, which might be acceptable in the current situation.\r\n\r\nStill sending to some black holes is ok (we currently do). But could this PR have the adverse effect of starting to treat as black holes peers that are actually not?\r\n\r\nAs for relaying to more peers: currently we relay reachable addresses to 2 peers. So (assuming everybody relays) every node relays to two others (it spreads like a virus). And an average spread rate of <1 is required to stop an address from propagating. It means that if more than half of the peers are black holes then propagation will not work (will stop). I think we are far from 50% black holes but I could be wrong. For unreachable peers (e.g. a Tor address relayed via a peer that does not have Tor connectivity) the number is 1.5 and so, 33% or more black holes are needed to brick propagation.",
      "created_at" : "2021-06-18T10:40:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-863943765",
      "id" : 863943765,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2Mzk0Mzc2NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-18T10:40:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/863943765",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@vasild \r\n\r\n> That is, a peer who connected to us and did not send us getaddr must be in blocks-only mode / is a black hole?\r\n\r\nThis is false. If you see the notes I've taken on alternative clients here: https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-809906430, you can see that several of them will always self-advertise, but only occasionally send getaddr messages. \r\n\r\n> Still sending to some black holes is ok (we currently do). But could this PR have the adverse effect of starting to treat as black holes peers that are actually not?\r\n\r\nYes, exactly. This is why I have taken great care to communicate these changes & research clients to ensure they would not be harmed. If we only used getaddr to indicate \"wants to participate in addr relay\", this exact adverse effect would occur. \r\n\r\n> As for relaying to more peers: currently we relay reachable addresses to 2 peers. So (assuming everybody relays) every node relays to two others (it spreads like a virus). And an average spread rate of <1 is required to stop an address from propagating. It means that if more than half of the peers are black holes then propagation will not work (will stop). I think we are far from 50% black holes but I could be wrong. For unreachable peers (e.g. a Tor address relayed via a peer that does not have Tor connectivity) the number is 1.5 and so, 33% or more black holes are needed to brick propagation.\r\n\r\nAs I said in my previous post, \"Relaying addresses to 3 rather than 2 random peers could be possible, but I think it would require in-depth research to ensure there wouldn't be any negative bandwidth or privacy impact.\" There is no doubt that relaying addresses to more peers could ensure they saturate the network. Heck, if that was all we cared about, why not forward addresses to every node? \r\n\r\nThe concern is if there would be any _other_ adverse impact, and that is difficult to reason about. We could model the bandwidth increase by estimating: number of nodes on network, expected frequency of initiating self-announcements, number of anticipated blackholes & multiplier of forwarding addresses. This could help build confidence, but a lot of these numbers would have to be estimates. Even harder would be to guarantee that there are no significant security concerns. For example, addr relay can reveal node topology which can ease a partition or eclipse attack. I believe it would be significantly more complex to usefully model how changing the relay policy would impact potential information leaks. And that wouldn't be the only security concern about changing addr relay policy, just one example.",
      "created_at" : "2021-06-18T18:17:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-864202916",
      "id" : 864202916,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2NDIwMjkxNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-18T18:17:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/864202916",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK.\r\n\r\n> As for relaying to more peers: currently we relay reachable addresses to 2 peers. So (assuming everybody relays) every node relays to two others (it spreads like a virus). And an average spread rate of <1 is required to stop an address from propagating. It means that if more than half of the peers are black holes then propagation will not work (will stop). I think we are far from 50% black holes but I could be wrong.\r\n\r\nI think that there are at least two limitations to a virus-like spread:\r\n1. Each full node relays a given addr only once to two peers, and becomes a black hole for it after that - if it receives the addr again from another peer, it won't relay it to different peers within 24h because of how `RelayAddress()` works. This makes addr gossip sensitive to network topology (hubs with many peers are bottlenecks) and makes it pretty much impossible for an addr to percolate through the entire network via gossip relay. Even with zero black holes, an addr would only reach ~35% of the nodes in my simulation.\r\n2. Each node in the network will stop relaying an addr 10 minutes after the announcement (that's 20 hops on average with `AVG_ADDRESS_BROADCAST_INTERVAL = 30s`), see [first condition here](https://github.com/bitcoin/bitcoin/blob/da69d9965a112c6421fce5649b5a18beb7513526/src/net_processing.cpp#L2783-L2786)\r\n\r\nMy impression is that the introduction of 20% block-relay-only connections could have effected addr gossip relay quite clearly. I did some quick simulations similar to @naumenkogs' work from #17194 but adjusted for points 1 and 2 from above: \r\nThe simulations ([code](https://github.com/mzumsande/addr_relay_sim)) suggest that the percentage of nodes reached by an initial self-announcement of a new non-listening node falls from 35% (0% black holes) to 21% (20% black holes) to 2% (35% black holes).\r\n\r\n> I think that currently address relay works, so maybe it is not a \"big\" problem, or not a problem at all?\r\n\r\nI think that whether addr gossip relay \"works\"  is not so easy to judge because other means of addr propagation (DNS seeds; getaddr mechanism) also contribute to addr propagation and introduce some degree of redundancy - maybe the best measure is how fast a new node on the network receives inbound connections?\r\nBut getaddr does not adapt quickly (older addrs, 24 hour cache) to changes in the network, so it makes sense to me to improve the state of gossip relay as suggested by this PR.",
      "created_at" : "2021-06-21T00:08:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-864633869",
      "id" : 864633869,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2NDYzMzg2OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-21T00:08:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/864633869",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> The simulations ([code](https://github.com/mzumsande/addr_relay_sim)) suggest that the percentage of nodes reached by an initial self-announcement of a new non-listening node falls from 35% (0% black holes) to 21% (20% black holes) to 2% (35% black holes).\r\n\r\nI think that's simulating having 8 outbounds of which 20% (or 30%,35%,40%) are blackholes, rather than 8 full outbounds and an additional 2 blackholes.\r\n\r\nMight be worth distinguishing between the percentage of listening nodes that see an address versus total nodes -- I think with 8 outbounds, 0% blackholes it's 92% of listening nodes and 35% of all nodes that see an address, and 20% blackholes (6.4 full outbound 1.6 block relay only) gives 65% of listening nodes and 21% of all nodes see an address.\r\n\r\nI tried writing [my own sim](https://gist.github.com/ajtowns/ec27774113e5d1214b99281f6b7549c4) which only deals with listening peers; the numbers I got were 8 full-relay 0 block-relay gives ~80% of nodes seeing an address on average, while 8 full-relay 2 block-relay gives ~70% coverage, and 8 full-relay 5 block-relay gives ~50% coverage. Switching from 2 peers to 3 for addr relay brings those numbers up to 95%, 92% and 85% respectively.",
      "created_at" : "2021-06-21T05:30:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-864740342",
      "id" : 864740342,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2NDc0MDM0Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-21T05:30:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/864740342",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@mzumsande, @ajtowns, wow! That gives some rough picture on the severity of the problem. I think it rules out \"not a problem at all\". Thanks!\r\n\r\n@amitiuttarwar, I guess the \"waiting for confirmation\" for btcd and bitcoinj [above](https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-809906430) should be cleared before this PR is merged?",
      "created_at" : "2021-06-21T14:48:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-865093349",
      "id" : 865093349,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2NTA5MzM0OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-21T14:48:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/865093349",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@mzumsande, thanks for putting together that awesome simulation! and thank you @ajtowns for reviewing :) very cool. \r\n\r\nbiggest changes in the recent push: \r\n- as per the conversation on #22245, I've removed the commit that uses `sendaddrv2` as a signal to set up addr relay on the connection \r\n- I was finding the `p2p_addr_relay.py` refactor commit hard to parse, so I pulled it out into #22306 and broke it down into multiple commits. this PR builds on that branch. ",
      "created_at" : "2021-06-22T03:47:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-865505493",
      "id" : 865505493,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2NTUwNTQ5Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-22T03:47:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/865505493",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Had a bit more of a [poke](https://gist.github.com/ajtowns/ec27774113e5d1214b99281f6b7549c4) at this, I think the interesting results are (with 10k listening nodes, 50k private nodes with only outbounds):\r\n\r\n```\r\nConn: 8+2 Spread: 2 Limit: 10000/600 Avg/dev: 78.5%Â±9.7% 26.1%Â±3.5%\r\nConn: 8+0 Spread: 2 Limit: 10000/600 Avg/dev: 90.5%Â±1.7% 33.5%Â±1.0%\r\nConn: 8+5 Spread: 2 Limit: 10000/600 Avg/dev: 44.5%Â±17.0% 13.0%Â±5.1%\r\n\r\nConn: 8+5 Spread: 3 Limit: 10000/600 Avg/dev: 96.5%Â±9.7% 35.8%Â±3.6%\r\nConn: 8+0 Spread: 3 Limit: 10000/600 Avg/dev: 99.6%Â±0.1% 46.1%Â±0.2%\r\n```\r\n\r\nThat is, with 8 regular outbounds, sending addresses to 2 peers gives ~78% coverage of listening peers (and ~26% coverage of total peers) with 2 additional block-relay-only/blackhole peers, or ~90% coverage with this patch, or ~44% coverage without this patch and 5 additional block-relay-only peers instead of 2.\r\n\r\nWith a spread of 3 instead, then 5 block-relay-only peers gets to 96% coverage even without this patch (though with a large stddev), and with this patch as well gets to 99% coverage with a small standard deviation. So this seems like a \"both\" rather than an \"either/or\" situation to me.\r\n\r\nAddr relay is pretty low bandwidth, so I think the extra 50% of data for going from 2 to 3 is probably pretty fine (maybe make it 3 peers of which at most 2 are outbounds so that private peers don't increase traffic to listening nodes?); I'm not seeing what the privacy concerns should really be.\r\n\r\nI think these numbers are a bit more robust and better match @mzumsande's results. I switched the limit to 600s with poisson timing rather than 20 hops; provided there were enough samples the results between the two methods seemed pretty consistent.\r\n\r\nSo in summary, Concept ACK?",
      "created_at" : "2021-06-22T07:09:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-865658016",
      "id" : 865658016,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2NTY1ODAxNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-22T07:09:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/865658016",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   }
]
