[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [1440000bytes](https://github.com/bitcoin/bitcoin/pull/26837#issuecomment-1374359846), [zzzi2p](https://github.com/bitcoin/bitcoin/pull/26837#issuecomment-1374557660), [sipa](https://github.com/bitcoin/bitcoin/pull/26837#issuecomment-1376379927), [mzumsande](https://github.com/bitcoin/bitcoin/pull/26837#pullrequestreview-1242470108) |\n| Approach ACK | [w0xlt](https://github.com/bitcoin/bitcoin/pull/26837#pullrequestreview-1240520345) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#26621](https://github.com/bitcoin/bitcoin/pull/26621) (refactor: Continue moving application data from CNode to Peer by dergoegge)\n* [#26441](https://github.com/bitcoin/bitcoin/pull/26441) (rpc, p2p: add `addpermissionflags` RPC by brunoerg)\n* [#26114](https://github.com/bitcoin/bitcoin/pull/26114) (net: Make AddrFetch connections to fixed seeds by mzumsande)\n* [#25515](https://github.com/bitcoin/bitcoin/pull/25515) (net, test: Virtualise CConnman and add initial PeerManager unit tests by dergoegge)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-01-06T17:43:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26837#issuecomment-1373948043",
      "id" : 1373948043,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26837",
      "node_id" : "IC_kwDOABII585R5MiL",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1373948043/reactions"
      },
      "updated_at" : "2023-01-10T15:40:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1373948043",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "If it is desired to rate limit the creation of new sessions, we should (for `i2pacceptincoming=0` aka transient sessions):\r\n\r\n* keep track of the rate at which we create new sessions\r\n* when closing a connection, if the rate is too high, instead of discarding the session put it back to a pool of reused sessions\r\n* when creating new session, if the rate is too high and if the reused sessions pool is non-empty, then pick one from there\r\n\r\nReading https://github.com/bitcoin/bitcoin/issues/26754 I get the impression that this is not necessary. Further, it would be a compromise with \"one address per connection\" and would be somewhat more complicated (to implement and maintain).",
      "created_at" : "2023-01-06T17:53:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26837#issuecomment-1373956086",
      "id" : 1373956086,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26837",
      "node_id" : "IC_kwDOABII585R5Of2",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1373956086/reactions"
      },
      "updated_at" : "2023-01-06T17:53:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1373956086",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26837#discussion_r1063681972"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26837"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1063681972"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This would benefit from https://github.com/bitcoin/bitcoin/pull/25390 by just adding `Synced<...> m_i2p_sessions` without a separate mutex.",
      "commit_id" : "57fd27fd3621e782652c280d99263589fb3697a1",
      "created_at" : "2023-01-06T18:33:03Z",
      "diff_hunk" : "@@ -1126,6 +1127,20 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * Mutex protecting m_i2p_sam_sessions.\n+     */\n+    Mutex m_i2p_sessions_mutex;\n+\n+    /**\n+     * A pool of created I2P SAM transient sessions that should be used instead\n+     * of creating new ones in order to reduce the load on the I2P network.\n+     * Creating a session in I2P is not cheap, thus if this is not empty, then\n+     * pick an entry from it instead of creating a new session. If connecting to\n+     * a host fails, then the created session is put to this pool for reuse.\n+     */\n+    std::queue<std::unique_ptr<i2p::sam::Session>> m_i2p_sessions GUARDED_BY(m_i2p_sessions_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26837#discussion_r1063681972",
      "id" : 1063681972,
      "line" : 1142,
      "node_id" : "PRRC_kwDOABII584_Zn-0",
      "original_commit_id" : "57fd27fd3621e782652c280d99263589fb3697a1",
      "original_line" : 1142,
      "original_position" : 65,
      "original_start_line" : 1130,
      "path" : "src/net.h",
      "position" : 65,
      "pull_request_review_id" : 1239224890,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26837",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1063681972/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1130,
      "start_side" : "RIGHT",
      "updated_at" : "2023-01-06T18:33:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1063681972",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks @vasild, will have a look and test with i2pd.",
      "created_at" : "2023-01-06T20:19:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26837#issuecomment-1374088179",
      "id" : 1374088179,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26837",
      "node_id" : "IC_kwDOABII585R5uvz",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1374088179/reactions"
      },
      "updated_at" : "2023-01-06T20:19:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1374088179",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2023-01-07T02:58:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26837#issuecomment-1374359846",
      "id" : 1374359846,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26837",
      "node_id" : "IC_kwDOABII585R6xEm",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1374359846/reactions"
      },
      "updated_at" : "2023-01-07T02:58:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1374359846",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/94559964?v=4",
         "events_url" : "https://api.github.com/users/1440000bytes/events{/privacy}",
         "followers_url" : "https://api.github.com/users/1440000bytes/followers",
         "following_url" : "https://api.github.com/users/1440000bytes/following{/other_user}",
         "gists_url" : "https://api.github.com/users/1440000bytes/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/1440000bytes",
         "id" : 94559964,
         "login" : "1440000bytes",
         "node_id" : "U_kgDOBaLe3A",
         "organizations_url" : "https://api.github.com/users/1440000bytes/orgs",
         "received_events_url" : "https://api.github.com/users/1440000bytes/received_events",
         "repos_url" : "https://api.github.com/users/1440000bytes/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/1440000bytes/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/1440000bytes/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/1440000bytes"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "With `i2pacceptincoming=0 onlynet=i2p` and this PR (57fd27fd3621e782652c280d99263589fb3697a1):\r\n\r\n* In the first 5 minutes 10 sessions were created (= one session creation per 30 seconds). During that time 19 connection failures occurred, whose sessions were reused for subsequent attempts due to this PR. Without it, it would be 29 (10+19) instead of 10.\r\n* In the next 18 hours 264 sessions were created (= one session creation per 4 minutes). During that time 234 connection failures occurred.\r\n\r\nWithout `onlynet=i2p` the numbers would be much lower since other networks would also be tried.\r\n\r\n@zzzi2p, does that look reasonable?",
      "created_at" : "2023-01-07T14:18:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26837#issuecomment-1374496243",
      "id" : 1374496243,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26837",
      "node_id" : "IC_kwDOABII585R7SXz",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1374496243/reactions"
      },
      "updated_at" : "2023-01-07T14:18:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1374496243",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26837#discussion_r1064010311"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26837"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064010311"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I am wondering if `m_i2p_sessions` can grow unchecked to the point of using too much memory and whether it should be capped.\r\n\r\nIf this is run by a single thread then the size of `m_i2p_sessions` can be either 0 or 1 because in order to create a new session, the list must be empty and then if the connection fails it will be added to the list. If run by N threads, then the size can be at most N, if all of the threads race into it.\r\n\r\nI think that is ok with the current pattern of add 1, take 1. Just a note to the future - if the code is changed to add more entries to the list and it takes.",
      "commit_id" : "57fd27fd3621e782652c280d99263589fb3697a1",
      "created_at" : "2023-01-07T14:30:01Z",
      "diff_hunk" : "@@ -496,8 +496,21 @@ CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCo\n             if (m_i2p_sam_session) {\n                 connected = m_i2p_sam_session->Connect(addrConnect, conn, proxyConnectionFailed);\n             } else {\n-                i2p_transient_session = std::make_unique<i2p::sam::Session>(proxy.proxy, &interruptNet);\n+                {\n+                    LOCK(m_i2p_sessions_mutex);\n+                    if (m_i2p_sessions.empty()) {\n+                        i2p_transient_session =\n+                            std::make_unique<i2p::sam::Session>(proxy.proxy, &interruptNet);\n+                    } else {\n+                        i2p_transient_session.swap(m_i2p_sessions.front());\n+                        m_i2p_sessions.pop();\n+                    }\n+                }\n                 connected = i2p_transient_session->Connect(addrConnect, conn, proxyConnectionFailed);\n+                if (!connected) {\n+                    LOCK(m_i2p_sessions_mutex);\n+                    m_i2p_sessions.emplace(i2p_transient_session.release());\n+                }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26837#discussion_r1064010311",
      "id" : 1064010311,
      "line" : 513,
      "node_id" : "PRRC_kwDOABII584_a4JH",
      "original_commit_id" : "57fd27fd3621e782652c280d99263589fb3697a1",
      "original_line" : 513,
      "original_position" : 19,
      "original_start_line" : 499,
      "path" : "src/net.cpp",
      "position" : 19,
      "pull_request_review_id" : 1239675900,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26837",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064010311/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 499,
      "start_side" : "RIGHT",
      "updated_at" : "2023-01-07T14:30:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064010311",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "ACK, thank you very much.\r\n\r\nThis helps my thesis that it was mainly a startup problem that would drive the router into congestion. The key is you've gone from 290 tunnels at startup down to 22, which is a massive massive improvement.\r\n\r\nA couple notes:\r\n\r\n- You should monitor/test the reliability of connections over transient tunnels with *.quantity=1. If it doesn't meet your requirements, retest with *.quantity=2 to see if that improves things enough to be worth the additional resource usage.\r\n- You should monitor/test the performance of non-transient tunnels with *.quantity=3. If it doesn't meet your requirements, try 4 or 5 to see if that improves things enough to be worth the additional resource usage.\r\n- Agreed you want to avoid a pool with lots of unused sessions for a long time, either by design or some check. Also maybe close all idle sessions once you get to 10 good ones? Up to you, you're on the right track here.\r\n- Try to get an ack from i2pd's @orignal",
      "created_at" : "2023-01-07T18:10:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26837#issuecomment-1374557660",
      "id" : 1374557660,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26837",
      "node_id" : "IC_kwDOABII585R7hXc",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1374557660/reactions"
      },
      "updated_at" : "2023-01-07T18:10:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1374557660",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/62618568?v=4",
         "events_url" : "https://api.github.com/users/zzzi2p/events{/privacy}",
         "followers_url" : "https://api.github.com/users/zzzi2p/followers",
         "following_url" : "https://api.github.com/users/zzzi2p/following{/other_user}",
         "gists_url" : "https://api.github.com/users/zzzi2p/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/zzzi2p",
         "id" : 62618568,
         "login" : "zzzi2p",
         "node_id" : "MDQ6VXNlcjYyNjE4NTY4",
         "organizations_url" : "https://api.github.com/users/zzzi2p/orgs",
         "received_events_url" : "https://api.github.com/users/zzzi2p/received_events",
         "repos_url" : "https://api.github.com/users/zzzi2p/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/zzzi2p/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/zzzi2p/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/zzzi2p"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Looks good",
      "created_at" : "2023-01-07T20:38:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26837#issuecomment-1374604629",
      "id" : 1374604629,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26837",
      "node_id" : "IC_kwDOABII585R7s1V",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1374604629/reactions"
      },
      "updated_at" : "2023-01-07T20:38:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1374604629",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5358364?v=4",
         "events_url" : "https://api.github.com/users/orignal/events{/privacy}",
         "followers_url" : "https://api.github.com/users/orignal/followers",
         "following_url" : "https://api.github.com/users/orignal/following{/other_user}",
         "gists_url" : "https://api.github.com/users/orignal/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/orignal",
         "id" : 5358364,
         "login" : "orignal",
         "node_id" : "MDQ6VXNlcjUzNTgzNjQ=",
         "organizations_url" : "https://api.github.com/users/orignal/orgs",
         "received_events_url" : "https://api.github.com/users/orignal/received_events",
         "repos_url" : "https://api.github.com/users/orignal/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/orignal/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/orignal/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/orignal"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Testing ATM with i2pd <strike>2.45.0</strike> now 2.45.0_1.\r\n\r\n> Without `onlynet=i2p` the numbers would be much lower since other networks would also be tried.\r\n\r\nWe discourage using only I2P enough in `doc/i2p.md` and this [article](https://jonatack.github.io/articles/using-alternative-p2p-networks-with-bitcoin-core) (and Tor is so popular with node operators) that I wonder if anyone is running bitcoind only over I2P.  Two that did reported it took 1-2 months for IBD.\r\n\r\nWhen running with all of the networks (clearnet/tor/i2p/cjdns), I rarely see more than 1 outbound I2P connection.\r\n\r\nFor instance, spun up a node running `-i2pacceptincoming=0` and only one single transient destination was created in the first hour. \r\n\r\n---\r\n\r\nUpdate: now running a node with i2p listening off and onlynet=tor/i2p/cjdns without clearnet and seeing ~3 transient destinations created/hour:\r\n\r\n```\r\n$ bitcoin-cli -netinfo\r\n\r\n        onion     i2p   cjdns   total   block  manual\r\nin         15       0       1      16\r\nout        11       1       0      13       2       3\r\ntotal      26       1       1      29\r\n```\r\n\r\n```\r\n$ grep \"Creating transient SAM session\" ~/.bitcoin/debug.log\r\n2023-01-09T17:56:31Z [i2p] Creating transient SAM session a92e43fc84 with 127.0.0.1:7656\r\n2023-01-09T17:58:57Z [i2p] Creating transient SAM session 7856a8a898 with 127.0.0.1:7656\r\n2023-01-09T18:05:05Z [i2p] Creating transient SAM session ed245cc8fa with 127.0.0.1:7656\r\n2023-01-09T18:32:13Z [i2p] Creating transient SAM session ddae5d177f with 127.0.0.1:7656\r\n2023-01-09T18:39:09Z [i2p] Creating transient SAM session 4a7f812350 with 127.0.0.1:7656\r\n2023-01-09T18:41:03Z [i2p] Creating transient SAM session 1207fc28da with 127.0.0.1:7656\r\n2023-01-09T19:22:27Z [i2p] Creating transient SAM session 703f938b98 with 127.0.0.1:7656\r\n2023-01-09T20:04:05Z [i2p] Creating transient SAM session 089261758e with 127.0.0.1:7656\r\n2023-01-09T20:10:06Z [i2p] Creating transient SAM session d2f3c81164 with 127.0.0.1:7656\r\n2023-01-09T21:01:40Z [i2p] Creating transient SAM session 30471f5bc3 with 127.0.0.1:7656\r\n```\r\n",
      "created_at" : "2023-01-09T17:11:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26837#issuecomment-1375968477",
      "id" : 1375968477,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26837",
      "node_id" : "IC_kwDOABII585SA5zd",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1375968477/reactions"
      },
      "updated_at" : "2023-01-10T00:46:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1375968477",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26837#discussion_r1064880693"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26837"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064880693"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit 74fa583, would adding this lock annotation only to the `ConnectNode` declaration suffice?\r\n\r\n(The corresponding lock assertion `AssertLockNotHeld(m_i2p_sessions_mutex);` should be added to the function definition.)",
      "commit_id" : "57fd27fd3621e782652c280d99263589fb3697a1",
      "created_at" : "2023-01-09T17:14:30Z",
      "diff_hunk" : "@@ -955,7 +956,7 @@ class CConnman\n     bool AlreadyConnectedToAddress(const CAddress& addr);\n \n     bool AttemptToEvictConnection();\n-    CNode* ConnectNode(CAddress addrConnect, const char *pszDest, bool fCountFailure, ConnectionType conn_type);\n+    CNode* ConnectNode(CAddress addrConnect, const char *pszDest, bool fCountFailure, ConnectionType conn_type) EXCLUSIVE_LOCKS_REQUIRED(!m_i2p_sessions_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26837#discussion_r1064880693",
      "id" : 1064880693,
      "line" : 959,
      "node_id" : "PRRC_kwDOABII584_eMo1",
      "original_commit_id" : "57fd27fd3621e782652c280d99263589fb3697a1",
      "original_line" : 959,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 45,
      "pull_request_review_id" : 1240859061,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26837",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064880693/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-09T17:14:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064880693",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26837#discussion_r1064932794"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26837"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064932794"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n     * Mutex protecting m_i2p_sessions.\r\n```\r\n-----\r\nThe role of this mutex and of the queue it guards might be more clearly named something like `m_unused_i2p_sessions` and `m_unused_i2p_sessions_mutex`.",
      "commit_id" : "57fd27fd3621e782652c280d99263589fb3697a1",
      "created_at" : "2023-01-09T17:59:40Z",
      "diff_hunk" : "@@ -1126,6 +1127,20 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * Mutex protecting m_i2p_sam_sessions.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26837#discussion_r1064932794",
      "id" : 1064932794,
      "line" : 1131,
      "node_id" : "PRRC_kwDOABII584_eZW6",
      "original_commit_id" : "57fd27fd3621e782652c280d99263589fb3697a1",
      "original_line" : 1131,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 54,
      "pull_request_review_id" : 1240940633,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26837",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064932794/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-09T17:59:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064932794",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26837#discussion_r1064943252"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26837"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064943252"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe only emplace if under a max size.\r\n\r\n```diff\r\n-                if (!connected) {\r\n+                if (!connected && m_i2p_sessions.size() < 10) {\r\n                     LOCK(m_i2p_sessions_mutex);\r\n                     m_i2p_sessions.emplace(i2p_transient_session.release());\r\n```\r\n",
      "commit_id" : "57fd27fd3621e782652c280d99263589fb3697a1",
      "created_at" : "2023-01-09T18:08:04Z",
      "diff_hunk" : "@@ -496,8 +496,21 @@ CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCo\n             if (m_i2p_sam_session) {\n                 connected = m_i2p_sam_session->Connect(addrConnect, conn, proxyConnectionFailed);\n             } else {\n-                i2p_transient_session = std::make_unique<i2p::sam::Session>(proxy.proxy, &interruptNet);\n+                {\n+                    LOCK(m_i2p_sessions_mutex);\n+                    if (m_i2p_sessions.empty()) {\n+                        i2p_transient_session =\n+                            std::make_unique<i2p::sam::Session>(proxy.proxy, &interruptNet);\n+                    } else {\n+                        i2p_transient_session.swap(m_i2p_sessions.front());\n+                        m_i2p_sessions.pop();\n+                    }\n+                }\n                 connected = i2p_transient_session->Connect(addrConnect, conn, proxyConnectionFailed);\n+                if (!connected) {\n+                    LOCK(m_i2p_sessions_mutex);\n+                    m_i2p_sessions.emplace(i2p_transient_session.release());\n+                }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26837#discussion_r1064943252",
      "id" : 1064943252,
      "in_reply_to_id" : 1064010311,
      "line" : 513,
      "node_id" : "PRRC_kwDOABII584_eb6U",
      "original_commit_id" : "57fd27fd3621e782652c280d99263589fb3697a1",
      "original_line" : 513,
      "original_position" : 19,
      "original_start_line" : 499,
      "path" : "src/net.cpp",
      "position" : 19,
      "pull_request_review_id" : 1240955475,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26837",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064943252/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 499,
      "start_side" : "RIGHT",
      "updated_at" : "2023-01-09T18:08:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1064943252",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2023-01-09T21:54:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26837#issuecomment-1376379927",
      "id" : 1376379927,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26837",
      "node_id" : "IC_kwDOABII585SCeQX",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1376379927/reactions"
      },
      "updated_at" : "2023-01-09T21:54:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1376379927",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "NONE",
      "body" : ">Why exactly is session creation not cheap?\r\n\r\nEvery session creates few tunnels. Tunnels creation is not cheap, because asymmetric crypto and KDF for each hop. ",
      "created_at" : "2023-01-10T18:06:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26837#issuecomment-1377653104",
      "id" : 1377653104,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26837",
      "node_id" : "IC_kwDOABII585SHVFw",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1377653104/reactions"
      },
      "updated_at" : "2023-01-10T18:06:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1377653104",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5358364?v=4",
         "events_url" : "https://api.github.com/users/orignal/events{/privacy}",
         "followers_url" : "https://api.github.com/users/orignal/followers",
         "following_url" : "https://api.github.com/users/orignal/following{/other_user}",
         "gists_url" : "https://api.github.com/users/orignal/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/orignal",
         "id" : 5358364,
         "login" : "orignal",
         "node_id" : "MDQ6VXNlcjUzNTgzNjQ=",
         "organizations_url" : "https://api.github.com/users/orignal/orgs",
         "received_events_url" : "https://api.github.com/users/orignal/received_events",
         "repos_url" : "https://api.github.com/users/orignal/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/orignal/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/orignal/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/orignal"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Why exactly is session creation not cheap?\r\n\r\nPer the OP in #26754: *...some limit on the number of addresses (aka destinations or tunnels) built by the bitcoin client is necessary. I2P Destinations are designed to be long-lived, it's not like in Tor where you can create tons of circuits. Waiting for tunnels to be built for each connection also adds a huge amount of delay to connection setup time.  A high number of addresses will also result in excessive CPU and bandwidth usage by your router to build the tunnels for each. Additionally, other routers will reject your excessive tunnel building, which will increase your resource usage even more as your router retries. And, of course, the overhead applies to every connection attempt, not just every successful connection.*\r\n\r\nLocally, I'm seeing between 45-100 seconds for a successful transient I2P connection to be established, based on the \"Creating transient SAM session xyz\" and \"Transient SAM session xyz created\" logging in `src/i2p.cpp`.\r\n",
      "created_at" : "2023-01-10T18:12:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26837#issuecomment-1377659594",
      "id" : 1377659594,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26837",
      "node_id" : "IC_kwDOABII585SHWrK",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1377659594/reactions"
      },
      "updated_at" : "2023-01-10T18:55:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1377659594",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "@mzumsande re: why not cheap, in addition to what orignal said:\r\n\r\n- a tunnel is a bandwidth commitment by 3 peers, who have finite capacity, for 10 minutes\r\n- the asymmetric crypto is both locally and at each peer\r\n- the tunnel build request and response themselves require bandwidth\r\n- if any peer rejects or drops the request, esp. in times of congestion, the whole build process begins again\r\n- each peer doesn't \"know\" if the other peers agreed, and if it agrees must allocate capacity for the tunnel regardless\r\n\r\nyou can see how careful congestion strategies in the router are required to prevent congestion collapse, where failed tunnel builds lead to more failed builds\r\n\r\n\"local\" or \"client\" tunnels created by SAM are different from \"transit\" or \"participating\" tunnels created by others, and for the most part, one won't affect the other, until we approach bandwidth or CPU limits.\r\n",
      "created_at" : "2023-01-11T00:42:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26837#issuecomment-1378085753",
      "id" : 1378085753,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26837",
      "node_id" : "IC_kwDOABII585SI-t5",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1378085753/reactions"
      },
      "updated_at" : "2023-01-11T00:42:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1378085753",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/62618568?v=4",
         "events_url" : "https://api.github.com/users/zzzi2p/events{/privacy}",
         "followers_url" : "https://api.github.com/users/zzzi2p/followers",
         "following_url" : "https://api.github.com/users/zzzi2p/following{/other_user}",
         "gists_url" : "https://api.github.com/users/zzzi2p/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/zzzi2p",
         "id" : 62618568,
         "login" : "zzzi2p",
         "node_id" : "MDQ6VXNlcjYyNjE4NTY4",
         "organizations_url" : "https://api.github.com/users/zzzi2p/orgs",
         "received_events_url" : "https://api.github.com/users/zzzi2p/received_events",
         "repos_url" : "https://api.github.com/users/zzzi2p/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/zzzi2p/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/zzzi2p/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/zzzi2p"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> You should monitor/test the reliability of connections over transient tunnels with *.quantity=1\r\n\r\nI ran two nodes for about 20 hours each - one with `*.quantity=1` and one with `*.quantity=3`. I recorded the time when each I2P session was created and its duration (time between `Creating transient SAM session X` and `Destroying SAM session X`). Running with `i2pacceptincoming=0 onlynet=i2p`. Here are the results:\r\n\r\n![1tunnel_timeline](https://user-images.githubusercontent.com/266751/211789406-dca3b9e4-f87a-44fa-b588-b54bd6e02e6a.svg)\r\n![3tunnel_timeline](https://user-images.githubusercontent.com/266751/211789410-67a3c72a-7993-413c-8f23-a53e59ec2e6c.svg)\r\n\r\nIt looks ok - the points in the \"1 tunnel\" case are not visibly lower than in the \"3 tunnel\" case. I guess if connections are dropped frequently and unexpectedly due to low tunnel count, then the durations would be lower.",
      "created_at" : "2023-01-11T11:05:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26837#issuecomment-1378581439",
      "id" : 1378581439,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26837",
      "node_id" : "IC_kwDOABII585SK3u_",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1378581439/reactions"
      },
      "updated_at" : "2023-01-11T11:05:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1378581439",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26837#discussion_r1066943150"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26837"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1066943150"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fair enough, not too difficult to add a cap. Done.",
      "commit_id" : "57fd27fd3621e782652c280d99263589fb3697a1",
      "created_at" : "2023-01-11T12:38:54Z",
      "diff_hunk" : "@@ -496,8 +496,21 @@ CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCo\n             if (m_i2p_sam_session) {\n                 connected = m_i2p_sam_session->Connect(addrConnect, conn, proxyConnectionFailed);\n             } else {\n-                i2p_transient_session = std::make_unique<i2p::sam::Session>(proxy.proxy, &interruptNet);\n+                {\n+                    LOCK(m_i2p_sessions_mutex);\n+                    if (m_i2p_sessions.empty()) {\n+                        i2p_transient_session =\n+                            std::make_unique<i2p::sam::Session>(proxy.proxy, &interruptNet);\n+                    } else {\n+                        i2p_transient_session.swap(m_i2p_sessions.front());\n+                        m_i2p_sessions.pop();\n+                    }\n+                }\n                 connected = i2p_transient_session->Connect(addrConnect, conn, proxyConnectionFailed);\n+                if (!connected) {\n+                    LOCK(m_i2p_sessions_mutex);\n+                    m_i2p_sessions.emplace(i2p_transient_session.release());\n+                }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26837#discussion_r1066943150",
      "id" : 1066943150,
      "in_reply_to_id" : 1064010311,
      "line" : 513,
      "node_id" : "PRRC_kwDOABII584_mEKu",
      "original_commit_id" : "57fd27fd3621e782652c280d99263589fb3697a1",
      "original_line" : 513,
      "original_position" : 19,
      "original_start_line" : 499,
      "path" : "src/net.cpp",
      "position" : 19,
      "pull_request_review_id" : 1243834333,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26837",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1066943150/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 499,
      "start_side" : "RIGHT",
      "updated_at" : "2023-01-11T12:38:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1066943150",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26837#discussion_r1066958395"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26837"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1066958395"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> would adding this lock annotation only to the `ConnectNode` declaration suffice?\r\n\r\nNo, all callers of `EXCLUSIVE_LOCKS_REQUIRED(!m)` must also be tagged with the same annotation. Otherwise:\r\n\r\n```\r\nnet.cpp:1995:20: error: calling function 'ConnectNode' requires negative capability '!m_unused_i2p_sessions_mutex' [-Werror,-Wthread-safety-analysis]\r\n    CNode* pnode = ConnectNode(addrConnect, pszDest, fCountFailure, conn_type);\r\n                   ^\r\n```\r\n\r\nAdded `AssertLockNotHeld()` calls to methods marked with `EXCLUSIVE_LOCKS_REQUIRED(!m_unused_i2p_sessions_mutex)`",
      "commit_id" : "57fd27fd3621e782652c280d99263589fb3697a1",
      "created_at" : "2023-01-11T12:55:26Z",
      "diff_hunk" : "@@ -955,7 +956,7 @@ class CConnman\n     bool AlreadyConnectedToAddress(const CAddress& addr);\n \n     bool AttemptToEvictConnection();\n-    CNode* ConnectNode(CAddress addrConnect, const char *pszDest, bool fCountFailure, ConnectionType conn_type);\n+    CNode* ConnectNode(CAddress addrConnect, const char *pszDest, bool fCountFailure, ConnectionType conn_type) EXCLUSIVE_LOCKS_REQUIRED(!m_i2p_sessions_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26837#discussion_r1066958395",
      "id" : 1066958395,
      "in_reply_to_id" : 1064880693,
      "line" : 959,
      "node_id" : "PRRC_kwDOABII584_mH47",
      "original_commit_id" : "57fd27fd3621e782652c280d99263589fb3697a1",
      "original_line" : 959,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 45,
      "pull_request_review_id" : 1243857392,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26837",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1066958395/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-11T12:55:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1066958395",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26837#discussion_r1066958740"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26837"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1066958740"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Renamed.",
      "commit_id" : "57fd27fd3621e782652c280d99263589fb3697a1",
      "created_at" : "2023-01-11T12:55:47Z",
      "diff_hunk" : "@@ -1126,6 +1127,20 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * Mutex protecting m_i2p_sam_sessions.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26837#discussion_r1066958740",
      "id" : 1066958740,
      "in_reply_to_id" : 1064932794,
      "line" : 1131,
      "node_id" : "PRRC_kwDOABII584_mH-U",
      "original_commit_id" : "57fd27fd3621e782652c280d99263589fb3697a1",
      "original_line" : 1131,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 54,
      "pull_request_review_id" : 1243857884,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26837",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1066958740/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-01-11T12:55:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1066958740",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   }
]
