[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#25118](https://github.com/bitcoin/bitcoin/pull/25118) (wallet: unify âallow/block other inputsâ concept by furszy)\n* [#25083](https://github.com/bitcoin/bitcoin/pull/25083) (Set effective_value when initializing a COutput by ishaanam)\n* [#24699](https://github.com/bitcoin/bitcoin/pull/24699) (wallet: Improve AvailableCoins performance by reducing duplicated operations by achow101)\n* [#24584](https://github.com/bitcoin/bitcoin/pull/24584) (wallet: avoid mixing different `OutputTypes` during coin selection by josibake)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-04-28T02:00:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25005#issuecomment-1111657636",
      "id" : 1111657636,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25005",
      "node_id" : "IC_kwDOABII585CQoyk",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1111657636/reactions"
      },
      "updated_at" : "2022-05-18T09:49:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1111657636",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@furszy It looks like the qt wallet test is failing in the CI. You can run `./src/qt/test/test_bitcoin-qt` in your dev environment to reproduce and debug the issue.",
      "created_at" : "2022-04-28T10:45:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25005#issuecomment-1112056877",
      "id" : 1112056877,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25005",
      "node_id" : "IC_kwDOABII585CSKQt",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1112056877/reactions"
      },
      "updated_at" : "2022-04-28T10:45:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1112056877",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Ah, thanks @jonatack ð. Just noticed that the GUI `WalletTests` isn't run by default in my OS under `make check`.\r\n\r\nIt's an easy fix; as the test doesn't start the balance polling timer, the model does not have the balance cached so.. as 5babfb7 make uses of it, the creation process fails with a not-enough balance error.\r\n\r\nWill push the fix and expand + improve the test coverage a bit more.\r\nAnd.. most likely will decouple that last commit into a separate PR in few days. Have some further improvements locally for the wallet model area that can package out all together that aren't really part of the scope of this PR.\r\n(like a mutex to be able to access the model cached balance from different threads, connect it to the widgets etc..)",
      "created_at" : "2022-04-28T14:01:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25005#issuecomment-1112243680",
      "id" : 1112243680,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25005",
      "node_id" : "IC_kwDOABII585CS33g",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1112243680/reactions"
      },
      "updated_at" : "2022-04-28T14:19:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1112243680",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> 6) The GUI `WalletModel::prepareTransaction` will now use the cached balance to make the funds availability check if the user didn't manually selected outputs to spend. This will avoid an entire on-demand recalculation of the available balance which is quite expensive as the wallet has to walk through the entire txs map.\r\n\r\nDropped the last two commits that were implementing point (6) described above. They are now part of https://github.com/bitcoin-core/gui/pull/598",
      "created_at" : "2022-05-09T20:58:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25005#issuecomment-1121574208",
      "id" : 1121574208,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25005",
      "node_id" : "IC_kwDOABII585C2d1A",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1121574208/reactions"
      },
      "updated_at" : "2022-05-10T15:03:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1121574208",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25005#discussion_r874124981"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25005"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/874124981"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 2cdd2a1a5498cb8767799dd26a4082e9d3b064ee \"wallet: speedup 'GetAvailableBalance' filtering by spendable outputs only and using the 'AvailableCoins' retrieved total_amount.\"\r\n\r\nWhat is the purpose of the rename and making an empty `CCoinControl` here? `AvailableCoins` can take `nullptr` for `coinControl`.",
      "commit_id" : "2cdd2a1a5498cb8767799dd26a4082e9d3b064ee",
      "created_at" : "2022-05-16T20:23:45Z",
      "diff_hunk" : "@@ -225,17 +223,13 @@ CoinsResult AvailableCoins(const CWallet& wallet,\n     return result;\n }\n \n-CAmount GetAvailableBalance(const CWallet& wallet, const CCoinControl* coinControl)\n+CAmount GetAvailableBalance(const CWallet& wallet, const CCoinControl* _coinControl)\n {\n     LOCK(wallet.cs_wallet);\n-\n-    CAmount balance = 0;\n-    for (const COutput& out : AvailableCoins(wallet, coinControl).coins) {\n-        if (out.spendable) {\n-            balance += out.txout.nValue;\n-        }\n-    }\n-    return balance;\n+    // Copy to filter by spendable coins only\n+    CCoinControl coinControl = _coinControl ? *_coinControl : CCoinControl();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25005#discussion_r874124981",
      "id" : 874124981,
      "line" : 230,
      "node_id" : "PRRC_kwDOABII5840Gha1",
      "original_commit_id" : "2cdd2a1a5498cb8767799dd26a4082e9d3b064ee",
      "original_line" : 230,
      "original_position" : 40,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 40,
      "pull_request_review_id" : 974523072,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25005",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/874124981/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-16T20:27:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/874124981",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Hey achow101, thanks for the review!\r\n\r\n> I don't quite understand the purpose of the first commit. It doesn't seem like it materially improves anything?\r\n\r\nWe are skipping the non-spendable coins that appear in `vCoins` (`AvailableCoins` result) later, in several parts of the `CreateTransaction` and `GetBalance` flows:\r\n\r\n1.  `GetAvailableBalance` was (1) getting all the available coins calling `AvailableCoins` and, right away, walking through the entire vector, skipping the non-spendable coins, to calculate the total balance.â¨\r\n\r\n2. Inside `CreateTransactionInternal` â> `SelectCoins(vCoins,...)`, we have several calls to `AttemptSelection` which, on each of them internally, we call twice to `GroupOutputs` which internally has two for-loops over the entire `vCoins` vector that skip the non-spendable coins.\r\n\r\nSo, the purpose is not add the non-spendable coins into the `AvailableCoins` result (`vCoins`) in the first place for the processes that arenât using them at all, so we donât waste resources skipping them later so many times.\r\n\r\nNote: this speedup is for all the processes that calls to `CreateTransaction` and `GetBalance*` internally.",
      "created_at" : "2022-05-21T17:54:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25005#issuecomment-1133735550",
      "id" : 1133735550,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25005",
      "node_id" : "IC_kwDOABII585Dk25-",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1133735550/reactions"
      },
      "updated_at" : "2022-05-21T17:54:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1133735550",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   }
]
