[
   {
      "body" : "Concept ACK.",
      "created_at" : "2016-05-06T20:24:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8020#issuecomment-217549274",
      "id" : 217549274,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8020",
      "updated_at" : "2016-05-06T20:24:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/217549274",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "Concept ACK\r\nad00e3af31df0655c1cdc95b8d29dcc1ec413e5b",
      "created_at" : "2016-05-06T21:11:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8020#issuecomment-217559544",
      "id" : 217559544,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8020",
      "updated_at" : "2016-05-06T21:11:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/217559544",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/620611?v=3",
         "events_url" : "https://api.github.com/users/pstratem/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pstratem/followers",
         "following_url" : "https://api.github.com/users/pstratem/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pstratem/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pstratem",
         "id" : 620611,
         "login" : "pstratem",
         "organizations_url" : "https://api.github.com/users/pstratem/orgs",
         "received_events_url" : "https://api.github.com/users/pstratem/received_events",
         "repos_url" : "https://api.github.com/users/pstratem/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pstratem/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pstratem"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8020#discussion_r62408348"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8020"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/62408348"
         }
      },
      "body" : "What if pnode is 32-bit?",
      "commit_id" : "ed521703dc23c5ab28e7ba768a73422cb2d3b315",
      "created_at" : "2016-05-07T01:06:25Z",
      "diff_hunk" : "@@ -4704,25 +4704,24 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n                     LOCK(cs_vNodes);\n                     // Use deterministic randomness to send to the same nodes for 24 hours\n                     // at a time so the addrKnowns of the chosen nodes prevent repeats\n-                    static uint256 hashSalt;\n-                    if (hashSalt.IsNull())\n-                        hashSalt = GetRandHash();\n+                    static uint64_t salt0 = 0, salt1 = 0;\n+                    while (salt0 == 0 && salt1 == 0) {\n+                        GetRandBytes((unsigned char*)&salt0, sizeof(salt0));\n+                        GetRandBytes((unsigned char*)&salt1, sizeof(salt1));\n+                    }\n                     uint64_t hashAddr = addr.GetHash();\n-                    uint256 hashRand = ArithToUint256(UintToArith256(hashSalt) ^ (hashAddr<<32) ^ ((GetTime()+hashAddr)/(24*60*60)));\n-                    hashRand = Hash(BEGIN(hashRand), END(hashRand));\n-                    multimap<uint256, CNode*> mapMix;\n+                    multimap<uint64_t, CNode*> mapMix;\n                     BOOST_FOREACH(CNode* pnode, vNodes)\n                     {\n                         if (pnode->nVersion < CADDR_TIME_VERSION)\n                             continue;\n-                        unsigned int nPointer;\n+                        uint64_t nPointer = 0;\n                         memcpy(&nPointer, &pnode, sizeof(nPointer));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8020#discussion_r62408348",
      "id" : 62408348,
      "original_commit_id" : "ad00e3af31df0655c1cdc95b8d29dcc1ec413e5b",
      "original_position" : 23,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8020",
      "updated_at" : "2016-05-07T02:24:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/62408348",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1047859?v=3",
         "events_url" : "https://api.github.com/users/kazcw/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kazcw/followers",
         "following_url" : "https://api.github.com/users/kazcw/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kazcw/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kazcw",
         "id" : 1047859,
         "login" : "kazcw",
         "organizations_url" : "https://api.github.com/users/kazcw/orgs",
         "received_events_url" : "https://api.github.com/users/kazcw/received_events",
         "repos_url" : "https://api.github.com/users/kazcw/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kazcw/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kazcw/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kazcw"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8020#discussion_r62409947"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8020"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/62409947"
         }
      },
      "body" : "Nice catch. I've replaced it by using pnode->id.",
      "commit_id" : "ed521703dc23c5ab28e7ba768a73422cb2d3b315",
      "created_at" : "2016-05-07T02:25:26Z",
      "diff_hunk" : "@@ -4704,25 +4704,24 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n                     LOCK(cs_vNodes);\n                     // Use deterministic randomness to send to the same nodes for 24 hours\n                     // at a time so the addrKnowns of the chosen nodes prevent repeats\n-                    static uint256 hashSalt;\n-                    if (hashSalt.IsNull())\n-                        hashSalt = GetRandHash();\n+                    static uint64_t salt0 = 0, salt1 = 0;\n+                    while (salt0 == 0 && salt1 == 0) {\n+                        GetRandBytes((unsigned char*)&salt0, sizeof(salt0));\n+                        GetRandBytes((unsigned char*)&salt1, sizeof(salt1));\n+                    }\n                     uint64_t hashAddr = addr.GetHash();\n-                    uint256 hashRand = ArithToUint256(UintToArith256(hashSalt) ^ (hashAddr<<32) ^ ((GetTime()+hashAddr)/(24*60*60)));\n-                    hashRand = Hash(BEGIN(hashRand), END(hashRand));\n-                    multimap<uint256, CNode*> mapMix;\n+                    multimap<uint64_t, CNode*> mapMix;\n                     BOOST_FOREACH(CNode* pnode, vNodes)\n                     {\n                         if (pnode->nVersion < CADDR_TIME_VERSION)\n                             continue;\n-                        unsigned int nPointer;\n+                        uint64_t nPointer = 0;\n                         memcpy(&nPointer, &pnode, sizeof(nPointer));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8020#discussion_r62409947",
      "id" : 62409947,
      "original_commit_id" : "ad00e3af31df0655c1cdc95b8d29dcc1ec413e5b",
      "original_position" : 23,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8020",
      "updated_at" : "2016-05-07T02:25:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/62409947",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Concept ACK\r\nPython took the same step for 3.4 to convert their hash algorithms to SipHash, and they have similar motivations of mitigating collision attacks, so we're in good company: https://www.python.org/dev/peps/pep-0456/\r\n",
      "created_at" : "2016-05-07T08:27:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8020#issuecomment-217618882",
      "id" : 217618882,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8020",
      "updated_at" : "2016-05-07T08:29:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/217618882",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Here is a comment about using SipHash-1-3 instead of SipHash-2-4: https://github.com/rust-lang/rust/issues/29754#issuecomment-156073946\r\n\r\nIt would be approximately twice as fast for hashing txids, and the distinguisher mentioned in that comment is not relevant for data that is a multiple of 8 bytes (which is the case for us), as 8 bytes of padding are added in that case. Opinions?",
      "created_at" : "2016-05-08T23:13:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8020#issuecomment-217751991",
      "id" : 217751991,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8020",
      "updated_at" : "2016-05-08T23:13:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/217751991",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Siphash 2-4 seems to be the defacto 'safe' choice. Siphash 1-3 happens to be secure for our use case right now, but that sounds a tad brittle: as if a small change in our use case, or a small advancement in cryptoanalysis of the function, could mean that the known weakness does suddenly affect us?\r\n\r\nNot sure how much hashing the txids is a bottleneck in the whole scheme of things around CCoinsCache, it's only 32 bytes after all. Conservatively I'd say only consider 'downgrading' if performance is seriously affected by going from 29 cycles to 49 cycles.\r\n\r\nOn the other hand it's pretty nice if using a hash with better security properties could be *faster* than the Lookup3/XOR scheme, so I see the attraction in that.\r\n",
      "created_at" : "2016-05-09T10:39:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8020#issuecomment-217831712",
      "id" : 217831712,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8020",
      "updated_at" : "2016-05-09T10:39:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/217831712",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   }
]
