[
   {
      "body" : "nit: Might be worthwhile to print out the cmpctblk version being reconstructed in debug log\r\n\r\nnit aside, utACK https://github.com/bitcoin/bitcoin/pull/8393/commits/1b417c20a6b0205a98268f95e6e19d27def076e9",
      "created_at" : "2016-07-22T16:45:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#issuecomment-234594686",
      "id" : 234594686,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8393",
      "updated_at" : "2016-07-22T16:45:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/234594686",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "body" : "Tested ACK 1b417c2 (I tested this branch extensively before this PR was opened).\r\n\r\n",
      "created_at" : "2016-07-22T16:48:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#issuecomment-234595302",
      "id" : 234595302,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8393",
      "updated_at" : "2016-07-22T16:48:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/234595302",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7275704?v=3",
         "events_url" : "https://api.github.com/users/btcdrak/events{/privacy}",
         "followers_url" : "https://api.github.com/users/btcdrak/followers",
         "following_url" : "https://api.github.com/users/btcdrak/following{/other_user}",
         "gists_url" : "https://api.github.com/users/btcdrak/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/btcdrak",
         "id" : 7275704,
         "login" : "btcdrak",
         "organizations_url" : "https://api.github.com/users/btcdrak/orgs",
         "received_events_url" : "https://api.github.com/users/btcdrak/received_events",
         "repos_url" : "https://api.github.com/users/btcdrak/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/btcdrak/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/btcdrak/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/btcdrak"
      }
   },
   {
      "body" : "utACK 1b417c2 I will write some tests with NBitcoin soon.",
      "created_at" : "2016-07-24T04:50:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#issuecomment-234757666",
      "id" : 234757666,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8393",
      "updated_at" : "2016-07-24T04:50:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/234757666",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3020646?v=3",
         "events_url" : "https://api.github.com/users/NicolasDorier/events{/privacy}",
         "followers_url" : "https://api.github.com/users/NicolasDorier/followers",
         "following_url" : "https://api.github.com/users/NicolasDorier/following{/other_user}",
         "gists_url" : "https://api.github.com/users/NicolasDorier/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/NicolasDorier",
         "id" : 3020646,
         "login" : "NicolasDorier",
         "organizations_url" : "https://api.github.com/users/NicolasDorier/orgs",
         "received_events_url" : "https://api.github.com/users/NicolasDorier/received_events",
         "repos_url" : "https://api.github.com/users/NicolasDorier/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/NicolasDorier/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/NicolasDorier/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/NicolasDorier"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8393#discussion_r72060387"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8393"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/72060387"
         }
      },
      "body" : "This means that prior to segwit activation, blocks found by unupgraded miners will propagate without the benefit of compactblock announcements to upgraded nodes.\r\n\r\nPerhaps it'd be better to instead use the BIP9 LOCKED_IN window to transition from receiving compactblock announcements from any peer regardless of nServices, towards NODE_WITNESS peers, and once ACTIVE state is reached, we enforce that all announcing peers are NODE_WITNESS?\r\n\r\nTo be concrete, here's one suggestion:\r\n 1. before LOCKED_IN, use existing algorithm\r\n 1. after LOCKED_IN, don't allow NODE_WITNESS peers to be evicted by non-WITNESS peers, and preferentially first evict non-WITNESS peers when trying to add a WITNESS peer\r\n 1. after ACTIVATED, evict any non-WITNESS peers we have left making announcements.\r\n\r\nI think this ought to provide a smooth transition, but I actually am not sure we even need that second step, we can probably be a little more disruptive around the LOCKED_IN time to ensure that we're ready at activation.",
      "commit_id" : "1b417c20a6b0205a98268f95e6e19d27def076e9",
      "created_at" : "2016-07-25T13:12:28Z",
      "diff_hunk" : "@@ -476,16 +479,16 @@ void UpdateBlockAvailability(NodeId nodeid, const uint256 &hash) {\n }\n \n void MaybeSetPeerAsAnnouncingHeaderAndIDs(const CNodeState* nodestate, CNode* pfrom) {\n-    if (nLocalServices & NODE_WITNESS) {\n-        // Don't ever request compact blocks when segwit is enabled.\n+    if (nLocalServices & ~pfrom->nServices & NODE_WITNESS) {\n+        // Never ask from peers who can't provide witnesses.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#discussion_r72060387",
      "id" : 72060387,
      "original_commit_id" : "1b417c20a6b0205a98268f95e6e19d27def076e9",
      "original_position" : 24,
      "path" : "src/main.cpp",
      "position" : 24,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8393",
      "updated_at" : "2016-07-25T13:12:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/72060387",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "Reminder for myself: adapt to use the suggestion from BIP152 to just send both sendcmpct version 1 and version 2 (and let the 2 be ignored by pre-witness peers), rather than trying to guess what the peer will want based on service flags. Suggested by @TheBlueMatt",
      "created_at" : "2016-07-25T23:37:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#issuecomment-235118990",
      "id" : 235118990,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8393",
      "updated_at" : "2016-07-25T23:37:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/235118990",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Implemented the suggestion above.",
      "created_at" : "2016-07-30T01:34:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#issuecomment-236331258",
      "id" : 236331258,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8393",
      "updated_at" : "2016-07-30T01:34:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/236331258",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Fixed a bug found by @sdaftuar (see #8418).",
      "created_at" : "2016-07-30T18:22:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8393#issuecomment-236381021",
      "id" : 236381021,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8393",
      "updated_at" : "2016-07-30T18:22:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/236381021",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   }
]
