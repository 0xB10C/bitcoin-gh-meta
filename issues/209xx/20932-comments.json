[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20932#discussion_r557365662"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20932"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/557365662"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n     * @return \\p p if \\p p is an absolute path, otherwise \\p base joined with \\p p is returned.\r\n```",
      "commit_id" : "c0da7456833fac6d5613d97e09266cf54f13594f",
      "created_at" : "2021-01-14T12:39:43Z",
      "diff_hunk" : "@@ -21,6 +21,15 @@ namespace fs = boost::filesystem;\n namespace fsbridge {\n     FILE *fopen(const fs::path& p, const char *mode);\n \n+    /**\n+     * Helper function asserting that \\p base is an absolute path and returning the result of boost::filesystem::absolute(p, base) then.\n+     *\n+     * @param[in] base  Absolute path.\n+     * @param[in] p     Path to combine with \\p base.\n+     * @return \\p p if \\p p is an absolute path, othwerwise \\p base joined with \\p p is returned.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20932#discussion_r557365662",
      "id" : 557365662,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzM2NTY2Mg==",
      "original_commit_id" : "6d5947e1c6ba7384b7407fa429778272de518eb3",
      "original_line" : 29,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/fs.h",
      "position" : null,
      "pull_request_review_id" : 568194346,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20932",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-14T13:28:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/557365662",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/58662979?v=4",
         "events_url" : "https://api.github.com/users/kiminuo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kiminuo/followers",
         "following_url" : "https://api.github.com/users/kiminuo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kiminuo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kiminuo",
         "id" : 58662979,
         "login" : "kiminuo",
         "node_id" : "MDQ6VXNlcjU4NjYyOTc5",
         "organizations_url" : "https://api.github.com/users/kiminuo/orgs",
         "received_events_url" : "https://api.github.com/users/kiminuo/received_events",
         "repos_url" : "https://api.github.com/users/kiminuo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kiminuo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kiminuo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kiminuo"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #20017 (rpc: Add RPCContext by promag)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-01-14T15:35:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20932#issuecomment-760273962",
      "id" : 760273962,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20932",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2MDI3Mzk2Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-14T15:35:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/760273962",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm able to reproduce appveyor failure on linux with\r\n\r\n```\r\nmake -C src test/test_bitcoin && src/test/test_bitcoin -l test_suite -t init_tests -t wallet_tests/CreateWallet --random=2\r\n```\r\n\r\nTo reproduce, it may be necessary to vary the random seed to get CreateWallet test to run after the init_tests as happens on appveyor.\r\n\r\nThe problem seems to be that init_tests [force set](https://github.com/bitcoin/bitcoin/blob/f91587f050d9dceb45fe10129a76a4a9a060a09c/src/wallet/test/init_test_fixture.cpp#L45) a -walletdir that [GetWalletDir](https://github.com/bitcoin/bitcoin/blob/f91587f050d9dceb45fe10129a76a4a9a060a09c/src/wallet/walletutil.cpp#L16-L19) rejects and turns into an empty path, which gets rejected by the assert because it is not absolute.\r\n\r\nProbably a minimal fix is possible in init_tests. Backtrace at assert fail looks like\r\n\r\n```\r\n#0  __GI_raise (sig=sig@entry=6) at ../sysdeps/unix/sysv/linux/raise.c:51\r\n#1  0x00007ffff59b38b1 in __GI_abort () at abort.c:79\r\n#2  0x00007ffff59a342a in __assert_fail_base (fmt=0x7ffff5b2aa38 \"%s%s%s:%u: %s%sAssertion `%s' failed.\\n%n\", \r\n    assertion=assertion@entry=0x5555566fc54f \"base.is_absolute()\", file=file@entry=0x5555566fc548 \"fs.cpp\", line=line@entry=36, \r\n    function=function@entry=0x5555566fc600 <fsbridge::AbsPathJoin(boost::filesystem::path const&, boost::filesystem::path const&)::__PRETTY_FUNCTION__> \"boost::filesystem::path fsbridge::AbsPathJoin(const boost::filesystem::path&, const boost::filesystem::path&)\") at assert.c:92\r\n#3  0x00007ffff59a34a2 in __GI___assert_fail (assertion=0x5555566fc54f \"base.is_absolute()\", file=0x5555566fc548 \"fs.cpp\", line=36, \r\n    function=0x5555566fc600 <fsbridge::AbsPathJoin(boost::filesystem::path const&, boost::filesystem::path const&)::__PRETTY_FUNCTION__> \"boost::filesystem::path fsbridge::AbsPathJoin(const boost::filesystem::path&, const boost::filesystem::path&)\") at assert.c:101\r\n#4  0x000055555620de2f in fsbridge::AbsPathJoin (base=..., p=...) at fs.cpp:36\r\n#5  0x00005555563d5298 in MakeWalletDatabase (name=\"\", options=..., status=@0x7fffffffb57c: 21845, error_string=...) at wallet/wallet.cpp:3783\r\n#6  0x0000555555cd0d59 in wallet_tests::TestLoadWallet (chain=...) at wallet/test/wallet_tests.cpp:46\r\n#7  0x0000555555ce03f2 in wallet_tests::CreateWallet::test_method (this=0x7fffffffc9c0) at wallet/test/wallet_tests.cpp:699\r\n#8  0x0000555555cdf585 in wallet_tests::CreateWallet_invoker () at wallet/test/wallet_tests.cpp:696\r\n```\r\n\r\n",
      "created_at" : "2021-01-14T21:27:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20932#issuecomment-760487360",
      "id" : 760487360,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20932",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2MDQ4NzM2MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-14T21:27:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/760487360",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Following fix seems to work:\r\n\r\n```diff\r\n--- a/src/wallet/test/init_test_fixture.cpp\r\n+++ b/src/wallet/test/init_test_fixture.cpp\r\n@@ -3,6 +3,7 @@\r\n // file COPYING or http://www.opensource.org/licenses/mit-license.php.\r\n \r\n #include <fs.h>\r\n+#include <univalue.h>\r\n #include <util/check.h>\r\n #include <util/system.h>\r\n \r\n@@ -37,6 +38,9 @@ InitWalletDirTestingSetup::InitWalletDirTestingSetup(const std::string& chainNam\r\n \r\n InitWalletDirTestingSetup::~InitWalletDirTestingSetup()\r\n {\r\n+    gArgs.LockSettings([&](util::Settings& settings) {\r\n+        settings.forced_settings.erase(\"walletdir\");\r\n+    });\r\n     fs::current_path(m_cwd);\r\n }\r\n \r\n```\r\n\r\nWould suggest commit message like:\r\n\r\n> test: Clear forced -walletdir setting after wallet init_tests\r\n>\r\n> Leaving this value set interfered with the CreateWallet test if it happened to execute later in the test ordering. Specifically it would cause CreateWallet test to write data to the current directory instead of temporary test directory.",
      "created_at" : "2021-01-14T21:38:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20932#issuecomment-760492506",
      "id" : 760492506,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20932",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2MDQ5MjUwNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-14T21:38:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/760492506",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/20932#issue-554809577\r\n\r\n> This PR is based on @ryanofsky suggestion here [#20744 (review)](https://github.com/bitcoin/bitcoin/pull/20744#pullrequestreview-558131849) and it should help make #20744 diff smaller in the long run.\r\n\r\nWould suggest writing a self-contained PR description that doesn't require reading a comment in another issue to understand. Something like:\r\n\r\nrefactor: Replace fs::absolute calls with AbsPathJoin calls\r\n\r\nThis adds better test coverage and will make it easier in #20744 to remove our dependency on the two-argument `boost::filesystem::absolute()` function which does not have a direct equivalent in C++17.\r\n\r\nThis PR doesn't change behavior aside from adding an assert and fixing a test bug.\r\n\r\n\r\n",
      "created_at" : "2021-01-14T21:48:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20932#issuecomment-760497563",
      "id" : 760497563,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20932",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2MDQ5NzU2Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-14T21:48:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/760497563",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   }
]
