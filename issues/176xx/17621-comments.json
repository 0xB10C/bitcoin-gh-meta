[
   {
      "author_association" : "MEMBER",
      "body" : "cc @kallewoof since you designed the first iteration",
      "created_at" : "2019-11-27T16:11:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17621#issuecomment-559152851",
      "id" : 559152851,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17621",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1OTE1Mjg1MQ==",
      "updated_at" : "2019-11-27T16:11:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/559152851",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK\r\n\r\nTests please  :)",
      "created_at" : "2019-12-06T21:58:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17621#issuecomment-562752173",
      "id" : 562752173,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17621",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU2Mjc1MjE3Mw==",
      "updated_at" : "2019-12-06T21:59:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/562752173",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2019-12-06T23:13:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17621#issuecomment-562776453",
      "id" : 562776453,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17621",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU2Mjc3NjQ1Mw==",
      "updated_at" : "2019-12-06T23:13:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/562776453",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/250224?v=4",
         "events_url" : "https://api.github.com/users/kallewoof/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kallewoof/followers",
         "following_url" : "https://api.github.com/users/kallewoof/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kallewoof/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kallewoof",
         "id" : 250224,
         "login" : "kallewoof",
         "node_id" : "MDQ6VXNlcjI1MDIyNA==",
         "organizations_url" : "https://api.github.com/users/kallewoof/orgs",
         "received_events_url" : "https://api.github.com/users/kallewoof/received_events",
         "repos_url" : "https://api.github.com/users/kallewoof/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kallewoof/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kallewoof"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Pushed test, updated logic to fix test failure.\r\n\r\nRemoved a function that resulted in a used footgun.",
      "created_at" : "2019-12-09T15:38:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17621#issuecomment-563296236",
      "id" : 563296236,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17621",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU2MzI5NjIzNg==",
      "updated_at" : "2019-12-09T15:38:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/563296236",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17621#discussion_r358539866"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17621"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/358539866"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit, also add the EXCLUSIVE_LOCKS_REQUIRED annotation.",
      "commit_id" : "ef4a1a4941be5a4a018aedc5f4dc41cea3cb816e",
      "created_at" : "2019-12-17T00:42:35Z",
      "diff_hunk" : "@@ -719,17 +719,31 @@ void CWallet::SetUsedDestinationState(WalletBatch& batch, const uint256& hash, u\n     }\n }\n \n-bool CWallet::IsUsedDestination(const CTxDestination& dst) const\n-{\n-    LOCK(cs_wallet);\n-    return IsMine(dst) && GetDestData(dst, \"used\", nullptr);\n-}\n-\n bool CWallet::IsUsedDestination(const uint256& hash, unsigned int n) const\n {\n+    AssertLockHeld(cs_wallet);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17621#discussion_r358539866",
      "id" : 358539866,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1ODUzOTg2Ng==",
      "original_commit_id" : "ef4a1a4941be5a4a018aedc5f4dc41cea3cb816e",
      "original_position" : 12,
      "path" : "src/wallet/wallet.cpp",
      "position" : 12,
      "pull_request_review_id" : 332959521,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17621",
      "updated_at" : "2019-12-17T00:42:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/358539866",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17621#discussion_r358540779"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17621"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/358540779"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Should be `>`?",
      "commit_id" : "ef4a1a4941be5a4a018aedc5f4dc41cea3cb816e",
      "created_at" : "2019-12-17T00:46:26Z",
      "diff_hunk" : "@@ -719,17 +719,31 @@ void CWallet::SetUsedDestinationState(WalletBatch& batch, const uint256& hash, u\n     }\n }\n \n-bool CWallet::IsUsedDestination(const CTxDestination& dst) const\n-{\n-    LOCK(cs_wallet);\n-    return IsMine(dst) && GetDestData(dst, \"used\", nullptr);\n-}\n-\n bool CWallet::IsUsedDestination(const uint256& hash, unsigned int n) const\n {\n+    AssertLockHeld(cs_wallet);\n     CTxDestination dst;\n     const CWalletTx* srctx = GetWalletTx(hash);\n-    return srctx && ExtractDestination(srctx->tx->vout[n].scriptPubKey, dst) && IsUsedDestination(dst);\n+    if (srctx) {\n+        assert(srctx->tx->vout.size() >= n);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17621#discussion_r358540779",
      "id" : 358540779,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1ODU0MDc3OQ==",
      "original_commit_id" : "ef4a1a4941be5a4a018aedc5f4dc41cea3cb816e",
      "original_position" : 17,
      "path" : "src/wallet/wallet.cpp",
      "position" : 17,
      "pull_request_review_id" : 332960641,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17621",
      "updated_at" : "2019-12-17T00:46:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/358540779",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17621#discussion_r358541499"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17621"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/358541499"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Haven't profiled but looks like `GetDestData && IsMine` should be faster? ",
      "commit_id" : "ef4a1a4941be5a4a018aedc5f4dc41cea3cb816e",
      "created_at" : "2019-12-17T00:49:17Z",
      "diff_hunk" : "@@ -719,17 +719,31 @@ void CWallet::SetUsedDestinationState(WalletBatch& batch, const uint256& hash, u\n     }\n }\n \n-bool CWallet::IsUsedDestination(const CTxDestination& dst) const\n-{\n-    LOCK(cs_wallet);\n-    return IsMine(dst) && GetDestData(dst, \"used\", nullptr);\n-}\n-\n bool CWallet::IsUsedDestination(const uint256& hash, unsigned int n) const\n {\n+    AssertLockHeld(cs_wallet);\n     CTxDestination dst;\n     const CWalletTx* srctx = GetWalletTx(hash);\n-    return srctx && ExtractDestination(srctx->tx->vout[n].scriptPubKey, dst) && IsUsedDestination(dst);\n+    if (srctx) {\n+        assert(srctx->tx->vout.size() >= n);\n+        LegacyScriptPubKeyMan* spk_man = GetLegacyScriptPubKeyMan();\n+        assert(spk_man != nullptr);\n+        for (const auto& keyid : GetAffectedKeys(srctx->tx->vout[n].scriptPubKey, *spk_man)) {\n+            WitnessV0KeyHash wpkh_dest(keyid);\n+            if (IsMine(wpkh_dest) && GetDestData(wpkh_dest, \"used\", nullptr)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17621#discussion_r358541499",
      "id" : 358541499,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1ODU0MTQ5OQ==",
      "original_commit_id" : "ef4a1a4941be5a4a018aedc5f4dc41cea3cb816e",
      "original_position" : 22,
      "path" : "src/wallet/wallet.cpp",
      "position" : 22,
      "pull_request_review_id" : 332961450,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17621",
      "updated_at" : "2019-12-17T00:49:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/358541499",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17621#discussion_r358804704"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17621"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/358804704"
         }
      },
      "author_association" : "MEMBER",
      "body" : "d'oh, I always have to sit there and reason with myself on this :)",
      "commit_id" : "ef4a1a4941be5a4a018aedc5f4dc41cea3cb816e",
      "created_at" : "2019-12-17T13:59:23Z",
      "diff_hunk" : "@@ -719,17 +719,31 @@ void CWallet::SetUsedDestinationState(WalletBatch& batch, const uint256& hash, u\n     }\n }\n \n-bool CWallet::IsUsedDestination(const CTxDestination& dst) const\n-{\n-    LOCK(cs_wallet);\n-    return IsMine(dst) && GetDestData(dst, \"used\", nullptr);\n-}\n-\n bool CWallet::IsUsedDestination(const uint256& hash, unsigned int n) const\n {\n+    AssertLockHeld(cs_wallet);\n     CTxDestination dst;\n     const CWalletTx* srctx = GetWalletTx(hash);\n-    return srctx && ExtractDestination(srctx->tx->vout[n].scriptPubKey, dst) && IsUsedDestination(dst);\n+    if (srctx) {\n+        assert(srctx->tx->vout.size() >= n);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17621#discussion_r358804704",
      "id" : 358804704,
      "in_reply_to_id" : 358540779,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1ODgwNDcwNA==",
      "original_commit_id" : "ef4a1a4941be5a4a018aedc5f4dc41cea3cb816e",
      "original_position" : 17,
      "path" : "src/wallet/wallet.cpp",
      "position" : 17,
      "pull_request_review_id" : 333291810,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17621",
      "updated_at" : "2019-12-17T13:59:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/358804704",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   }
]
