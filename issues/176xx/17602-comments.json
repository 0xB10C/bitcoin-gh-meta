[
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK\r\n\r\nThe quoted discussion mentions that a maximum 31 IP:s fit in a single DNS response packet over UDP. Would it make sense to go with a `nMaxIPs` of `31` instead of the `32`?",
      "created_at" : "2019-11-25T21:26:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17602#issuecomment-558347205",
      "id" : 558347205,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17602",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1ODM0NzIwNQ==",
      "updated_at" : "2019-11-25T21:26:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/558347205",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> The quoted discussion mentions that a maximum 31 IP:s fit in a single DNS response packet over UDP. Would it make sense to go with a `nMaxIPs` of `31` instead of the `32`?\r\n\r\nI actually don't remember how I calculated that or if I even calculated it correctly... Someone should verify... :eyes: @EthanHeilman\r\n\r\n___Update___: Ah, so we have 512 bytes to spend, and the DNS response should look something like:\r\nHeader = 96 bits\r\nQuery = 32 bits (assuming \".\" as question)\r\nAnswer = ( 96 bits + 32 bits ) * numIPv4 + ( 96 bits + 128 bits ) * numIPv6\r\n\r\nNote that this assumes we use DNS packet compression in the Answer section, no Authority or Additional sections, and \".\" as the question (empty QNAME).\r\n\r\nSo in this case we can get 31 IPv4 addresses at the most, or 17 IPv6 addresses (with some room to spare).\r\n\r\nThis is just a rough calculation, we have yet to decide whether it is even a good reference point or not.\r\n\r\nReference: https://www2.cs.duke.edu/courses/fall16/compsci356/DNS/DNS-primer.pdf",
      "created_at" : "2019-11-26T17:37:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17602#issuecomment-558739567",
      "id" : 558739567,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17602",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1ODczOTU2Nw==",
      "updated_at" : "2019-11-26T18:37:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/558739567",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "@dongcarl \r\n\r\nI liked the initiative but it seems that the protocol is well militated. \r\n\r\nDOMAIN NAMES - IMPLEMENTATION AND SPECIFICATION\r\n**2.3.4. Size limits**\r\nVarious objects and parameters in the DNS have size limits.  They are\r\nlisted below.  Some could be easily changed, others are more\r\nfundamental.\r\n\r\nlabels          63 octets or less\r\nnames           255 octets or less\r\nTTL             positive values of a signed 32 bit number.\r\nUDP messages    512 octets or less\r\n\r\nReference: [2.3.4. Size limits](https://www.ietf.org/rfc/rfc1035.txt)\r\n\r\nmaybe another scope can help, who knows DNSSEC, root DNS\r\n\r\n\r\n",
      "created_at" : "2019-11-26T19:44:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17602#issuecomment-558788698",
      "id" : 558788698,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17602",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1ODc4ODY5OA==",
      "updated_at" : "2019-11-26T19:44:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/558788698",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7637553?v=4",
         "events_url" : "https://api.github.com/users/EvertonMelo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/EvertonMelo/followers",
         "following_url" : "https://api.github.com/users/EvertonMelo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/EvertonMelo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/EvertonMelo",
         "id" : 7637553,
         "login" : "EvertonMelo",
         "node_id" : "MDQ6VXNlcjc2Mzc1NTM=",
         "organizations_url" : "https://api.github.com/users/EvertonMelo/orgs",
         "received_events_url" : "https://api.github.com/users/EvertonMelo/received_events",
         "repos_url" : "https://api.github.com/users/EvertonMelo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/EvertonMelo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/EvertonMelo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/EvertonMelo"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "If I'm reading the code correctly even if you set `nMaxIPs=1` that will not stop a DNS seeder or misconfigured DNS resolver from sending you far more than `1` IP address over UDP or TCP. Instead Bitcoin will receive all of those IPs and then select `1` of them and throw away the rest. So sadly this change won't fix DNS over TCP grossness.\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/73b26e38d7a174d5409dda8aa1fe9804e7779a1f/src/netbase.cpp#L194-L209\r\n\r\nIt seems reasonable to reduce this number to `64`, `32`,  or `16` but beyond that point I start to worry that there is a chance a node will get all offline IP addresses.\r\n\r\nHere is my back of the envelope calculation. Assume that U is the fraction of IP addresses returned by seeders that are offline and numSeeders is the number of DNSseeders. The probability a node gets all unreachable IP addresses is:\r\n\r\n`U^(numSeeders*nMaxIPs)`\r\n\r\n`U=0.9`, `numSeeders=8` and `nMaxIPs = 8` then the probability is 0.001. \r\n\r\n`0.00117=0.9^(8*8)`\r\n\r\nThat is we will see a failure to connect on average once each thousand times a node calls the seeders. Assuming seeders go down from time to time or incoming connection exhaustion attacks we probably want a number greater than `nMaxIPs=8`.\r\n\r\nThe blog post I wrote that counted IP addresses in a DNS query focuses on TCP based responses.\r\n[How many IP addresses can a DNS query return?](https://ethanheilman.tumblr.com/post/110920218915/how-many-ip-addresses-can-a-dns-query-return)",
      "created_at" : "2019-11-26T20:27:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17602#issuecomment-558803899",
      "id" : 558803899,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17602",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1ODgwMzg5OQ==",
      "updated_at" : "2019-11-26T20:27:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/558803899",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/274814?v=4",
         "events_url" : "https://api.github.com/users/EthanHeilman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/EthanHeilman/followers",
         "following_url" : "https://api.github.com/users/EthanHeilman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/EthanHeilman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/EthanHeilman",
         "id" : 274814,
         "login" : "EthanHeilman",
         "node_id" : "MDQ6VXNlcjI3NDgxNA==",
         "organizations_url" : "https://api.github.com/users/EthanHeilman/orgs",
         "received_events_url" : "https://api.github.com/users/EthanHeilman/received_events",
         "repos_url" : "https://api.github.com/users/EthanHeilman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/EthanHeilman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/EthanHeilman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/EthanHeilman"
      }
   }
]
