[
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK\r\n\r\nThe quoted discussion mentions that a maximum 31 IP:s fit in a single DNS response packet over UDP. Would it make sense to go with a `nMaxIPs` of `31` instead of the `32`?",
      "created_at" : "2019-11-25T21:26:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17602#issuecomment-558347205",
      "id" : 558347205,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17602",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1ODM0NzIwNQ==",
      "updated_at" : "2019-11-25T21:26:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/558347205",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> The quoted discussion mentions that a maximum 31 IP:s fit in a single DNS response packet over UDP. Would it make sense to go with a `nMaxIPs` of `31` instead of the `32`?\r\n\r\nI actually don't remember how I calculated that or if I even calculated it correctly... Someone should verify... :eyes: @EthanHeilman\r\n\r\n___Update___: Ah, so we have 512 bytes to spend, and the DNS response should look something like:\r\nHeader = 96 bits\r\nQuery = 32 bits (assuming \".\" as question)\r\nAnswer = ( 96 bits + 32 bits ) * numIPv4 + ( 96 bits + 128 bits ) * numIPv6\r\n\r\nNote that this assumes we use DNS packet compression in the Answer section, no Authority or Additional sections, and \".\" as the question (empty QNAME).\r\n\r\nSo in this case we can get 31 IPv4 addresses at the most, or 17 IPv6 addresses (with some room to spare).\r\n\r\nThis is just a rough calculation, we have yet to decide whether it is even a good reference point or not.\r\n\r\nReference: https://www2.cs.duke.edu/courses/fall16/compsci356/DNS/DNS-primer.pdf",
      "created_at" : "2019-11-26T17:37:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17602#issuecomment-558739567",
      "id" : 558739567,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17602",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1ODczOTU2Nw==",
      "updated_at" : "2019-11-26T18:37:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/558739567",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "@dongcarl \r\n\r\nI liked the initiative but it seems that the protocol is well militated. \r\n\r\nDOMAIN NAMES - IMPLEMENTATION AND SPECIFICATION\r\n**2.3.4. Size limits**\r\nVarious objects and parameters in the DNS have size limits.  They are\r\nlisted below.  Some could be easily changed, others are more\r\nfundamental.\r\n\r\nlabels          63 octets or less\r\nnames           255 octets or less\r\nTTL             positive values of a signed 32 bit number.\r\nUDP messages    512 octets or less\r\n\r\nReference: [2.3.4. Size limits](https://www.ietf.org/rfc/rfc1035.txt)\r\n\r\nmaybe another scope can help, who knows DNSSEC, root DNS\r\n\r\n\r\n",
      "created_at" : "2019-11-26T19:44:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17602#issuecomment-558788698",
      "id" : 558788698,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17602",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1ODc4ODY5OA==",
      "updated_at" : "2019-11-26T19:44:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/558788698",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7637553?v=4",
         "events_url" : "https://api.github.com/users/EvertonMelo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/EvertonMelo/followers",
         "following_url" : "https://api.github.com/users/EvertonMelo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/EvertonMelo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/EvertonMelo",
         "id" : 7637553,
         "login" : "EvertonMelo",
         "node_id" : "MDQ6VXNlcjc2Mzc1NTM=",
         "organizations_url" : "https://api.github.com/users/EvertonMelo/orgs",
         "received_events_url" : "https://api.github.com/users/EvertonMelo/received_events",
         "repos_url" : "https://api.github.com/users/EvertonMelo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/EvertonMelo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/EvertonMelo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/EvertonMelo"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "If I'm reading the code correctly even if you set `nMaxIPs=1` that will not stop a DNS seeder or misconfigured DNS resolver from sending you far more than `1` IP address over UDP or TCP. Instead Bitcoin will receive all of those IPs and then select `1` of them and throw away the rest. So sadly this change won't fix DNS over TCP grossness.\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/73b26e38d7a174d5409dda8aa1fe9804e7779a1f/src/netbase.cpp#L194-L209\r\n\r\nIt seems reasonable to reduce this number to `64`, `32`,  or `16` but beyond that point I start to worry that there is a chance a node will get all offline IP addresses.\r\n\r\nHere is my back of the envelope calculation. Assume that U is the fraction of IP addresses returned by seeders that are offline and numSeeders is the number of DNSseeders. The probability a node gets all unreachable IP addresses is:\r\n\r\n`U^(numSeeders*nMaxIPs)`\r\n\r\n`U=0.9`, `numSeeders=8` and `nMaxIPs = 8` then the probability is 0.001. \r\n\r\n`0.00117=0.9^(8*8)`\r\n\r\nThat is we will see a failure to connect on average once each thousand times a node calls the seeders. Assuming seeders go down from time to time or incoming connection exhaustion attacks we probably want a number greater than `nMaxIPs=8`.\r\n\r\nThe blog post I wrote that counted IP addresses in a DNS query focuses on TCP based responses.\r\n[How many IP addresses can a DNS query return?](https://ethanheilman.tumblr.com/post/110920218915/how-many-ip-addresses-can-a-dns-query-return)",
      "created_at" : "2019-11-26T20:27:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17602#issuecomment-558803899",
      "id" : 558803899,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17602",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1ODgwMzg5OQ==",
      "updated_at" : "2019-11-26T20:27:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/558803899",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/274814?v=4",
         "events_url" : "https://api.github.com/users/EthanHeilman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/EthanHeilman/followers",
         "following_url" : "https://api.github.com/users/EthanHeilman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/EthanHeilman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/EthanHeilman",
         "id" : 274814,
         "login" : "EthanHeilman",
         "node_id" : "MDQ6VXNlcjI3NDgxNA==",
         "organizations_url" : "https://api.github.com/users/EthanHeilman/orgs",
         "received_events_url" : "https://api.github.com/users/EthanHeilman/received_events",
         "repos_url" : "https://api.github.com/users/EthanHeilman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/EthanHeilman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/EthanHeilman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/EthanHeilman"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Instead Bitcoin will receive all of those IPs and then select `1` of them and throw away the rest. So sadly this change won't fix DNS over TCP grossness.\r\n\r\nYes, that's a good point. Perhaps it should be recommended that Bitcoin DNS seeder implementations limit the number of returned addresses to keep the response in one UDP packet and thus avoiding fragile DNS-over-TCP (fragile due middleboxes filtering TCP/53).",
      "created_at" : "2019-11-26T21:52:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17602#issuecomment-558832908",
      "id" : 558832908,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17602",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1ODgzMjkwOA==",
      "updated_at" : "2019-11-26T21:58:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/558832908",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@practicalswift Are there any BIPs around how seeders should behave? I don't think we should specify implementation details, but having a rule saying something like don't return 3000 IPs would be helpful.",
      "created_at" : "2019-11-27T17:18:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17602#issuecomment-559179057",
      "id" : 559179057,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17602",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1OTE3OTA1Nw==",
      "updated_at" : "2019-11-27T17:18:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/559179057",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/274814?v=4",
         "events_url" : "https://api.github.com/users/EthanHeilman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/EthanHeilman/followers",
         "following_url" : "https://api.github.com/users/EthanHeilman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/EthanHeilman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/EthanHeilman",
         "id" : 274814,
         "login" : "EthanHeilman",
         "node_id" : "MDQ6VXNlcjI3NDgxNA==",
         "organizations_url" : "https://api.github.com/users/EthanHeilman/orgs",
         "received_events_url" : "https://api.github.com/users/EthanHeilman/received_events",
         "repos_url" : "https://api.github.com/users/EthanHeilman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/EthanHeilman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/EthanHeilman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/EthanHeilman"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : ">  Are there any BIPs around how seeders should behave?\r\n\r\nThere's `doc/dnsseed-policy.md` which all DNS seed operators need to agree with (this is particular to this project, not bitcoin in general).\r\n",
      "created_at" : "2019-11-28T12:06:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17602#issuecomment-559468955",
      "id" : 559468955,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17602",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1OTQ2ODk1NQ==",
      "updated_at" : "2019-11-28T12:07:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/559468955",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Some discussion from the other thread: https://github.com/bitcoin/bitcoin/issues/16070#issuecomment-559297746",
      "created_at" : "2019-12-02T15:59:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17602#issuecomment-560458705",
      "id" : 560458705,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17602",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU2MDQ1ODcwNQ==",
      "updated_at" : "2019-12-02T15:59:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/560458705",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@EthanHeilman yeah I think we can definitely do 32, one thing that I realized after reading TheBlueMatt's response (in the other thread :roll_eyes:) was that: because we set `ai_family = AF_UNSPEC`, we actually get back both the `A` _and_ `AAAA` records, and the total would be more than 32.\r\n\r\nSomething that I want to discuss is: after we get the names from `getaddrinfo`, should we randomize the returned linked list first before truncating to 32 entries? Mostly because `getaddrinfo` is usually implemented in such a way that the `IPv4` addresses come before the `IPv6` addresses. As it currently stands, `IPv6` addresses are already disadvantaged by the fact that less of them fit within a 512byte payload, with this change, we'd be truncating mostly `IPv6` addresses...\r\n\r\n-----\r\n\r\nIt also seems kind of weird that we're basically disadvantaging the `IPv6` network by nature of DNS's 512 byte limit (which remains true even with randomization)... I'm not sure what's best here, but perhaps a limit _per-family_ is what we want?",
      "created_at" : "2019-12-02T18:35:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17602#issuecomment-560523250",
      "id" : 560523250,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17602",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU2MDUyMzI1MA==",
      "updated_at" : "2019-12-02T18:41:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/560523250",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   }
]
