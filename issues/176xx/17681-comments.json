[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#17261](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/17261.html) (Make ScriptPubKeyMan an actual interface and the wallet to have multiple by achow101)\n* [#16895](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16895.html) (External signer multisig support by Sjors)\n* [#16549](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16549.html) ([WIP] UI external signer support (e.g. hardware wallet) by Sjors)\n* [#16546](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16546.html) ([WIP] External signer support - Wallet Box edition by Sjors)\n* [#16528](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16528.html) ([WIP] Native Descriptor Wallets (take 2) by achow101)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2019-12-05T22:21:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#issuecomment-562345098",
      "id" : 562345098,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU2MjM0NTA5OA==",
      "updated_at" : "2019-12-09T18:27:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/562345098",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355111113"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355111113"
         }
      },
      "author_association" : "NONE",
      "body" : "should `index` and `internal` be made `const` too? ",
      "commit_id" : "fc7a5e4d5341f5a541a68e2717fefc5e0f4d4007",
      "created_at" : "2019-12-07T09:22:41Z",
      "diff_hunk" : "@@ -275,6 +275,48 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::FillInactiveChain(const CKeyID seed_id, int64_t index, bool internal)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355111113",
      "id" : 355111113,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTExMTExMw==",
      "original_commit_id" : "c4ae01c81255c5e0e3b5ca3b979e60a1c531aed1",
      "original_position" : 4,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 4,
      "pull_request_review_id" : 328547913,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "updated_at" : "2019-12-09T23:17:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355111113",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1986950?v=4",
         "events_url" : "https://api.github.com/users/paymog/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paymog/followers",
         "following_url" : "https://api.github.com/users/paymog/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paymog/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paymog",
         "id" : 1986950,
         "login" : "paymog",
         "node_id" : "MDQ6VXNlcjE5ODY5NTA=",
         "organizations_url" : "https://api.github.com/users/paymog/orgs",
         "received_events_url" : "https://api.github.com/users/paymog/received_events",
         "repos_url" : "https://api.github.com/users/paymog/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paymog/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paymog/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paymog"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355111471"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355111471"
         }
      },
      "author_association" : "NONE",
      "body" : "Documentation for the function would be nice, whether here or in the header file. What does this function do? What does the return value mean?",
      "commit_id" : "fc7a5e4d5341f5a541a68e2717fefc5e0f4d4007",
      "created_at" : "2019-12-07T09:29:58Z",
      "diff_hunk" : "@@ -275,6 +275,48 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::FillInactiveChain(const CKeyID seed_id, int64_t index, bool internal)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355111471",
      "id" : 355111471,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTExMTQ3MQ==",
      "original_commit_id" : "c4ae01c81255c5e0e3b5ca3b979e60a1c531aed1",
      "original_position" : 4,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 4,
      "pull_request_review_id" : 328547913,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "updated_at" : "2019-12-09T23:17:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355111471",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1986950?v=4",
         "events_url" : "https://api.github.com/users/paymog/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paymog/followers",
         "following_url" : "https://api.github.com/users/paymog/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paymog/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paymog",
         "id" : 1986950,
         "login" : "paymog",
         "node_id" : "MDQ6VXNlcjE5ODY5NTA=",
         "organizations_url" : "https://api.github.com/users/paymog/orgs",
         "received_events_url" : "https://api.github.com/users/paymog/received_events",
         "repos_url" : "https://api.github.com/users/paymog/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paymog/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paymog/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paymog"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355111542"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355111542"
         }
      },
      "author_association" : "NONE",
      "body" : "`const`? Seems like this isn't be modified later in the function",
      "commit_id" : "fc7a5e4d5341f5a541a68e2717fefc5e0f4d4007",
      "created_at" : "2019-12-07T09:31:26Z",
      "diff_hunk" : "@@ -275,6 +275,48 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::FillInactiveChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_wallet);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355111542",
      "id" : 355111542,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTExMTU0Mg==",
      "original_commit_id" : "c4ae01c81255c5e0e3b5ca3b979e60a1c531aed1",
      "original_position" : 15,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 15,
      "pull_request_review_id" : 328547913,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "updated_at" : "2019-12-09T23:17:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355111542",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1986950?v=4",
         "events_url" : "https://api.github.com/users/paymog/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paymog/followers",
         "following_url" : "https://api.github.com/users/paymog/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paymog/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paymog",
         "id" : 1986950,
         "login" : "paymog",
         "node_id" : "MDQ6VXNlcjE5ODY5NTA=",
         "organizations_url" : "https://api.github.com/users/paymog/orgs",
         "received_events_url" : "https://api.github.com/users/paymog/received_events",
         "repos_url" : "https://api.github.com/users/paymog/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paymog/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paymog/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paymog"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355112025"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355112025"
         }
      },
      "author_association" : "NONE",
      "body" : "should the type on the left hand side be `int64_t`? It seems `GetArg` returns that type and you're casting `0` to that type too: https://github.com/bitcoin/bitcoin/blob/23cecd6cd56f952c757f469c46d7593c2ffaa419/src/util/system.h#L234",
      "commit_id" : "fc7a5e4d5341f5a541a68e2717fefc5e0f4d4007",
      "created_at" : "2019-12-07T09:40:37Z",
      "diff_hunk" : "@@ -275,6 +275,48 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::FillInactiveChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_wallet);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;\n+\n+    // Top up key pool\n+    unsigned int target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355112025",
      "id" : 355112025,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTExMjAyNQ==",
      "original_commit_id" : "c4ae01c81255c5e0e3b5ca3b979e60a1c531aed1",
      "original_position" : 18,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 328547913,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "updated_at" : "2019-12-09T23:17:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355112025",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1986950?v=4",
         "events_url" : "https://api.github.com/users/paymog/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paymog/followers",
         "following_url" : "https://api.github.com/users/paymog/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paymog/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paymog",
         "id" : 1986950,
         "login" : "paymog",
         "node_id" : "MDQ6VXNlcjE5ODY5NTA=",
         "organizations_url" : "https://api.github.com/users/paymog/orgs",
         "received_events_url" : "https://api.github.com/users/paymog/received_events",
         "repos_url" : "https://api.github.com/users/paymog/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paymog/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paymog/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paymog"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355112076"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355112076"
         }
      },
      "author_association" : "NONE",
      "body" : "`(int64_t) 0` is used twice now, should it be made into a constant?",
      "commit_id" : "fc7a5e4d5341f5a541a68e2717fefc5e0f4d4007",
      "created_at" : "2019-12-07T09:42:06Z",
      "diff_hunk" : "@@ -275,6 +275,48 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::FillInactiveChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_wallet);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;\n+\n+    // Top up key pool\n+    unsigned int target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+\n+    // \"size\" of the keypools. Not really the size, actually the difference between index and the chain counter\n+    int64_t kp_size = (internal ? chain.nInternalChainCounter : chain.nExternalChainCounter) - index;\n+\n+    // count amount of available keys (internal, external)\n+    // make sure the keypool of external and internal keys fits the user selected target (-keypool)\n+    // available is determined based on the index given\n+    int64_t missing = std::max(std::max((int64_t) target_size, (int64_t) 1) - kp_size, (int64_t) 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355112076",
      "id" : 355112076,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTExMjA3Ng==",
      "original_commit_id" : "c4ae01c81255c5e0e3b5ca3b979e60a1c531aed1",
      "original_position" : 26,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 27,
      "pull_request_review_id" : 328547913,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "updated_at" : "2019-12-09T23:17:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355112076",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1986950?v=4",
         "events_url" : "https://api.github.com/users/paymog/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paymog/followers",
         "following_url" : "https://api.github.com/users/paymog/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paymog/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paymog",
         "id" : 1986950,
         "login" : "paymog",
         "node_id" : "MDQ6VXNlcjE5ODY5NTA=",
         "organizations_url" : "https://api.github.com/users/paymog/orgs",
         "received_events_url" : "https://api.github.com/users/paymog/received_events",
         "repos_url" : "https://api.github.com/users/paymog/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paymog/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paymog/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paymog"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355112156"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355112156"
         }
      },
      "author_association" : "NONE",
      "body" : "is this missing a termination condition?",
      "commit_id" : "fc7a5e4d5341f5a541a68e2717fefc5e0f4d4007",
      "created_at" : "2019-12-07T09:44:10Z",
      "diff_hunk" : "@@ -275,6 +275,48 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::FillInactiveChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_wallet);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;\n+\n+    // Top up key pool\n+    unsigned int target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+\n+    // \"size\" of the keypools. Not really the size, actually the difference between index and the chain counter\n+    int64_t kp_size = (internal ? chain.nInternalChainCounter : chain.nExternalChainCounter) - index;\n+\n+    // count amount of available keys (internal, external)\n+    // make sure the keypool of external and internal keys fits the user selected target (-keypool)\n+    // available is determined based on the index given\n+    int64_t missing = std::max(std::max((int64_t) target_size, (int64_t) 1) - kp_size, (int64_t) 0);\n+\n+    WalletBatch batch(m_storage.GetDatabase());\n+    for (int64_t i = missing; i--;)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355112156",
      "id" : 355112156,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTExMjE1Ng==",
      "original_commit_id" : "c4ae01c81255c5e0e3b5ca3b979e60a1c531aed1",
      "original_position" : 29,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 328547913,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "updated_at" : "2019-12-09T23:17:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355112156",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1986950?v=4",
         "events_url" : "https://api.github.com/users/paymog/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paymog/followers",
         "following_url" : "https://api.github.com/users/paymog/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paymog/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paymog",
         "id" : 1986950,
         "login" : "paymog",
         "node_id" : "MDQ6VXNlcjE5ODY5NTA=",
         "organizations_url" : "https://api.github.com/users/paymog/orgs",
         "received_events_url" : "https://api.github.com/users/paymog/received_events",
         "repos_url" : "https://api.github.com/users/paymog/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paymog/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paymog/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paymog"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355170609"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355170609"
         }
      },
      "author_association" : "NONE",
      "body" : "sanity check: should this be `hdChain` or `chain`?",
      "commit_id" : "fc7a5e4d5341f5a541a68e2717fefc5e0f4d4007",
      "created_at" : "2019-12-08T09:03:09Z",
      "diff_hunk" : "@@ -732,12 +787,27 @@ bool LegacyScriptPubKeyMan::AddWatchOnly(const CScript& dest, int64_t nCreateTim\n void LegacyScriptPubKeyMan::SetHDChain(const CHDChain& chain, bool memonly)\n {\n     LOCK(cs_wallet);\n-    if (!memonly && !WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain))\n-        throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+    if (!memonly) {\n+        if (!WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain)) {\n+            throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+        }\n+        if (!hdChain.seed_id.IsNull()) {\n+            AddInactiveHDChain(hdChain, false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355170609",
      "id" : 355170609,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTE3MDYwOQ==",
      "original_commit_id" : "c4ae01c81255c5e0e3b5ca3b979e60a1c531aed1",
      "original_position" : 80,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 328547913,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "updated_at" : "2019-12-09T23:17:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355170609",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1986950?v=4",
         "events_url" : "https://api.github.com/users/paymog/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paymog/followers",
         "following_url" : "https://api.github.com/users/paymog/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paymog/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paymog",
         "id" : 1986950,
         "login" : "paymog",
         "node_id" : "MDQ6VXNlcjE5ODY5NTA=",
         "organizations_url" : "https://api.github.com/users/paymog/orgs",
         "received_events_url" : "https://api.github.com/users/paymog/received_events",
         "repos_url" : "https://api.github.com/users/paymog/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paymog/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paymog/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paymog"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355170663"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355170663"
         }
      },
      "author_association" : "NONE",
      "body" : "should we check if `chain.seed_id` is null here? ",
      "commit_id" : "fc7a5e4d5341f5a541a68e2717fefc5e0f4d4007",
      "created_at" : "2019-12-08T09:04:15Z",
      "diff_hunk" : "@@ -732,12 +787,27 @@ bool LegacyScriptPubKeyMan::AddWatchOnly(const CScript& dest, int64_t nCreateTim\n void LegacyScriptPubKeyMan::SetHDChain(const CHDChain& chain, bool memonly)\n {\n     LOCK(cs_wallet);\n-    if (!memonly && !WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain))\n-        throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+    if (!memonly) {\n+        if (!WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain)) {\n+            throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+        }\n+        if (!hdChain.seed_id.IsNull()) {\n+            AddInactiveHDChain(hdChain, false);\n+        }\n+    }\n \n     hdChain = chain;\n }\n \n+void LegacyScriptPubKeyMan::AddInactiveHDChain(const CHDChain& chain, bool memonly)\n+{\n+    LOCK(cs_wallet);\n+    if (!memonly && !WalletBatch(m_storage.GetDatabase()).WriteInactiveHDChain(chain))\n+        throw std::runtime_error(std::string(__func__) + \": writing inactive chain failed\");\n+\n+    m_inactive_hd_chains[chain.seed_id] = chain;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355170663",
      "id" : 355170663,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTE3MDY2Mw==",
      "original_commit_id" : "c4ae01c81255c5e0e3b5ca3b979e60a1c531aed1",
      "original_position" : 93,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 95,
      "pull_request_review_id" : 328547913,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "updated_at" : "2019-12-09T23:17:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355170663",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1986950?v=4",
         "events_url" : "https://api.github.com/users/paymog/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paymog/followers",
         "following_url" : "https://api.github.com/users/paymog/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paymog/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paymog",
         "id" : 1986950,
         "login" : "paymog",
         "node_id" : "MDQ6VXNlcjE5ODY5NTA=",
         "organizations_url" : "https://api.github.com/users/paymog/orgs",
         "received_events_url" : "https://api.github.com/users/paymog/received_events",
         "repos_url" : "https://api.github.com/users/paymog/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paymog/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paymog/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paymog"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355171237"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355171237"
         }
      },
      "author_association" : "NONE",
      "body" : "I'm new to Bitcoin and I'm still learning the testing standards - should there be a test where this exception is expected to be thrown?",
      "commit_id" : "fc7a5e4d5341f5a541a68e2717fefc5e0f4d4007",
      "created_at" : "2019-12-08T09:12:33Z",
      "diff_hunk" : "@@ -732,12 +787,27 @@ bool LegacyScriptPubKeyMan::AddWatchOnly(const CScript& dest, int64_t nCreateTim\n void LegacyScriptPubKeyMan::SetHDChain(const CHDChain& chain, bool memonly)\n {\n     LOCK(cs_wallet);\n-    if (!memonly && !WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain))\n-        throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+    if (!memonly) {\n+        if (!WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355171237",
      "id" : 355171237,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTE3MTIzNw==",
      "original_commit_id" : "c4ae01c81255c5e0e3b5ca3b979e60a1c531aed1",
      "original_position" : 76,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 77,
      "pull_request_review_id" : 328547913,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "updated_at" : "2019-12-09T23:17:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355171237",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1986950?v=4",
         "events_url" : "https://api.github.com/users/paymog/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paymog/followers",
         "following_url" : "https://api.github.com/users/paymog/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paymog/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paymog",
         "id" : 1986950,
         "login" : "paymog",
         "node_id" : "MDQ6VXNlcjE5ODY5NTA=",
         "organizations_url" : "https://api.github.com/users/paymog/orgs",
         "received_events_url" : "https://api.github.com/users/paymog/received_events",
         "repos_url" : "https://api.github.com/users/paymog/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paymog/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paymog/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paymog"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355199686"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355199686"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No. This is only expected to be thrown under corruption and/or hardware failure conditions.",
      "commit_id" : "fc7a5e4d5341f5a541a68e2717fefc5e0f4d4007",
      "created_at" : "2019-12-08T16:56:33Z",
      "diff_hunk" : "@@ -732,12 +787,27 @@ bool LegacyScriptPubKeyMan::AddWatchOnly(const CScript& dest, int64_t nCreateTim\n void LegacyScriptPubKeyMan::SetHDChain(const CHDChain& chain, bool memonly)\n {\n     LOCK(cs_wallet);\n-    if (!memonly && !WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain))\n-        throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+    if (!memonly) {\n+        if (!WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355199686",
      "id" : 355199686,
      "in_reply_to_id" : 355171237,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTE5OTY4Ng==",
      "original_commit_id" : "c4ae01c81255c5e0e3b5ca3b979e60a1c531aed1",
      "original_position" : 76,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 77,
      "pull_request_review_id" : 328620017,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "updated_at" : "2019-12-09T23:17:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355199686",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355199870"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355199870"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think it really matters. They are not references and are primitives.",
      "commit_id" : "fc7a5e4d5341f5a541a68e2717fefc5e0f4d4007",
      "created_at" : "2019-12-08T16:59:21Z",
      "diff_hunk" : "@@ -275,6 +275,48 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::FillInactiveChain(const CKeyID seed_id, int64_t index, bool internal)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355199870",
      "id" : 355199870,
      "in_reply_to_id" : 355111113,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTE5OTg3MA==",
      "original_commit_id" : "c4ae01c81255c5e0e3b5ca3b979e60a1c531aed1",
      "original_position" : 4,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 4,
      "pull_request_review_id" : 328620165,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "updated_at" : "2019-12-09T23:17:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355199870",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355200192"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355200192"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`GenerateNewKey` modifies it.",
      "commit_id" : "fc7a5e4d5341f5a541a68e2717fefc5e0f4d4007",
      "created_at" : "2019-12-08T17:04:27Z",
      "diff_hunk" : "@@ -275,6 +275,48 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::FillInactiveChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_wallet);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355200192",
      "id" : 355200192,
      "in_reply_to_id" : 355111542,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTIwMDE5Mg==",
      "original_commit_id" : "c4ae01c81255c5e0e3b5ca3b979e60a1c531aed1",
      "original_position" : 15,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 15,
      "pull_request_review_id" : 328620430,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "updated_at" : "2019-12-09T23:17:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355200192",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355200227"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355200227"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think it's worth it.",
      "commit_id" : "fc7a5e4d5341f5a541a68e2717fefc5e0f4d4007",
      "created_at" : "2019-12-08T17:05:01Z",
      "diff_hunk" : "@@ -275,6 +275,48 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::FillInactiveChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_wallet);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;\n+\n+    // Top up key pool\n+    unsigned int target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+\n+    // \"size\" of the keypools. Not really the size, actually the difference between index and the chain counter\n+    int64_t kp_size = (internal ? chain.nInternalChainCounter : chain.nExternalChainCounter) - index;\n+\n+    // count amount of available keys (internal, external)\n+    // make sure the keypool of external and internal keys fits the user selected target (-keypool)\n+    // available is determined based on the index given\n+    int64_t missing = std::max(std::max((int64_t) target_size, (int64_t) 1) - kp_size, (int64_t) 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355200227",
      "id" : 355200227,
      "in_reply_to_id" : 355112076,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTIwMDIyNw==",
      "original_commit_id" : "c4ae01c81255c5e0e3b5ca3b979e60a1c531aed1",
      "original_position" : 26,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 27,
      "pull_request_review_id" : 328620464,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "updated_at" : "2019-12-09T23:17:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355200227",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355200722"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355200722"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It is supposed to be `hdChain`.\r\n\r\n`SetHDChain` happens when we change `hdChain`. We want to store what is currently `hdChain` as an inactive seed before we switch it out for the new one. So this is correct, we add it as an inactive chain before it is set to the new `chain`.",
      "commit_id" : "fc7a5e4d5341f5a541a68e2717fefc5e0f4d4007",
      "created_at" : "2019-12-08T17:12:53Z",
      "diff_hunk" : "@@ -732,12 +787,27 @@ bool LegacyScriptPubKeyMan::AddWatchOnly(const CScript& dest, int64_t nCreateTim\n void LegacyScriptPubKeyMan::SetHDChain(const CHDChain& chain, bool memonly)\n {\n     LOCK(cs_wallet);\n-    if (!memonly && !WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain))\n-        throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+    if (!memonly) {\n+        if (!WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain)) {\n+            throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+        }\n+        if (!hdChain.seed_id.IsNull()) {\n+            AddInactiveHDChain(hdChain, false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355200722",
      "id" : 355200722,
      "in_reply_to_id" : 355170609,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTIwMDcyMg==",
      "original_commit_id" : "c4ae01c81255c5e0e3b5ca3b979e60a1c531aed1",
      "original_position" : 80,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 328620840,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "updated_at" : "2019-12-09T23:17:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355200722",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355203595"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355203595"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added a comment.",
      "commit_id" : "fc7a5e4d5341f5a541a68e2717fefc5e0f4d4007",
      "created_at" : "2019-12-08T18:00:50Z",
      "diff_hunk" : "@@ -275,6 +275,48 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::FillInactiveChain(const CKeyID seed_id, int64_t index, bool internal)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355203595",
      "id" : 355203595,
      "in_reply_to_id" : 355111471,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTIwMzU5NQ==",
      "original_commit_id" : "c4ae01c81255c5e0e3b5ca3b979e60a1c531aed1",
      "original_position" : 4,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 4,
      "pull_request_review_id" : 328623013,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "updated_at" : "2019-12-09T23:17:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355203595",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355203600"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355203600"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "fc7a5e4d5341f5a541a68e2717fefc5e0f4d4007",
      "created_at" : "2019-12-08T18:00:55Z",
      "diff_hunk" : "@@ -275,6 +275,48 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::FillInactiveChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_wallet);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;\n+\n+    // Top up key pool\n+    unsigned int target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355203600",
      "id" : 355203600,
      "in_reply_to_id" : 355112025,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTIwMzYwMA==",
      "original_commit_id" : "c4ae01c81255c5e0e3b5ca3b979e60a1c531aed1",
      "original_position" : 18,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 328623021,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "updated_at" : "2019-12-09T23:17:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355203600",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355203638"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355203638"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I copied this out of TopUp and technically this is correct. But it's hard to read and reason about, so I've changed it to the standard way of doing for loops.",
      "commit_id" : "fc7a5e4d5341f5a541a68e2717fefc5e0f4d4007",
      "created_at" : "2019-12-08T18:01:18Z",
      "diff_hunk" : "@@ -275,6 +275,48 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::FillInactiveChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_wallet);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;\n+\n+    // Top up key pool\n+    unsigned int target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+\n+    // \"size\" of the keypools. Not really the size, actually the difference between index and the chain counter\n+    int64_t kp_size = (internal ? chain.nInternalChainCounter : chain.nExternalChainCounter) - index;\n+\n+    // count amount of available keys (internal, external)\n+    // make sure the keypool of external and internal keys fits the user selected target (-keypool)\n+    // available is determined based on the index given\n+    int64_t missing = std::max(std::max((int64_t) target_size, (int64_t) 1) - kp_size, (int64_t) 0);\n+\n+    WalletBatch batch(m_storage.GetDatabase());\n+    for (int64_t i = missing; i--;)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355203638",
      "id" : 355203638,
      "in_reply_to_id" : 355112156,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTIwMzYzOA==",
      "original_commit_id" : "c4ae01c81255c5e0e3b5ca3b979e60a1c531aed1",
      "original_position" : 29,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 328623064,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "updated_at" : "2019-12-09T23:17:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355203638",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355203648"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355203648"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It should never be null. I've added an assert to check that.",
      "commit_id" : "fc7a5e4d5341f5a541a68e2717fefc5e0f4d4007",
      "created_at" : "2019-12-08T18:01:35Z",
      "diff_hunk" : "@@ -732,12 +787,27 @@ bool LegacyScriptPubKeyMan::AddWatchOnly(const CScript& dest, int64_t nCreateTim\n void LegacyScriptPubKeyMan::SetHDChain(const CHDChain& chain, bool memonly)\n {\n     LOCK(cs_wallet);\n-    if (!memonly && !WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain))\n-        throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+    if (!memonly) {\n+        if (!WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain)) {\n+            throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+        }\n+        if (!hdChain.seed_id.IsNull()) {\n+            AddInactiveHDChain(hdChain, false);\n+        }\n+    }\n \n     hdChain = chain;\n }\n \n+void LegacyScriptPubKeyMan::AddInactiveHDChain(const CHDChain& chain, bool memonly)\n+{\n+    LOCK(cs_wallet);\n+    if (!memonly && !WalletBatch(m_storage.GetDatabase()).WriteInactiveHDChain(chain))\n+        throw std::runtime_error(std::string(__func__) + \": writing inactive chain failed\");\n+\n+    m_inactive_hd_chains[chain.seed_id] = chain;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355203648",
      "id" : 355203648,
      "in_reply_to_id" : 355170663,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTIwMzY0OA==",
      "original_commit_id" : "c4ae01c81255c5e0e3b5ca3b979e60a1c531aed1",
      "original_position" : 93,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 95,
      "pull_request_review_id" : 328623077,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "updated_at" : "2019-12-09T23:17:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355203648",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Found a few bugs where the wrong CHDChain was being used/updated/written. Should be fixed now.",
      "created_at" : "2019-12-08T18:02:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#issuecomment-562975226",
      "id" : 562975226,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU2Mjk3NTIyNg==",
      "updated_at" : "2019-12-08T18:02:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/562975226",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355716017"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355716017"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Is needed to take lock again? Can't you `AssertLockHeld` and `EXCLUSIVE_LOCKREQUIRED` instead?",
      "commit_id" : "fc7a5e4d5341f5a541a68e2717fefc5e0f4d4007",
      "created_at" : "2019-12-09T22:17:38Z",
      "diff_hunk" : "@@ -732,12 +732,28 @@ bool LegacyScriptPubKeyMan::AddWatchOnly(const CScript& dest, int64_t nCreateTim\n void LegacyScriptPubKeyMan::SetHDChain(const CHDChain& chain, bool memonly)\n {\n     LOCK(cs_wallet);\n-    if (!memonly && !WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain))\n-        throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+    if (!memonly) {\n+        if (!WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain)) {\n+            throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+        }\n+        if (!hdChain.seed_id.IsNull()) {\n+            AddInactiveHDChain(hdChain, false);\n+        }\n+    }\n \n     hdChain = chain;\n }\n \n+void LegacyScriptPubKeyMan::AddInactiveHDChain(const CHDChain& chain, bool memonly)\n+{\n+    LOCK(cs_wallet);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355716017",
      "id" : 355716017,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTcxNjAxNw==",
      "original_commit_id" : "cf80607b12ecd4c6b07441557c81d986b6fb12d8",
      "original_position" : 20,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 329329202,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "updated_at" : "2019-12-09T23:17:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355716017",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355717884"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355717884"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Pass `memonly`? (even if value is always `false` for now)",
      "commit_id" : "fc7a5e4d5341f5a541a68e2717fefc5e0f4d4007",
      "created_at" : "2019-12-09T22:22:02Z",
      "diff_hunk" : "@@ -732,12 +732,28 @@ bool LegacyScriptPubKeyMan::AddWatchOnly(const CScript& dest, int64_t nCreateTim\n void LegacyScriptPubKeyMan::SetHDChain(const CHDChain& chain, bool memonly)\n {\n     LOCK(cs_wallet);\n-    if (!memonly && !WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain))\n-        throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+    if (!memonly) {\n+        if (!WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain)) {\n+            throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+        }\n+        if (!hdChain.seed_id.IsNull()) {\n+            AddInactiveHDChain(hdChain, false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355717884",
      "id" : 355717884,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTcxNzg4NA==",
      "original_commit_id" : "cf80607b12ecd4c6b07441557c81d986b6fb12d8",
      "original_position" : 11,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 329329202,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "updated_at" : "2019-12-09T23:17:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355717884",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355738392"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355738392"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "fc7a5e4d5341f5a541a68e2717fefc5e0f4d4007",
      "created_at" : "2019-12-09T23:17:31Z",
      "diff_hunk" : "@@ -732,12 +732,28 @@ bool LegacyScriptPubKeyMan::AddWatchOnly(const CScript& dest, int64_t nCreateTim\n void LegacyScriptPubKeyMan::SetHDChain(const CHDChain& chain, bool memonly)\n {\n     LOCK(cs_wallet);\n-    if (!memonly && !WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain))\n-        throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+    if (!memonly) {\n+        if (!WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain)) {\n+            throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+        }\n+        if (!hdChain.seed_id.IsNull()) {\n+            AddInactiveHDChain(hdChain, false);\n+        }\n+    }\n \n     hdChain = chain;\n }\n \n+void LegacyScriptPubKeyMan::AddInactiveHDChain(const CHDChain& chain, bool memonly)\n+{\n+    LOCK(cs_wallet);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355738392",
      "id" : 355738392,
      "in_reply_to_id" : 355716017,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTczODM5Mg==",
      "original_commit_id" : "cf80607b12ecd4c6b07441557c81d986b6fb12d8",
      "original_position" : 20,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 329432291,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "updated_at" : "2019-12-09T23:17:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355738392",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355738422"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355738422"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "fc7a5e4d5341f5a541a68e2717fefc5e0f4d4007",
      "created_at" : "2019-12-09T23:17:36Z",
      "diff_hunk" : "@@ -732,12 +732,28 @@ bool LegacyScriptPubKeyMan::AddWatchOnly(const CScript& dest, int64_t nCreateTim\n void LegacyScriptPubKeyMan::SetHDChain(const CHDChain& chain, bool memonly)\n {\n     LOCK(cs_wallet);\n-    if (!memonly && !WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain))\n-        throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+    if (!memonly) {\n+        if (!WalletBatch(m_storage.GetDatabase()).WriteHDChain(chain)) {\n+            throw std::runtime_error(std::string(__func__) + \": writing chain failed\");\n+        }\n+        if (!hdChain.seed_id.IsNull()) {\n+            AddInactiveHDChain(hdChain, false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r355738422",
      "id" : 355738422,
      "in_reply_to_id" : 355717884,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NTczODQyMg==",
      "original_commit_id" : "cf80607b12ecd4c6b07441557c81d986b6fb12d8",
      "original_position" : 11,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 329432447,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "updated_at" : "2019-12-09T23:17:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/355738422",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@achow101 after thoughts, I was thinking of the case where we have initial keypool=1000, we create a wallet backup B1 at block N, then we exhaust keypool until reaching index 1100, none of the address in the range 0 to 1000 are confirmed on chain, address index 1100 get confirmed at block N+10000. We restore wallet backup B1 and rescan from N until N+10000, wallet is not going to see address index 1100 because we only advance look-ahead key buffer when we detect an address in range 0 to 1000.\r\n\r\nThis scenario is really unlikely but it this current code behavior ? Just to be sure, if yes maybe comment of `CKeyPool` should be updated to avoid people setting to small `-keypool`.",
      "created_at" : "2019-12-10T02:31:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#issuecomment-563613452",
      "id" : 563613452,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU2MzYxMzQ1Mg==",
      "updated_at" : "2019-12-10T02:31:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/563613452",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Yes, such a scenario is possible and is unavoidable. The only thing that you can do is to have a large enough keypool (or gap limit as other wallets call it) where this is unlikely to happen. This is why the default `-keypool` was raised to 1000 from 100.",
      "created_at" : "2019-12-10T02:49:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#issuecomment-563636980",
      "id" : 563636980,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU2MzYzNjk4MA==",
      "updated_at" : "2019-12-10T02:49:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/563636980",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Okay thanks for answer, added a commit on top of your branch (https://github.com/ariard/bitcoin/commit/3c25ab7f36319cbe38d1fb65a321b1234635648e) to clarify the risk of losing funds by lowering the default keypool value. With the default value, this scenario is really unlikely, but we should inform as best user to avoid one of them removing the footgun protection by mistake.\r\n\r\nWe could also go further and return error at wallet init if -keypool < 100.",
      "created_at" : "2019-12-10T23:24:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#issuecomment-564305888",
      "id" : 564305888,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU2NDMwNTg4OA==",
      "updated_at" : "2019-12-10T23:24:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/564305888",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I think updating the docs about `-keypool` settings is out of scope for this PR.",
      "created_at" : "2019-12-11T01:48:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#issuecomment-564340206",
      "id" : 564340206,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU2NDM0MDIwNg==",
      "updated_at" : "2019-12-11T01:48:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/564340206",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "No worries I'll take it on its own. But on the raw idea, do you think it's pertinent to update the doc to inform user ?",
      "created_at" : "2019-12-11T03:49:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#issuecomment-564367899",
      "id" : 564367899,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU2NDM2Nzg5OQ==",
      "updated_at" : "2019-12-11T03:49:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/564367899",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Yes, we should keep docs up to date with behavior.",
      "created_at" : "2019-12-11T03:54:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#issuecomment-564368726",
      "id" : 564368726,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17681",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU2NDM2ODcyNg==",
      "updated_at" : "2019-12-11T03:54:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/564368726",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r361878437"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/361878437"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit, above.",
      "commit_id" : "fc7a5e4d5341f5a541a68e2717fefc5e0f4d4007",
      "created_at" : "2019-12-29T23:21:00Z",
      "diff_hunk" : "@@ -275,6 +275,49 @@ bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool i\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::FillInactiveChain(const CKeyID seed_id, int64_t index, bool internal)\n+{\n+    LOCK(cs_wallet);\n+\n+    if (m_storage.IsLocked()) return false;\n+\n+    auto it = m_inactive_hd_chains.find(seed_id);\n+    if (it == m_inactive_hd_chains.end()) {\n+        return false;\n+    }\n+\n+    CHDChain& chain = it->second;\n+\n+    // Top up key pool\n+    int64_t target_size = std::max(gArgs.GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+\n+    // \"size\" of the keypools. Not really the size, actually the difference between index and the chain counter\n+    // Since chain counter is 1 based and index is 0 based, one of them needs to be offset by 1.\n+    int64_t kp_size = (internal ? chain.nInternalChainCounter : chain.nExternalChainCounter) - (index + 1);\n+\n+    // count amount of available keys (internal, external)\n+    // make sure the keypool of external and internal keys fits the user selected target (-keypool)\n+    // available is determined based on the index given\n+    int64_t missing = std::max(std::max((int64_t) target_size, (int64_t) 1) - kp_size, (int64_t) 0);\n+\n+    WalletBatch batch(m_storage.GetDatabase());\n+    for (int64_t i = missing; i > 0; --i)\n+    {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17681#discussion_r361878437",
      "id" : 361878437,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MTg3ODQzNw==",
      "original_commit_id" : "fc7a5e4d5341f5a541a68e2717fefc5e0f4d4007",
      "original_position" : 31,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 31,
      "pull_request_review_id" : 336980010,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17681",
      "updated_at" : "2019-12-29T23:47:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/361878437",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   }
]
