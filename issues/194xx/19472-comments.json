[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #18638 (net: Use mockable time for ping/pong, add tests by MarcoFalke)\n* #17785 (p2p: Unify Send and Receive protocol versions by hebasto)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-07-08T23:32:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#issuecomment-655810542",
      "id" : 655810542,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19472",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1NTgxMDU0Mg==",
      "updated_at" : "2020-07-08T23:32:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/655810542",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452101343"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452101343"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```\r\nnet_processing.cpp:3574:9: error: acquiring mutex 'cs_main' that is already held [-Werror,-Wthread-safety-analysis]\r\n\r\n        LOCK(cs_main);\r\n\r\n        ^",
      "commit_id" : "f54af5e58649d527d53990259f77892ad07f7ffa",
      "created_at" : "2020-07-09T09:53:10Z",
      "diff_hunk" : "@@ -3563,32 +3563,44 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode           The node to check.\n+ * @return                      True if the peer will be disconnected.\n+ */\n bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\n {\n-    AssertLockHeld(cs_main);\n-    CNodeState &state = *State(pnode.GetId());\n+    {\n+        LOCK(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452101343",
      "id" : 452101343,
      "line" : 3574,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjEwMTM0Mw==",
      "original_commit_id" : "5722b338d02be8de49b9e53664485c8cab4c526c",
      "original_line" : 3574,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 14,
      "pull_request_review_id" : 445463146,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-09T16:48:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452101343",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452102686"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452102686"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You might have to use clang++ to reproduce locally",
      "commit_id" : "f54af5e58649d527d53990259f77892ad07f7ffa",
      "created_at" : "2020-07-09T09:55:34Z",
      "diff_hunk" : "@@ -3563,32 +3563,44 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode           The node to check.\n+ * @return                      True if the peer will be disconnected.\n+ */\n bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\n {\n-    AssertLockHeld(cs_main);\n-    CNodeState &state = *State(pnode.GetId());\n+    {\n+        LOCK(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452102686",
      "id" : 452102686,
      "in_reply_to_id" : 452101343,
      "line" : 3574,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjEwMjY4Ng==",
      "original_commit_id" : "5722b338d02be8de49b9e53664485c8cab4c526c",
      "original_line" : 3574,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 14,
      "pull_request_review_id" : 445464953,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-09T16:48:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452102686",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452125782"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452125782"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah. I didn't remove the lock annotation from the function declaration. Fixed.",
      "commit_id" : "f54af5e58649d527d53990259f77892ad07f7ffa",
      "created_at" : "2020-07-09T10:38:50Z",
      "diff_hunk" : "@@ -3563,32 +3563,44 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode           The node to check.\n+ * @return                      True if the peer will be disconnected.\n+ */\n bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\n {\n-    AssertLockHeld(cs_main);\n-    CNodeState &state = *State(pnode.GetId());\n+    {\n+        LOCK(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452125782",
      "id" : 452125782,
      "in_reply_to_id" : 452101343,
      "line" : 3574,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjEyNTc4Mg==",
      "original_commit_id" : "5722b338d02be8de49b9e53664485c8cab4c526c",
      "original_line" : 3574,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 14,
      "pull_request_review_id" : 445496753,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-09T16:48:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452125782",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452147247"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452147247"
         }
      },
      "author_association" : "MEMBER",
      "body" : "edd1a8a5c76a15174985fe0a1a876eba9e7ee33c\r\n\r\nDo you have an idea why this wasn't in the top?",
      "commit_id" : "f54af5e58649d527d53990259f77892ad07f7ffa",
      "created_at" : "2020-07-09T11:23:44Z",
      "diff_hunk" : "@@ -3881,8 +3883,6 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n     {\n         LOCK(cs_main);\n \n-        if (MaybeDiscourageAndDisconnect(*pto)) return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452147247",
      "id" : 452147247,
      "line" : 3888,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjE0NzI0Nw==",
      "original_commit_id" : "edd1a8a5c76a15174985fe0a1a876eba9e7ee33c",
      "original_line" : 3884,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 130,
      "pull_request_review_id" : 445524800,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-09T16:48:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452147247",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452149662"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452149662"
         }
      },
      "author_association" : "MEMBER",
      "body" : "37e7265796102df35ec83b53fe9114e07d214910\r\n\r\nMaybe drop these `else` since you early return on each block.",
      "commit_id" : "f54af5e58649d527d53990259f77892ad07f7ffa",
      "created_at" : "2020-07-09T11:28:28Z",
      "diff_hunk" : "@@ -3563,32 +3563,44 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode           The node to check.\n+ * @return                      True if the peer will be disconnected.\n+ */\n bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\n {\n-    LOCK(cs_main);\n-    CNodeState &state = *State(pnode.GetId());\n+    {\n+        LOCK(cs_main);\n+        CNodeState &state = *State(pnode.GetId());\n+\n+        // There's nothing to do if the m_should_discourage flag isn't set\n+        if (!state.m_should_discourage) return false;\n \n-    if (state.m_should_discourage) {\n+        // Reset m_should_discourage\n         state.m_should_discourage = false;\n-        if (pnode.HasPermission(PF_NOBAN)) {\n-            LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.m_manual_connection) {\n-            LogPrintf(\"Warning: not punishing manually-connected peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.addr.IsLocal()) {\n-            // Disconnect but don't discourage this local node\n-            LogPrintf(\"Warning: disconnecting but not discouraging local peer %s!\\n\", pnode.addr.ToString());\n-            pnode.fDisconnect = true;\n-        } else {\n-            // Disconnect and discourage all nodes sharing the address\n-            LogPrintf(\"Disconnecting and discouraging peer %s!\\n\", pnode.addr.ToString());\n-            if (m_banman) {\n-                m_banman->Discourage(pnode.addr);\n-            }\n-            connman->DisconnectNode(pnode.addr);\n-        }\n+    } // cs_main\n+\n+    if (pnode.HasPermission(PF_NOBAN)) {\n+        // Log but don't disconnect\n+        LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\n+        return false;\n+    } else if (pnode.m_manual_connection) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452149662",
      "id" : 452149662,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjE0OTY2Mg==",
      "original_commit_id" : "37e7265796102df35ec83b53fe9114e07d214910",
      "original_line" : 3588,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 445524800,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-09T16:48:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452149662",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452150787"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452150787"
         }
      },
      "author_association" : "MEMBER",
      "body" : "37e7265796102df35ec83b53fe9114e07d214910\r\n\r\nnit, I only find this comment useful when the block is big enough.",
      "commit_id" : "f54af5e58649d527d53990259f77892ad07f7ffa",
      "created_at" : "2020-07-09T11:30:50Z",
      "diff_hunk" : "@@ -3563,32 +3563,44 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode           The node to check.\n+ * @return                      True if the peer will be disconnected.\n+ */\n bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\n {\n-    LOCK(cs_main);\n-    CNodeState &state = *State(pnode.GetId());\n+    {\n+        LOCK(cs_main);\n+        CNodeState &state = *State(pnode.GetId());\n+\n+        // There's nothing to do if the m_should_discourage flag isn't set\n+        if (!state.m_should_discourage) return false;\n \n-    if (state.m_should_discourage) {\n+        // Reset m_should_discourage\n         state.m_should_discourage = false;\n-        if (pnode.HasPermission(PF_NOBAN)) {\n-            LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.m_manual_connection) {\n-            LogPrintf(\"Warning: not punishing manually-connected peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.addr.IsLocal()) {\n-            // Disconnect but don't discourage this local node\n-            LogPrintf(\"Warning: disconnecting but not discouraging local peer %s!\\n\", pnode.addr.ToString());\n-            pnode.fDisconnect = true;\n-        } else {\n-            // Disconnect and discourage all nodes sharing the address\n-            LogPrintf(\"Disconnecting and discouraging peer %s!\\n\", pnode.addr.ToString());\n-            if (m_banman) {\n-                m_banman->Discourage(pnode.addr);\n-            }\n-            connman->DisconnectNode(pnode.addr);\n-        }\n+    } // cs_main",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452150787",
      "id" : 452150787,
      "line" : 3582,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjE1MDc4Nw==",
      "original_commit_id" : "37e7265796102df35ec83b53fe9114e07d214910",
      "original_line" : 3582,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 39,
      "pull_request_review_id" : 445524800,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-09T16:48:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452150787",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452151279"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452151279"
         }
      },
      "author_association" : "MEMBER",
      "body" : "37e7265796102df35ec83b53fe9114e07d214910\r\n\r\nNo test for this right?",
      "commit_id" : "f54af5e58649d527d53990259f77892ad07f7ffa",
      "created_at" : "2020-07-09T11:31:54Z",
      "diff_hunk" : "@@ -3563,32 +3563,44 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode           The node to check.\n+ * @return                      True if the peer will be disconnected.\n+ */\n bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\n {\n-    LOCK(cs_main);\n-    CNodeState &state = *State(pnode.GetId());\n+    {\n+        LOCK(cs_main);\n+        CNodeState &state = *State(pnode.GetId());\n+\n+        // There's nothing to do if the m_should_discourage flag isn't set\n+        if (!state.m_should_discourage) return false;\n \n-    if (state.m_should_discourage) {\n+        // Reset m_should_discourage\n         state.m_should_discourage = false;\n-        if (pnode.HasPermission(PF_NOBAN)) {\n-            LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.m_manual_connection) {\n-            LogPrintf(\"Warning: not punishing manually-connected peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.addr.IsLocal()) {\n-            // Disconnect but don't discourage this local node\n-            LogPrintf(\"Warning: disconnecting but not discouraging local peer %s!\\n\", pnode.addr.ToString());\n-            pnode.fDisconnect = true;\n-        } else {\n-            // Disconnect and discourage all nodes sharing the address\n-            LogPrintf(\"Disconnecting and discouraging peer %s!\\n\", pnode.addr.ToString());\n-            if (m_banman) {\n-                m_banman->Discourage(pnode.addr);\n-            }\n-            connman->DisconnectNode(pnode.addr);\n-        }\n+    } // cs_main\n+\n+    if (pnode.HasPermission(PF_NOBAN)) {\n+        // Log but don't disconnect\n+        LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\n+        return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452151279",
      "id" : 452151279,
      "line" : 3587,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjE1MTI3OQ==",
      "original_commit_id" : "37e7265796102df35ec83b53fe9114e07d214910",
      "original_line" : 3587,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 44,
      "pull_request_review_id" : 445524800,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-09T16:48:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452151279",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452166851"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452166851"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Saw this warning as well @ 5722b338d. Now building at 37e726579.",
      "commit_id" : "f54af5e58649d527d53990259f77892ad07f7ffa",
      "created_at" : "2020-07-09T12:03:47Z",
      "diff_hunk" : "@@ -3563,32 +3563,44 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode           The node to check.\n+ * @return                      True if the peer will be disconnected.\n+ */\n bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\n {\n-    AssertLockHeld(cs_main);\n-    CNodeState &state = *State(pnode.GetId());\n+    {\n+        LOCK(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452166851",
      "id" : 452166851,
      "in_reply_to_id" : 452101343,
      "line" : 3574,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjE2Njg1MQ==",
      "original_commit_id" : "5722b338d02be8de49b9e53664485c8cab4c526c",
      "original_line" : 3574,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 14,
      "pull_request_review_id" : 445550030,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-09T16:48:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452166851",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452238852"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452238852"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Because it used to be `SendRejectsAndCheckIfBanned()`, and before that it was just sending rejects. Those required cs_main, which is taken after the ping processing at the top.\r\n\r\nI've added that explanation to the commit log.",
      "commit_id" : "f54af5e58649d527d53990259f77892ad07f7ffa",
      "created_at" : "2020-07-09T13:59:25Z",
      "diff_hunk" : "@@ -3881,8 +3883,6 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n     {\n         LOCK(cs_main);\n \n-        if (MaybeDiscourageAndDisconnect(*pto)) return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452238852",
      "id" : 452238852,
      "in_reply_to_id" : 452147247,
      "line" : 3888,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjIzODg1Mg==",
      "original_commit_id" : "edd1a8a5c76a15174985fe0a1a876eba9e7ee33c",
      "original_line" : 3884,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 130,
      "pull_request_review_id" : 445643932,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-09T16:48:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452238852",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452258091"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452258091"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Agree. That's much clearer.",
      "commit_id" : "f54af5e58649d527d53990259f77892ad07f7ffa",
      "created_at" : "2020-07-09T14:26:18Z",
      "diff_hunk" : "@@ -3563,32 +3563,44 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode           The node to check.\n+ * @return                      True if the peer will be disconnected.\n+ */\n bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\n {\n-    LOCK(cs_main);\n-    CNodeState &state = *State(pnode.GetId());\n+    {\n+        LOCK(cs_main);\n+        CNodeState &state = *State(pnode.GetId());\n+\n+        // There's nothing to do if the m_should_discourage flag isn't set\n+        if (!state.m_should_discourage) return false;\n \n-    if (state.m_should_discourage) {\n+        // Reset m_should_discourage\n         state.m_should_discourage = false;\n-        if (pnode.HasPermission(PF_NOBAN)) {\n-            LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.m_manual_connection) {\n-            LogPrintf(\"Warning: not punishing manually-connected peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.addr.IsLocal()) {\n-            // Disconnect but don't discourage this local node\n-            LogPrintf(\"Warning: disconnecting but not discouraging local peer %s!\\n\", pnode.addr.ToString());\n-            pnode.fDisconnect = true;\n-        } else {\n-            // Disconnect and discourage all nodes sharing the address\n-            LogPrintf(\"Disconnecting and discouraging peer %s!\\n\", pnode.addr.ToString());\n-            if (m_banman) {\n-                m_banman->Discourage(pnode.addr);\n-            }\n-            connman->DisconnectNode(pnode.addr);\n-        }\n+    } // cs_main\n+\n+    if (pnode.HasPermission(PF_NOBAN)) {\n+        // Log but don't disconnect\n+        LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\n+        return false;\n+    } else if (pnode.m_manual_connection) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452258091",
      "id" : 452258091,
      "in_reply_to_id" : 452149662,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI1ODA5MQ==",
      "original_commit_id" : "37e7265796102df35ec83b53fe9114e07d214910",
      "original_line" : 3588,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 445669667,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-09T16:48:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452258091",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452258263"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452258263"
         }
      },
      "author_association" : "MEMBER",
      "body" : "That's fair, but I don't think it does any harm.",
      "commit_id" : "f54af5e58649d527d53990259f77892ad07f7ffa",
      "created_at" : "2020-07-09T14:26:32Z",
      "diff_hunk" : "@@ -3563,32 +3563,44 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode           The node to check.\n+ * @return                      True if the peer will be disconnected.\n+ */\n bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\n {\n-    LOCK(cs_main);\n-    CNodeState &state = *State(pnode.GetId());\n+    {\n+        LOCK(cs_main);\n+        CNodeState &state = *State(pnode.GetId());\n+\n+        // There's nothing to do if the m_should_discourage flag isn't set\n+        if (!state.m_should_discourage) return false;\n \n-    if (state.m_should_discourage) {\n+        // Reset m_should_discourage\n         state.m_should_discourage = false;\n-        if (pnode.HasPermission(PF_NOBAN)) {\n-            LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.m_manual_connection) {\n-            LogPrintf(\"Warning: not punishing manually-connected peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.addr.IsLocal()) {\n-            // Disconnect but don't discourage this local node\n-            LogPrintf(\"Warning: disconnecting but not discouraging local peer %s!\\n\", pnode.addr.ToString());\n-            pnode.fDisconnect = true;\n-        } else {\n-            // Disconnect and discourage all nodes sharing the address\n-            LogPrintf(\"Disconnecting and discouraging peer %s!\\n\", pnode.addr.ToString());\n-            if (m_banman) {\n-                m_banman->Discourage(pnode.addr);\n-            }\n-            connman->DisconnectNode(pnode.addr);\n-        }\n+    } // cs_main",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452258263",
      "id" : 452258263,
      "in_reply_to_id" : 452150787,
      "line" : 3582,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI1ODI2Mw==",
      "original_commit_id" : "37e7265796102df35ec83b53fe9114e07d214910",
      "original_line" : 3582,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 39,
      "pull_request_review_id" : 445669902,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-09T16:48:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452258263",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452259600"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452259600"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It seems that feature_maxuploadtarget.py tests the `-noban` permission (by verifying that a peer stays connected after exceeding the banscore.",
      "commit_id" : "f54af5e58649d527d53990259f77892ad07f7ffa",
      "created_at" : "2020-07-09T14:28:28Z",
      "diff_hunk" : "@@ -3563,32 +3563,44 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode           The node to check.\n+ * @return                      True if the peer will be disconnected.\n+ */\n bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\n {\n-    LOCK(cs_main);\n-    CNodeState &state = *State(pnode.GetId());\n+    {\n+        LOCK(cs_main);\n+        CNodeState &state = *State(pnode.GetId());\n+\n+        // There's nothing to do if the m_should_discourage flag isn't set\n+        if (!state.m_should_discourage) return false;\n \n-    if (state.m_should_discourage) {\n+        // Reset m_should_discourage\n         state.m_should_discourage = false;\n-        if (pnode.HasPermission(PF_NOBAN)) {\n-            LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.m_manual_connection) {\n-            LogPrintf(\"Warning: not punishing manually-connected peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.addr.IsLocal()) {\n-            // Disconnect but don't discourage this local node\n-            LogPrintf(\"Warning: disconnecting but not discouraging local peer %s!\\n\", pnode.addr.ToString());\n-            pnode.fDisconnect = true;\n-        } else {\n-            // Disconnect and discourage all nodes sharing the address\n-            LogPrintf(\"Disconnecting and discouraging peer %s!\\n\", pnode.addr.ToString());\n-            if (m_banman) {\n-                m_banman->Discourage(pnode.addr);\n-            }\n-            connman->DisconnectNode(pnode.addr);\n-        }\n+    } // cs_main\n+\n+    if (pnode.HasPermission(PF_NOBAN)) {\n+        // Log but don't disconnect\n+        LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\n+        return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452259600",
      "id" : 452259600,
      "in_reply_to_id" : 452151279,
      "line" : 3587,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI1OTYwMA==",
      "original_commit_id" : "37e7265796102df35ec83b53fe9114e07d214910",
      "original_line" : 3587,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 44,
      "pull_request_review_id" : 445671743,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-09T16:48:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452259600",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review @promag . I've addressed your comments.",
      "created_at" : "2020-07-09T14:28:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#issuecomment-656161599",
      "id" : 656161599,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19472",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1NjE2MTU5OQ==",
      "updated_at" : "2020-07-09T14:28:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/656161599",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452343368"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452343368"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The whitespace linter needs appeasing, looks like extra whitespace in lines 3589 and 3595.\r\n```diff\r\ndiff --git a/src/net_processing.cpp b/src/net_processing.cpp\r\n\r\n@@ -3573,16 +3582,18 @@ bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\r\n\r\n+\r\n\r\n+\r\n\r\n^---- failure generated from test/lint/lint-whitespace.sh\r\n```\r\n(which won't prevent me from reviewing tomorrow am, so no rush)",
      "commit_id" : "f54af5e58649d527d53990259f77892ad07f7ffa",
      "created_at" : "2020-07-09T16:29:56Z",
      "diff_hunk" : "@@ -3563,32 +3563,48 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode           The node to check.\n+ * @return                      True if the peer will be disconnected.\n+ */\n bool PeerLogicValidation::MaybeDiscourageAndDisconnect(CNode& pnode)\n {\n-    AssertLockHeld(cs_main);\n-    CNodeState &state = *State(pnode.GetId());\n+    {\n+        LOCK(cs_main);\n+        CNodeState &state = *State(pnode.GetId());\n+\n+        // There's nothing to do if the m_should_discourage flag isn't set\n+        if (!state.m_should_discourage) return false;\n \n-    if (state.m_should_discourage) {\n+        // Reset m_should_discourage\n         state.m_should_discourage = false;\n-        if (pnode.HasPermission(PF_NOBAN)) {\n-            LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.m_manual_connection) {\n-            LogPrintf(\"Warning: not punishing manually-connected peer %s!\\n\", pnode.addr.ToString());\n-        } else if (pnode.addr.IsLocal()) {\n-            // Disconnect but don't discourage this local node\n-            LogPrintf(\"Warning: disconnecting but not discouraging local peer %s!\\n\", pnode.addr.ToString());\n-            pnode.fDisconnect = true;\n-        } else {\n-            // Disconnect and discourage all nodes sharing the address\n-            LogPrintf(\"Disconnecting and discouraging peer %s!\\n\", pnode.addr.ToString());\n-            if (m_banman) {\n-                m_banman->Discourage(pnode.addr);\n-            }\n-            connman->DisconnectNode(pnode.addr);\n-        }\n+    } // cs_main\n+\n+    if (pnode.HasPermission(PF_NOBAN)) {\n+        // Peer has the NOBAN permission flag - log but don't disconnect\n+        LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode.addr.ToString());\n+        return false;\n+    }\n+    \n+    if (pnode.m_manual_connection) {\n+        // Peer is a manual connection - log but don't disconnect\n+        LogPrintf(\"Warning: not punishing manually-connected peer %s!\\n\", pnode.addr.ToString());\n+        return false;\n+    }\n+    ",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452343368",
      "id" : 452343368,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjM0MzM2OA==",
      "original_commit_id" : "c3dde2b52a641a8351a969c058d438f59edfeff0",
      "original_line" : 3595,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 445781296,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-09T16:48:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452343368",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452458981"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452458981"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "What about something along the lines of \"True if the peer was marked for disconnection in this function\"?",
      "commit_id" : "f54af5e58649d527d53990259f77892ad07f7ffa",
      "created_at" : "2020-07-09T20:03:25Z",
      "diff_hunk" : "@@ -3563,32 +3563,48 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode           The node to check.\n+ * @return                      True if the peer will be disconnected.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452458981",
      "id" : 452458981,
      "line" : 3569,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ1ODk4MQ==",
      "original_commit_id" : "f54af5e58649d527d53990259f77892ad07f7ffa",
      "original_line" : 3569,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 7,
      "pull_request_review_id" : 445929332,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-09T20:03:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452458981",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452467029"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452467029"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Sure. Happy to make that change if I need to retouch this PR.",
      "commit_id" : "f54af5e58649d527d53990259f77892ad07f7ffa",
      "created_at" : "2020-07-09T20:20:02Z",
      "diff_hunk" : "@@ -3563,32 +3563,48 @@ void ProcessMessage(\n     return;\n }\n \n+/** Maybe disconnect a peer and discourage future connections from its address.\n+ *\n+ * @param[in]   pnode           The node to check.\n+ * @return                      True if the peer will be disconnected.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19472#discussion_r452467029",
      "id" : 452467029,
      "in_reply_to_id" : 452458981,
      "line" : 3569,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ2NzAyOQ==",
      "original_commit_id" : "f54af5e58649d527d53990259f77892ad07f7ffa",
      "original_line" : 3569,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 7,
      "pull_request_review_id" : 445939726,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19472",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-09T20:20:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452467029",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   }
]
