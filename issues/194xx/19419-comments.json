[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #18095 (Fix crashes and infinite loop in ListWalletDir() by uhliksk)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-06-30T13:00:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19419#issuecomment-651774831",
      "id" : 651774831,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19419",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1MTc3NDgzMQ==",
      "updated_at" : "2020-06-30T13:00:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/651774831",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "No strong opinion regarding excluding some paths. Current patch needs to be updated (format) and maybe change implementation to use a list of ignore/exclude paths.\r\n\r\nThis can improve GUI by reducing freezes but it's not the right fix for that. When `ListWalletDir` is triggered from the GUI, it should be called on a background thread. Alternatively we could consider caching `ListWalletDir` result and invalidate it when wallets are created or loaded.",
      "created_at" : "2020-07-01T09:40:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19419#issuecomment-652311748",
      "id" : 652311748,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19419",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1MjMxMTc0OA==",
      "updated_at" : "2020-07-01T09:40:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/652311748",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> No strong opinion regarding excluding some paths. Current patch needs to be updated (format) and maybe change implementation to use a list of ignore/exclude paths.\r\n> \r\n> This can improve GUI by reducing freezes but it's not the right fix for that. When `ListWalletDir` is triggered from the GUI, it should be called on a background thread. Alternatively we could consider caching `ListWalletDir` result and invalidate it when wallets are created or loaded.\r\n\r\nyup, ugly quick fix and background thread seams reasonable.. but fix proves the point and lets be honest why should we waste time and risk locks, when traverse trough known node dir?.. .  also other GUI freezes should be tackled.\r\nBefore moon scale there is a long list of things in my backlog, that need to be fixed before bam..\r\n.\r\nThere might be soon real users who use the gui,  and lets be real, gui is bitcoin for them.\r\n\r\n",
      "created_at" : "2020-07-01T12:22:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19419#issuecomment-652386136",
      "id" : 652386136,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19419",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1MjM4NjEzNg==",
      "updated_at" : "2020-07-01T12:22:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/652386136",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/34917548?v=4",
         "events_url" : "https://api.github.com/users/Saibato/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Saibato/followers",
         "following_url" : "https://api.github.com/users/Saibato/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Saibato/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Saibato",
         "id" : 34917548,
         "login" : "Saibato",
         "node_id" : "MDQ6VXNlcjM0OTE3NTQ4",
         "organizations_url" : "https://api.github.com/users/Saibato/orgs",
         "received_events_url" : "https://api.github.com/users/Saibato/received_events",
         "repos_url" : "https://api.github.com/users/Saibato/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Saibato/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Saibato/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Saibato"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19419#discussion_r448630671"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19419"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/448630671"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Instead of multiple variables, you can declare something like `const std::vector ignore_paths{ GetBlocksDir(), sub_path / \"testnet3\", ... }` and then compare against this.",
      "commit_id" : "320e94ecc1b78c59fd6e68907b04baa22630a204",
      "created_at" : "2020-07-01T21:40:32Z",
      "diff_hunk" : "@@ -60,33 +60,69 @@ std::vector<fs::path> ListWalletDir()\n     const size_t offset = wallet_dir.string().size() + 1;\n     std::vector<fs::path> paths;\n     boost::system::error_code ec;\n+    fs::path sub_path = GetDataDir();\n+\n+    bool we_have_wallets_dir = (wallet_dir != sub_path);\n+    const fs::path fblocks = GetBlocksDir();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19419#discussion_r448630671",
      "id" : 448630671,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYzMDY3MQ==",
      "original_commit_id" : "3d69e4ccaeae53a8a14f05b062448f4898734dbe",
      "original_line" : 66,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/wallet/walletutil.cpp",
      "position" : null,
      "pull_request_review_id" : 441214538,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19419",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-13T13:33:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/448630671",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19419#discussion_r448701432"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19419"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/448701432"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "yup  :+1:  , btw strange how long those bare strings survived refactor, still no global #define BLOCKS_DIR or TESTNET_STR etc.     ",
      "commit_id" : "320e94ecc1b78c59fd6e68907b04baa22630a204",
      "created_at" : "2020-07-02T01:39:34Z",
      "diff_hunk" : "@@ -60,33 +60,69 @@ std::vector<fs::path> ListWalletDir()\n     const size_t offset = wallet_dir.string().size() + 1;\n     std::vector<fs::path> paths;\n     boost::system::error_code ec;\n+    fs::path sub_path = GetDataDir();\n+\n+    bool we_have_wallets_dir = (wallet_dir != sub_path);\n+    const fs::path fblocks = GetBlocksDir();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19419#discussion_r448701432",
      "id" : 448701432,
      "in_reply_to_id" : 448630671,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODcwMTQzMg==",
      "original_commit_id" : "3d69e4ccaeae53a8a14f05b062448f4898734dbe",
      "original_line" : 66,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/wallet/walletutil.cpp",
      "position" : null,
      "pull_request_review_id" : 441294967,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19419",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-13T13:33:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/448701432",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/34917548?v=4",
         "events_url" : "https://api.github.com/users/Saibato/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Saibato/followers",
         "following_url" : "https://api.github.com/users/Saibato/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Saibato/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Saibato",
         "id" : 34917548,
         "login" : "Saibato",
         "node_id" : "MDQ6VXNlcjM0OTE3NTQ4",
         "organizations_url" : "https://api.github.com/users/Saibato/orgs",
         "received_events_url" : "https://api.github.com/users/Saibato/received_events",
         "repos_url" : "https://api.github.com/users/Saibato/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Saibato/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Saibato/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Saibato"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19419#discussion_r452407475"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19419"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452407475"
         }
      },
      "author_association" : "MEMBER",
      "body" : "better to define `skip_path` here\r\n\r\nNote to other reviewers, the enum file_type: https://www.boost.org/doc/libs/1_66_0/libs/filesystem/doc/reference.html#Enum-file_type",
      "commit_id" : "320e94ecc1b78c59fd6e68907b04baa22630a204",
      "created_at" : "2020-07-09T18:23:12Z",
      "diff_hunk" : "@@ -57,23 +57,48 @@ static bool IsBerkeleyBtree(const fs::path& path)\n std::vector<fs::path> ListWalletDir()\n {\n     const fs::path wallet_dir = GetWalletDir();\n+    const fs::path data_dir = GetDataDir();\n+    const fs::path blocks_dir = GetBlocksDir();\n+\n     const size_t offset = wallet_dir.string().size() + 1;\n     std::vector<fs::path> paths;\n     boost::system::error_code ec;\n \n+    bool skip_path;\n+    // Here we place the top level dirs we want to skip in case walletdir is datadir or blocksdir\n+    const std::vector<fs::path> ignore_paths = {\n+                                        blocks_dir,\n+                                        data_dir / \"testnet3\",\n+                                        data_dir / \"regtest\",\n+                                        data_dir / \"chainstate\",\n+                                        data_dir / \"database\",\n+                                        data_dir / \"indexes\",\n+                                        };\n+\n     for (auto it = fs::recursive_directory_iterator(wallet_dir, ec); it != fs::recursive_directory_iterator(); it.increment(ec)) {\n         if (ec) {\n             LogPrintf(\"%s: %s %s\\n\", __func__, ec.message(), it->path().string());\n             continue;\n         }\n-\n-        // Get wallet path relative to walletdir by removing walletdir from the wallet path.\n-        // This can be replaced by boost::filesystem::lexically_relative once boost is bumped to 1.60.\n-        const fs::path path = it->path().string().substr(offset);\n+        // We dont want to iterate trough those special node dirs\n+        if (it->status().type() == fs::directory_file) {\n+            skip_path = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19419#discussion_r452407475",
      "id" : 452407475,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQwNzQ3NQ==",
      "original_commit_id" : "4aa7bc58d4d615069774997dd68f2b6925165fbf",
      "original_line" : 85,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/wallet/walletutil.cpp",
      "position" : null,
      "pull_request_review_id" : 445863101,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19419",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-13T13:33:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452407475",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19419#discussion_r452409592"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19419"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452409592"
         }
      },
      "author_association" : "MEMBER",
      "body" : "could use `break;` so you don't need to check `!skip_path &&` (and in fact, don't need it at all)\r\n\r\nYou can also do `it.disable_recursion_pending();` here",
      "commit_id" : "320e94ecc1b78c59fd6e68907b04baa22630a204",
      "created_at" : "2020-07-09T18:26:58Z",
      "diff_hunk" : "@@ -57,23 +57,48 @@ static bool IsBerkeleyBtree(const fs::path& path)\n std::vector<fs::path> ListWalletDir()\n {\n     const fs::path wallet_dir = GetWalletDir();\n+    const fs::path data_dir = GetDataDir();\n+    const fs::path blocks_dir = GetBlocksDir();\n+\n     const size_t offset = wallet_dir.string().size() + 1;\n     std::vector<fs::path> paths;\n     boost::system::error_code ec;\n \n+    bool skip_path;\n+    // Here we place the top level dirs we want to skip in case walletdir is datadir or blocksdir\n+    const std::vector<fs::path> ignore_paths = {\n+                                        blocks_dir,\n+                                        data_dir / \"testnet3\",\n+                                        data_dir / \"regtest\",\n+                                        data_dir / \"chainstate\",\n+                                        data_dir / \"database\",\n+                                        data_dir / \"indexes\",\n+                                        };\n+\n     for (auto it = fs::recursive_directory_iterator(wallet_dir, ec); it != fs::recursive_directory_iterator(); it.increment(ec)) {\n         if (ec) {\n             LogPrintf(\"%s: %s %s\\n\", __func__, ec.message(), it->path().string());\n             continue;\n         }\n-\n-        // Get wallet path relative to walletdir by removing walletdir from the wallet path.\n-        // This can be replaced by boost::filesystem::lexically_relative once boost is bumped to 1.60.\n-        const fs::path path = it->path().string().substr(offset);\n+        // We dont want to iterate trough those special node dirs\n+        if (it->status().type() == fs::directory_file) {\n+            skip_path = false;\n+            for(const auto& fpath: ignore_paths) {\n+                if (!skip_path && it->path().string().find(fpath.string()) == 0) {\n+                    skip_path = true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19419#discussion_r452409592",
      "id" : 452409592,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQwOTU5Mg==",
      "original_commit_id" : "4aa7bc58d4d615069774997dd68f2b6925165fbf",
      "original_line" : 88,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/wallet/walletutil.cpp",
      "position" : null,
      "pull_request_review_id" : 445863101,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19419",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-13T13:33:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452409592",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19419#discussion_r452410603"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19419"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452410603"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: just use brackets and newline\r\n\r\nAlso, I think we should follow symlinks? `symlink_file`",
      "commit_id" : "320e94ecc1b78c59fd6e68907b04baa22630a204",
      "created_at" : "2020-07-09T18:28:53Z",
      "diff_hunk" : "@@ -57,23 +57,48 @@ static bool IsBerkeleyBtree(const fs::path& path)\n std::vector<fs::path> ListWalletDir()\n {\n     const fs::path wallet_dir = GetWalletDir();\n+    const fs::path data_dir = GetDataDir();\n+    const fs::path blocks_dir = GetBlocksDir();\n+\n     const size_t offset = wallet_dir.string().size() + 1;\n     std::vector<fs::path> paths;\n     boost::system::error_code ec;\n \n+    bool skip_path;\n+    // Here we place the top level dirs we want to skip in case walletdir is datadir or blocksdir\n+    const std::vector<fs::path> ignore_paths = {\n+                                        blocks_dir,\n+                                        data_dir / \"testnet3\",\n+                                        data_dir / \"regtest\",\n+                                        data_dir / \"chainstate\",\n+                                        data_dir / \"database\",\n+                                        data_dir / \"indexes\",\n+                                        };\n+\n     for (auto it = fs::recursive_directory_iterator(wallet_dir, ec); it != fs::recursive_directory_iterator(); it.increment(ec)) {\n         if (ec) {\n             LogPrintf(\"%s: %s %s\\n\", __func__, ec.message(), it->path().string());\n             continue;\n         }\n-\n-        // Get wallet path relative to walletdir by removing walletdir from the wallet path.\n-        // This can be replaced by boost::filesystem::lexically_relative once boost is bumped to 1.60.\n-        const fs::path path = it->path().string().substr(offset);\n+        // We dont want to iterate trough those special node dirs\n+        if (it->status().type() == fs::directory_file) {\n+            skip_path = false;\n+            for(const auto& fpath: ignore_paths) {\n+                if (!skip_path && it->path().string().find(fpath.string()) == 0) {\n+                    skip_path = true;\n+                }\n+            }\n+            if (skip_path) {\n+                it.disable_recursion_pending();\n+                continue;\n+            }\n+        } else it.disable_recursion_pending();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19419#discussion_r452410603",
      "id" : 452410603,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQxMDYwMw==",
      "original_commit_id" : "4aa7bc58d4d615069774997dd68f2b6925165fbf",
      "original_line" : 95,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/wallet/walletutil.cpp",
      "position" : null,
      "pull_request_review_id" : 445863101,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19419",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-13T13:33:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452410603",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19419#discussion_r453349974"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19419"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/453349974"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Following symlinks could create an infinite loop.",
      "commit_id" : "320e94ecc1b78c59fd6e68907b04baa22630a204",
      "created_at" : "2020-07-12T18:45:54Z",
      "diff_hunk" : "@@ -57,23 +57,48 @@ static bool IsBerkeleyBtree(const fs::path& path)\n std::vector<fs::path> ListWalletDir()\n {\n     const fs::path wallet_dir = GetWalletDir();\n+    const fs::path data_dir = GetDataDir();\n+    const fs::path blocks_dir = GetBlocksDir();\n+\n     const size_t offset = wallet_dir.string().size() + 1;\n     std::vector<fs::path> paths;\n     boost::system::error_code ec;\n \n+    bool skip_path;\n+    // Here we place the top level dirs we want to skip in case walletdir is datadir or blocksdir\n+    const std::vector<fs::path> ignore_paths = {\n+                                        blocks_dir,\n+                                        data_dir / \"testnet3\",\n+                                        data_dir / \"regtest\",\n+                                        data_dir / \"chainstate\",\n+                                        data_dir / \"database\",\n+                                        data_dir / \"indexes\",\n+                                        };\n+\n     for (auto it = fs::recursive_directory_iterator(wallet_dir, ec); it != fs::recursive_directory_iterator(); it.increment(ec)) {\n         if (ec) {\n             LogPrintf(\"%s: %s %s\\n\", __func__, ec.message(), it->path().string());\n             continue;\n         }\n-\n-        // Get wallet path relative to walletdir by removing walletdir from the wallet path.\n-        // This can be replaced by boost::filesystem::lexically_relative once boost is bumped to 1.60.\n-        const fs::path path = it->path().string().substr(offset);\n+        // We dont want to iterate trough those special node dirs\n+        if (it->status().type() == fs::directory_file) {\n+            skip_path = false;\n+            for(const auto& fpath: ignore_paths) {\n+                if (!skip_path && it->path().string().find(fpath.string()) == 0) {\n+                    skip_path = true;\n+                }\n+            }\n+            if (skip_path) {\n+                it.disable_recursion_pending();\n+                continue;\n+            }\n+        } else it.disable_recursion_pending();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19419#discussion_r453349974",
      "id" : 453349974,
      "in_reply_to_id" : 452410603,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM0OTk3NA==",
      "original_commit_id" : "4aa7bc58d4d615069774997dd68f2b6925165fbf",
      "original_line" : 95,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/wallet/walletutil.cpp",
      "position" : null,
      "pull_request_review_id" : 446901219,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19419",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-13T13:33:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/453349974",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19419#discussion_r453350233"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19419"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/453350233"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Since we're using exact paths in `ignore_paths`, can't we use an exact match? (And then `ignore_paths` can become an `unordered_set` and just use `.count` here...)",
      "commit_id" : "320e94ecc1b78c59fd6e68907b04baa22630a204",
      "created_at" : "2020-07-12T18:48:46Z",
      "diff_hunk" : "@@ -57,23 +57,48 @@ static bool IsBerkeleyBtree(const fs::path& path)\n std::vector<fs::path> ListWalletDir()\n {\n     const fs::path wallet_dir = GetWalletDir();\n+    const fs::path data_dir = GetDataDir();\n+    const fs::path blocks_dir = GetBlocksDir();\n+\n     const size_t offset = wallet_dir.string().size() + 1;\n     std::vector<fs::path> paths;\n     boost::system::error_code ec;\n \n+    bool skip_path;\n+    // Here we place the top level dirs we want to skip in case walletdir is datadir or blocksdir\n+    const std::vector<fs::path> ignore_paths = {\n+                                        blocks_dir,\n+                                        data_dir / \"testnet3\",\n+                                        data_dir / \"regtest\",\n+                                        data_dir / \"chainstate\",\n+                                        data_dir / \"database\",\n+                                        data_dir / \"indexes\",\n+                                        };\n+\n     for (auto it = fs::recursive_directory_iterator(wallet_dir, ec); it != fs::recursive_directory_iterator(); it.increment(ec)) {\n         if (ec) {\n             LogPrintf(\"%s: %s %s\\n\", __func__, ec.message(), it->path().string());\n             continue;\n         }\n-\n-        // Get wallet path relative to walletdir by removing walletdir from the wallet path.\n-        // This can be replaced by boost::filesystem::lexically_relative once boost is bumped to 1.60.\n-        const fs::path path = it->path().string().substr(offset);\n+        // We dont want to iterate trough those special node dirs\n+        if (it->status().type() == fs::directory_file) {\n+            skip_path = false;\n+            for(const auto& fpath: ignore_paths) {\n+                if (!skip_path && it->path().string().find(fpath.string()) == 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19419#discussion_r453350233",
      "id" : 453350233,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM1MDIzMw==",
      "original_commit_id" : "4aa7bc58d4d615069774997dd68f2b6925165fbf",
      "original_line" : 87,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/wallet/walletutil.cpp",
      "position" : null,
      "pull_request_review_id" : 446901377,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19419",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-13T13:33:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/453350233",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19419#discussion_r453350304"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19419"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/453350304"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Suggest alphabetising.",
      "commit_id" : "320e94ecc1b78c59fd6e68907b04baa22630a204",
      "created_at" : "2020-07-12T18:49:33Z",
      "diff_hunk" : "@@ -57,23 +57,48 @@ static bool IsBerkeleyBtree(const fs::path& path)\n std::vector<fs::path> ListWalletDir()\n {\n     const fs::path wallet_dir = GetWalletDir();\n+    const fs::path data_dir = GetDataDir();\n+    const fs::path blocks_dir = GetBlocksDir();\n+\n     const size_t offset = wallet_dir.string().size() + 1;\n     std::vector<fs::path> paths;\n     boost::system::error_code ec;\n \n+    bool skip_path;\n+    // Here we place the top level dirs we want to skip in case walletdir is datadir or blocksdir\n+    const std::vector<fs::path> ignore_paths = {\n+                                        blocks_dir,\n+                                        data_dir / \"testnet3\",\n+                                        data_dir / \"regtest\",\n+                                        data_dir / \"chainstate\",\n+                                        data_dir / \"database\",\n+                                        data_dir / \"indexes\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19419#discussion_r453350304",
      "id" : 453350304,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM1MDMwNA==",
      "original_commit_id" : "4aa7bc58d4d615069774997dd68f2b6925165fbf",
      "original_line" : 75,
      "original_position" : 19,
      "original_start_line" : 71,
      "path" : "src/wallet/walletutil.cpp",
      "position" : null,
      "pull_request_review_id" : 446901377,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19419",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-07-13T13:33:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/453350304",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19419#discussion_r453350602"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19419"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/453350602"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Consider adding \"blktree\" and \"coins\" (see `files.md`)",
      "commit_id" : "320e94ecc1b78c59fd6e68907b04baa22630a204",
      "created_at" : "2020-07-12T18:52:31Z",
      "diff_hunk" : "@@ -57,23 +57,48 @@ static bool IsBerkeleyBtree(const fs::path& path)\n std::vector<fs::path> ListWalletDir()\n {\n     const fs::path wallet_dir = GetWalletDir();\n+    const fs::path data_dir = GetDataDir();\n+    const fs::path blocks_dir = GetBlocksDir();\n+\n     const size_t offset = wallet_dir.string().size() + 1;\n     std::vector<fs::path> paths;\n     boost::system::error_code ec;\n \n+    bool skip_path;\n+    // Here we place the top level dirs we want to skip in case walletdir is datadir or blocksdir\n+    const std::vector<fs::path> ignore_paths = {\n+                                        blocks_dir,\n+                                        data_dir / \"testnet3\",\n+                                        data_dir / \"regtest\",\n+                                        data_dir / \"chainstate\",\n+                                        data_dir / \"database\",\n+                                        data_dir / \"indexes\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19419#discussion_r453350602",
      "id" : 453350602,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM1MDYwMg==",
      "original_commit_id" : "4aa7bc58d4d615069774997dd68f2b6925165fbf",
      "original_line" : 75,
      "original_position" : 19,
      "original_start_line" : 71,
      "path" : "src/wallet/walletutil.cpp",
      "position" : null,
      "pull_request_review_id" : 446901377,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19419",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-07-13T13:33:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/453350602",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19419#discussion_r453350994"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19419"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/453350994"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Or hopefully `std::filesystem::path::lexically_relative` (C++17) :)",
      "commit_id" : "320e94ecc1b78c59fd6e68907b04baa22630a204",
      "created_at" : "2020-07-12T18:56:20Z",
      "diff_hunk" : "@@ -57,23 +57,48 @@ static bool IsBerkeleyBtree(const fs::path& path)\n std::vector<fs::path> ListWalletDir()\n {\n     const fs::path wallet_dir = GetWalletDir();\n+    const fs::path data_dir = GetDataDir();\n+    const fs::path blocks_dir = GetBlocksDir();\n+\n     const size_t offset = wallet_dir.string().size() + 1;\n     std::vector<fs::path> paths;\n     boost::system::error_code ec;\n \n+    bool skip_path;\n+    // Here we place the top level dirs we want to skip in case walletdir is datadir or blocksdir\n+    const std::vector<fs::path> ignore_paths = {\n+                                        blocks_dir,\n+                                        data_dir / \"testnet3\",\n+                                        data_dir / \"regtest\",\n+                                        data_dir / \"chainstate\",\n+                                        data_dir / \"database\",\n+                                        data_dir / \"indexes\",\n+                                        };\n+\n     for (auto it = fs::recursive_directory_iterator(wallet_dir, ec); it != fs::recursive_directory_iterator(); it.increment(ec)) {\n         if (ec) {\n             LogPrintf(\"%s: %s %s\\n\", __func__, ec.message(), it->path().string());\n             continue;\n         }\n-\n-        // Get wallet path relative to walletdir by removing walletdir from the wallet path.\n-        // This can be replaced by boost::filesystem::lexically_relative once boost is bumped to 1.60.\n-        const fs::path path = it->path().string().substr(offset);\n+        // We dont want to iterate trough those special node dirs\n+        if (it->status().type() == fs::directory_file) {\n+            skip_path = false;\n+            for(const auto& fpath: ignore_paths) {\n+                if (!skip_path && it->path().string().find(fpath.string()) == 0) {\n+                    skip_path = true;\n+                }\n+            }\n+            if (skip_path) {\n+                it.disable_recursion_pending();\n+                continue;\n+            }\n+        } else it.disable_recursion_pending();\n \n         if (it->status().type() == fs::directory_file && IsBerkeleyBtree(it->path() / \"wallet.dat\")) {\n             // Found a directory which contains wallet.dat btree file, add it as a wallet.\n-            paths.emplace_back(path);\n+            // Get wallet path relative to walletdir by removing walletdir from the wallet path.\n+            // This can be replaced by boost::filesystem::lexically_relative once boost is bumped to 1.60.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19419#discussion_r453350994",
      "id" : 453350994,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM1MDk5NA==",
      "original_commit_id" : "4aa7bc58d4d615069774997dd68f2b6925165fbf",
      "original_line" : 100,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/wallet/walletutil.cpp",
      "position" : null,
      "pull_request_review_id" : 446901377,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19419",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-13T13:33:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/453350994",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19419#discussion_r453351273"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19419"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/453351273"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n            if (ignore_paths.count(it->path()) {\r\n                it.disable_recursion_pending();\r\n                continue;\r\n            }\r\n```",
      "commit_id" : "320e94ecc1b78c59fd6e68907b04baa22630a204",
      "created_at" : "2020-07-12T18:59:17Z",
      "diff_hunk" : "@@ -57,23 +57,48 @@ static bool IsBerkeleyBtree(const fs::path& path)\n std::vector<fs::path> ListWalletDir()\n {\n     const fs::path wallet_dir = GetWalletDir();\n+    const fs::path data_dir = GetDataDir();\n+    const fs::path blocks_dir = GetBlocksDir();\n+\n     const size_t offset = wallet_dir.string().size() + 1;\n     std::vector<fs::path> paths;\n     boost::system::error_code ec;\n \n+    bool skip_path;\n+    // Here we place the top level dirs we want to skip in case walletdir is datadir or blocksdir\n+    const std::vector<fs::path> ignore_paths = {\n+                                        blocks_dir,\n+                                        data_dir / \"testnet3\",\n+                                        data_dir / \"regtest\",\n+                                        data_dir / \"chainstate\",\n+                                        data_dir / \"database\",\n+                                        data_dir / \"indexes\",\n+                                        };\n+\n     for (auto it = fs::recursive_directory_iterator(wallet_dir, ec); it != fs::recursive_directory_iterator(); it.increment(ec)) {\n         if (ec) {\n             LogPrintf(\"%s: %s %s\\n\", __func__, ec.message(), it->path().string());\n             continue;\n         }\n-\n-        // Get wallet path relative to walletdir by removing walletdir from the wallet path.\n-        // This can be replaced by boost::filesystem::lexically_relative once boost is bumped to 1.60.\n-        const fs::path path = it->path().string().substr(offset);\n+        // We dont want to iterate trough those special node dirs\n+        if (it->status().type() == fs::directory_file) {\n+            skip_path = false;\n+            for(const auto& fpath: ignore_paths) {\n+                if (!skip_path && it->path().string().find(fpath.string()) == 0) {\n+                    skip_path = true;\n+                }\n+            }\n+            if (skip_path) {\n+                it.disable_recursion_pending();\n+                continue;\n+            }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19419#discussion_r453351273",
      "id" : 453351273,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzM1MTI3Mw==",
      "original_commit_id" : "4aa7bc58d4d615069774997dd68f2b6925165fbf",
      "original_line" : 94,
      "original_position" : 42,
      "original_start_line" : 85,
      "path" : "src/wallet/walletutil.cpp",
      "position" : null,
      "pull_request_review_id" : 446901377,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19419",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-07-13T13:33:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/453351273",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19419#discussion_r453531725"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19419"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/453531725"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> (and in fact, don't need it at all)\r\n\r\nhmm... If we allow wallets in those dir yes, but i would choose to touch the dir's not at all, \r\nPlease view fixup I will post before i squash.\r\nI guess we will need the skip  But sure about that we need some vote. :+1:    ",
      "commit_id" : "320e94ecc1b78c59fd6e68907b04baa22630a204",
      "created_at" : "2020-07-13T09:51:46Z",
      "diff_hunk" : "@@ -57,23 +57,48 @@ static bool IsBerkeleyBtree(const fs::path& path)\n std::vector<fs::path> ListWalletDir()\n {\n     const fs::path wallet_dir = GetWalletDir();\n+    const fs::path data_dir = GetDataDir();\n+    const fs::path blocks_dir = GetBlocksDir();\n+\n     const size_t offset = wallet_dir.string().size() + 1;\n     std::vector<fs::path> paths;\n     boost::system::error_code ec;\n \n+    bool skip_path;\n+    // Here we place the top level dirs we want to skip in case walletdir is datadir or blocksdir\n+    const std::vector<fs::path> ignore_paths = {\n+                                        blocks_dir,\n+                                        data_dir / \"testnet3\",\n+                                        data_dir / \"regtest\",\n+                                        data_dir / \"chainstate\",\n+                                        data_dir / \"database\",\n+                                        data_dir / \"indexes\",\n+                                        };\n+\n     for (auto it = fs::recursive_directory_iterator(wallet_dir, ec); it != fs::recursive_directory_iterator(); it.increment(ec)) {\n         if (ec) {\n             LogPrintf(\"%s: %s %s\\n\", __func__, ec.message(), it->path().string());\n             continue;\n         }\n-\n-        // Get wallet path relative to walletdir by removing walletdir from the wallet path.\n-        // This can be replaced by boost::filesystem::lexically_relative once boost is bumped to 1.60.\n-        const fs::path path = it->path().string().substr(offset);\n+        // We dont want to iterate trough those special node dirs\n+        if (it->status().type() == fs::directory_file) {\n+            skip_path = false;\n+            for(const auto& fpath: ignore_paths) {\n+                if (!skip_path && it->path().string().find(fpath.string()) == 0) {\n+                    skip_path = true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19419#discussion_r453531725",
      "id" : 453531725,
      "in_reply_to_id" : 452409592,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzUzMTcyNQ==",
      "original_commit_id" : "4aa7bc58d4d615069774997dd68f2b6925165fbf",
      "original_line" : 88,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/wallet/walletutil.cpp",
      "position" : null,
      "pull_request_review_id" : 447101681,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19419",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-13T13:33:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/453531725",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/34917548?v=4",
         "events_url" : "https://api.github.com/users/Saibato/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Saibato/followers",
         "following_url" : "https://api.github.com/users/Saibato/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Saibato/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Saibato",
         "id" : 34917548,
         "login" : "Saibato",
         "node_id" : "MDQ6VXNlcjM0OTE3NTQ4",
         "organizations_url" : "https://api.github.com/users/Saibato/orgs",
         "received_events_url" : "https://api.github.com/users/Saibato/received_events",
         "repos_url" : "https://api.github.com/users/Saibato/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Saibato/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Saibato/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Saibato"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19419#discussion_r453656346"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19419"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/453656346"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : ":+1: Though I choose  \r\n`if (std::count(ignore_paths.begin(), ignore_paths.end(), it->path())) {`\r\nnot sure ignore_paths has a count?",
      "commit_id" : "320e94ecc1b78c59fd6e68907b04baa22630a204",
      "created_at" : "2020-07-13T13:39:30Z",
      "diff_hunk" : "@@ -57,23 +57,48 @@ static bool IsBerkeleyBtree(const fs::path& path)\n std::vector<fs::path> ListWalletDir()\n {\n     const fs::path wallet_dir = GetWalletDir();\n+    const fs::path data_dir = GetDataDir();\n+    const fs::path blocks_dir = GetBlocksDir();\n+\n     const size_t offset = wallet_dir.string().size() + 1;\n     std::vector<fs::path> paths;\n     boost::system::error_code ec;\n \n+    bool skip_path;\n+    // Here we place the top level dirs we want to skip in case walletdir is datadir or blocksdir\n+    const std::vector<fs::path> ignore_paths = {\n+                                        blocks_dir,\n+                                        data_dir / \"testnet3\",\n+                                        data_dir / \"regtest\",\n+                                        data_dir / \"chainstate\",\n+                                        data_dir / \"database\",\n+                                        data_dir / \"indexes\",\n+                                        };\n+\n     for (auto it = fs::recursive_directory_iterator(wallet_dir, ec); it != fs::recursive_directory_iterator(); it.increment(ec)) {\n         if (ec) {\n             LogPrintf(\"%s: %s %s\\n\", __func__, ec.message(), it->path().string());\n             continue;\n         }\n-\n-        // Get wallet path relative to walletdir by removing walletdir from the wallet path.\n-        // This can be replaced by boost::filesystem::lexically_relative once boost is bumped to 1.60.\n-        const fs::path path = it->path().string().substr(offset);\n+        // We dont want to iterate trough those special node dirs\n+        if (it->status().type() == fs::directory_file) {\n+            skip_path = false;\n+            for(const auto& fpath: ignore_paths) {\n+                if (!skip_path && it->path().string().find(fpath.string()) == 0) {\n+                    skip_path = true;\n+                }\n+            }\n+            if (skip_path) {\n+                it.disable_recursion_pending();\n+                continue;\n+            }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19419#discussion_r453656346",
      "id" : 453656346,
      "in_reply_to_id" : 453351273,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY1NjM0Ng==",
      "original_commit_id" : "4aa7bc58d4d615069774997dd68f2b6925165fbf",
      "original_line" : 94,
      "original_position" : 42,
      "original_start_line" : 85,
      "path" : "src/wallet/walletutil.cpp",
      "position" : null,
      "pull_request_review_id" : 447259253,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19419",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-07-13T13:39:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/453656346",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/34917548?v=4",
         "events_url" : "https://api.github.com/users/Saibato/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Saibato/followers",
         "following_url" : "https://api.github.com/users/Saibato/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Saibato/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Saibato",
         "id" : 34917548,
         "login" : "Saibato",
         "node_id" : "MDQ6VXNlcjM0OTE3NTQ4",
         "organizations_url" : "https://api.github.com/users/Saibato/orgs",
         "received_events_url" : "https://api.github.com/users/Saibato/received_events",
         "repos_url" : "https://api.github.com/users/Saibato/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Saibato/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Saibato/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Saibato"
      }
   }
]
