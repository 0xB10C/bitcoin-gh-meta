[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #18191 (Change UpdateForDescendants to use Epochs by JeremyRubin)\n* #18086 (Accurately account for mempool index memory by sipa)\n* #18017 (txmempool: split epoch logic into class by ajtowns)\n* #17786 (refactor: Nuke policy/fees->mempool circular dependencies by hebasto)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-07-10T02:21:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19478#issuecomment-656443703",
      "id" : 656443703,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19478",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1NjQ0MzcwMw==",
      "updated_at" : "2020-07-11T10:42:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/656443703",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This is cool! How much memory would be saved by this change on average, do you think?",
      "created_at" : "2020-07-15T12:24:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19478#issuecomment-658736321",
      "id" : 658736321,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19478",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1ODczNjMyMQ==",
      "updated_at" : "2020-07-15T12:24:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/658736321",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "std::sets are awful for memory. I think you can get like a max of 220k txns in the mempool... let's assume that average is 50k? I don't know if that's a good assumption though. the overhead for a map entry is very high. I would guess that it's somewhere around 64 bytes per entry? Can double check, but based on:\r\n```\r\n struct stl_tree_node\r\n {\r\n private:\r\n     int color;\r\n     void* parent;\r\n     void* left;\r\n     void* right;\r\n     std::pair<txiter, txlinks>;\r\n };\r\n```\r\nThat's 4 bytes + 4 bytes alignment + 8 * 3 bytes pointers + 8 bytes txiter (ignoring txlinks itself since we still store those in the CTxMempoolEntry, but adding another 8 bytes for alignments and padding) = 6 * 8 = 48 byes of raw overhead. Then with mallocusage, this gives us 64 bytes. So it may not *use* 64 bytes per element, but we certainly count that many! Depending on how big txlinks is itself, we may have some extra overhead (implementation dependent).\r\n\r\nAnyways, let's assume 64 bytes.\r\n\r\n\r\n64*50,000 bytes = 3.2 MB, 64 * 200,000 bytes = 12.8 MB.\r\n\r\nFor a 300MB pool, 1-3% memory savings. Note that this doesn't account for the fact that there are other downsides to the memory fragmentation of doing so many allocations, but a pooled allocator could also help with this issue.\r\n\r\n\r\n \r\n\r\n(A further change which is maybe worth looking at is the Children themselves -- because there is so much memory overhead, storing a std::vector<hash> and std::vector<element> might be more efficient for many txs with small numbers of vins/vouts, especially since you can super optimize checking if a H is in a vector v.s. log N random memory compares)\r\n\r\n",
      "created_at" : "2020-07-15T19:03:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19478#issuecomment-658946971",
      "id" : 658946971,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19478",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1ODk0Njk3MQ==",
      "updated_at" : "2020-07-15T20:11:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/658946971",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "```c++\r\n  template <size_t s1, size_t s2> struct static_check {\r\n       static_check() {\r\n       static_assert(s1 == s2);\r\n       }\r\n   };\r\n       auto s = static_check<48, sizeof(setEntries)>();\r\n       auto s2 = static_check<48*2, sizeof(TxLinks)>();\r\n       auto s3 = static_check<136, sizeof(memusage::stl_tree_node<std::pair<const txiter, TxLinks>>)>();\r\n       auto s4 = static_check<160, ((31 + sizeof(memusage::stl_tree_node<std::pair<const txiter, TxLinks>>)) >> 4)<<4 >();\r\n```\r\nThis confirms that a setEntries uses 48 bytes for the container itself, and the overhead is 64 bytes per node for each TxLinks in the mapLinks data structure compared to inlined TxLinks in CTxMempoolEntry. Even though the nodes themselves are only 136 bytes, the MallocUsage accounting pads out to 160 bytes.",
      "created_at" : "2020-07-15T20:35:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19478#issuecomment-658995547",
      "id" : 658995547,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19478",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1ODk5NTU0Nw==",
      "updated_at" : "2020-07-15T20:35:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/658995547",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   }
]
