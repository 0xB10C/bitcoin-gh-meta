[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #21575 (refactor: Create blockstorage module by MarcoFalke)\n* #21467 (Move external signer out of wallet module by Sjors)\n* #21401 (Refactor versionbits deployments to avoid potential uninitialized variables by achow101)\n* #21391 ([Bundle 5/n] Prune g_chainman usage in RPC modules by dongcarl)\n* #21378 (Convert taproot to flag day activation by ajtowns)\n* #21377 (Speedy trial support for versionbits by ajtowns)\n* #21009 (Remove RewindBlockIndex logic by dhruv)\n* #19573 (Replace unused BIP 9 logic with draft BIP 8 by luke-jr)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-07-03T19:35:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#issuecomment-653660370",
      "id" : 653660370,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19438",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1MzY2MDM3MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-08T07:01:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/653660370",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r449695222"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449695222"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "prefer enum class to prevent leaking names.",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2020-07-03T20:10:16Z",
      "diff_hunk" : "@@ -11,6 +11,15 @@\n \n namespace Consensus {\n \n+enum BuriedDeployment",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r449695222",
      "id" : 449695222,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY5NTIyMg==",
      "original_commit_id" : "5834cc86540f9854736f6e0478e1348ca3b4290c",
      "original_line" : 14,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/consensus/params.h",
      "position" : null,
      "pull_request_review_id" : 442550162,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-17T05:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449695222",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r449695331"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449695331"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Also helps with avoiding overlap with SignalledDeployment.",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2020-07-03T20:10:55Z",
      "diff_hunk" : "@@ -11,6 +11,15 @@\n \n namespace Consensus {\n \n+enum BuriedDeployment",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r449695331",
      "id" : 449695331,
      "in_reply_to_id" : 449695222,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY5NTMzMQ==",
      "original_commit_id" : "5834cc86540f9854736f6e0478e1348ca3b4290c",
      "original_line" : 14,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/consensus/params.h",
      "position" : null,
      "pull_request_review_id" : 442550162,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-17T05:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449695331",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r449695480"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449695480"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "prefer explicitly numbering these.\r\n\r\n-255 is an extremely odd number, can you clarify why you picked it? It doesn't fit in a signed byte.",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2020-07-03T20:11:55Z",
      "diff_hunk" : "@@ -11,6 +11,15 @@\n \n namespace Consensus {\n \n+enum BuriedDeployment\n+{\n+    // buried deployments get negative values to avoid overlap with SignalledDeployment\n+    DEPLOYMENT_CLTV = -255,\n+    DEPLOYMENT_DERSIG,\n+    DEPLOYMENT_CSV,\n+    DEPLOYMENT_SEGWIT,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r449695480",
      "id" : 449695480,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY5NTQ4MA==",
      "original_commit_id" : "5834cc86540f9854736f6e0478e1348ca3b4290c",
      "original_line" : 21,
      "original_position" : 10,
      "original_start_line" : 17,
      "path" : "src/consensus/params.h",
      "position" : null,
      "pull_request_review_id" : 442550162,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-17T05:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449695480",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r449695754"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449695754"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Maybe tighter to make this a templated function as we're never calling DeploymentHeight with a variable, only literal.\r\n\r\nThen we get not just a warning, but a compiler error.",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2020-07-03T20:13:43Z",
      "diff_hunk" : "@@ -80,7 +89,19 @@ struct Params {\n     int64_t DifficultyAdjustmentInterval() const { return nPowTargetTimespan / nPowTargetSpacing; }\n     uint256 nMinimumChainWork;\n     uint256 defaultAssumeValid;\n+\n+    inline int DeploymentHeight(BuriedDeployment dep) const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r449695754",
      "id" : 449695754,
      "line" : 106,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY5NTc1NA==",
      "original_commit_id" : "5834cc86540f9854736f6e0478e1348ca3b4290c",
      "original_line" : 106,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/consensus/params.h",
      "position" : 33,
      "pull_request_review_id" : 442550162,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-17T05:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449695754",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r449695981"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449695981"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "dates",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2020-07-03T20:15:11Z",
      "diff_hunk" : "@@ -0,0 +1,53 @@\n+// Copyright (c) 2016-2019 The Bitcoin Core developers",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r449695981",
      "id" : 449695981,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY5NTk4MQ==",
      "original_commit_id" : "5834cc86540f9854736f6e0478e1348ca3b4290c",
      "original_line" : 1,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/deploymentstatus.h",
      "position" : null,
      "pull_request_review_id" : 442550162,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-17T05:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449695981",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r449696529"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449696529"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This dispatch scares me a bit unless we use enum class -- enums could coerce poorly right?",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2020-07-03T20:18:25Z",
      "diff_hunk" : "@@ -0,0 +1,53 @@\n+// Copyright (c) 2016-2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_DEPLOYMENTSTATUS_H\n+#define BITCOIN_DEPLOYMENTSTATUS_H\n+\n+#include <chain.h>\n+#include <sync.h>\n+#include <versionbits.h>\n+\n+#include <limits>\n+\n+extern RecursiveMutex cs_main;\n+\n+/** Global cache for versionbits deployment status */\n+extern VersionBitsCache versionbitscache GUARDED_BY(cs_main);\n+\n+/** Determine if a deployment is active for the next block */\n+inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::BuriedDeployment dep)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r449696529",
      "id" : 449696529,
      "line" : 17,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY5NjUyOQ==",
      "original_commit_id" : "5834cc86540f9854736f6e0478e1348ca3b4290c",
      "original_line" : 17,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/deploymentstatus.h",
      "position" : 17,
      "pull_request_review_id" : 442550162,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-17T05:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449696529",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r449704885"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449704885"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Leaking the names is the point -- otherwise you'd need to change every use from `Consensus::DeploymentPos::SEGWIT` to `Consensus::BuriedDeployment::SEGWIT`. With C++20, you will be able to specify `enum class DeploymentPos { .. }; using enum DeploymentPos;` but that's a while away.",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2020-07-03T21:14:10Z",
      "diff_hunk" : "@@ -11,6 +11,15 @@\n \n namespace Consensus {\n \n+enum BuriedDeployment",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r449704885",
      "id" : 449704885,
      "in_reply_to_id" : 449695222,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTcwNDg4NQ==",
      "original_commit_id" : "5834cc86540f9854736f6e0478e1348ca3b4290c",
      "original_line" : 14,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/consensus/params.h",
      "position" : null,
      "pull_request_review_id" : 442560869,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-17T05:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449704885",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r449707076"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449707076"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I had tried that, but thought that it might be useful to be able to do `for (dep = 0; dep < MAX_VERSIONBITS_DEPLOYMENTS; ++dep) { ... DeploymentActiveAt(pindex, consParams, dep) .. }`. I think in all the cases where that currently comes up you want to know more fine grained details though. (Changing `BuriedForkDescPushBack` to take a BuriedDeployment instead of a height would make use of that, eg)\r\n\r\nI don't think the type checking is any better with the template though, as unfortunately you can invoke `DeploymentHeight<(BuriedDeployment)9000>()` just as easily as `DeploymentHeight((BuriedDeployment)9000)` with both g++ and clang++.",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2020-07-03T21:29:49Z",
      "diff_hunk" : "@@ -80,7 +89,19 @@ struct Params {\n     int64_t DifficultyAdjustmentInterval() const { return nPowTargetTimespan / nPowTargetSpacing; }\n     uint256 nMinimumChainWork;\n     uint256 defaultAssumeValid;\n+\n+    inline int DeploymentHeight(BuriedDeployment dep) const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r449707076",
      "id" : 449707076,
      "in_reply_to_id" : 449695754,
      "line" : 106,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTcwNzA3Ng==",
      "original_commit_id" : "5834cc86540f9854736f6e0478e1348ca3b4290c",
      "original_line" : 106,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/consensus/params.h",
      "position" : 33,
      "pull_request_review_id" : 442563065,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-17T05:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449707076",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r449708147"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449708147"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Nope; int (and the like) won't automatically coerce to enum, so with `int x = Consensus::DEPLOYMENT_SEGWIT; return DeploymentActiveAt(pindex, params, x)` you get errors:\r\n\r\n```\r\nvalidation.cpp:1921:12: error: no matching function for call to 'DeploymentActiveAt'\r\n    return DeploymentActiveAt(pindex, consensusparams, x);\r\n           ^~~~~~~~~~~~~~~~~~\r\n./deploymentstatus.h:32:13: note: candidate function not viable: no known conversion from 'int' to 'Consensus::BuriedDeployment' for 3rd argument\r\ninline bool DeploymentActiveAt(const CBlockIndex* pindex, const Consensus::Params& params, Consensus::BuriedDeployment dep)\r\n            ^\r\n./deploymentstatus.h:37:13: note: candidate function not viable: no known conversion from 'int' to 'Consensus::DeploymentPos' for 3rd argument\r\ninline bool DeploymentActiveAt(const CBlockIndex* pindex, const Consensus::Params& params, Consensus::DeploymentPos dep) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\r\n            ^\r\n```\r\n\r\n(even if it did, which enum it coerced to is ambiguous between the two types, resulting in a failure like `error: call to 'DeploymentActiveAt' is ambiguous`)",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2020-07-03T21:38:43Z",
      "diff_hunk" : "@@ -0,0 +1,53 @@\n+// Copyright (c) 2016-2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_DEPLOYMENTSTATUS_H\n+#define BITCOIN_DEPLOYMENTSTATUS_H\n+\n+#include <chain.h>\n+#include <sync.h>\n+#include <versionbits.h>\n+\n+#include <limits>\n+\n+extern RecursiveMutex cs_main;\n+\n+/** Global cache for versionbits deployment status */\n+extern VersionBitsCache versionbitscache GUARDED_BY(cs_main);\n+\n+/** Determine if a deployment is active for the next block */\n+inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::BuriedDeployment dep)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r449708147",
      "id" : 449708147,
      "in_reply_to_id" : 449696529,
      "line" : 17,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTcwODE0Nw==",
      "original_commit_id" : "5834cc86540f9854736f6e0478e1348ca3b4290c",
      "original_line" : 17,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/deploymentstatus.h",
      "position" : 17,
      "pull_request_review_id" : 442564187,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-17T05:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449708147",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r449712349"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449712349"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Explicitly numbering them risks accidentally repeating a number. No particular objection to a different starting point. Could perhaps make it `enum DeploymentPos : uint8_t` and `enum BuriedDeployment : int16_t { DEPLOYMENT_CLTV = 256, // larger than largest possible DeploymentPos value`.\r\n\r\n(I guess `2**n` is an \"extremely even\" number, so calling  `+/- 2**n-1` \"extremely odd\" makes a lot of sense...)",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2020-07-03T22:16:14Z",
      "diff_hunk" : "@@ -11,6 +11,15 @@\n \n namespace Consensus {\n \n+enum BuriedDeployment\n+{\n+    // buried deployments get negative values to avoid overlap with SignalledDeployment\n+    DEPLOYMENT_CLTV = -255,\n+    DEPLOYMENT_DERSIG,\n+    DEPLOYMENT_CSV,\n+    DEPLOYMENT_SEGWIT,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r449712349",
      "id" : 449712349,
      "in_reply_to_id" : 449695480,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTcxMjM0OQ==",
      "original_commit_id" : "5834cc86540f9854736f6e0478e1348ca3b4290c",
      "original_line" : 21,
      "original_position" : 10,
      "original_start_line" : 17,
      "path" : "src/consensus/params.h",
      "position" : null,
      "pull_request_review_id" : 442568351,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-17T05:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449712349",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-09-07T17:40:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#issuecomment-688451949",
      "id" : 688451949,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19438",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4ODQ1MTk0OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-07T17:40:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/688451949",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-09-08T20:46:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#issuecomment-689126846",
      "id" : 689126846,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19438",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4OTEyNjg0Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-08T20:46:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/689126846",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-09-21T22:20:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#issuecomment-696409373",
      "id" : 696409373,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19438",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5NjQwOTM3Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-21T22:20:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/696409373",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-10-15T11:09:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#issuecomment-709204291",
      "id" : 709204291,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19438",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwOTIwNDI5MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-15T11:09:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/709204291",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r549065742"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/549065742"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Any chance of just introducing a new lock for the versionbitscache, to avoid this semantically-cyclic dependency between validation and deploymentstatus?",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2020-12-27T05:00:49Z",
      "diff_hunk" : "@@ -0,0 +1,52 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_DEPLOYMENTSTATUS_H\n+#define BITCOIN_DEPLOYMENTSTATUS_H\n+\n+#include <chain.h>\n+#include <sync.h>\n+#include <versionbits.h>\n+\n+#include <limits>\n+\n+extern RecursiveMutex cs_main;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r549065742",
      "id" : 549065742,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTA2NTc0Mg==",
      "original_commit_id" : "60de491a030011f3caeb42f0b650a1028905c54d",
      "original_line" : 14,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/deploymentstatus.h",
      "position" : null,
      "pull_request_review_id" : 558903894,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-17T05:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/549065742",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r549898915"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/549898915"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah, can make `VersionBitsCache` be natively threadsafe, rather than having the caller manage a mutex (which should help if it ever ends up having some sort of shared lock too). I've done that, though I've added the lock as the first commit, since I think that makes the impact of the change clearer.",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2020-12-30T00:45:03Z",
      "diff_hunk" : "@@ -0,0 +1,52 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_DEPLOYMENTSTATUS_H\n+#define BITCOIN_DEPLOYMENTSTATUS_H\n+\n+#include <chain.h>\n+#include <sync.h>\n+#include <versionbits.h>\n+\n+#include <limits>\n+\n+extern RecursiveMutex cs_main;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r549898915",
      "id" : 549898915,
      "in_reply_to_id" : 549065742,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTg5ODkxNQ==",
      "original_commit_id" : "60de491a030011f3caeb42f0b650a1028905c54d",
      "original_line" : 14,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/deploymentstatus.h",
      "position" : null,
      "pull_request_review_id" : 559748619,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-17T05:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/549898915",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r549976688"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/549976688"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit \"[refactor] Add deploymentstatus.h\":\r\n\r\nYUUUUGE nit: missing parenthesis in comment",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2020-12-30T07:16:59Z",
      "diff_hunk" : "@@ -0,0 +1,30 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_DEPLOYMENTSTATUS_H\n+#define BITCOIN_DEPLOYMENTSTATUS_H\n+\n+#include <chain.h>\n+\n+#include <limits>\n+\n+/** Determine if a deployment is active for the next block */\n+inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::BuriedDeployment dep)\n+{\n+    return (pindexPrev == nullptr ? 0 : pindexPrev->nHeight + 1) >= params.DeploymentHeight(dep);\n+}\n+\n+/** Determine if a deployment is active for this block */\n+inline bool DeploymentActiveAt(const CBlockIndex* pindex, const Consensus::Params& params, Consensus::BuriedDeployment dep)\n+{\n+    return pindex->nHeight >= params.DeploymentHeight(dep);\n+}\n+\n+/** Determine if a deployment is enabled (can ever be active */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r549976688",
      "id" : 549976688,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTk3NjY4OA==",
      "original_commit_id" : "318370aa0e5b08c157c95ffda3d18906468c4ff7",
      "original_line" : 24,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/deploymentstatus.h",
      "position" : null,
      "pull_request_review_id" : 559933443,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-17T05:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/549976688",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r549979188"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/549979188"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit \"[refactor] Add deploymentstatus.h\":\r\n\r\nIs this \"EXCLUSIVE_LOCKS_REQUIRED(cs_main)\" still needed?",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2020-12-30T07:20:36Z",
      "diff_hunk" : "@@ -3461,13 +3448,13 @@ static bool ContextualCheckBlockHeader(const CBlockHeader& block, BlockValidatio\n  *  in ConnectBlock().\n  *  Note that -reindex-chainstate skips the validation that happens here!\n  */\n-static bool ContextualCheckBlock(const CBlock& block, BlockValidationState& state, const Consensus::Params& consensusParams, const CBlockIndex* pindexPrev)\n+static bool ContextualCheckBlock(const CBlock& block, BlockValidationState& state, const Consensus::Params& consensusParams, const CBlockIndex* pindexPrev) EXCLUSIVE_LOCKS_REQUIRED(cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r549979188",
      "id" : 549979188,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTk3OTE4OA==",
      "original_commit_id" : "318370aa0e5b08c157c95ffda3d18906468c4ff7",
      "original_line" : 3451,
      "original_position" : 127,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 559933443,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-17T05:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/549979188",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r549983058"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/549983058"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit \"[refactor] Add versionbits deployments to deploymentstatus.h\":\r\n\r\nPerhaps assert that dep >= 0 in these functions (and dep < 0 for the buried ones)?",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2020-12-30T07:25:47Z",
      "diff_hunk" : "@@ -6,25 +6,44 @@\n #define BITCOIN_DEPLOYMENTSTATUS_H\n \n #include <chain.h>\n+#include <versionbits.h>\n \n #include <limits>\n \n+/** Global cache for versionbits deployment status */\n+extern VersionBitsCache versionbitscache;\n+\n /** Determine if a deployment is active for the next block */\n inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::BuriedDeployment dep)\n {\n     return (pindexPrev == nullptr ? 0 : pindexPrev->nHeight + 1) >= params.DeploymentHeight(dep);\n }\n \n+inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos dep)\n+{\n+    return ThresholdState::ACTIVE == VersionBitsState(pindexPrev, params, dep, versionbitscache);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r549983058",
      "id" : 549983058,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTk4MzA1OA==",
      "original_commit_id" : "a323cdf30e05d2a3d853a342aeddb271dbe490cf",
      "original_line" : 24,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/deploymentstatus.h",
      "position" : null,
      "pull_request_review_id" : 559933443,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-17T05:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/549983058",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@JeremyRubin Have your comments been addressed?",
      "created_at" : "2020-12-30T20:55:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#issuecomment-752755310",
      "id" : 752755310,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19438",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1Mjc1NTMxMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-30T20:55:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/752755310",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-12-31T17:59:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#issuecomment-753016995",
      "id" : 753016995,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19438",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1MzAxNjk5NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-31T17:59:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/753016995",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r550856669"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/550856669"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I've added a `ValidDeployment()` function for checking this with a bit more precision.\r\n\r\nMight be worth revisiting @JeremyRubin's suggestion of using templated functions so it can be a static assertion that's resolved at compile-time? Having looked at it again, I think the only thing that would really end up making awkward is the rpc/blockchain.cpp stuff (ie, it would mean templating the `SoftForkPushBack` function and having the compiler duplicate the code and possibly not de-duplicate it when optimising) but that's not necessarily a big deal.\r\n\r\nI've added a draft commit that switches to templated functions and static_asserts to see what that's like. It does make rpc/blockchain a bit bigger (after compiling with clang) so might need be worth some tweaking to avoid that, and the syntax is a bit clunky, but it seems plausible. Thoughts?",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-01-02T07:58:35Z",
      "diff_hunk" : "@@ -6,25 +6,44 @@\n #define BITCOIN_DEPLOYMENTSTATUS_H\n \n #include <chain.h>\n+#include <versionbits.h>\n \n #include <limits>\n \n+/** Global cache for versionbits deployment status */\n+extern VersionBitsCache versionbitscache;\n+\n /** Determine if a deployment is active for the next block */\n inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::BuriedDeployment dep)\n {\n     return (pindexPrev == nullptr ? 0 : pindexPrev->nHeight + 1) >= params.DeploymentHeight(dep);\n }\n \n+inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos dep)\n+{\n+    return ThresholdState::ACTIVE == VersionBitsState(pindexPrev, params, dep, versionbitscache);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r550856669",
      "id" : 550856669,
      "in_reply_to_id" : 549983058,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDg1NjY2OQ==",
      "original_commit_id" : "a323cdf30e05d2a3d853a342aeddb271dbe490cf",
      "original_line" : 24,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/deploymentstatus.h",
      "position" : null,
      "pull_request_review_id" : 560625538,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-17T05:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/550856669",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r550856694"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/550856694"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "No, don't think so. Removed.",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-01-02T07:58:50Z",
      "diff_hunk" : "@@ -3461,13 +3448,13 @@ static bool ContextualCheckBlockHeader(const CBlockHeader& block, BlockValidatio\n  *  in ConnectBlock().\n  *  Note that -reindex-chainstate skips the validation that happens here!\n  */\n-static bool ContextualCheckBlock(const CBlock& block, BlockValidationState& state, const Consensus::Params& consensusParams, const CBlockIndex* pindexPrev)\n+static bool ContextualCheckBlock(const CBlock& block, BlockValidationState& state, const Consensus::Params& consensusParams, const CBlockIndex* pindexPrev) EXCLUSIVE_LOCKS_REQUIRED(cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r550856694",
      "id" : 550856694,
      "in_reply_to_id" : 549979188,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDg1NjY5NA==",
      "original_commit_id" : "318370aa0e5b08c157c95ffda3d18906468c4ff7",
      "original_line" : 3451,
      "original_position" : 127,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 560625545,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-17T05:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/550856694",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased to after the copyright bump, addressed comments, added a draft commit that switches from runtime to static checks.",
      "created_at" : "2021-01-02T08:07:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#issuecomment-753445789",
      "id" : 753445789,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19438",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1MzQ0NTc4OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-02T08:07:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/753445789",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Dropped draft commit that made the ValidDeployment checks static_asserts.",
      "created_at" : "2021-01-11T03:41:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#issuecomment-757608615",
      "id" : 757608615,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19438",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1NzYwODYxNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-11T03:41:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/757608615",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r554675546"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554675546"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Okay, dropped the templated approach as too unwieldy for not enough benefit, so think this is resolved via `ValidDeployment()`.",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-01-11T03:42:03Z",
      "diff_hunk" : "@@ -6,25 +6,44 @@\n #define BITCOIN_DEPLOYMENTSTATUS_H\n \n #include <chain.h>\n+#include <versionbits.h>\n \n #include <limits>\n \n+/** Global cache for versionbits deployment status */\n+extern VersionBitsCache versionbitscache;\n+\n /** Determine if a deployment is active for the next block */\n inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::BuriedDeployment dep)\n {\n     return (pindexPrev == nullptr ? 0 : pindexPrev->nHeight + 1) >= params.DeploymentHeight(dep);\n }\n \n+inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos dep)\n+{\n+    return ThresholdState::ACTIVE == VersionBitsState(pindexPrev, params, dep, versionbitscache);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r554675546",
      "id" : 554675546,
      "in_reply_to_id" : 549983058,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDY3NTU0Ng==",
      "original_commit_id" : "a323cdf30e05d2a3d853a342aeddb271dbe490cf",
      "original_line" : 24,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/deploymentstatus.h",
      "position" : null,
      "pull_request_review_id" : 565047777,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-17T05:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/554675546",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-02-01T13:10:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#issuecomment-770845886",
      "id" : 770845886,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19438",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3MDg0NTg4Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-01T13:10:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/770845886",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased on top of #20749 due to conflict from both PRs changing nearby sections of validation.h",
      "created_at" : "2021-02-02T09:11:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#issuecomment-771486762",
      "id" : 771486762,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19438",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3MTQ4Njc2Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-02T09:11:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/771486762",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-02-18T07:57:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#issuecomment-781132485",
      "id" : 781132485,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19438",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4MTEzMjQ4NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-18T07:57:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/781132485",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r589867085"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/589867085"
         }
      },
      "author_association" : "MEMBER",
      "body" : "typo: `BuridedDeployment`",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-03-09T01:15:56Z",
      "diff_hunk" : "@@ -0,0 +1,17 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <deploymentstatus.h>\n+#include <versionbits.h>\n+\n+#include <consensus/params.h>\n+\n+VersionBitsCache versionbitscache;\n+\n+/* Basic sanity checking for BuriedDeployment/DeploymentPos enums and\n+ * ValidDeployment check */\n+\n+static_assert(ValidDeployment(Consensus::DEPLOYMENT_TESTDUMMY), \"sanity check of DeploymentPos failed (TESTDUMMY not valid)\");\n+static_assert(!ValidDeployment(Consensus::MAX_VERSION_BITS_DEPLOYMENTS), \"sanity check of DeploymentPos failed (MAX value considered valid)\");\n+static_assert(!ValidDeployment(static_cast<Consensus::BuriedDeployment>(Consensus::DEPLOYMENT_TESTDUMMY)), \"sanity check of BuridedDeployment failed (overlaps with DeploymentPos)\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r589867085",
      "id" : 589867085,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4OTg2NzA4NQ==",
      "original_commit_id" : "073ae5b33c51fe66800c364830f0b645046150d7",
      "original_line" : 17,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/deploymentstatus.cpp",
      "position" : null,
      "pull_request_review_id" : 606850272,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-17T05:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/589867085",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK. I really like that deployments can be changed from versionbits to buried without any changes to the code in validation and other places.",
      "created_at" : "2021-03-09T18:22:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#issuecomment-794266520",
      "id" : 794266520,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19438",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5NDI2NjUyMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-09T18:22:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/794266520",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r591903943"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/591903943"
         }
      },
      "author_association" : "MEMBER",
      "body" : "SignalledDeployment == DeploymentPos? \r\n\r\nalthough, I'd probably be down for a rename. I've been wondering what Pos stands for? position? ",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-03-10T22:01:18Z",
      "diff_hunk" : "@@ -11,13 +11,25 @@\n \n namespace Consensus {\n \n-enum DeploymentPos\n+enum BuriedDeployment : int16_t\n+{\n+    // buried deployments get negative values to avoid overlap with SignalledDeployment",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r591903943",
      "id" : 591903943,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MTkwMzk0Mw==",
      "original_commit_id" : "3a32ec4a0562a009c65182071e822bf556be01a8",
      "original_line" : 16,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/consensus/params.h",
      "position" : null,
      "pull_request_review_id" : 609207081,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-17T05:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/591903943",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r591909479"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/591909479"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this comment was previously incorrect (`VersionBitsDeploymentInfo` was in `versionbitsinfo.cpp`), but should definitely be updated since as of this PR it is defined in `deploymentinfo.cpp` ",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-03-10T22:11:18Z",
      "diff_hunk" : "@@ -11,13 +11,25 @@\n \n namespace Consensus {\n \n-enum DeploymentPos\n+enum BuriedDeployment : int16_t\n+{\n+    // buried deployments get negative values to avoid overlap with SignalledDeployment\n+    DEPLOYMENT_HEIGHTINCB = std::numeric_limits<int16_t>::min(),\n+    DEPLOYMENT_CLTV,\n+    DEPLOYMENT_DERSIG,\n+    DEPLOYMENT_CSV,\n+    DEPLOYMENT_SEGWIT,\n+};\n+constexpr bool ValidDeployment(BuriedDeployment dep) { return DEPLOYMENT_HEIGHTINCB <= dep && dep <= DEPLOYMENT_SEGWIT; }\n+\n+enum DeploymentPos : uint16_t\n {\n     DEPLOYMENT_TESTDUMMY,\n     DEPLOYMENT_TAPROOT, // Deployment of Schnorr/Taproot (BIPs 340-342)\n     // NOTE: Also add new deployments to VersionBitsDeploymentInfo in versionbits.cpp",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r591909479",
      "id" : 591909479,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MTkwOTQ3OQ==",
      "original_commit_id" : "3a32ec4a0562a009c65182071e822bf556be01a8",
      "original_line" : 29,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/consensus/params.h",
      "position" : null,
      "pull_request_review_id" : 609207081,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-17T05:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/591909479",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r591968358"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/591968358"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "\"position in the vDeployments\" array, I presume. Yeah, I think I changed it to \"SignalledDeployment\" at some point then dropped it as being too annoying to keep rebasing",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-03-11T00:02:08Z",
      "diff_hunk" : "@@ -11,13 +11,25 @@\n \n namespace Consensus {\n \n-enum DeploymentPos\n+enum BuriedDeployment : int16_t\n+{\n+    // buried deployments get negative values to avoid overlap with SignalledDeployment",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r591968358",
      "id" : 591968358,
      "in_reply_to_id" : 591903943,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MTk2ODM1OA==",
      "original_commit_id" : "3a32ec4a0562a009c65182071e822bf556be01a8",
      "original_line" : 16,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/consensus/params.h",
      "position" : null,
      "pull_request_review_id" : 609283968,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-17T05:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/591968358",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Probably a good idea to review #21380 (Fuzzing harness for versionbits) before this one -- ~it has some refactors that will cause this to get rebased, and both the \"speedy trial\" implementations are based on it.~",
      "created_at" : "2021-03-11T04:09:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#issuecomment-796432157",
      "id" : 796432157,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19438",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5NjQzMjE1Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-17T05:24:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/796432157",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Split deploymentinfo rename, DeploymentName and SoftForkPushBack into separate commits. (EDIT: and fix the comments amiti noted)",
      "created_at" : "2021-03-11T06:21:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#issuecomment-796491653",
      "id" : 796491653,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19438",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5NjQ5MTY1Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-11T06:25:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/796491653",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r594201846"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594201846"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It seems a bit strange for this interface to be called 'cache'. I'd say this _has_ a cache, not _is_ a cache.",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-03-15T10:08:02Z",
      "diff_hunk" : "@@ -70,21 +72,32 @@ class AbstractThresholdConditionChecker {\n     int GetStateSinceHeightFor(const CBlockIndex* pindexPrev, const Consensus::Params& params, ThresholdConditionCache& cache) const;\n };\n \n-/** BIP 9 allows multiple softforks to be deployed in parallel. We cache per-period state for every one of them\n- *  keyed by the bit position used to signal support. */\n-struct VersionBitsCache\n+/** BIP 9 allows multiple softforks to be deployed in parallel. We cache\n+ *  per-period state for every one of them. */\n+\n+class VersionBitsCache",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r594201846",
      "id" : 594201846,
      "line" : 78,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDIwMTg0Ng==",
      "original_commit_id" : "eb211ea0af0ba683ff1f77b576f33b651eab8cff",
      "original_line" : 78,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/versionbits.h",
      "position" : 19,
      "pull_request_review_id" : 612017175,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-17T05:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594201846",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r594204760"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594204760"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Couple of suggested changes:\r\n\r\n- use `m_` naming convention (and cs -> mutex)\r\n- mark these mutable so the functions can all be `const`\r\n\r\n```suggestion\r\n    mutable Mutex m_mutex;\r\n    mutable ThresholdConditionCache m_caches[Consensus::MAX_VERSION_BITS_DEPLOYMENTS] GUARDED_BY(cs);\r\n```",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-03-15T10:12:25Z",
      "diff_hunk" : "@@ -70,21 +72,32 @@ class AbstractThresholdConditionChecker {\n     int GetStateSinceHeightFor(const CBlockIndex* pindexPrev, const Consensus::Params& params, ThresholdConditionCache& cache) const;\n };\n \n-/** BIP 9 allows multiple softforks to be deployed in parallel. We cache per-period state for every one of them\n- *  keyed by the bit position used to signal support. */\n-struct VersionBitsCache\n+/** BIP 9 allows multiple softforks to be deployed in parallel. We cache\n+ *  per-period state for every one of them. */\n+\n+class VersionBitsCache\n {\n-    ThresholdConditionCache caches[Consensus::MAX_VERSION_BITS_DEPLOYMENTS];\n+private:\n+    Mutex cs;\n+    ThresholdConditionCache caches[Consensus::MAX_VERSION_BITS_DEPLOYMENTS] GUARDED_BY(cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r594204760",
      "id" : 594204760,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDIwNDc2MA==",
      "original_commit_id" : "eb211ea0af0ba683ff1f77b576f33b651eab8cff",
      "original_line" : 82,
      "original_position" : 24,
      "original_start_line" : 81,
      "path" : "src/versionbits.h",
      "position" : null,
      "pull_request_review_id" : 612017175,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-17T05:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594204760",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r594206873"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594206873"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What's the benefit of specifically these two functions being `static`? There will only ever be one instance of `VersionBitsCache` so theoretically everything here could be static. I'd suggest just dropping the `static` here.",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-03-15T10:15:37Z",
      "diff_hunk" : "@@ -70,21 +72,32 @@ class AbstractThresholdConditionChecker {\n     int GetStateSinceHeightFor(const CBlockIndex* pindexPrev, const Consensus::Params& params, ThresholdConditionCache& cache) const;\n };\n \n-/** BIP 9 allows multiple softforks to be deployed in parallel. We cache per-period state for every one of them\n- *  keyed by the bit position used to signal support. */\n-struct VersionBitsCache\n+/** BIP 9 allows multiple softforks to be deployed in parallel. We cache\n+ *  per-period state for every one of them. */\n+\n+class VersionBitsCache\n {\n-    ThresholdConditionCache caches[Consensus::MAX_VERSION_BITS_DEPLOYMENTS];\n+private:\n+    Mutex cs;\n+    ThresholdConditionCache caches[Consensus::MAX_VERSION_BITS_DEPLOYMENTS] GUARDED_BY(cs);\n+\n+public:\n+    /** Get the numerical statistics for the BIP9 state for a given deployment as at pindexPrev. */\n+    static BIP9Stats Statistics(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos pos);\n+\n+    static uint32_t Mask(const Consensus::Params& params, Consensus::DeploymentPos pos);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r594206873",
      "id" : 594206873,
      "line" : 88,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDIwNjg3Mw==",
      "original_commit_id" : "eb211ea0af0ba683ff1f77b576f33b651eab8cff",
      "original_line" : 88,
      "original_position" : 30,
      "original_start_line" : 86,
      "path" : "src/versionbits.h",
      "position" : 30,
      "pull_request_review_id" : 612017175,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : 86,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-17T05:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594206873",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r594226697"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594226697"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You can use the underlying type of the enum rather than casting it to an int:\r\n\r\n```suggestion\r\n    for (std::underlying_type<Consensus::DeploymentPos>::type i = 0; i < Consensus::MAX_VERSION_BITS_DEPLOYMENTS; i++) {\r\n```",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-03-15T10:44:10Z",
      "diff_hunk" : "@@ -185,28 +185,47 @@ class VersionBitsConditionChecker : public AbstractThresholdConditionChecker {\n \n } // namespace\n \n-ThresholdState VersionBitsState(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos pos, VersionBitsCache& cache)\n+ThresholdState VersionBitsCache::State(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos pos)\n {\n-    return VersionBitsConditionChecker(pos).GetStateFor(pindexPrev, params, cache.caches[pos]);\n+    LOCK(cs);\n+    return VersionBitsConditionChecker(pos).GetStateFor(pindexPrev, params, caches[pos]);\n }\n \n-BIP9Stats VersionBitsStatistics(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos pos)\n+BIP9Stats VersionBitsCache::Statistics(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos pos)\n {\n     return VersionBitsConditionChecker(pos).GetStateStatisticsFor(pindexPrev, params);\n }\n \n-int VersionBitsStateSinceHeight(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos pos, VersionBitsCache& cache)\n+int VersionBitsCache::StateSinceHeight(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos pos)\n {\n-    return VersionBitsConditionChecker(pos).GetStateSinceHeightFor(pindexPrev, params, cache.caches[pos]);\n+    LOCK(cs);\n+    return VersionBitsConditionChecker(pos).GetStateSinceHeightFor(pindexPrev, params, caches[pos]);\n }\n \n-uint32_t VersionBitsMask(const Consensus::Params& params, Consensus::DeploymentPos pos)\n+uint32_t VersionBitsCache::Mask(const Consensus::Params& params, Consensus::DeploymentPos pos)\n {\n     return VersionBitsConditionChecker(pos).Mask(params);\n }\n \n+int32_t VersionBitsCache::ComputeBlockVersion(const CBlockIndex* pindexPrev, const Consensus::Params& params)\n+{\n+    LOCK(cs);\n+    int32_t nVersion = VERSIONBITS_TOP_BITS;\n+\n+    for (int i = 0; i < (int)Consensus::MAX_VERSION_BITS_DEPLOYMENTS; i++) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r594226697",
      "id" : 594226697,
      "line" : 215,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDIyNjY5Nw==",
      "original_commit_id" : "eb211ea0af0ba683ff1f77b576f33b651eab8cff",
      "original_line" : 215,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/versionbits.cpp",
      "position" : 37,
      "pull_request_review_id" : 612017175,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-17T05:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594226697",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r594230875"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594230875"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Comment can be removed. We're no longer interested in the activation method now that these deployments are buried.",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-03-15T10:49:55Z",
      "diff_hunk" : "@@ -3491,11 +3458,12 @@ static bool ContextualCheckBlockHeader(const CBlockHeader& block, BlockValidatio\n \n     // Reject outdated version blocks when 95% (75% on testnet) of the network has upgraded:\n     // check for version 2, 3 and 4 upgrades",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r594230875",
      "id" : 594230875,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDIzMDg3NQ==",
      "original_commit_id" : "eb211ea0af0ba683ff1f77b576f33b651eab8cff",
      "original_line" : 3460,
      "original_position" : 160,
      "original_start_line" : 3459,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 612017175,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-17T05:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594230875",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r594231581"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594231581"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    // Start enforcing Taproot.\r\n```\r\n\r\nActually, all of these comments can have s/Start enforcing/Enforce/.",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-03-15T10:50:49Z",
      "diff_hunk" : "@@ -1881,32 +1854,32 @@ static unsigned int GetBlockScriptFlags(const CBlockIndex* pindex, const Consens\n \n     // Enforce WITNESS rules whenever P2SH is in effect (and the segwit\n     // deployment is defined).\n-    if (flags & SCRIPT_VERIFY_P2SH && IsScriptWitnessEnabled(consensusparams)) {\n+    if (flags & SCRIPT_VERIFY_P2SH && DeploymentEnabled(consensusparams, Consensus::DEPLOYMENT_SEGWIT)) {\n         flags |= SCRIPT_VERIFY_WITNESS;\n     }\n \n     // Start enforcing the DERSIG (BIP66) rule\n-    if (pindex->nHeight >= consensusparams.BIP66Height) {\n+    if (DeploymentActiveAt(pindex, consensusparams, Consensus::DEPLOYMENT_DERSIG)) {\n         flags |= SCRIPT_VERIFY_DERSIG;\n     }\n \n     // Start enforcing CHECKLOCKTIMEVERIFY (BIP65) rule\n-    if (pindex->nHeight >= consensusparams.BIP65Height) {\n+    if (DeploymentActiveAt(pindex, consensusparams, Consensus::DEPLOYMENT_CLTV)) {\n         flags |= SCRIPT_VERIFY_CHECKLOCKTIMEVERIFY;\n     }\n \n     // Start enforcing BIP112 (CHECKSEQUENCEVERIFY)\n-    if (pindex->nHeight >= consensusparams.CSVHeight) {\n+    if (DeploymentActiveAt(pindex, consensusparams, Consensus::DEPLOYMENT_CSV)) {\n         flags |= SCRIPT_VERIFY_CHECKSEQUENCEVERIFY;\n     }\n \n     // Start enforcing Taproot using versionbits logic.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r594231581",
      "id" : 594231581,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDIzMTU4MQ==",
      "original_commit_id" : "eb211ea0af0ba683ff1f77b576f33b651eab8cff",
      "original_line" : 1876,
      "original_position" : 99,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 612017175,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-17T05:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594231581",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r594255146"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594255146"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n\r\n#include <consensus/params.h>\r\n#include <versionbits.h>\r\n```",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-03-15T11:27:35Z",
      "diff_hunk" : "@@ -0,0 +1,17 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <deploymentstatus.h>\n+#include <versionbits.h>\n+\n+#include <consensus/params.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r594255146",
      "id" : 594255146,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDI1NTE0Ng==",
      "original_commit_id" : "eb211ea0af0ba683ff1f77b576f33b651eab8cff",
      "original_line" : 7,
      "original_position" : 8,
      "original_start_line" : 6,
      "path" : "src/deploymentstatus.cpp",
      "position" : null,
      "pull_request_review_id" : 612017175,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-17T05:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594255146",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r594258168"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594258168"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n#include <string>\r\n```\r\n\r\n(string.h is the c string library: https://en.cppreference.com/w/cpp/header/cstring)",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-03-15T11:32:16Z",
      "diff_hunk" : "@@ -0,0 +1,29 @@\n+// Copyright (c) 2016-2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_DEPLOYMENTINFO_H\n+#define BITCOIN_DEPLOYMENTINFO_H\n+\n+#include <consensus/params.h>\n+\n+#include <string.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r594258168",
      "id" : 594258168,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDI1ODE2OA==",
      "original_commit_id" : "eb211ea0af0ba683ff1f77b576f33b651eab8cff",
      "original_line" : 10,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/deploymentinfo.h",
      "position" : null,
      "pull_request_review_id" : 612017175,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-17T05:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594258168",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "approach ACK, I like the strategy of using enums with safety checks + overloaded functions to abstract buried vs future deployments ",
      "created_at" : "2021-03-16T20:27:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#issuecomment-800581046",
      "id" : 800581046,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19438",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwMDU4MTA0Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-16T20:27:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/800581046",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r595599351"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595599351"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In \"versionbits: correct doxygen comments\"\r\n\r\nNit: perhaps it's worth stopping using `pindexPrev` here if it's giving statistics for the specified block rather than its successor?",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-03-16T23:04:33Z",
      "diff_hunk" : "@@ -79,11 +79,11 @@ struct VersionBitsCache\n     void Clear();\n };\n \n-/** Get the BIP9 state for a given deployment at the current tip. */\n+/** Get the BIP9 state for a given deployment for the block after pindexPrev. */\n ThresholdState VersionBitsState(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos pos, VersionBitsCache& cache);\n-/** Get the numerical statistics for the BIP9 state for a given deployment at the current tip. */\n+/** Get the numerical statistics for the BIP9 state for a given deployment as at pindexPrev. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r595599351",
      "id" : 595599351,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTU5OTM1MQ==",
      "original_commit_id" : "898d54177d364a8120c2fcd4cfeaa831121062fd",
      "original_line" : 84,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/versionbits.h",
      "position" : null,
      "pull_request_review_id" : 613795309,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-17T05:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595599351",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r595610191"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595610191"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@jnewbery The class does have members variables, and the non-static member function do access them, so unless those variables become static too (which would be rather ugly), the other member functions can't be.\r\n\r\nI think it doesn't hurt to mark the function that don't need state static.",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-03-16T23:32:50Z",
      "diff_hunk" : "@@ -70,21 +72,32 @@ class AbstractThresholdConditionChecker {\n     int GetStateSinceHeightFor(const CBlockIndex* pindexPrev, const Consensus::Params& params, ThresholdConditionCache& cache) const;\n };\n \n-/** BIP 9 allows multiple softforks to be deployed in parallel. We cache per-period state for every one of them\n- *  keyed by the bit position used to signal support. */\n-struct VersionBitsCache\n+/** BIP 9 allows multiple softforks to be deployed in parallel. We cache\n+ *  per-period state for every one of them. */\n+\n+class VersionBitsCache\n {\n-    ThresholdConditionCache caches[Consensus::MAX_VERSION_BITS_DEPLOYMENTS];\n+private:\n+    Mutex cs;\n+    ThresholdConditionCache caches[Consensus::MAX_VERSION_BITS_DEPLOYMENTS] GUARDED_BY(cs);\n+\n+public:\n+    /** Get the numerical statistics for the BIP9 state for a given deployment as at pindexPrev. */\n+    static BIP9Stats Statistics(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos pos);\n+\n+    static uint32_t Mask(const Consensus::Params& params, Consensus::DeploymentPos pos);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r595610191",
      "id" : 595610191,
      "in_reply_to_id" : 594206873,
      "line" : 88,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTYxMDE5MQ==",
      "original_commit_id" : "eb211ea0af0ba683ff1f77b576f33b651eab8cff",
      "original_line" : 88,
      "original_position" : 30,
      "original_start_line" : 86,
      "path" : "src/versionbits.h",
      "position" : 30,
      "pull_request_review_id" : 613795309,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : 86,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-17T05:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595610191",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r595618136"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595618136"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It's giving the statistics for the retarget period that includes `pindexPrev`'s successor, up to and including `pindexPrev` if `pindexPrev` is in the same retarget period, but not if `pindexPrev` was the last block in the previous retarget period. (That means you can't actually query the statistics for a fully completed retarget period -- you'll always get statistics for between 0 and 2015 blocks worth of signalling, never the full 2016 blocks. Or whatever the period is)\r\n\r\nI've been confused about this until recently, so not sure how to describe it well",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-03-16T23:55:22Z",
      "diff_hunk" : "@@ -79,11 +79,11 @@ struct VersionBitsCache\n     void Clear();\n };\n \n-/** Get the BIP9 state for a given deployment at the current tip. */\n+/** Get the BIP9 state for a given deployment for the block after pindexPrev. */\n ThresholdState VersionBitsState(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos pos, VersionBitsCache& cache);\n-/** Get the numerical statistics for the BIP9 state for a given deployment at the current tip. */\n+/** Get the numerical statistics for the BIP9 state for a given deployment as at pindexPrev. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r595618136",
      "id" : 595618136,
      "in_reply_to_id" : 595599351,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTYxODEzNg==",
      "original_commit_id" : "898d54177d364a8120c2fcd4cfeaa831121062fd",
      "original_line" : 84,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/versionbits.h",
      "position" : null,
      "pull_request_review_id" : 613816703,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-17T05:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595618136",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r595702589"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595702589"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't think I agree -- if there wasn't a cache, there would be no need for an object, these things would just be standalone functions, so calling the object a cache makes sense to me.\r\n\r\nThere's some impedence mismatch though -- apart from having to have the object, the api is otherwise pretty independent of whether there's a cache or not.",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-03-17T04:22:05Z",
      "diff_hunk" : "@@ -70,21 +72,32 @@ class AbstractThresholdConditionChecker {\n     int GetStateSinceHeightFor(const CBlockIndex* pindexPrev, const Consensus::Params& params, ThresholdConditionCache& cache) const;\n };\n \n-/** BIP 9 allows multiple softforks to be deployed in parallel. We cache per-period state for every one of them\n- *  keyed by the bit position used to signal support. */\n-struct VersionBitsCache\n+/** BIP 9 allows multiple softforks to be deployed in parallel. We cache\n+ *  per-period state for every one of them. */\n+\n+class VersionBitsCache",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r595702589",
      "id" : 595702589,
      "in_reply_to_id" : 594201846,
      "line" : 78,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTcwMjU4OQ==",
      "original_commit_id" : "eb211ea0af0ba683ff1f77b576f33b651eab8cff",
      "original_line" : 78,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/versionbits.h",
      "position" : 19,
      "pull_request_review_id" : 613909603,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-17T05:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595702589",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r595704637"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595704637"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It could just say \"Get statistics for the BIP9 state for the measuring window that inlcudes pindexPrev's successor.\" ?\r\n\r\nFeel free to disregard this.",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-03-17T04:29:10Z",
      "diff_hunk" : "@@ -79,11 +79,11 @@ struct VersionBitsCache\n     void Clear();\n };\n \n-/** Get the BIP9 state for a given deployment at the current tip. */\n+/** Get the BIP9 state for a given deployment for the block after pindexPrev. */\n ThresholdState VersionBitsState(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos pos, VersionBitsCache& cache);\n-/** Get the numerical statistics for the BIP9 state for a given deployment at the current tip. */\n+/** Get the numerical statistics for the BIP9 state for a given deployment as at pindexPrev. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r595704637",
      "id" : 595704637,
      "in_reply_to_id" : 595599351,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTcwNDYzNw==",
      "original_commit_id" : "898d54177d364a8120c2fcd4cfeaa831121062fd",
      "original_line" : 84,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/versionbits.h",
      "position" : null,
      "pull_request_review_id" : 613911903,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-17T05:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595704637",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r595711135"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595711135"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "We cast to an int to iterate in a few places, and changing them feels gratuitous -- we can't make the underlying type something that won't fit in an int because the fixed arrays we index into via the enum value would break too.",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-03-17T04:50:27Z",
      "diff_hunk" : "@@ -185,28 +185,47 @@ class VersionBitsConditionChecker : public AbstractThresholdConditionChecker {\n \n } // namespace\n \n-ThresholdState VersionBitsState(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos pos, VersionBitsCache& cache)\n+ThresholdState VersionBitsCache::State(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos pos)\n {\n-    return VersionBitsConditionChecker(pos).GetStateFor(pindexPrev, params, cache.caches[pos]);\n+    LOCK(cs);\n+    return VersionBitsConditionChecker(pos).GetStateFor(pindexPrev, params, caches[pos]);\n }\n \n-BIP9Stats VersionBitsStatistics(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos pos)\n+BIP9Stats VersionBitsCache::Statistics(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos pos)\n {\n     return VersionBitsConditionChecker(pos).GetStateStatisticsFor(pindexPrev, params);\n }\n \n-int VersionBitsStateSinceHeight(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos pos, VersionBitsCache& cache)\n+int VersionBitsCache::StateSinceHeight(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos pos)\n {\n-    return VersionBitsConditionChecker(pos).GetStateSinceHeightFor(pindexPrev, params, cache.caches[pos]);\n+    LOCK(cs);\n+    return VersionBitsConditionChecker(pos).GetStateSinceHeightFor(pindexPrev, params, caches[pos]);\n }\n \n-uint32_t VersionBitsMask(const Consensus::Params& params, Consensus::DeploymentPos pos)\n+uint32_t VersionBitsCache::Mask(const Consensus::Params& params, Consensus::DeploymentPos pos)\n {\n     return VersionBitsConditionChecker(pos).Mask(params);\n }\n \n+int32_t VersionBitsCache::ComputeBlockVersion(const CBlockIndex* pindexPrev, const Consensus::Params& params)\n+{\n+    LOCK(cs);\n+    int32_t nVersion = VERSIONBITS_TOP_BITS;\n+\n+    for (int i = 0; i < (int)Consensus::MAX_VERSION_BITS_DEPLOYMENTS; i++) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r595711135",
      "id" : 595711135,
      "in_reply_to_id" : 594226697,
      "line" : 215,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTcxMTEzNQ==",
      "original_commit_id" : "eb211ea0af0ba683ff1f77b576f33b651eab8cff",
      "original_line" : 215,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/versionbits.cpp",
      "position" : 37,
      "pull_request_review_id" : 613919126,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-17T05:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595711135",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r595721593"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595721593"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think this is the same impedence mismatch as \"calling it a cache\" -- they're static because they don't use the cache.",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-03-17T05:26:05Z",
      "diff_hunk" : "@@ -70,21 +72,32 @@ class AbstractThresholdConditionChecker {\n     int GetStateSinceHeightFor(const CBlockIndex* pindexPrev, const Consensus::Params& params, ThresholdConditionCache& cache) const;\n };\n \n-/** BIP 9 allows multiple softforks to be deployed in parallel. We cache per-period state for every one of them\n- *  keyed by the bit position used to signal support. */\n-struct VersionBitsCache\n+/** BIP 9 allows multiple softforks to be deployed in parallel. We cache\n+ *  per-period state for every one of them. */\n+\n+class VersionBitsCache\n {\n-    ThresholdConditionCache caches[Consensus::MAX_VERSION_BITS_DEPLOYMENTS];\n+private:\n+    Mutex cs;\n+    ThresholdConditionCache caches[Consensus::MAX_VERSION_BITS_DEPLOYMENTS] GUARDED_BY(cs);\n+\n+public:\n+    /** Get the numerical statistics for the BIP9 state for a given deployment as at pindexPrev. */\n+    static BIP9Stats Statistics(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos pos);\n+\n+    static uint32_t Mask(const Consensus::Params& params, Consensus::DeploymentPos pos);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r595721593",
      "id" : 595721593,
      "in_reply_to_id" : 594206873,
      "line" : 88,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTcyMTU5Mw==",
      "original_commit_id" : "eb211ea0af0ba683ff1f77b576f33b651eab8cff",
      "original_line" : 88,
      "original_position" : 30,
      "original_start_line" : 86,
      "path" : "src/versionbits.h",
      "position" : 30,
      "pull_request_review_id" : 613931247,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : 86,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-17T05:41:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595721593",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Nits picked.",
      "created_at" : "2021-03-17T05:41:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#issuecomment-800811067",
      "id" : 800811067,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19438",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwMDgxMTA2Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-17T05:41:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/800811067",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r595727074"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595727074"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Names changed; left as non-mutable and non-const.",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-03-17T05:42:59Z",
      "diff_hunk" : "@@ -70,21 +72,32 @@ class AbstractThresholdConditionChecker {\n     int GetStateSinceHeightFor(const CBlockIndex* pindexPrev, const Consensus::Params& params, ThresholdConditionCache& cache) const;\n };\n \n-/** BIP 9 allows multiple softforks to be deployed in parallel. We cache per-period state for every one of them\n- *  keyed by the bit position used to signal support. */\n-struct VersionBitsCache\n+/** BIP 9 allows multiple softforks to be deployed in parallel. We cache\n+ *  per-period state for every one of them. */\n+\n+class VersionBitsCache\n {\n-    ThresholdConditionCache caches[Consensus::MAX_VERSION_BITS_DEPLOYMENTS];\n+private:\n+    Mutex cs;\n+    ThresholdConditionCache caches[Consensus::MAX_VERSION_BITS_DEPLOYMENTS] GUARDED_BY(cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r595727074",
      "id" : 595727074,
      "in_reply_to_id" : 594204760,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTcyNzA3NA==",
      "original_commit_id" : "eb211ea0af0ba683ff1f77b576f33b651eab8cff",
      "original_line" : 82,
      "original_position" : 24,
      "original_start_line" : 81,
      "path" : "src/versionbits.h",
      "position" : null,
      "pull_request_review_id" : 613937551,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-17T05:43:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595727074",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r595841030"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595841030"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ok",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-03-17T09:21:20Z",
      "diff_hunk" : "@@ -185,28 +185,47 @@ class VersionBitsConditionChecker : public AbstractThresholdConditionChecker {\n \n } // namespace\n \n-ThresholdState VersionBitsState(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos pos, VersionBitsCache& cache)\n+ThresholdState VersionBitsCache::State(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos pos)\n {\n-    return VersionBitsConditionChecker(pos).GetStateFor(pindexPrev, params, cache.caches[pos]);\n+    LOCK(cs);\n+    return VersionBitsConditionChecker(pos).GetStateFor(pindexPrev, params, caches[pos]);\n }\n \n-BIP9Stats VersionBitsStatistics(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos pos)\n+BIP9Stats VersionBitsCache::Statistics(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos pos)\n {\n     return VersionBitsConditionChecker(pos).GetStateStatisticsFor(pindexPrev, params);\n }\n \n-int VersionBitsStateSinceHeight(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos pos, VersionBitsCache& cache)\n+int VersionBitsCache::StateSinceHeight(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos pos)\n {\n-    return VersionBitsConditionChecker(pos).GetStateSinceHeightFor(pindexPrev, params, cache.caches[pos]);\n+    LOCK(cs);\n+    return VersionBitsConditionChecker(pos).GetStateSinceHeightFor(pindexPrev, params, caches[pos]);\n }\n \n-uint32_t VersionBitsMask(const Consensus::Params& params, Consensus::DeploymentPos pos)\n+uint32_t VersionBitsCache::Mask(const Consensus::Params& params, Consensus::DeploymentPos pos)\n {\n     return VersionBitsConditionChecker(pos).Mask(params);\n }\n \n+int32_t VersionBitsCache::ComputeBlockVersion(const CBlockIndex* pindexPrev, const Consensus::Params& params)\n+{\n+    LOCK(cs);\n+    int32_t nVersion = VERSIONBITS_TOP_BITS;\n+\n+    for (int i = 0; i < (int)Consensus::MAX_VERSION_BITS_DEPLOYMENTS; i++) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r595841030",
      "id" : 595841030,
      "in_reply_to_id" : 594226697,
      "line" : 215,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTg0MTAzMA==",
      "original_commit_id" : "eb211ea0af0ba683ff1f77b576f33b651eab8cff",
      "original_line" : 215,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/versionbits.cpp",
      "position" : 37,
      "pull_request_review_id" : 614078407,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-17T09:21:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595841030",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r595842651"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595842651"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> apart from having to have the object, the api is otherwise pretty independent of whether there's a cache or not.\r\n\r\nIndeed. The client doesn't care whether there's a cache or not (and for the static functions, there isn't even a cache). Generally, I think interfaces should be named according to the client usage, not the implementation specifics. Not a big deal, and shouldn't hold up this PR.",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-03-17T09:23:30Z",
      "diff_hunk" : "@@ -70,21 +72,32 @@ class AbstractThresholdConditionChecker {\n     int GetStateSinceHeightFor(const CBlockIndex* pindexPrev, const Consensus::Params& params, ThresholdConditionCache& cache) const;\n };\n \n-/** BIP 9 allows multiple softforks to be deployed in parallel. We cache per-period state for every one of them\n- *  keyed by the bit position used to signal support. */\n-struct VersionBitsCache\n+/** BIP 9 allows multiple softforks to be deployed in parallel. We cache\n+ *  per-period state for every one of them. */\n+\n+class VersionBitsCache",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r595842651",
      "id" : 595842651,
      "in_reply_to_id" : 594201846,
      "line" : 78,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTg0MjY1MQ==",
      "original_commit_id" : "eb211ea0af0ba683ff1f77b576f33b651eab8cff",
      "original_line" : 78,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/versionbits.h",
      "position" : 19,
      "pull_request_review_id" : 614080482,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-17T09:23:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595842651",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "code review ACK e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-03-17T09:24:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#issuecomment-800930430",
      "id" : 800930430,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19438",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwMDkzMDQzMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-17T09:24:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/800930430",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r595859319"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595859319"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The client does care a little about whether there's a cache -- without it, checking the state is potentially linear in the height of the block being tested, with it, it's amortized constant. Particularly for deployments with short periods (like bip91) that could be prohibitive.\r\n\r\nPerhaps it's worth considering renaming it to `SignalledDeploymentManager` or similar along with renaming from `BIP9` to `VBits` or renaming `DeploymentPos` or a deeper refactoring of `AbstractThresholdConditionChecker` etc.",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-03-17T09:45:25Z",
      "diff_hunk" : "@@ -70,21 +72,32 @@ class AbstractThresholdConditionChecker {\n     int GetStateSinceHeightFor(const CBlockIndex* pindexPrev, const Consensus::Params& params, ThresholdConditionCache& cache) const;\n };\n \n-/** BIP 9 allows multiple softforks to be deployed in parallel. We cache per-period state for every one of them\n- *  keyed by the bit position used to signal support. */\n-struct VersionBitsCache\n+/** BIP 9 allows multiple softforks to be deployed in parallel. We cache\n+ *  per-period state for every one of them. */\n+\n+class VersionBitsCache",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r595859319",
      "id" : 595859319,
      "in_reply_to_id" : 594201846,
      "line" : 78,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTg1OTMxOQ==",
      "original_commit_id" : "eb211ea0af0ba683ff1f77b576f33b651eab8cff",
      "original_line" : 78,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/versionbits.h",
      "position" : 19,
      "pull_request_review_id" : 614101719,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-17T09:45:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595859319",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r595865800"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595865800"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'd prefer a generic name like `SignalledDeploymentManager`, but it definitely shouldn't hold up this PR.",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-03-17T09:53:51Z",
      "diff_hunk" : "@@ -70,21 +72,32 @@ class AbstractThresholdConditionChecker {\n     int GetStateSinceHeightFor(const CBlockIndex* pindexPrev, const Consensus::Params& params, ThresholdConditionCache& cache) const;\n };\n \n-/** BIP 9 allows multiple softforks to be deployed in parallel. We cache per-period state for every one of them\n- *  keyed by the bit position used to signal support. */\n-struct VersionBitsCache\n+/** BIP 9 allows multiple softforks to be deployed in parallel. We cache\n+ *  per-period state for every one of them. */\n+\n+class VersionBitsCache",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r595865800",
      "id" : 595865800,
      "in_reply_to_id" : 594201846,
      "line" : 78,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTg2NTgwMA==",
      "original_commit_id" : "eb211ea0af0ba683ff1f77b576f33b651eab8cff",
      "original_line" : 78,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/versionbits.h",
      "position" : 19,
      "pull_request_review_id" : 614109794,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-17T09:53:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595865800",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r595866714"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595866714"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> The client does care a little about whether there's a cache\r\n\r\nSorry, I meant in terms of correctness/observability. Of course a cache has implications for computational complexity.",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-03-17T09:55:05Z",
      "diff_hunk" : "@@ -70,21 +72,32 @@ class AbstractThresholdConditionChecker {\n     int GetStateSinceHeightFor(const CBlockIndex* pindexPrev, const Consensus::Params& params, ThresholdConditionCache& cache) const;\n };\n \n-/** BIP 9 allows multiple softforks to be deployed in parallel. We cache per-period state for every one of them\n- *  keyed by the bit position used to signal support. */\n-struct VersionBitsCache\n+/** BIP 9 allows multiple softforks to be deployed in parallel. We cache\n+ *  per-period state for every one of them. */\n+\n+class VersionBitsCache",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r595866714",
      "id" : 595866714,
      "in_reply_to_id" : 594201846,
      "line" : 78,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTg2NjcxNA==",
      "original_commit_id" : "eb211ea0af0ba683ff1f77b576f33b651eab8cff",
      "original_line" : 78,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/versionbits.h",
      "position" : 19,
      "pull_request_review_id" : 614110978,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-17T09:55:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595866714",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r598387676"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/598387676"
         }
      },
      "author_association" : "NONE",
      "body" : "nit: With all these new functions taking a `const CBlockIndex* ...` argument, maybe use a `const CBlockIndex& ...` instead. Safer API, and can still use `&pindexPrev` to get a pointer (if needed).",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-03-22T02:22:03Z",
      "diff_hunk" : "@@ -0,0 +1,55 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_DEPLOYMENTSTATUS_H\n+#define BITCOIN_DEPLOYMENTSTATUS_H\n+\n+#include <chain.h>\n+#include <versionbits.h>\n+\n+#include <limits>\n+\n+/** Global cache for versionbits deployment status */\n+extern VersionBitsCache versionbitscache;\n+\n+/** Determine if a deployment is active for the next block */\n+inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::BuriedDeployment dep)\n+{\n+    assert(Consensus::ValidDeployment(dep));\n+    return (pindexPrev == nullptr ? 0 : pindexPrev->nHeight + 1) >= params.DeploymentHeight(dep);\n+}\n+\n+inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos dep)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r598387676",
      "id" : 598387676,
      "line" : 23,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5ODM4NzY3Ng==",
      "original_commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "original_line" : 23,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/deploymentstatus.h",
      "position" : 23,
      "pull_request_review_id" : 617108154,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-22T02:22:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/598387676",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/80422284?v=4",
         "events_url" : "https://api.github.com/users/GeneFerneau/events{/privacy}",
         "followers_url" : "https://api.github.com/users/GeneFerneau/followers",
         "following_url" : "https://api.github.com/users/GeneFerneau/following{/other_user}",
         "gists_url" : "https://api.github.com/users/GeneFerneau/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/GeneFerneau",
         "id" : 80422284,
         "login" : "GeneFerneau",
         "node_id" : "MDQ6VXNlcjgwNDIyMjg0",
         "organizations_url" : "https://api.github.com/users/GeneFerneau/orgs",
         "received_events_url" : "https://api.github.com/users/GeneFerneau/received_events",
         "repos_url" : "https://api.github.com/users/GeneFerneau/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/GeneFerneau/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/GeneFerneau/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/GeneFerneau"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r598406329"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/598406329"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Could make sense to have `DeploymentActiveAt(const CBlockIndex&, ...)` but `DeploymentActiveAfter` can be called with nullptr, so can't be a reference.",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-03-22T03:38:32Z",
      "diff_hunk" : "@@ -0,0 +1,55 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_DEPLOYMENTSTATUS_H\n+#define BITCOIN_DEPLOYMENTSTATUS_H\n+\n+#include <chain.h>\n+#include <versionbits.h>\n+\n+#include <limits>\n+\n+/** Global cache for versionbits deployment status */\n+extern VersionBitsCache versionbitscache;\n+\n+/** Determine if a deployment is active for the next block */\n+inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::BuriedDeployment dep)\n+{\n+    assert(Consensus::ValidDeployment(dep));\n+    return (pindexPrev == nullptr ? 0 : pindexPrev->nHeight + 1) >= params.DeploymentHeight(dep);\n+}\n+\n+inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos dep)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r598406329",
      "id" : 598406329,
      "in_reply_to_id" : 598387676,
      "line" : 23,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5ODQwNjMyOQ==",
      "original_commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "original_line" : 23,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/deploymentstatus.h",
      "position" : 23,
      "pull_request_review_id" : 617128855,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-22T03:38:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/598406329",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK. Started reviewing ",
      "created_at" : "2021-03-22T17:23:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#issuecomment-804249778",
      "id" : 804249778,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19438",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwNDI0OTc3OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-22T17:23:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/804249778",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19157360?v=4",
         "events_url" : "https://api.github.com/users/0xB10C/events{/privacy}",
         "followers_url" : "https://api.github.com/users/0xB10C/followers",
         "following_url" : "https://api.github.com/users/0xB10C/following{/other_user}",
         "gists_url" : "https://api.github.com/users/0xB10C/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/0xB10C",
         "id" : 19157360,
         "login" : "0xB10C",
         "node_id" : "MDQ6VXNlcjE5MTU3MzYw",
         "organizations_url" : "https://api.github.com/users/0xB10C/orgs",
         "received_events_url" : "https://api.github.com/users/0xB10C/received_events",
         "repos_url" : "https://api.github.com/users/0xB10C/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/0xB10C/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/0xB10C/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/0xB10C"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r600402619"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/600402619"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "in 8b2aa89f9f6366cfd3a3dfccf2f7678740b4d0ea\r\n\r\nnit: couldn't this be `< MAX_VERSION_BITS_DEPLOYMENTS` to avoid changing this line when adding/burring a deployment?\r\n\r\n```suggestion\r\nconstexpr bool ValidDeployment(DeploymentPos dep) { return DEPLOYMENT_TESTDUMMY <= dep && dep < MAX_VERSION_BITS_DEPLOYMENTS; }\r\n```",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-03-24T11:44:31Z",
      "diff_hunk" : "@@ -22,13 +22,14 @@ enum BuriedDeployment : int16_t\n };\n constexpr bool ValidDeployment(BuriedDeployment dep) { return DEPLOYMENT_HEIGHTINCB <= dep && dep <= DEPLOYMENT_SEGWIT; }\n \n-enum DeploymentPos\n+enum DeploymentPos : uint16_t\n {\n     DEPLOYMENT_TESTDUMMY,\n     DEPLOYMENT_TAPROOT, // Deployment of Schnorr/Taproot (BIPs 340-342)\n     // NOTE: Also add new deployments to VersionBitsDeploymentInfo in versionbits.cpp\n     MAX_VERSION_BITS_DEPLOYMENTS\n };\n+constexpr bool ValidDeployment(DeploymentPos dep) { return DEPLOYMENT_TESTDUMMY <= dep && dep <= DEPLOYMENT_TAPROOT; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r600402619",
      "id" : 600402619,
      "line" : 32,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMDQwMjYxOQ==",
      "original_commit_id" : "8b2aa89f9f6366cfd3a3dfccf2f7678740b4d0ea",
      "original_line" : 32,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/consensus/params.h",
      "position" : 24,
      "pull_request_review_id" : 619619356,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T11:44:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/600402619",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19157360?v=4",
         "events_url" : "https://api.github.com/users/0xB10C/events{/privacy}",
         "followers_url" : "https://api.github.com/users/0xB10C/followers",
         "following_url" : "https://api.github.com/users/0xB10C/following{/other_user}",
         "gists_url" : "https://api.github.com/users/0xB10C/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/0xB10C",
         "id" : 19157360,
         "login" : "0xB10C",
         "node_id" : "MDQ6VXNlcjE5MTU3MzYw",
         "organizations_url" : "https://api.github.com/users/0xB10C/orgs",
         "received_events_url" : "https://api.github.com/users/0xB10C/received_events",
         "repos_url" : "https://api.github.com/users/0xB10C/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/0xB10C/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/0xB10C/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/0xB10C"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r606681109"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/606681109"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "very minor nit: If you add a `DEPLOYMENT_BURIED_MAX` and then use `dep < DEPLOYMENT_BURIED_MAX` instead of `dep <= DEPLOYMENT_SEGWIT` then this line wouldn't need to change when something is buried. But I am not sure if it's an improvement overall.",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-04-03T16:09:57Z",
      "diff_hunk" : "@@ -11,6 +11,17 @@\n \n namespace Consensus {\n \n+enum BuriedDeployment : int16_t\n+{\n+    // buried deployments get negative values to avoid overlap with DeploymentPos\n+    DEPLOYMENT_HEIGHTINCB = std::numeric_limits<int16_t>::min(),\n+    DEPLOYMENT_CLTV,\n+    DEPLOYMENT_DERSIG,\n+    DEPLOYMENT_CSV,\n+    DEPLOYMENT_SEGWIT,\n+};\n+constexpr bool ValidDeployment(BuriedDeployment dep) { return DEPLOYMENT_HEIGHTINCB <= dep && dep <= DEPLOYMENT_SEGWIT; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r606681109",
      "id" : 606681109,
      "line" : 23,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNjY4MTEwOQ==",
      "original_commit_id" : "994b0ce58f832da28adf90ab08ce2a7d6886cdae",
      "original_line" : 23,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/consensus/params.h",
      "position" : 14,
      "pull_request_review_id" : 627453646,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-03T17:30:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/606681109",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r606682906"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/606682906"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: You could do `!pindexPrev` instead of `== nullptr` I think",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-04-03T16:28:35Z",
      "diff_hunk" : "@@ -0,0 +1,33 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_DEPLOYMENTSTATUS_H\n+#define BITCOIN_DEPLOYMENTSTATUS_H\n+\n+#include <chain.h>\n+\n+#include <limits>\n+\n+/** Determine if a deployment is active for the next block */\n+inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::BuriedDeployment dep)\n+{\n+    assert(Consensus::ValidDeployment(dep));\n+    return (pindexPrev == nullptr ? 0 : pindexPrev->nHeight + 1) >= params.DeploymentHeight(dep);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r606682906",
      "id" : 606682906,
      "line" : 20,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNjY4MjkwNg==",
      "original_commit_id" : "994b0ce58f832da28adf90ab08ce2a7d6886cdae",
      "original_line" : 16,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/deploymentstatus.h",
      "position" : 20,
      "pull_request_review_id" : 627453646,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-03T23:03:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/606682906",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r606683378"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/606683378"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: Could use an optional as return value instead of this to signal if no height was found?",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-04-03T16:34:05Z",
      "diff_hunk" : "@@ -90,7 +101,25 @@ struct Params {\n      */\n     bool signet_blocks{false};\n     std::vector<uint8_t> signet_challenge;\n+\n+    inline int DeploymentHeight(BuriedDeployment dep) const\n+    {\n+        switch (dep) {\n+        case DEPLOYMENT_HEIGHTINCB:\n+            return BIP34Height;\n+        case DEPLOYMENT_CLTV:\n+            return BIP65Height;\n+        case DEPLOYMENT_DERSIG:\n+            return BIP66Height;\n+        case DEPLOYMENT_CSV:\n+            return CSVHeight;\n+        case DEPLOYMENT_SEGWIT:\n+            return SegwitHeight;\n+        } // no default case, so the compiler can warn about missing cases\n+        return std::numeric_limits<int>::max();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r606683378",
      "id" : 606683378,
      "line" : 120,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNjY4MzM3OA==",
      "original_commit_id" : "994b0ce58f832da28adf90ab08ce2a7d6886cdae",
      "original_line" : 119,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/consensus/params.h",
      "position" : 47,
      "pull_request_review_id" : 627453646,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-03T17:30:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/606683378",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r606683621"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/606683621"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: This check is repeated three times only to protect `DeploymentHeight()` afaict, maybe move it into `DeploymentHeight()`?",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-04-03T16:36:33Z",
      "diff_hunk" : "@@ -0,0 +1,33 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_DEPLOYMENTSTATUS_H\n+#define BITCOIN_DEPLOYMENTSTATUS_H\n+\n+#include <chain.h>\n+\n+#include <limits>\n+\n+/** Determine if a deployment is active for the next block */\n+inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::BuriedDeployment dep)\n+{\n+    assert(Consensus::ValidDeployment(dep));\n+    return (pindexPrev == nullptr ? 0 : pindexPrev->nHeight + 1) >= params.DeploymentHeight(dep);\n+}\n+\n+/** Determine if a deployment is active for this block */\n+inline bool DeploymentActiveAt(const CBlockIndex* pindex, const Consensus::Params& params, Consensus::BuriedDeployment dep)\n+{\n+    assert(Consensus::ValidDeployment(dep));\n+    return pindex->nHeight >= params.DeploymentHeight(dep);\n+}\n+\n+/** Determine if a deployment is enabled (can ever be active) */\n+inline bool DeploymentEnabled(const Consensus::Params& params, Consensus::BuriedDeployment dep)\n+{\n+    assert(Consensus::ValidDeployment(dep));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r606683621",
      "id" : 606683621,
      "line" : 45,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNjY4MzYyMQ==",
      "original_commit_id" : "994b0ce58f832da28adf90ab08ce2a7d6886cdae",
      "original_line" : 29,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/deploymentstatus.h",
      "position" : 45,
      "pull_request_review_id" : 627453646,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-03T17:30:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/606683621",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r606685946"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/606685946"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: accidental empty line?",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-04-03T16:59:02Z",
      "diff_hunk" : "@@ -70,21 +72,32 @@ class AbstractThresholdConditionChecker {\n     int GetStateSinceHeightFor(const CBlockIndex* pindexPrev, const Consensus::Params& params, ThresholdConditionCache& cache) const;\n };\n \n-/** BIP 9 allows multiple softforks to be deployed in parallel. We cache per-period state for every one of them\n- *  keyed by the bit position used to signal support. */\n-struct VersionBitsCache\n+/** BIP 9 allows multiple softforks to be deployed in parallel. We cache\n+ *  per-period state for every one of them. */\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r606685946",
      "id" : 606685946,
      "line" : 77,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNjY4NTk0Ng==",
      "original_commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "original_line" : 77,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/versionbits.h",
      "position" : 18,
      "pull_request_review_id" : 627453646,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-03T17:30:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/606685946",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r607013194"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/607013194"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "That would mean checking and dereferencing the optional at every call site, which doesn't seem useful.",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-04-05T09:56:51Z",
      "diff_hunk" : "@@ -90,7 +101,25 @@ struct Params {\n      */\n     bool signet_blocks{false};\n     std::vector<uint8_t> signet_challenge;\n+\n+    inline int DeploymentHeight(BuriedDeployment dep) const\n+    {\n+        switch (dep) {\n+        case DEPLOYMENT_HEIGHTINCB:\n+            return BIP34Height;\n+        case DEPLOYMENT_CLTV:\n+            return BIP65Height;\n+        case DEPLOYMENT_DERSIG:\n+            return BIP66Height;\n+        case DEPLOYMENT_CSV:\n+            return CSVHeight;\n+        case DEPLOYMENT_SEGWIT:\n+            return SegwitHeight;\n+        } // no default case, so the compiler can warn about missing cases\n+        return std::numeric_limits<int>::max();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r607013194",
      "id" : 607013194,
      "in_reply_to_id" : 606683378,
      "line" : 120,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNzAxMzE5NA==",
      "original_commit_id" : "994b0ce58f832da28adf90ab08ce2a7d6886cdae",
      "original_line" : 119,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/consensus/params.h",
      "position" : 47,
      "pull_request_review_id" : 627748098,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-05T09:56:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/607013194",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r611105596"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611105596"
         }
      },
      "author_association" : "NONE",
      "body" : "#21EA80DB",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-04-10T23:31:32Z",
      "diff_hunk" : "@@ -90,7 +101,25 @@ struct Params {\n      */\n     bool signet_blocks{false};\n     std::vector<uint8_t> signet_challenge;\n+\n+    inline int DeploymentHeight(BuriedDeployment dep) const\n+    {\n+        switch (dep) {\n+        case DEPLOYMENT_HEIGHTINCB:\n+            return BIP34Height;\n+        case DEPLOYMENT_CLTV:\n+            return BIP65Height;\n+        case DEPLOYMENT_DERSIG:\n+            return BIP66Height;\n+        case DEPLOYMENT_CSV:\n+            return CSVHeight;\n+        case DEPLOYMENT_SEGWIT:\n+            return SegwitHeight;\n+        } // no default case, so the compiler can warn about missing cases\n+        return std::numeric_limits<int>::max();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r611105596",
      "id" : 611105596,
      "in_reply_to_id" : 606683378,
      "line" : 120,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMTEwNTU5Ng==",
      "original_commit_id" : "994b0ce58f832da28adf90ab08ce2a7d6886cdae",
      "original_line" : 119,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/consensus/params.h",
      "position" : 47,
      "pull_request_review_id" : 632959904,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-10T23:33:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611105596",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/57122455?v=4",
         "events_url" : "https://api.github.com/users/hamedtayeban/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hamedtayeban/followers",
         "following_url" : "https://api.github.com/users/hamedtayeban/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hamedtayeban/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hamedtayeban",
         "id" : 57122455,
         "login" : "hamedtayeban",
         "node_id" : "MDQ6VXNlcjU3MTIyNDU1",
         "organizations_url" : "https://api.github.com/users/hamedtayeban/orgs",
         "received_events_url" : "https://api.github.com/users/hamedtayeban/received_events",
         "repos_url" : "https://api.github.com/users/hamedtayeban/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hamedtayeban/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hamedtayeban/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hamedtayeban"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r611105604"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611105604"
         }
      },
      "author_association" : "NONE",
      "body" : "> very minor nit: If you add a `DEPLOYMENT_BURIED_MAX` and then use `dep < DEPLOYMENT_BURIED_MAX` instead of `dep <= DEPLOYMENT_SEGWIT` then this line wouldn't need to change when something is buried. But I am not sure if it's an improvement overall.\n\n",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-04-10T23:31:43Z",
      "diff_hunk" : "@@ -11,6 +11,17 @@\n \n namespace Consensus {\n \n+enum BuriedDeployment : int16_t\n+{\n+    // buried deployments get negative values to avoid overlap with DeploymentPos\n+    DEPLOYMENT_HEIGHTINCB = std::numeric_limits<int16_t>::min(),\n+    DEPLOYMENT_CLTV,\n+    DEPLOYMENT_DERSIG,\n+    DEPLOYMENT_CSV,\n+    DEPLOYMENT_SEGWIT,\n+};\n+constexpr bool ValidDeployment(BuriedDeployment dep) { return DEPLOYMENT_HEIGHTINCB <= dep && dep <= DEPLOYMENT_SEGWIT; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r611105604",
      "id" : 611105604,
      "in_reply_to_id" : 606681109,
      "line" : 23,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMTEwNTYwNA==",
      "original_commit_id" : "994b0ce58f832da28adf90ab08ce2a7d6886cdae",
      "original_line" : 23,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/consensus/params.h",
      "position" : 14,
      "pull_request_review_id" : 632959914,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-10T23:33:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611105604",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/57122455?v=4",
         "events_url" : "https://api.github.com/users/hamedtayeban/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hamedtayeban/followers",
         "following_url" : "https://api.github.com/users/hamedtayeban/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hamedtayeban/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hamedtayeban",
         "id" : 57122455,
         "login" : "hamedtayeban",
         "node_id" : "MDQ6VXNlcjU3MTIyNDU1",
         "organizations_url" : "https://api.github.com/users/hamedtayeban/orgs",
         "received_events_url" : "https://api.github.com/users/hamedtayeban/received_events",
         "repos_url" : "https://api.github.com/users/hamedtayeban/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hamedtayeban/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hamedtayeban/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hamedtayeban"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r611105608"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611105608"
         }
      },
      "author_association" : "NONE",
      "body" : "> nit: You could do `!pindexPrev` instead of `== nullptr` I think\n\n",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-04-10T23:31:51Z",
      "diff_hunk" : "@@ -0,0 +1,33 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_DEPLOYMENTSTATUS_H\n+#define BITCOIN_DEPLOYMENTSTATUS_H\n+\n+#include <chain.h>\n+\n+#include <limits>\n+\n+/** Determine if a deployment is active for the next block */\n+inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::BuriedDeployment dep)\n+{\n+    assert(Consensus::ValidDeployment(dep));\n+    return (pindexPrev == nullptr ? 0 : pindexPrev->nHeight + 1) >= params.DeploymentHeight(dep);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r611105608",
      "id" : 611105608,
      "in_reply_to_id" : 606682906,
      "line" : 20,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMTEwNTYwOA==",
      "original_commit_id" : "994b0ce58f832da28adf90ab08ce2a7d6886cdae",
      "original_line" : 16,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/deploymentstatus.h",
      "position" : 20,
      "pull_request_review_id" : 632959920,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-10T23:33:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611105608",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/57122455?v=4",
         "events_url" : "https://api.github.com/users/hamedtayeban/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hamedtayeban/followers",
         "following_url" : "https://api.github.com/users/hamedtayeban/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hamedtayeban/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hamedtayeban",
         "id" : 57122455,
         "login" : "hamedtayeban",
         "node_id" : "MDQ6VXNlcjU3MTIyNDU1",
         "organizations_url" : "https://api.github.com/users/hamedtayeban/orgs",
         "received_events_url" : "https://api.github.com/users/hamedtayeban/received_events",
         "repos_url" : "https://api.github.com/users/hamedtayeban/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hamedtayeban/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hamedtayeban/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hamedtayeban"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r611105614"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611105614"
         }
      },
      "author_association" : "NONE",
      "body" : "> nit: You could do `!pindexPrev` instead of `== nullptr` I think\n\n",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-04-10T23:31:59Z",
      "diff_hunk" : "@@ -0,0 +1,33 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_DEPLOYMENTSTATUS_H\n+#define BITCOIN_DEPLOYMENTSTATUS_H\n+\n+#include <chain.h>\n+\n+#include <limits>\n+\n+/** Determine if a deployment is active for the next block */\n+inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::BuriedDeployment dep)\n+{\n+    assert(Consensus::ValidDeployment(dep));\n+    return (pindexPrev == nullptr ? 0 : pindexPrev->nHeight + 1) >= params.DeploymentHeight(dep);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r611105614",
      "id" : 611105614,
      "in_reply_to_id" : 606682906,
      "line" : 20,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMTEwNTYxNA==",
      "original_commit_id" : "994b0ce58f832da28adf90ab08ce2a7d6886cdae",
      "original_line" : 16,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/deploymentstatus.h",
      "position" : 20,
      "pull_request_review_id" : 632959926,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-10T23:33:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611105614",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/57122455?v=4",
         "events_url" : "https://api.github.com/users/hamedtayeban/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hamedtayeban/followers",
         "following_url" : "https://api.github.com/users/hamedtayeban/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hamedtayeban/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hamedtayeban",
         "id" : 57122455,
         "login" : "hamedtayeban",
         "node_id" : "MDQ6VXNlcjU3MTIyNDU1",
         "organizations_url" : "https://api.github.com/users/hamedtayeban/orgs",
         "received_events_url" : "https://api.github.com/users/hamedtayeban/received_events",
         "repos_url" : "https://api.github.com/users/hamedtayeban/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hamedtayeban/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hamedtayeban/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hamedtayeban"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r611105617"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611105617"
         }
      },
      "author_association" : "NONE",
      "body" : "> nit: You could do `!pindexPrev` instead of `== nullptr` I think\n\n",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-04-10T23:32:07Z",
      "diff_hunk" : "@@ -0,0 +1,33 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_DEPLOYMENTSTATUS_H\n+#define BITCOIN_DEPLOYMENTSTATUS_H\n+\n+#include <chain.h>\n+\n+#include <limits>\n+\n+/** Determine if a deployment is active for the next block */\n+inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::BuriedDeployment dep)\n+{\n+    assert(Consensus::ValidDeployment(dep));\n+    return (pindexPrev == nullptr ? 0 : pindexPrev->nHeight + 1) >= params.DeploymentHeight(dep);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r611105617",
      "id" : 611105617,
      "in_reply_to_id" : 606682906,
      "line" : 20,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMTEwNTYxNw==",
      "original_commit_id" : "994b0ce58f832da28adf90ab08ce2a7d6886cdae",
      "original_line" : 16,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/deploymentstatus.h",
      "position" : 20,
      "pull_request_review_id" : 632959928,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-10T23:33:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611105617",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/57122455?v=4",
         "events_url" : "https://api.github.com/users/hamedtayeban/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hamedtayeban/followers",
         "following_url" : "https://api.github.com/users/hamedtayeban/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hamedtayeban/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hamedtayeban",
         "id" : 57122455,
         "login" : "hamedtayeban",
         "node_id" : "MDQ6VXNlcjU3MTIyNDU1",
         "organizations_url" : "https://api.github.com/users/hamedtayeban/orgs",
         "received_events_url" : "https://api.github.com/users/hamedtayeban/received_events",
         "repos_url" : "https://api.github.com/users/hamedtayeban/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hamedtayeban/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hamedtayeban/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hamedtayeban"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r611105639"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611105639"
         }
      },
      "author_association" : "NONE",
      "body" : "> > very minor nit: If you add a `DEPLOYMENT_BURIED_MAX` and then use `dep < DEPLOYMENT_BURIED_MAX` instead of `dep <= DEPLOYMENT_SEGWIT` then this line wouldn't need to change when something is buried. But I am not sure if it's an improvement overall.\n> \n> \n\n",
      "commit_id" : "e72e062e5a8279864d746776dc9072c112ddc014",
      "created_at" : "2021-04-10T23:32:15Z",
      "diff_hunk" : "@@ -11,6 +11,17 @@\n \n namespace Consensus {\n \n+enum BuriedDeployment : int16_t\n+{\n+    // buried deployments get negative values to avoid overlap with DeploymentPos\n+    DEPLOYMENT_HEIGHTINCB = std::numeric_limits<int16_t>::min(),\n+    DEPLOYMENT_CLTV,\n+    DEPLOYMENT_DERSIG,\n+    DEPLOYMENT_CSV,\n+    DEPLOYMENT_SEGWIT,\n+};\n+constexpr bool ValidDeployment(BuriedDeployment dep) { return DEPLOYMENT_HEIGHTINCB <= dep && dep <= DEPLOYMENT_SEGWIT; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19438#discussion_r611105639",
      "id" : 611105639,
      "in_reply_to_id" : 606681109,
      "line" : 23,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMTEwNTYzOQ==",
      "original_commit_id" : "994b0ce58f832da28adf90ab08ce2a7d6886cdae",
      "original_line" : 23,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/consensus/params.h",
      "position" : 14,
      "pull_request_review_id" : 632959934,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19438",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-10T23:33:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611105639",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/57122455?v=4",
         "events_url" : "https://api.github.com/users/hamedtayeban/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hamedtayeban/followers",
         "following_url" : "https://api.github.com/users/hamedtayeban/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hamedtayeban/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hamedtayeban",
         "id" : 57122455,
         "login" : "hamedtayeban",
         "node_id" : "MDQ6VXNlcjU3MTIyNDU1",
         "organizations_url" : "https://api.github.com/users/hamedtayeban/orgs",
         "received_events_url" : "https://api.github.com/users/hamedtayeban/received_events",
         "repos_url" : "https://api.github.com/users/hamedtayeban/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hamedtayeban/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hamedtayeban/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hamedtayeban"
      }
   }
]
