[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Resurrected from #24474.\r\n\r\nThe main purpose of this PR is to document the variables we assume are only accessed via one thread, and hence which we don't bother to grab a mutex before accessing. Since these annotations are checked automatically by clang in CI, this should help avoid possible bugs in future.\r\n\r\nTo do this, this PR replaces the per-peer `CNode::cs_sendProcessing` (that was never actually used as a guard annotation for any variables, nor locked from any thread other than the message processing thread, and can only be used to guard other members of the `CNode` class) with a single, global, `NetEventsInterface:g_mutex_msgproc_thread` that is locked once from the message processing thread and released only when the thread exits.\r\n\r\nIt would also be possible to have a \"dummy\" lockable type and use that to document these variables, rather than an actual mutex. I've done an example of that sort of approach at https://github.com/bitcoin/bitcoin/pull/25174#issuecomment-1230284198 but for this case where the lock is only ever acquired once at startup and has no possible contention, the overhead seems so minimal as to not be worth worrying about.\r\n\r\nIn the long-term, simplifying the locking scheme, and perhaps allowing more things to happen in parallel are obviously still worthwhile; this PR doesn't mean to imply that these things *should* only be used from a single thread in future, rather it's just documenting that they are right now.\r\n\r\nSee also https://github.com/bitcoin/bitcoin/pull/25454#pullrequestreview-1030142634 https://github.com/bitcoin/bitcoin/pull/25557#issuecomment-1182092190  ",
      "created_at" : "2022-09-07T17:59:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26036#issuecomment-1239707930",
      "id" : 1239707930,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26036",
      "node_id" : "IC_kwDOABII585J5HEa",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1239707930/reactions"
      },
      "updated_at" : "2022-09-07T17:59:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1239707930",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#25597](https://github.com/bitcoin/bitcoin/pull/25597) (refactor: replace RecursiveMutex `cs_sendProcessing` with Mutex by theStack)\n* [#25572](https://github.com/bitcoin/bitcoin/pull/25572) (refactor: Introduce EvictionManager and use it for the inbound eviction logic by dergoegge)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-09-08T17:35:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26036#issuecomment-1241026514",
      "id" : 1241026514,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26036",
      "node_id" : "IC_kwDOABII585J-I_S",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1241026514/reactions"
      },
      "updated_at" : "2022-09-08T17:35:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1241026514",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   }
]
