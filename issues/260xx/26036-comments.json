[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Resurrected from #24474.\r\n\r\nThe main purpose of this PR is to document the variables we assume are only accessed via one thread, and hence which we don't bother to grab a mutex before accessing. Since these annotations are checked automatically by clang in CI, this should help avoid possible bugs in future.\r\n\r\nTo do this, this PR replaces the per-peer `CNode::cs_sendProcessing` (that was never actually used as a guard annotation for any variables, nor locked from any thread other than the message processing thread, and can only be used to guard other members of the `CNode` class) with a single, global, ~`NetEventsInterface:g_mutex_msgproc_thread`~ `NetEventsInterface:g_msgproc_mutex` that is locked once from the message processing thread and released only when the thread exits.\r\n\r\nIt would also be possible to have a \"dummy\" lockable type and use that to document these variables, rather than an actual mutex. I've done an example of that sort of approach at https://github.com/bitcoin/bitcoin/pull/25174#issuecomment-1230284198 but for this case where the lock is only ever acquired once at startup and has no possible contention, the overhead seems so minimal as to not be worth worrying about.\r\n\r\nIn the long-term, simplifying the locking scheme, and perhaps allowing more things to happen in parallel are obviously still worthwhile; this PR doesn't mean to imply that these things *should* only be used from a single thread in future, rather it's just documenting that they are right now.\r\n\r\nSee also https://github.com/bitcoin/bitcoin/pull/25454#pullrequestreview-1030142634 https://github.com/bitcoin/bitcoin/pull/25557#issuecomment-1182092190  ",
      "created_at" : "2022-09-07T17:59:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26036#issuecomment-1239707930",
      "id" : 1239707930,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26036",
      "node_id" : "IC_kwDOABII585J5HEa",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1239707930/reactions"
      },
      "updated_at" : "2022-09-13T03:44:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1239707930",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#25597](https://github.com/bitcoin/bitcoin/pull/25597) (refactor: replace RecursiveMutex `cs_sendProcessing` with Mutex by theStack)\n* [#25572](https://github.com/bitcoin/bitcoin/pull/25572) (refactor: Introduce EvictionManager and use it for the inbound eviction logic by dergoegge)\n* [#24545](https://github.com/bitcoin/bitcoin/pull/24545) (BIP324: Enable v2 P2P encrypted transport by dhruv)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-09-08T17:35:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26036#issuecomment-1241026514",
      "id" : 1241026514,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26036",
      "node_id" : "IC_kwDOABII585J-I_S",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1241026514/reactions"
      },
      "updated_at" : "2022-09-12T09:02:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1241026514",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26036#discussion_r967765403"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26036"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/967765403"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Runtime lock assertions on the definitions for the methods with added annotations on their declarations, e.g. for the first commit (same for the later commits):\r\n\r\n```diff\r\n--- a/src/net_processing.cpp\r\n+++ b/src/net_processing.cpp\r\n@@ -3135,6 +3135,7 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\r\n                                      const std::chrono::microseconds time_received,\r\n                                      const std::atomic<bool>& interruptMsgProc)\r\n {\r\n+    AssertLockHeld(g_mutex_msgproc_thread);\r\n \r\n@@ -4748,6 +4749,7 @@ bool PeerManagerImpl::MaybeDiscourageAndDisconnect(CNode& pnode, Peer& peer)\r\n \r\n bool PeerManagerImpl::ProcessMessages(CNode* pfrom, std::atomic<bool>& interruptMsgProc)\r\n {\r\n+    AssertLockHeld(g_mutex_msgproc_thread);\r\n \r\n@@ -5240,6 +5242,7 @@ bool PeerManagerImpl::SetupAddressRelay(const CNode& node, Peer& peer)\r\n \r\n bool PeerManagerImpl::SendMessages(CNode* pto)\r\n {\r\n+    AssertLockHeld(g_mutex_msgproc_thread);\r\n```\r\n\r\n\r\n ",
      "commit_id" : "f55747fa66afe1dcca242c0903b17c93f0437279",
      "created_at" : "2022-09-11T06:10:24Z",
      "diff_hunk" : "@@ -84,7 +84,7 @@ class PeerManager : public CValidationInterface, public NetEventsInterface\n \n     /** Process a single message from a peer. Public for fuzz testing */\n     virtual void ProcessMessage(CNode& pfrom, const std::string& msg_type, CDataStream& vRecv,\n-                                const std::chrono::microseconds time_received, const std::atomic<bool>& interruptMsgProc) = 0;\n+                                const std::chrono::microseconds time_received, const std::atomic<bool>& interruptMsgProc) EXCLUSIVE_LOCKS_REQUIRED(g_mutex_msgproc_thread) = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26036#discussion_r967765403",
      "id" : 967765403,
      "line" : 87,
      "node_id" : "PRRC_kwDOABII5845ru2b",
      "original_commit_id" : "f55747fa66afe1dcca242c0903b17c93f0437279",
      "original_line" : 87,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 5,
      "pull_request_review_id" : 1103244150,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26036",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/967765403/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-11T06:14:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/967765403",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26036#discussion_r968562054"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26036"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968562054"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: since it is not required that the variables protected by this mutex should only be used from a single thread in future, maybe drop `_thread` from the name of this mutex.\r\n\r\nnit: it seems like unwritten convention to put `_mutex` at the end: `foobar_mutex`, I think this is the first one to use `mutex_foobar`",
      "commit_id" : "22e7c464db9719ebc8eba0143f5a6024aac658c3",
      "created_at" : "2022-09-12T15:27:23Z",
      "diff_hunk" : "@@ -629,6 +627,9 @@ class CNode\n class NetEventsInterface\n {\n public:\n+    /** Mutex for anything that is only accessed via the msg processing thread */\n+    static Mutex g_mutex_msgproc_thread;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26036#discussion_r968562054",
      "id" : 968562054,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5845uxWG",
      "original_commit_id" : "f55747fa66afe1dcca242c0903b17c93f0437279",
      "original_line" : 631,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 1104351136,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26036",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968562054/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-12T15:33:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968562054",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26036#discussion_r969087706"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26036"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969087706"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Renamed",
      "commit_id" : "22e7c464db9719ebc8eba0143f5a6024aac658c3",
      "created_at" : "2022-09-13T02:41:18Z",
      "diff_hunk" : "@@ -629,6 +627,9 @@ class CNode\n class NetEventsInterface\n {\n public:\n+    /** Mutex for anything that is only accessed via the msg processing thread */\n+    static Mutex g_mutex_msgproc_thread;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26036#discussion_r969087706",
      "id" : 969087706,
      "in_reply_to_id" : 968562054,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5845wxra",
      "original_commit_id" : "f55747fa66afe1dcca242c0903b17c93f0437279",
      "original_line" : 631,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 1105052728,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26036",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969087706/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-13T02:41:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969087706",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Are you planning to actually make the message processing multi-threaded?\r\n\r\nOriginal point of all this was just to be able to make `g_cs_orphans` private to `TxOrphanage` without reducing guard annotations (#21527 and `vExtraTxn*`).\r\n\r\nI don't think multiple `net_processing` threads is likely to help much -- I think blocking mostly happens due to `cs_main` getting locked which would just cause multiple threads to stall if we had them, rather than some node requiring a lot of local processing that holds up some other node's local processing. Having either reader-writer locks for the mempool and `cs_main` or switching to a RCU model might help there, but is probably a lot of work. Either way, it seems helpful in the meantime to make it clearer how we protect things from race conditions.",
      "created_at" : "2022-09-13T03:36:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26036#issuecomment-1244855724",
      "id" : 1244855724,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26036",
      "node_id" : "IC_kwDOABII585KMv2s",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1244855724/reactions"
      },
      "updated_at" : "2022-09-13T03:36:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1244855724",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   }
]
