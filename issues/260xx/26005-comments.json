[
   {
      "author_association" : "MEMBER",
      "body" : ">Not sure if b60a2ce (\"Bugfix: Wallet: Wrap RestoreWallet content in a try block ...\") is needed.\r\nSee #22541 (comment).\r\n\r\nWithout it, the GUI crashes quite uncleanly (https://github.com/bitcoin-core/gui/issues/661), and an empty directory is left behind.",
      "created_at" : "2022-09-05T00:05:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26005#issuecomment-1236442290",
      "id" : 1236442290,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26005",
      "node_id" : "IC_kwDOABII585Jspyy",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1236442290/reactions"
      },
      "updated_at" : "2022-09-05T00:07:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1236442290",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26005#discussion_r962526431"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26005"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962526431"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This was likely introduced in fa475e9c7977a952617738f2ee8cf600c07d4df8, and 07df6cda1468ed45ac227ac6f0169b040e5c0bf3",
      "commit_id" : "c1cd7b4ac60d00dec369b3fe8f883cad07fbe833",
      "created_at" : "2022-09-05T06:37:51Z",
      "diff_hunk" : "@@ -570,15 +574,23 @@ class WalletLoaderImpl : public WalletLoader\n         ReadDatabaseArgs(*m_context.args, options);\n         options.require_existing = true;\n         bilingual_str error;\n-        util::Result<std::unique_ptr<Wallet>> wallet{MakeWallet(m_context, LoadWallet(m_context, name, /*load_on_start=*/true, options, status, error, warnings))};\n-        return wallet ? std::move(wallet) : util::Error{error};\n+        std::unique_ptr<Wallet> wallet{MakeWallet(m_context, LoadWallet(m_context, name, /*load_on_start=*/true, options, status, error, warnings))};\n+        if (wallet) {\n+            return std::move(wallet);\n+        } else {\n+            return util::Error{error};\n+        }\n     }\n     util::Result<std::unique_ptr<Wallet>> restoreWallet(const fs::path& backup_file, const std::string& wallet_name, std::vector<bilingual_str>& warnings) override\n     {\n         DatabaseStatus status;\n         bilingual_str error;\n-        util::Result<std::unique_ptr<Wallet>> wallet{MakeWallet(m_context, RestoreWallet(m_context, backup_file, wallet_name, /*load_on_start=*/true, status, error, warnings))};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26005#discussion_r962526431",
      "id" : 962526431,
      "line" : 580,
      "node_id" : "PRRC_kwDOABII5845Xvzf",
      "original_commit_id" : "c1cd7b4ac60d00dec369b3fe8f883cad07fbe833",
      "original_line" : 580,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/wallet/interfaces.cpp",
      "position" : 32,
      "pull_request_review_id" : 1095916504,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26005",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962526431/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-05T06:37:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962526431",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#25722](https://github.com/bitcoin/bitcoin/pull/25722) (refactor: Use util::Result class for wallet loading by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-09-05T06:38:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26005#issuecomment-1236592366",
      "id" : 1236592366,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26005",
      "node_id" : "IC_kwDOABII585JtObu",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1236592366/reactions"
      },
      "updated_at" : "2022-09-05T06:38:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1236592366",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "The `try` should probably be moved up to also include the `TryCreateDirectories` as well? If I change the permissions on the entire `wallets/` directory, it still crashes.\r\n\r\nOr maybe `TryCreateDirectories` needs to be modified to handle when it actually can't create a directory. That would also help with the case where a wallet dir can't be created during wallet creation.",
      "created_at" : "2022-09-06T16:58:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26005#issuecomment-1238416649",
      "id" : 1238416649,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26005",
      "node_id" : "IC_kwDOABII585J0L0J",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1238416649/reactions"
      },
      "updated_at" : "2022-09-06T17:00:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1238416649",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26005#discussion_r963972096"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26005"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963972096"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Bugfix: Wallet: Wrap RestoreWallet content in a try block to ensure exceptions become returned errors and incomplete wallet directory is removed\" (b60a2ce138f4549e7233542e21cd96e0d8e0b5f8)\r\n\r\nThis might just be difference of opinion about defensive programming, but IMO it makes code harder to reason about and maintain if it is catching exceptions that are never expected to be thrown. I think it would be better to only catch fs::filesystem_exception not std::exception, and only catch exceptions if copy_file throws, not if LoadWallet throws. I also think an error text like \"failed to copy wallet\" is better than \"unexpected exception.\" Possible suggestion:\r\n\r\n```diff\r\n--- a/src/wallet/wallet.cpp\r\n+++ b/src/wallet/wallet.cpp\r\n@@ -394,17 +394,16 @@ std::shared_ptr<CWallet> RestoreWallet(WalletContext& context, const fs::path& b\r\n     }\r\n \r\n     auto wallet_file = wallet_path / \"wallet.dat\";\r\n-    std::shared_ptr<CWallet> wallet;\r\n-\r\n+    status = DatabaseStatus::SUCCESS;\r\n     try {\r\n         fs::copy_file(backup_file, wallet_file, fs::copy_options::none);\r\n-\r\n-        wallet = LoadWallet(context, wallet_name, load_on_start, options, status, error, warnings);\r\n-    } catch (const std::exception& e) {\r\n-        wallet.reset();  // just in case\r\n-        if (!error.empty()) error += Untranslated(\"\\n\");\r\n-        error += strprintf(Untranslated(\"Unexpected exception: %s\"), e.what());\r\n+    } catch (const fs::filesystem_error& e) {\r\n+        error += Untranslated(strprintf((\"Failed to copy wallet: %s\"), e.what()));\r\n+        status = DatabaseStatus::FAILED_CREATE;\r\n     }\r\n+\r\n+    auto wallet = status == DatabaseStatus::SUCCESS ? LoadWallet(context, wallet_name, load_on_start, options, status, error, warnings) : nullptr;\r\n+\r\n     if (!wallet) {\r\n         fs::remove(wallet_file);\r\n         fs::remove(wallet_path);\r\n```",
      "commit_id" : "c1cd7b4ac60d00dec369b3fe8f883cad07fbe833",
      "created_at" : "2022-09-06T17:05:25Z",
      "diff_hunk" : "@@ -394,10 +394,17 @@ std::shared_ptr<CWallet> RestoreWallet(WalletContext& context, const fs::path& b\n     }\n \n     auto wallet_file = wallet_path / \"wallet.dat\";\n-    fs::copy_file(backup_file, wallet_file, fs::copy_options::none);\n+    std::shared_ptr<CWallet> wallet;\n \n-    auto wallet = LoadWallet(context, wallet_name, load_on_start, options, status, error, warnings);\n+    try {\n+        fs::copy_file(backup_file, wallet_file, fs::copy_options::none);\n \n+        wallet = LoadWallet(context, wallet_name, load_on_start, options, status, error, warnings);\n+    } catch (const std::exception& e) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26005#discussion_r963972096",
      "id" : 963972096,
      "line" : 403,
      "node_id" : "PRRC_kwDOABII5845dQwA",
      "original_commit_id" : "b60a2ce138f4549e7233542e21cd96e0d8e0b5f8",
      "original_line" : 403,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 12,
      "pull_request_review_id" : 1097969254,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26005",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963972096/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-06T17:17:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963972096",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   }
]
