[
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for reviewing!\r\n\r\n> From a practical perspective, I wonder if this change (or changes like it) would see a performance gain, or if the goal is more about clean code.\r\n\r\nI think the goal is to remove any unneeded locks for performance, while using locks where needed for thread safety. If you launch bitcoind with `debug=lock` (or run `bitcoin-cli logging [] '[\"lock\"]'` on a bitcoind instance) you'll see how much time is spent in locks, and in some cases it is significant. Even in faster or non-hotspot cases, taking a lock isn't particularly cheap so it seems best to not do so needlessly.\r\n\r\n> I also wonder if it is will result in future changes that are sub-optimal. What are the odds that something will want to call this function in the future that is not already locking cs_main?\r\n\r\nIn this case, thanks to the thread safety annotation the compiler would give a warning, and the run-time assertion may be hit, both of which would serve to warn that a missing lock is needed. At this time, however, `LoadBlockIndexGuts()` only has one caller in the codebase.\r\n\r\nMore information about Clang thread safety analysis, if helpful:\r\n    - https://clang.llvm.org/docs/ThreadSafetyAnalysis.html\r\n    - https://github.com/bitcoin/bitcoin/blob/master/doc/developer-notes.md#lockingmutex-usage-notes\r\n    - https://github.com/bitcoin/bitcoin/blob/master/doc/developer-notes.md#threads-and-synchronization",
      "created_at" : "2022-01-30T16:06:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24197#issuecomment-1025175163",
      "id" : 1025175163,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24197",
      "node_id" : "IC_kwDOABII5849Gu57",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1025175163/reactions"
      },
      "updated_at" : "2022-01-30T16:06:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1025175163",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   }
]
