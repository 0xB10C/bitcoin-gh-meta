[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#24091](https://github.com/bitcoin/bitcoin/pull/24091) (wallet: Consolidate CInputCoin and COutput by achow101)\n* [#20726](https://github.com/bitcoin/bitcoin/pull/20726) (p2p: Add DISABLETX message for negotiating block-relay-only connections by sdaftuar)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-01-22T20:34:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24128#issuecomment-1019353666",
      "id" : 1019353666,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24128",
      "node_id" : "IC_kwDOABII5848whpC",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1019353666/reactions"
      },
      "updated_at" : "2022-03-25T02:59:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1019353666",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Please review https://github.com/bitcoin/bitcoin/pull/24136  first, while this stays in Draft",
      "created_at" : "2022-01-24T09:22:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24128#issuecomment-1019885303",
      "id" : 1019885303,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24128",
      "node_id" : "IC_kwDOABII5848yjb3",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1019885303/reactions"
      },
      "updated_at" : "2022-01-24T09:22:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1019885303",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24128#discussion_r796564941"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24128"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/796564941"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "please convert this to a c++11 style functional cast",
      "commit_id" : "e0a3bf98b57fc36db60311f65793c16fdfee2452",
      "created_at" : "2022-02-01T12:52:59Z",
      "diff_hunk" : "@@ -609,23 +618,77 @@ static uint32_t GetLocktimeForNewTransaction(interfaces::Chain& chain, const uin\n     // enough, that fee sniping isn't a problem yet, but by implementing a fix\n     // now we ensure code won't be written that makes assumptions about\n     // nLockTime that preclude a fix later.\n+    //\n+    // nSequence-based\n+    // ---------------\n+    //\n+    // If all inputs in the tx spend taproot coins, use nSequence to discourage\n+    // fee-sniping. This creates a \"privacy cloak\" for txs that use taproot\n+    // key-path spends (BIP326).\n+    //\n+    // Compared to nLockTime-based anti-fee-sniping, this may be minimally less\n+    // effective, as nSequence only allows relative locks. If all inputs of the\n+    // tx can be moved backward in the chain, this tx can be as well. Though,\n+    // this should be fine given that 10% of txs have their locktime randomly\n+    // reduced to a past block. Also, sequence-based locking will only be used\n+    // if every sequence is at least 1.\n     if (IsCurrentForAntiFeeSniping(chain, block_hash)) {\n-        locktime = block_height;\n-\n-        // Secondly occasionally randomly pick a nLockTime even further back, so\n-        // that transactions that are delayed after signing for whatever reason,\n-        // e.g. high-latency mix networks and some CoinJoin implementations, have\n-        // better privacy.\n-        if (GetRandInt(10) == 0)\n-            locktime = std::max(0, (int)locktime - GetRandInt(100));\n+        bool locktime_based{false};\n+        for (const auto& in : inputs) {\n+            std::vector<std::vector<uint8_t>> dummy;\n+            const TxoutType in_type{Solver(in.txout.scriptPubKey, dummy)};\n+            // Use locktime if any nSequence is out-of-range or any input isn't taproot\n+            if (1 > in.m_depth || in.m_depth > 65535 || in_type != TxoutType::WITNESS_V1_TAPROOT) {\n+                locktime_based = true;\n+                break;\n+            }\n+        }\n+        if (locktime_based || GetRandInt(2) == 0) {\n+            tx.nLockTime = block_height;\n+\n+            // Secondly occasionally randomly pick a nLockTime even further back, so\n+            // that transactions that are delayed after signing for whatever reason,\n+            // e.g. high-latency mix networks and some CoinJoin implementations, have\n+            // better privacy.\n+            if (GetRandInt(10) == 0) {\n+                tx.nLockTime = std::max(0, (int)tx.nLockTime - GetRandInt(100));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24128#discussion_r796564941",
      "id" : 796564941,
      "line" : 654,
      "node_id" : "PRRC_kwDOABII584vep3N",
      "original_commit_id" : "e0a3bf98b57fc36db60311f65793c16fdfee2452",
      "original_line" : 654,
      "original_position" : 80,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 80,
      "pull_request_review_id" : 869085466,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24128",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/796564941/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-01T12:54:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/796564941",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6443210?v=4",
         "events_url" : "https://api.github.com/users/PastaPastaPasta/events{/privacy}",
         "followers_url" : "https://api.github.com/users/PastaPastaPasta/followers",
         "following_url" : "https://api.github.com/users/PastaPastaPasta/following{/other_user}",
         "gists_url" : "https://api.github.com/users/PastaPastaPasta/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/PastaPastaPasta",
         "id" : 6443210,
         "login" : "PastaPastaPasta",
         "node_id" : "MDQ6VXNlcjY0NDMyMTA=",
         "organizations_url" : "https://api.github.com/users/PastaPastaPasta/orgs",
         "received_events_url" : "https://api.github.com/users/PastaPastaPasta/received_events",
         "repos_url" : "https://api.github.com/users/PastaPastaPasta/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/PastaPastaPasta/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/PastaPastaPasta/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/PastaPastaPasta"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24128#discussion_r796596221"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24128"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/796596221"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Seems unrelated to this pull request, but done in https://github.com/bitcoin/bitcoin/pull/24225",
      "commit_id" : "c00fd82f6ea522429e7961af014405d4c3011b53",
      "created_at" : "2022-02-01T13:30:13Z",
      "diff_hunk" : "@@ -609,23 +618,77 @@ static uint32_t GetLocktimeForNewTransaction(interfaces::Chain& chain, const uin\n     // enough, that fee sniping isn't a problem yet, but by implementing a fix\n     // now we ensure code won't be written that makes assumptions about\n     // nLockTime that preclude a fix later.\n+    //\n+    // nSequence-based\n+    // ---------------\n+    //\n+    // If all inputs in the tx spend taproot coins, use nSequence to discourage\n+    // fee-sniping. This creates a \"privacy cloak\" for txs that use taproot\n+    // key-path spends (BIP326).\n+    //\n+    // Compared to nLockTime-based anti-fee-sniping, this may be minimally less\n+    // effective, as nSequence only allows relative locks. If all inputs of the\n+    // tx can be moved backward in the chain, this tx can be as well. Though,\n+    // this should be fine given that 10% of txs have their locktime randomly\n+    // reduced to a past block. Also, sequence-based locking will only be used\n+    // if every sequence is at least 1.\n     if (IsCurrentForAntiFeeSniping(chain, block_hash)) {\n-        locktime = block_height;\n-\n-        // Secondly occasionally randomly pick a nLockTime even further back, so\n-        // that transactions that are delayed after signing for whatever reason,\n-        // e.g. high-latency mix networks and some CoinJoin implementations, have\n-        // better privacy.\n-        if (GetRandInt(10) == 0)\n-            locktime = std::max(0, (int)locktime - GetRandInt(100));\n+        bool locktime_based{false};\n+        for (const auto& in : inputs) {\n+            std::vector<std::vector<uint8_t>> dummy;\n+            const TxoutType in_type{Solver(in.txout.scriptPubKey, dummy)};\n+            // Use locktime if any nSequence is out-of-range or any input isn't taproot\n+            if (1 > in.m_depth || in.m_depth > 65535 || in_type != TxoutType::WITNESS_V1_TAPROOT) {\n+                locktime_based = true;\n+                break;\n+            }\n+        }\n+        if (locktime_based || GetRandInt(2) == 0) {\n+            tx.nLockTime = block_height;\n+\n+            // Secondly occasionally randomly pick a nLockTime even further back, so\n+            // that transactions that are delayed after signing for whatever reason,\n+            // e.g. high-latency mix networks and some CoinJoin implementations, have\n+            // better privacy.\n+            if (GetRandInt(10) == 0) {\n+                tx.nLockTime = std::max(0, (int)tx.nLockTime - GetRandInt(100));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24128#discussion_r796596221",
      "id" : 796596221,
      "in_reply_to_id" : 796564941,
      "line" : 657,
      "node_id" : "PRRC_kwDOABII584vexf9",
      "original_commit_id" : "e0a3bf98b57fc36db60311f65793c16fdfee2452",
      "original_line" : 657,
      "original_position" : 80,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 83,
      "pull_request_review_id" : 869129599,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24128",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/796596221/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-01T13:30:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/796596221",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Please review https://github.com/bitcoin/bitcoin/pull/24225 first, while this stays in Draft",
      "created_at" : "2022-02-01T13:30:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24128#issuecomment-1026846034",
      "id" : 1026846034,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24128",
      "node_id" : "IC_kwDOABII5849NG1S",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1026846034/reactions"
      },
      "updated_at" : "2022-02-01T13:30:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1026846034",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Please review https://github.com/bitcoin/bitcoin/pull/24091 first while this stays in draft",
      "created_at" : "2022-03-16T14:17:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24128#issuecomment-1069179489",
      "id" : 1069179489,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24128",
      "node_id" : "IC_kwDOABII584_umJh",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1069179489/reactions"
      },
      "updated_at" : "2022-03-16T14:17:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1069179489",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-03-23T18:49:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24128#issuecomment-1076700424",
      "id" : 1076700424,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24128",
      "node_id" : "IC_kwDOABII585ALSUI",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1076700424/reactions"
      },
      "updated_at" : "2022-03-23T18:49:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1076700424",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-03-24T22:17:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24128#issuecomment-1078434724",
      "id" : 1078434724,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24128",
      "node_id" : "IC_kwDOABII585AR5uk",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1078434724/reactions"
      },
      "updated_at" : "2022-03-24T22:17:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1078434724",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This is now open for review",
      "created_at" : "2022-03-25T12:50:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24128#issuecomment-1078998404",
      "id" : 1078998404,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24128",
      "node_id" : "IC_kwDOABII585AUDWE",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1078998404/reactions"
      },
      "updated_at" : "2022-03-25T12:50:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1078998404",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24128#discussion_r838760681"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24128"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/838760681"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: since you already haveÂ `rng_fast` you could use it instead of re-creating a context with `GetRandInt`. (Here and elsewhere in this function.)",
      "commit_id" : "fa2066fd1272b857501f996267052b4f64a04b29",
      "created_at" : "2022-03-30T16:47:52Z",
      "diff_hunk" : "@@ -615,15 +625,59 @@ static void DiscourageFeeSniping(CMutableTransaction& tx, FastRandomContext& rng\n     // enough, that fee sniping isn't a problem yet, but by implementing a fix\n     // now we ensure code won't be written that makes assumptions about\n     // nLockTime that preclude a fix later.\n+    //\n+    // nSequence-based\n+    // ---------------\n+    //\n+    // If all inputs in the tx spend taproot coins, use nSequence to discourage\n+    // fee-sniping. This creates a \"privacy cloak\" for txs that use taproot\n+    // key-path spends (BIP326).\n+    //\n+    // Compared to nLockTime-based anti-fee-sniping, this may be minimally less\n+    // effective, as nSequence only allows relative locks. If all inputs of the\n+    // tx can be moved backward in the chain, this tx can be as well. Though,\n+    // this should be fine given that 10% of txs have their locktime randomly\n+    // reduced to a past block. Also, sequence-based locking will only be used\n+    // if every sequence is at least 1.\n     if (IsCurrentForAntiFeeSniping(chain, block_hash)) {\n-        tx.nLockTime = block_height;\n-\n-        // Secondly occasionally randomly pick a nLockTime even further back, so\n-        // that transactions that are delayed after signing for whatever reason,\n-        // e.g. high-latency mix networks and some CoinJoin implementations, have\n-        // better privacy.\n-        if (rng_fast.randrange(10) == 0) {\n-            tx.nLockTime = std::max(0, int(tx.nLockTime) - int(rng_fast.randrange(100)));\n+        auto locktime_based{[&] {\n+            if (!SignalsOptInRBF(CTransaction{tx})) {\n+                // Use locktime if the tx inputs do not opt-in to RBF\n+                return true;\n+            }\n+            for (const auto& in : inputs) {\n+                if (in.depth < 1 || uint64_t(in.depth) > MAX_BLOCK_SEQ) {\n+                    // Use locktime if any depth is out-of-range\n+                    return true;\n+                }\n+                std::vector<std::vector<uint8_t>> dummy;\n+                const TxoutType in_type{Solver(in.txout.scriptPubKey, dummy)};\n+                // Use locktime if any input isn't taproot\n+                if (in_type != TxoutType::WITNESS_V1_TAPROOT) {\n+                    return true;\n+                }\n+            }\n+            return false;\n+        }};\n+        if (locktime_based() || GetRandInt(2) == 0) {\n+            tx.nLockTime = block_height;\n+\n+            // Secondly occasionally randomly pick a nLockTime even further back, so\n+            // that transactions that are delayed after signing for whatever reason,\n+            // e.g. high-latency mix networks and some CoinJoin implementations, have\n+            // better privacy.\n+            if (rng_fast.randrange(10) == 0) {\n+                tx.nLockTime = std::max(0, int(tx.nLockTime) - int(rng_fast.randrange(100)));\n+            }\n+        } else { // sequence based\n+            tx.nLockTime = 0;\n+            const auto i_input{GetRandInt(tx.vin.size())};\n+            CTxIn& in{tx.vin.at(i_input)};\n+            in.nSequence = inputs.at(i_input).depth;\n+            if (GetRandInt(10) == 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24128#discussion_r838760681",
      "id" : 838760681,
      "line" : 677,
      "node_id" : "PRRC_kwDOABII584x_njp",
      "original_commit_id" : "fa2066fd1272b857501f996267052b4f64a04b29",
      "original_line" : 677,
      "original_position" : 98,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 98,
      "pull_request_review_id" : 926432309,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24128",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/838760681/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-30T17:47:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/838760681",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24128#discussion_r838787057"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24128"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/838787057"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It has a specific usecase for Taproot, but what is the rationale for disabling it for non-(pure-)Taproot transactions? The \"created by Bitcoin Core wallet\" fingerprint?",
      "commit_id" : "fa2066fd1272b857501f996267052b4f64a04b29",
      "created_at" : "2022-03-30T17:17:29Z",
      "diff_hunk" : "@@ -615,15 +625,59 @@ static void DiscourageFeeSniping(CMutableTransaction& tx, FastRandomContext& rng\n     // enough, that fee sniping isn't a problem yet, but by implementing a fix\n     // now we ensure code won't be written that makes assumptions about\n     // nLockTime that preclude a fix later.\n+    //\n+    // nSequence-based\n+    // ---------------\n+    //\n+    // If all inputs in the tx spend taproot coins, use nSequence to discourage\n+    // fee-sniping. This creates a \"privacy cloak\" for txs that use taproot\n+    // key-path spends (BIP326).\n+    //\n+    // Compared to nLockTime-based anti-fee-sniping, this may be minimally less\n+    // effective, as nSequence only allows relative locks. If all inputs of the\n+    // tx can be moved backward in the chain, this tx can be as well. Though,\n+    // this should be fine given that 10% of txs have their locktime randomly\n+    // reduced to a past block. Also, sequence-based locking will only be used\n+    // if every sequence is at least 1.\n     if (IsCurrentForAntiFeeSniping(chain, block_hash)) {\n-        tx.nLockTime = block_height;\n-\n-        // Secondly occasionally randomly pick a nLockTime even further back, so\n-        // that transactions that are delayed after signing for whatever reason,\n-        // e.g. high-latency mix networks and some CoinJoin implementations, have\n-        // better privacy.\n-        if (rng_fast.randrange(10) == 0) {\n-            tx.nLockTime = std::max(0, int(tx.nLockTime) - int(rng_fast.randrange(100)));\n+        auto locktime_based{[&] {\n+            if (!SignalsOptInRBF(CTransaction{tx})) {\n+                // Use locktime if the tx inputs do not opt-in to RBF\n+                return true;\n+            }\n+            for (const auto& in : inputs) {\n+                if (in.depth < 1 || uint64_t(in.depth) > MAX_BLOCK_SEQ) {\n+                    // Use locktime if any depth is out-of-range\n+                    return true;\n+                }\n+                std::vector<std::vector<uint8_t>> dummy;\n+                const TxoutType in_type{Solver(in.txout.scriptPubKey, dummy)};\n+                // Use locktime if any input isn't taproot\n+                if (in_type != TxoutType::WITNESS_V1_TAPROOT) {\n+                    return true;\n+                }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24128#discussion_r838787057",
      "id" : 838787057,
      "line" : 658,
      "node_id" : "PRRC_kwDOABII584x_t_x",
      "original_commit_id" : "fa2066fd1272b857501f996267052b4f64a04b29",
      "original_line" : 658,
      "original_position" : 79,
      "original_start_line" : 653,
      "path" : "src/wallet/spend.cpp",
      "position" : 79,
      "pull_request_review_id" : 926432309,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24128",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/838787057/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 653,
      "start_side" : "RIGHT",
      "updated_at" : "2022-03-30T17:47:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/838787057",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24128#discussion_r839827974"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24128"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/839827974"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I can't say for sure, since I am not the author of BIP 326, but I presume:\r\n\r\n* Any protocol that relies on sequence values in \"legacy\" key-only spends may be encouraged to upgrade to taproot.\r\n* Any new \"population\" of txs that have the same fingerprint will reduce the privacy for themselves and everyone else. Though, if such a population already exists, I can see the reason for Bitcoin Core to mix itself into that population.\r\n\r\nSo I guess the question is whether such a protocol exists and is unlikely to use/upgrade to taproot?",
      "commit_id" : "fa8cfae8b82a36ae598e1956d16d2d65ac8df44c",
      "created_at" : "2022-03-31T16:52:14Z",
      "diff_hunk" : "@@ -615,15 +625,59 @@ static void DiscourageFeeSniping(CMutableTransaction& tx, FastRandomContext& rng\n     // enough, that fee sniping isn't a problem yet, but by implementing a fix\n     // now we ensure code won't be written that makes assumptions about\n     // nLockTime that preclude a fix later.\n+    //\n+    // nSequence-based\n+    // ---------------\n+    //\n+    // If all inputs in the tx spend taproot coins, use nSequence to discourage\n+    // fee-sniping. This creates a \"privacy cloak\" for txs that use taproot\n+    // key-path spends (BIP326).\n+    //\n+    // Compared to nLockTime-based anti-fee-sniping, this may be minimally less\n+    // effective, as nSequence only allows relative locks. If all inputs of the\n+    // tx can be moved backward in the chain, this tx can be as well. Though,\n+    // this should be fine given that 10% of txs have their locktime randomly\n+    // reduced to a past block. Also, sequence-based locking will only be used\n+    // if every sequence is at least 1.\n     if (IsCurrentForAntiFeeSniping(chain, block_hash)) {\n-        tx.nLockTime = block_height;\n-\n-        // Secondly occasionally randomly pick a nLockTime even further back, so\n-        // that transactions that are delayed after signing for whatever reason,\n-        // e.g. high-latency mix networks and some CoinJoin implementations, have\n-        // better privacy.\n-        if (rng_fast.randrange(10) == 0) {\n-            tx.nLockTime = std::max(0, int(tx.nLockTime) - int(rng_fast.randrange(100)));\n+        auto locktime_based{[&] {\n+            if (!SignalsOptInRBF(CTransaction{tx})) {\n+                // Use locktime if the tx inputs do not opt-in to RBF\n+                return true;\n+            }\n+            for (const auto& in : inputs) {\n+                if (in.depth < 1 || uint64_t(in.depth) > MAX_BLOCK_SEQ) {\n+                    // Use locktime if any depth is out-of-range\n+                    return true;\n+                }\n+                std::vector<std::vector<uint8_t>> dummy;\n+                const TxoutType in_type{Solver(in.txout.scriptPubKey, dummy)};\n+                // Use locktime if any input isn't taproot\n+                if (in_type != TxoutType::WITNESS_V1_TAPROOT) {\n+                    return true;\n+                }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24128#discussion_r839827974",
      "id" : 839827974,
      "in_reply_to_id" : 838787057,
      "line" : 663,
      "node_id" : "PRRC_kwDOABII584yDsIG",
      "original_commit_id" : "fa2066fd1272b857501f996267052b4f64a04b29",
      "original_line" : 663,
      "original_position" : 79,
      "original_start_line" : 653,
      "path" : "src/wallet/spend.cpp",
      "position" : 79,
      "pull_request_review_id" : 927906694,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24128",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/839827974/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 658,
      "start_side" : "RIGHT",
      "updated_at" : "2022-03-31T16:52:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/839827974",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
