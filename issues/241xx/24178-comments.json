[
   {
      "author_association" : "MEMBER",
      "body" : "For additional background on where this logic came from originally, please see: https://github.com/bitcoin/bitcoin/pull/5927#issuecomment-104665085, https://github.com/bitcoin/bitcoin/pull/6172, https://github.com/bitcoin/bitcoin/pull/21106#issuecomment-790802591 (as well as additional discussion in #21106 generally)",
      "created_at" : "2022-01-27T13:53:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24178#issuecomment-1023233262",
      "id" : 1023233262,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24178",
      "node_id" : "IC_kwDOABII5848_Uzu",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1023233262/reactions"
      },
      "updated_at" : "2022-01-27T13:53:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1023233262",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks @jonatack -- I've made the test cleanups you suggested.",
      "created_at" : "2022-01-27T16:37:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24178#issuecomment-1023418755",
      "id" : 1023418755,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24178",
      "node_id" : "IC_kwDOABII5849ACGD",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1023418755/reactions"
      },
      "updated_at" : "2022-01-27T16:37:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1023418755",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#24008](https://github.com/bitcoin/bitcoin/pull/24008) (assumeutxo: net_processing changes by jamesob)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-01-27T22:01:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24178#issuecomment-1023677360",
      "id" : 1023677360,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24178",
      "node_id" : "IC_kwDOABII5849BBOw",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1023677360/reactions"
      },
      "updated_at" : "2022-01-27T22:01:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1023677360",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@sdaftuar So when two nodes differ in their checkpoint value, the attack could in theory still apply (being fed a bogus chain during IBD, which would then cause you to be banned by other nodes), but that's just too expensive if it requires the attacker to either branch off long before the current nMinimumChainWork value (effectively requiring the attacker to rewrite history), or shortly before the current nMinimumChainWork (but require recent-ish difficulty blocks on top)?",
      "created_at" : "2022-01-27T23:47:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24178#issuecomment-1023745278",
      "id" : 1023745278,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24178",
      "node_id" : "IC_kwDOABII5849BRz-",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1023745278/reactions"
      },
      "updated_at" : "2022-01-27T23:47:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1023745278",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> @sdaftuar So when two nodes differ in their checkpoint value, the attack could in theory still apply (being fed a bogus chain during IBD, which would then cause you to be banned by other nodes), but that's just too expensive if it requires the attacker to either branch off long before the current nMinimumChainWork value (effectively requiring the attacker to rewrite history), or shortly before the current nMinimumChainWork (but require recent-ish difficulty blocks on top)?\r\n\r\nI'm interpreting \"differ in their checkpoint value\" as meaning \"have chains that disagree about blocks before the checkpoint value\", instead of \"have software that disagrees about which blockhashes are checkpointed\", because in that latter case I think it should be clear that all bets are off for such peers remaining in consensus with each other.\r\n\r\nIn the former case, which is what this logic is trying to protect against, then yes the point of the `nMinimumChainWork` check is that it is too expensive to rewrite history that forks off before the last checkpoint which has as much work as our `nMinimumChainWork` setting.  I don't believe there's any meaningful DoS risk to us from an attacker branching the chain shortly before the current nMinimumChainWork, because even if we're fed a less work chain that forks from some recent-ish point, that won't cause us to be partitioned off the network (our peers will just think we're on some less-work but not consensus-invalid branch).\r\n\r\nMaybe I should have reframed what this PR does a bit when I opened it.  Right now, one of the criteria to leave IBD (so that `IsIBD()` returns false, and so that we would respond to getheaders requests) is having a chain with more work than `nMinimumChainWork`, so what this PR changes is that the other `IsIBD()` requirements no longer need to be met in order to start responding to getheaders requests.  The other checks done in `IsIBD()` are:\r\n\r\n```    \r\n    if (m_cached_finished_ibd.load(std::memory_order_relaxed))\r\n        return false;\r\n    if (fImporting || fReindex)\r\n        return true;\r\n    if (m_chain.Tip() == nullptr)\r\n        return true;\r\n    if (m_chain.Tip()->nChainWork < nMinimumChainWork)\r\n        return true;\r\n    if (m_chain.Tip()->GetBlockTime() < (GetTime() - nMaxTipAge))\r\n        return true;\r\n```\r\nSo what this PR is doing is not requiring the tip-age check to pass, and it's also not requiring that we're done reindexing or importing blocks from disk.  Relaxing the tip-age check is intentional and I think a better behavior in the event that block creation stalled on the network for some reason.  Now that I think about it, maybe I should re-add the guard about `fImporting || fReindex` so that we don't have peers asking to download blocks from us while we're still busy processing what we have on disk, but not sure how important that is.",
      "created_at" : "2022-01-28T13:52:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24178#issuecomment-1024244611",
      "id" : 1024244611,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24178",
      "node_id" : "IC_kwDOABII5849DLuD",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1024244611/reactions"
      },
      "updated_at" : "2022-01-28T13:52:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1024244611",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   }
]
