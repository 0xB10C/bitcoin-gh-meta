[
   {
      "body" : "Another one at https://travis-ci.org/bitcoin/bitcoin/jobs/109329790",
      "created_at" : "2016-02-15T13:12:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/7463#issuecomment-184200673",
      "id" : 184200673,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7463",
      "updated_at" : "2016-02-15T13:12:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/184200673",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "I've noticed that this mostly happens on the 32 bit travis build (.3)\r\n",
      "created_at" : "2016-03-15T14:02:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/7463#issuecomment-196834823",
      "id" : 196834823,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7463",
      "updated_at" : "2016-03-15T14:02:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/196834823",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "I don't think we're even sure whether -salvagewallet terminates. In this case every time the last line seem to call some bitcoin-cli command with -rpcwait. In case the client would crash, or exit, it would just wait forever.\r\nI so wish we had full access to the VM image that runs the tests in these cases.\r\n",
      "created_at" : "2016-03-25T10:14:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/7463#issuecomment-201228590",
      "id" : 201228590,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7463",
      "updated_at" : "2016-03-25T10:32:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/201228590",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "> In case the client would crash, or exit, it would just wait forever.\r\n\r\nThe client does not crash nor exit, iIrc. salvagewallet returns some sort of error and the client tries to shutdown. Somehow this fails and the \"write-peers.dat-thread\" just continues to run. Haven't had the time  to look into that yet...",
      "created_at" : "2016-03-25T11:24:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/7463#issuecomment-201244901",
      "id" : 201244901,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7463",
      "updated_at" : "2016-03-25T11:24:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/201244901",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=3",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "body" : "~~So you managed to reproduce this locally?~~\r\ndohh you say so in the OP",
      "created_at" : "2016-03-25T11:26:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/7463#issuecomment-201245062",
      "id" : 201245062,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7463",
      "updated_at" : "2016-03-25T11:26:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/201245062",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "You can just run\r\n\r\n```sh\r\n$ for i in {0..10000}; do qa/pull-tester/rpc-tests.py wallet --nocleanup;if [ $? -ne 0 ];then echo; echo \"fail\"; sleep 1d;fi ;done\r\n```\r\n\r\nand come back 20 minutes later to dig through the dumps.",
      "created_at" : "2016-03-25T11:29:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/7463#issuecomment-201245467",
      "id" : 201245467,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7463",
      "updated_at" : "2016-03-25T11:29:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/201245467",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=3",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "body" : "I did a similar thing, I put the part of wallet.py that does the salvage in an infinite loop.\r\n\r\nManaged to make it hang after ~100 iterations.\r\n\r\nLooking at the debug.log it didn't hang during the salvage, but manages to go into normal operation. And the node didn't start shutting down at all. I could even succesfully send it a stop command and it stopped running. This won't set the python script in motion again though. Curious.\r\n\r\n~~At least it looks like a problem in the script framework, not in the salvage process itself, that does put my concerns to rest a bit.~~\r\n\r\nOh, I didn't notice it spawns three nodes. The third one indeed has:\r\n```\r\n2016-03-25 10:41:54 Renamed wallet.dat to wallet.1458902514.bak\r\n2016-03-25 10:41:54 CDBEnv::Salvage: Database salvage found errors, all data may not be recoverable.\r\n2016-03-25 10:41:54 Salvage(aggressive) found 295 records\r\n```\r\n",
      "created_at" : "2016-03-25T12:00:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/7463#issuecomment-201251744",
      "id" : 201251744,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7463",
      "updated_at" : "2016-03-25T12:04:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/201251744",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Ok, I was right in my gist above. I can reproduce this 100% of the time now with a specific wallet:\r\nAfter the salvage goes wrong (for whatever reason) the node will just exit.\r\n\r\nThe test framework somehow doesn't detect this sudden exit. I think it will try to send a stop command (with -rpcwait) which never arrives, because the node is not running anymore in the first place. It will try forever to send it.\r\n\r\nThis makes the test hang 100% of the time:\r\n```patch\r\n--- a/src/wallet/wallet.cpp\r\n+++ b/src/wallet/wallet.cpp\r\n@@ -390,8 +390,9 @@ bool CWallet::Verify(const string& walletFile, string& warningString, string& er\r\n     if (GetBoolArg(\"-salvagewallet\", false))\r\n     {\r\n         // Recover readable keypairs:\r\n-        if (!CWalletDB::Recover(bitdb, walletFile, true))\r\n-            return false;\r\n+        return false;\r\n     }\r\n     \r\n     if (boost::filesystem::exists(GetDataDir() / walletFile))\r\n```\r\n\r\nThat, of course, leaves the question *why* the wallet ends up in a non-salvageable state. But at least the test should not hang in this case, but fail with a clearer error.",
      "created_at" : "2016-03-25T12:32:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/7463#issuecomment-201264203",
      "id" : 201264203,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7463",
      "updated_at" : "2016-03-25T12:43:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/201264203",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "#7744 solves the test framework issue.\r\n\r\n> That, of course, leaves the question why the wallet ends up in a non-salvageable state.\r\n\r\nThe underlying problem is weird. It seems that randomly, after exit, the wallet database fails verification with `DB_SALVAGE|DB_AGRESSIVE` but otherwise works fine. E.g.\r\n```\r\nint result = db.verify(strFile.c_str(), NULL, &strDump, flags); \r\n```\r\nreturns `DB_VERIFY_BAD`.\r\n\r\n- However, the wallet works as normally. Non `-salvagewallet` doesn't see any problems at all.\r\n- Unlike the error message would have you believe, the salvage successfully recovers the entire wallet.\r\n\r\nHere's an example wallet that triggers this: https://dev.visucore.com/bitcoin/tmp/crapwallet.dat\r\n",
      "created_at" : "2016-03-25T14:46:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/7463#issuecomment-201319622",
      "id" : 201319622,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7463",
      "updated_at" : "2016-03-25T14:46:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/201319622",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   }
]
