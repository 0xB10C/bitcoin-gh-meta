[
   {
      "body" : "Thanks, good catch, assigned 0.10 milestone.\r\n\r\nutACK",
      "created_at" : "2014-12-19T07:11:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5507#issuecomment-67605564",
      "id" : 67605564,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5507",
      "updated_at" : "2014-12-19T07:12:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/67605564",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Nice catch, this is indeed a problem.\r\n\r\nI'm less sure about the solution. MarkBlockAsInFlight is only called as a result of a local decision to start fetching a block, so if it overflows, it just means the logic for decision to download blocks in the first place is wrong.\r\n\r\nSo, there are two possible code paths that lead to a decision to download a block. One is the 'normal' headers-based synchronization: see the FindNextBlocksToDownload() call in main.cpp:SendMessages. This one should properly take the number of blocks in flight into account, and can always function as a fallback.\r\n\r\nThe other is the 'direct download' optimized path, in the \"inv\" handling in main.cppProcessMessage, which only works in the case we assume we're already very close to syncing, and is there to reduce latency in waiting for SendMessages, plus avoids a roundtrip between asking the headers and asking the block.\r\n\r\nI think the solution is just disabling the second mechanism in case we're already downloading too many blocks from the peer under consideration. We shouldn't look at the total number in flight for this, though, as that would lead to a potential DoS where a few peers spam block announcements, and avoid using the optimized fetching from honest peers.",
      "created_at" : "2014-12-19T14:29:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5507#issuecomment-67644273",
      "id" : 67644273,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5507",
      "updated_at" : "2014-12-19T14:29:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/67644273",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Also, #4831 is only affects transaction fetching, not block fetching, so a solution is very welcome here, including master.",
      "created_at" : "2014-12-19T14:34:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5507#issuecomment-67644881",
      "id" : 67644881,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5507",
      "updated_at" : "2014-12-19T14:34:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/67644881",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Cool!  I've reverted the original strategy...  I assume you mean something like this.  I've verified that it does indeed stop the attack and I'm playing with testing synchronization under a few conditions now.\r\n",
      "created_at" : "2014-12-19T17:32:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5507#issuecomment-67669499",
      "id" : 67669499,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5507",
      "updated_at" : "2014-12-19T17:32:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/67669499",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/430315?v=3",
         "events_url" : "https://api.github.com/users/ajweiss/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajweiss/followers",
         "following_url" : "https://api.github.com/users/ajweiss/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajweiss/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajweiss",
         "id" : 430315,
         "login" : "ajweiss",
         "organizations_url" : "https://api.github.com/users/ajweiss/orgs",
         "received_events_url" : "https://api.github.com/users/ajweiss/received_events",
         "repos_url" : "https://api.github.com/users/ajweiss/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajweiss/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajweiss/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajweiss"
      }
   },
   {
      "body" : "Untested ACK (after squash). Testing on testnet now.",
      "created_at" : "2014-12-22T15:08:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5507#issuecomment-67846953",
      "id" : 67846953,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5507",
      "updated_at" : "2014-12-22T15:08:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/67846953",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Tested ACK.",
      "created_at" : "2014-12-22T20:51:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5507#issuecomment-67888085",
      "id" : 67888085,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5507",
      "updated_at" : "2014-12-22T20:51:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/67888085",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "afk today, will squash tonight...   also tested against bogus inv floods and early/late stage sync...",
      "created_at" : "2014-12-22T21:38:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5507#issuecomment-67893165",
      "id" : 67893165,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5507",
      "updated_at" : "2014-12-22T21:38:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/67893165",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/430315?v=3",
         "events_url" : "https://api.github.com/users/ajweiss/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajweiss/followers",
         "following_url" : "https://api.github.com/users/ajweiss/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajweiss/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajweiss",
         "id" : 430315,
         "login" : "ajweiss",
         "organizations_url" : "https://api.github.com/users/ajweiss/orgs",
         "received_events_url" : "https://api.github.com/users/ajweiss/received_events",
         "repos_url" : "https://api.github.com/users/ajweiss/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajweiss/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajweiss/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajweiss"
      }
   },
   {
      "body" : "Rebase-squashed.  No changes from what sipa tested.\r\n",
      "created_at" : "2014-12-23T07:32:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5507#issuecomment-67927844",
      "id" : 67927844,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5507",
      "updated_at" : "2014-12-23T07:32:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/67927844",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/430315?v=3",
         "events_url" : "https://api.github.com/users/ajweiss/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajweiss/followers",
         "following_url" : "https://api.github.com/users/ajweiss/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajweiss/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajweiss",
         "id" : 430315,
         "login" : "ajweiss",
         "organizations_url" : "https://api.github.com/users/ajweiss/orgs",
         "received_events_url" : "https://api.github.com/users/ajweiss/received_events",
         "repos_url" : "https://api.github.com/users/ajweiss/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajweiss/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajweiss/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajweiss"
      }
   },
   {
      "body" : "utACK. code is the same after squash.\r\n\r\nnicely found @ajweiss ",
      "created_at" : "2014-12-23T08:33:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5507#issuecomment-67930806",
      "id" : 67930806,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5507",
      "updated_at" : "2014-12-23T08:33:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/67930806",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7275704?v=3",
         "events_url" : "https://api.github.com/users/btcdrak/events{/privacy}",
         "followers_url" : "https://api.github.com/users/btcdrak/followers",
         "following_url" : "https://api.github.com/users/btcdrak/following{/other_user}",
         "gists_url" : "https://api.github.com/users/btcdrak/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/btcdrak",
         "id" : 7275704,
         "login" : "btcdrak",
         "organizations_url" : "https://api.github.com/users/btcdrak/orgs",
         "received_events_url" : "https://api.github.com/users/btcdrak/received_events",
         "repos_url" : "https://api.github.com/users/btcdrak/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/btcdrak/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/btcdrak/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/btcdrak"
      }
   },
   {
      "body" : "ACK.",
      "created_at" : "2014-12-23T10:28:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5507#issuecomment-67938378",
      "id" : 67938378,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5507",
      "updated_at" : "2014-12-23T10:28:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/67938378",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   }
]
