[
   {
      "body" : "Where are the tests that would have caught this in the first place?\r\nHave those tests been updated?\r\n",
      "created_at" : "2014-08-27T15:43:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4770#issuecomment-53592775",
      "id" : 53592775,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4770",
      "updated_at" : "2014-08-27T15:43:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/53592775",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "body" : "Any reason to allow >1? Seems like a good opportunity to discourage address reuse abuses.",
      "created_at" : "2014-08-27T15:45:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4770#issuecomment-53593140",
      "id" : 53593140,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4770",
      "updated_at" : "2014-08-27T15:45:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/53593140",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "body" : "Jeff, once again you are asking questions that were already answered *in the description of the original patch*. Please do read that document, but I'll repeat the relevant section here:\r\n\r\n*Testing*\r\n\r\nI attempted to write unit tests for this, but Core has no infrastructure for building test chains .... the miner_tests.cpp code does it but at the cost of not allowing any other unit test to do so, as it doesn't reset or clean up the global state afterwards! I tried to fix this and ended up down a giant rabbit hole.\r\n\r\nSo instead I've tested it with a local test app I wrote, which also exercises the client side part in bitcoinj.\r\n\r\n\r\nThe good news is, Sergio is making a start on fixing this, so in future we'll be able to write unit tests that build test chains. The bad news is we still lack test infrastructure for testing the network stack - there are zero tests that cover ProcessMessages and as a result it's difficult to write them. If you'd like to help fill that need that'd be fantastic.\r\n\r\nAdditionally, what dhill reported does not trigger a crash or any other kind of bug that could be easily found using unit testing. It doesn't even seem to trigger a lot of network usage, I guess the data does get truncated somewhere inside the network stack. I repeated his test against my own bitcoind and it survived just fine. What it does is cause a spike in memory usage, so dhill ran such queries many times in parallel until his host ran out of memory. \r\n\r\nBut Bitcoin Core does not have a fixed memory budget or any kind of limit - it's just \"whatever the host happens to have at the time\". I'm not even sure if there's any way to write a unit test that checks memory usage. If there was one, it'd lead to the question of what kind of memory usage limit would we select?\r\n\r\nSo testing this is not as trivial as it looks. It comes back to the entire anti-DoS question we've been debating for years. A full resource management infrastructure and ability to set resource budgets would be great, and it'd allow us to define this as a bug and test for it.",
      "created_at" : "2014-08-27T15:56:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4770#issuecomment-53595846",
      "id" : 53595846,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4770",
      "updated_at" : "2014-08-27T15:56:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/53595846",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/971089?v=3",
         "events_url" : "https://api.github.com/users/mikehearn/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mikehearn/followers",
         "following_url" : "https://api.github.com/users/mikehearn/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mikehearn/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mikehearn",
         "id" : 971089,
         "login" : "mikehearn",
         "organizations_url" : "https://api.github.com/users/mikehearn/orgs",
         "received_events_url" : "https://api.github.com/users/mikehearn/received_events",
         "repos_url" : "https://api.github.com/users/mikehearn/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mikehearn/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mikehearn/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mikehearn"
      }
   },
   {
      "body" : "Automatic sanity-testing: PASSED, see http://jenkins.bluematt.me/pull-tester/p4770_dfb40dd0cdb8f3e65a3422c55353550c45130930/ for binaries and test log.\nThis test script verifies pulls every time they are updated. It, however, dies sometimes and fails to test properly.  If you are waiting on a test, please check timestamps to verify that the test.log is moving at http://jenkins.bluematt.me/pull-tester/current/\nContact BlueMatt on freenode if something looks broken.",
      "created_at" : "2014-08-27T15:56:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4770#issuecomment-53595939",
      "id" : 53595939,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4770",
      "updated_at" : "2014-08-27T15:56:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/53595939",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2110907?v=3",
         "events_url" : "https://api.github.com/users/BitcoinPullTester/events{/privacy}",
         "followers_url" : "https://api.github.com/users/BitcoinPullTester/followers",
         "following_url" : "https://api.github.com/users/BitcoinPullTester/following{/other_user}",
         "gists_url" : "https://api.github.com/users/BitcoinPullTester/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/BitcoinPullTester",
         "id" : 2110907,
         "login" : "BitcoinPullTester",
         "organizations_url" : "https://api.github.com/users/BitcoinPullTester/orgs",
         "received_events_url" : "https://api.github.com/users/BitcoinPullTester/received_events",
         "repos_url" : "https://api.github.com/users/BitcoinPullTester/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/BitcoinPullTester/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/BitcoinPullTester/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/BitcoinPullTester"
      }
   },
   {
      "body" : "That's a dodge.  Key phrase \"that would have caught this\"\r\n\r\nIt is clearly possible to test that a P2P message does not return oversized output.\r\n",
      "created_at" : "2014-08-27T15:58:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4770#issuecomment-53596231",
      "id" : 53596231,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4770",
      "updated_at" : "2014-08-27T15:58:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/53596231",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "body" : "Well, like I said, at the moment I'm not sure how to write a test for it and there are no examples to guide me. I tried to test ProcessGetUTXOs independently (that's why it's a separate function) but until Sergio's work lands there's no way to build test chains, so I didn't succeed.\r\n\r\nOnce there's the right infrastructure for writing this kind of unit test then I'd be happy to do so. I did write functionality tests in the pull tester.",
      "created_at" : "2014-08-27T16:05:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4770#issuecomment-53597258",
      "id" : 53597258,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4770",
      "updated_at" : "2014-08-27T16:05:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/53597258",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/971089?v=3",
         "events_url" : "https://api.github.com/users/mikehearn/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mikehearn/followers",
         "following_url" : "https://api.github.com/users/mikehearn/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mikehearn/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mikehearn",
         "id" : 971089,
         "login" : "mikehearn",
         "organizations_url" : "https://api.github.com/users/mikehearn/orgs",
         "received_events_url" : "https://api.github.com/users/mikehearn/received_events",
         "repos_url" : "https://api.github.com/users/mikehearn/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mikehearn/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mikehearn/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mikehearn"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4770#discussion_r16785637"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4770"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/16785637"
         }
      },
      "body" : "You can use:\r\n```\r\nbytes_used += ::GetSerializeSize(coin, SER_NETWORK, PROTOCOL_VERSION);\r\n```\r\ninstead of defining a custom size computer.",
      "commit_id" : "dfb40dd0cdb8f3e65a3422c55353550c45130930",
      "created_at" : "2014-08-27T16:10:30Z",
      "diff_hunk" : "@@ -3577,6 +3585,9 @@ bool ProcessGetUTXOs(const vector<COutPoint> &vOutPoints, bool fCheckMemPool, ve\n                     coin.nHeight = coins.nHeight;\n                     coin.out = coins.vout.at(vOutPoints[i].n);\n                     assert(!coin.out.IsNull());\n+                    bytes_used += coin.GetSizeOf();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4770#discussion_r16785637",
      "id" : 16785637,
      "original_commit_id" : "dfb40dd0cdb8f3e65a3422c55353550c45130930",
      "original_position" : 33,
      "path" : "src/main.cpp",
      "position" : 33,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4770",
      "updated_at" : "2014-08-27T16:10:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/16785637",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4770#discussion_r16785793"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4770"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/16785793"
         }
      },
      "body" : "So decreasing the send buffer size will increase the chance that we start disconnecting peers?",
      "commit_id" : "dfb40dd0cdb8f3e65a3422c55353550c45130930",
      "created_at" : "2014-08-27T16:11:17Z",
      "diff_hunk" : "@@ -3555,6 +3560,9 @@ bool ProcessGetUTXOs(const vector<COutPoint> &vOutPoints, bool fCheckMemPool, ve\n \n     LogPrint(\"net\", \"getutxos for %d queries %s mempool\\n\", vOutPoints.size(), fCheckMemPool ? \"with\" : \"without\");\n \n+    // Due to the above check max space the bitmap can use is 50,000 / 8 == 6250 bytes.\n+    size_t bytes_used = vOutPoints.size() / 8;\n+    size_t max_bytes = SendBufferSize();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4770#discussion_r16785793",
      "id" : 16785793,
      "original_commit_id" : "dfb40dd0cdb8f3e65a3422c55353550c45130930",
      "original_position" : 25,
      "path" : "src/main.cpp",
      "position" : 25,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4770",
      "updated_at" : "2014-08-27T16:11:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/16785793",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Seems like yet another reason to revert #4351 pending proper investigation and Sergio's patch to enable tests to be written. There is clearly zero urgency for this and it needs more time and consideration to find the right solution (or even decide if it should be a feature of p2p at all). There is no reason you can't write this for bitcoinj afterall...",
      "created_at" : "2014-08-27T16:11:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4770#issuecomment-53598218",
      "id" : 53598218,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4770",
      "updated_at" : "2014-08-27T16:11:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/53598218",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7275704?v=3",
         "events_url" : "https://api.github.com/users/btcdrak/events{/privacy}",
         "followers_url" : "https://api.github.com/users/btcdrak/followers",
         "following_url" : "https://api.github.com/users/btcdrak/following{/other_user}",
         "gists_url" : "https://api.github.com/users/btcdrak/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/btcdrak",
         "id" : 7275704,
         "login" : "btcdrak",
         "organizations_url" : "https://api.github.com/users/btcdrak/orgs",
         "received_events_url" : "https://api.github.com/users/btcdrak/received_events",
         "repos_url" : "https://api.github.com/users/btcdrak/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/btcdrak/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/btcdrak/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/btcdrak"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/4770#discussion_r16786121"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4770"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/16786121"
         }
      },
      "body" : "How so? Like I said, requesting 50,000 outputs of a normal output would not even trigger problems. Requesting 50,000 outputs of the biggest output on the testnet doesn't even kill my node, it just bloats up and then shrinks a few seconds later. dhill had to run many times in parallel to get the effect of him running out of RAM.\r\n\r\nSo I don't see why shrinking the send buffer would cause problems for any normal app, not even if we halved it.",
      "commit_id" : "dfb40dd0cdb8f3e65a3422c55353550c45130930",
      "created_at" : "2014-08-27T16:16:49Z",
      "diff_hunk" : "@@ -3555,6 +3560,9 @@ bool ProcessGetUTXOs(const vector<COutPoint> &vOutPoints, bool fCheckMemPool, ve\n \n     LogPrint(\"net\", \"getutxos for %d queries %s mempool\\n\", vOutPoints.size(), fCheckMemPool ? \"with\" : \"without\");\n \n+    // Due to the above check max space the bitmap can use is 50,000 / 8 == 6250 bytes.\n+    size_t bytes_used = vOutPoints.size() / 8;\n+    size_t max_bytes = SendBufferSize();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4770#discussion_r16786121",
      "id" : 16786121,
      "original_commit_id" : "dfb40dd0cdb8f3e65a3422c55353550c45130930",
      "original_position" : 25,
      "path" : "src/main.cpp",
      "position" : 25,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/4770",
      "updated_at" : "2014-08-27T16:16:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/16786121",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/971089?v=3",
         "events_url" : "https://api.github.com/users/mikehearn/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mikehearn/followers",
         "following_url" : "https://api.github.com/users/mikehearn/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mikehearn/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mikehearn",
         "id" : 971089,
         "login" : "mikehearn",
         "organizations_url" : "https://api.github.com/users/mikehearn/orgs",
         "received_events_url" : "https://api.github.com/users/mikehearn/received_events",
         "repos_url" : "https://api.github.com/users/mikehearn/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mikehearn/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mikehearn/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mikehearn"
      }
   },
   {
      "body" : "Closing due to #4351 revert.  Presumably this gets rolled into the main getutxos implementation.\r\n",
      "created_at" : "2014-09-14T14:50:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4770#issuecomment-55527937",
      "id" : 55527937,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4770",
      "updated_at" : "2014-09-14T14:50:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/55527937",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   }
]
