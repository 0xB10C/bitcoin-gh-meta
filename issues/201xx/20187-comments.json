[
   {
      "author_association" : "MEMBER",
      "body" : "I'm still trying to verify that the bug being fixed relating to test-before-evict is in fact a bug (and I'm not just misunderstanding the logic); but if my understanding is correct I think we should fix all these issues in the next release.",
      "created_at" : "2020-10-19T18:40:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20187#issuecomment-712367742",
      "id" : 712367742,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20187",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcxMjM2Nzc0Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-19T18:40:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/712367742",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #20233 (addrman: Make consistency checks a runtime option by jnewbery)\n* #20228 (addrman: Make addrman a top-level component by jnewbery)\n* #19843 (Refactoring and minor improvement for self-advertisements by naumenkogs)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-10-19T19:21:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20187#issuecomment-712389721",
      "id" : 712389721,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20187",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcxMjM4OTcyMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-25T17:55:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/712389721",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.\r\n\r\nThe former issues are worth addressing.\r\nSeems like the latter bug is real, even though the chance of hitting it is rather low.",
      "created_at" : "2020-10-20T06:31:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20187#issuecomment-712626312",
      "id" : 712626312,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20187",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcxMjYyNjMxMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-20T06:31:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/712626312",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I was able to verify the test-before-evict bug by modifying the tried table to be very small, making collisions with existing peers likely.  The patch here appears to fix it as well.",
      "created_at" : "2020-10-25T15:20:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20187#issuecomment-716164872",
      "id" : 716164872,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20187",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcxNjE2NDg3Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-25T15:20:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/716164872",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r511795306"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/511795306"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This further splits the logic about whether to call `Connected()` for a node. Now there are three three places that you need to look:\r\n\r\n- Is the peer an outbound (https://github.com/bitcoin/bitcoin/blob/dafde15cc04fbeb5851fa98fec34dd9f2a7e8420/src/net_processing.cpp#L2475-L2478)\r\n- Does the peer have any misbehavior points (https://github.com/bitcoin/bitcoin/blob/dafde15cc04fbeb5851fa98fec34dd9f2a7e8420/src/net_processing.cpp#L849-L851)\r\n- Is the peer a block only connection (here)\r\n\r\nI'd rather place this new logic in one of the existing places and eventually consolidate them, rather than add another place for people to look.",
      "commit_id" : "430c8b6c0f9381f039d83066aa2cbd70c1d1414b",
      "created_at" : "2020-10-26T08:44:13Z",
      "diff_hunk" : "@@ -2571,7 +2587,8 @@ void CConnman::DeleteNode(CNode* pnode)\n     assert(pnode);\n     bool fUpdateConnectionTime = false;\n     m_msgproc->FinalizeNode(pnode->GetId(), fUpdateConnectionTime);\n-    if (fUpdateConnectionTime) {\n+    if (fUpdateConnectionTime && !pnode->IsBlockOnlyConn()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r511795306",
      "id" : 511795306,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc5NTMwNg==",
      "original_commit_id" : "dafde15cc04fbeb5851fa98fec34dd9f2a7e8420",
      "original_line" : 2590,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 516562733,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-26T19:55:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/511795306",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r511799043"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/511799043"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is there any reason to net send a `getaddr` message to block relay only peers? See the comment above \"If we're starting up for the first time, our addrman may be pretty empty...\". Since #17428, the first peers we connect to on startup will be anchor connections, which are block relay only peers. I can't see any downside to asking them for addrs.",
      "commit_id" : "430c8b6c0f9381f039d83066aa2cbd70c1d1414b",
      "created_at" : "2020-10-26T08:50:45Z",
      "diff_hunk" : "@@ -2421,9 +2415,22 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             // Get recent addresses\n             m_connman.PushMessage(&pfrom, CNetMsgMaker(greatest_common_version).Make(NetMsgType::GETADDR));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r511799043",
      "id" : 511799043,
      "line" : 2428,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc5OTA0Mw==",
      "original_commit_id" : "dafde15cc04fbeb5851fa98fec34dd9f2a7e8420",
      "original_line" : 2427,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 39,
      "pull_request_review_id" : 516562733,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-26T19:55:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/511799043",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r511800034"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/511800034"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Make this a doxygen format comment (starting with `/**`, so that doxygen docs can be generated from it: https://doxygen.bitcoincore.org/)",
      "commit_id" : "430c8b6c0f9381f039d83066aa2cbd70c1d1414b",
      "created_at" : "2020-10-26T08:52:27Z",
      "diff_hunk" : "@@ -445,6 +445,10 @@ class CConnman\n     CNode* FindNode(const std::string& addrName);\n     CNode* FindNode(const CService& addr);\n \n+    // Determine whether we're already connected to a given peer, in order to",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r511800034",
      "id" : 511800034,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTgwMDAzNA==",
      "original_commit_id" : "dafde15cc04fbeb5851fa98fec34dd9f2a7e8420",
      "original_line" : 448,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 516562733,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-26T19:55:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/511800034",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r511842475"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/511842475"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This logic is already very convoluted, and I think this change makes it even more difficult to follow. The mainline case (connecting to a new outbound beer), currently calls `SelectedTriedCollision()`, then sets `test_before_evict` to false, and then throws away the return value from `SelectedTriedCollision()` in the `if (!test_before_evict)` block below.\r\n\r\nThe logic for feeler connections and non-feeler connections has diverged to the point where it'd make this code a lot easier to follow if it were refactored to a GetFeelerConnectionAddress() and GetOutboundConnectionAddress() function. For now, I think the following is easier to read:\r\n\r\n```\r\n            if (fFeeler) {\r\n                // First, try to get a tried table collision address. This returns\r\n                // an empty (invalid) address if there are no collisions to try.\r\n                addr = addrman.SelectTriedCollision();\r\n\r\n                if (!addr.IsValid()) {\r\n                    // No tried table collisions. Select a new table address\r\n                    // for our feeler.\r\n                    addr = addrman.Select(true);\r\n                } else if (AlreadyConnectedToPeer(addr)) {\r\n                    // If test-before-evict logic would have us connect to a\r\n                    // peer that we're already connected to, just mark that\r\n                    // address as Good(). We won't be able to initiate the\r\n                    // connection anyway, so this avoids inadvertently evicting\r\n                    // a currently-connected peer.\r\n                    addrman.Good(addr);\r\n                    addr = addrman.Select(true);\r\n                }\r\n            } else {\r\n                // Not a feeler\r\n                addr = addrman.Select();\r\n            }\r\n```\r\n\r\n",
      "commit_id" : "430c8b6c0f9381f039d83066aa2cbd70c1d1414b",
      "created_at" : "2020-10-26T10:02:25Z",
      "diff_hunk" : "@@ -1967,7 +1972,18 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\n             CAddrInfo addr = addrman.SelectTriedCollision();\n \n             // SelectTriedCollision returns an invalid address if it is empty.\n-            if (!fFeeler || !addr.IsValid()) {\n+            bool test_before_evict = fFeeler && addr.IsValid();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r511842475",
      "id" : 511842475,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg0MjQ3NQ==",
      "original_commit_id" : "dafde15cc04fbeb5851fa98fec34dd9f2a7e8420",
      "original_line" : 1975,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 516562733,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-26T19:55:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/511842475",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r511842695"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/511842695"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No need to call this CConnman forwarding function. Just call `addrman.Good()` directly.",
      "commit_id" : "430c8b6c0f9381f039d83066aa2cbd70c1d1414b",
      "created_at" : "2020-10-26T10:02:49Z",
      "diff_hunk" : "@@ -1967,7 +1972,18 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\n             CAddrInfo addr = addrman.SelectTriedCollision();\n \n             // SelectTriedCollision returns an invalid address if it is empty.\n-            if (!fFeeler || !addr.IsValid()) {\n+            bool test_before_evict = fFeeler && addr.IsValid();\n+\n+            // If test-before-evict logic would have us connect to a peer that\n+            // we're already connected to, just mark that address as Good(). We\n+            // won't be able to initiate the connection anyway, so this avoids\n+            // inadvertently evicting a currently-connected peer.\n+            if (test_before_evict && AlreadyConnectedToPeer(addr)) {\n+                MarkAddressGood(addr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r511842695",
      "id" : 511842695,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg0MjY5NQ==",
      "original_commit_id" : "dafde15cc04fbeb5851fa98fec34dd9f2a7e8420",
      "original_line" : 1982,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 516562733,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-26T19:55:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/511842695",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r511843620"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/511843620"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Remove the word 'also'. Comments have a habit of migrating around in the codebase, and joining words like also lose their meaning if additional code/comments are added around the existing comments.",
      "commit_id" : "430c8b6c0f9381f039d83066aa2cbd70c1d1414b",
      "created_at" : "2020-10-26T10:04:27Z",
      "diff_hunk" : "@@ -2421,9 +2415,22 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             // Get recent addresses\n             m_connman.PushMessage(&pfrom, CNetMsgMaker(greatest_common_version).Make(NetMsgType::GETADDR));\n             pfrom.fGetAddr = true;\n+        }\n \n-            // Moves address from New to Tried table in Addrman, resolves\n-            // tried-table collisions, etc.\n+        if (!pfrom.IsInboundConn()) {\n+            // For non-inbound connections, we also update the addrman to",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r511843620",
      "id" : 511843620,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg0MzYyMA==",
      "original_commit_id" : "dafde15cc04fbeb5851fa98fec34dd9f2a7e8420",
      "original_line" : 2421,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 516562733,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-26T19:55:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/511843620",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r511845721"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/511845721"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Note that this is inefficient (lock cs_vNodes, iterate through nodes, unlock, lock, iterate, unlock), but that was a problem with the existing code. It could be made more efficient by converting this to a `ForEachNode()` call with a lambda returning if the address matches the `CNetAddr` or string.",
      "commit_id" : "430c8b6c0f9381f039d83066aa2cbd70c1d1414b",
      "created_at" : "2020-10-26T10:07:51Z",
      "diff_hunk" : "@@ -348,6 +348,11 @@ CNode* CConnman::FindNode(const CService& addr)\n     return nullptr;\n }\n \n+bool CConnman::AlreadyConnectedToPeer(const CAddress& addr)\n+{\n+    return FindNode(static_cast<CNetAddr>(addr)) || FindNode(addr.ToStringIPPort());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r511845721",
      "id" : 511845721,
      "line" : 359,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg0NTcyMQ==",
      "original_commit_id" : "dafde15cc04fbeb5851fa98fec34dd9f2a7e8420",
      "original_line" : 359,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 6,
      "pull_request_review_id" : 516562733,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-26T19:55:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/511845721",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r511846688"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/511846688"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: `AlreadyConnectedToAddress()` would be a more accurate name.",
      "commit_id" : "430c8b6c0f9381f039d83066aa2cbd70c1d1414b",
      "created_at" : "2020-10-26T10:09:31Z",
      "diff_hunk" : "@@ -348,6 +348,11 @@ CNode* CConnman::FindNode(const CService& addr)\n     return nullptr;\n }\n \n+bool CConnman::AlreadyConnectedToPeer(const CAddress& addr)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r511846688",
      "id" : 511846688,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg0NjY4OA==",
      "original_commit_id" : "dafde15cc04fbeb5851fa98fec34dd9f2a7e8420",
      "original_line" : 351,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 516562733,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-26T19:55:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/511846688",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r511847746"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/511847746"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It might be worth adding a comment about why we search both for the `CNetAddr` _and_ the ip/port string. It was added here: https://github.com/bitcoin/bitcoin/commit/9bab521df895c149579b9e64931405c56b008afb#diff-00021eed586a482abdb09d6cdada1d90115abe988a91421851960e26658bed02R1416 in the PR to add support for SOCKS5.",
      "commit_id" : "430c8b6c0f9381f039d83066aa2cbd70c1d1414b",
      "created_at" : "2020-10-26T10:11:15Z",
      "diff_hunk" : "@@ -348,6 +348,11 @@ CNode* CConnman::FindNode(const CService& addr)\n     return nullptr;\n }\n \n+bool CConnman::AlreadyConnectedToPeer(const CAddress& addr)\n+{\n+    return FindNode(static_cast<CNetAddr>(addr)) || FindNode(addr.ToStringIPPort());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r511847746",
      "id" : 511847746,
      "line" : 359,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg0Nzc0Ng==",
      "original_commit_id" : "dafde15cc04fbeb5851fa98fec34dd9f2a7e8420",
      "original_line" : 359,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 6,
      "pull_request_review_id" : 516562733,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-26T19:55:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/511847746",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r511933800"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/511933800"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Well if you have anchor connections to connect to, you likely have a useful `peers.dat` as well (you must have been running before), so I don't think that reasoning applies.\r\n\r\nIf we process an `addr` message from a peer by adding entries to addrman, we then will leak that information in at least two ways I can think of -- feeler connections will be attempted to addresses we learn that are in the new table, and we sample from our addrman to respond to other peers who send us `getaddr` messages.  I don't know if there might be additional sources of information leak about what is in our addrman besides those, but those both seem like ways an attacker could at least probabilistically test whether two nodes on the network might be connected.",
      "commit_id" : "430c8b6c0f9381f039d83066aa2cbd70c1d1414b",
      "created_at" : "2020-10-26T12:49:12Z",
      "diff_hunk" : "@@ -2421,9 +2415,22 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             // Get recent addresses\n             m_connman.PushMessage(&pfrom, CNetMsgMaker(greatest_common_version).Make(NetMsgType::GETADDR));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r511933800",
      "id" : 511933800,
      "in_reply_to_id" : 511799043,
      "line" : 2428,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkzMzgwMA==",
      "original_commit_id" : "dafde15cc04fbeb5851fa98fec34dd9f2a7e8420",
      "original_line" : 2427,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 39,
      "pull_request_review_id" : 516741591,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-26T19:55:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/511933800",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r511934522"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/511934522"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Agreed, but I didn't want to rewrite this.",
      "commit_id" : "430c8b6c0f9381f039d83066aa2cbd70c1d1414b",
      "created_at" : "2020-10-26T12:50:21Z",
      "diff_hunk" : "@@ -348,6 +348,11 @@ CNode* CConnman::FindNode(const CService& addr)\n     return nullptr;\n }\n \n+bool CConnman::AlreadyConnectedToPeer(const CAddress& addr)\n+{\n+    return FindNode(static_cast<CNetAddr>(addr)) || FindNode(addr.ToStringIPPort());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r511934522",
      "id" : 511934522,
      "in_reply_to_id" : 511845721,
      "line" : 359,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkzNDUyMg==",
      "original_commit_id" : "dafde15cc04fbeb5851fa98fec34dd9f2a7e8420",
      "original_line" : 359,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 6,
      "pull_request_review_id" : 516742480,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-26T19:55:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/511934522",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r511935957"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/511935957"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Agreed that this is confusing.  Originally I was contemplating have code in `net.cpp` that wouldn't call `CAddrMan::Attempt()` on block-relay-only peers, and so having this logic also be in `net.cpp` made more sense to me; but now I think it's fine to move into `net_processing`/`FinalizeNode()`.",
      "commit_id" : "430c8b6c0f9381f039d83066aa2cbd70c1d1414b",
      "created_at" : "2020-10-26T12:52:49Z",
      "diff_hunk" : "@@ -2571,7 +2587,8 @@ void CConnman::DeleteNode(CNode* pnode)\n     assert(pnode);\n     bool fUpdateConnectionTime = false;\n     m_msgproc->FinalizeNode(pnode->GetId(), fUpdateConnectionTime);\n-    if (fUpdateConnectionTime) {\n+    if (fUpdateConnectionTime && !pnode->IsBlockOnlyConn()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r511935957",
      "id" : 511935957,
      "in_reply_to_id" : 511795306,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkzNTk1Nw==",
      "original_commit_id" : "dafde15cc04fbeb5851fa98fec34dd9f2a7e8420",
      "original_line" : 2590,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 516744353,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-26T19:55:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/511935957",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r511998003"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/511998003"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah, I see that we ignore all `addr` messages from block-relay-only peers anyway, in the addr message processing (https://github.com/bitcoin/bitcoin/blob/d67883d01e507dd22d1281f4a4860e79d6a46a47/src/net_processing.cpp#L2549), so this seems fine.",
      "commit_id" : "430c8b6c0f9381f039d83066aa2cbd70c1d1414b",
      "created_at" : "2020-10-26T14:23:01Z",
      "diff_hunk" : "@@ -2421,9 +2415,22 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             // Get recent addresses\n             m_connman.PushMessage(&pfrom, CNetMsgMaker(greatest_common_version).Make(NetMsgType::GETADDR));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r511998003",
      "id" : 511998003,
      "in_reply_to_id" : 511799043,
      "line" : 2428,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk5ODAwMw==",
      "original_commit_id" : "dafde15cc04fbeb5851fa98fec34dd9f2a7e8420",
      "original_line" : 2427,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 39,
      "pull_request_review_id" : 516827655,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-26T19:55:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/511998003",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r512004982"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/512004982"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'd suggest going further and removing `fCurrentlyConnected`, and then changing `FinalizeNode()` to check whether the peer is:\r\n- `fSuccessfullyConnected`\r\n- not inbound and not block relay only\r\n- has 0 misbehavior score\r\nand then directly call `CAddrMan.Connected()` directly, so that all the logic around calling `Connected()` is in one place.\r\n\r\nIf you agree, perhaps you could take a look at 1755f08b4dba34b483a401c6098d5df549219ce7 in PR #20228, which does some of that. For this PR, just putting the block relay only check inside `FinalizeNode()` at least doesn't make the situation any worse.",
      "commit_id" : "430c8b6c0f9381f039d83066aa2cbd70c1d1414b",
      "created_at" : "2020-10-26T14:31:39Z",
      "diff_hunk" : "@@ -2571,7 +2587,8 @@ void CConnman::DeleteNode(CNode* pnode)\n     assert(pnode);\n     bool fUpdateConnectionTime = false;\n     m_msgproc->FinalizeNode(pnode->GetId(), fUpdateConnectionTime);\n-    if (fUpdateConnectionTime) {\n+    if (fUpdateConnectionTime && !pnode->IsBlockOnlyConn()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r512004982",
      "id" : 512004982,
      "in_reply_to_id" : 511795306,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjAwNDk4Mg==",
      "original_commit_id" : "dafde15cc04fbeb5851fa98fec34dd9f2a7e8420",
      "original_line" : 2590,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 516837035,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-26T19:55:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/512004982",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r512106253"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/512106253"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think it'd be cleaner to pass in a `const CNode&` and get the id and block relay only state from the CNode.",
      "commit_id" : "430c8b6c0f9381f039d83066aa2cbd70c1d1414b",
      "created_at" : "2020-10-26T16:42:38Z",
      "diff_hunk" : "@@ -829,7 +829,7 @@ void PeerManager::ReattemptInitialBroadcast(CScheduler& scheduler) const\n     scheduler.scheduleFromNow([&] { ReattemptInitialBroadcast(scheduler); }, delta);\n }\n \n-void PeerManager::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTime) {\n+void PeerManager::FinalizeNode(NodeId nodeid, const bool is_block_relay_only_peer, bool& fUpdateConnectionTime) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r512106253",
      "id" : 512106253,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjEwNjI1Mw==",
      "original_commit_id" : "266d22a3d18c89a3b74d81bcdcc9750a9f8a056f",
      "original_line" : 840,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 516970642,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-26T19:55:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/512106253",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r512106972"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/512106972"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is now in FinalizeNode, not net.cpp :)",
      "commit_id" : "430c8b6c0f9381f039d83066aa2cbd70c1d1414b",
      "created_at" : "2020-10-26T16:43:46Z",
      "diff_hunk" : "@@ -2421,9 +2416,22 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             // Get recent addresses\n             m_connman.PushMessage(&pfrom, CNetMsgMaker(greatest_common_version).Make(NetMsgType::GETADDR));\n             pfrom.fGetAddr = true;\n+        }\n \n-            // Moves address from New to Tried table in Addrman, resolves\n-            // tried-table collisions, etc.\n+        if (!pfrom.IsInboundConn()) {\n+            // For non-inbound connections, we update the addrman to record\n+            // connection success so that addrman will have an up-to-date\n+            // notion of which peers are online and available.\n+            //\n+            // While we strive to not leak information about block-relay-only\n+            // connections via the addrman, not moving an address to the tried\n+            // table is also potentially detrimental because new-table entries\n+            // are subject to eviction in the event of addrman collisions.  We\n+            // mitigate the information-leak by never calling\n+            // CAddrMan::Connected() on block-relay-only peers; see net.cpp",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r512106972",
      "id" : 512106972,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjEwNjk3Mg==",
      "original_commit_id" : "266d22a3d18c89a3b74d81bcdcc9750a9f8a056f",
      "original_line" : 2441,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 516970642,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-26T19:55:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/512106972",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r512116986"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/512116986"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "430c8b6c0f9381f039d83066aa2cbd70c1d1414b",
      "created_at" : "2020-10-26T16:53:33Z",
      "diff_hunk" : "@@ -445,6 +445,10 @@ class CConnman\n     CNode* FindNode(const std::string& addrName);\n     CNode* FindNode(const CService& addr);\n \n+    // Determine whether we're already connected to a given peer, in order to",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r512116986",
      "id" : 512116986,
      "in_reply_to_id" : 511800034,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjExNjk4Ng==",
      "original_commit_id" : "dafde15cc04fbeb5851fa98fec34dd9f2a7e8420",
      "original_line" : 448,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 516983409,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-26T19:55:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/512116986",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r512118406"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/512118406"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I just did the simple thing of moving this to `FinalizeNode()`.  Because there's no good way to get a `CNode` from a `NodeId` while it's in the process of being deleted (as far as I can tell!), I had to change the interface to accommodate this move.",
      "commit_id" : "430c8b6c0f9381f039d83066aa2cbd70c1d1414b",
      "created_at" : "2020-10-26T16:54:49Z",
      "diff_hunk" : "@@ -2571,7 +2587,8 @@ void CConnman::DeleteNode(CNode* pnode)\n     assert(pnode);\n     bool fUpdateConnectionTime = false;\n     m_msgproc->FinalizeNode(pnode->GetId(), fUpdateConnectionTime);\n-    if (fUpdateConnectionTime) {\n+    if (fUpdateConnectionTime && !pnode->IsBlockOnlyConn()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r512118406",
      "id" : 512118406,
      "in_reply_to_id" : 511795306,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjExODQwNg==",
      "original_commit_id" : "dafde15cc04fbeb5851fa98fec34dd9f2a7e8420",
      "original_line" : 2590,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 516984643,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-26T19:55:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/512118406",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r512118798"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/512118798"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm indifferent, so taking your patch.",
      "commit_id" : "430c8b6c0f9381f039d83066aa2cbd70c1d1414b",
      "created_at" : "2020-10-26T16:55:12Z",
      "diff_hunk" : "@@ -1967,7 +1972,18 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\n             CAddrInfo addr = addrman.SelectTriedCollision();\n \n             // SelectTriedCollision returns an invalid address if it is empty.\n-            if (!fFeeler || !addr.IsValid()) {\n+            bool test_before_evict = fFeeler && addr.IsValid();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r512118798",
      "id" : 512118798,
      "in_reply_to_id" : 511842475,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjExODc5OA==",
      "original_commit_id" : "dafde15cc04fbeb5851fa98fec34dd9f2a7e8420",
      "original_line" : 1975,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 516985051,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-26T19:55:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/512118798",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r512118929"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/512118929"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I took this change as part of your patch for rewriting the loop.",
      "commit_id" : "430c8b6c0f9381f039d83066aa2cbd70c1d1414b",
      "created_at" : "2020-10-26T16:55:22Z",
      "diff_hunk" : "@@ -1967,7 +1972,18 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\n             CAddrInfo addr = addrman.SelectTriedCollision();\n \n             // SelectTriedCollision returns an invalid address if it is empty.\n-            if (!fFeeler || !addr.IsValid()) {\n+            bool test_before_evict = fFeeler && addr.IsValid();\n+\n+            // If test-before-evict logic would have us connect to a peer that\n+            // we're already connected to, just mark that address as Good(). We\n+            // won't be able to initiate the connection anyway, so this avoids\n+            // inadvertently evicting a currently-connected peer.\n+            if (test_before_evict && AlreadyConnectedToPeer(addr)) {\n+                MarkAddressGood(addr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r512118929",
      "id" : 512118929,
      "in_reply_to_id" : 511842695,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjExODkyOQ==",
      "original_commit_id" : "dafde15cc04fbeb5851fa98fec34dd9f2a7e8420",
      "original_line" : 1982,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 516985213,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-26T19:55:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/512118929",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r512119008"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/512119008"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "430c8b6c0f9381f039d83066aa2cbd70c1d1414b",
      "created_at" : "2020-10-26T16:55:29Z",
      "diff_hunk" : "@@ -2421,9 +2415,22 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             // Get recent addresses\n             m_connman.PushMessage(&pfrom, CNetMsgMaker(greatest_common_version).Make(NetMsgType::GETADDR));\n             pfrom.fGetAddr = true;\n+        }\n \n-            // Moves address from New to Tried table in Addrman, resolves\n-            // tried-table collisions, etc.\n+        if (!pfrom.IsInboundConn()) {\n+            // For non-inbound connections, we also update the addrman to",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r512119008",
      "id" : 512119008,
      "in_reply_to_id" : 511843620,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjExOTAwOA==",
      "original_commit_id" : "dafde15cc04fbeb5851fa98fec34dd9f2a7e8420",
      "original_line" : 2421,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 516985318,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-26T19:55:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/512119008",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r512119091"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/512119091"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Agreed, done.",
      "commit_id" : "430c8b6c0f9381f039d83066aa2cbd70c1d1414b",
      "created_at" : "2020-10-26T16:55:37Z",
      "diff_hunk" : "@@ -348,6 +348,11 @@ CNode* CConnman::FindNode(const CService& addr)\n     return nullptr;\n }\n \n+bool CConnman::AlreadyConnectedToPeer(const CAddress& addr)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r512119091",
      "id" : 512119091,
      "in_reply_to_id" : 511846688,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjExOTA5MQ==",
      "original_commit_id" : "dafde15cc04fbeb5851fa98fec34dd9f2a7e8420",
      "original_line" : 351,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 516985428,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-26T19:55:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/512119091",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r512119159"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/512119159"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Care to suggest a comment?  I'm not sure my understanding of when we might be looking up by `CNetAddr` versus string is precise enough to say the right thing here.",
      "commit_id" : "430c8b6c0f9381f039d83066aa2cbd70c1d1414b",
      "created_at" : "2020-10-26T16:55:43Z",
      "diff_hunk" : "@@ -348,6 +348,11 @@ CNode* CConnman::FindNode(const CService& addr)\n     return nullptr;\n }\n \n+bool CConnman::AlreadyConnectedToPeer(const CAddress& addr)\n+{\n+    return FindNode(static_cast<CNetAddr>(addr)) || FindNode(addr.ToStringIPPort());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r512119159",
      "id" : 512119159,
      "in_reply_to_id" : 511847746,
      "line" : 359,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjExOTE1OQ==",
      "original_commit_id" : "dafde15cc04fbeb5851fa98fec34dd9f2a7e8420",
      "original_line" : 359,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 6,
      "pull_request_review_id" : 516985519,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-26T19:55:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/512119159",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r512130998"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/512130998"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I was hoping you might have a better understanding of this than me :grin: . My understanding of how hostnames/proxies work in Bitcoin Core is certainly too hazy to suggest any wording here.\r\n\r\nI'm going to mark this as resolved. It'd be good to document why we're doing this, but this PR isn't changing the behavior, so it's certainly not a blocker.",
      "commit_id" : "430c8b6c0f9381f039d83066aa2cbd70c1d1414b",
      "created_at" : "2020-10-26T17:12:59Z",
      "diff_hunk" : "@@ -348,6 +348,11 @@ CNode* CConnman::FindNode(const CService& addr)\n     return nullptr;\n }\n \n+bool CConnman::AlreadyConnectedToPeer(const CAddress& addr)\n+{\n+    return FindNode(static_cast<CNetAddr>(addr)) || FindNode(addr.ToStringIPPort());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r512130998",
      "id" : 512130998,
      "in_reply_to_id" : 511847746,
      "line" : 359,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjEzMDk5OA==",
      "original_commit_id" : "dafde15cc04fbeb5851fa98fec34dd9f2a7e8420",
      "original_line" : 359,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 6,
      "pull_request_review_id" : 517001419,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-26T19:55:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/512130998",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r512131320"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/512131320"
         }
      },
      "author_association" : "MEMBER",
      "body" : "That's reasonable. It's not a change in behaviour. Marking resolved.",
      "commit_id" : "430c8b6c0f9381f039d83066aa2cbd70c1d1414b",
      "created_at" : "2020-10-26T17:13:31Z",
      "diff_hunk" : "@@ -348,6 +348,11 @@ CNode* CConnman::FindNode(const CService& addr)\n     return nullptr;\n }\n \n+bool CConnman::AlreadyConnectedToPeer(const CAddress& addr)\n+{\n+    return FindNode(static_cast<CNetAddr>(addr)) || FindNode(addr.ToStringIPPort());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r512131320",
      "id" : 512131320,
      "in_reply_to_id" : 511845721,
      "line" : 359,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjEzMTMyMA==",
      "original_commit_id" : "dafde15cc04fbeb5851fa98fec34dd9f2a7e8420",
      "original_line" : 359,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 6,
      "pull_request_review_id" : 517001871,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-26T19:55:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/512131320",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r512133129"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/512133129"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`DeleteNode()` is holding a reference to the `CNode`, so you should just be able to pass a const reference to that CNode down to `FinalizeNode()`. That'd be more symmetrical with the other `NetEventsInterface` interface functions (you could also pass a pointer like the other functions, but they should all be const references really)",
      "commit_id" : "430c8b6c0f9381f039d83066aa2cbd70c1d1414b",
      "created_at" : "2020-10-26T17:16:02Z",
      "diff_hunk" : "@@ -2571,7 +2587,8 @@ void CConnman::DeleteNode(CNode* pnode)\n     assert(pnode);\n     bool fUpdateConnectionTime = false;\n     m_msgproc->FinalizeNode(pnode->GetId(), fUpdateConnectionTime);\n-    if (fUpdateConnectionTime) {\n+    if (fUpdateConnectionTime && !pnode->IsBlockOnlyConn()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r512133129",
      "id" : 512133129,
      "in_reply_to_id" : 511795306,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjEzMzEyOQ==",
      "original_commit_id" : "dafde15cc04fbeb5851fa98fec34dd9f2a7e8420",
      "original_line" : 2590,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 517004097,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-26T19:55:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/512133129",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> An alternative approach could be to just periodically refresh the info.nLastSuccess for all active connections. If I'm understanding the addrman code correctly, as long as we're refreshing that value every 4 hours, we'll never evict that peer.\r\n\r\n> Adding a StillGood() (with a better name) method to CAddrMan which simply updates nLastSuccess and calling it either globally or per-peer every three hours would avoid adding more logic to the already-too-complicated ThreadOpenConnections()\r\n\r\nI think the best thing would be if addrman just detected the collision with an existing peer immediately, and avoided the whole tried-collision logic itself.  If we had a good way to do that (by changing the interface between addrman and connman) then I think that could make sense. \r\n\r\nShort of addrman being smart enough to avoid this problem, having `net.cpp` detect this condition and fix it directly seems next simplest to me; relying on `Good()` or a `StillGood()` being called at the right times to avoid this problem as a consequence of how and when those variables get updated just seems unnecessarily complex...?  The next time someone wonders if it's possible for an existing peer to be evicted from the tried table, I think it'll be much easier to reason about my proposed change than the alternative you're suggesting.",
      "created_at" : "2020-10-26T18:05:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20187#issuecomment-716728387",
      "id" : 716728387,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20187",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcxNjcyODM4Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-26T18:05:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/716728387",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r512179647"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/512179647"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "430c8b6c0f9381f039d83066aa2cbd70c1d1414b",
      "created_at" : "2020-10-26T18:28:31Z",
      "diff_hunk" : "@@ -829,7 +829,7 @@ void PeerManager::ReattemptInitialBroadcast(CScheduler& scheduler) const\n     scheduler.scheduleFromNow([&] { ReattemptInitialBroadcast(scheduler); }, delta);\n }\n \n-void PeerManager::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTime) {\n+void PeerManager::FinalizeNode(NodeId nodeid, const bool is_block_relay_only_peer, bool& fUpdateConnectionTime) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r512179647",
      "id" : 512179647,
      "in_reply_to_id" : 512106253,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE3OTY0Nw==",
      "original_commit_id" : "266d22a3d18c89a3b74d81bcdcc9750a9f8a056f",
      "original_line" : 840,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 517063951,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-26T19:55:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/512179647",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r512179793"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/512179793"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oops, thanks for catching that. Fixed.",
      "commit_id" : "430c8b6c0f9381f039d83066aa2cbd70c1d1414b",
      "created_at" : "2020-10-26T18:28:44Z",
      "diff_hunk" : "@@ -2421,9 +2416,22 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             // Get recent addresses\n             m_connman.PushMessage(&pfrom, CNetMsgMaker(greatest_common_version).Make(NetMsgType::GETADDR));\n             pfrom.fGetAddr = true;\n+        }\n \n-            // Moves address from New to Tried table in Addrman, resolves\n-            // tried-table collisions, etc.\n+        if (!pfrom.IsInboundConn()) {\n+            // For non-inbound connections, we update the addrman to record\n+            // connection success so that addrman will have an up-to-date\n+            // notion of which peers are online and available.\n+            //\n+            // While we strive to not leak information about block-relay-only\n+            // connections via the addrman, not moving an address to the tried\n+            // table is also potentially detrimental because new-table entries\n+            // are subject to eviction in the event of addrman collisions.  We\n+            // mitigate the information-leak by never calling\n+            // CAddrMan::Connected() on block-relay-only peers; see net.cpp",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r512179793",
      "id" : 512179793,
      "in_reply_to_id" : 512106972,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE3OTc5Mw==",
      "original_commit_id" : "266d22a3d18c89a3b74d81bcdcc9750a9f8a056f",
      "original_line" : 2441,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 517064130,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-26T19:55:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/512179793",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r512192998"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/512192998"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Sorry I wasn't clear here, but you can also drop the `NodeId` argument from the function signature, and then call `GetId()` from within `FinalizeNode()`. Passing both CNode& and NodeId is somewhat redundant.",
      "commit_id" : "430c8b6c0f9381f039d83066aa2cbd70c1d1414b",
      "created_at" : "2020-10-26T18:50:11Z",
      "diff_hunk" : "@@ -829,7 +829,7 @@ void PeerManager::ReattemptInitialBroadcast(CScheduler& scheduler) const\n     scheduler.scheduleFromNow([&] { ReattemptInitialBroadcast(scheduler); }, delta);\n }\n \n-void PeerManager::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTime) {\n+void PeerManager::FinalizeNode(NodeId nodeid, const bool is_block_relay_only_peer, bool& fUpdateConnectionTime) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r512192998",
      "id" : 512192998,
      "in_reply_to_id" : 512106253,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjE5Mjk5OA==",
      "original_commit_id" : "266d22a3d18c89a3b74d81bcdcc9750a9f8a056f",
      "original_line" : 840,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 517080202,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-26T19:55:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/512192998",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> relying on Good() or a StillGood() being called at the right times to avoid this problem as a consequence of how and when those variables get updated just seems unnecessarily complex...? The next time someone wonders if it's possible for an existing peer to be evicted from the tried table, I think it'll be much easier to reason about my proposed change than the alternative you're suggesting.\r\n\r\nI disagree, but perhaps it's just a matter of taste. To me, making addrman always aware of existing connections and keeping `nLastSuccess` fresh by periodic notifications from net_processing or net seems much cleaner than only finding out at the point that we attempt to reconnect.",
      "created_at" : "2020-10-26T18:57:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20187#issuecomment-716756846",
      "id" : 716756846,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20187",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcxNjc1Njg0Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-26T18:57:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/716756846",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r512230086"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/512230086"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done in 430c8b6c0f9381f039d83066aa2cbd70c1d1414b.",
      "commit_id" : "430c8b6c0f9381f039d83066aa2cbd70c1d1414b",
      "created_at" : "2020-10-26T19:56:02Z",
      "diff_hunk" : "@@ -829,7 +829,7 @@ void PeerManager::ReattemptInitialBroadcast(CScheduler& scheduler) const\n     scheduler.scheduleFromNow([&] { ReattemptInitialBroadcast(scheduler); }, delta);\n }\n \n-void PeerManager::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTime) {\n+void PeerManager::FinalizeNode(NodeId nodeid, const bool is_block_relay_only_peer, bool& fUpdateConnectionTime) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20187#discussion_r512230086",
      "id" : 512230086,
      "in_reply_to_id" : 512106253,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjIzMDA4Ng==",
      "original_commit_id" : "266d22a3d18c89a3b74d81bcdcc9750a9f8a056f",
      "original_line" : 840,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 517127015,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20187",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-26T19:56:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/512230086",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I disagree, but perhaps it's just a matter of taste. To me, making addrman always aware of existing connections and keeping nLastSuccess fresh by periodic notifications from net_processing or net seems much cleaner than only finding out at the point that we attempt to reconnect.\r\n\r\nWe could add an interface to addrman so that it explicitly keeps track of currently connected peers, by notifying it when we successfully make new connections and again when a peer disconnects, and then use that to prevent tried collisions with current peers from ever making it into the tried-collision list for later resolution.",
      "created_at" : "2020-10-26T20:25:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20187#issuecomment-716802555",
      "id" : 716802555,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20187",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcxNjgwMjU1NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-26T20:27:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/716802555",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> We could add an interface to addrman so that it explicitly keeps track of currently connected peers, by notifying it when we successfully make new connections and again when a peer disconnects, and then use that to prevent tried collisions with current peers from ever making it into the tried-collision list for later resolution.\r\n\r\nYes, that seems like another reasonable approach.\r\n\r\nTo be clear, I'm not NACKing the approach in this PR. I wanted to offer an alternative suggestion, but what you're doing here seems fine, and this actually cleans up and clarifies some of the code.\r\n\r\nThanks for being so responsive to review. I plan to do another pass of the latest changes tomorrow.",
      "created_at" : "2020-10-26T22:36:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20187#issuecomment-716861647",
      "id" : 716861647,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20187",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcxNjg2MTY0Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-26T22:36:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/716861647",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   }
]
