[
   {
      "body" : "@pstratem  you might have some interest in reviewing this.",
      "created_at" : "2017-07-15T04:02:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10831#issuecomment-315507700",
      "id" : 315507700,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10831",
      "updated_at" : "2017-07-15T04:02:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315507700",
      "user" : {
         "avatar_url" : "https://avatars5.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "utACK ff9a291b30d7464c1ff0990b1cab36d6119b2ae5",
      "created_at" : "2017-07-15T18:06:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10831#issuecomment-315551806",
      "id" : 315551806,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10831",
      "updated_at" : "2017-07-15T18:06:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315551806",
      "user" : {
         "avatar_url" : "https://avatars5.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "tACK https://github.com/bitcoin/bitcoin/pull/10831/commits/ff9a291b30d7464c1ff0990b1cab36d6119b2ae5\r\n\r\nwith 1000 keypool size, topup went from 20 seconds to 1.6.",
      "created_at" : "2017-07-15T19:09:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10831#issuecomment-315555429",
      "id" : 315555429,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10831",
      "updated_at" : "2017-07-15T19:09:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315555429",
      "user" : {
         "avatar_url" : "https://avatars4.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "body" : "utACK ff9a291b30d7464c1ff0990b1cab36d6119b2ae5 (needs rebase, though). ",
      "created_at" : "2017-07-15T23:41:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10831#issuecomment-315570741",
      "id" : 315570741,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10831",
      "updated_at" : "2017-07-15T23:41:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315570741",
      "user" : {
         "avatar_url" : "https://avatars4.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "@TheBlueMatt  rebased, please re-review",
      "created_at" : "2017-07-16T00:18:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10831#issuecomment-315572295",
      "id" : 315572295,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10831",
      "updated_at" : "2017-07-16T00:18:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315572295",
      "user" : {
         "avatar_url" : "https://avatars5.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127619405"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127619405"
         }
      },
      "body" : "It seems strange that we're creating a db transaction, only to throw it out in a second. I think its safe, but it might be nicer to let AddKeyPubKeyWithDB create a CWalletDB if it needs one automagically (eg by passing the walletdb in as a pointer).",
      "commit_id" : "3986271c0accfe896c66a48d3ed884a7553b6413",
      "created_at" : "2017-07-16T23:05:48Z",
      "diff_hunk" : "@@ -162,33 +164,49 @@ void CWallet::DeriveNewChildKey(CKeyMetadata& metadata, CKey& secret, bool inter\n     secret = childKey.key;\n     metadata.hdMasterKeyID = hdChain.masterKeyID;\n     // update the chain model in the database\n-    if (!CWalletDB(*dbw).WriteHDChain(hdChain))\n+    if (!walletdb.WriteHDChain(hdChain))\n         throw std::runtime_error(std::string(__func__) + \": Writing HD chain model failed\");\n }\n \n-bool CWallet::AddKeyPubKey(const CKey& secret, const CPubKey &pubkey)\n+bool CWallet::AddKeyPubKeyWithDB(CWalletDB &walletdb, const CKey& secret, const CPubKey &pubkey)\n {\n     AssertLockHeld(cs_wallet); // mapKeyMetadata\n-    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey))\n+\n+    bool needsDB = !pwalletdbEncryption;\n+    if (needsDB) {\n+        pwalletdbEncryption = &walletdb;\n+    }\n+    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey)) {\n+        if (needsDB) pwalletdbEncryption = NULL;\n         return false;\n+    }\n+    if (needsDB) pwalletdbEncryption = NULL;\n \n     // check if we need to remove from watch-only\n     CScript script;\n     script = GetScriptForDestination(pubkey.GetID());\n-    if (HaveWatchOnly(script))\n+    if (HaveWatchOnly(script)) {\n         RemoveWatchOnly(script);\n+    }\n     script = GetScriptForRawPubKey(pubkey);\n-    if (HaveWatchOnly(script))\n+    if (HaveWatchOnly(script)) {\n         RemoveWatchOnly(script);\n+    }\n \n     if (!IsCrypted()) {\n-        return CWalletDB(*dbw).WriteKey(pubkey,\n+        return walletdb.WriteKey(pubkey,\n                                                  secret.GetPrivKey(),\n                                                  mapKeyMetadata[pubkey.GetID()]);\n     }\n     return true;\n }\n \n+bool CWallet::AddKeyPubKey(const CKey& secret, const CPubKey &pubkey)\n+{\n+    CWalletDB walletdb(*dbw);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127619405",
      "id" : 127619405,
      "original_commit_id" : "3986271c0accfe896c66a48d3ed884a7553b6413",
      "original_position" : 92,
      "path" : "src/wallet/wallet.cpp",
      "position" : 92,
      "pull_request_review_id" : 50222851,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831",
      "updated_at" : "2017-07-16T23:05:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127619405",
      "user" : {
         "avatar_url" : "https://avatars4.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127622400"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127622400"
         }
      },
      "body" : "Another approach is to use `dbw` as the storage of the transaction. For instance, `CWalletDBWrapper` could keep a `CBD` instance, referenced counted by `CWalletDB`. This could be thread safe too.",
      "commit_id" : "3986271c0accfe896c66a48d3ed884a7553b6413",
      "created_at" : "2017-07-17T01:03:21Z",
      "diff_hunk" : "@@ -162,33 +164,49 @@ void CWallet::DeriveNewChildKey(CKeyMetadata& metadata, CKey& secret, bool inter\n     secret = childKey.key;\n     metadata.hdMasterKeyID = hdChain.masterKeyID;\n     // update the chain model in the database\n-    if (!CWalletDB(*dbw).WriteHDChain(hdChain))\n+    if (!walletdb.WriteHDChain(hdChain))\n         throw std::runtime_error(std::string(__func__) + \": Writing HD chain model failed\");\n }\n \n-bool CWallet::AddKeyPubKey(const CKey& secret, const CPubKey &pubkey)\n+bool CWallet::AddKeyPubKeyWithDB(CWalletDB &walletdb, const CKey& secret, const CPubKey &pubkey)\n {\n     AssertLockHeld(cs_wallet); // mapKeyMetadata\n-    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey))\n+\n+    bool needsDB = !pwalletdbEncryption;\n+    if (needsDB) {\n+        pwalletdbEncryption = &walletdb;\n+    }\n+    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey)) {\n+        if (needsDB) pwalletdbEncryption = NULL;\n         return false;\n+    }\n+    if (needsDB) pwalletdbEncryption = NULL;\n \n     // check if we need to remove from watch-only\n     CScript script;\n     script = GetScriptForDestination(pubkey.GetID());\n-    if (HaveWatchOnly(script))\n+    if (HaveWatchOnly(script)) {\n         RemoveWatchOnly(script);\n+    }\n     script = GetScriptForRawPubKey(pubkey);\n-    if (HaveWatchOnly(script))\n+    if (HaveWatchOnly(script)) {\n         RemoveWatchOnly(script);\n+    }\n \n     if (!IsCrypted()) {\n-        return CWalletDB(*dbw).WriteKey(pubkey,\n+        return walletdb.WriteKey(pubkey,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127622400",
      "id" : 127622400,
      "original_commit_id" : "3986271c0accfe896c66a48d3ed884a7553b6413",
      "original_position" : 83,
      "path" : "src/wallet/wallet.cpp",
      "position" : 83,
      "pull_request_review_id" : 50225909,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831",
      "updated_at" : "2017-07-17T01:05:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127622400",
      "user" : {
         "avatar_url" : "https://avatars5.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127622496"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127622496"
         }
      },
      "body" : "I'm happy to write such alternative if there is interest.",
      "commit_id" : "3986271c0accfe896c66a48d3ed884a7553b6413",
      "created_at" : "2017-07-17T01:06:20Z",
      "diff_hunk" : "@@ -162,33 +164,49 @@ void CWallet::DeriveNewChildKey(CKeyMetadata& metadata, CKey& secret, bool inter\n     secret = childKey.key;\n     metadata.hdMasterKeyID = hdChain.masterKeyID;\n     // update the chain model in the database\n-    if (!CWalletDB(*dbw).WriteHDChain(hdChain))\n+    if (!walletdb.WriteHDChain(hdChain))\n         throw std::runtime_error(std::string(__func__) + \": Writing HD chain model failed\");\n }\n \n-bool CWallet::AddKeyPubKey(const CKey& secret, const CPubKey &pubkey)\n+bool CWallet::AddKeyPubKeyWithDB(CWalletDB &walletdb, const CKey& secret, const CPubKey &pubkey)\n {\n     AssertLockHeld(cs_wallet); // mapKeyMetadata\n-    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey))\n+\n+    bool needsDB = !pwalletdbEncryption;\n+    if (needsDB) {\n+        pwalletdbEncryption = &walletdb;\n+    }\n+    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey)) {\n+        if (needsDB) pwalletdbEncryption = NULL;\n         return false;\n+    }\n+    if (needsDB) pwalletdbEncryption = NULL;\n \n     // check if we need to remove from watch-only\n     CScript script;\n     script = GetScriptForDestination(pubkey.GetID());\n-    if (HaveWatchOnly(script))\n+    if (HaveWatchOnly(script)) {\n         RemoveWatchOnly(script);\n+    }\n     script = GetScriptForRawPubKey(pubkey);\n-    if (HaveWatchOnly(script))\n+    if (HaveWatchOnly(script)) {\n         RemoveWatchOnly(script);\n+    }\n \n     if (!IsCrypted()) {\n-        return CWalletDB(*dbw).WriteKey(pubkey,\n+        return walletdb.WriteKey(pubkey,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127622496",
      "id" : 127622496,
      "original_commit_id" : "3986271c0accfe896c66a48d3ed884a7553b6413",
      "original_position" : 83,
      "path" : "src/wallet/wallet.cpp",
      "position" : 83,
      "pull_request_review_id" : 50226004,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831",
      "updated_at" : "2017-07-17T01:06:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127622496",
      "user" : {
         "avatar_url" : "https://avatars5.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "body" : "@promag sadly I think it's a bit late for that for 15, it might be a decent change later, however.\n\nOn July 16, 2017 7:05:52 PM EDT, Matt Corallo <notifications@github.com> wrote:\n>TheBlueMatt commented on this pull request.\n>\n>\n>\n>>                                                  \n>secret.GetPrivKey(),\n>                                       mapKeyMetadata[pubkey.GetID()]);\n>     }\n>     return true;\n> }\n> \n>+bool CWallet::AddKeyPubKey(const CKey& secret, const CPubKey &pubkey)\n>+{\n>+    CWalletDB walletdb(*dbw);\n>\n>It seems strange that we're creating a db transaction, only to throw it\n>out in a second. I think its safe, but it might be nicer to let\n>AddKeyPubKeyWithDB create a CWalletDB if it needs one automagically (eg\n>by passing the walletdb in as a pointer).\n",
      "created_at" : "2017-07-17T01:17:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10831#issuecomment-315652287",
      "id" : 315652287,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10831",
      "updated_at" : "2017-07-17T01:17:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315652287",
      "user" : {
         "avatar_url" : "https://avatars4.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127626915"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127626915"
         }
      },
      "body" : "This isn't called when we don't need one; the case where we already have a dbwallet calls the WithDB version.  (and changing the prototype of the function would mean changing the function it overrides, which a db handle doesn't even make sense for, and 29 callsites) Unless I'm misunderstanding you.",
      "commit_id" : "3986271c0accfe896c66a48d3ed884a7553b6413",
      "created_at" : "2017-07-17T02:57:03Z",
      "diff_hunk" : "@@ -162,33 +164,49 @@ void CWallet::DeriveNewChildKey(CKeyMetadata& metadata, CKey& secret, bool inter\n     secret = childKey.key;\n     metadata.hdMasterKeyID = hdChain.masterKeyID;\n     // update the chain model in the database\n-    if (!CWalletDB(*dbw).WriteHDChain(hdChain))\n+    if (!walletdb.WriteHDChain(hdChain))\n         throw std::runtime_error(std::string(__func__) + \": Writing HD chain model failed\");\n }\n \n-bool CWallet::AddKeyPubKey(const CKey& secret, const CPubKey &pubkey)\n+bool CWallet::AddKeyPubKeyWithDB(CWalletDB &walletdb, const CKey& secret, const CPubKey &pubkey)\n {\n     AssertLockHeld(cs_wallet); // mapKeyMetadata\n-    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey))\n+\n+    bool needsDB = !pwalletdbEncryption;\n+    if (needsDB) {\n+        pwalletdbEncryption = &walletdb;\n+    }\n+    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey)) {\n+        if (needsDB) pwalletdbEncryption = NULL;\n         return false;\n+    }\n+    if (needsDB) pwalletdbEncryption = NULL;\n \n     // check if we need to remove from watch-only\n     CScript script;\n     script = GetScriptForDestination(pubkey.GetID());\n-    if (HaveWatchOnly(script))\n+    if (HaveWatchOnly(script)) {\n         RemoveWatchOnly(script);\n+    }\n     script = GetScriptForRawPubKey(pubkey);\n-    if (HaveWatchOnly(script))\n+    if (HaveWatchOnly(script)) {\n         RemoveWatchOnly(script);\n+    }\n \n     if (!IsCrypted()) {\n-        return CWalletDB(*dbw).WriteKey(pubkey,\n+        return walletdb.WriteKey(pubkey,\n                                                  secret.GetPrivKey(),\n                                                  mapKeyMetadata[pubkey.GetID()]);\n     }\n     return true;\n }\n \n+bool CWallet::AddKeyPubKey(const CKey& secret, const CPubKey &pubkey)\n+{\n+    CWalletDB walletdb(*dbw);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127626915",
      "id" : 127626915,
      "original_commit_id" : "3986271c0accfe896c66a48d3ed884a7553b6413",
      "original_position" : 92,
      "path" : "src/wallet/wallet.cpp",
      "position" : 92,
      "pull_request_review_id" : 50230551,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831",
      "updated_at" : "2017-07-17T02:57:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127626915",
      "user" : {
         "avatar_url" : "https://avatars5.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127626971"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127626971"
         }
      },
      "body" : "Seems like a reasonable thing to do, but I didn't even want to consider anything that complex-- I wanted to eliminate the complaint that having many keys is 'slow' for 0.15 because of the bad interactions with hd-wallet and rescan when the keypool isn't big.",
      "commit_id" : "3986271c0accfe896c66a48d3ed884a7553b6413",
      "created_at" : "2017-07-17T02:58:23Z",
      "diff_hunk" : "@@ -162,33 +164,49 @@ void CWallet::DeriveNewChildKey(CKeyMetadata& metadata, CKey& secret, bool inter\n     secret = childKey.key;\n     metadata.hdMasterKeyID = hdChain.masterKeyID;\n     // update the chain model in the database\n-    if (!CWalletDB(*dbw).WriteHDChain(hdChain))\n+    if (!walletdb.WriteHDChain(hdChain))\n         throw std::runtime_error(std::string(__func__) + \": Writing HD chain model failed\");\n }\n \n-bool CWallet::AddKeyPubKey(const CKey& secret, const CPubKey &pubkey)\n+bool CWallet::AddKeyPubKeyWithDB(CWalletDB &walletdb, const CKey& secret, const CPubKey &pubkey)\n {\n     AssertLockHeld(cs_wallet); // mapKeyMetadata\n-    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey))\n+\n+    bool needsDB = !pwalletdbEncryption;\n+    if (needsDB) {\n+        pwalletdbEncryption = &walletdb;\n+    }\n+    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey)) {\n+        if (needsDB) pwalletdbEncryption = NULL;\n         return false;\n+    }\n+    if (needsDB) pwalletdbEncryption = NULL;\n \n     // check if we need to remove from watch-only\n     CScript script;\n     script = GetScriptForDestination(pubkey.GetID());\n-    if (HaveWatchOnly(script))\n+    if (HaveWatchOnly(script)) {\n         RemoveWatchOnly(script);\n+    }\n     script = GetScriptForRawPubKey(pubkey);\n-    if (HaveWatchOnly(script))\n+    if (HaveWatchOnly(script)) {\n         RemoveWatchOnly(script);\n+    }\n \n     if (!IsCrypted()) {\n-        return CWalletDB(*dbw).WriteKey(pubkey,\n+        return walletdb.WriteKey(pubkey,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127626971",
      "id" : 127626971,
      "original_commit_id" : "3986271c0accfe896c66a48d3ed884a7553b6413",
      "original_position" : 83,
      "path" : "src/wallet/wallet.cpp",
      "position" : 83,
      "pull_request_review_id" : 50230624,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831",
      "updated_at" : "2017-07-17T02:58:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127626971",
      "user" : {
         "avatar_url" : "https://avatars5.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "@TheBlueMatt another PR then.\r\n\r\nutACK 3986271.\r\n",
      "created_at" : "2017-07-17T07:45:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10831#issuecomment-315687135",
      "id" : 315687135,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10831",
      "updated_at" : "2017-07-17T07:45:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315687135",
      "user" : {
         "avatar_url" : "https://avatars5.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "body" : "reutACK 3986271c0accfe896c66a48d3ed884a7553b6413",
      "created_at" : "2017-07-17T08:03:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10831#issuecomment-315690170",
      "id" : 315690170,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10831",
      "updated_at" : "2017-07-17T08:03:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315690170",
      "user" : {
         "avatar_url" : "https://avatars5.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127649698"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127649698"
         }
      },
      "body" : "If we increase the default keypool size, the `LogPrintf(\"keypool added key %d` message below shouldn't be logged for every key. Or at least moved to a debug category. It's ugly to log that many messages at first run, and it is performance overhead too.",
      "commit_id" : "3986271c0accfe896c66a48d3ed884a7553b6413",
      "created_at" : "2017-07-17T08:04:17Z",
      "diff_hunk" : "@@ -3183,8 +3201,9 @@ bool CWallet::TopUpKeyPool(unsigned int kpSize)\n                 nEnd = std::max(nEnd, *(setExternalKeyPool.rbegin()) + 1);\n             }\n \n-            if (!walletdb.WritePool(nEnd, CKeyPool(GenerateNewKey(internal), internal)))\n+            if (!walletdb.WritePool(nEnd, CKeyPool(GenerateNewKey(walletdb, internal), internal))) {\n                 throw std::runtime_error(std::string(__func__) + \": writing generated key failed\");\n+            }\n \n             if (internal) {\n                 setInternalKeyPool.insert(nEnd);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127649698",
      "id" : 127649698,
      "original_commit_id" : "3986271c0accfe896c66a48d3ed884a7553b6413",
      "original_position" : 109,
      "path" : "src/wallet/wallet.cpp",
      "position" : 109,
      "pull_request_review_id" : 50254385,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831",
      "updated_at" : "2017-07-17T08:05:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127649698",
      "user" : {
         "avatar_url" : "https://avatars4.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   }
]
