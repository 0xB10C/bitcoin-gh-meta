{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "NONE",
   "body" : "This code makes executing two particular (and potentially other) attacks harder by changing 60 lines of p2p code.\r\n\r\n### InvBlock\r\nThis behavior was described well [here](https://www.cs.umd.edu/projects/coinscope/coinscope.pdf) (page 11).\r\n\r\nPer current implementation, if node A receives _INV_ (tx) from node B, node A sends _GETDATA_ to B and waits for _TX_ message back.\r\n\r\nNode A is likely to receive more _INVs_ (regarding the same tx) from other peers. But node A would not send another _GETDATA_ unless it does not hear _TX_ back from node B for next 2 minutes (to save bandwidth)\r\n\r\nThus, if B is a malicious node, it can prevent node A from getting the transaction (even if all AÃ¢ÂÂs peers have it) for 2 minutes.\r\n\r\nThis behavior seems to be an inherent limitation of the current P2P relay protocol, and I donÃ¢ÂÂt see how it can be fundamentally changed (I can see workarounds which involve rewriting a lot of P2P code though).\r\n\r\n### What does this PR fix?\r\n\r\nThe attacks IÃ¢ÂÂm looking at involve preventing A from learning the transaction for 2*N minutes. To do that, an attacker has to spin up N nodes and send N _INVs_ simultaneously to node A (then InvBlocks will be queued with an interval of 2 minutes according to current implementation)\r\n\r\nMore precisely, 2 scenarios IÃ¢ÂÂm looking at are:\r\n1. An attacker censors a particular transaction. By performing InvBlock from different nodes, an attacker can execute a network-wide censorship of a particular transaction (or all transactions). The earlier an attacker founds the transaction he wants to censor, the easier it is to perform an attack. As it was pointed out by @gwillen, this is even more dangerous in the case of lightning, where transactions are known in advance. \r\n2. Topology inference described in papers [1](https://www.cs.umd.edu/projects/coinscope/coinscope.pdf), [2](https://arxiv.org/pdf/1812.00942.pdf) involve network-wide InvBlock. This fix would not mitigate this type of inference, but I believe it will make it more expensive to perform (an attacker would have to create more transactions and perform more rounds to learn the topology, the second paper itself notes that InvBlock isolation is important for the attack).\r\n\r\n### How does it work\r\n~~Instead of having a single timer which takes the last request timestamp and adds 2 minutes, I propose to have 2 timers: for inbound and outbound connections. They start from the same timestamp, but for inbound the timeout is 4 minutes and for outbound itÃ¢ÂÂs 1 minute.\r\nAfter this fix, if the incoming messages were [I, I, I, O, O, O, O, O], the queue for _GETDATA_ would look like [I, O, O, O, I, O, O, O, Ã¢ÂÂ¦.]~~\r\n\r\nThis PR introduces bias toward outbound connections (they have higher priority when a node chooses from whom it should request a transaction) and randomizes the order.\r\nAs per @gmaxwell suggestion, GETDATA requests queue is created after processing all incoming messages from all nodes. \r\n\r\nAfter this fix, if the incoming messages were [I1, I2, I3, O1, O2, O3, O4], the queue for _GETDATA_ may look like [O2, O1, O3, O4, I1, I3, I2, Ã¢ÂÂ¦.].\r\n\r\nIf {I1, I2, I3} were significantly earlier (but the difference is less than TX_TIMEOUT=60 s) than others, the queue for _GETDATA_ may look like [I2, O2, O1, O3, O4, I1, I3, Ã¢ÂÂ¦.]. \r\n\r\n\r\n### Other comments:\r\n1. This mitigation works better if the connectivity is higher (especially outbound, because it would be less likely that 2 _GETDATAs_ for inbound malicious nodes queued together)\r\n2. We also can randomize the order for scheduling inbound _GETDATAs_, but I believe the benefit (on top of my simple proposal) does not worth rewriting a lot of p2p code\r\n",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 6,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14897/comments",
   "created_at" : "2018-12-08T04:12:48Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14897/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/14897",
   "id" : 388883229,
   "labels" : [
      {
         "color" : "cccccc",
         "default" : false,
         "id" : 955867938,
         "name" : "Needs rebase",
         "node_id" : "MDU6TGFiZWw5NTU4Njc5Mzg=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Needs%20rebase"
      },
      {
         "color" : "006b75",
         "default" : false,
         "id" : 98298007,
         "name" : "P2P",
         "node_id" : "MDU6TGFiZWw5ODI5ODAwNw==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/P2P"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14897/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDExOlB1bGxSZXF1ZXN0MjM3MDQzODU1",
   "number" : 14897,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/14897.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14897",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/14897.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14897"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "title" : "randomize GETDATA(tx) request order and introduce bias toward outbound ",
   "updated_at" : "2019-01-14T14:20:45Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14897",
   "user" : {
      "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
      "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
      "followers_url" : "https://api.github.com/users/naumenkogs/followers",
      "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
      "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/naumenkogs",
      "id" : 7975071,
      "login" : "naumenkogs",
      "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
      "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
      "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
      "repos_url" : "https://api.github.com/users/naumenkogs/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/naumenkogs"
   }
}
