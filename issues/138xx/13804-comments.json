[
   {
      "author_association" : "MEMBER",
      "body" : "Currently based on some other commits, which probably should be reviewed and merged first.\r\n\r\n* #13783",
      "created_at" : "2018-07-30T14:50:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13804#issuecomment-408890871",
      "id" : 408890871,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13804",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQwODg5MDg3MQ==",
      "updated_at" : "2018-09-10T16:53:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/408890871",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->Note to reviewers: This pull request conflicts with the following ones:\n\n* #14193 (validation: Add missing mempool locks by MarcoFalke)\n* #13949 (Introduce MempoolObserver interface to break \"policy/fees -> txmempool -> policy/fees\" circular dependency by Empact)\n* #13909 (validation: Remove unused CChainParams argument in AcceptToMemoryPoolWorker(...) by practicalswift)\n* #13864 (validation: Document where we are intentionally ignoring bool return values from validation related functions by practicalswift)\n* #13783 (validation: Pass tx pool reference into CheckSequenceLocks by MarcoFalke)\n* #13189 (Remove 2nd mapTx lookup in CTxMemPool::removeForBlock by promag)\n* #11652 (Add missing locks: validation.cpp + related by practicalswift)\n* #11535 (Avoid unintentional unsigned integer wraparounds by practicalswift)\n* #10823 (Allow all mempool txs to be replaced after a configurable timeout (default 6h) by greenaddress)\n* #10443 (Add fee_est tool for debugging fee estimation code by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2018-07-30T17:42:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13804#issuecomment-408949300",
      "id" : 408949300,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13804",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQwODk0OTMwMA==",
      "updated_at" : "2018-09-14T14:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/408949300",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13804#discussion_r206541409"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13804"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/206541409"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Commit \"Stacked Transaction Pool\"\r\n\r\nnit, add space after `,`.",
      "commit_id" : "7bbdcd3a04470c5c4ab6ef7d946a29d7504f7b16",
      "created_at" : "2018-07-31T14:05:34Z",
      "diff_hunk" : "@@ -23,6 +23,6 @@ bool SignalsOptInRBF(const CTransaction &tx);\n // according to BIP 125\n // This involves checking sequence numbers of the transaction, as well\n // as the sequence numbers of all in-mempool ancestors.\n-RBFTransactionState IsRBFOptIn(const CTransaction &tx, CTxMemPool &pool) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);\n+RBFTransactionState IsRBFOptIn(const CTransaction &tx,const CTxMemPool &pool) EXCLUSIVE_LOCKS_REQUIRED(pool.cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13804#discussion_r206541409",
      "id" : 206541409,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIwNjU0MTQwOQ==",
      "original_commit_id" : "fa7a9de343c689b8c6a83da8a014a825076f7583",
      "original_position" : 5,
      "path" : "src/policy/rbf.h",
      "position" : null,
      "pull_request_review_id" : 141971067,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13804",
      "updated_at" : "2018-09-10T19:14:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/206541409",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13804#discussion_r206541787"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13804"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/206541787"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Commit \"Stacked Transaction Pool\"\r\n\r\nnit, remove extra spaces.",
      "commit_id" : "7bbdcd3a04470c5c4ab6ef7d946a29d7504f7b16",
      "created_at" : "2018-07-31T14:06:36Z",
      "diff_hunk" : "@@ -289,19 +332,27 @@ void CTxMemPool::UpdateForRemoveFromMempool(const setEntries &entriesToRemove, b\n         // differ from the set of mempool parents we'd calculate by searching,\n         // and it's important that we use the mapLinks[] notion of ancestor\n         // transactions as the set of things to update for removal.\n-        CalculateMemPoolAncestors(removeIt, setAncestors, nNoLimit, nNoLimit, nNoLimit, nNoLimit, dummy);\n+        pool.CalculateMemPoolAncestors(removeIt, setAncestors, nNoLimit, nNoLimit, nNoLimit, nNoLimit, dummy);\n         // Note that UpdateAncestorsOf severs the child links that point to\n         // removeIt in the entries for the parents of removeIt.\n-        UpdateAncestorsOf(false, removeIt, setAncestors);\n+        pool.UpdateAncestorsOf(false, removeIt, setAncestors);\n     }\n     // After updating all the ancestor sizes, we can now sever the link between each\n     // transaction being removed and any mempool children (ie, update setMemPoolParents\n     // for each direct child of a transaction being removed).\n-    for (txiter removeIt : entriesToRemove) {\n-        UpdateChildrenForRemoval(removeIt);\n+    for (const auto& removeIt : entriesToRemove) {\n+        pool.UpdateChildrenForRemoval(removeIt);\n     }\n }\n+void CTxMemPool::UpdateForRemoveFromMempool(const setEntries& entriesToRemove, bool updateDescendants)\n+{\n+    return ::UpdateForRemoveFromMempool(*this, entriesToRemove, updateDescendants);\n+}\n \n+void CTxMemPool::Layer::  UpdateForRemoveFromMempool(const setEntries&entriesToRemove, bool updateDescendants)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13804#discussion_r206541787",
      "id" : 206541787,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIwNjU0MTc4Nw==",
      "original_commit_id" : "fa7a9de343c689b8c6a83da8a014a825076f7583",
      "original_position" : 239,
      "path" : "src/txmempool.cpp",
      "position" : 235,
      "pull_request_review_id" : 141971067,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13804",
      "updated_at" : "2018-09-10T19:14:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/206541787",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13804#discussion_r217764910"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13804"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/217764910"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ownerless expression?",
      "commit_id" : "7bbdcd3a04470c5c4ab6ef7d946a29d7504f7b16",
      "created_at" : "2018-09-14T16:10:01Z",
      "diff_hunk" : "@@ -865,38 +993,96 @@ const CTransaction* CTxMemPool::GetConflictTx(const COutPoint& prevout) const\n     return it == mapNextTx.end() ? nullptr : it->second;\n }\n \n+const CTransaction* CTxMemPool::Layer::GetConflictTx(const COutPoint& prevout) const\n+{\n+    auto it_add = m_map_next_tx_added.find(prevout);\n+    if (it_add != m_map_next_tx_added.end()) return it_add->second;\n+    if (m_map_next_tx_removed.find(prevout) != m_map_next_tx_removed.end()) return nullptr;\n+\n+    return m_tx_pool.GetConflictTx(prevout);\n+}\n+\n boost::optional<CTxMemPool::txiter> CTxMemPool::GetIter(const uint256& txid) const\n {\n     auto it = mapTx.find(txid);\n     if (it != mapTx.end()) return it;\n     return boost::optional<txiter>{};\n }\n \n-CTxMemPool::setEntries CTxMemPool::GetIterSet(const std::set<uint256>& hashes) const\n+boost::optional<CTxMemPool::Layer::txiter> CTxMemPool::Layer::GetIter(const uint256& txid) const\n {\n-    CTxMemPool::setEntries ret;\n+    const auto& it_cache = m_cache_added.find(txid);\n+    if (it_cache != m_cache_added.end()) {\n+        CTxMemPool::Layer::txiter{it_cache};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13804#discussion_r217764910",
      "id" : 217764910,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNzc2NDkxMA==",
      "original_commit_id" : "7bbdcd3a04470c5c4ab6ef7d946a29d7504f7b16",
      "original_position" : 521,
      "path" : "src/txmempool.cpp",
      "position" : 521,
      "pull_request_review_id" : 155563229,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13804",
      "updated_at" : "2018-09-14T16:10:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/217764910",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   }
]
