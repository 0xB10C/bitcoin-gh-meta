[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "utACK although it would be good to factor out the counting into a WalletWriteCache or something, that flushes itself at intervals so you don't have to do it manually.",
      "created_at" : "2019-04-03T23:30:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15741#issuecomment-479694760",
      "id" : 479694760,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15741",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3OTY5NDc2MA==",
      "updated_at" : "2019-04-03T23:30:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/479694760",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/458997?v=4",
         "events_url" : "https://api.github.com/users/gwillen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gwillen/followers",
         "following_url" : "https://api.github.com/users/gwillen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gwillen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gwillen",
         "id" : 458997,
         "login" : "gwillen",
         "node_id" : "MDQ6VXNlcjQ1ODk5Nw==",
         "organizations_url" : "https://api.github.com/users/gwillen/orgs",
         "received_events_url" : "https://api.github.com/users/gwillen/received_events",
         "repos_url" : "https://api.github.com/users/gwillen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gwillen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gwillen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gwillen"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15741#discussion_r271971255"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15741"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271971255"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "There is a weird indentation glitch here, although it looks like it was preexisting.",
      "commit_id" : "f2b9b32a63b5ff544334e15c2c8040a2572e920c",
      "created_at" : "2019-04-03T23:31:53Z",
      "diff_hunk" : "@@ -1282,33 +1287,46 @@ static UniValue ProcessImport(CWallet * const pwallet, const UniValue& data, con\n             }\n              const CPubKey& pubkey = entry->second;\n              CPubKey temp;\n-             if (!pwallet->GetPubKey(id, temp) && !pwallet->AddWatchOnly(GetScriptForRawPubKey(pubkey), timestamp)) {\n+             if (!pwallet->GetPubKey(id, temp) && !pwallet->AddWatchOnlyWithDB(*batch, GetScriptForRawPubKey(pubkey), timestamp)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15741#discussion_r271971255",
      "id" : 271971255,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTk3MTI1NQ==",
      "original_commit_id" : "508c4860644e818023735d77e706efa490db744a",
      "original_position" : 29,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 222501439,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15741",
      "updated_at" : "2019-04-05T22:01:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271971255",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/458997?v=4",
         "events_url" : "https://api.github.com/users/gwillen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gwillen/followers",
         "following_url" : "https://api.github.com/users/gwillen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gwillen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gwillen",
         "id" : 458997,
         "login" : "gwillen",
         "node_id" : "MDQ6VXNlcjQ1ODk5Nw==",
         "organizations_url" : "https://api.github.com/users/gwillen/orgs",
         "received_events_url" : "https://api.github.com/users/gwillen/received_events",
         "repos_url" : "https://api.github.com/users/gwillen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gwillen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gwillen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gwillen"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15741#discussion_r271971423"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15741"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271971423"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Is this necessary? It's about to go out of scope, right?",
      "commit_id" : "f2b9b32a63b5ff544334e15c2c8040a2572e920c",
      "created_at" : "2019-04-03T23:32:40Z",
      "diff_hunk" : "@@ -1282,33 +1287,46 @@ static UniValue ProcessImport(CWallet * const pwallet, const UniValue& data, con\n             }\n              const CPubKey& pubkey = entry->second;\n              CPubKey temp;\n-             if (!pwallet->GetPubKey(id, temp) && !pwallet->AddWatchOnly(GetScriptForRawPubKey(pubkey), timestamp)) {\n+             if (!pwallet->GetPubKey(id, temp) && !pwallet->AddWatchOnlyWithDB(*batch, GetScriptForRawPubKey(pubkey), timestamp)) {\n                 throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding address to wallet\");\n             }\n+            if (++cnt % 1000 == 0) {\n+                batch.reset(new WalletBatch(pwallet->GetDBHandle()));\n+            }\n             const auto& key_orig_it = import_data.key_origins.find(id);\n             if (key_orig_it != import_data.key_origins.end()) {\n-                pwallet->AddKeyOrigin(pubkey, key_orig_it->second);\n+                pwallet->AddKeyOriginWithDB(*batch, pubkey, key_orig_it->second);\n+                if (++cnt % 1000 == 0) {\n+                    batch.reset(new WalletBatch(pwallet->GetDBHandle()));\n+                }\n             }\n             pwallet->mapKeyMetadata[id].nCreateTime = timestamp;\n \n             // Add to keypool only works with pubkeys\n             if (add_keypool) {\n-                pwallet->AddKeypoolPubkey(pubkey, internal);\n+                pwallet->AddKeypoolPubkeyWithDB(pubkey, internal, *batch);\n+                if (++cnt % 1000 == 0) {\n+                    batch.reset(new WalletBatch(pwallet->GetDBHandle()));\n+                }\n             }\n         }\n \n         for (const CScript& script : script_pub_keys) {\n             if (!have_solving_data || !::IsMine(*pwallet, script)) { // Always call AddWatchOnly for non-solvable watch-only, so that watch timestamp gets updated\n-                if (!pwallet->AddWatchOnly(script, timestamp)) {\n+                if (!pwallet->AddWatchOnlyWithDB(*batch, script, timestamp)) {\n                     throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding address to wallet\");\n                 }\n+                if (++cnt % 1000 == 0) {\n+                    batch.reset(new WalletBatch(pwallet->GetDBHandle()));\n+                }\n             }\n             CTxDestination dest;\n             ExtractDestination(script, dest);\n             if (!internal && IsValidDestination(dest)) {\n                 pwallet->SetAddressBook(dest, label, \"receive\");\n             }\n         }\n+        batch.reset();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15741#discussion_r271971423",
      "id" : 271971423,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTk3MTQyMw==",
      "original_commit_id" : "508c4860644e818023735d77e706efa490db744a",
      "original_position" : 71,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 222501439,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15741",
      "updated_at" : "2019-04-05T22:01:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271971423",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/458997?v=4",
         "events_url" : "https://api.github.com/users/gwillen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gwillen/followers",
         "following_url" : "https://api.github.com/users/gwillen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gwillen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gwillen",
         "id" : 458997,
         "login" : "gwillen",
         "node_id" : "MDQ6VXNlcjQ1ODk5Nw==",
         "organizations_url" : "https://api.github.com/users/gwillen/orgs",
         "received_events_url" : "https://api.github.com/users/gwillen/received_events",
         "repos_url" : "https://api.github.com/users/gwillen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gwillen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gwillen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gwillen"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#15749](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15749.html) (Fix: importmulti only imports origin info for PKH outputs by sipa)\n* [#15424](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15424.html) ([wallet] wallet-tool: command to remove key metadata by Sjors)\n* [#15414](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15414.html) ([wallet] allow adding pubkeys from imported private keys to keypool by Sjors)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2019-04-04T01:10:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15741#issuecomment-479712248",
      "id" : 479712248,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15741",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3OTcxMjI0OA==",
      "updated_at" : "2019-04-04T20:11:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/479712248",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "https://github.com/Empact/bitcoin/commit/dd5b0aaf58d843c2532b3ca1829bf90482e9dc52 `CWallet::AddKeyOrigin(const CPubKey& pubkey, const KeyOriginInfo& info)` and `CWallet::WriteKeyMetadata(const CKeyMetadata& meta, const CPubKey& pubkey, const bool overwrite)` can be removed.\r\n\r\nhttps://github.com/Empact/bitcoin/commit/c5d9eec6529cb2ce185be92d199ac50790a400ff How about moving this functionality into `CWallet`, so that we don't operate externally on `CWallet::database` any more than we already do. As the `GetDBHandle` comments say:\r\nhttps://github.com/bitcoin/bitcoin/blob/ba54342c9dd3f2e5cdeed9ac57f1924f0d885cc6/src/wallet/wallet.h#L750-L753\r\n\r\nPractically speaking, this also explicitly limits the scope of the batch operations on `database` to within the lifecycle of the `CWallet` instance.\r\n\r\nhttps://github.com/Empact/bitcoin/commit/b363aa785eb2d2cfb95a69f6cb1ddb6ebe89db18 Could also apply the batch treatment to `SetAddressBook`\r\n",
      "created_at" : "2019-04-04T09:18:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15741#issuecomment-479819136",
      "id" : 479819136,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15741",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3OTgxOTEzNg==",
      "updated_at" : "2019-04-04T09:35:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/479819136",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5470?v=4",
         "events_url" : "https://api.github.com/users/Empact/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Empact/followers",
         "following_url" : "https://api.github.com/users/Empact/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Empact/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Empact",
         "id" : 5470,
         "login" : "Empact",
         "node_id" : "MDQ6VXNlcjU0NzA=",
         "organizations_url" : "https://api.github.com/users/Empact/orgs",
         "received_events_url" : "https://api.github.com/users/Empact/received_events",
         "repos_url" : "https://api.github.com/users/Empact/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Empact/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Empact/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Empact"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15741#discussion_r272102808"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15741"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272102808"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: May be a bad example to follow, but `AddKeypoolPubkeyWithDB` has `batch` as the last argument, which makes as much sense to me.",
      "commit_id" : "f2b9b32a63b5ff544334e15c2c8040a2572e920c",
      "created_at" : "2019-04-04T09:52:44Z",
      "diff_hunk" : "@@ -1222,6 +1224,7 @@ class CWallet final : public CCryptoKeyStore, private interfaces::Chain::Notific\n \n     /** Add a KeyOriginInfo to the wallet */\n     bool AddKeyOrigin(const CPubKey& pubkey, const KeyOriginInfo& info);\n+    bool AddKeyOriginWithDB(WalletBatch& batch, const CPubKey& pubkey, const KeyOriginInfo& info);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15741#discussion_r272102808",
      "id" : 272102808,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MjEwMjgwOA==",
      "original_commit_id" : "508c4860644e818023735d77e706efa490db744a",
      "original_position" : 20,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 222662248,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15741",
      "updated_at" : "2019-04-05T22:01:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272102808",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5470?v=4",
         "events_url" : "https://api.github.com/users/Empact/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Empact/followers",
         "following_url" : "https://api.github.com/users/Empact/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Empact/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Empact",
         "id" : 5470,
         "login" : "Empact",
         "node_id" : "MDQ6VXNlcjU0NzA=",
         "organizations_url" : "https://api.github.com/users/Empact/orgs",
         "received_events_url" : "https://api.github.com/users/Empact/received_events",
         "repos_url" : "https://api.github.com/users/Empact/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Empact/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Empact/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Empact"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2019-04-04T09:53:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15741#issuecomment-479831135",
      "id" : 479831135,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15741",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3OTgzMTEzNQ==",
      "updated_at" : "2019-04-04T09:53:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/479831135",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5470?v=4",
         "events_url" : "https://api.github.com/users/Empact/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Empact/followers",
         "following_url" : "https://api.github.com/users/Empact/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Empact/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Empact",
         "id" : 5470,
         "login" : "Empact",
         "node_id" : "MDQ6VXNlcjU0NzA=",
         "organizations_url" : "https://api.github.com/users/Empact/orgs",
         "received_events_url" : "https://api.github.com/users/Empact/received_events",
         "repos_url" : "https://api.github.com/users/Empact/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Empact/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Empact/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Empact"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15741#discussion_r272164997"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15741"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272164997"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What is the problem of one batch only?",
      "commit_id" : "f2b9b32a63b5ff544334e15c2c8040a2572e920c",
      "created_at" : "2019-04-04T12:57:53Z",
      "diff_hunk" : "@@ -1263,17 +1263,22 @@ static UniValue ProcessImport(CWallet * const pwallet, const UniValue& data, con\n                 throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding script to wallet\");\n              }\n          }\n+         std::unique_ptr<WalletBatch> batch = MakeUnique<WalletBatch>(pwallet->GetDBHandle());\n+         size_t cnt = 0;\n          for (const auto& entry : privkey_map) {\n              const CKey& key = entry.second;\n              CPubKey pubkey = key.GetPubKey();\n              const CKeyID& id = entry.first;\n              assert(key.VerifyPubKey(pubkey));\n              pwallet->mapKeyMetadata[id].nCreateTime = timestamp;\n              // If the private key is not present in the wallet, insert it.\n-             if (!pwallet->HaveKey(id) && !pwallet->AddKeyPubKey(key, pubkey)) {\n+             if (!pwallet->HaveKey(id) && !pwallet->AddKeyPubKeyWithDB(*batch, key, pubkey)) {\n                  throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding key to wallet\");\n              }\n              pwallet->UpdateTimeFirstKey(timestamp);\n+             if (++cnt % 1000 == 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15741#discussion_r272164997",
      "id" : 272164997,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MjE2NDk5Nw==",
      "original_commit_id" : "508c4860644e818023735d77e706efa490db744a",
      "original_position" : 18,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 222743348,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15741",
      "updated_at" : "2019-04-05T22:01:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272164997",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "See also:  \r\n\r\n* Use a single wallet batch for UpgradeKeyMetadata #15433 ",
      "created_at" : "2019-04-04T17:46:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15741#issuecomment-479996852",
      "id" : 479996852,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15741",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3OTk5Njg1Mg==",
      "updated_at" : "2019-04-04T17:46:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/479996852",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've pulled in @Empact's changes (Empact@dd5b0aa was squashed into 59ec41257f37f2a0438b10ef9776bf7ea3488e9a, cherry-picked the other two commits).",
      "created_at" : "2019-04-04T18:10:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15741#issuecomment-480005407",
      "id" : 480005407,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15741",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4MDAwNTQwNw==",
      "updated_at" : "2019-04-04T18:10:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/480005407",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15741#discussion_r272303357"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15741"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272303357"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The batch can get very large in memory if lots of keys are involved, so we limit the size to avoid blowing up memory during imports.",
      "commit_id" : "f2b9b32a63b5ff544334e15c2c8040a2572e920c",
      "created_at" : "2019-04-04T18:11:17Z",
      "diff_hunk" : "@@ -1263,17 +1263,22 @@ static UniValue ProcessImport(CWallet * const pwallet, const UniValue& data, con\n                 throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding script to wallet\");\n              }\n          }\n+         std::unique_ptr<WalletBatch> batch = MakeUnique<WalletBatch>(pwallet->GetDBHandle());\n+         size_t cnt = 0;\n          for (const auto& entry : privkey_map) {\n              const CKey& key = entry.second;\n              CPubKey pubkey = key.GetPubKey();\n              const CKeyID& id = entry.first;\n              assert(key.VerifyPubKey(pubkey));\n              pwallet->mapKeyMetadata[id].nCreateTime = timestamp;\n              // If the private key is not present in the wallet, insert it.\n-             if (!pwallet->HaveKey(id) && !pwallet->AddKeyPubKey(key, pubkey)) {\n+             if (!pwallet->HaveKey(id) && !pwallet->AddKeyPubKeyWithDB(*batch, key, pubkey)) {\n                  throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding key to wallet\");\n              }\n              pwallet->UpdateTimeFirstKey(timestamp);\n+             if (++cnt % 1000 == 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15741#discussion_r272303357",
      "id" : 272303357,
      "in_reply_to_id" : 272164997,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MjMwMzM1Nw==",
      "original_commit_id" : "508c4860644e818023735d77e706efa490db744a",
      "original_position" : 18,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 222922919,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15741",
      "updated_at" : "2019-04-05T22:01:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272303357",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15741#discussion_r272303687"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15741"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272303687"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I was following the `AddKeyPubKeyWithDB` way of argument ordering.",
      "commit_id" : "f2b9b32a63b5ff544334e15c2c8040a2572e920c",
      "created_at" : "2019-04-04T18:12:04Z",
      "diff_hunk" : "@@ -1222,6 +1224,7 @@ class CWallet final : public CCryptoKeyStore, private interfaces::Chain::Notific\n \n     /** Add a KeyOriginInfo to the wallet */\n     bool AddKeyOrigin(const CPubKey& pubkey, const KeyOriginInfo& info);\n+    bool AddKeyOriginWithDB(WalletBatch& batch, const CPubKey& pubkey, const KeyOriginInfo& info);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15741#discussion_r272303687",
      "id" : 272303687,
      "in_reply_to_id" : 272102808,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MjMwMzY4Nw==",
      "original_commit_id" : "508c4860644e818023735d77e706efa490db744a",
      "original_position" : 20,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 222923339,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15741",
      "updated_at" : "2019-04-05T22:01:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272303687",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15741#discussion_r272303803"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15741"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272303803"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Probably not. I did that just as a belt-and-suspenders thing.",
      "commit_id" : "f2b9b32a63b5ff544334e15c2c8040a2572e920c",
      "created_at" : "2019-04-04T18:12:21Z",
      "diff_hunk" : "@@ -1282,33 +1287,46 @@ static UniValue ProcessImport(CWallet * const pwallet, const UniValue& data, con\n             }\n              const CPubKey& pubkey = entry->second;\n              CPubKey temp;\n-             if (!pwallet->GetPubKey(id, temp) && !pwallet->AddWatchOnly(GetScriptForRawPubKey(pubkey), timestamp)) {\n+             if (!pwallet->GetPubKey(id, temp) && !pwallet->AddWatchOnlyWithDB(*batch, GetScriptForRawPubKey(pubkey), timestamp)) {\n                 throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding address to wallet\");\n             }\n+            if (++cnt % 1000 == 0) {\n+                batch.reset(new WalletBatch(pwallet->GetDBHandle()));\n+            }\n             const auto& key_orig_it = import_data.key_origins.find(id);\n             if (key_orig_it != import_data.key_origins.end()) {\n-                pwallet->AddKeyOrigin(pubkey, key_orig_it->second);\n+                pwallet->AddKeyOriginWithDB(*batch, pubkey, key_orig_it->second);\n+                if (++cnt % 1000 == 0) {\n+                    batch.reset(new WalletBatch(pwallet->GetDBHandle()));\n+                }\n             }\n             pwallet->mapKeyMetadata[id].nCreateTime = timestamp;\n \n             // Add to keypool only works with pubkeys\n             if (add_keypool) {\n-                pwallet->AddKeypoolPubkey(pubkey, internal);\n+                pwallet->AddKeypoolPubkeyWithDB(pubkey, internal, *batch);\n+                if (++cnt % 1000 == 0) {\n+                    batch.reset(new WalletBatch(pwallet->GetDBHandle()));\n+                }\n             }\n         }\n \n         for (const CScript& script : script_pub_keys) {\n             if (!have_solving_data || !::IsMine(*pwallet, script)) { // Always call AddWatchOnly for non-solvable watch-only, so that watch timestamp gets updated\n-                if (!pwallet->AddWatchOnly(script, timestamp)) {\n+                if (!pwallet->AddWatchOnlyWithDB(*batch, script, timestamp)) {\n                     throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding address to wallet\");\n                 }\n+                if (++cnt % 1000 == 0) {\n+                    batch.reset(new WalletBatch(pwallet->GetDBHandle()));\n+                }\n             }\n             CTxDestination dest;\n             ExtractDestination(script, dest);\n             if (!internal && IsValidDestination(dest)) {\n                 pwallet->SetAddressBook(dest, label, \"receive\");\n             }\n         }\n+        batch.reset();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15741#discussion_r272303803",
      "id" : 272303803,
      "in_reply_to_id" : 271971423,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MjMwMzgwMw==",
      "original_commit_id" : "508c4860644e818023735d77e706efa490db744a",
      "original_position" : 71,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 222923489,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15741",
      "updated_at" : "2019-04-05T22:01:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272303803",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Especially if there are now multiple places we're manually batching writes like this, and more where we're considering it: Let me suggest again and more strongly that the batch object should be handling autoflushing after every X calls, instead of open-coding it in the caller like this. If it's appropriate for every caller, it could go into WalletBatch, else into a new class that's an extremely thin wrapper around it. I bet the total number of lines added in this PR would actually go down.",
      "created_at" : "2019-04-04T22:59:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15741#issuecomment-480092953",
      "id" : 480092953,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15741",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4MDA5Mjk1Mw==",
      "updated_at" : "2019-04-04T22:59:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/480092953",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/458997?v=4",
         "events_url" : "https://api.github.com/users/gwillen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gwillen/followers",
         "following_url" : "https://api.github.com/users/gwillen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gwillen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gwillen",
         "id" : 458997,
         "login" : "gwillen",
         "node_id" : "MDQ6VXNlcjQ1ODk5Nw==",
         "organizations_url" : "https://api.github.com/users/gwillen/orgs",
         "received_events_url" : "https://api.github.com/users/gwillen/received_events",
         "repos_url" : "https://api.github.com/users/gwillen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gwillen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gwillen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gwillen"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK. I tried the first two commits (so without address book change) with #14145 and importing 2x 1000 keys seems about 6 times faster. ",
      "created_at" : "2019-04-05T01:32:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15741#issuecomment-480119266",
      "id" : 480119266,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15741",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4MDExOTI2Ng==",
      "updated_at" : "2019-04-05T01:32:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/480119266",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@gwillen Agree it should be done but would be appropriate as a follow-up ",
      "created_at" : "2019-04-05T04:09:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15741#issuecomment-480141948",
      "id" : 480141948,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15741",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4MDE0MTk0OA==",
      "updated_at" : "2019-04-05T04:09:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/480141948",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5470?v=4",
         "events_url" : "https://api.github.com/users/Empact/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Empact/followers",
         "following_url" : "https://api.github.com/users/Empact/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Empact/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Empact",
         "id" : 5470,
         "login" : "Empact",
         "node_id" : "MDQ6VXNlcjU0NzA=",
         "organizations_url" : "https://api.github.com/users/Empact/orgs",
         "received_events_url" : "https://api.github.com/users/Empact/received_events",
         "repos_url" : "https://api.github.com/users/Empact/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Empact/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Empact/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Empact"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Looks like `AddKeypoolPubkey` is no longer used and can be removed?",
      "created_at" : "2019-04-05T11:45:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15741#issuecomment-480246084",
      "id" : 480246084,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15741",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4MDI0NjA4NA==",
      "updated_at" : "2019-04-05T11:45:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/480246084",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've implemented @gwillen's suggestion. `WalletBatch` will flush to disk automatically after every 1000 writes. This appears to be faster too as it does not close and reopen the database on every flush. With this change, I've also updated `UpgradeKeyMetadata`.\r\n\r\n> Looks like `AddKeypoolPubkey` is no longer used and can be removed?\r\n\r\nDone",
      "created_at" : "2019-04-05T19:24:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15741#issuecomment-480394233",
      "id" : 480394233,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15741",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4MDM5NDIzMw==",
      "updated_at" : "2019-04-05T19:24:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/480394233",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15741#discussion_r272733923"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15741"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272733923"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in commit ebb0ea85539b3e2f515fca89231c20ac86fb52d5:\r\n\r\nWhy is this no longer needed?",
      "commit_id" : "f2b9b32a63b5ff544334e15c2c8040a2572e920c",
      "created_at" : "2019-04-05T20:29:51Z",
      "diff_hunk" : "@@ -389,15 +388,10 @@ void CWallet::UpgradeKeyMetadata()\n             // Write meta to wallet\n             CPubKey pubkey;\n             if (GetPubKey(meta_pair.first, pubkey)) {\n-                batch->WriteKeyMetadata(meta, pubkey, true);\n-                if (++cnt % 1000 == 0) {\n-                    // avoid creating overlarge in-memory batches in case the wallet contains large amounts of keys\n-                    batch.reset(new WalletBatch(*database));\n-                }\n+                batch.WriteKeyMetadata(meta, pubkey, true);\n             }\n         }\n     }\n-    batch.reset(); //write before setting the flag",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15741#discussion_r272733923",
      "id" : 272733923,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MjczMzkyMw==",
      "original_commit_id" : "ebb0ea85539b3e2f515fca89231c20ac86fb52d5",
      "original_position" : 23,
      "path" : "src/wallet/wallet.cpp",
      "position" : 36,
      "pull_request_review_id" : 223466050,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15741",
      "updated_at" : "2019-04-05T22:01:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272733923",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15741#discussion_r272753131"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15741"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272753131"
         }
      },
      "author_association" : "MEMBER",
      "body" : "When batch goes out of scope, it will write. This was just a belt and suspenders.",
      "commit_id" : "f2b9b32a63b5ff544334e15c2c8040a2572e920c",
      "created_at" : "2019-04-05T21:44:18Z",
      "diff_hunk" : "@@ -389,15 +388,10 @@ void CWallet::UpgradeKeyMetadata()\n             // Write meta to wallet\n             CPubKey pubkey;\n             if (GetPubKey(meta_pair.first, pubkey)) {\n-                batch->WriteKeyMetadata(meta, pubkey, true);\n-                if (++cnt % 1000 == 0) {\n-                    // avoid creating overlarge in-memory batches in case the wallet contains large amounts of keys\n-                    batch.reset(new WalletBatch(*database));\n-                }\n+                batch.WriteKeyMetadata(meta, pubkey, true);\n             }\n         }\n     }\n-    batch.reset(); //write before setting the flag",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15741#discussion_r272753131",
      "id" : 272753131,
      "in_reply_to_id" : 272733923,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3Mjc1MzEzMQ==",
      "original_commit_id" : "ebb0ea85539b3e2f515fca89231c20ac86fb52d5",
      "original_position" : 23,
      "path" : "src/wallet/wallet.cpp",
      "position" : 36,
      "pull_request_review_id" : 223490974,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15741",
      "updated_at" : "2019-04-05T22:01:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272753131",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I'm unsure why tests are currently failing.",
      "created_at" : "2019-04-05T21:50:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15741#issuecomment-480433154",
      "id" : 480433154,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15741",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4MDQzMzE1NA==",
      "updated_at" : "2019-04-05T21:50:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/480433154",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15741#discussion_r272755099"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15741"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272755099"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The comment suggests that in this case -- unlike the batch write in importmulti -- there's a specific reason to force it to write before the end of the scope.",
      "commit_id" : "f2b9b32a63b5ff544334e15c2c8040a2572e920c",
      "created_at" : "2019-04-05T21:53:43Z",
      "diff_hunk" : "@@ -389,15 +388,10 @@ void CWallet::UpgradeKeyMetadata()\n             // Write meta to wallet\n             CPubKey pubkey;\n             if (GetPubKey(meta_pair.first, pubkey)) {\n-                batch->WriteKeyMetadata(meta, pubkey, true);\n-                if (++cnt % 1000 == 0) {\n-                    // avoid creating overlarge in-memory batches in case the wallet contains large amounts of keys\n-                    batch.reset(new WalletBatch(*database));\n-                }\n+                batch.WriteKeyMetadata(meta, pubkey, true);\n             }\n         }\n     }\n-    batch.reset(); //write before setting the flag",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15741#discussion_r272755099",
      "id" : 272755099,
      "in_reply_to_id" : 272733923,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3Mjc1NTA5OQ==",
      "original_commit_id" : "ebb0ea85539b3e2f515fca89231c20ac86fb52d5",
      "original_position" : 23,
      "path" : "src/wallet/wallet.cpp",
      "position" : 36,
      "pull_request_review_id" : 223493473,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15741",
      "updated_at" : "2019-04-05T22:01:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272755099",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/458997?v=4",
         "events_url" : "https://api.github.com/users/gwillen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gwillen/followers",
         "following_url" : "https://api.github.com/users/gwillen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gwillen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gwillen",
         "id" : 458997,
         "login" : "gwillen",
         "node_id" : "MDQ6VXNlcjQ1ODk5Nw==",
         "organizations_url" : "https://api.github.com/users/gwillen/orgs",
         "received_events_url" : "https://api.github.com/users/gwillen/received_events",
         "repos_url" : "https://api.github.com/users/gwillen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gwillen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gwillen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gwillen"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15741#discussion_r272757790"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15741"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272757790"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I get that this makes the code simple, but IMO this defeats the batch purpose. Like, it shouldn't be something to worry about here.",
      "commit_id" : "f2b9b32a63b5ff544334e15c2c8040a2572e920c",
      "created_at" : "2019-04-05T22:08:11Z",
      "diff_hunk" : "@@ -157,6 +157,9 @@ class WalletBatch\n             return false;\n         }\n         m_database.IncrementUpdateCounter();\n+        if (m_database.nUpdateCounter % 1000 == 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15741#discussion_r272757790",
      "id" : 272757790,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3Mjc1Nzc5MA==",
      "original_commit_id" : "f2b9b32a63b5ff544334e15c2c8040a2572e920c",
      "original_position" : 4,
      "path" : "src/wallet/walletdb.h",
      "position" : 4,
      "pull_request_review_id" : 223496976,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15741",
      "updated_at" : "2019-04-05T22:14:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272757790",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15741#discussion_r272758955"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15741"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272758955"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why this change?",
      "commit_id" : "f2b9b32a63b5ff544334e15c2c8040a2572e920c",
      "created_at" : "2019-04-05T22:14:33Z",
      "diff_hunk" : "@@ -614,7 +614,9 @@ void BerkeleyBatch::Flush()\n     if (fReadOnly)\n         nMinutes = 1;\n \n-    env->dbenv->txn_checkpoint(nMinutes ? gArgs.GetArg(\"-dblogsize\", DEFAULT_WALLET_DBLOGSIZE) * 1024 : 0, nMinutes, 0);\n+    if (env) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15741#discussion_r272758955",
      "id" : 272758955,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3Mjc1ODk1NQ==",
      "original_commit_id" : "f2b9b32a63b5ff544334e15c2c8040a2572e920c",
      "original_position" : 5,
      "path" : "src/wallet/db.cpp",
      "position" : 5,
      "pull_request_review_id" : 223496976,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15741",
      "updated_at" : "2019-04-05T22:14:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/272758955",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   }
]
