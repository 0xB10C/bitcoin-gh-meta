[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "utACK although it would be good to factor out the counting into a WalletWriteCache or something, that flushes itself at intervals so you don't have to do it manually.",
      "created_at" : "2019-04-03T23:30:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15741#issuecomment-479694760",
      "id" : 479694760,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15741",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3OTY5NDc2MA==",
      "updated_at" : "2019-04-03T23:30:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/479694760",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/458997?v=4",
         "events_url" : "https://api.github.com/users/gwillen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gwillen/followers",
         "following_url" : "https://api.github.com/users/gwillen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gwillen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gwillen",
         "id" : 458997,
         "login" : "gwillen",
         "node_id" : "MDQ6VXNlcjQ1ODk5Nw==",
         "organizations_url" : "https://api.github.com/users/gwillen/orgs",
         "received_events_url" : "https://api.github.com/users/gwillen/received_events",
         "repos_url" : "https://api.github.com/users/gwillen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gwillen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gwillen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gwillen"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15741#discussion_r271971255"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15741"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271971255"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "There is a weird indentation glitch here, although it looks like it was preexisting.",
      "commit_id" : "508c4860644e818023735d77e706efa490db744a",
      "created_at" : "2019-04-03T23:31:53Z",
      "diff_hunk" : "@@ -1282,33 +1287,46 @@ static UniValue ProcessImport(CWallet * const pwallet, const UniValue& data, con\n             }\n              const CPubKey& pubkey = entry->second;\n              CPubKey temp;\n-             if (!pwallet->GetPubKey(id, temp) && !pwallet->AddWatchOnly(GetScriptForRawPubKey(pubkey), timestamp)) {\n+             if (!pwallet->GetPubKey(id, temp) && !pwallet->AddWatchOnlyWithDB(*batch, GetScriptForRawPubKey(pubkey), timestamp)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15741#discussion_r271971255",
      "id" : 271971255,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTk3MTI1NQ==",
      "original_commit_id" : "508c4860644e818023735d77e706efa490db744a",
      "original_position" : 29,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 29,
      "pull_request_review_id" : 222501439,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15741",
      "updated_at" : "2019-04-03T23:32:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271971255",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/458997?v=4",
         "events_url" : "https://api.github.com/users/gwillen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gwillen/followers",
         "following_url" : "https://api.github.com/users/gwillen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gwillen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gwillen",
         "id" : 458997,
         "login" : "gwillen",
         "node_id" : "MDQ6VXNlcjQ1ODk5Nw==",
         "organizations_url" : "https://api.github.com/users/gwillen/orgs",
         "received_events_url" : "https://api.github.com/users/gwillen/received_events",
         "repos_url" : "https://api.github.com/users/gwillen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gwillen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gwillen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gwillen"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15741#discussion_r271971423"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15741"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271971423"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Is this necessary? It's about to go out of scope, right?",
      "commit_id" : "508c4860644e818023735d77e706efa490db744a",
      "created_at" : "2019-04-03T23:32:40Z",
      "diff_hunk" : "@@ -1282,33 +1287,46 @@ static UniValue ProcessImport(CWallet * const pwallet, const UniValue& data, con\n             }\n              const CPubKey& pubkey = entry->second;\n              CPubKey temp;\n-             if (!pwallet->GetPubKey(id, temp) && !pwallet->AddWatchOnly(GetScriptForRawPubKey(pubkey), timestamp)) {\n+             if (!pwallet->GetPubKey(id, temp) && !pwallet->AddWatchOnlyWithDB(*batch, GetScriptForRawPubKey(pubkey), timestamp)) {\n                 throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding address to wallet\");\n             }\n+            if (++cnt % 1000 == 0) {\n+                batch.reset(new WalletBatch(pwallet->GetDBHandle()));\n+            }\n             const auto& key_orig_it = import_data.key_origins.find(id);\n             if (key_orig_it != import_data.key_origins.end()) {\n-                pwallet->AddKeyOrigin(pubkey, key_orig_it->second);\n+                pwallet->AddKeyOriginWithDB(*batch, pubkey, key_orig_it->second);\n+                if (++cnt % 1000 == 0) {\n+                    batch.reset(new WalletBatch(pwallet->GetDBHandle()));\n+                }\n             }\n             pwallet->mapKeyMetadata[id].nCreateTime = timestamp;\n \n             // Add to keypool only works with pubkeys\n             if (add_keypool) {\n-                pwallet->AddKeypoolPubkey(pubkey, internal);\n+                pwallet->AddKeypoolPubkeyWithDB(pubkey, internal, *batch);\n+                if (++cnt % 1000 == 0) {\n+                    batch.reset(new WalletBatch(pwallet->GetDBHandle()));\n+                }\n             }\n         }\n \n         for (const CScript& script : script_pub_keys) {\n             if (!have_solving_data || !::IsMine(*pwallet, script)) { // Always call AddWatchOnly for non-solvable watch-only, so that watch timestamp gets updated\n-                if (!pwallet->AddWatchOnly(script, timestamp)) {\n+                if (!pwallet->AddWatchOnlyWithDB(*batch, script, timestamp)) {\n                     throw JSONRPCError(RPC_WALLET_ERROR, \"Error adding address to wallet\");\n                 }\n+                if (++cnt % 1000 == 0) {\n+                    batch.reset(new WalletBatch(pwallet->GetDBHandle()));\n+                }\n             }\n             CTxDestination dest;\n             ExtractDestination(script, dest);\n             if (!internal && IsValidDestination(dest)) {\n                 pwallet->SetAddressBook(dest, label, \"receive\");\n             }\n         }\n+        batch.reset();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15741#discussion_r271971423",
      "id" : 271971423,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTk3MTQyMw==",
      "original_commit_id" : "508c4860644e818023735d77e706efa490db744a",
      "original_position" : 71,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 71,
      "pull_request_review_id" : 222501439,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15741",
      "updated_at" : "2019-04-03T23:32:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271971423",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/458997?v=4",
         "events_url" : "https://api.github.com/users/gwillen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gwillen/followers",
         "following_url" : "https://api.github.com/users/gwillen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gwillen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gwillen",
         "id" : 458997,
         "login" : "gwillen",
         "node_id" : "MDQ6VXNlcjQ1ODk5Nw==",
         "organizations_url" : "https://api.github.com/users/gwillen/orgs",
         "received_events_url" : "https://api.github.com/users/gwillen/received_events",
         "repos_url" : "https://api.github.com/users/gwillen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gwillen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gwillen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gwillen"
      }
   }
]
