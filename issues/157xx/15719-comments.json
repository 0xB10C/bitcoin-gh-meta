[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#15700](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15700.html) (rfc: Synchronize validation interface registration by promag)\n* [#15632](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15632.html) (Remove ResendWalletTransactions from the Validation Interface by jnewbery)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2019-04-01T22:01:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15719#issuecomment-478763783",
      "id" : 478763783,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15719",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3ODc2Mzc4Mw==",
      "updated_at" : "2019-04-01T22:01:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/478763783",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "How will `snapshot_fn` work with IPC?",
      "created_at" : "2019-04-01T22:09:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15719#issuecomment-478765890",
      "id" : 478765890,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15719",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3ODc2NTg5MA==",
      "updated_at" : "2019-04-01T22:09:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/478765890",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/15719#issuecomment-478765890\r\n\r\n> How will snapshot_fn work with IPC?\r\n\r\nNo different than other callback arguments. In #10102, `std::function` arguments are passed as objects with a single `call()` method:\r\n\r\nhttps://github.com/ryanofsky/bitcoin/blob/3440513a45e94a5f1f0c67ab7409439afbbef673/src/interfaces/capnp/messages.capnp#L144-L154\r\n\r\nhttps://github.com/ryanofsky/bitcoin/blob/3440513a45e94a5f1f0c67ab7409439afbbef673/src/interfaces/capnp/messages.capnp#L236-L239\r\n\r\n",
      "created_at" : "2019-04-02T00:37:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15719#issuecomment-478797459",
      "id" : 478797459,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15719",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3ODc5NzQ1OQ==",
      "updated_at" : "2019-04-02T00:37:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/478797459",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15719#discussion_r271169011"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15719"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271169011"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Could use `LOCKS_EXCLUDED` annotations for those? ",
      "commit_id" : "5f593ab2e1dd52a50062abffbbe5e601fea165a8",
      "created_at" : "2019-04-02T07:43:06Z",
      "diff_hunk" : "@@ -358,22 +359,38 @@ class ChainImpl : public Chain\n     {\n         ::uiInterface.ShowProgress(title, progress, resume_possible);\n     }\n-    std::unique_ptr<Handler> handleNotifications(Notifications& notifications) override\n+    std::unique_ptr<Handler> handleNotifications(Notifications& notifications, SnapshotFn snapshot_fn) override\n     {\n-        return MakeUnique<NotificationsHandlerImpl>(*this, notifications);\n+        AssertLockNotHeld(::cs_main);\n+        AssertLockNotHeld(::mempool.cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15719#discussion_r271169011",
      "id" : 271169011,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTE2OTAxMQ==",
      "original_commit_id" : "10f92ce5c41a6936066f159012be72395385f282",
      "original_position" : 17,
      "path" : "src/interfaces/chain.cpp",
      "position" : 18,
      "pull_request_review_id" : 221492587,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15719",
      "updated_at" : "2019-04-02T15:09:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271169011",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ryanofsky ok thanks, will look into that.",
      "created_at" : "2019-04-02T12:24:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15719#issuecomment-478972074",
      "id" : 478972074,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15719",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3ODk3MjA3NA==",
      "updated_at" : "2019-04-02T12:24:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/478972074",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15719#discussion_r271292127"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15719"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271292127"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Mempool can change after the snapshot but before registering the interface and so those changes will be missed.",
      "commit_id" : "5f593ab2e1dd52a50062abffbbe5e601fea165a8",
      "created_at" : "2019-04-02T13:05:07Z",
      "diff_hunk" : "@@ -358,22 +359,38 @@ class ChainImpl : public Chain\n     {\n         ::uiInterface.ShowProgress(title, progress, resume_possible);\n     }\n-    std::unique_ptr<Handler> handleNotifications(Notifications& notifications) override\n+    std::unique_ptr<Handler> handleNotifications(Notifications& notifications, SnapshotFn snapshot_fn) override\n     {\n-        return MakeUnique<NotificationsHandlerImpl>(*this, notifications);\n+        AssertLockNotHeld(::cs_main);\n+        AssertLockNotHeld(::mempool.cs);\n+\n+        // Declare packaged task to run in notification thread, and to first\n+        // send the snapshot before enabling subsequent notifications.\n+        std::vector<CTransactionRef> snapshot;\n+        std::packaged_task<std::unique_ptr<Handler>()> task([&] {\n+            if (snapshot_fn) snapshot_fn(std::move(snapshot));\n+            return MakeUnique<NotificationsHandlerImpl>(*this, notifications);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15719#discussion_r271292127",
      "id" : 271292127,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTI5MjEyNw==",
      "original_commit_id" : "10f92ce5c41a6936066f159012be72395385f282",
      "original_position" : 24,
      "path" : "src/interfaces/chain.cpp",
      "position" : 25,
      "pull_request_review_id" : 221643011,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15719",
      "updated_at" : "2019-04-02T15:09:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271292127",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15719#discussion_r271355792"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15719"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271355792"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/15719#discussion_r271169011\r\n\r\n> Could use LOCKS_EXCLUDED annotations for those?\r\n\r\nAdded annotations. Effect is kind of limited since this is an override and these mutexes aren't accessible where this is called in the wallet, but it still seems better to have these annotations than not.\r\n\r\nLonger term, after more changes like this and #15632, which reduce Chain::Lock usage, wallet code should stop holding these locks altogether.",
      "commit_id" : "5f593ab2e1dd52a50062abffbbe5e601fea165a8",
      "created_at" : "2019-04-02T15:09:41Z",
      "diff_hunk" : "@@ -358,22 +359,38 @@ class ChainImpl : public Chain\n     {\n         ::uiInterface.ShowProgress(title, progress, resume_possible);\n     }\n-    std::unique_ptr<Handler> handleNotifications(Notifications& notifications) override\n+    std::unique_ptr<Handler> handleNotifications(Notifications& notifications, SnapshotFn snapshot_fn) override\n     {\n-        return MakeUnique<NotificationsHandlerImpl>(*this, notifications);\n+        AssertLockNotHeld(::cs_main);\n+        AssertLockNotHeld(::mempool.cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15719#discussion_r271355792",
      "id" : 271355792,
      "in_reply_to_id" : 271169011,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTM1NTc5Mg==",
      "original_commit_id" : "10f92ce5c41a6936066f159012be72395385f282",
      "original_position" : 17,
      "path" : "src/interfaces/chain.cpp",
      "position" : 18,
      "pull_request_review_id" : 221722990,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15719",
      "updated_at" : "2019-04-02T15:24:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271355792",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15719#discussion_r271355828"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15719"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271355828"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/15719#discussion_r271292127\r\n\r\n> Mempool can change after the snapshot but before registering the interface and so those changes will be missed.\r\n\r\nThis isn't true, and the comment below, \"Hold locks while scheduling the task so notifications about added and removed transactions after the snapshot arrive after the snapshot\" is specifically referring to this case.\r\n\r\nLet me know if I should make it more clear, but as long as the locks are held, transactions can't be added / removed by other threads, and as long as CallFunctionInValidationInterfaceQueue is called before transactions are added/removed, the handler will be registered before the queued notifications signal it.",
      "commit_id" : "5f593ab2e1dd52a50062abffbbe5e601fea165a8",
      "created_at" : "2019-04-02T15:09:45Z",
      "diff_hunk" : "@@ -358,22 +359,38 @@ class ChainImpl : public Chain\n     {\n         ::uiInterface.ShowProgress(title, progress, resume_possible);\n     }\n-    std::unique_ptr<Handler> handleNotifications(Notifications& notifications) override\n+    std::unique_ptr<Handler> handleNotifications(Notifications& notifications, SnapshotFn snapshot_fn) override\n     {\n-        return MakeUnique<NotificationsHandlerImpl>(*this, notifications);\n+        AssertLockNotHeld(::cs_main);\n+        AssertLockNotHeld(::mempool.cs);\n+\n+        // Declare packaged task to run in notification thread, and to first\n+        // send the snapshot before enabling subsequent notifications.\n+        std::vector<CTransactionRef> snapshot;\n+        std::packaged_task<std::unique_ptr<Handler>()> task([&] {\n+            if (snapshot_fn) snapshot_fn(std::move(snapshot));\n+            return MakeUnique<NotificationsHandlerImpl>(*this, notifications);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15719#discussion_r271355828",
      "id" : 271355828,
      "in_reply_to_id" : 271292127,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTM1NTgyOA==",
      "original_commit_id" : "10f92ce5c41a6936066f159012be72395385f282",
      "original_position" : 24,
      "path" : "src/interfaces/chain.cpp",
      "position" : 25,
      "pull_request_review_id" : 221722990,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15719",
      "updated_at" : "2019-04-02T15:24:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271355828",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   }
]
