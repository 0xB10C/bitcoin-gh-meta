[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.",
      "created_at" : "2019-04-01T22:01:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15719#issuecomment-478763783",
      "id" : 478763783,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15719",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3ODc2Mzc4Mw==",
      "updated_at" : "2019-04-11T11:22:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/478763783",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "How will `snapshot_fn` work with IPC?",
      "created_at" : "2019-04-01T22:09:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15719#issuecomment-478765890",
      "id" : 478765890,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15719",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3ODc2NTg5MA==",
      "updated_at" : "2019-04-01T22:09:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/478765890",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/15719#issuecomment-478765890\r\n\r\n> How will snapshot_fn work with IPC?\r\n\r\nNo different than other callback arguments. In #10102, `std::function` arguments are passed as objects with a single `call()` method:\r\n\r\nhttps://github.com/ryanofsky/bitcoin/blob/3440513a45e94a5f1f0c67ab7409439afbbef673/src/interfaces/capnp/messages.capnp#L144-L154\r\n\r\nhttps://github.com/ryanofsky/bitcoin/blob/3440513a45e94a5f1f0c67ab7409439afbbef673/src/interfaces/capnp/messages.capnp#L236-L239\r\n\r\n",
      "created_at" : "2019-04-02T00:37:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15719#issuecomment-478797459",
      "id" : 478797459,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15719",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3ODc5NzQ1OQ==",
      "updated_at" : "2019-04-02T00:37:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/478797459",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15719#discussion_r271169011"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15719"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271169011"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Could use `LOCKS_EXCLUDED` annotations for those? ",
      "commit_id" : "0ebc74e7636f6eadfde5685466c2b08065681702",
      "created_at" : "2019-04-02T07:43:06Z",
      "diff_hunk" : "@@ -358,22 +359,38 @@ class ChainImpl : public Chain\n     {\n         ::uiInterface.ShowProgress(title, progress, resume_possible);\n     }\n-    std::unique_ptr<Handler> handleNotifications(Notifications& notifications) override\n+    std::unique_ptr<Handler> handleNotifications(Notifications& notifications, SnapshotFn snapshot_fn) override\n     {\n-        return MakeUnique<NotificationsHandlerImpl>(*this, notifications);\n+        AssertLockNotHeld(::cs_main);\n+        AssertLockNotHeld(::mempool.cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15719#discussion_r271169011",
      "id" : 271169011,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTE2OTAxMQ==",
      "original_commit_id" : "10f92ce5c41a6936066f159012be72395385f282",
      "original_position" : 17,
      "path" : "src/interfaces/chain.cpp",
      "position" : 18,
      "pull_request_review_id" : 221492587,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15719",
      "updated_at" : "2019-04-11T10:03:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271169011",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ryanofsky ok thanks, will look into that.",
      "created_at" : "2019-04-02T12:24:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15719#issuecomment-478972074",
      "id" : 478972074,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15719",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3ODk3MjA3NA==",
      "updated_at" : "2019-04-02T12:24:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/478972074",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15719#discussion_r271292127"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15719"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271292127"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Mempool can change after the snapshot but before registering the interface and so those changes will be missed.",
      "commit_id" : "0ebc74e7636f6eadfde5685466c2b08065681702",
      "created_at" : "2019-04-02T13:05:07Z",
      "diff_hunk" : "@@ -358,22 +359,38 @@ class ChainImpl : public Chain\n     {\n         ::uiInterface.ShowProgress(title, progress, resume_possible);\n     }\n-    std::unique_ptr<Handler> handleNotifications(Notifications& notifications) override\n+    std::unique_ptr<Handler> handleNotifications(Notifications& notifications, SnapshotFn snapshot_fn) override\n     {\n-        return MakeUnique<NotificationsHandlerImpl>(*this, notifications);\n+        AssertLockNotHeld(::cs_main);\n+        AssertLockNotHeld(::mempool.cs);\n+\n+        // Declare packaged task to run in notification thread, and to first\n+        // send the snapshot before enabling subsequent notifications.\n+        std::vector<CTransactionRef> snapshot;\n+        std::packaged_task<std::unique_ptr<Handler>()> task([&] {\n+            if (snapshot_fn) snapshot_fn(std::move(snapshot));\n+            return MakeUnique<NotificationsHandlerImpl>(*this, notifications);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15719#discussion_r271292127",
      "id" : 271292127,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTI5MjEyNw==",
      "original_commit_id" : "10f92ce5c41a6936066f159012be72395385f282",
      "original_position" : 24,
      "path" : "src/interfaces/chain.cpp",
      "position" : 25,
      "pull_request_review_id" : 221643011,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15719",
      "updated_at" : "2019-04-11T10:03:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271292127",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15719#discussion_r271355792"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15719"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271355792"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/15719#discussion_r271169011\r\n\r\n> Could use LOCKS_EXCLUDED annotations for those?\r\n\r\nAdded annotations. Effect is kind of limited since this is an override and these mutexes aren't accessible where this is called in the wallet, but it still seems better to have these annotations than not.\r\n\r\nLonger term, after more changes like this and #15632, which reduce Chain::Lock usage, wallet code should stop holding these locks altogether.",
      "commit_id" : "0ebc74e7636f6eadfde5685466c2b08065681702",
      "created_at" : "2019-04-02T15:09:41Z",
      "diff_hunk" : "@@ -358,22 +359,38 @@ class ChainImpl : public Chain\n     {\n         ::uiInterface.ShowProgress(title, progress, resume_possible);\n     }\n-    std::unique_ptr<Handler> handleNotifications(Notifications& notifications) override\n+    std::unique_ptr<Handler> handleNotifications(Notifications& notifications, SnapshotFn snapshot_fn) override\n     {\n-        return MakeUnique<NotificationsHandlerImpl>(*this, notifications);\n+        AssertLockNotHeld(::cs_main);\n+        AssertLockNotHeld(::mempool.cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15719#discussion_r271355792",
      "id" : 271355792,
      "in_reply_to_id" : 271169011,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTM1NTc5Mg==",
      "original_commit_id" : "10f92ce5c41a6936066f159012be72395385f282",
      "original_position" : 17,
      "path" : "src/interfaces/chain.cpp",
      "position" : 18,
      "pull_request_review_id" : 221722990,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15719",
      "updated_at" : "2019-04-11T10:03:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271355792",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15719#discussion_r271355828"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15719"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271355828"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/15719#discussion_r271292127\r\n\r\n> Mempool can change after the snapshot but before registering the interface and so those changes will be missed.\r\n\r\nThis isn't true, and the comment below, \"Hold locks while scheduling the task so notifications about added and removed transactions after the snapshot arrive after the snapshot\" is specifically referring to this case.\r\n\r\nLet me know if I should make it more clear, but as long as the locks are held, transactions can't be added / removed by other threads, and as long as CallFunctionInValidationInterfaceQueue is called before transactions are added/removed, the handler will be registered before the queued notifications signal it.",
      "commit_id" : "0ebc74e7636f6eadfde5685466c2b08065681702",
      "created_at" : "2019-04-02T15:09:45Z",
      "diff_hunk" : "@@ -358,22 +359,38 @@ class ChainImpl : public Chain\n     {\n         ::uiInterface.ShowProgress(title, progress, resume_possible);\n     }\n-    std::unique_ptr<Handler> handleNotifications(Notifications& notifications) override\n+    std::unique_ptr<Handler> handleNotifications(Notifications& notifications, SnapshotFn snapshot_fn) override\n     {\n-        return MakeUnique<NotificationsHandlerImpl>(*this, notifications);\n+        AssertLockNotHeld(::cs_main);\n+        AssertLockNotHeld(::mempool.cs);\n+\n+        // Declare packaged task to run in notification thread, and to first\n+        // send the snapshot before enabling subsequent notifications.\n+        std::vector<CTransactionRef> snapshot;\n+        std::packaged_task<std::unique_ptr<Handler>()> task([&] {\n+            if (snapshot_fn) snapshot_fn(std::move(snapshot));\n+            return MakeUnique<NotificationsHandlerImpl>(*this, notifications);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15719#discussion_r271355828",
      "id" : 271355828,
      "in_reply_to_id" : 271292127,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTM1NTgyOA==",
      "original_commit_id" : "10f92ce5c41a6936066f159012be72395385f282",
      "original_position" : 24,
      "path" : "src/interfaces/chain.cpp",
      "position" : 25,
      "pull_request_review_id" : 221722990,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15719",
      "updated_at" : "2019-04-11T10:03:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271355828",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15719#discussion_r271375746"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15719"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271375746"
         }
      },
      "author_association" : "MEMBER",
      "body" : "But the queue can be non empty when CallFunctionInValidationInterfaceQueue is called?",
      "commit_id" : "0ebc74e7636f6eadfde5685466c2b08065681702",
      "created_at" : "2019-04-02T15:50:29Z",
      "diff_hunk" : "@@ -358,22 +359,38 @@ class ChainImpl : public Chain\n     {\n         ::uiInterface.ShowProgress(title, progress, resume_possible);\n     }\n-    std::unique_ptr<Handler> handleNotifications(Notifications& notifications) override\n+    std::unique_ptr<Handler> handleNotifications(Notifications& notifications, SnapshotFn snapshot_fn) override\n     {\n-        return MakeUnique<NotificationsHandlerImpl>(*this, notifications);\n+        AssertLockNotHeld(::cs_main);\n+        AssertLockNotHeld(::mempool.cs);\n+\n+        // Declare packaged task to run in notification thread, and to first\n+        // send the snapshot before enabling subsequent notifications.\n+        std::vector<CTransactionRef> snapshot;\n+        std::packaged_task<std::unique_ptr<Handler>()> task([&] {\n+            if (snapshot_fn) snapshot_fn(std::move(snapshot));\n+            return MakeUnique<NotificationsHandlerImpl>(*this, notifications);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15719#discussion_r271375746",
      "id" : 271375746,
      "in_reply_to_id" : 271292127,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTM3NTc0Ng==",
      "original_commit_id" : "10f92ce5c41a6936066f159012be72395385f282",
      "original_position" : 24,
      "path" : "src/interfaces/chain.cpp",
      "position" : 25,
      "pull_request_review_id" : 221748475,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15719",
      "updated_at" : "2019-04-11T10:03:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271375746",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15719#discussion_r271384607"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15719"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271384607"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/15719#discussion_r271375746\r\n\r\n> But the queue can be non empty when CallFunctionInValidationInterfaceQueue is called?\r\n\r\nI think you are referring to a different problem now (problem of old notifications being received when they shouldn't be, which is different from the problem of new notifications not being received when they should be). The problem of old notifications being received when they shouldn't be is what happens without this PR in the current code:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/2c364fde423e74b4e03ebcff4582a9db7a6c4e4b/src/interfaces/chain.h#L273-L281\r\n\r\nThe problem is fixed by this PR by not constructing NotificationsHandlerImpl until after snapshot_fn is called. The comment there \"to first send the snapshot before enabling subsequent notifications\" is about this.",
      "commit_id" : "0ebc74e7636f6eadfde5685466c2b08065681702",
      "created_at" : "2019-04-02T16:10:27Z",
      "diff_hunk" : "@@ -358,22 +359,38 @@ class ChainImpl : public Chain\n     {\n         ::uiInterface.ShowProgress(title, progress, resume_possible);\n     }\n-    std::unique_ptr<Handler> handleNotifications(Notifications& notifications) override\n+    std::unique_ptr<Handler> handleNotifications(Notifications& notifications, SnapshotFn snapshot_fn) override\n     {\n-        return MakeUnique<NotificationsHandlerImpl>(*this, notifications);\n+        AssertLockNotHeld(::cs_main);\n+        AssertLockNotHeld(::mempool.cs);\n+\n+        // Declare packaged task to run in notification thread, and to first\n+        // send the snapshot before enabling subsequent notifications.\n+        std::vector<CTransactionRef> snapshot;\n+        std::packaged_task<std::unique_ptr<Handler>()> task([&] {\n+            if (snapshot_fn) snapshot_fn(std::move(snapshot));\n+            return MakeUnique<NotificationsHandlerImpl>(*this, notifications);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15719#discussion_r271384607",
      "id" : 271384607,
      "in_reply_to_id" : 271292127,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTM4NDYwNw==",
      "original_commit_id" : "10f92ce5c41a6936066f159012be72395385f282",
      "original_position" : 24,
      "path" : "src/interfaces/chain.cpp",
      "position" : 25,
      "pull_request_review_id" : 221760023,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15719",
      "updated_at" : "2019-04-11T10:03:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271384607",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15719#discussion_r271409110"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15719"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271409110"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`AddToProcessQueue` tricked me, what really goes to that queue are notifications.",
      "commit_id" : "0ebc74e7636f6eadfde5685466c2b08065681702",
      "created_at" : "2019-04-02T17:12:10Z",
      "diff_hunk" : "@@ -358,22 +359,38 @@ class ChainImpl : public Chain\n     {\n         ::uiInterface.ShowProgress(title, progress, resume_possible);\n     }\n-    std::unique_ptr<Handler> handleNotifications(Notifications& notifications) override\n+    std::unique_ptr<Handler> handleNotifications(Notifications& notifications, SnapshotFn snapshot_fn) override\n     {\n-        return MakeUnique<NotificationsHandlerImpl>(*this, notifications);\n+        AssertLockNotHeld(::cs_main);\n+        AssertLockNotHeld(::mempool.cs);\n+\n+        // Declare packaged task to run in notification thread, and to first\n+        // send the snapshot before enabling subsequent notifications.\n+        std::vector<CTransactionRef> snapshot;\n+        std::packaged_task<std::unique_ptr<Handler>()> task([&] {\n+            if (snapshot_fn) snapshot_fn(std::move(snapshot));\n+            return MakeUnique<NotificationsHandlerImpl>(*this, notifications);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15719#discussion_r271409110",
      "id" : 271409110,
      "in_reply_to_id" : 271292127,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTQwOTExMA==",
      "original_commit_id" : "10f92ce5c41a6936066f159012be72395385f282",
      "original_position" : 24,
      "path" : "src/interfaces/chain.cpp",
      "position" : 25,
      "pull_request_review_id" : 221791281,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15719",
      "updated_at" : "2019-04-11T10:03:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271409110",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15719#discussion_r271410636"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15719"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271410636"
         }
      },
      "author_association" : "MEMBER",
      "body" : "also \"arrive after task() is called\" right?",
      "commit_id" : "0ebc74e7636f6eadfde5685466c2b08065681702",
      "created_at" : "2019-04-02T17:16:02Z",
      "diff_hunk" : "@@ -358,22 +359,39 @@ class ChainImpl : public Chain\n     {\n         ::uiInterface.ShowProgress(title, progress, resume_possible);\n     }\n-    std::unique_ptr<Handler> handleNotifications(Notifications& notifications) override\n+    std::unique_ptr<Handler> handleNotifications(Notifications& notifications, SnapshotFn snapshot_fn) override\n+        LOCKS_EXCLUDED(::cs_main, ::mempool.cs)\n     {\n-        return MakeUnique<NotificationsHandlerImpl>(*this, notifications);\n+        AssertLockNotHeld(::cs_main);\n+        AssertLockNotHeld(::mempool.cs);\n+\n+        // Declare packaged task to run in notification thread, and to first\n+        // send the snapshot before enabling subsequent notifications.\n+        std::vector<CTransactionRef> snapshot;\n+        std::packaged_task<std::unique_ptr<Handler>()> task([&] {\n+            if (snapshot_fn) snapshot_fn(std::move(snapshot));\n+            return MakeUnique<NotificationsHandlerImpl>(*this, notifications);\n+        });\n+\n+        // Snapshot mempool transactions, then schedule the task to execute.\n+        // Hold locks while scheduling the task so notifications about added and\n+        // removed transactions after the snapshot arrive after the snapshot.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15719#discussion_r271410636",
      "id" : 271410636,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTQxMDYzNg==",
      "original_commit_id" : "5f593ab2e1dd52a50062abffbbe5e601fea165a8",
      "original_position" : 30,
      "path" : "src/interfaces/chain.cpp",
      "position" : null,
      "pull_request_review_id" : 221791281,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15719",
      "updated_at" : "2019-04-11T10:03:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271410636",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15719#discussion_r271430419"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15719"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271430419"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/15719#discussion_r271410636\r\n\r\n> also \"arrive after task() is called\" right?\r\n\r\nYes task() is what sends the snapshot, so that's what this is referring to. Replaced \"transactions after the snapshot arrive after the snapshot\" with \"transactions after taking the snapshot arrive after the snapshot callback in task()\" to reference it and be more specific.",
      "commit_id" : "0ebc74e7636f6eadfde5685466c2b08065681702",
      "created_at" : "2019-04-02T18:04:40Z",
      "diff_hunk" : "@@ -358,22 +359,39 @@ class ChainImpl : public Chain\n     {\n         ::uiInterface.ShowProgress(title, progress, resume_possible);\n     }\n-    std::unique_ptr<Handler> handleNotifications(Notifications& notifications) override\n+    std::unique_ptr<Handler> handleNotifications(Notifications& notifications, SnapshotFn snapshot_fn) override\n+        LOCKS_EXCLUDED(::cs_main, ::mempool.cs)\n     {\n-        return MakeUnique<NotificationsHandlerImpl>(*this, notifications);\n+        AssertLockNotHeld(::cs_main);\n+        AssertLockNotHeld(::mempool.cs);\n+\n+        // Declare packaged task to run in notification thread, and to first\n+        // send the snapshot before enabling subsequent notifications.\n+        std::vector<CTransactionRef> snapshot;\n+        std::packaged_task<std::unique_ptr<Handler>()> task([&] {\n+            if (snapshot_fn) snapshot_fn(std::move(snapshot));\n+            return MakeUnique<NotificationsHandlerImpl>(*this, notifications);\n+        });\n+\n+        // Snapshot mempool transactions, then schedule the task to execute.\n+        // Hold locks while scheduling the task so notifications about added and\n+        // removed transactions after the snapshot arrive after the snapshot.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15719#discussion_r271430419",
      "id" : 271430419,
      "in_reply_to_id" : 271410636,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTQzMDQxOQ==",
      "original_commit_id" : "5f593ab2e1dd52a50062abffbbe5e601fea165a8",
      "original_position" : 30,
      "path" : "src/interfaces/chain.cpp",
      "position" : null,
      "pull_request_review_id" : 221817666,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15719",
      "updated_at" : "2019-04-11T10:03:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271430419",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Should we assert cs_main is held in the relevant validation interface notifications?",
      "created_at" : "2019-04-02T20:07:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15719#issuecomment-479177413",
      "id" : 479177413,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15719",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3OTE3NzQxMw==",
      "updated_at" : "2019-04-02T20:07:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/479177413",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/15719#issuecomment-479177413\r\n\r\n> Should we assert cs_main is held in the relevant validation interface notifications?\r\n\r\n`cs_main` can be acquired inside notification callbacks, if necessary, but it is not held when these notifications happen. This PR and #15632 disentangle notifications and locking, so locks are never held when notifications are received (right now they are inconsistently held in some cases but not others). \r\n\r\nRemoving locking from notifications is a step toward eventually removing Chain::Lock completely, and having the wallet just asynchronously process notifications without being able to hold on to `cs_main`.",
      "created_at" : "2019-04-02T20:24:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15719#issuecomment-479184766",
      "id" : 479184766,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15719",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3OTE4NDc2Ng==",
      "updated_at" : "2019-04-02T20:24:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/479184766",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Sorry for not being clear. I mean that `cs_main` is locked when `GetMainSignals().TransactionAddedToMempool()` is called, and it is important that doesn't change, by adding:\r\n```diff\r\n@@ -152,6 +152,8 @@ void CMainSignals::UpdatedBlockTip(const CBlockIndex *pindexNew, const CBlockInd\r\n }\r\n\r\n void CMainSignals::TransactionAddedToMempool(const CTransactionRef &ptx) {\r\n+    AssertLockHeld(::cs_main);\r\n+    AssertLockHeld(::mempool.cs);\r\n     m_internals->m_schedulerClient.AddToProcessQueue([ptx, this] {\r\n         m_internals->TransactionAddedToMempool(ptx);\r\n     });\r\n```",
      "created_at" : "2019-04-03T13:35:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15719#issuecomment-479491609",
      "id" : 479491609,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15719",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3OTQ5MTYwOQ==",
      "updated_at" : "2019-04-03T13:35:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/479491609",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2019-04-09T22:25:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15719#issuecomment-481463048",
      "id" : 481463048,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15719",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4MTQ2MzA0OA==",
      "updated_at" : "2019-04-09T22:25:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/481463048",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK\r\n\r\n> Mempool transactions are sent in a single IPC call instead of in a loop calling an IPC method repeatedly.\r\n\r\nDo we know what this does to memory usage if there's a very large mempool (either at startup when starting one or multiple wallets, or when loading a wallet dynamically during runtime)?",
      "created_at" : "2019-04-11T21:00:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15719#issuecomment-482312004",
      "id" : 482312004,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15719",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4MjMxMjAwNA==",
      "updated_at" : "2019-04-11T21:00:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/482312004",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Do we know what this does to memory usage if there's a very large mempool (either at startup when starting one or multiple wallets, or when loading a wallet dynamically during runtime)?\r\n\r\nWith this PR by itself, a new temporary vector with one pointer per mempool transaction is created when a wallet is loaded. It's something to consider, but probably not likely to cause problems.\r\n\r\nWith this PR combined with #10102 and running `bitcoin-node` with a wallet loading in a different process, this will use significantly more memory, because serializing the vector serializes all the transactions at once in memory before sending them. This might be about as expensive as a `getrawmempool` call. If this is a problem, the `snapshot_fn` callback could be tweaked to send the transactions in batches. I guess I wouldn't want to try to optimize this prematurely, though.\r\n\r\nSince I did write this PR \"Improves performance over IPC\" in the description, the increased memory usage might factor into that. But to be sure, the motivation for this PR is mainly to make notifications show up cleanly and in order on the client side.",
      "created_at" : "2019-04-11T21:49:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15719#issuecomment-482334255",
      "id" : 482334255,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15719",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4MjMzNDI1NQ==",
      "updated_at" : "2019-04-11T21:49:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/482334255",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15719#discussion_r274932794"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15719"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274932794"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@jnewbery points out that it is too early to handle mempool transactions here at this point, because the rescan hasn't happened yet. Processing a mempool transaction before the rescan could result in the `IsFromMe` check in `AddToWalletIfInvolvingMe` failing to add the transaction to the walelt when it depends on a block that hasn't been scanned yet.\r\n\r\nSo the mempool loop here needs to be moved below and will require some changes to locking, since handleNotifications in this PR can't be called with cs_main (it would deadlock).",
      "commit_id" : "0ebc74e7636f6eadfde5685466c2b08065681702",
      "created_at" : "2019-04-12T14:33:46Z",
      "diff_hunk" : "@@ -4213,6 +4215,17 @@ std::shared_ptr<CWallet> CWallet::CreateWalletFromFile(interfaces::Chain& chain,\n     // Try to top up keypool. No-op if the wallet is locked.\n     walletInstance->TopUpKeyPool();\n \n+    // Register with the validation interface. Skip requesting mempool transactions if wallet is empty.\n+    interfaces::Chain::SnapshotFn snapshot_fn;\n+    if (!fFirstRun) {\n+        snapshot_fn = [walletInstance](std::vector<CTransactionRef> mempool_txs) {\n+            for (const auto& mempool_tx : mempool_txs) {\n+                walletInstance->TransactionAddedToMempool(mempool_tx);\n+            }\n+        };\n+    }\n+    walletInstance->m_chain_notifications_handler = chain.handleNotifications(*walletInstance, snapshot_fn);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15719#discussion_r274932794",
      "id" : 274932794,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NDkzMjc5NA==",
      "original_commit_id" : "0ebc74e7636f6eadfde5685466c2b08065681702",
      "original_position" : 46,
      "path" : "src/wallet/wallet.cpp",
      "position" : 46,
      "pull_request_review_id" : 226115629,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15719",
      "updated_at" : "2019-04-12T14:33:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274932794",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15719#discussion_r274934195"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15719"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274934195"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think moving the sync-from-mempool function to above the initial rescan breaks the (undocumented) expectation that the wallet is notified of transactions in dependency order. In fact, this was slightly broken by #15652, but this PR makes it worse.\r\n\r\nPrior to dynamically-loaded wallets, the wallet would always receive a transaction after it had received all of that transaction's ancestors. That wallet relies on that expectation:\r\n\r\n- `CWallet::IsFromMe()` will only match on a transaction if its parent is already in the wallet.\r\n- `nTimeSmart` should be monotonically increasing for transaction descendency. If transactions arrive in the wrong order then this is no longer true, and they'll be shown out-of-order in the GUI.\r\n\r\nSince #10740, a wallet could receive mempool transactions out-of-order (since a newly loaded wallet would not be notified of transactions in the mempool, but could be notified of their descendant transactions when they arrive).  #15652 improved the situtation by notifying the wallet of all mempool transactions, but didn't sort them first, so a wallet could still be notified of the mempool txs in the wrong order. This PR potentially makes things worse by notifying the wallet of mempool txs before the blocks which could contain the mempool txs' ancestors.\r\n\r\nI think to fix this, we need to:\r\n- move the sync-from-mempool to after the rescan call, while cs_main is still held\r\n- sort the mempool txs by using `mempool.infoAll()` before notifying the wallet.\r\n\r\nWe should also document that the wallet expects to see transactions in order!",
      "commit_id" : "0ebc74e7636f6eadfde5685466c2b08065681702",
      "created_at" : "2019-04-12T14:36:43Z",
      "diff_hunk" : "@@ -4213,6 +4215,17 @@ std::shared_ptr<CWallet> CWallet::CreateWalletFromFile(interfaces::Chain& chain,\n     // Try to top up keypool. No-op if the wallet is locked.\n     walletInstance->TopUpKeyPool();\n \n+    // Register with the validation interface. Skip requesting mempool transactions if wallet is empty.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15719#discussion_r274934195",
      "id" : 274934195,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NDkzNDE5NQ==",
      "original_commit_id" : "0ebc74e7636f6eadfde5685466c2b08065681702",
      "original_position" : 37,
      "path" : "src/wallet/wallet.cpp",
      "position" : 37,
      "pull_request_review_id" : 226117444,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15719",
      "updated_at" : "2019-04-12T14:36:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274934195",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15719#discussion_r274946683"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15719"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274946683"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I also wonder if there could brokenness in the case where a reorg happens during a `rescanblockchain` or `importmulti` RPC call (these rescans are different because cs_main isn't held the whole time).",
      "commit_id" : "0ebc74e7636f6eadfde5685466c2b08065681702",
      "created_at" : "2019-04-12T15:03:53Z",
      "diff_hunk" : "@@ -4213,6 +4215,17 @@ std::shared_ptr<CWallet> CWallet::CreateWalletFromFile(interfaces::Chain& chain,\n     // Try to top up keypool. No-op if the wallet is locked.\n     walletInstance->TopUpKeyPool();\n \n+    // Register with the validation interface. Skip requesting mempool transactions if wallet is empty.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15719#discussion_r274946683",
      "id" : 274946683,
      "in_reply_to_id" : 274934195,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NDk0NjY4Mw==",
      "original_commit_id" : "0ebc74e7636f6eadfde5685466c2b08065681702",
      "original_position" : 37,
      "path" : "src/wallet/wallet.cpp",
      "position" : 37,
      "pull_request_review_id" : 226133835,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15719",
      "updated_at" : "2019-04-12T15:03:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274946683",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   }
]
