[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n",
      "created_at" : "2022-11-23T15:13:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#issuecomment-1325231872",
      "id" : 1325231872,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26560",
      "node_id" : "IC_kwDOABII585O_W8A",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1325231872/reactions"
      },
      "updated_at" : "2022-11-23T15:13:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1325231872",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1030669464"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1030669464"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 7f6abb39159cd55b6c9193630ca4c3d9ae551be6 \"wallet: bugfix, 'CoinsResult::Erase' is erasing only one output of the set\"\r\n\r\nHow come we need to have `coins_to_remove` and erase the removed coins from it? `coins_to_remove` isn't being used anywhere else so this doesn't seem to be doing anything?",
      "commit_id" : "0fd9be14af28a5c707f2d5be03d252d2b5cb7ad7",
      "created_at" : "2022-11-23T16:39:27Z",
      "diff_hunk" : "@@ -102,15 +102,19 @@ void CoinsResult::Clear() {\n     coins.clear();\n }\n \n-void CoinsResult::Erase(std::set<COutPoint>& preset_coins)\n+void CoinsResult::Erase(const std::set<COutPoint>& outs)\n {\n-    for (auto& it : coins) {\n-        auto& vec = it.second;\n-        auto i = std::find_if(vec.begin(), vec.end(), [&](const COutput &c) { return preset_coins.count(c.outpoint);});\n-        if (i != vec.end()) {\n-            vec.erase(i);\n-            break;\n-        }\n+    std::set<COutPoint> coins_to_remove = outs;\n+    for (auto& [type, vec] : coins) {\n+        auto remove_it = std::remove_if(vec.begin(), vec.end(), [&](const COutput& coin) {\n+            auto it = coins_to_remove.find(coin.outpoint);\n+            if (it == coins_to_remove.end()) return false;\n+\n+            // remove coin\n+            coins_to_remove.erase(it);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1030669464",
      "id" : 1030669464,
      "line" : 114,
      "node_id" : "PRRC_kwDOABII5849bsSY",
      "original_commit_id" : "7f6abb39159cd55b6c9193630ca4c3d9ae551be6",
      "original_line" : 114,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 21,
      "pull_request_review_id" : 1191984507,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1030669464/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-23T16:39:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1030669464",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1030884532"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1030884532"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It's to decrease the search time while moving across the `CoinsResult` vectors.\r\n\r\n`Erase` receives a const set with all the coins that needs to be removed from the `CoinsResult` internal vectors. So, what we do is loop across each coins vector and, for each coin inside them, **we test whether the coin is inside the set of coins provided by the caller**, if it's there, then we update the internal state and return true so `std:.remove_if` does its magic.\r\n(bolded the important part)\r\n\r\nSo, if we remove coins as we find them on the `CoinsResult` vectors from the to_remove set, we will continually search inside a container with less elements up until there is none and we can stop the search earlier.",
      "commit_id" : "0fd9be14af28a5c707f2d5be03d252d2b5cb7ad7",
      "created_at" : "2022-11-23T21:30:33Z",
      "diff_hunk" : "@@ -102,15 +102,19 @@ void CoinsResult::Clear() {\n     coins.clear();\n }\n \n-void CoinsResult::Erase(std::set<COutPoint>& preset_coins)\n+void CoinsResult::Erase(const std::set<COutPoint>& outs)\n {\n-    for (auto& it : coins) {\n-        auto& vec = it.second;\n-        auto i = std::find_if(vec.begin(), vec.end(), [&](const COutput &c) { return preset_coins.count(c.outpoint);});\n-        if (i != vec.end()) {\n-            vec.erase(i);\n-            break;\n-        }\n+    std::set<COutPoint> coins_to_remove = outs;\n+    for (auto& [type, vec] : coins) {\n+        auto remove_it = std::remove_if(vec.begin(), vec.end(), [&](const COutput& coin) {\n+            auto it = coins_to_remove.find(coin.outpoint);\n+            if (it == coins_to_remove.end()) return false;\n+\n+            // remove coin\n+            coins_to_remove.erase(it);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1030884532",
      "id" : 1030884532,
      "in_reply_to_id" : 1030669464,
      "line" : 114,
      "node_id" : "PRRC_kwDOABII5849cgy0",
      "original_commit_id" : "7f6abb39159cd55b6c9193630ca4c3d9ae551be6",
      "original_line" : 114,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 21,
      "pull_request_review_id" : 1192284295,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1030884532/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-23T21:30:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1030884532",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1030894873"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1030894873"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think that's really a useful optimization since `outs` is likely to be very small. If we are concerned about the complexity of `find`, then I think it would be better to use an `unordered_set` rather than erasing after each removal.\r\n\r\nThis isn't really a blocking comment, I just found it a bit confusing.",
      "commit_id" : "0fd9be14af28a5c707f2d5be03d252d2b5cb7ad7",
      "created_at" : "2022-11-23T21:50:56Z",
      "diff_hunk" : "@@ -102,15 +102,19 @@ void CoinsResult::Clear() {\n     coins.clear();\n }\n \n-void CoinsResult::Erase(std::set<COutPoint>& preset_coins)\n+void CoinsResult::Erase(const std::set<COutPoint>& outs)\n {\n-    for (auto& it : coins) {\n-        auto& vec = it.second;\n-        auto i = std::find_if(vec.begin(), vec.end(), [&](const COutput &c) { return preset_coins.count(c.outpoint);});\n-        if (i != vec.end()) {\n-            vec.erase(i);\n-            break;\n-        }\n+    std::set<COutPoint> coins_to_remove = outs;\n+    for (auto& [type, vec] : coins) {\n+        auto remove_it = std::remove_if(vec.begin(), vec.end(), [&](const COutput& coin) {\n+            auto it = coins_to_remove.find(coin.outpoint);\n+            if (it == coins_to_remove.end()) return false;\n+\n+            // remove coin\n+            coins_to_remove.erase(it);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1030894873",
      "id" : 1030894873,
      "in_reply_to_id" : 1030669464,
      "line" : 114,
      "node_id" : "PRRC_kwDOABII5849cjUZ",
      "original_commit_id" : "7f6abb39159cd55b6c9193630ca4c3d9ae551be6",
      "original_line" : 114,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 21,
      "pull_request_review_id" : 1192298629,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1030894873/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-23T21:50:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1030894873",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1030960317"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1030960317"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yeah, an `unordered_set` sounds good too.\r\n\r\nstill, what I wanted to add (and I actually didn't add it for some reason..) is the capability to stop early if the set has no elements. E.g. if the wallet has 100k UTXO inside, the preset inputs set is small, and the coins appear early in the loop: the process could stop right away (no need to keep traversing the entire available coins vector if we already found them).\r\n\r\nbut.. as this is primarily to solve the dangerous bug in v24. Could go ahead with the `unordered_set`, make the code simpler, and leave any optimization for later.",
      "commit_id" : "f20f88f60e87867e755507dc6e59a5cd80e3c3a9",
      "created_at" : "2022-11-24T00:27:15Z",
      "diff_hunk" : "@@ -102,15 +102,19 @@ void CoinsResult::Clear() {\n     coins.clear();\n }\n \n-void CoinsResult::Erase(std::set<COutPoint>& preset_coins)\n+void CoinsResult::Erase(const std::set<COutPoint>& outs)\n {\n-    for (auto& it : coins) {\n-        auto& vec = it.second;\n-        auto i = std::find_if(vec.begin(), vec.end(), [&](const COutput &c) { return preset_coins.count(c.outpoint);});\n-        if (i != vec.end()) {\n-            vec.erase(i);\n-            break;\n-        }\n+    std::set<COutPoint> coins_to_remove = outs;\n+    for (auto& [type, vec] : coins) {\n+        auto remove_it = std::remove_if(vec.begin(), vec.end(), [&](const COutput& coin) {\n+            auto it = coins_to_remove.find(coin.outpoint);\n+            if (it == coins_to_remove.end()) return false;\n+\n+            // remove coin\n+            coins_to_remove.erase(it);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1030960317",
      "id" : 1030960317,
      "in_reply_to_id" : 1030669464,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5849czS9",
      "original_commit_id" : "7f6abb39159cd55b6c9193630ca4c3d9ae551be6",
      "original_line" : 114,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : null,
      "pull_request_review_id" : 1192391348,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1030960317/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-24T00:33:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1030960317",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1032802753"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1032802753"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Is locking here necessary? Can we just fund the wallets with 2 coins instead of 10?",
      "commit_id" : "f20f88f60e87867e755507dc6e59a5cd80e3c3a9",
      "created_at" : "2022-11-26T15:45:22Z",
      "diff_hunk" : "@@ -1200,6 +1201,63 @@ def test_add_inputs_default_value(self):\n \n         self.nodes[2].unloadwallet(\"test_preset_inputs\")\n \n+    def test_preset_inputs_selection_crash(self):\n+        self.log.info('Test wallet preset inputs selection')\n+\n+        # Here will confuse the wallet to make it select the\n+        # preset inputs twice during the coin selection process (on v24.0).\n+        #\n+        # Making it think that the selection process result covers\n+        # the entire tx target when it does not. It's actually creating\n+        # a tx that sends more coins than what inputs are covering for.\n+        #\n+        # Which, combined with the subtract fee from outputs option,\n+        # makes the wallet generate and broadcast a tx that pays\n+        # up to the sum of all the preset inputs, minus one, amounts in fee!\n+\n+        # Create and fund the wallet with 10 UTXO of 5 BTC each\n+        self.nodes[2].createwallet(\"test_preset_inputs_selection\")\n+        wallet = self.nodes[2].get_wallet_rpc(\"test_preset_inputs_selection\")\n+        outputs = {}\n+        for _ in range(10):\n+            outputs[wallet.getnewaddress(address_type=\"bech32\")] = 5\n+        self.nodes[0].sendmany(\"\", outputs)\n+        self.generate(self.nodes[0], 1)\n+\n+        # Select the preset inputs and lock the rest of the coins",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1032802753",
      "id" : 1032802753,
      "line" : 1227,
      "node_id" : "PRRC_kwDOABII5849j1HB",
      "original_commit_id" : "f20f88f60e87867e755507dc6e59a5cd80e3c3a9",
      "original_line" : 1227,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "test/functional/rpc_fundrawtransaction.py",
      "position" : 35,
      "pull_request_review_id" : 1194885937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1032802753/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-26T17:33:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1032802753",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1032807770"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1032807770"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Same question here. Do we really need to lock the coins? ",
      "commit_id" : "f20f88f60e87867e755507dc6e59a5cd80e3c3a9",
      "created_at" : "2022-11-26T16:33:35Z",
      "diff_hunk" : "@@ -112,5 +112,38 @@ BOOST_FIXTURE_TEST_CASE(FillInputToWeightTest, BasicTestingSetup)\n     // Note: We don't test the next boundary because of memory allocation constraints.\n }\n \n+BOOST_FIXTURE_TEST_CASE(wallet_duplicated_preset_inputs_test, TestChain100Setup)\n+{\n+    // Verifies that the wallet's Coin Selection process does not include pre-selected inputs twice in a transaction.\n+    for (int i = 0; i < 10; i++) CreateAndProcessBlock({}, GetScriptForRawPubKey(coinbaseKey.GetPubKey()));\n+    auto wallet = CreateSyncedWallet(*m_node.chain, WITH_LOCK(Assert(m_node.chainman)->GetMutex(), return m_node.chainman->ActiveChain()), m_args, coinbaseKey);\n+\n+    LOCK(wallet->cs_wallet);\n+    auto available_coins = AvailableCoins(*wallet);\n+    std::vector<COutput> coins = available_coins.All();\n+    std::set<COutPoint> preset_inputs = {coins[0].outpoint, coins[1].outpoint};\n+    // Lock the rest of the coins",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1032807770",
      "id" : 1032807770,
      "line" : 125,
      "node_id" : "PRRC_kwDOABII5849j2Va",
      "original_commit_id" : "d8e195bc3d1ec46b874e70374b0d68698d442683",
      "original_line" : 125,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/wallet/test/spend_tests.cpp",
      "position" : 14,
      "pull_request_review_id" : 1194885937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1032807770/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-26T17:33:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1032807770",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1032808028"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1032808028"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: I'm not sure having second test provides enough extra value. I'd rather keep one, but ultimately up to you.",
      "commit_id" : "f20f88f60e87867e755507dc6e59a5cd80e3c3a9",
      "created_at" : "2022-11-26T16:36:00Z",
      "diff_hunk" : "@@ -112,5 +112,38 @@ BOOST_FIXTURE_TEST_CASE(FillInputToWeightTest, BasicTestingSetup)\n     // Note: We don't test the next boundary because of memory allocation constraints.\n }\n \n+BOOST_FIXTURE_TEST_CASE(wallet_duplicated_preset_inputs_test, TestChain100Setup)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1032808028",
      "id" : 1032808028,
      "line" : 115,
      "node_id" : "PRRC_kwDOABII5849j2Zc",
      "original_commit_id" : "d8e195bc3d1ec46b874e70374b0d68698d442683",
      "original_line" : 115,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/test/spend_tests.cpp",
      "position" : 4,
      "pull_request_review_id" : 1194885937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1032808028/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-26T17:33:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1032808028",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1032811592"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1032811592"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't think it's correct to fallback on `available_coins.total_amount` when we don't do SFFO.\r\n\r\nwith SFFO we must have effective amount, if we don't - something went wrong.",
      "commit_id" : "f20f88f60e87867e755507dc6e59a5cd80e3c3a9",
      "created_at" : "2022-11-26T17:09:24Z",
      "diff_hunk" : "@@ -575,6 +584,14 @@ std::optional<SelectionResult> SelectCoins(const CWallet& wallet, CoinsResult& a\n         return result;\n     }\n \n+    // Return early if we cannot cover the target with the wallet's UTXO.\n+    // We use the total effective value if we are not subtracting fee from outputs and 'available_coins' contains the data.\n+    CAmount available_coins_total_amount = coin_selection_params.m_subtract_fee_outputs ? available_coins.total_amount :\n+            (available_coins.total_effective_amount.has_value() ? *available_coins.total_effective_amount : available_coins.total_amount);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1032811592",
      "id" : 1032811592,
      "line" : 590,
      "node_id" : "PRRC_kwDOABII5849j3RI",
      "original_commit_id" : "f20f88f60e87867e755507dc6e59a5cd80e3c3a9",
      "original_line" : 590,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 43,
      "pull_request_review_id" : 1194885937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1032811592/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-26T17:33:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1032811592",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1032813025"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1032813025"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "note to self: not a huge fan of how this looks like with `optional`. The code would look much simpler if we can just always pass a fee rate to `AvailableCoins` (we can set it 0 by default). Can't make my mind which way is better...",
      "commit_id" : "f20f88f60e87867e755507dc6e59a5cd80e3c3a9",
      "created_at" : "2022-11-26T17:24:38Z",
      "diff_hunk" : "@@ -51,8 +51,10 @@ struct CoinsResult {\n     void Shuffle(FastRandomContext& rng_fast);\n     void Add(OutputType type, const COutput& out);\n \n-    /** Sum of all available coins */\n+    /** Sum of all available coins raw value */\n     CAmount total_amount{0};\n+    /** Sum of all available coins effective value (each output value minus fees required to spend it) */\n+    std::optional<CAmount> total_effective_amount{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26560#discussion_r1032813025",
      "id" : 1032813025,
      "line" : 57,
      "node_id" : "PRRC_kwDOABII5849j3nh",
      "original_commit_id" : "f20f88f60e87867e755507dc6e59a5cd80e3c3a9",
      "original_line" : 57,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/wallet/spend.h",
      "position" : 8,
      "pull_request_review_id" : 1194885937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26560",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1032813025/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-26T17:33:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1032813025",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   }
]
