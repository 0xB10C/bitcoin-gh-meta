{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "MEMBER",
   "body" : "Here I confuse the wallet to make it select the preset\r\ninputs twice during the coin selection process (on v24.0).\r\n\r\nMaking it think that the selection process result covers\r\nthe entire tx target when it does not. It's actually creating\r\na tx that sends more coins than what inputs are covering for.\r\n\r\nWhich, combined with the subtract fee from outputs option,\r\nmakes the wallet generate and broadcast a tx that pays\r\nup to the sum of all the preset inputs, minus one, amounts in fee :(.\r\n\r\n### Technical Explanation\r\n\r\nThe reason why this happens is that the `CoinsResult::Erase`\r\nmethod is removing only one output from the available coins\r\nvector (there is a [loop break](https://github.com/bitcoin/bitcoin/blob/c1061be14a515b0ed4f4d646fcd0378c62e6ded3/src/wallet/spend.cpp#L112) that should have never been\r\nthere) and not all the preset inputs.\r\n\r\nWhich makes the Coin Selection process receive the preset\r\ninputs inside the selectable coins **and** inside the preset\r\ninputs vector. \r\nWhich is not good, because we merge the preset inputs inside\r\nthe automatic Coin Selection result manually at the end of the\r\nprocess, so this result can already contain the preset inputs.\r\n\r\nSo.. this ends up with the Coin Selection result having less\r\ninputs selected and not covering the entire target amount.\r\nWhich, alone, makes the wallet crash inside the \"insane fee\" assertion.\r\n\r\nBut.. to make it worst, adding the subtract fee from output functionality\r\nto this mix ends up with the wallet by-passing the \"insane\" fee assertion,\r\ndecreasing the output amount to fulfill the insane fee, and.. sadly,\r\nbroadcasting the tx to the network.\r\n\r\n### Important Note\r\n\r\nThis is only a problem for v24.0 and not in master.\r\nSince #25685, we no longer use the `CoinsResult::Erase` method inside\r\nthe Coin Selection Process.",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 1,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26559/comments",
   "created_at" : "2022-11-23T15:03:20Z",
   "draft" : false,
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26559/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/26559",
   "id" : 1461923091,
   "labels" : [
      {
         "color" : "08a781",
         "default" : false,
         "description" : null,
         "id" : 149424,
         "name" : "Wallet",
         "node_id" : "MDU6TGFiZWwxNDk0MjQ=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Wallet"
      },
      {
         "color" : "dd7200",
         "default" : false,
         "description" : "",
         "id" : 390024790,
         "name" : "Backport",
         "node_id" : "MDU6TGFiZWwzOTAwMjQ3OTA=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Backport"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26559/labels{/name}",
   "locked" : false,
   "milestone" : {
      "closed_at" : null,
      "closed_issues" : 2,
      "created_at" : "2022-11-17T10:40:26Z",
      "creator" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      },
      "description" : null,
      "due_on" : null,
      "html_url" : "https://github.com/bitcoin/bitcoin/milestone/58",
      "id" : 8664975,
      "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/milestones/58/labels",
      "node_id" : "MI_kwDOABII584AhDeP",
      "number" : 58,
      "open_issues" : 2,
      "state" : "open",
      "title" : "24.1",
      "updated_at" : "2022-11-23T15:06:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/milestones/58"
   },
   "node_id" : "PR_kwDOABII585DkjHc",
   "number" : 26559,
   "performed_via_github_app" : null,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/26559.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26559",
      "merged_at" : null,
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/26559.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26559"
   },
   "reactions" : {
      "+1" : 0,
      "-1" : 0,
      "confused" : 0,
      "eyes" : 0,
      "heart" : 0,
      "hooray" : 0,
      "laugh" : 0,
      "rocket" : 0,
      "total_count" : 0,
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26559/reactions"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "state_reason" : null,
   "timeline_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26559/timeline",
   "title" : "[24.x] wallet: bugfix, insane fee tx creation due duplicated selection of the preset inputs",
   "updated_at" : "2022-11-23T16:30:16Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26559",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
      "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
      "followers_url" : "https://api.github.com/users/furszy/followers",
      "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
      "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/furszy",
      "id" : 5377650,
      "login" : "furszy",
      "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
      "organizations_url" : "https://api.github.com/users/furszy/orgs",
      "received_events_url" : "https://api.github.com/users/furszy/received_events",
      "repos_url" : "https://api.github.com/users/furszy/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/furszy"
   }
}
