{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "NONE",
   "body" : "**Bug 1:** If the daemon does not have enough file descriptors (we'll call them FDs), it is not asserted. \r\nThe daemon only aborts if `FD count < MIN_CORE_FILEDESCRIPTORS(150)`.\r\n\r\n**Bug 2:** The daemon does not allocate the right amount of dynamic FDs during init (but it's close).\r\n\r\n**Steps to produce**: Run `ulimit -n 150`', then start `bitcoind` in the same shell.\r\n\r\n**Result:** bitcoind runs normally and displays a rather hilarious warning:\r\n`Warning: Reducing -maxconnections from 125 to -8, because of system limitations.`\r\n`...`\r\n`Using at most -8 automatic connections (150 file descriptors available)`\r\n\r\n**Expected:** bitcoind should not start, as it needs at least 163~172~(?) FDs to ensure we won't run out:\r\n\r\n-`MIN_CORE_FILEDESCRIPTORS = 150`\r\n-`MAX_ADDNODE_CONNECTIONS = 8`\r\n~-`MAX_OUTBOUND_CONNECTIONS = 8`~\r\n~-`CConnman::Options:nMaxFeeler = 1`~(Edit: softlimit changed to 0 for these variables)\r\n-Number of `-bind` interfaces, default = 1\r\n-Number of `-rpcthreads`, default = 4\r\n\r\n150 + 8 + 1 + 4 = 163\r\n(comments needed!)\r\n\r\n**Results with this patch: (Updated)**\r\n`Bitcoin Core version v0.18.99.0-30ff63887-dirty (release build)`\r\n`File descriptors minimum: 163, available: 150.`\r\n`Error: Not enough file descriptors available.`\r\n\r\n**Results with this patch + `ulimit -n 163`: (Updated)**\r\n`Bitcoin Core version v0.18.99.0-30ff63887-dirty (release build)`\r\n`File descriptors minimum: 163, available: 163.`\r\n`Warning: Reducing -maxconnections from 125 to 0, because of system limitations.`\r\n`...`\r\n`Using at most 0 automatic connections (163 file descriptors available)`\r\n\r\n**Results with this patch + default ulimit on Debian 9.8: (Updated)**\r\n`Bitcoin Core version v0.18.99.0-30ff63887-dirty (release build)`\r\n`File descriptors minimum: 163, available: 1024.`\r\n`...`\r\n`Using at most 125 automatic connections (1024 file descriptors available)`\r\n\r\n\r\nThe replaced arithmetic is also smells strange if you consider these subtraction operations can subtract negative values to increase their value, and any unintended behavior will then be silenced by std::max().\r\n\r\n(thanks to IRC chat for the tips!)",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 1,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16003/comments",
   "created_at" : "2019-05-10T08:28:59Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16003/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/16003",
   "id" : 442599787,
   "labels" : [
      {
         "color" : "006b75",
         "default" : false,
         "id" : 98298007,
         "name" : "P2P",
         "node_id" : "MDU6TGFiZWw5ODI5ODAwNw==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/P2P"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16003/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDExOlB1bGxSZXF1ZXN0Mjc3Njc3Njkw",
   "number" : 16003,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/16003.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16003",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/16003.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16003"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "title" : "init: an incorrect amount of file descriptors is requested, and a different amount is also asserted",
   "updated_at" : "2019-05-10T10:00:38Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16003",
   "user" : {
      "avatar_url" : "https://avatars1.githubusercontent.com/u/8435003?v=4",
      "events_url" : "https://api.github.com/users/tryphe/events{/privacy}",
      "followers_url" : "https://api.github.com/users/tryphe/followers",
      "following_url" : "https://api.github.com/users/tryphe/following{/other_user}",
      "gists_url" : "https://api.github.com/users/tryphe/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/tryphe",
      "id" : 8435003,
      "login" : "tryphe",
      "node_id" : "MDQ6VXNlcjg0MzUwMDM=",
      "organizations_url" : "https://api.github.com/users/tryphe/orgs",
      "received_events_url" : "https://api.github.com/users/tryphe/received_events",
      "repos_url" : "https://api.github.com/users/tryphe/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/tryphe/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/tryphe/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/tryphe"
   }
}
