[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21106#discussion_r571946307"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21106"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/571946307"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This assumes that `GetTime()` is monotonic, which I don't think is true. `GetTime()` is mockable so may move backwards in tests.\r\n\r\nIt looks like `GetTime()` is also deprecated.",
      "commit_id" : "99283bf75197199191e433ae07456f3cf239308e",
      "created_at" : "2021-02-08T10:46:22Z",
      "diff_hunk" : "@@ -1305,6 +1305,14 @@ bool CChainState::IsInitialBlockDownload() const\n         return false;\n     if (fImporting || fReindex)\n         return true;\n+    uint64_t ibdtimeout = gArgs.GetArg(\"-ibdtimeout\", DEFAULT_IBD_TIMEOUT);\n+    int64_t uptime = GetTime() - GetStartupTime();\n+    assert(uptime >= 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#discussion_r571946307",
      "id" : 571946307,
      "line" : 1310,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTk0NjMwNw==",
      "original_commit_id" : "22c27cca430298bfc0b76ab50b18dc639110d75e",
      "original_line" : 1310,
      "original_position" : 6,
      "original_start_line" : 1309,
      "path" : "src/validation.cpp",
      "position" : 6,
      "pull_request_review_id" : 585370500,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21106",
      "side" : "RIGHT",
      "start_line" : 1309,
      "start_side" : "RIGHT",
      "updated_at" : "2021-02-09T01:12:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/571946307",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> all or most of the listening nodes are restarted into Initial Block Download mode \r\n\r\nWouldn't that mean that there hasn't been a block in 24 hours? Then, waiting another two days for the next block doesn't seem like a fallback that will be needed.",
      "created_at" : "2021-02-08T11:58:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#issuecomment-775094408",
      "id" : 775094408,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21106",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NTA5NDQwOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-08T11:58:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/775094408",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21106#discussion_r572483459"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21106"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572483459"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Nodes in IBD will not respond to GETHEADERS. Nodes in IBD do not request headers from inbound peers only outbound.\r\n\r\nIf all or most of the listening nodes are in IBD (emergency hot fix or something) then nobody will be able to get headers.\r\n\r\nTo get out of this the listening nodes need to request headers from inbound connections, either by exiting IBD or special casing that limit while in IBD.",
      "commit_id" : "99283bf75197199191e433ae07456f3cf239308e",
      "created_at" : "2021-02-09T00:43:37Z",
      "diff_hunk" : "@@ -1305,6 +1305,14 @@ bool CChainState::IsInitialBlockDownload() const\n         return false;\n     if (fImporting || fReindex)\n         return true;\n+    uint64_t ibdtimeout = gArgs.GetArg(\"-ibdtimeout\", DEFAULT_IBD_TIMEOUT);\n+    int64_t uptime = GetTime() - GetStartupTime();\n+    assert(uptime >= 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#discussion_r572483459",
      "id" : 572483459,
      "in_reply_to_id" : 571946307,
      "line" : 1310,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjQ4MzQ1OQ==",
      "original_commit_id" : "22c27cca430298bfc0b76ab50b18dc639110d75e",
      "original_line" : 1310,
      "original_position" : 6,
      "original_start_line" : 1309,
      "path" : "src/validation.cpp",
      "position" : 6,
      "pull_request_review_id" : 586054492,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21106",
      "side" : "RIGHT",
      "start_line" : 1309,
      "start_side" : "RIGHT",
      "updated_at" : "2021-02-09T01:12:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572483459",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/620611?v=4",
         "events_url" : "https://api.github.com/users/pstratem/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pstratem/followers",
         "following_url" : "https://api.github.com/users/pstratem/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pstratem/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pstratem",
         "id" : 620611,
         "login" : "pstratem",
         "node_id" : "MDQ6VXNlcjYyMDYxMQ==",
         "organizations_url" : "https://api.github.com/users/pstratem/orgs",
         "received_events_url" : "https://api.github.com/users/pstratem/received_events",
         "repos_url" : "https://api.github.com/users/pstratem/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pstratem/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pstratem"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@MarcoFalke no it doesn't, just that the listening nodes haven't seen the block yet.",
      "created_at" : "2021-02-09T00:45:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#issuecomment-775567992",
      "id" : 775567992,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21106",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NTU2Nzk5Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-09T00:45:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/775567992",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/620611?v=4",
         "events_url" : "https://api.github.com/users/pstratem/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pstratem/followers",
         "following_url" : "https://api.github.com/users/pstratem/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pstratem/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pstratem",
         "id" : 620611,
         "login" : "pstratem",
         "node_id" : "MDQ6VXNlcjYyMDYxMQ==",
         "organizations_url" : "https://api.github.com/users/pstratem/orgs",
         "received_events_url" : "https://api.github.com/users/pstratem/received_events",
         "repos_url" : "https://api.github.com/users/pstratem/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pstratem/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pstratem"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "If the listening nodes haven't seen a block from 24h ago, something is going wrong and needs human attention to manually fixup. Having an automated fallback that hits after two days doesn't seem needed when having to manually interfere anyway.",
      "created_at" : "2021-02-09T07:08:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#issuecomment-775723337",
      "id" : 775723337,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21106",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NTcyMzMzNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-09T07:08:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/775723337",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@MarcoFalke  I respectfully disagree.  The network consists of thousands of listening nodes, tens of thousands of total nodes.  Many-- probably most-- are not observed on a daily or weekly basis.  If the network ends up in a bad state it may be difficult to recover nodes even manually if it is full of other nodes which are non-functional.\r\n\r\nWhen users do \"manually\" intervene, the results are not always pretty--  I've consoled more than one user through a thousands of dollars loss because in their efforts to 'fix' a 'stuck' node that wasn't actually stuck (e.g. when they were confused at the 0.99x progress display) and managed to delete or corrupt every copy of their wallet due to trying random things and/or following bad advice online.  Any particular user isn't likely to footgun themselves, but if you make 50,000 users do so, a few probably will.\r\n\r\nI'm not particularly sure about the approach in this PR right now, but the general practice that nodes should fix themselves if reasonable and safely possible is a really good one.  The whole behaviour switching on IBD handling is a pile of gross hacks on top of a pile of gross hacks,  several of which were needed to resolve cases where the network could more or less just spontaneously fail as a result of the IBD behaviour (some of which were witnessed on testnet).\r\n\r\nIt would be good to have a stronger assurance that things will recover if they end up in that state but the tricky part is being equally confident that the various attacks that the IBD specific behaviour is intended to protect against are still protected against-- esp because no one reviewing this work may remember all of them.\r\n\r\n\r\n",
      "created_at" : "2021-02-10T06:42:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#issuecomment-776484069",
      "id" : 776484069,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21106",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NjQ4NDA2OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-10T06:42:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/776484069",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I fully agree that the node should try to recover (to avoid manual intervention as much as possible) when its both reasonable and safe to do. Though in this particular case, the users that are eager enough to corrupt their datadir, won't be patient enough to wait three full days for this workaround to take effect. And similarly, the patient users won't see the benefits either because some eager users successfully poked their node on the first day of issues.",
      "created_at" : "2021-02-10T07:04:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21106#issuecomment-776494393",
      "id" : 776494393,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21106",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NjQ5NDM5Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-10T07:04:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/776494393",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
