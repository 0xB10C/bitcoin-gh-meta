[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #21144 (test: convert feature_bip68_sequence.py to use MiniWallet by danben)\n* #21014 (test: Run mempool_accept.py even with wallet disabled by stackman27)\n* #20889 (test: ensure any failing method in MiniWallet leaves no side-effects by mjdietzx)\n* #20874 (test: Run mempool_limit.py even with wallet disabled by stackman27)\n* #20808 (test: Run rpc_generateblock.py even with wallet disabled by nginocchio)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-02-15T08:44:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21178#issuecomment-779060043",
      "id" : 779060043,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21178",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3OTA2MDA0Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-15T08:44:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/779060043",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21178#discussion_r576830729"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21178"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576830729"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "this is not needed anymore i believe",
      "commit_id" : "2ff5034eb12ff3771c9e2640a5f3d4f5004df430",
      "created_at" : "2021-02-16T13:41:55Z",
      "diff_hunk" : "@@ -67,13 +67,26 @@ def send_self_transfer(self, *, fee_rate=Decimal(\"0.003\"), from_node, utxo_to_sp\n         tx = CTransaction()\n         tx.vin = [CTxIn(COutPoint(int(utxo_to_spend['txid'], 16), utxo_to_spend['vout']))]\n         tx.vout = [CTxOut(int(send_value * COIN), self._scriptPubKey)]\n+        tx.nLockTime = locktime\n         tx.wit.vtxinwit = [CTxInWitness()]\n         tx.wit.vtxinwit[0].scriptWitness.stack = [CScript([OP_TRUE])]\n         tx_hex = tx.serialize().hex()\n \n         tx_info = from_node.testmempoolaccept([tx_hex])[0]\n-        self._utxos.append({'txid': tx_info['txid'], 'vout': 0, 'value': send_value})\n+        if tx_info['allowed']:\n+            assert_equal(tx_info['vsize'], vsize)\n+            assert_equal(tx_info['fees']['base'], fee)\n+\n+        new_utxo = {'txid': tx_info['txid'], 'vout': 0, 'value': send_value}\n+        return tx_hex,  new_utxo\n+\n+    def send_self_transfer(self, *, fee_rate=Decimal(\"0.003\"), from_node, utxo_to_spend=None, locktime=0):\n+        \"\"\"Create and send a tx with the specified fee_rate. Fee may be exact or at most one satoshi higher than needed.\"\"\"\n+\n+        tx_hex, new_utxo = self.create_self_transfer(fee_rate=fee_rate, from_node=from_node, utxo_to_spend=utxo_to_spend, locktime=locktime)\n+\n+        tx_info = from_node.testmempoolaccept([tx_hex])[0]",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21178#discussion_r576830729",
      "id" : 576830729,
      "line" : 88,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjgzMDcyOQ==",
      "original_commit_id" : "a96c58aad6912eb725455dec5997bd60308aa762",
      "original_line" : 88,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/wallet.py",
      "position" : 34,
      "pull_request_review_id" : 591233260,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21178",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T13:56:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576830729",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21178#discussion_r576833170"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21178"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576833170"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit\r\n```suggestion\r\n        timelock_tx, _ = wallet.create_self_transfer(\r\n            from_node=self.nodes[0],\r\n            utxo_to_spend=utxo,\r\n            locktime=self.nodes[0].getblockcount() + 2\r\n         )\r\n```",
      "commit_id" : "2ff5034eb12ff3771c9e2640a5f3d4f5004df430",
      "created_at" : "2021-02-16T13:45:35Z",
      "diff_hunk" : "@@ -46,33 +42,34 @@ def run_test(self):\n         # and make sure the mempool code behaves correctly.\n         b = [self.nodes[0].getblockhash(n) for n in range(101, 105)]\n         coinbase_txids = [self.nodes[0].getblock(h)['tx'][0] for h in b]\n-        spend_101_raw = create_raw_transaction(self.nodes[0], coinbase_txids[1], node1_address, amount=49.99)\n-        spend_102_raw = create_raw_transaction(self.nodes[0], coinbase_txids[2], node0_address, amount=49.99)\n-        spend_103_raw = create_raw_transaction(self.nodes[0], coinbase_txids[3], node0_address, amount=49.99)\n+        utxo_101 = wallet.get_utxo(txid=coinbase_txids[1])\n+        utxo_102 = wallet.get_utxo(txid=coinbase_txids[2])\n+        utxo_103 = wallet.get_utxo(txid=coinbase_txids[3])\n+        spend_101_raw, _ = wallet.create_self_transfer(from_node=self.nodes[0], utxo_to_spend=utxo_101)\n+        spend_102_raw, utxo_102 = wallet.create_self_transfer(from_node=self.nodes[0], utxo_to_spend=utxo_102)\n+        spend_103_raw, utxo_103 = wallet.create_self_transfer(from_node=self.nodes[0], utxo_to_spend=utxo_103)\n \n         # Create a transaction which is time-locked to two blocks in the future\n-        timelock_tx = self.nodes[0].createrawtransaction(\n-            inputs=[{\n-                \"txid\": coinbase_txids[0],\n-                \"vout\": 0,\n-            }],\n-            outputs={node0_address: 49.99},\n-            locktime=self.nodes[0].getblockcount() + 2,\n-        )\n-        timelock_tx = self.nodes[0].signrawtransactionwithwallet(timelock_tx)[\"hex\"]\n+        utxo = wallet.get_utxo(txid=coinbase_txids[0])\n+        timelock_tx, _ = wallet.create_self_transfer(\n+            from_node=self.nodes[0],\n+            utxo_to_spend=utxo,\n+            locktime=self.nodes[0].getblockcount() + 2\n+            )",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21178#discussion_r576833170",
      "id" : 576833170,
      "line" : 58,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjgzMzE3MA==",
      "original_commit_id" : "2ff5034eb12ff3771c9e2640a5f3d4f5004df430",
      "original_line" : 58,
      "original_position" : 72,
      "original_start_line" : 54,
      "path" : "test/functional/mempool_reorg.py",
      "position" : 72,
      "pull_request_review_id" : 591233260,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21178",
      "side" : "RIGHT",
      "start_line" : 54,
      "start_side" : "RIGHT",
      "updated_at" : "2021-02-16T13:56:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576833170",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21178#discussion_r576838361"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21178"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576838361"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Not sure if this is relevant to this PR or previous one, but I'm surprised the vsize is hard-coded? It should be programmatically obtained or asserted to be correct after it's constructed. There's a `get_vsize()` for `CTransaction`s in test_framework.messages",
      "commit_id" : "2ff5034eb12ff3771c9e2640a5f3d4f5004df430",
      "created_at" : "2021-02-16T13:53:07Z",
      "diff_hunk" : "@@ -55,8 +55,8 @@ def get_utxo(self, *, txid=''):\n             index = self._utxos.index(utxo)\n         return self._utxos.pop(index)\n \n-    def send_self_transfer(self, *, fee_rate=Decimal(\"0.003\"), from_node, utxo_to_spend=None):\n-        \"\"\"Create and send a tx with the specified fee_rate. Fee may be exact or at most one satoshi higher than needed.\"\"\"\n+    def create_self_transfer(self, *, fee_rate=Decimal(\"0.003\"), from_node, utxo_to_spend=None, locktime=0):\n+        \"\"\"Create a tx with the specified fee_rate. Fee may be exact or at most one satoshi higher than needed.\"\"\"\n         self._utxos = sorted(self._utxos, key=lambda k: k['value'])\n         utxo_to_spend = utxo_to_spend or self._utxos.pop()  # Pick the largest utxo (if none provided) and hope it covers the fee\n         vsize = Decimal(96)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21178#discussion_r576838361",
      "id" : 576838361,
      "line" : 62,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjgzODM2MQ==",
      "original_commit_id" : "2ff5034eb12ff3771c9e2640a5f3d4f5004df430",
      "original_line" : 62,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/wallet.py",
      "position" : 10,
      "pull_request_review_id" : 591233260,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21178",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T13:56:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576838361",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   }
]
