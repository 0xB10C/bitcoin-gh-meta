[
   {
      "author_association" : "MEMBER",
      "body" : "Fixes https://github.com/bitcoin/bitcoin/pull/20942#discussion_r576105248",
      "created_at" : "2021-02-15T12:44:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21188#issuecomment-779200326",
      "id" : 779200326,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21188",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3OTIwMDMyNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-15T12:44:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/779200326",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Too bad the compiler can't error on those by itself",
      "created_at" : "2021-02-15T12:45:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21188#issuecomment-779200740",
      "id" : 779200740,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21188",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3OTIwMDc0MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-15T12:45:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/779200740",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I don't think so. This is all my hacky grep could find.\r\n\r\n```\r\n$ git grep --extended-regexp --ignore-case  ' [a-z0-9]+::[a-z0-9]+\\([^()]*\\).*LOCKS_'\r\nsrc/net_processing.cpp:bool PeerManagerImpl::MarkBlockAsReceived(const uint256& hash) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\r\nsrc/net_processing.cpp:bool PeerManagerImpl::MarkBlockAsInFlight(NodeId nodeid, const uint256& hash, const CBlockIndex* pindex, std::list<QueuedBlock>::iterator** pit) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\r\nsrc/net_processing.cpp:void PeerManagerImpl::MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\r\nsrc/net_processing.cpp:bool PeerManagerImpl::TipMayBeStale() EXCLUSIVE_LOCKS_REQUIRED(cs_main)\r\nsrc/net_processing.cpp:void PeerManagerImpl::FindNextBlocksToDownload(NodeId nodeid, unsigned int count, std::vector<const CBlockIndex*>& vBlocks, NodeId& nodeStaller) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\r\nsrc/net_processing.cpp:bool PeerManagerImpl::AlreadyHaveTx(const GenTxid& gtxid) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\r\nsrc/net_processing.cpp:CTransactionRef PeerManagerImpl::FindTxForGetData(const CNode& peer, const GenTxid& gtxid, const std::chrono::seconds mempool_req, const std::chrono::seconds now) LOCKS_EXCLUDED(cs_main)\r\nsrc/net_processing.cpp:void PeerManagerImpl::ProcessGetData(CNode& pfrom, Peer& peer, const std::atomic<bool>& interruptMsgProc) EXCLUSIVE_LOCKS_REQUIRED(!cs_main, peer.m_getdata_requests_mutex)\r\nsrc/qt/transactiondesc.cpp:            strHTML += BitcoinUnits::formatHtmlWithUnit(unit, nUnmatured)+ \" (\" + tr(\"matures in %n more block(s)\", \"\", status.blocks_to_maturity) + \")\";\r\n",
      "created_at" : "2021-02-15T15:19:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21188#issuecomment-779288047",
      "id" : 779288047,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21188",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3OTI4ODA0Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-15T15:19:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/779288047",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I don't understand the issue. How can I reproduce it? \r\n\r\nI interpreted the issue to be that we would _not_ get a compiler warning under the following circumstance: \r\n- header declaration of function FooBar has annotation EXCLUSIVE_LOCKS_REQUIRED(lock1, lock2)\r\n- FooBar definition has annotation EXCLUSIVE_LOCKS_REQUIRED(lock1)\r\n- call site acquires lock1 then calls FooBar\r\n- issue: we do not get a compiler warning that lock2 was not acquired before calling FooBar\r\n\r\nI tried it out by doing the following:\r\n- on master, `TipMayBeStale()` has `EXCLUSIVE_LOCKS_REQUIRED(cs_main)` on both the function declaration and the function definition \r\n- I added a new mutex `RecursiveMutex cs_other;` and updated only the declaration of `TipMayBeStale()` to be `EXCLUSIVE_LOCKS_REQUIRED(cs_main, cs_other);`\r\n- I did not update the annotations in the definition of `TipMayBeStale()` or the call site `CheckForStaleTipAndEvictPeers`. \r\n\r\nfull diff:\r\n```\r\n-    bool TipMayBeStale() EXCLUSIVE_LOCKS_REQUIRED(cs_main);\r\n+    RecursiveMutex cs_mainstream;\r\n+    bool TipMayBeStale() EXCLUSIVE_LOCKS_REQUIRED(cs_main, cs_mainstream);\r\n```\r\n\r\n- I expected that the issue would be that we would not get a compiler warning even though the call site didn't take `cs_other`. \r\n\r\nHowever, I did get a compiler warning: `net_processing.cpp:4284:110: warning: calling function 'TipMayBeStale' requires holding mutex 'cs_other' exclusively [-Wthread-safety-analysis]` So, I don't understand the context of what we are trying to prevent / fix. ",
      "created_at" : "2021-02-16T00:22:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21188#issuecomment-779506757",
      "id" : 779506757,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21188",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3OTUwNjc1Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-16T00:27:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/779506757",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   }
]
