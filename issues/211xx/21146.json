{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "CONTRIBUTOR",
   "body" : "This builds on #21062 (and is also a followup, first commit addresses some leftover comments).\r\nI'm also including a commit from #20750 because there's a lot of overlapping goals + code.\r\n\r\nThe `MemPoolAccept` validates txns as mempool candidates on top of current chainstate. \r\n\r\n`MemPoolAccept` interacts with 4 `CCoinsView`s: \r\n```cpp\r\n// members of MemPoolAccept:\r\nCCoinsViewMemPool m_viewmempool // has access to mempool outputs\r\nCCoinsViewCache m_view // main view used for validation, keeps cache of coins we need\r\nCCoinsView m_dummy // setting backend to this is equivalent to removing the backend\r\n\r\n// non-member\r\nCCoinsViewCache m_active_chainstate.CoinsTip() // current chainstate coins cache, which we want to protect\r\n```\r\n\r\nWhen validating unconfirmed transactions, we want to account for all coins brought in from disk so we can uncache them if the tx is invalid. On master it's disconnected in the middle: `m_view` -> `m_dummy` // `m_viewmempool` -> `CoinsTip()`\r\nThe problem with this is:\r\n- `m_viewmempool` still has `CoinsTip()` as its backend :shrug:\r\n- It's not necessary to remove `m_view`'s backend, which is `m_viewmempool`. It'd be nice to still be able to access `m_viewmempool` through `m_view`.\r\n\r\n\r\nWe should have:\r\n(1) When `MemPoolAccept` is constructed: `m_view` -> `m_viewmempool` -> `m_dummy`\r\n\r\n(2) Right before we are look up UTXOs spent by the tx, record them in `coins_to_uncache`, and set the backend:\r\n`m_view` -> `m_viewmempool` -> `m_active_chainstate.CoinsTip()`\r\n\r\n(3) Immediately afterward, return to `m_view` -> `m_viewmempool` -> `m_dummy`.\r\n\r\n(4) Later (see #20833), use `m_view` to access package UTXOs within a package in `m_viewmempool`.\r\n",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 0,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21146/comments",
   "created_at" : "2021-02-10T23:33:21Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21146/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/21146",
   "id" : 805962123,
   "labels" : [
      {
         "color" : "6060aa",
         "default" : false,
         "description" : null,
         "id" : 118379652,
         "name" : "Validation",
         "node_id" : "MDU6TGFiZWwxMTgzNzk2NTI=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Validation"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21146/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDExOlB1bGxSZXF1ZXN0NTcxNDc0NzQ2",
   "number" : 21146,
   "performed_via_github_app" : null,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/21146.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21146",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/21146.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21146"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "title" : "[WIP] validation/coins: limit MemPoolAccept access to coins cache",
   "updated_at" : "2021-02-10T23:34:04Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21146",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
      "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
      "followers_url" : "https://api.github.com/users/glozow/followers",
      "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
      "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/glozow",
      "id" : 25183001,
      "login" : "glozow",
      "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
      "organizations_url" : "https://api.github.com/users/glozow/orgs",
      "received_events_url" : "https://api.github.com/users/glozow/received_events",
      "repos_url" : "https://api.github.com/users/glozow/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/glozow"
   }
}
