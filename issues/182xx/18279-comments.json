[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18279#discussion_r388951184"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18279"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/388951184"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Shouldn't this whole scope happen under the cs_wallet lock?\r\n\r\nAlso, shouldn't `m_chain_notifications_handler.reset()` happen inside here under the wallet lock?\r\n\r\nOtherwise a new block could come in and put new notifications in the handler while we reset it.",
      "commit_id" : "78a88ef667c07e645ff43dcd112a6931ae2fc4b0",
      "created_at" : "2020-03-06T14:58:58Z",
      "diff_hunk" : "@@ -1156,8 +1156,11 @@ void CWallet::BlockUntilSyncedToCurrentChain() {\n     // ::ChainActive().Tip(), otherwise put a callback in the validation interface queue and wait\n     // for the queue to drain enough to execute it (indicating we are caught up\n     // at least with the time we entered this function).\n-    uint256 last_block_hash = WITH_LOCK(cs_wallet, return m_last_block_processed);\n-    chain().waitForNotificationsIfTipChanged(last_block_hash);\n+    bool tipIsSame = false;\n+    do {\n+        uint256 last_block_hash = WITH_LOCK(cs_wallet, return m_last_block_processed);\n+        tipIsSame = chain().waitForNotificationsIfTipIsNotSame(last_block_hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18279#discussion_r388951184",
      "id" : 388951184,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk1MTE4NA==",
      "original_commit_id" : "ddcc4b23b18f00e33a9f6916553d0eae6a69a1b3",
      "original_position" : 19,
      "path" : "src/wallet/wallet.cpp",
      "position" : 20,
      "pull_request_review_id" : 370384387,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18279",
      "updated_at" : "2020-03-07T10:42:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/388951184",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I think this is the wrong approach.",
      "created_at" : "2020-03-06T15:00:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18279#issuecomment-595806717",
      "id" : 595806717,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18279",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5NTgwNjcxNw==",
      "updated_at" : "2020-03-06T15:00:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/595806717",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18279#discussion_r388957652"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18279"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/388957652"
         }
      },
      "author_association" : "NONE",
      "body" : "> Shouldn't this whole scope happen under the cs_wallet lock?\r\n\r\nNo, we leave mutex for process thread to finish.\r\n> Also, shouldn't m_chain_notifications_handler.reset() happen inside here under the wallet lock?\r\n\r\nNo.\r\n> Otherwise a new block could come in and put new notifications in the handler while we reset it.\r\n\r\nI'm aware of that, we can have a function that takes a mutex and reset notifications",
      "commit_id" : "78a88ef667c07e645ff43dcd112a6931ae2fc4b0",
      "created_at" : "2020-03-06T15:10:19Z",
      "diff_hunk" : "@@ -1156,8 +1156,11 @@ void CWallet::BlockUntilSyncedToCurrentChain() {\n     // ::ChainActive().Tip(), otherwise put a callback in the validation interface queue and wait\n     // for the queue to drain enough to execute it (indicating we are caught up\n     // at least with the time we entered this function).\n-    uint256 last_block_hash = WITH_LOCK(cs_wallet, return m_last_block_processed);\n-    chain().waitForNotificationsIfTipChanged(last_block_hash);\n+    bool tipIsSame = false;\n+    do {\n+        uint256 last_block_hash = WITH_LOCK(cs_wallet, return m_last_block_processed);\n+        tipIsSame = chain().waitForNotificationsIfTipIsNotSame(last_block_hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18279#discussion_r388957652",
      "id" : 388957652,
      "in_reply_to_id" : 388951184,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk1NzY1Mg==",
      "original_commit_id" : "ddcc4b23b18f00e33a9f6916553d0eae6a69a1b3",
      "original_position" : 19,
      "path" : "src/wallet/wallet.cpp",
      "position" : 20,
      "pull_request_review_id" : 370392864,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18279",
      "updated_at" : "2020-03-07T10:42:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/388957652",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/8323581?v=4",
         "events_url" : "https://api.github.com/users/bvbfan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bvbfan/followers",
         "following_url" : "https://api.github.com/users/bvbfan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bvbfan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bvbfan",
         "id" : 8323581,
         "login" : "bvbfan",
         "node_id" : "MDQ6VXNlcjgzMjM1ODE=",
         "organizations_url" : "https://api.github.com/users/bvbfan/orgs",
         "received_events_url" : "https://api.github.com/users/bvbfan/received_events",
         "repos_url" : "https://api.github.com/users/bvbfan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bvbfan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bvbfan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bvbfan"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> I think this is the wrong approach.\r\n\r\nThat's at least ensure sync between wallet and chain tips otherwise all calls to `BlockUntilSyncedToCurrentChain` are just pointless, they don't do what is supposed to do. Your patch looks fine but not what we want when calls a function like `BlockUntilSyncedToCurrentChain`",
      "created_at" : "2020-03-06T15:16:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18279#issuecomment-595813866",
      "id" : 595813866,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18279",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5NTgxMzg2Ng==",
      "updated_at" : "2020-03-06T15:17:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/595813866",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/8323581?v=4",
         "events_url" : "https://api.github.com/users/bvbfan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bvbfan/followers",
         "following_url" : "https://api.github.com/users/bvbfan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bvbfan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bvbfan",
         "id" : 8323581,
         "login" : "bvbfan",
         "node_id" : "MDQ6VXNlcjgzMjM1ODE=",
         "organizations_url" : "https://api.github.com/users/bvbfan/orgs",
         "received_events_url" : "https://api.github.com/users/bvbfan/received_events",
         "repos_url" : "https://api.github.com/users/bvbfan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bvbfan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bvbfan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bvbfan"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.",
      "created_at" : "2020-03-07T02:45:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18279#issuecomment-596037468",
      "id" : 596037468,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18279",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5NjAzNzQ2OA==",
      "updated_at" : "2020-03-09T21:48:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/596037468",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "@promag the problem is not the queued connection / disconnection, actually \r\n```\r\nvoid UnregisterValidationInterface(CValidationInterface* pwalletIn) {\r\n    if (g_signals.m_internals) {\r\n        g_signals.m_internals->m_connMainSignals.erase(pwalletIn);\r\n    }\r\n}\r\n```\r\nsignal is received before disconnect is called by erasing the caller.\r\n\r\nFix unit test and rebase.",
      "created_at" : "2020-03-07T09:22:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18279#issuecomment-596066452",
      "id" : 596066452,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18279",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5NjA2NjQ1Mg==",
      "updated_at" : "2020-03-07T09:22:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/596066452",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/8323581?v=4",
         "events_url" : "https://api.github.com/users/bvbfan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bvbfan/followers",
         "following_url" : "https://api.github.com/users/bvbfan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bvbfan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bvbfan",
         "id" : 8323581,
         "login" : "bvbfan",
         "node_id" : "MDQ6VXNlcjgzMjM1ODE=",
         "organizations_url" : "https://api.github.com/users/bvbfan/orgs",
         "received_events_url" : "https://api.github.com/users/bvbfan/received_events",
         "repos_url" : "https://api.github.com/users/bvbfan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bvbfan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bvbfan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bvbfan"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Let's clarify a bit more.\r\n```\r\nvoid disconnect() override\r\n{\r\n    if (m_notifications) {\r\n        m_notifications = nullptr; // <---------------- it makes no sense to be before unregister\r\n        UnregisterValidationInterface(this);\r\n    }\r\n}\r\n```\r\nSince `ValidationInterfaceConnections` calls destructors in reverse order, for a bad luck `UpdatedBlockTip` is disconnected last which is not held the mutex but update time by atomic variable.\r\nRunning in testnet for at least an hour in parallel with \r\n```\r\n#!/bin/bash\r\nwhile [ 1 ]\r\ndo\r\n    src/bitcoin-cli -testnet loadwallet test\r\n    src/bitcoin-cli -testnet unloadwallet test\r\ndone\r\n```\r\nno crashes anymore.",
      "created_at" : "2020-03-07T10:47:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18279#issuecomment-596074276",
      "id" : 596074276,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18279",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5NjA3NDI3Ng==",
      "updated_at" : "2020-03-07T10:49:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/596074276",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/8323581?v=4",
         "events_url" : "https://api.github.com/users/bvbfan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bvbfan/followers",
         "following_url" : "https://api.github.com/users/bvbfan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bvbfan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bvbfan",
         "id" : 8323581,
         "login" : "bvbfan",
         "node_id" : "MDQ6VXNlcjgzMjM1ODE=",
         "organizations_url" : "https://api.github.com/users/bvbfan/orgs",
         "received_events_url" : "https://api.github.com/users/bvbfan/received_events",
         "repos_url" : "https://api.github.com/users/bvbfan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bvbfan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bvbfan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bvbfan"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> while holding wallet lock and then test handler still exists in BlockConnected/BlockDisconnected\r\n\r\ni don't think that's right approach to me.",
      "created_at" : "2020-03-10T13:06:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18279#issuecomment-597074855",
      "id" : 597074855,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18279",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5NzA3NDg1NQ==",
      "updated_at" : "2020-03-10T13:06:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/597074855",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/8323581?v=4",
         "events_url" : "https://api.github.com/users/bvbfan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bvbfan/followers",
         "following_url" : "https://api.github.com/users/bvbfan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bvbfan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bvbfan",
         "id" : 8323581,
         "login" : "bvbfan",
         "node_id" : "MDQ6VXNlcjgzMjM1ODE=",
         "organizations_url" : "https://api.github.com/users/bvbfan/orgs",
         "received_events_url" : "https://api.github.com/users/bvbfan/received_events",
         "repos_url" : "https://api.github.com/users/bvbfan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bvbfan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bvbfan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bvbfan"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18279#discussion_r390450804"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18279"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/390450804"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This change seems clearly correct. Good catch! Maybe `m_notifications` should be an atomic pointer too since `m_notifications` is get and set from different threads, though probably the synchronization done by boost signals & the scheduler prevents bugs from it not being atomic",
      "commit_id" : "78a88ef667c07e645ff43dcd112a6931ae2fc4b0",
      "created_at" : "2020-03-10T16:35:46Z",
      "diff_hunk" : "@@ -160,8 +160,8 @@ class NotificationsHandlerImpl : public Handler, CValidationInterface\n     void disconnect() override\n     {\n         if (m_notifications) {\n-            m_notifications = nullptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18279#discussion_r390450804",
      "id" : 390450804,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ1MDgwNA==",
      "original_commit_id" : "78a88ef667c07e645ff43dcd112a6931ae2fc4b0",
      "original_position" : 4,
      "path" : "src/interfaces/chain.cpp",
      "position" : 4,
      "pull_request_review_id" : 372125199,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18279",
      "updated_at" : "2020-03-10T16:59:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/390450804",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18279#discussion_r390453622"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18279"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/390453622"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I like the name change, and I can see how the having the bool return value should make races and the deadlock reported https://github.com/bitcoin/bitcoin/issues/16307#issuecomment-595786198 less likely, though I suspect there is also probably a more direct and reliable fix we can find",
      "commit_id" : "78a88ef667c07e645ff43dcd112a6931ae2fc4b0",
      "created_at" : "2020-03-10T16:39:54Z",
      "diff_hunk" : "@@ -346,13 +346,14 @@ class ChainImpl : public Chain\n     {\n         return MakeUnique<NotificationsHandlerImpl>(*this, notifications);\n     }\n-    void waitForNotificationsIfTipChanged(const uint256& old_tip) override\n+    bool waitForNotificationsIfTipIsNotSame(const uint256& tip) override",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18279#discussion_r390453622",
      "id" : 390453622,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ1MzYyMg==",
      "original_commit_id" : "78a88ef667c07e645ff43dcd112a6931ae2fc4b0",
      "original_position" : 15,
      "path" : "src/interfaces/chain.cpp",
      "position" : 15,
      "pull_request_review_id" : 372125199,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18279",
      "updated_at" : "2020-03-10T16:59:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/390453622",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18279#discussion_r390457946"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18279"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/390457946"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Acquiring the cs_wallet lock here is unexpected. If this is really neccessary, I think the lock should be acquired closer to where it's used inside the Flush implementation, probably with a comment if the purpose of the lock isn't more obvious there",
      "commit_id" : "78a88ef667c07e645ff43dcd112a6931ae2fc4b0",
      "created_at" : "2020-03-10T16:46:06Z",
      "diff_hunk" : "@@ -110,8 +110,8 @@ static void ReleaseWallet(CWallet* wallet)\n     const std::string name = wallet->GetName();\n     wallet->WalletLogPrintf(\"Releasing wallet\\n\");\n     wallet->BlockUntilSyncedToCurrentChain();\n-    wallet->Flush();\n     wallet->m_chain_notifications_handler.reset();\n+    WITH_LOCK(wallet->cs_wallet, wallet->Flush());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18279#discussion_r390457946",
      "id" : 390457946,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ1Nzk0Ng==",
      "original_commit_id" : "78a88ef667c07e645ff43dcd112a6931ae2fc4b0",
      "original_position" : 6,
      "path" : "src/wallet/wallet.cpp",
      "position" : 6,
      "pull_request_review_id" : 372125199,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18279",
      "updated_at" : "2020-03-10T16:59:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/390457946",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18279#discussion_r390802687"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18279"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/390802687"
         }
      },
      "author_association" : "NONE",
      "body" : "> I think there is a misunderstanding here (maybe my own), but my understanding is that the point of BlockUntilSyncedToCurrentChain is just to ensure that if you make two RPC calls in a row the second RPC call is always aware of the result of first call. Ensuring that notification in the queue from the time of the call are processed is sufficient to do this, without trying to guarantee that the wallet tip and node tips are equal.\r\n\r\nYes, but mostly after BlockUntilSyncedToCurrentChain lock is acquired and there is no guarantee that notification is faster than this held, i.e. you can leave BlockUntilSyncedToCurrentChain and don't do what you want, you gain mutex before notification thread and you're not sync anything.",
      "commit_id" : "78a88ef667c07e645ff43dcd112a6931ae2fc4b0",
      "created_at" : "2020-03-11T08:15:24Z",
      "diff_hunk" : "@@ -110,8 +110,8 @@ static void ReleaseWallet(CWallet* wallet)\n     const std::string name = wallet->GetName();\n     wallet->WalletLogPrintf(\"Releasing wallet\\n\");\n     wallet->BlockUntilSyncedToCurrentChain();\n-    wallet->Flush();\n     wallet->m_chain_notifications_handler.reset();\n+    WITH_LOCK(wallet->cs_wallet, wallet->Flush());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18279#discussion_r390802687",
      "id" : 390802687,
      "in_reply_to_id" : 390457946,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDgwMjY4Nw==",
      "original_commit_id" : "78a88ef667c07e645ff43dcd112a6931ae2fc4b0",
      "original_position" : 6,
      "path" : "src/wallet/wallet.cpp",
      "position" : 6,
      "pull_request_review_id" : 372545138,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18279",
      "updated_at" : "2020-03-11T08:28:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/390802687",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/8323581?v=4",
         "events_url" : "https://api.github.com/users/bvbfan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bvbfan/followers",
         "following_url" : "https://api.github.com/users/bvbfan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bvbfan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bvbfan",
         "id" : 8323581,
         "login" : "bvbfan",
         "node_id" : "MDQ6VXNlcjgzMjM1ODE=",
         "organizations_url" : "https://api.github.com/users/bvbfan/orgs",
         "received_events_url" : "https://api.github.com/users/bvbfan/received_events",
         "repos_url" : "https://api.github.com/users/bvbfan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bvbfan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bvbfan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bvbfan"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18279#discussion_r390803411"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18279"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/390803411"
         }
      },
      "author_association" : "NONE",
      "body" : "Here after BlockUntilSyncedToCurrentChain is ensuring it's on current tip, the lock tries to guarantee that notification thread is finished before we flush and release memory.",
      "commit_id" : "78a88ef667c07e645ff43dcd112a6931ae2fc4b0",
      "created_at" : "2020-03-11T08:17:07Z",
      "diff_hunk" : "@@ -110,8 +110,8 @@ static void ReleaseWallet(CWallet* wallet)\n     const std::string name = wallet->GetName();\n     wallet->WalletLogPrintf(\"Releasing wallet\\n\");\n     wallet->BlockUntilSyncedToCurrentChain();\n-    wallet->Flush();\n     wallet->m_chain_notifications_handler.reset();\n+    WITH_LOCK(wallet->cs_wallet, wallet->Flush());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18279#discussion_r390803411",
      "id" : 390803411,
      "in_reply_to_id" : 390457946,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDgwMzQxMQ==",
      "original_commit_id" : "78a88ef667c07e645ff43dcd112a6931ae2fc4b0",
      "original_position" : 6,
      "path" : "src/wallet/wallet.cpp",
      "position" : 6,
      "pull_request_review_id" : 372546031,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18279",
      "updated_at" : "2020-03-11T08:17:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/390803411",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/8323581?v=4",
         "events_url" : "https://api.github.com/users/bvbfan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bvbfan/followers",
         "following_url" : "https://api.github.com/users/bvbfan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bvbfan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bvbfan",
         "id" : 8323581,
         "login" : "bvbfan",
         "node_id" : "MDQ6VXNlcjgzMjM1ODE=",
         "organizations_url" : "https://api.github.com/users/bvbfan/orgs",
         "received_events_url" : "https://api.github.com/users/bvbfan/received_events",
         "repos_url" : "https://api.github.com/users/bvbfan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bvbfan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bvbfan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bvbfan"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18279#discussion_r390809490"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18279"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/390809490"
         }
      },
      "author_association" : "NONE",
      "body" : "> Maybe m_notifications should be an atomic pointer too since m_notifications is get and set from different threads, though probably the synchronization done by boost signals & the scheduler prevents bugs from it not being atomic\r\n\r\nYou're right",
      "commit_id" : "78a88ef667c07e645ff43dcd112a6931ae2fc4b0",
      "created_at" : "2020-03-11T08:30:07Z",
      "diff_hunk" : "@@ -160,8 +160,8 @@ class NotificationsHandlerImpl : public Handler, CValidationInterface\n     void disconnect() override\n     {\n         if (m_notifications) {\n-            m_notifications = nullptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18279#discussion_r390809490",
      "id" : 390809490,
      "in_reply_to_id" : 390450804,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDgwOTQ5MA==",
      "original_commit_id" : "78a88ef667c07e645ff43dcd112a6931ae2fc4b0",
      "original_position" : 4,
      "path" : "src/interfaces/chain.cpp",
      "position" : 4,
      "pull_request_review_id" : 372553400,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18279",
      "updated_at" : "2020-03-11T08:30:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/390809490",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/8323581?v=4",
         "events_url" : "https://api.github.com/users/bvbfan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bvbfan/followers",
         "following_url" : "https://api.github.com/users/bvbfan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bvbfan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bvbfan",
         "id" : 8323581,
         "login" : "bvbfan",
         "node_id" : "MDQ6VXNlcjgzMjM1ODE=",
         "organizations_url" : "https://api.github.com/users/bvbfan/orgs",
         "received_events_url" : "https://api.github.com/users/bvbfan/received_events",
         "repos_url" : "https://api.github.com/users/bvbfan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bvbfan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bvbfan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bvbfan"
      }
   }
]
