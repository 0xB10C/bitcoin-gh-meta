[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #18274 (rpc/wallet: initialize nFeeRequired to avoid using garbage value on failure by kallewoof)\n* #16549 ([WIP] UI external signer support (e.g. hardware wallet) by Sjors)\n* #16546 ([WIP] External signer support - Wallet Box edition by Sjors)\n* #15729 (rpc: Raise error in getbalance if minconf is not zero by promag)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-02-24T20:52:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18202#issuecomment-590542670",
      "id" : 590542670,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18202",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5MDU0MjY3MA==",
      "updated_at" : "2020-03-09T06:13:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/590542670",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Dropped the dependency on #18115 since it was only necessary in the original PR. ",
      "created_at" : "2020-02-25T09:53:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18202#issuecomment-590781071",
      "id" : 590781071,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18202",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5MDc4MTA3MQ==",
      "updated_at" : "2020-02-25T09:53:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/590781071",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18202#discussion_r383951177"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18202"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/383951177"
         }
      },
      "author_association" : "MEMBER",
      "body" : "this string is changing yet I don't see associated test strings changing. Increase coverage?",
      "commit_id" : "6da80c72d780277e21201a464ab71746c2f1f333",
      "created_at" : "2020-02-25T15:28:05Z",
      "diff_hunk" : "@@ -326,36 +326,53 @@ static UniValue setlabel(const JSONRPCRequest& request)\n     return NullUniValue;\n }\n \n-\n-static CTransactionRef SendMoney(interfaces::Chain::Lock& locked_chain, CWallet * const pwallet, const CTxDestination &address, CAmount nValue, bool fSubtractFeeFromAmount, const CCoinControl& coin_control, mapValue_t mapValue)\n+UniValue SendMoney(interfaces::Chain::Lock& locked_chain, CWallet * const pwallet, CCoinControl coin_control, UniValue& address_amounts, mapValue_t mapValue, UniValue& subtractFeeFromAmount)\n {\n-    CAmount curBalance = pwallet->GetBalance(0, coin_control.m_avoid_address_reuse).m_mine_trusted;\n+    std::set<CTxDestination> destinations;\n+    std::vector<CRecipient> vecSend;\n+    for (const std::string& address: address_amounts.getKeys()) {\n+        CTxDestination dest = DecodeDestination(address);\n+        if (!IsValidDestination(dest)) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, std::string(\"Invalid Bitcoin address: \") + address);\n+        }\n \n-    // Check amount\n-    if (nValue <= 0)\n-        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Invalid amount\");\n+        if (destinations.count(dest)) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, std::string(\"Invalid parameter, duplicated address: \") + address);\n+        }\n+        destinations.insert(dest);\n \n-    if (nValue > curBalance)\n-        throw JSONRPCError(RPC_WALLET_INSUFFICIENT_FUNDS, \"Insufficient funds\");\n+        CScript scriptPubKey = GetScriptForDestination(dest);\n+        CAmount nAmount = AmountFromValue(address_amounts[address]);\n+        if (nAmount <= 0)\n+            throw JSONRPCError(RPC_TYPE_ERROR, \"Invalid amount for send\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18202#discussion_r383951177",
      "id" : 383951177,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzk1MTE3Nw==",
      "original_commit_id" : "ae2655d431622eac21869deb80e597e0c04f2778",
      "original_position" : 30,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : null,
      "pull_request_review_id" : 364232506,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18202",
      "updated_at" : "2020-02-25T19:15:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/383951177",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18202#discussion_r383953020"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18202"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/383953020"
         }
      },
      "author_association" : "MEMBER",
      "body" : "also good time to add braces to this conditional :)",
      "commit_id" : "6da80c72d780277e21201a464ab71746c2f1f333",
      "created_at" : "2020-02-25T15:30:49Z",
      "diff_hunk" : "@@ -326,36 +326,53 @@ static UniValue setlabel(const JSONRPCRequest& request)\n     return NullUniValue;\n }\n \n-\n-static CTransactionRef SendMoney(interfaces::Chain::Lock& locked_chain, CWallet * const pwallet, const CTxDestination &address, CAmount nValue, bool fSubtractFeeFromAmount, const CCoinControl& coin_control, mapValue_t mapValue)\n+UniValue SendMoney(interfaces::Chain::Lock& locked_chain, CWallet * const pwallet, CCoinControl coin_control, UniValue& address_amounts, mapValue_t mapValue, UniValue& subtractFeeFromAmount)\n {\n-    CAmount curBalance = pwallet->GetBalance(0, coin_control.m_avoid_address_reuse).m_mine_trusted;\n+    std::set<CTxDestination> destinations;\n+    std::vector<CRecipient> vecSend;\n+    for (const std::string& address: address_amounts.getKeys()) {\n+        CTxDestination dest = DecodeDestination(address);\n+        if (!IsValidDestination(dest)) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, std::string(\"Invalid Bitcoin address: \") + address);\n+        }\n \n-    // Check amount\n-    if (nValue <= 0)\n-        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Invalid amount\");\n+        if (destinations.count(dest)) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, std::string(\"Invalid parameter, duplicated address: \") + address);\n+        }\n+        destinations.insert(dest);\n \n-    if (nValue > curBalance)\n-        throw JSONRPCError(RPC_WALLET_INSUFFICIENT_FUNDS, \"Insufficient funds\");\n+        CScript scriptPubKey = GetScriptForDestination(dest);\n+        CAmount nAmount = AmountFromValue(address_amounts[address]);\n+        if (nAmount <= 0)\n+            throw JSONRPCError(RPC_TYPE_ERROR, \"Invalid amount for send\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18202#discussion_r383953020",
      "id" : 383953020,
      "in_reply_to_id" : 383951177,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzk1MzAyMA==",
      "original_commit_id" : "ae2655d431622eac21869deb80e597e0c04f2778",
      "original_position" : 30,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : null,
      "pull_request_review_id" : 364232506,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18202",
      "updated_at" : "2020-02-25T19:15:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/383953020",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18202#discussion_r384066419"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18202"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384066419"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`AmountFromValue` already checks the range, so dropping it here and adding a test with a negative value.",
      "commit_id" : "6da80c72d780277e21201a464ab71746c2f1f333",
      "created_at" : "2020-02-25T19:08:12Z",
      "diff_hunk" : "@@ -326,36 +326,53 @@ static UniValue setlabel(const JSONRPCRequest& request)\n     return NullUniValue;\n }\n \n-\n-static CTransactionRef SendMoney(interfaces::Chain::Lock& locked_chain, CWallet * const pwallet, const CTxDestination &address, CAmount nValue, bool fSubtractFeeFromAmount, const CCoinControl& coin_control, mapValue_t mapValue)\n+UniValue SendMoney(interfaces::Chain::Lock& locked_chain, CWallet * const pwallet, CCoinControl coin_control, UniValue& address_amounts, mapValue_t mapValue, UniValue& subtractFeeFromAmount)\n {\n-    CAmount curBalance = pwallet->GetBalance(0, coin_control.m_avoid_address_reuse).m_mine_trusted;\n+    std::set<CTxDestination> destinations;\n+    std::vector<CRecipient> vecSend;\n+    for (const std::string& address: address_amounts.getKeys()) {\n+        CTxDestination dest = DecodeDestination(address);\n+        if (!IsValidDestination(dest)) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, std::string(\"Invalid Bitcoin address: \") + address);\n+        }\n \n-    // Check amount\n-    if (nValue <= 0)\n-        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Invalid amount\");\n+        if (destinations.count(dest)) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, std::string(\"Invalid parameter, duplicated address: \") + address);\n+        }\n+        destinations.insert(dest);\n \n-    if (nValue > curBalance)\n-        throw JSONRPCError(RPC_WALLET_INSUFFICIENT_FUNDS, \"Insufficient funds\");\n+        CScript scriptPubKey = GetScriptForDestination(dest);\n+        CAmount nAmount = AmountFromValue(address_amounts[address]);\n+        if (nAmount <= 0)\n+            throw JSONRPCError(RPC_TYPE_ERROR, \"Invalid amount for send\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18202#discussion_r384066419",
      "id" : 384066419,
      "in_reply_to_id" : 383951177,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA2NjQxOQ==",
      "original_commit_id" : "ae2655d431622eac21869deb80e597e0c04f2778",
      "original_position" : 30,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : null,
      "pull_request_review_id" : 364374032,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18202",
      "updated_at" : "2020-02-25T19:15:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384066419",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18202#discussion_r384067001"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18202"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384067001"
         }
      },
      "author_association" : "MEMBER",
      "body" : "even better :) `CreateTransaction` checks as well, heh",
      "commit_id" : "6da80c72d780277e21201a464ab71746c2f1f333",
      "created_at" : "2020-02-25T19:09:18Z",
      "diff_hunk" : "@@ -326,36 +326,53 @@ static UniValue setlabel(const JSONRPCRequest& request)\n     return NullUniValue;\n }\n \n-\n-static CTransactionRef SendMoney(interfaces::Chain::Lock& locked_chain, CWallet * const pwallet, const CTxDestination &address, CAmount nValue, bool fSubtractFeeFromAmount, const CCoinControl& coin_control, mapValue_t mapValue)\n+UniValue SendMoney(interfaces::Chain::Lock& locked_chain, CWallet * const pwallet, CCoinControl coin_control, UniValue& address_amounts, mapValue_t mapValue, UniValue& subtractFeeFromAmount)\n {\n-    CAmount curBalance = pwallet->GetBalance(0, coin_control.m_avoid_address_reuse).m_mine_trusted;\n+    std::set<CTxDestination> destinations;\n+    std::vector<CRecipient> vecSend;\n+    for (const std::string& address: address_amounts.getKeys()) {\n+        CTxDestination dest = DecodeDestination(address);\n+        if (!IsValidDestination(dest)) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, std::string(\"Invalid Bitcoin address: \") + address);\n+        }\n \n-    // Check amount\n-    if (nValue <= 0)\n-        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Invalid amount\");\n+        if (destinations.count(dest)) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, std::string(\"Invalid parameter, duplicated address: \") + address);\n+        }\n+        destinations.insert(dest);\n \n-    if (nValue > curBalance)\n-        throw JSONRPCError(RPC_WALLET_INSUFFICIENT_FUNDS, \"Insufficient funds\");\n+        CScript scriptPubKey = GetScriptForDestination(dest);\n+        CAmount nAmount = AmountFromValue(address_amounts[address]);\n+        if (nAmount <= 0)\n+            throw JSONRPCError(RPC_TYPE_ERROR, \"Invalid amount for send\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18202#discussion_r384067001",
      "id" : 384067001,
      "in_reply_to_id" : 383951177,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA2NzAwMQ==",
      "original_commit_id" : "ae2655d431622eac21869deb80e597e0c04f2778",
      "original_position" : 30,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : null,
      "pull_request_review_id" : 364374749,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18202",
      "updated_at" : "2020-02-25T19:15:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384067001",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased and snake-cased.",
      "created_at" : "2020-02-25T19:15:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18202#issuecomment-591020548",
      "id" : 591020548,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18202",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5MTAyMDU0OA==",
      "updated_at" : "2020-02-25T19:15:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/591020548",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18202#discussion_r384071771"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18202"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384071771"
         }
      },
      "author_association" : "MEMBER",
      "body" : "now that I mention it, I'm a little shocked we don't have coverage on this?",
      "commit_id" : "6da80c72d780277e21201a464ab71746c2f1f333",
      "created_at" : "2020-02-25T19:18:28Z",
      "diff_hunk" : "@@ -309,6 +309,9 @@ def run_test(self):\n         assert_equal(tx_obj['amount'], Decimal('-0.0001'))\n \n         # General checks for errors from incorrect inputs\n+        # This will raise an exception because the amount is negative\n+        assert_raises_rpc_error(-3, \"Amount out of range\", self.nodes[0].sendtoaddress, self.nodes[2].getnewaddress(), \"-1\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18202#discussion_r384071771",
      "id" : 384071771,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA3MTc3MQ==",
      "original_commit_id" : "6da80c72d780277e21201a464ab71746c2f1f333",
      "original_position" : 14,
      "path" : "test/functional/wallet_basic.py",
      "position" : 14,
      "pull_request_review_id" : 364380725,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18202",
      "updated_at" : "2020-02-25T19:19:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384071771",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18202#discussion_r384074210"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18202"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384074210"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We do for the utility function via `createrawtransaction` tests.",
      "commit_id" : "6da80c72d780277e21201a464ab71746c2f1f333",
      "created_at" : "2020-02-25T19:23:07Z",
      "diff_hunk" : "@@ -309,6 +309,9 @@ def run_test(self):\n         assert_equal(tx_obj['amount'], Decimal('-0.0001'))\n \n         # General checks for errors from incorrect inputs\n+        # This will raise an exception because the amount is negative\n+        assert_raises_rpc_error(-3, \"Amount out of range\", self.nodes[0].sendtoaddress, self.nodes[2].getnewaddress(), \"-1\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18202#discussion_r384074210",
      "id" : 384074210,
      "in_reply_to_id" : 384071771,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA3NDIxMA==",
      "original_commit_id" : "6da80c72d780277e21201a464ab71746c2f1f333",
      "original_position" : 14,
      "path" : "test/functional/wallet_basic.py",
      "position" : 14,
      "pull_request_review_id" : 364383830,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18202",
      "updated_at" : "2020-02-25T19:23:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384074210",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18202#discussion_r384074794"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18202"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384074794"
         }
      },
      "author_association" : "MEMBER",
      "body" : "you mean `AmountFromValue`? I meant specifically for `sendtoaddress`. Anyways, a test is a win.",
      "commit_id" : "6da80c72d780277e21201a464ab71746c2f1f333",
      "created_at" : "2020-02-25T19:24:11Z",
      "diff_hunk" : "@@ -309,6 +309,9 @@ def run_test(self):\n         assert_equal(tx_obj['amount'], Decimal('-0.0001'))\n \n         # General checks for errors from incorrect inputs\n+        # This will raise an exception because the amount is negative\n+        assert_raises_rpc_error(-3, \"Amount out of range\", self.nodes[0].sendtoaddress, self.nodes[2].getnewaddress(), \"-1\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18202#discussion_r384074794",
      "id" : 384074794,
      "in_reply_to_id" : 384071771,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA3NDc5NA==",
      "original_commit_id" : "6da80c72d780277e21201a464ab71746c2f1f333",
      "original_position" : 14,
      "path" : "test/functional/wallet_basic.py",
      "position" : 14,
      "pull_request_review_id" : 364384583,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18202",
      "updated_at" : "2020-02-25T19:24:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384074794",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18202#discussion_r388386332"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18202"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/388386332"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This (order N, so in aggregate, quadratic) lookup would be unnecessary if the loop would iterate over key,value pairs in `address_amounts`. But I don't think univalue offers this functionality?",
      "commit_id" : "6da80c72d780277e21201a464ab71746c2f1f333",
      "created_at" : "2020-03-05T15:55:04Z",
      "diff_hunk" : "@@ -326,36 +326,51 @@ static UniValue setlabel(const JSONRPCRequest& request)\n     return NullUniValue;\n }\n \n-\n-static CTransactionRef SendMoney(interfaces::Chain::Lock& locked_chain, CWallet * const pwallet, const CTxDestination &address, CAmount nValue, bool fSubtractFeeFromAmount, const CCoinControl& coin_control, mapValue_t mapValue)\n+UniValue SendMoney(interfaces::Chain::Lock& locked_chain, CWallet * const pwallet, CCoinControl coin_control, UniValue& address_amounts, mapValue_t map_value, UniValue& subtract_fee_outputs)\n {\n-    CAmount curBalance = pwallet->GetBalance(0, coin_control.m_avoid_address_reuse).m_mine_trusted;\n+    std::set<CTxDestination> destinations;\n+    std::vector<CRecipient> recipients;\n+    for (const std::string& address: address_amounts.getKeys()) {\n+        CTxDestination dest = DecodeDestination(address);\n+        if (!IsValidDestination(dest)) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, std::string(\"Invalid Bitcoin address: \") + address);\n+        }\n+\n+        if (destinations.count(dest)) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, std::string(\"Invalid parameter, duplicated address: \") + address);\n+        }\n+        destinations.insert(dest);\n+\n+        CScript script_pub_key = GetScriptForDestination(dest);\n+        CAmount amount = AmountFromValue(address_amounts[address]);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18202#discussion_r388386332",
      "id" : 388386332,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM4NjMzMg==",
      "original_commit_id" : "6da80c72d780277e21201a464ab71746c2f1f333",
      "original_position" : 23,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : 23,
      "pull_request_review_id" : 369690314,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18202",
      "updated_at" : "2020-03-05T15:55:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/388386332",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18202#discussion_r388391093"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18202"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/388391093"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Please add braces here as required by the style guidelines, or put the `subtrace_fee...` on the same line.\r\nI was to suggest using ranged for here but that doesn't work for univalue as there's no `begin()` and `end()`.",
      "commit_id" : "6da80c72d780277e21201a464ab71746c2f1f333",
      "created_at" : "2020-03-05T16:00:57Z",
      "diff_hunk" : "@@ -326,36 +326,51 @@ static UniValue setlabel(const JSONRPCRequest& request)\n     return NullUniValue;\n }\n \n-\n-static CTransactionRef SendMoney(interfaces::Chain::Lock& locked_chain, CWallet * const pwallet, const CTxDestination &address, CAmount nValue, bool fSubtractFeeFromAmount, const CCoinControl& coin_control, mapValue_t mapValue)\n+UniValue SendMoney(interfaces::Chain::Lock& locked_chain, CWallet * const pwallet, CCoinControl coin_control, UniValue& address_amounts, mapValue_t map_value, UniValue& subtract_fee_outputs)\n {\n-    CAmount curBalance = pwallet->GetBalance(0, coin_control.m_avoid_address_reuse).m_mine_trusted;\n+    std::set<CTxDestination> destinations;\n+    std::vector<CRecipient> recipients;\n+    for (const std::string& address: address_amounts.getKeys()) {\n+        CTxDestination dest = DecodeDestination(address);\n+        if (!IsValidDestination(dest)) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, std::string(\"Invalid Bitcoin address: \") + address);\n+        }\n+\n+        if (destinations.count(dest)) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, std::string(\"Invalid parameter, duplicated address: \") + address);\n+        }\n+        destinations.insert(dest);\n+\n+        CScript script_pub_key = GetScriptForDestination(dest);\n+        CAmount amount = AmountFromValue(address_amounts[address]);\n \n-    // Check amount\n-    if (nValue <= 0)\n-        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Invalid amount\");\n+        bool subtract_fee = false;\n+        for (unsigned int idx = 0; idx < subtract_fee_outputs.size(); idx++) {\n+            const UniValue& addr = subtract_fee_outputs[idx];\n+            if (addr.get_str() == address)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18202#discussion_r388391093",
      "id" : 388391093,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM5MTA5Mw==",
      "original_commit_id" : "6da80c72d780277e21201a464ab71746c2f1f333",
      "original_position" : 31,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : 31,
      "pull_request_review_id" : 369696962,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18202",
      "updated_at" : "2020-03-05T16:00:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/388391093",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Nice cleanup, overall!",
      "created_at" : "2020-03-05T16:01:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18202#issuecomment-595306434",
      "id" : 595306434,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18202",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5NTMwNjQzNA==",
      "updated_at" : "2020-03-05T16:01:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/595306434",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK, looks good",
      "created_at" : "2020-03-09T07:27:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18202#issuecomment-596369570",
      "id" : 596369570,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18202",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5NjM2OTU3MA==",
      "updated_at" : "2020-03-09T07:27:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/596369570",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/3211283?v=4",
         "events_url" : "https://api.github.com/users/meshcollider/events{/privacy}",
         "followers_url" : "https://api.github.com/users/meshcollider/followers",
         "following_url" : "https://api.github.com/users/meshcollider/following{/other_user}",
         "gists_url" : "https://api.github.com/users/meshcollider/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/meshcollider",
         "id" : 3211283,
         "login" : "meshcollider",
         "node_id" : "MDQ6VXNlcjMyMTEyODM=",
         "organizations_url" : "https://api.github.com/users/meshcollider/orgs",
         "received_events_url" : "https://api.github.com/users/meshcollider/received_events",
         "repos_url" : "https://api.github.com/users/meshcollider/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/meshcollider/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/meshcollider/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/meshcollider"
      }
   }
]
