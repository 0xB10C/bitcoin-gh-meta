[
   {
      "body" : "Fine with me. Reorg is still a problem, but relaying the tip is at least better than relaying nothing.\r\n\r\nTo solve the reorg-problem, I would want to also call FindNextBlocksToDownload on pruned-nodes, if it is ensured that we can not ask them for pruned blocks.\r\n@sipa Would this be possible, to just call FindNextBlocksToDownload also for pruned nodes, when we are close to being synced?",
      "created_at" : "2015-05-16T11:30:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6148#issuecomment-102613206",
      "id" : 102613206,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6148",
      "updated_at" : "2015-05-16T11:30:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/102613206",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2814559?v=3",
         "events_url" : "https://api.github.com/users/cozz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/cozz/followers",
         "following_url" : "https://api.github.com/users/cozz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/cozz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/cozz",
         "id" : 2814559,
         "login" : "cozz",
         "organizations_url" : "https://api.github.com/users/cozz/orgs",
         "received_events_url" : "https://api.github.com/users/cozz/received_events",
         "repos_url" : "https://api.github.com/users/cozz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/cozz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/cozz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/cozz"
      }
   },
   {
      "body" : "ACK. Tested for tip relay for master and reorg relay (up to a certain depth) for 0.9.",
      "created_at" : "2015-05-17T21:00:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6148#issuecomment-102857824",
      "id" : 102857824,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6148",
      "updated_at" : "2015-05-17T21:00:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/102857824",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "body" : "I just sopped my pruned node, added this PR on top of the current master, ran again and had the following issue:\r\n\r\n**Stopping:**\r\n```\r\nPrune: target=550MiB actual=467MiB diff=82MiB min_must_keep=356959 removed 0 blk/rev pairs\r\nreceive version message: /bitcoinseeder:0.01/: version 60000, blocks=230000, us=***:8334, peer=18138\r\nreceive version message: /Snoopy:0.1/: version 60001, blocks=0, us=***:8334, peer=18139\r\nreceive version message: /bitcoinseeder:0.01/: version 60000, blocks=230000, us=***:8334, peer=18140\r\nreceive version message: /bitcoinseeder:0.01/: version 60000, blocks=230000, us=***:8334, peer=18141\r\nreceive version message: /getaddr.bitnodes.io:0.1/: version 70002, blocks=357246, us=***:8334, peer=18142\r\nreceive version message: /getaddr.bitnodes.io:0.1/: version 70002, blocks=357246, us=***:8334, peer=18143\r\nreceive version message: /bitcoinseeder:0.01/: version 60000, blocks=230000, us=***:8334, peer=18144\r\nERROR: AcceptToMemoryPool: nonstandard transaction: dust\r\nreceive version message: /breadwallet:0.5.1/: version 70002, blocks=0, us=***:8334, peer=18145\r\nAdded time data, samples 200, offset -1 (+0 minutes)\r\nreceive version message: /Snoopy:0.1/: version 60001, blocks=0, us=***:8334, peer=18146\r\nreceive version message: /getaddr.bitnodes.io:0.1/: version 70002, blocks=357247, us=****:8334, peer=18147\r\nreceive version message: /bitcoinseeder:0.01/: version 60000, blocks=230000, us=***:8334, peer=18148\r\n^Cnet thread interrupt\r\nmsghand thread interrupt\r\naddcon thread interrupt\r\nopencon thread interrupt\r\ndumpaddr thread stop\r\nShutdown: In progress...\r\nRPCAcceptHandler: Error: Operation canceled\r\nRPCAcceptHandler: Error: Operation canceled\r\nStopNode()\r\nPrune: target=550MiB actual=467MiB diff=82MiB min_must_keep=356959 removed 0 blk/rev pairs\r\nShutdown: done\r\n```\r\n\r\n**Restarting (after serval seconds/minutes):**\r\n```\r\nAppInit2 : parameter interaction: -prune -> setting -disablewallet=1\r\nPrune configured to target 550MiB on disk for block and undo files.\r\n---snip---\r\nBitcoin version v0.10.99.0-4b30ade (2015-05-20 11:45:07 +0200)\r\nUsing OpenSSL version OpenSSL 1.0.1e 11 Feb 2013\r\nUsing BerkeleyDB version Berkeley DB 4.8.30: (April  9, 2010)\r\nDefault data directory ***\r\nUsing data directory ***\r\nUsing config file ***/bitcoin.conf\r\nUsing at most 125 connections (1024 file descriptors available)\r\nUsing 8 threads for script verification\r\nscheduler thread start\r\nAllowing RPC connections from: 127.0.0.0/255.0.0.0 ::1/ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff\r\nBinding RPC on address ::1 port *** (IPv4+IPv6 bind any: 0)\r\nBinding RPC on address 127.0.0.1 port *** (IPv4+IPv6 bind any: 0)\r\nBound to [::]:8334\r\nBound to 0.0.0.0:8334\r\nCache configuration:\r\n* Using 2.0MiB for block index database\r\n* Using 32.5MiB for chain state database\r\n* Using 65.5MiB for in-memory UTXO set\r\ninit message: Loading block index...  \r\nOpening LevelDB in ***/blocks/index\r\nOpened LevelDB successfully\r\nOpening LevelDB in ***/chainstate\r\nOpened LevelDB successfully\r\nLoadBlockIndexDB: last block file = 271\r\nLoadBlockIndexDB: last block file info: CBlockFileInfo(blocks=70, size=30105947, heights=357178...357247, time=2015-05-19...2015-05-20)\r\nChecking all blk files are present... \r\nUnable to open file ***/blocks/blk00264.dat\r\n: Error loading block database.\r\n\r\nDo you want to rebuild the block database now?\r\n: Error loading block database.\r\n\r\nDo you want to rebuild the block database now?\r\nAborted block database rebuild. Exiting.\r\nShutdown: In progress...\r\n```\r\n\r\nI doubt that it has something to do with this PR but it could lead to another existing issue.",
      "created_at" : "2015-05-20T11:04:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6148#issuecomment-103843806",
      "id" : 103843806,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6148",
      "updated_at" : "2015-05-20T11:04:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/103843806",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "My `/blocks` dir contains the following:\r\n```\r\nblk00268.dat  blk00269.dat  blk00270.dat  blk00271.dat  index  rev00268.dat  rev00269.dat  rev00270.dat  rev00271.dat\r\n```",
      "created_at" : "2015-05-20T11:06:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6148#issuecomment-103844273",
      "id" : 103844273,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6148",
      "updated_at" : "2015-05-20T11:06:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/103844273",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "Further up i can see in my log that `blk00264.dat` has been deleted because of pruning (around 9 days ago).\r\n\r\n```\r\nreceive version message: /btccrawler.ch:v0.1/: version 70002, blocks=355967, us=***:8334, peer=729\r\nERROR: AcceptToMemoryPool: nonstandard transaction: dust\r\nPrune: target=550MiB actual=532MiB diff=17MiB min_must_keep=355679 removed 0 blk/rev pairs\r\nPrune: target=550MiB actual=388MiB diff=161MiB min_must_keep=355679 removed 1 blk/rev pairs\r\nPrune: UnlinkPrunedFiles deleted blk/rev (00264)\r\nUpdateTip: new best=00000000000000000cbfa2566c81e0bc78f37b66e35ff3657d552154ca9436ca  height=355968  log2_work=82.765851  tx=68384633  date=2015-05-11 20:16:36 progress=1.\r\n00000  cache=0\r\n```",
      "created_at" : "2015-05-20T11:14:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6148#issuecomment-103846388",
      "id" : 103846388,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6148",
      "updated_at" : "2015-05-20T11:14:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/103846388",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "@jonasschnelli any chance you had been running with #6118 and then switched to running without? This looks exactly like what happens when trying to downgrade from lazy updating of mapBlockIndex. If that is the issue you can workaround by restarting your node with #6118 and then quickly stopping; the block index is refreshed on startup. You could then restart without the lazy updating code and things should work fine.",
      "created_at" : "2015-05-20T12:15:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6148#issuecomment-103860722",
      "id" : 103860722,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6148",
      "updated_at" : "2015-05-20T12:15:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/103860722",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "@sdaftuar pretty sure i did this. I'll now try to run a master-full-node, sync up, add this PR on top and continue to confirm the missing-lazy-update issue.",
      "created_at" : "2015-05-20T12:19:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6148#issuecomment-103861280",
      "id" : 103861280,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6148",
      "updated_at" : "2015-05-20T12:19:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/103861280",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "Stopped a full-node, copied datadir, ran a new master-full-node with the just copied datadir and pruning target 550, stopped after a while, added this PR on top and it looks good.\r\n\r\nNow testing block relying.",
      "created_at" : "2015-05-20T12:59:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6148#issuecomment-103875842",
      "id" : 103875842,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6148",
      "updated_at" : "2015-05-20T12:59:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/103875842",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   }
]
