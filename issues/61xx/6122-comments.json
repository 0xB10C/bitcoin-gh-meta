[
   {
      "body" : "We should do something like this, but it won't help without also having\nsome means of advertizing that we can relay blocks, as right now, nobody\nshould even be connecting to pruned nodes (which advertize as spv nodes).\n",
      "created_at" : "2015-05-12T09:19:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6122#issuecomment-101207642",
      "id" : 101207642,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6122",
      "updated_at" : "2015-05-12T09:19:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/101207642",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "@sipa Can you point me to the code, where we dont connect to pruned nodes, please?\r\nBecause I assumed we dont distinguish on service-bits in the connection logic.",
      "created_at" : "2015-05-12T09:29:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6122#issuecomment-101211657",
      "id" : 101211657,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6122",
      "updated_at" : "2015-05-12T09:29:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/101211657",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2814559?v=3",
         "events_url" : "https://api.github.com/users/cozz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/cozz/followers",
         "following_url" : "https://api.github.com/users/cozz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/cozz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/cozz",
         "id" : 2814559,
         "login" : "cozz",
         "organizations_url" : "https://api.github.com/users/cozz/orgs",
         "received_events_url" : "https://api.github.com/users/cozz/received_events",
         "repos_url" : "https://api.github.com/users/cozz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/cozz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/cozz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/cozz"
      }
   },
   {
      "body" : "Unsure, addnode may work, but automatic discovery shouldn't.\n",
      "created_at" : "2015-05-12T10:08:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6122#issuecomment-101221514",
      "id" : 101221514,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6122",
      "updated_at" : "2015-05-12T10:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/101221514",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "So you dont know the code? Didnt you write the address-manager?\r\n\r\nWell, I will go bother and test now, if a node without NODE_NETWORK announces his ip, and whether or not we add it and connect to it with the address-manager. Because exactly that is, what I was assuming.",
      "created_at" : "2015-05-12T10:21:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6122#issuecomment-101224062",
      "id" : 101224062,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6122",
      "updated_at" : "2015-05-12T10:21:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/101224062",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2814559?v=3",
         "events_url" : "https://api.github.com/users/cozz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/cozz/followers",
         "following_url" : "https://api.github.com/users/cozz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/cozz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/cozz",
         "id" : 2814559,
         "login" : "cozz",
         "organizations_url" : "https://api.github.com/users/cozz/orgs",
         "received_events_url" : "https://api.github.com/users/cozz/received_events",
         "repos_url" : "https://api.github.com/users/cozz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/cozz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/cozz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/cozz"
      }
   },
   {
      "body" : "So I dont know how to test this NODE_NETWORK thing.\r\n\r\nThe address-manager does not care about nServices, so from my understanding, there is no difference between NODE_NETWORK-nodes and non-NODE_NETWORK-nodes.\r\nWe make a difference after we have connected in the version message, but not before.\r\n\r\nI any case this pull request does not hurt. Block relay is highest priority, and I believe we really should always announce the block, whenever possible.\r\n\r\nLets say someone runs a bunch of full nodes, because he wants to contribute to the network, then\r\nour -prune feature is really bad, if suddenly all those nodes dont relay blocks anymore.\r\nThe guy thinks that he is doing something good for the network and himself (with pruning) while\r\nits not.\r\n\r\nIf what you are saying is true, that nobody connects to pruned nodes, this would be also bad, because\r\nthis is not even mentioned in the help-message. If so, there is a big fat warning missing. \r\nBut again, I can not even find this behavior in the source code.",
      "created_at" : "2015-05-12T13:25:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6122#issuecomment-101275210",
      "id" : 101275210,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6122",
      "updated_at" : "2015-05-12T13:25:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/101275210",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2814559?v=3",
         "events_url" : "https://api.github.com/users/cozz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/cozz/followers",
         "following_url" : "https://api.github.com/users/cozz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/cozz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/cozz",
         "id" : 2814559,
         "login" : "cozz",
         "organizations_url" : "https://api.github.com/users/cozz/orgs",
         "received_events_url" : "https://api.github.com/users/cozz/received_events",
         "repos_url" : "https://api.github.com/users/cozz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/cozz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/cozz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/cozz"
      }
   },
   {
      "body" : "ACK concept.\r\n\r\nI don't think this pull-req should be gated on whether or not we advertise that other nodes should connect to us; relaying is always valuable to ensure the P2P network is well connected. Note how if you start a node with -listen=0 you'll never have anyone connect to you, yet we still relay blocks. The same logic should apply here.\r\n\r\nWhat I don't get is why make this dependent on the peer's advertised starting height? Why should their height (which may be out of date) have any relevance to whether or not we relay a block? Instead I think this should be based only on our height, with an appropriate window to prevent stalls.\r\n\r\nAs for the size of that window... isn't this code only triggered when *we* get a new block? You'd have to get a burst of >288 blocks in a row in non-initial-download mode to run into that problem - seems rather unlikely. I'm not sure it's really worth having extra code for such an unlikely case.",
      "created_at" : "2015-05-12T14:39:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6122#issuecomment-101303688",
      "id" : 101303688,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6122",
      "updated_at" : "2015-05-12T14:39:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/101303688",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "body" : "@petertodd The code I added only cares about the height of the other node, for both nStartingHeight and pindexBestKnownBlock. The reason is that this avoids, that the other node asks us for blocks we dont have.  If we know, that the other has at least what we have (minus 288), nothing can go wrong. \r\nThe code already is executed for (!fInitialDownload), which is based on our height. So there must have been a reason why it has been disabled in the first place. So I added, to also care about the other nodes height.\r\n\r\nI am just very unhappy, with block relay being completely disabled for pruning. To me, this is a bug.\r\n",
      "created_at" : "2015-05-12T16:16:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6122#issuecomment-101335936",
      "id" : 101335936,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6122",
      "updated_at" : "2015-05-12T16:16:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/101335936",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2814559?v=3",
         "events_url" : "https://api.github.com/users/cozz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/cozz/followers",
         "following_url" : "https://api.github.com/users/cozz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/cozz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/cozz",
         "id" : 2814559,
         "login" : "cozz",
         "organizations_url" : "https://api.github.com/users/cozz/orgs",
         "received_events_url" : "https://api.github.com/users/cozz/received_events",
         "repos_url" : "https://api.github.com/users/cozz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/cozz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/cozz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/cozz"
      }
   },
   {
      "body" : "@cozz Whoops, yeah, brainfart on my part. That exception is reasonable, although the fact we need it is annoying. :( Pity that we still deal with stalling peers so badly.\r\n\r\nDefinitely agree re: the total disabling. Heck, I even argue that SPV nodes should be forwarding blocks.",
      "created_at" : "2015-05-12T16:41:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6122#issuecomment-101343867",
      "id" : 101343867,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6122",
      "updated_at" : "2015-05-12T16:41:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/101343867",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   }
]
