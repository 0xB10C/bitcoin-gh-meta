[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#15721](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15721.html) (validation: Check absence of locks at compile-time (LOCKS_EXCLUDED) in addition to the current run-time checking (AssertLockNotHeld) by practicalswift)\n* [#15700](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15700.html) (rfc: Synchronize validation interface registration by promag)\n* [#15699](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15699.html) (Remove no-op CClientUIInterface::[signal_name]_disconnect. Disconnect BlockNotifyGenesisWait and RPCNotifyBlockChange properly. by practicalswift)\n* [#15685](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15685.html) (doc: rpc-mining: Clarify error messages by MarcoFalke)\n* [#15670](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15670.html) (refactor: combine Chain::findFirstBlockWithTime/findFirstBlockWithTimeAndHeight by ariard)\n* [#15632](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15632.html) (Remove ResendWalletTransactions from the Validation Interface by jnewbery)\n* [#15192](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15192.html) (Add missing cs_main locks in ThreadImport(...)/Shutdown(...)/gettxoutsetinfo(...)/InitScriptExecutionCache(). Add missing locking annotations. by practicalswift)\n* [#15191](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15191.html) (validation: Add missing cs_{LastBlockFile,nBlockSequenceId} locks in PruneAndFlush() and UnloadBlockIndex(). Add missing locking annotations. by practicalswift)\n* [#14856](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/14856.html) (net: remove more CConnman globals (theuni) by dongcarl)\n* [#14193](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/14193.html) (validation: Add missing mempool locks by MarcoFalke)\n* [#14121](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/14121.html) (Index for BIP 157 block filters by jimpo)\n* [#13868](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/13868.html) (Remove unused fScriptChecks parameter from CheckInputs by Empact)\n* [#13713](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/13713.html) (Ignore new blocks when -stopatheight target has been reached by jonasschnelli)\n* [#13686](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/13686.html) (ZMQ: Small cleanups in the ZMQ code by domob1812)\n* [#13582](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/13582.html) (Extract AppInitLoadBlockIndex from AppInitMain by Empact)\n* [#13462](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/13462.html) (Make SER_GETHASH implicit for CHashWriter and SerializeHash by Empact)\n* [#13045](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/13045.html) ([p2p] getblock for 1-block reorgs in response to compact block message by instagibbs)\n* [#9849](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/9849.html) (Qt: Network Watch tool by luke-jr)\n* [#9384](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/9384.html) (CCoinsViewCache code cleanup & deduplication by ryanofsky)\n* [#9381](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/9381.html) (Remove CWalletTx merging logic from AddToWallet by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2019-03-15T15:07:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-473322663",
      "id" : 473322663,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3MzMyMjY2Mw==",
      "updated_at" : "2019-04-02T17:20:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/473322663",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Presumably the snapshot would be taken relatively close to the current tip but far enough away to avoid meaningful reorgs, say 10,000 blocks deep.\r\n\r\nTo be clear, the snapshot can't be terribly recent for the user of it or it breaks the security model. Assume valid only has any security at all if there is time for the review and communication about review to happen, which means a human timescale of at least weeks.\r\n\r\nProbably the assumption should be that snapshots are created pretty close to tip, just far enough to avoid wasting time in reorgs (even 6 blocks would be fine) but the users aren't using them until they are quite a bit older, likely using the second to most recent available one.\r\n\r\n> We don't serve blocks or transactions to the network while we're operating with an unvalidated snapshot-based chain.\r\n\r\nWe shouldn't do that.  The worst that getting it wrong does is getting us disconnected from peers, which isn't particularly cosmic (and at least we might notice that something is going wrong).  The downside of it is that not forwarding transactions shoots our privacy in the head, since any transaction we're emitting would be one we created.\r\n\r\n> When we attempt to load a wallet with a BestBlock locator lower than the base of a snapshot and the snapshot has not yet been validated, we refuse to load the wallet.\r\n\r\nSounds good.\r\n\r\n>  compare it with the claimed hash in the snapshot metadata.\r\n\r\nThis is a zero security approach.  You can't just ask the user for a value and then accept that. The attack is to reorg the chain and then announce to everyone that there is a node bug and you need to run this command to continue, we specifically engineered out that possibility in assumevalid.  This isn't hypothetical, this is exactly what we've seen happen in ethereum w/ fastsync.\r\n\r\nThis is a fine setup for testing your PR however!    Ultimately we should get it to a state where a (FEC-split) copy of the state is loaded from the network and where it can be tested against a publicly reviewed constants configured in the software and/or blockchain.",
      "created_at" : "2019-03-15T19:39:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-473416823",
      "id" : 473416823,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3MzQxNjgyMw==",
      "updated_at" : "2019-03-15T19:39:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/473416823",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Probably the assumption should be that snapshots are created pretty close to tip, just far enough to avoid wasting time in reorgs (even 6 blocks would be fine) but the users aren't using them until they are quite a bit older, likely using the second to most recent available one.\r\n\r\nYep - I figured that we'd update the assumeutxo hash in lockstep with assumevalid's.\r\n\r\n> We shouldn't do that. The worst that getting it wrong does is getting us disconnected from peers, which isn't particularly cosmic (and at least we might notice that something is going wrong). The downside of it is that not forwarding transactions shoots our privacy in the head [...]\r\n\r\nGood points, will fix that.\r\n\r\n> This is a zero security approach. You can't just ask the user for a value and then accept that.\r\n\r\nAgreed - the check I do there is just for sanity. Deciding on an initial hardcoded `assumeutxo` hash seems corequisite to allowing snapshots to be loadable through RPC (or any other means).\r\n",
      "created_at" : "2019-03-19T14:11:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-474387827",
      "id" : 474387827,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3NDM4NzgyNw==",
      "updated_at" : "2019-03-19T14:11:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/474387827",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2019-03-21T08:25:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-475144784",
      "id" : 475144784,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3NTE0NDc4NA==",
      "updated_at" : "2019-03-21T08:25:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/475144784",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "There are so many code changes here, and it seems like 80% of them are just renames. I know you are putting off really breaking this up and restructuring it, but maybe you could start by just splitting b2a735d00d3c297cdfdd93609c12537497025ca1 in two commits: one that adds the new classes and function arguments and brute force renames without changing behavior, and a smaller one with the new functionality. That way reviewers could see the more interesting changes without having to go through all the mind-numbing renames.",
      "created_at" : "2019-03-26T19:39:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-476815777",
      "id" : 476815777,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3NjgxNTc3Nw==",
      "updated_at" : "2019-03-26T19:39:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/476815777",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the suggestion, @ryanofsky. I spent the last few days reconstructing the changeset into sensible commits - hopefully it's easier to understand this way.\r\n\r\nMost of the early commits are just shuffling stuff around (though all of it strictly necessary AFAICT). I've phrased the changes as much as possible as scripted-diffs and move-onlys. In replaying the changes, I found a few unnecessary diffs to omit.\r\n\r\nIf anyone has additional suggestions for how this could be made easier to review, I'm all ears, though I'm not holding my breath waiting until some Concept (N)ACKs roll in on #15605. ",
      "created_at" : "2019-03-30T01:41:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#issuecomment-478194695",
      "id" : 478194695,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15606",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3ODE5NDY5NQ==",
      "updated_at" : "2019-03-30T01:41:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/478194695",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r270963373"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/270963373"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"move-only: make the CChainState interface public\" (77e5c902168ca2191448c5f8924b6831dc2717b9)\r\n\r\nBetter to drop anonymous namespace. It doesn't actually hide any functionality and causes warnings:\r\n\r\n```\r\n./validation.h:487:7: warning: Ã¢ÂÂCChainStateÃ¢ÂÂ has a field Ã¢ÂÂCChainState::setBlockIndexCandidatesÃ¢ÂÂ whose type uses the anonymous namespace [-Wsubobject-linkage]\r\n```\r\n",
      "commit_id" : "1bb64fcf1cb94e28c4090909e229f546757d25de",
      "created_at" : "2019-04-01T17:03:11Z",
      "diff_hunk" : "@@ -437,6 +438,161 @@ inline CBlockIndex* LookupBlockIndex(const uint256& hash)\n /** Find the last common block between the parameter chain and a locator. */\n CBlockIndex* FindForkInGlobalIndex(const CChain& chain, const CBlockLocator& locator) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+enum DisconnectResult\n+{\n+    DISCONNECT_OK,      // All good.\n+    DISCONNECT_UNCLEAN, // Rolled back, but UTXO set was inconsistent with block.\n+    DISCONNECT_FAILED   // Something else went wrong.\n+};\n+\n+class ConnectTrace;\n+\n+namespace {\n+    struct CBlockIndexWorkComparator",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r270963373",
      "id" : 270963373,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MDk2MzM3Mw==",
      "original_commit_id" : "77e5c902168ca2191448c5f8924b6831dc2717b9",
      "original_position" : 22,
      "path" : "src/validation.h",
      "position" : 102,
      "pull_request_review_id" : 221234122,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "updated_at" : "2019-04-01T19:15:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/270963373",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271006988"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271006988"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"refactoring: introduce unused ChainActive()\" (b5627060df9c7876d91391e34c84a7e4fb1ff378)\r\n\r\nLine seems unrelated to this commit. Maybe move to commit that first uses this.",
      "commit_id" : "1bb64fcf1cb94e28c4090909e229f546757d25de",
      "created_at" : "2019-04-01T18:59:57Z",
      "diff_hunk" : "@@ -614,6 +614,11 @@ void ResetBlockFailureFlags(CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(cs_mai\n /** The currently-connected chain of blocks (protected by cs_main). */\n extern CChain& chainActive;\n \n+extern CChainState g_chainstate;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271006988",
      "id" : 271006988,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTAwNjk4OA==",
      "original_commit_id" : "b5627060df9c7876d91391e34c84a7e4fb1ff378",
      "original_position" : 4,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 221234122,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "updated_at" : "2019-04-01T19:15:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271006988",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271010773"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271010773"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"refactoring: introduce ChainstateActive()\" (612d1b5df556eb70eb5fb670d166a1d7927e6efc)\r\n\r\nThis is returning a pointer, but none of the places calling it are checking null, so it seems like it'd be better to return a reference instead. Also would make `ChainstateActive()` more consistent with `ChainActive()`",
      "commit_id" : "1bb64fcf1cb94e28c4090909e229f546757d25de",
      "created_at" : "2019-04-01T19:10:52Z",
      "diff_hunk" : "@@ -60,6 +60,8 @@\n \n CChainState g_chainstate;\n \n+CChainState* ChainstateActive() { return &g_chainstate; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271010773",
      "id" : 271010773,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTAxMDc3Mw==",
      "original_commit_id" : "612d1b5df556eb70eb5fb670d166a1d7927e6efc",
      "original_position" : 4,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 221234122,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "updated_at" : "2019-04-01T19:15:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271010773",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271014661"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271014661"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Does `CBlockIndexWorkComparator` have to be in the header or would it be sufficient to forward declare and put the implementation in the cpp file only?",
      "commit_id" : "1bb64fcf1cb94e28c4090909e229f546757d25de",
      "created_at" : "2019-04-01T19:22:48Z",
      "diff_hunk" : "@@ -437,6 +438,161 @@ inline CBlockIndex* LookupBlockIndex(const uint256& hash)\n /** Find the last common block between the parameter chain and a locator. */\n CBlockIndex* FindForkInGlobalIndex(const CChain& chain, const CBlockLocator& locator) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+enum DisconnectResult\n+{\n+    DISCONNECT_OK,      // All good.\n+    DISCONNECT_UNCLEAN, // Rolled back, but UTXO set was inconsistent with block.\n+    DISCONNECT_FAILED   // Something else went wrong.\n+};\n+\n+class ConnectTrace;\n+\n+namespace {\n+    struct CBlockIndexWorkComparator",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271014661",
      "id" : 271014661,
      "in_reply_to_id" : 270963373,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTAxNDY2MQ==",
      "original_commit_id" : "77e5c902168ca2191448c5f8924b6831dc2717b9",
      "original_position" : 22,
      "path" : "src/validation.h",
      "position" : 102,
      "pull_request_review_id" : 221299363,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "updated_at" : "2019-04-01T19:22:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271014661",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271018669"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271018669"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It has to be in the header because it affects the layout of the CChainState object.",
      "commit_id" : "1bb64fcf1cb94e28c4090909e229f546757d25de",
      "created_at" : "2019-04-01T19:34:55Z",
      "diff_hunk" : "@@ -437,6 +438,161 @@ inline CBlockIndex* LookupBlockIndex(const uint256& hash)\n /** Find the last common block between the parameter chain and a locator. */\n CBlockIndex* FindForkInGlobalIndex(const CChain& chain, const CBlockLocator& locator) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+enum DisconnectResult\n+{\n+    DISCONNECT_OK,      // All good.\n+    DISCONNECT_UNCLEAN, // Rolled back, but UTXO set was inconsistent with block.\n+    DISCONNECT_FAILED   // Something else went wrong.\n+};\n+\n+class ConnectTrace;\n+\n+namespace {\n+    struct CBlockIndexWorkComparator",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271018669",
      "id" : 271018669,
      "in_reply_to_id" : 270963373,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTAxODY2OQ==",
      "original_commit_id" : "77e5c902168ca2191448c5f8924b6831dc2717b9",
      "original_position" : 22,
      "path" : "src/validation.h",
      "position" : 102,
      "pull_request_review_id" : 221304557,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "updated_at" : "2019-04-01T19:34:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271018669",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271434904"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271434904"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"refactoring: FlushStateToDisk -> CChainState\" (c9d13d26314e2368562a1612bc0c89f3099c4154)\r\n\r\nCould keep this comment, I think it applies to the whole block of function declarations.",
      "commit_id" : "1bb64fcf1cb94e28c4090909e229f546757d25de",
      "created_at" : "2019-04-02T18:16:44Z",
      "diff_hunk" : "@@ -158,15 +158,6 @@ std::unique_ptr<CCoinsViewDB> pcoinsdbview;\n std::unique_ptr<CCoinsViewCache> pcoinsTip;\n std::unique_ptr<CBlockTreeDB> pblocktree;\n \n-enum class FlushStateMode {\n-    NONE,\n-    IF_NEEDED,\n-    PERIODIC,\n-    ALWAYS\n-};\n-\n-// See definition for documentation",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271434904",
      "id" : 271434904,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTQzNDkwNA==",
      "original_commit_id" : "c9d13d26314e2368562a1612bc0c89f3099c4154",
      "original_position" : 11,
      "path" : "src/validation.cpp",
      "position" : 241,
      "pull_request_review_id" : 221823542,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "updated_at" : "2019-04-02T22:10:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271434904",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271440899"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271440899"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"refactoring: FlushStateToDisk -> CChainState\" (c9d13d26314e2368562a1612bc0c89f3099c4154)\r\n\r\nI think it'd be better not to have these default parameters and chain guessing code:\r\n\r\n```c++\r\nif (!chainstate) {\r\n    chainstate = ::ChainstateActive();\r\n}\r\n```\r\n\r\nIt seems like choosing a chain implicitly makes the call sites less straightforward, and increases the risk of a bug due to using the wrong chain.\r\n\r\nAlso, I don't think having these defaults arguments would be a good idea even if they made the diff smaller, but I think they might actually make it bigger, since these functions aren't called very many places.",
      "commit_id" : "1bb64fcf1cb94e28c4090909e229f546757d25de",
      "created_at" : "2019-04-02T18:31:26Z",
      "diff_hunk" : "@@ -290,9 +291,9 @@ void PruneOneBlockFile(const int fileNumber) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune);\n \n /** Flush all state, indexes and buffers to disk. */\n-void FlushStateToDisk();\n+void FlushStateToDisk(CChainState* chainstate = nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271440899",
      "id" : 271440899,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTQ0MDg5OQ==",
      "original_commit_id" : "c9d13d26314e2368562a1612bc0c89f3099c4154",
      "original_position" : 13,
      "path" : "src/validation.h",
      "position" : 54,
      "pull_request_review_id" : 221823542,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "updated_at" : "2019-04-02T22:10:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271440899",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271504421"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271504421"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"refactoring: IsInitialBlockDownload -> CChainState\" (e9fab103e6f81cf32b09618ea9a70540616f7da8)\r\n\r\nWould call this `m_cached_in_ibd` or something to indicate the value may not be up to date. I could imagine incorrect code that checks `m_in_ibd` when it should be calling `IsInitialBlockDownload` instead. Calling this \"cached\" would make the bug more obvious. \r\n\r\nCould also update the comment above to suggest calling IsInitialBlockDownload instead of accessing this variable.",
      "commit_id" : "1bb64fcf1cb94e28c4090909e229f546757d25de",
      "created_at" : "2019-04-02T21:33:04Z",
      "diff_hunk" : "@@ -540,6 +538,14 @@ class CChainState {\n      */\n     CCriticalSection m_cs_chainstate;\n \n+    /**\n+     * Is this chainstate undergoing initial block download?\n+     *\n+     * Mutable because we need to be able to mark IsInitialBlockDownload()\n+     * const, which toggles this for caching purposes.\n+     */\n+    mutable std::atomic<bool> m_is_ibd;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271504421",
      "id" : 271504421,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTUwNDQyMQ==",
      "original_commit_id" : "e9fab103e6f81cf32b09618ea9a70540616f7da8",
      "original_position" : 19,
      "path" : "src/validation.h",
      "position" : 192,
      "pull_request_review_id" : 221823542,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "updated_at" : "2019-04-02T22:10:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271504421",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271506825"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271506825"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"move-onlyish: move CCoinsViewErrorCatcher out of init.cpp\" (e8e09fcb16b7e358a88b4f38d0d8af49a3eafac3)\r\n\r\nI think this comment makes more sense in the place where it was written previously (in class definition rather than in GetCoin method implementation).",
      "commit_id" : "1bb64fcf1cb94e28c4090909e229f546757d25de",
      "created_at" : "2019-04-02T21:40:59Z",
      "diff_hunk" : "@@ -258,3 +258,21 @@ const Coin& AccessByTxid(const CCoinsViewCache& view, const uint256& txid)\n     }\n     return coinEmpty;\n }\n+\n+bool CCoinsViewErrorCatcher::GetCoin(const COutPoint &outpoint, Coin &coin) const {\n+    try {\n+        return CCoinsViewBacked::GetCoin(outpoint, coin);\n+    } catch(const std::runtime_error& e) {\n+        for (auto f : m_err_callbacks) {\n+            f();\n+        }\n+        LogPrintf(\"Error reading from database: %s\\n\", e.what());\n+        // Starting the shutdown sequence and returning false to the caller would be\n+        // interpreted as 'entry not found' (as opposed to unable to read data), and\n+        // could lead to invalid interpretation. Just exit immediately, as we can't\n+        // continue anyway, and all writes should be atomic.\n+        std::abort();\n+    }\n+\n+    // Writes do not need similar protection, as failure to write is handled by the caller.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271506825",
      "id" : 271506825,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTUwNjgyNQ==",
      "original_commit_id" : "e8e09fcb16b7e358a88b4f38d0d8af49a3eafac3",
      "original_position" : 20,
      "path" : "src/coins.cpp",
      "position" : 20,
      "pull_request_review_id" : 221823542,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "updated_at" : "2019-04-02T22:10:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271506825",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271507466"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271507466"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"move-onlyish: move CCoinsViewErrorCatcher out of init.cpp\" (e8e09fcb16b7e358a88b4f38d0d8af49a3eafac3)\r\n\r\nSpacing seems off, maybe use clang-format for the new code.",
      "commit_id" : "1bb64fcf1cb94e28c4090909e229f546757d25de",
      "created_at" : "2019-04-02T21:43:04Z",
      "diff_hunk" : "@@ -311,4 +313,28 @@ void AddCoins(CCoinsViewCache& cache, const CTransaction& tx, int nHeight, bool\n //! lookups to database, so it should be used with care.\n const Coin& AccessByTxid(const CCoinsViewCache& cache, const uint256& txid);\n \n+/**\n+ * This is a minimally invasive approach to shutdown on LevelDB read errors from the\n+ * chainstate, while keeping user interface out of the common library, which is shared\n+ * between bitcoind, and bitcoin-qt and non-server tools.\n+*/\n+class CCoinsViewErrorCatcher final : public CCoinsViewBacked\n+{\n+public:\n+    typedef std::function<void()> Function;\n+\n+    explicit CCoinsViewErrorCatcher(CCoinsView* view) : CCoinsViewBacked(view) {}\n+\n+    void AddReadErrCallback(const Function f) {\n+      m_err_callbacks.push_back(f);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271507466",
      "id" : 271507466,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTUwNzQ2Ng==",
      "original_commit_id" : "e8e09fcb16b7e358a88b4f38d0d8af49a3eafac3",
      "original_position" : 33,
      "path" : "src/coins.h",
      "position" : 41,
      "pull_request_review_id" : 221823542,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "updated_at" : "2019-04-02T22:10:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271507466",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271508985"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271508985"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"move-onlyish: move CCoinsViewErrorCatcher out of init.cpp\" (e8e09fcb16b7e358a88b4f38d0d8af49a3eafac3)\r\n\r\nNot a big deal, but it would be nice to avoid copies:\r\n\r\n```\r\nvoid AddReadErrCallback(Function f) {\r\n    m_err_callbacks.emplace_back(std::move(f));\r\n}\r\n```",
      "commit_id" : "1bb64fcf1cb94e28c4090909e229f546757d25de",
      "created_at" : "2019-04-02T21:48:04Z",
      "diff_hunk" : "@@ -311,4 +313,28 @@ void AddCoins(CCoinsViewCache& cache, const CTransaction& tx, int nHeight, bool\n //! lookups to database, so it should be used with care.\n const Coin& AccessByTxid(const CCoinsViewCache& cache, const uint256& txid);\n \n+/**\n+ * This is a minimally invasive approach to shutdown on LevelDB read errors from the\n+ * chainstate, while keeping user interface out of the common library, which is shared\n+ * between bitcoind, and bitcoin-qt and non-server tools.\n+*/\n+class CCoinsViewErrorCatcher final : public CCoinsViewBacked\n+{\n+public:\n+    typedef std::function<void()> Function;\n+\n+    explicit CCoinsViewErrorCatcher(CCoinsView* view) : CCoinsViewBacked(view) {}\n+\n+    void AddReadErrCallback(const Function f) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271508985",
      "id" : 271508985,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTUwODk4NQ==",
      "original_commit_id" : "e8e09fcb16b7e358a88b4f38d0d8af49a3eafac3",
      "original_position" : 32,
      "path" : "src/coins.h",
      "position" : 40,
      "pull_request_review_id" : 221823542,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "updated_at" : "2019-04-02T22:10:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271508985",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271513853"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271513853"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"refactoring: move block metadata into BlockMetadataManager\" (155ee896520e51b8a13d6904e3a14b5fa50295c0)\r\n\r\nIt seems like a step backwards to be replacing a local reference with a global reference. I get that BlockMetadataManager is a singleton shared between multiple chainstates, but I think it's a mistake to add global references to it all over the code. If you could add a `BlockMetadataManager& m_blockmetaman` member to CChainState (also needs forward declaration and initialization in constructor), and replace \r\n`g_blockmetaman` with `m_blockmetaman` where possible, I think it would help make relationship between the classes clearer, and also be a step in the direction of making validation code more testable and possible to break apart.",
      "commit_id" : "1bb64fcf1cb94e28c4090909e229f546757d25de",
      "created_at" : "2019-04-02T22:04:54Z",
      "diff_hunk" : "@@ -1148,7 +1209,7 @@ void static InvalidChainFound(CBlockIndex* pindexNew) EXCLUSIVE_LOCKS_REQUIRED(c\n void CChainState::InvalidBlockFound(CBlockIndex *pindex, const CValidationState &state) {\n     if (!state.CorruptionPossible()) {\n         pindex->nStatus |= BLOCK_FAILED_VALID;\n-        m_failed_blocks.insert(pindex);\n+        g_blockmetaman.m_failed_blocks.insert(pindex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15606#discussion_r271513853",
      "id" : 271513853,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3MTUxMzg1Mw==",
      "original_commit_id" : "155ee896520e51b8a13d6904e3a14b5fa50295c0",
      "original_position" : 101,
      "path" : "src/validation.cpp",
      "position" : 510,
      "pull_request_review_id" : 221823542,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15606",
      "updated_at" : "2019-04-02T22:10:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/271513853",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   }
]
