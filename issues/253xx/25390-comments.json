[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#25314](https://github.com/bitcoin/bitcoin/pull/25314) (p2p: always set nTime for self-advertisements by mzumsande)\n* [#25152](https://github.com/bitcoin/bitcoin/pull/25152) (refactor: Split util/system into exception, shell, and fs-specific files by Empact)\n* [#23531](https://github.com/bitcoin/bitcoin/pull/23531) (Add Yggdrasil support by prusnak)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-06-16T15:04:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1157765950",
      "id" : 1157765950,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25390",
      "node_id" : "IC_kwDOABII585FAhs-",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1157765950/reactions"
      },
      "updated_at" : "2022-06-16T15:04:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1157765950",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "This seems like a potentially useful alternative to clang thread safety annotations. The `ThreadSafePtr<T>` class forces code to lock a mutex when accessing data, just like TSA annotations do, except unlike TSA annotations, it doesn't rely on a nonstandard compiler extension, or suffer from quirks that come from doing a limited static analysis.\r\n\r\n`ThreadSafePtr<T>` is obviously not a complete substitute for thread safety annotations since it only handles the simple case where a single non-recursive Mutex is used to protect access to a single variable. But the variable can have any C++ type (primitive, container, or struct), so it's probably flexible enough for a lot of cases.\r\n\r\nI don't think the `ThreadSafePtr<T>` is the best name because `xxx_ptr<T>` implies the type is some kind of lightweight reference to the `T`, not a container which holds the `T`. I would call it something like `Synced<T>` or `LockedData<T>`. (An analogy here would be `std::optional<T>`, which is not called `std::optional_ptr<T>`, even though it has `*` and `->` members, because it's purpose is to be a container, not a pointer. The class is named after what it's used for not what kind of members it has.)",
      "created_at" : "2022-06-16T17:28:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#issuecomment-1157945376",
      "id" : 1157945376,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25390",
      "node_id" : "IC_kwDOABII585FBNgg",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1157945376/reactions"
      },
      "updated_at" : "2022-06-16T17:28:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1157945376",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r899366531"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/899366531"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"sync: introduce a thread safe smart pointer\" (3d77fdb3127649d560c8f39d8ab83d32c9d0dff6)\r\n\r\nI think it would be an improvement to just give these methods a normal name like `Lock` instead of making them operators. Calling code would change from:\r\n\r\n```c++\r\nauto v_locked = *v;\r\nfor (auto& i : v_locked) ...\r\n```\r\n\r\nto \r\n\r\n```c++\r\nauto v_locked = v.Lock();\r\nfor (auto& i : v_locked) ...\r\n```\r\n\r\nwhich would be clearer and simpler. Proxy class is the actual class acting like a pointer so it needs `*` and `->` methods. But outer `ThreadSafePtr` class is not really a pointer at all, but a container, so there is not a concrete reason it needs to have `*` and `->` members unless that's an aesthetic preference.",
      "commit_id" : "e577177a339d5a833ba82c9656fa0291ad05b001",
      "created_at" : "2022-06-16T17:42:39Z",
      "diff_hunk" : "@@ -400,4 +400,98 @@ class CSemaphoreGrant\n     }\n };\n \n+/**\n+ * A smart pointer that protects the owned object with a mutex.\n+ * Every time the pointer is dereferenced a mutex is acquired and held locked\n+ * for the duration of the method being executed. For example, the following is\n+ * safe:\n+ * @code{.cpp}\n+ * ThreadSafePtr<std::vector<int>> v;\n+ *\n+ * std::thread t1{[&v]() { v->push_back(5); }};\n+ * std::thread t2{[&v]() { v->push_back(6); }};\n+ * @endcode\n+ *\n+ * It is possible so acquire the mutex for longer time than just for a single call:\n+ * @code{.cpp}\n+ * ThreadSafePtr<std::vector<int>> v{5, 6, 7, 8};\n+ *\n+ * {\n+ *     auto v_locked = *v;  // acquires the mutex\n+ *     for (auto& i : v_locked) {\n+ *         i *= 10;\n+ *     }\n+ *     // the mutex is released when `v_locked` is destroyed\n+ * }\n+ * // will result in `v` being `{50, 60, 70, 80}`\n+ * @endcode\n+ */\n+template <typename T>\n+class ThreadSafePtr\n+{\n+public:\n+    /**\n+     * Construct the smart pointer and its internal object of type T,\n+     * passing `args...` to its constructor.\n+     */\n+    template <typename... Args>\n+    ThreadSafePtr(Args... args) : m_obj{args...}\n+    {\n+    }\n+\n+    /**\n+     * An auxiliary class that holds a mutex locked for the duration of its\n+     * lifetime and provides access to another object. For exaple:\n+     * @code{.cpp}\n+     * Proxy p{mutex, obj}; // acquires the mutex\n+     *\n+     * p->foo(); // `foo()` is a method of `obj`, the mutex is still locked\n+     * p->bar(); // `bar()` is a method of `obj`, the mutex is still locked\n+     *\n+     * // if `obj` provides `operator[]` (e.g. `std::map`), then the following is also ok:\n+     * p[5] = 10; // the mutex is still locked\n+     *\n+     * // if `obj` provides `begin()`/`end()` methods, then the following is also ok:\n+     * for (auto& x : p) { ... } // the mutex is still locked\n+     *\n+     * // the mutex is released when `p` is destroyed\n+     * @endcode\n+     */\n+    class Proxy\n+    {\n+    public:\n+        Proxy(Mutex& mutex, T& obj)\n+            : m_lock{mutex, \"ThreadSafePtrMutex\", __FILE__, __LINE__},\n+              m_raw_ptr_to_obj{&obj}\n+        {\n+        }\n+\n+        T* operator->() { return m_raw_ptr_to_obj; }\n+        const T* operator->() const { return m_raw_ptr_to_obj; }\n+\n+        template <typename Key>\n+        auto& operator[](Key key)\n+        {\n+            return (*m_raw_ptr_to_obj)[key];\n+        }\n+\n+        auto begin() { return m_raw_ptr_to_obj->begin(); }\n+        auto end() { return m_raw_ptr_to_obj->end(); }\n+\n+    private:\n+        const UniqueLock<Mutex> m_lock;\n+        T* const m_raw_ptr_to_obj;\n+    };\n+\n+    Proxy operator->() { return Proxy{m_mutex, m_obj}; }\n+    const Proxy operator->() const { return Proxy{m_mutex, m_obj}; }\n+\n+    Proxy operator*() { return Proxy{m_mutex, m_obj}; }\n+    const Proxy operator*() const { return Proxy{m_mutex, m_obj}; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r899366531",
      "id" : 899366531,
      "line" : 490,
      "node_id" : "PRRC_kwDOABII5841mz6D",
      "original_commit_id" : "3d77fdb3127649d560c8f39d8ab83d32c9d0dff6",
      "original_line" : 490,
      "original_position" : 91,
      "original_start_line" : 486,
      "path" : "src/sync.h",
      "position" : 91,
      "pull_request_review_id" : 1009459470,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/899366531/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 486,
      "start_side" : "RIGHT",
      "updated_at" : "2022-06-16T18:02:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/899366531",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r899380437"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/899380437"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"sync: introduce a thread safe smart pointer\" (3d77fdb3127649d560c8f39d8ab83d32c9d0dff6)\r\n\r\nI'm pretty sure the const version of these -> and * methods are unusable and will always lead to compile errors if you ever tried to call them. If you want to allow accessing contents of const `ThreadSafePtr` objects, probably you need to introduce Proxy/ConstProxy classes similar to c++ iterator/const_interator classes. Otherwise you could drop these const methods.",
      "commit_id" : "e577177a339d5a833ba82c9656fa0291ad05b001",
      "created_at" : "2022-06-16T17:59:12Z",
      "diff_hunk" : "@@ -400,4 +400,98 @@ class CSemaphoreGrant\n     }\n };\n \n+/**\n+ * A smart pointer that protects the owned object with a mutex.\n+ * Every time the pointer is dereferenced a mutex is acquired and held locked\n+ * for the duration of the method being executed. For example, the following is\n+ * safe:\n+ * @code{.cpp}\n+ * ThreadSafePtr<std::vector<int>> v;\n+ *\n+ * std::thread t1{[&v]() { v->push_back(5); }};\n+ * std::thread t2{[&v]() { v->push_back(6); }};\n+ * @endcode\n+ *\n+ * It is possible so acquire the mutex for longer time than just for a single call:\n+ * @code{.cpp}\n+ * ThreadSafePtr<std::vector<int>> v{5, 6, 7, 8};\n+ *\n+ * {\n+ *     auto v_locked = *v;  // acquires the mutex\n+ *     for (auto& i : v_locked) {\n+ *         i *= 10;\n+ *     }\n+ *     // the mutex is released when `v_locked` is destroyed\n+ * }\n+ * // will result in `v` being `{50, 60, 70, 80}`\n+ * @endcode\n+ */\n+template <typename T>\n+class ThreadSafePtr\n+{\n+public:\n+    /**\n+     * Construct the smart pointer and its internal object of type T,\n+     * passing `args...` to its constructor.\n+     */\n+    template <typename... Args>\n+    ThreadSafePtr(Args... args) : m_obj{args...}\n+    {\n+    }\n+\n+    /**\n+     * An auxiliary class that holds a mutex locked for the duration of its\n+     * lifetime and provides access to another object. For exaple:\n+     * @code{.cpp}\n+     * Proxy p{mutex, obj}; // acquires the mutex\n+     *\n+     * p->foo(); // `foo()` is a method of `obj`, the mutex is still locked\n+     * p->bar(); // `bar()` is a method of `obj`, the mutex is still locked\n+     *\n+     * // if `obj` provides `operator[]` (e.g. `std::map`), then the following is also ok:\n+     * p[5] = 10; // the mutex is still locked\n+     *\n+     * // if `obj` provides `begin()`/`end()` methods, then the following is also ok:\n+     * for (auto& x : p) { ... } // the mutex is still locked\n+     *\n+     * // the mutex is released when `p` is destroyed\n+     * @endcode\n+     */\n+    class Proxy\n+    {\n+    public:\n+        Proxy(Mutex& mutex, T& obj)\n+            : m_lock{mutex, \"ThreadSafePtrMutex\", __FILE__, __LINE__},\n+              m_raw_ptr_to_obj{&obj}\n+        {\n+        }\n+\n+        T* operator->() { return m_raw_ptr_to_obj; }\n+        const T* operator->() const { return m_raw_ptr_to_obj; }\n+\n+        template <typename Key>\n+        auto& operator[](Key key)\n+        {\n+            return (*m_raw_ptr_to_obj)[key];\n+        }\n+\n+        auto begin() { return m_raw_ptr_to_obj->begin(); }\n+        auto end() { return m_raw_ptr_to_obj->end(); }\n+\n+    private:\n+        const UniqueLock<Mutex> m_lock;\n+        T* const m_raw_ptr_to_obj;\n+    };\n+\n+    Proxy operator->() { return Proxy{m_mutex, m_obj}; }\n+    const Proxy operator->() const { return Proxy{m_mutex, m_obj}; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25390#discussion_r899380437",
      "id" : 899380437,
      "line" : 487,
      "node_id" : "PRRC_kwDOABII5841m3TV",
      "original_commit_id" : "3d77fdb3127649d560c8f39d8ab83d32c9d0dff6",
      "original_line" : 487,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "src/sync.h",
      "position" : 88,
      "pull_request_review_id" : 1009459470,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25390",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/899380437/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-16T18:02:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/899380437",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   }
]
