[
   {
      "author_association" : "MEMBER",
      "body" : "Thanks, I've been looking into the design of these virtual classes (in #24150 and revisiting it more deeply lately), will have a look.",
      "created_at" : "2022-06-13T18:34:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/25365#issuecomment-1154248783",
      "id" : 1154248783,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25365",
      "node_id" : "IC_kwDOABII585EzHBP",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1154248783/reactions"
      },
      "updated_at" : "2022-06-13T18:34:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1154248783",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "This should fix it:\r\n\r\n<details>\r\n<summary>blind, guess, unverified, possible fix</summary>\r\n\r\n```diff\r\ndiff --git i/src/test/coinstatsindex_tests.cpp w/src/test/coinstatsindex_tests.cpp\r\nindex 2a6a777cfe..b78cac8908 100644\r\n--- i/src/test/coinstatsindex_tests.cpp\r\n+++ w/src/test/coinstatsindex_tests.cpp\r\n@@ -3,12 +3,13 @@\r\n // file COPYING or http://www.opensource.org/licenses/mit-license.php.\r\n \r\n #include <chainparams.h>\r\n #include <index/coinstatsindex.h>\r\n #include <interfaces/chain.h>\r\n #include <kernel/coinstats.h>\r\n+#include <scheduler.h>\r\n #include <test/util/setup_common.h>\r\n #include <test/util/validation.h>\r\n #include <util/time.h>\r\n #include <validation.h>\r\n \r\n #include <boost/test/unit_test.hpp>\r\n@@ -76,12 +77,16 @@ BOOST_FIXTURE_TEST_CASE(coinstatsindex_initial_sync, TestChain100Setup)\r\n \r\n     BOOST_CHECK(block_index != new_block_index);\r\n \r\n     // Shutdown sequence (c.f. Shutdown() in init.cpp)\r\n     coin_stats_index.Stop();\r\n \r\n+    // Stop the scheduler which may be using coin_stats_index (how?) before\r\n+    // coin_stats_index gets destroyed at the end of this function.\r\n+    m_node.scheduler->stop();\r\n+\r\n     // Rest of shutdown sequence and destructors happen in ~TestingSetup()\r\n }\r\n \r\n // Test shutdown between BlockConnected and ChainStateFlushed notifications,\r\n // make sure index is not corrupted and is able to reload.\r\n BOOST_FIXTURE_TEST_CASE(coinstatsindex_unclean_shutdown, TestChain100Setup)\r\n```\r\n</details>\r\n\r\nThough I do not understand how the scheduler picked the local variable `coin_stats_index` from the test.\r\n",
      "created_at" : "2022-09-16T11:40:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/25365#issuecomment-1249260516",
      "id" : 1249260516,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25365",
      "node_id" : "IC_kwDOABII585KdjPk",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1249260516/reactions"
      },
      "updated_at" : "2022-09-16T11:40:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1249260516",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Oh good catch. Though, I don't think your patch fixes it. Stopping the scheduler will have no effect on the queue. The event will still be triggered later on (when the queue is drained) and cause the segfault. You'd have to flush/sync the queue before destructing the index. See also init.cpp:\r\n\r\n\r\n```cpp\r\n    // After there are no more peers/RPC left to give us new data which may generate\r\n    // CValidationInterface callbacks, flush them...\r\n    GetMainSignals().FlushBackgroundCallbacks();\r\n\r\n    // Stop and delete all indexes only after flushing background callbacks.\r\n...\r\n```\r\n\r\n\r\n> Though I do not understand how the scheduler picked the local variable coin_stats_index from the test.\r\n\r\nThe pointer is passed over in `BaseIndex::Start`:\r\n\r\n```cpp\r\n    RegisterValidationInterface(this);\r\n",
      "created_at" : "2022-09-16T12:26:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/25365#issuecomment-1249301796",
      "id" : 1249301796,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25365",
      "node_id" : "IC_kwDOABII585KdtUk",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1249301796/reactions"
      },
      "updated_at" : "2022-09-16T12:26:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1249301796",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
