[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #19809 (log: Prefix log messages with function name if -logfunctionnames is set by practicalswift)\n* #16673 (Relog configuration args on debug.log rotation by LarryRuane)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-09-22T18:55:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19995#issuecomment-696915422",
      "id" : 696915422,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19995",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5NjkxNTQyMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-22T18:55:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/696915422",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK. I was wondering about this threat several times over last year, but never managed to look into it for real.",
      "created_at" : "2020-09-23T07:25:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19995#issuecomment-697185481",
      "id" : 697185481,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19995",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5NzE4NTQ4MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-23T07:25:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/697185481",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I'm not sure about this. This kind of \"drop everything\" rate limiting can be used for a different kind of DoS that might be even more serious than just shutting down: prevent important things from being logged.",
      "created_at" : "2020-09-23T12:04:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19995#issuecomment-697319173",
      "id" : 697319173,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19995",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5NzMxOTE3Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-23T12:06:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/697319173",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@laanwj \r\n\r\nHave you looked at the implementation? It certainly doesn't drop everything :)\r\n\r\nThe implementation was carefully written to minimise the risk of suppressing something important from being logged while at the same time killing the disk-fill-via-peer-triggered-logging bug class for good.\r\n\r\nDo you have any ideas on how to improve the implementation in a way to reduce the \"prevent important things from being logged\" risk?\r\n\r\nPerhaps this implementation isn't the way to go but I really think we need _some_ kind of general mitigation for disk fill attacks. This is a non-theoretical DoS vector which has been problematic for Bitcoin Core historically.\r\n",
      "created_at" : "2020-09-23T13:14:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19995#issuecomment-697356204",
      "id" : 697356204,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19995",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5NzM1NjIwNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-23T13:25:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/697356204",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I don't know how hard of a task that would be, but it would be great to see how easy it is to fill disk space depending on the protocol piece (message but also context).\r\nFor example,\r\ntx INV: X bytes per second\r\nADDR: Y bytes per second\r\nGETADDR: Z bytes per second\r\n\r\nFrom there we could make sure our rate-limiting is effective?",
      "created_at" : "2020-09-23T13:56:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19995#issuecomment-697394173",
      "id" : 697394173,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19995",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5NzM5NDE3Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-23T14:05:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/697394173",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@naumenkogs \r\n\r\nWhen testing this patch I reverted the fix for an historic disk fill bug to see if this mitigation would have been successful.\r\n\r\nIn that case an untrusted peer could achieve a disk fill rate of 15 GB/hour without this mitigation, and the expected 1 MB/hour with this mitigation. (The 15 GB/hour was achieved on a really old machine with mechanical disks so YMMV.)\r\n\r\nIn other words: the mitigation slowed that specific attack by a factor of 15 000 :)\r\n\r\nNote that the quota is set *per source location*. So every single source location (say `net_processing.cpp:418`) gets a quota of 1 MB of logging per hour. I think we could bump that to 10 MB/hour or even 100 MB/hour and still largely kill this bug class.\r\n\r\nPerhaps I misunderstood what you meant by the `INV`/`ADDR`/`GETADDR` bytes per second thing, but we only log per such message via `LogPrint(CATEGORY, â¦)` (`-debug`). `LogPrint(CATEGORY, â¦)` is intentionally not covered by the rate limiting, since end-users opt-ing in to `-debug` are assumed to know that doing so may cause excessive disk usage :)\r\n\r\nThe goal of this PR is to kill this bug class for a `bitcoind` node running with default settings (no `-debug`).",
      "created_at" : "2020-09-23T14:21:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19995#issuecomment-697434667",
      "id" : 697434667,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19995",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5NzQzNDY2Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-23T14:26:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/697434667",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   }
]
