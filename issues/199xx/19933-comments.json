[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Liked the first version better...\r\n\r\nme 2 , but failed with some standard cases, i guess there are better way's to do this?\r\nWhat we need is a patch without trailing'/' siggh... \r\n",
      "created_at" : "2020-09-10T18:16:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19933#issuecomment-690596101",
      "id" : 690596101,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19933",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5MDU5NjEwMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-10T18:16:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/690596101",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/34917548?v=4",
         "events_url" : "https://api.github.com/users/Saibato/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Saibato/followers",
         "following_url" : "https://api.github.com/users/Saibato/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Saibato/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Saibato",
         "id" : 34917548,
         "login" : "Saibato",
         "node_id" : "MDQ6VXNlcjM0OTE3NTQ4",
         "organizations_url" : "https://api.github.com/users/Saibato/orgs",
         "received_events_url" : "https://api.github.com/users/Saibato/received_events",
         "repos_url" : "https://api.github.com/users/Saibato/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Saibato/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Saibato/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Saibato"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19933#discussion_r486547248"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19933"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486547248"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Would it be safer to use `.at()` for bounds checks/no UB?\r\n\r\nnit, clang-formatting\r\n```diff\r\n-    while(wallet_dir.string()[offset-1] == '\\\\' || wallet_dir.string()[offset-1] == '/')\r\n-    {\r\n+    while (wallet_dir.string()[offset - 1] == '\\\\' || wallet_dir.string()[offset - 1] == '/') {\r\n```",
      "commit_id" : "19c5aba04d2cfff7049e076645691beac2268f56",
      "created_at" : "2020-09-10T18:23:51Z",
      "diff_hunk" : "@@ -57,10 +57,16 @@ bool IsBerkeleyBtree(const fs::path& path)\n std::vector<fs::path> ListWalletDir()\n {\n     const fs::path wallet_dir = GetWalletDir();\n-    const size_t offset = wallet_dir.string().size() + 1;\n+    size_t offset = wallet_dir.string().size();\n     std::vector<fs::path> paths;\n     boost::system::error_code ec;\n \n+    // account for possible trailing backslash, since we have boost below 1,60\n+    while(wallet_dir.string()[offset-1] == '\\\\' || wallet_dir.string()[offset-1] == '/')\n+    {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19933#discussion_r486547248",
      "id" : 486547248,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjU0NzI0OA==",
      "original_commit_id" : "966907b529b4c782da2fb1ee915d86c674ddde5f",
      "original_line" : 66,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/wallet/walletutil.cpp",
      "position" : null,
      "pull_request_review_id" : 486201877,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19933",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-10T18:47:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486547248",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19933#discussion_r486549932"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19933"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486549932"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "yup,  draft ugly and no checks, maybe i close it, that PR is now like POC.\r\nWhat we need is an elegant way with just boost 1.47   to do this. \r\nIdeas?\r\nedit:\r\nwhat would be nice to have />\r\n const fs::path path = fs::relative(it->path(), wallet_dir)",
      "commit_id" : "19c5aba04d2cfff7049e076645691beac2268f56",
      "created_at" : "2020-09-10T18:27:27Z",
      "diff_hunk" : "@@ -57,10 +57,16 @@ bool IsBerkeleyBtree(const fs::path& path)\n std::vector<fs::path> ListWalletDir()\n {\n     const fs::path wallet_dir = GetWalletDir();\n-    const size_t offset = wallet_dir.string().size() + 1;\n+    size_t offset = wallet_dir.string().size();\n     std::vector<fs::path> paths;\n     boost::system::error_code ec;\n \n+    // account for possible trailing backslash, since we have boost below 1,60\n+    while(wallet_dir.string()[offset-1] == '\\\\' || wallet_dir.string()[offset-1] == '/')\n+    {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19933#discussion_r486549932",
      "id" : 486549932,
      "in_reply_to_id" : 486547248,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjU0OTkzMg==",
      "original_commit_id" : "966907b529b4c782da2fb1ee915d86c674ddde5f",
      "original_line" : 66,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/wallet/walletutil.cpp",
      "position" : null,
      "pull_request_review_id" : 486204411,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19933",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-10T18:47:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486549932",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/34917548?v=4",
         "events_url" : "https://api.github.com/users/Saibato/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Saibato/followers",
         "following_url" : "https://api.github.com/users/Saibato/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Saibato/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Saibato",
         "id" : 34917548,
         "login" : "Saibato",
         "node_id" : "MDQ6VXNlcjM0OTE3NTQ4",
         "organizations_url" : "https://api.github.com/users/Saibato/orgs",
         "received_events_url" : "https://api.github.com/users/Saibato/received_events",
         "repos_url" : "https://api.github.com/users/Saibato/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Saibato/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Saibato/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Saibato"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19933#discussion_r486560730"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19933"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486560730"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe try `(wallet_dir / \"dummy\").remove_filename().string().size()`",
      "commit_id" : "19c5aba04d2cfff7049e076645691beac2268f56",
      "created_at" : "2020-09-10T18:44:44Z",
      "diff_hunk" : "@@ -57,10 +57,16 @@ bool IsBerkeleyBtree(const fs::path& path)\n std::vector<fs::path> ListWalletDir()\n {\n     const fs::path wallet_dir = GetWalletDir();\n-    const size_t offset = wallet_dir.string().size() + 1;\n+    size_t offset = wallet_dir.string().size();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19933#discussion_r486560730",
      "id" : 486560730,
      "line" : 60,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjU2MDczMA==",
      "original_commit_id" : "966907b529b4c782da2fb1ee915d86c674ddde5f",
      "original_line" : 60,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/walletutil.cpp",
      "position" : 5,
      "pull_request_review_id" : 486216244,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19933",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-10T18:47:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486560730",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19933#discussion_r486561426"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19933"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486561426"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Suggest we assert substr(0, offset) == what we used for calculating offset above",
      "commit_id" : "19c5aba04d2cfff7049e076645691beac2268f56",
      "created_at" : "2020-09-10T18:46:00Z",
      "diff_hunk" : "@@ -69,7 +75,7 @@ std::vector<fs::path> ListWalletDir()\n \n         // Get wallet path relative to walletdir by removing walletdir from the wallet path.\n         // This can be replaced by boost::filesystem::lexically_relative once boost is bumped to 1.60.\n-        const fs::path path = it->path().string().substr(offset);\n+        const fs::path path = it->path().string().substr(offset + 1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19933#discussion_r486561426",
      "id" : 486561426,
      "line" : 77,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjU2MTQyNg==",
      "original_commit_id" : "966907b529b4c782da2fb1ee915d86c674ddde5f",
      "original_line" : 77,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/wallet/walletutil.cpp",
      "position" : 22,
      "pull_request_review_id" : 486217077,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19933",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-10T18:47:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486561426",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Could `GetWalletDir()` return a \"clean\" path?\r\n\r\nThat would be nice to have.\r\nIt defaults in the error case we tackle here to `GetDataDir()`  we would need then in `GetWalletDir()` to strip all trailing chars off type fs::path::preferred_separator. there.\r\nBut that could also tangle deep into other parts where we need `GetWalletDir.`\r\n    \r\nTested that a bit, but then I found that path could be also like  \"/tmp////...\\\\.////test...///\\\\/////\" a hell\r\nto strip correctly,without boost > 1.47 siggh.\r\nTo go for size was so far what worked with all sorts of path and syminks. \r\nAnd here we only build somewhat symlinks to the real wallet names an path .\r\n\r\nAt least it will return at minimum a single  \".\" so it will not empty for the back() string call.\r\n\r\nedit@saibato\r\n\r\n@promag  this alternative patch just in `GetWalletDir()` would also work to mitigate the  error. like suggest.\r\nNot sure whats better and if there no side effects to other parts?\r\nSo far i counted 7 references.\r\n \r\nAt least some fewer lines so less error?\r\n   \r\n ``` Diff\r\ndiff --git a/src/wallet/walletutil.cpp b/src/wallet/walletutil.cpp\r\nindex e4c72aed9..afd915f82 100644\r\n--- a/src/wallet/walletutil.cpp\r\n+++ b/src/wallet/walletutil.cpp\r\n@@ -20,6 +20,9 @@ fs::path GetWalletDir()\r\n         }\r\n     } else {\r\n         path = GetDataDir();\r\n+        if (path.string().back() == fs::path::preferred_separator) {\r\n+            path = path.parent_path().string();\r\n+        }\r\n         // If a wallets directory exists, use that, otherwise default to GetDataDir\r\n         if (fs::is_directory(path / \"wallets\")) {\r\n             path /= \"wallets\";\r\n\r\n```\r\n",
      "created_at" : "2020-09-11T11:36:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19933#issuecomment-691042398",
      "id" : 691042398,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19933",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5MTA0MjM5OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-11T12:14:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/691042398",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/34917548?v=4",
         "events_url" : "https://api.github.com/users/Saibato/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Saibato/followers",
         "following_url" : "https://api.github.com/users/Saibato/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Saibato/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Saibato",
         "id" : 34917548,
         "login" : "Saibato",
         "node_id" : "MDQ6VXNlcjM0OTE3NTQ4",
         "organizations_url" : "https://api.github.com/users/Saibato/orgs",
         "received_events_url" : "https://api.github.com/users/Saibato/received_events",
         "repos_url" : "https://api.github.com/users/Saibato/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Saibato/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Saibato/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Saibato"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK. Prefer the patch above rather than the active PR. Logic is easier on the eyes and we need it everytime we call `GetWalletDir()`. As promag mentioned, it would be nice to know why the underlying function differs between systems, rather than adding this logic on. If it's necessary, I think this is a good solution, but if other path functions need this logic, would prefer something like a GetCleanPath static function.",
      "created_at" : "2020-09-16T05:25:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19933#issuecomment-693178711",
      "id" : 693178711,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19933",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5MzE3ODcxMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-16T05:38:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/693178711",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/8435003?v=4",
         "events_url" : "https://api.github.com/users/tryphe/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tryphe/followers",
         "following_url" : "https://api.github.com/users/tryphe/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tryphe/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tryphe",
         "id" : 8435003,
         "login" : "tryphe",
         "node_id" : "MDQ6VXNlcjg0MzUwMDM=",
         "organizations_url" : "https://api.github.com/users/tryphe/orgs",
         "received_events_url" : "https://api.github.com/users/tryphe/received_events",
         "repos_url" : "https://api.github.com/users/tryphe/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tryphe/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tryphe/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tryphe"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "My \"obsolete\" comments above remain unaddressed. Would like a test to reproduce it if possible - I have been unable to do so.",
      "created_at" : "2020-09-16T12:17:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19933#issuecomment-693367244",
      "id" : 693367244,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19933",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5MzM2NzI0NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-16T12:17:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/693367244",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   }
]
