[
   {
      "author_association" : "MEMBER",
      "body" : "Requested by @MarcoFalke @sdaftuar and @theuni . Review very much appreciated :pray: ",
      "created_at" : "2020-09-07T17:18:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#issuecomment-688444546",
      "id" : 688444546,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19910",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4ODQ0NDU0Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-07T17:18:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/688444546",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484529215"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484529215"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It is currently not possible to not have `node.peerman`. I think an `Ensure..()` like `EnsureMempool` would be good. It doesn't really make sense to call `getpeerinfo` without a peerman anyway?",
      "commit_id" : "d350feb2013e8db8a7464ec40670ef609d77e778",
      "created_at" : "2020-09-07T17:25:02Z",
      "diff_hunk" : "@@ -156,7 +156,10 @@ static UniValue getpeerinfo(const JSONRPCRequest& request)\n     for (const CNodeStats& stats : vstats) {\n         UniValue obj(UniValue::VOBJ);\n         CNodeStateStats statestats;\n-        bool fStateStats = GetNodeStateStats(stats.nodeid, statestats);\n+        bool fStateStats{false};\n+        if (node.peerman) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484529215",
      "id" : 484529215,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUyOTIxNQ==",
      "original_commit_id" : "e0b0d0c5648cf79ab563225fb1947a95dcb0373d",
      "original_line" : 160,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 483673436,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-08T10:33:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484529215",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484529374"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484529374"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    bool GetNodeStateStats(NodeId nodeid, CNodeStateStats& stats);\r\n```\r\n\r\nnit for new code",
      "commit_id" : "d350feb2013e8db8a7464ec40670ef609d77e778",
      "created_at" : "2020-09-07T17:25:42Z",
      "diff_hunk" : "@@ -93,7 +126,14 @@ class PeerManager final : public CValidationInterface, public NetEventsInterface\n      */\n     void Misbehaving(const NodeId pnode, const int howmuch, const std::string& message);\n \n+    /** Get statistics from node state */\n+    bool GetNodeStateStats(NodeId nodeid, CNodeStateStats &stats);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484529374",
      "id" : 484529374,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUyOTM3NA==",
      "original_commit_id" : "e0b0d0c5648cf79ab563225fb1947a95dcb0373d",
      "original_line" : 130,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 483673436,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-08T10:33:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484529374",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484537675"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484537675"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've done something slightly different and checked existence at the top of this function. Let me know what you think.",
      "commit_id" : "d350feb2013e8db8a7464ec40670ef609d77e778",
      "created_at" : "2020-09-07T18:08:44Z",
      "diff_hunk" : "@@ -156,7 +156,10 @@ static UniValue getpeerinfo(const JSONRPCRequest& request)\n     for (const CNodeStats& stats : vstats) {\n         UniValue obj(UniValue::VOBJ);\n         CNodeStateStats statestats;\n-        bool fStateStats = GetNodeStateStats(stats.nodeid, statestats);\n+        bool fStateStats{false};\n+        if (node.peerman) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484537675",
      "id" : 484537675,
      "in_reply_to_id" : 484529215,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUzNzY3NQ==",
      "original_commit_id" : "e0b0d0c5648cf79ab563225fb1947a95dcb0373d",
      "original_line" : 160,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 483681660,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-08T10:33:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484537675",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484537830"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484537830"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fixed. Thanks!",
      "commit_id" : "d350feb2013e8db8a7464ec40670ef609d77e778",
      "created_at" : "2020-09-07T18:09:37Z",
      "diff_hunk" : "@@ -93,7 +126,14 @@ class PeerManager final : public CValidationInterface, public NetEventsInterface\n      */\n     void Misbehaving(const NodeId pnode, const int howmuch, const std::string& message);\n \n+    /** Get statistics from node state */\n+    bool GetNodeStateStats(NodeId nodeid, CNodeStateStats &stats);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484537830",
      "id" : 484537830,
      "in_reply_to_id" : 484529374,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUzNzgzMA==",
      "original_commit_id" : "e0b0d0c5648cf79ab563225fb1947a95dcb0373d",
      "original_line" : 130,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 483681814,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-08T10:33:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484537830",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.",
      "created_at" : "2020-09-07T18:34:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#issuecomment-688467825",
      "id" : 688467825,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19910",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4ODQ2NzgyNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-07T18:34:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/688467825",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK: decoupling is good!",
      "created_at" : "2020-09-07T19:23:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#issuecomment-688482583",
      "id" : 688482583,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19910",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4ODQ4MjU4Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-07T19:23:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/688482583",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484785195"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484785195"
         }
      },
      "author_association" : "MEMBER",
      "body" : "322e87b6039877ed3457baea93cc87d78f3f4d96\r\n```suggestion\r\n     * by the m_peer_mutex. Once a shared pointer reference is\r\n```",
      "commit_id" : "d350feb2013e8db8a7464ec40670ef609d77e778",
      "created_at" : "2020-09-08T09:36:28Z",
      "diff_hunk" : "@@ -146,6 +176,16 @@ class PeerManager final : public CValidationInterface, public NetEventsInterface\n     CTxMemPool& m_mempool;\n \n     int64_t m_stale_tip_check_time; //!< Next time to check for stale tip\n+\n+    /** Protects m_peer_map */\n+    Mutex m_peer_mutex;\n+    /**\n+     * Map of all Peer objects, keyed by peer id. This map is protected\n+     * by the global m_peer_mutex. Once a shared pointer reference is",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484785195",
      "id" : 484785195,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc4NTE5NQ==",
      "original_commit_id" : "322e87b6039877ed3457baea93cc87d78f3f4d96",
      "original_line" : 184,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 483963562,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-08T10:33:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484785195",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484785821"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484785821"
         }
      },
      "author_association" : "MEMBER",
      "body" : "322e87b6039877ed3457baea93cc87d78f3f4d96\r\nnit: This comment duplicates the code :) Consider to drop it.",
      "commit_id" : "d350feb2013e8db8a7464ec40670ef609d77e778",
      "created_at" : "2020-09-08T09:37:33Z",
      "diff_hunk" : "@@ -146,6 +176,16 @@ class PeerManager final : public CValidationInterface, public NetEventsInterface\n     CTxMemPool& m_mempool;\n \n     int64_t m_stale_tip_check_time; //!< Next time to check for stale tip\n+\n+    /** Protects m_peer_map */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484785821",
      "id" : 484785821,
      "line" : 180,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc4NTgyMQ==",
      "original_commit_id" : "322e87b6039877ed3457baea93cc87d78f3f4d96",
      "original_line" : 180,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 66,
      "pull_request_review_id" : 483963562,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-08T10:33:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484785821",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484816918"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484816918"
         }
      },
      "author_association" : "MEMBER",
      "body" : "good catch. Fixed.",
      "commit_id" : "d350feb2013e8db8a7464ec40670ef609d77e778",
      "created_at" : "2020-09-08T10:32:10Z",
      "diff_hunk" : "@@ -146,6 +176,16 @@ class PeerManager final : public CValidationInterface, public NetEventsInterface\n     CTxMemPool& m_mempool;\n \n     int64_t m_stale_tip_check_time; //!< Next time to check for stale tip\n+\n+    /** Protects m_peer_map */\n+    Mutex m_peer_mutex;\n+    /**\n+     * Map of all Peer objects, keyed by peer id. This map is protected\n+     * by the global m_peer_mutex. Once a shared pointer reference is",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484816918",
      "id" : 484816918,
      "in_reply_to_id" : 484785195,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgxNjkxOA==",
      "original_commit_id" : "322e87b6039877ed3457baea93cc87d78f3f4d96",
      "original_line" : 184,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 484004756,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-08T10:33:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484816918",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484817325"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484817325"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Normally I'd agree with removing unnecessary commenting, but I think it's useful for every member variable to have a doxygen comment. Happy to go either way if others think it should be dropped.",
      "commit_id" : "d350feb2013e8db8a7464ec40670ef609d77e778",
      "created_at" : "2020-09-08T10:32:57Z",
      "diff_hunk" : "@@ -146,6 +176,16 @@ class PeerManager final : public CValidationInterface, public NetEventsInterface\n     CTxMemPool& m_mempool;\n \n     int64_t m_stale_tip_check_time; //!< Next time to check for stale tip\n+\n+    /** Protects m_peer_map */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484817325",
      "id" : 484817325,
      "in_reply_to_id" : 484785821,
      "line" : 180,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgxNzMyNQ==",
      "original_commit_id" : "322e87b6039877ed3457baea93cc87d78f3f4d96",
      "original_line" : 180,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 66,
      "pull_request_review_id" : 484005300,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-08T10:33:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484817325",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484838191"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484838191"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm for keeping it, it's better for consistency to have a comment for every one.",
      "commit_id" : "d350feb2013e8db8a7464ec40670ef609d77e778",
      "created_at" : "2020-09-08T11:14:10Z",
      "diff_hunk" : "@@ -146,6 +176,16 @@ class PeerManager final : public CValidationInterface, public NetEventsInterface\n     CTxMemPool& m_mempool;\n \n     int64_t m_stale_tip_check_time; //!< Next time to check for stale tip\n+\n+    /** Protects m_peer_map */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484838191",
      "id" : 484838191,
      "in_reply_to_id" : 484785821,
      "line" : 180,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgzODE5MQ==",
      "original_commit_id" : "322e87b6039877ed3457baea93cc87d78f3f4d96",
      "original_line" : 180,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 66,
      "pull_request_review_id" : 484031953,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-08T11:14:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484838191",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484981819"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484981819"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Does it change something if  this check is moved above at the `m_context->connman` level ? You may save one more control flow.",
      "commit_id" : "d350feb2013e8db8a7464ec40670ef609d77e778",
      "created_at" : "2020-09-08T14:50:47Z",
      "diff_hunk" : "@@ -105,11 +105,13 @@ class NodeImpl : public Node\n             }\n \n             // Try to retrieve the CNodeStateStats for each node.\n-            TRY_LOCK(::cs_main, lockMain);\n-            if (lockMain) {\n-                for (auto& node_stats : stats) {\n-                    std::get<1>(node_stats) =\n-                        GetNodeStateStats(std::get<0>(node_stats).nodeid, std::get<2>(node_stats));\n+            if (m_context->peerman) {\n+                TRY_LOCK(::cs_main, lockMain);\n+                if (lockMain) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484981819",
      "id" : 484981819,
      "line" : 110,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk4MTgxOQ==",
      "original_commit_id" : "6647af93614c834f99d431e4c09f7bac79f0f4dd",
      "original_line" : 110,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/interfaces/node.cpp",
      "position" : 11,
      "pull_request_review_id" : 484220356,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-08T14:56:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484981819",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484983468"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484983468"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It's a bit confusing to have `GetNodeStateStats` which is actually a member of `PeerManager`, and still have a `CNodeState`, even if inside this function you effectively fetch it. Maybe rename `GetNodeProcessingStats` ?",
      "commit_id" : "d350feb2013e8db8a7464ec40670ef609d77e778",
      "created_at" : "2020-09-08T14:52:56Z",
      "diff_hunk" : "@@ -953,7 +953,7 @@ void PeerManager::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTime) {\n     LogPrint(BCLog::NET, \"Cleared nodestate for peer=%d\\n\", nodeid);\n }\n \n-bool GetNodeStateStats(NodeId nodeid, CNodeStateStats &stats) {\n+bool PeerManager::GetNodeStateStats(NodeId nodeid, CNodeStateStats &stats) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r484983468",
      "id" : 484983468,
      "line" : 919,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk4MzQ2OA==",
      "original_commit_id" : "6647af93614c834f99d431e4c09f7bac79f0f4dd",
      "original_line" : 956,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 85,
      "pull_request_review_id" : 484220356,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-08T14:56:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484983468",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r485038136"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485038136"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Does it change something if this check is moved above at the `m_context->connman` level ? You may save one more control flow.\r\n\r\nWhy increase code block with locked `::cs_main`?",
      "commit_id" : "d350feb2013e8db8a7464ec40670ef609d77e778",
      "created_at" : "2020-09-08T16:10:25Z",
      "diff_hunk" : "@@ -105,11 +105,13 @@ class NodeImpl : public Node\n             }\n \n             // Try to retrieve the CNodeStateStats for each node.\n-            TRY_LOCK(::cs_main, lockMain);\n-            if (lockMain) {\n-                for (auto& node_stats : stats) {\n-                    std::get<1>(node_stats) =\n-                        GetNodeStateStats(std::get<0>(node_stats).nodeid, std::get<2>(node_stats));\n+            if (m_context->peerman) {\n+                TRY_LOCK(::cs_main, lockMain);\n+                if (lockMain) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r485038136",
      "id" : 485038136,
      "in_reply_to_id" : 484981819,
      "line" : 110,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAzODEzNg==",
      "original_commit_id" : "6647af93614c834f99d431e4c09f7bac79f0f4dd",
      "original_line" : 110,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/interfaces/node.cpp",
      "position" : 11,
      "pull_request_review_id" : 484293681,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-08T16:10:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485038136",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r485039519"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485039519"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think the name right now is fine. It's getting stats related to the node's state.",
      "commit_id" : "d350feb2013e8db8a7464ec40670ef609d77e778",
      "created_at" : "2020-09-08T16:12:40Z",
      "diff_hunk" : "@@ -953,7 +953,7 @@ void PeerManager::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTime) {\n     LogPrint(BCLog::NET, \"Cleared nodestate for peer=%d\\n\", nodeid);\n }\n \n-bool GetNodeStateStats(NodeId nodeid, CNodeStateStats &stats) {\n+bool PeerManager::GetNodeStateStats(NodeId nodeid, CNodeStateStats &stats) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r485039519",
      "id" : 485039519,
      "in_reply_to_id" : 484983468,
      "line" : 919,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAzOTUxOQ==",
      "original_commit_id" : "6647af93614c834f99d431e4c09f7bac79f0f4dd",
      "original_line" : 956,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 85,
      "pull_request_review_id" : 484295439,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-08T16:12:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485039519",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r485048559"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485048559"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Does it change something if this check is moved above at the m_context->connman level ? You may save one more control flow.\r\n\r\nYes, it's a try lock. It's possible that we're not able to take the lock, and therefore that we're not able to get the node state stats, but we'd still get the node stats. If we move the try above the m_context->connman level, then if we couldn't get the cs_main lock, we wouldn't be able to get any stats.\r\n\r\nEventually, none of the statistics should require cs_main, so the try lock can be removed entirely.",
      "commit_id" : "d350feb2013e8db8a7464ec40670ef609d77e778",
      "created_at" : "2020-09-08T16:27:09Z",
      "diff_hunk" : "@@ -105,11 +105,13 @@ class NodeImpl : public Node\n             }\n \n             // Try to retrieve the CNodeStateStats for each node.\n-            TRY_LOCK(::cs_main, lockMain);\n-            if (lockMain) {\n-                for (auto& node_stats : stats) {\n-                    std::get<1>(node_stats) =\n-                        GetNodeStateStats(std::get<0>(node_stats).nodeid, std::get<2>(node_stats));\n+            if (m_context->peerman) {\n+                TRY_LOCK(::cs_main, lockMain);\n+                if (lockMain) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r485048559",
      "id" : 485048559,
      "in_reply_to_id" : 484981819,
      "line" : 110,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA0ODU1OQ==",
      "original_commit_id" : "6647af93614c834f99d431e4c09f7bac79f0f4dd",
      "original_line" : 110,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/interfaces/node.cpp",
      "position" : 11,
      "pull_request_review_id" : 484306707,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-08T16:27:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485048559",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.",
      "created_at" : "2020-09-09T08:14:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#issuecomment-689404986",
      "id" : 689404986,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19910",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4OTQwNDk4Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-09T08:14:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/689404986",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #19911 (net: guard vRecvGetData with cs_vRecv and orphan_work_set with g_cs_orphans by narula)\n* #19858 (Periodically make block-relay connections and sync headers by sdaftuar)\n* #19829 (net processing: Move block inventory state to net_processing by jnewbery)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-09-19T13:46:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#issuecomment-695215523",
      "id" : 695215523,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19910",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5NTIxNTUyMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-19T13:46:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/695215523",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r493008783"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/493008783"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Using ```GetPeerRef()``` with an encapsulated lock for ```m_peer_map```, then manually locking the private mutex 3 lines later looks strange. It also requires two locks... all the drawbacks of mutex encapsulation without exploiting the benefits :)\r\n\r\nSince misbehavior changes to the peer will go unobserved after this point anyway, why not just take and remove with a single lock?\r\n\r\nSomething like (untested):\r\n```c++\r\nPeerRef PeerManager::RemovePeer(NodeId id)\r\n{\r\n    PeerRef ret;\r\n    {\r\n        LOCK(m_peer_mutex);\r\n        auto it = m_peer_map.find(id);\r\n        if (it != m_peer_map.end()) {\r\n            ret = std::move(it->second);\r\n            m_peer_map.erase(it);\r\n        }\r\n    }\r\n    return ret;\r\n}\r\n```",
      "commit_id" : "d350feb2013e8db8a7464ec40670ef609d77e778",
      "created_at" : "2020-09-22T20:19:54Z",
      "diff_hunk" : "@@ -915,8 +871,8 @@ void PeerManager::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTime) {\n         PeerRef peer = GetPeerRef(nodeid);\n         assert(peer != nullptr);\n         misbehavior = WITH_LOCK(peer->m_misbehavior_mutex, return peer->m_misbehavior_score);\n-        LOCK(g_peer_mutex);\n-        g_peer_map.erase(nodeid);\n+        LOCK(m_peer_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19910#discussion_r493008783",
      "id" : 493008783,
      "line" : 874,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAwODc4Mw==",
      "original_commit_id" : "d350feb2013e8db8a7464ec40670ef609d77e778",
      "original_line" : 874,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 68,
      "pull_request_review_id" : 493814969,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19910",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-22T20:19:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/493008783",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   }
]
