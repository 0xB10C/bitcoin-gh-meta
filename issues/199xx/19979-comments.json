[
   {
      "author_association" : "MEMBER",
      "body" : "cc @ajtowns @MarcoFalke @ryanofsky @vasild ",
      "created_at" : "2020-09-19T10:05:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19979#issuecomment-695193929",
      "id" : 695193929,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19979",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5NTE5MzkyOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-19T10:05:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/695193929",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "As mentioned in previous prs, clang may have accidental bugs or intentional limitations when checking for locks held at compile time. So removing the run-time checks seems dangerous, see also https://github.com/bitcoin/bitcoin/pull/19865#issuecomment-687585243 .\r\n\r\nFor example, the following diff compiles, but is obviously wrong:\r\n\r\n```diff\r\ndiff --git a/src/net_processing.cpp b/src/net_processing.cpp\r\nindex b256d719a6..b6006427a7 100644\r\n--- a/src/net_processing.cpp\r\n+++ b/src/net_processing.cpp\r\n@@ -1336,6 +1336,8 @@ void PeerManager::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_\r\n     std::shared_ptr<const CBlockHeaderAndShortTxIDs> pcmpctblock = std::make_shared<const CBlockHeaderAndShortTxIDs> (*pblock, true);\r\n     const CNetMsgMaker msgMaker(PROTOCOL_VERSION);\r\n \r\n+    CConnman::NodeFn fun;\r\n+    {\r\n     LOCK(cs_main);\r\n \r\n     static int nHighestFastAnnounce = 0;\r\n@@ -1353,8 +1355,7 @@ void PeerManager::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_\r\n         most_recent_compact_block = pcmpctblock;\r\n         fWitnessesPresentInMostRecentCompactBlock = fWitnessEnabled;\r\n     }\r\n-\r\n-    m_connman.ForEachNode([this, &pcmpctblock, pindex, &msgMaker, fWitnessEnabled, &hashBlock](CNode* pnode) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\r\n+    fun =[this, &pcmpctblock, pindex, &msgMaker, fWitnessEnabled, &hashBlock](CNode* pnode) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\r\n         // TODO: Avoid the repeated-serialization here\r\n         if (pnode->nVersion < INVALID_CB_NO_BAN_VERSION || pnode->fDisconnect)\r\n             return;\r\n@@ -1370,7 +1371,10 @@ void PeerManager::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_\r\n             m_connman.PushMessage(pnode, msgMaker.Make(NetMsgType::CMPCTBLOCK, *pcmpctblock));\r\n             state.pindexBestHeaderSent = pindex;\r\n         }\r\n-    });\r\n+    };\r\n+    }// release cs_main\r\n+\r\n+    m_connman.ForEachNode(fun);\r\n }\r\n \r\n /**\r\n",
      "created_at" : "2020-09-19T12:35:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19979#issuecomment-695207906",
      "id" : 695207906,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19979",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5NTIwNzkwNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-19T12:35:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/695207906",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19979#discussion_r491417794"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19979"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/491417794"
         }
      },
      "author_association" : "MEMBER",
      "body" : "As the func is not consumed, shouldn't this keep the uref `&&`? ",
      "commit_id" : "774face46174120ea7f548911895416bc4794eaa",
      "created_at" : "2020-09-19T12:37:47Z",
      "diff_hunk" : "@@ -268,8 +269,7 @@ class CConnman\n         }\n     };\n \n-    template<typename Callable>\n-    void ForEachNode(Callable&& func) const\n+    void ForEachNode(NodeFn func) const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19979#discussion_r491417794",
      "id" : 491417794,
      "line" : 272,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTQxNzc5NA==",
      "original_commit_id" : "774face46174120ea7f548911895416bc4794eaa",
      "original_line" : 272,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 18,
      "pull_request_review_id" : 491996119,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19979",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-19T12:37:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/491417794",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> So removing the run-time checks seems dangerous\r\n\r\nThis moves the run time checks outside of the lambdas. I don't think it's fair to say it removes them. PR could be tweaked to move the checks inside the lambdas instead of outside if you prefer that.\r\n\r\nIt is true in general that the approach of annotating a lambda and calling it through a std::function so the annotation will not be enforced is less safe than using an ASSERT_EXCLUSIVE_LOCK assert, because an ASSERT_EXCLUSIVE_LOCK assert pairs any unproven declaration that a mutex is locked together with a runtime check. With this approach in this PR, you are responsible for doing the check separately yourself.",
      "created_at" : "2020-09-19T12:59:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19979#issuecomment-695210287",
      "id" : 695210287,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19979",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5NTIxMDI4Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-19T12:59:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/695210287",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19979#discussion_r491428017"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19979"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/491428017"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This has to take a std::function argument so the lambda object is converted to a std::function and the EXCLUSIVE_LOCKS_REQUIRED requirement can by bypassed, otherwise static analysis will not accept this",
      "commit_id" : "774face46174120ea7f548911895416bc4794eaa",
      "created_at" : "2020-09-19T13:05:54Z",
      "diff_hunk" : "@@ -268,8 +269,7 @@ class CConnman\n         }\n     };\n \n-    template<typename Callable>\n-    void ForEachNode(Callable&& func) const\n+    void ForEachNode(NodeFn func) const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19979#discussion_r491428017",
      "id" : 491428017,
      "in_reply_to_id" : 491417794,
      "line" : 272,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTQyODAxNw==",
      "original_commit_id" : "774face46174120ea7f548911895416bc4794eaa",
      "original_line" : 272,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 18,
      "pull_request_review_id" : 491997482,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19979",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-19T13:05:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/491428017",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19979#discussion_r491432206"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19979"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/491432206"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    void ForEachNode(const NodeFn& func) const\r\n```\r\n\r\nshould work and be preferable? Obviously a style nit, as it doesn't make a difference with the current code.",
      "commit_id" : "774face46174120ea7f548911895416bc4794eaa",
      "created_at" : "2020-09-19T13:17:17Z",
      "diff_hunk" : "@@ -268,8 +269,7 @@ class CConnman\n         }\n     };\n \n-    template<typename Callable>\n-    void ForEachNode(Callable&& func) const\n+    void ForEachNode(NodeFn func) const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19979#discussion_r491432206",
      "id" : 491432206,
      "in_reply_to_id" : 491417794,
      "line" : 272,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTQzMjIwNg==",
      "original_commit_id" : "774face46174120ea7f548911895416bc4794eaa",
      "original_line" : 272,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 18,
      "pull_request_review_id" : 491998153,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19979",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-19T13:17:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/491432206",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #19970 (sync.h: fix LockAssertion error reporting by ajtowns)\n* #19918 (sync: Replace LockAssertion with WeaklyAssertLockHeld by ryanofsky)\n* #19865 (scripted-diff: Restore AssertLockHeld after #19668, remove LockAssertion by ryanofsky)\n* #19858 (Periodically make block-relay connections and sync headers by sdaftuar)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-09-19T13:22:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19979#issuecomment-695212894",
      "id" : 695212894,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19979",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5NTIxMjg5NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-19T13:22:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/695212894",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   }
]
