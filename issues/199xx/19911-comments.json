[
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2020-09-07T19:38:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#issuecomment-688486654",
      "id" : 688486654,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19911",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4ODQ4NjY1NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-07T19:38:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/688486654",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-09-07T19:44:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#issuecomment-688488586",
      "id" : 688488586,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19911",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4ODQ4ODU4Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-07T19:44:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/688488586",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r484555699"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484555699"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Consider using the `WITH_LOCK` macro for simple one-line statements:\r\n\r\n```suggestion\r\n            WITH_LOCK(pfrom.cs_vRecv, pfrom.vRecvGetData.push_back(inv));\r\n```",
      "commit_id" : "fe476e0c5130b8e13d5194fd7c98672f87818ba4",
      "created_at" : "2020-09-07T19:54:50Z",
      "diff_hunk" : "@@ -2880,7 +2883,10 @@ void PeerLogicValidation::ProcessMessage(CNode& pfrom, const std::string& msg_ty\n             CInv inv;\n             inv.type = State(pfrom.GetId())->fWantsCmpctWitness ? MSG_WITNESS_BLOCK : MSG_BLOCK;\n             inv.hash = req.blockhash;\n-            pfrom.vRecvGetData.push_back(inv);\n+            {\n+                LOCK(pfrom.cs_vRecv);\n+                pfrom.vRecvGetData.push_back(inv);\n+            }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r484555699",
      "id" : 484555699,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDU1NTY5OQ==",
      "original_commit_id" : "a4d7f3dc3126b6b808f27dcf3ad7b6e8b9d6b0a7",
      "original_line" : 2889,
      "original_position" : 31,
      "original_start_line" : 2886,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 483699195,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-09-30T00:30:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484555699",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r484558805"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484558805"
         }
      },
      "author_association" : "MEMBER",
      "body" : "style: consider adding braces to if blocks when touching code, to conform with the current style guide.",
      "commit_id" : "fe476e0c5130b8e13d5194fd7c98672f87818ba4",
      "created_at" : "2020-09-07T20:14:20Z",
      "diff_hunk" : "@@ -3855,15 +3861,20 @@ bool PeerLogicValidation::ProcessMessages(CNode* pfrom, std::atomic<bool>& inter\n     //\n     bool fMoreWork = false;\n \n-    if (!pfrom->vRecvGetData.empty())\n-        ProcessGetData(*pfrom, chainparams, m_connman, m_mempool, interruptMsgProc);\n+    {\n+        LOCK(pfrom->cs_vRecv);\n+        if (!pfrom->vRecvGetData.empty())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r484558805",
      "id" : 484558805,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDU1ODgwNQ==",
      "original_commit_id" : "a4d7f3dc3126b6b808f27dcf3ad7b6e8b9d6b0a7",
      "original_line" : 3866,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 483699195,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-30T00:30:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484558805",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r484568250"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484568250"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done!",
      "commit_id" : "fe476e0c5130b8e13d5194fd7c98672f87818ba4",
      "created_at" : "2020-09-07T21:15:47Z",
      "diff_hunk" : "@@ -2880,7 +2883,10 @@ void PeerLogicValidation::ProcessMessage(CNode& pfrom, const std::string& msg_ty\n             CInv inv;\n             inv.type = State(pfrom.GetId())->fWantsCmpctWitness ? MSG_WITNESS_BLOCK : MSG_BLOCK;\n             inv.hash = req.blockhash;\n-            pfrom.vRecvGetData.push_back(inv);\n+            {\n+                LOCK(pfrom.cs_vRecv);\n+                pfrom.vRecvGetData.push_back(inv);\n+            }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r484568250",
      "id" : 484568250,
      "in_reply_to_id" : 484555699,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDU2ODI1MA==",
      "original_commit_id" : "a4d7f3dc3126b6b808f27dcf3ad7b6e8b9d6b0a7",
      "original_line" : 2889,
      "original_position" : 31,
      "original_start_line" : 2886,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 483710588,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-09-30T00:30:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484568250",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/177646?v=4",
         "events_url" : "https://api.github.com/users/narula/events{/privacy}",
         "followers_url" : "https://api.github.com/users/narula/followers",
         "following_url" : "https://api.github.com/users/narula/following{/other_user}",
         "gists_url" : "https://api.github.com/users/narula/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/narula",
         "id" : 177646,
         "login" : "narula",
         "node_id" : "MDQ6VXNlcjE3NzY0Ng==",
         "organizations_url" : "https://api.github.com/users/narula/orgs",
         "received_events_url" : "https://api.github.com/users/narula/received_events",
         "repos_url" : "https://api.github.com/users/narula/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/narula/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/narula/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/narula"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r484568297"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484568297"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done! did not do so to adjacent code i wasn't touching.",
      "commit_id" : "fe476e0c5130b8e13d5194fd7c98672f87818ba4",
      "created_at" : "2020-09-07T21:16:00Z",
      "diff_hunk" : "@@ -3855,15 +3861,20 @@ bool PeerLogicValidation::ProcessMessages(CNode* pfrom, std::atomic<bool>& inter\n     //\n     bool fMoreWork = false;\n \n-    if (!pfrom->vRecvGetData.empty())\n-        ProcessGetData(*pfrom, chainparams, m_connman, m_mempool, interruptMsgProc);\n+    {\n+        LOCK(pfrom->cs_vRecv);\n+        if (!pfrom->vRecvGetData.empty())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r484568297",
      "id" : 484568297,
      "in_reply_to_id" : 484558805,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDU2ODI5Nw==",
      "original_commit_id" : "a4d7f3dc3126b6b808f27dcf3ad7b6e8b9d6b0a7",
      "original_line" : 3866,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 483710633,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-30T00:30:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484568297",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/177646?v=4",
         "events_url" : "https://api.github.com/users/narula/events{/privacy}",
         "followers_url" : "https://api.github.com/users/narula/followers",
         "following_url" : "https://api.github.com/users/narula/following{/other_user}",
         "gists_url" : "https://api.github.com/users/narula/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/narula",
         "id" : 177646,
         "login" : "narula",
         "node_id" : "MDQ6VXNlcjE3NzY0Ng==",
         "organizations_url" : "https://api.github.com/users/narula/orgs",
         "received_events_url" : "https://api.github.com/users/narula/received_events",
         "repos_url" : "https://api.github.com/users/narula/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/narula/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/narula/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/narula"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "The thread sanitizer is complaining about locking order; I'm looking into it.",
      "created_at" : "2020-09-07T22:46:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#issuecomment-688531736",
      "id" : 688531736,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19911",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4ODUzMTczNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-07T22:46:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/688531736",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/177646?v=4",
         "events_url" : "https://api.github.com/users/narula/events{/privacy}",
         "followers_url" : "https://api.github.com/users/narula/followers",
         "following_url" : "https://api.github.com/users/narula/following{/other_user}",
         "gists_url" : "https://api.github.com/users/narula/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/narula",
         "id" : 177646,
         "login" : "narula",
         "node_id" : "MDQ6VXNlcjE3NzY0Ng==",
         "organizations_url" : "https://api.github.com/users/narula/orgs",
         "received_events_url" : "https://api.github.com/users/narula/received_events",
         "repos_url" : "https://api.github.com/users/narula/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/narula/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/narula/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/narula"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r484707451"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484707451"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\nstatic void ProcessGetData(CNode& pfrom, const CChainParams& chainparams, CConnman& connman, CTxMemPool& mempool, const std::atomic<bool>& interruptMsgProc)\r\n    EXCLUSIVE_LOCKS_REQUIRED(!cs_main, pfrom.cs_vRecv)\r\n```",
      "commit_id" : "fe476e0c5130b8e13d5194fd7c98672f87818ba4",
      "created_at" : "2020-09-08T07:28:11Z",
      "diff_hunk" : "@@ -1722,7 +1722,7 @@ static CTransactionRef FindTxForGetData(const CTxMemPool& mempool, const CNode&\n     return {};\n }\n \n-void static ProcessGetData(CNode& pfrom, const CChainParams& chainparams, CConnman& connman, CTxMemPool& mempool, const std::atomic<bool>& interruptMsgProc) LOCKS_EXCLUDED(cs_main)\n+void static ProcessGetData(CNode& pfrom, const CChainParams& chainparams, CConnman& connman, CTxMemPool& mempool, const std::atomic<bool>& interruptMsgProc) EXCLUSIVE_LOCKS_REQUIRED(pfrom.cs_vRecv) LOCKS_EXCLUDED(cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r484707451",
      "id" : 484707451,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDcwNzQ1MQ==",
      "original_commit_id" : "3fe40815bf0e26b58dca03e164972ea70a6aa69d",
      "original_line" : 1725,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 483863940,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-30T00:30:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484707451",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r484737211"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484737211"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think it's right to reuse this mutex to guard `vRecvGetData` (despite the name similarities). `cs_vRecv` was added in 321d0fc6b6624c65508f8b9059418cb936f0bbbe to guard `nRecvBytes` and `mapRecvBytesPerMsgCmd`, which are statistics used in the net layer. `vRecvGetData` is a data structure used in the application layer (and should eventually move to the `Peer` struct), so should be guarded by a different mutex.\r\n\r\nI do have some commits that move both `vRecvGetData` and `orphan_work_set` to the `Peer` struct in https://github.com/jnewbery/bitcoin/commits/2020-06-cs-main-split-needs-rebase (everything from \r\n_END move tx data to net processing // START move work queue data to net processing_ to _END move work queue data to net processing // START move subversion to net_processing_). It's slightly orthogonal to this PR, but perhaps we should just do that now while we're touching these fields?",
      "commit_id" : "fe476e0c5130b8e13d5194fd7c98672f87818ba4",
      "created_at" : "2020-09-08T08:19:36Z",
      "diff_hunk" : "@@ -825,7 +826,7 @@ class CNode\n \n     RecursiveMutex cs_sendProcessing;\n \n-    std::deque<CInv> vRecvGetData;\n+    std::deque<CInv> vRecvGetData GUARDED_BY(cs_vRecv);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r484737211",
      "id" : 484737211,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDczNzIxMQ==",
      "original_commit_id" : "3fe40815bf0e26b58dca03e164972ea70a6aa69d",
      "original_line" : 829,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 483901878,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-30T00:30:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484737211",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@narula \r\n> The thread sanitizer is complaining about locking order; I'm looking into it.\r\n\r\nCould I suggest some code reorganization to keep locking order constant:\r\nhttps://github.com/hebasto/bitcoin/commits/pr19911-0908 ?",
      "created_at" : "2020-09-08T08:34:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#issuecomment-688712793",
      "id" : 688712793,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19911",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4ODcxMjc5Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-08T08:34:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/688712793",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r484795962"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484795962"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think `cs_main` is required here.",
      "commit_id" : "fe476e0c5130b8e13d5194fd7c98672f87818ba4",
      "created_at" : "2020-09-08T09:54:05Z",
      "diff_hunk" : "@@ -3852,8 +3861,14 @@ bool PeerManager::ProcessMessages(CNode* pfrom, std::atomic<bool>& interruptMsgP\n \n     // this maintains the order of responses\n     // and prevents vRecvGetData to grow unbounded\n-    if (!pfrom->vRecvGetData.empty()) return true;\n-    if (!pfrom->orphan_work_set.empty()) return true;\n+    {\n+        LOCK(pfrom->cs_vRecv);\n+        if (!pfrom->vRecvGetData.empty()) return true;\n+    }\n+    {\n+        LOCK2(cs_main, g_cs_orphans);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r484795962",
      "id" : 484795962,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc5NTk2Mg==",
      "original_commit_id" : "3fe40815bf0e26b58dca03e164972ea70a6aa69d",
      "original_line" : 3869,
      "original_position" : 72,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 483901878,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-30T00:30:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484795962",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r484799322"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484799322"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> ... `vRecvGetData` is a data structure used in the application layer (and should eventually move to the `Peer` struct)...\r\n\r\nMaybe start from moving, and then introduce a mutex?",
      "commit_id" : "fe476e0c5130b8e13d5194fd7c98672f87818ba4",
      "created_at" : "2020-09-08T09:59:50Z",
      "diff_hunk" : "@@ -825,7 +826,7 @@ class CNode\n \n     RecursiveMutex cs_sendProcessing;\n \n-    std::deque<CInv> vRecvGetData;\n+    std::deque<CInv> vRecvGetData GUARDED_BY(cs_vRecv);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r484799322",
      "id" : 484799322,
      "in_reply_to_id" : 484737211,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc5OTMyMg==",
      "original_commit_id" : "3fe40815bf0e26b58dca03e164972ea70a6aa69d",
      "original_line" : 829,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 483981369,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-30T00:30:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484799322",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r484820843"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484820843"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Maybe start from moving, and then introduce a mutex?\r\n\r\nI think that's probably the cleanest order, but I don't want to scope-creep @narula's PR if she thinks it's better to add the mutex first. I can do the move later.",
      "commit_id" : "fe476e0c5130b8e13d5194fd7c98672f87818ba4",
      "created_at" : "2020-09-08T10:39:48Z",
      "diff_hunk" : "@@ -825,7 +826,7 @@ class CNode\n \n     RecursiveMutex cs_sendProcessing;\n \n-    std::deque<CInv> vRecvGetData;\n+    std::deque<CInv> vRecvGetData GUARDED_BY(cs_vRecv);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r484820843",
      "id" : 484820843,
      "in_reply_to_id" : 484737211,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgyMDg0Mw==",
      "original_commit_id" : "3fe40815bf0e26b58dca03e164972ea70a6aa69d",
      "original_line" : 829,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 484009752,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-30T00:30:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484820843",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r485237497"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485237497"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks @hebasto! TIL. It's certainly shorter, but I'm worried people might miss the `!` if reading quickly, and think this function requires `cs_main`.\r\n\r\nCould you share why you suggest switching from `void static` to `static void`? Is it for general cleanup?",
      "commit_id" : "fe476e0c5130b8e13d5194fd7c98672f87818ba4",
      "created_at" : "2020-09-08T22:49:57Z",
      "diff_hunk" : "@@ -1722,7 +1722,7 @@ static CTransactionRef FindTxForGetData(const CTxMemPool& mempool, const CNode&\n     return {};\n }\n \n-void static ProcessGetData(CNode& pfrom, const CChainParams& chainparams, CConnman& connman, CTxMemPool& mempool, const std::atomic<bool>& interruptMsgProc) LOCKS_EXCLUDED(cs_main)\n+void static ProcessGetData(CNode& pfrom, const CChainParams& chainparams, CConnman& connman, CTxMemPool& mempool, const std::atomic<bool>& interruptMsgProc) EXCLUSIVE_LOCKS_REQUIRED(pfrom.cs_vRecv) LOCKS_EXCLUDED(cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r485237497",
      "id" : 485237497,
      "in_reply_to_id" : 484707451,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIzNzQ5Nw==",
      "original_commit_id" : "3fe40815bf0e26b58dca03e164972ea70a6aa69d",
      "original_line" : 1725,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 484546358,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-30T00:30:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485237497",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/177646?v=4",
         "events_url" : "https://api.github.com/users/narula/events{/privacy}",
         "followers_url" : "https://api.github.com/users/narula/followers",
         "following_url" : "https://api.github.com/users/narula/following{/other_user}",
         "gists_url" : "https://api.github.com/users/narula/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/narula",
         "id" : 177646,
         "login" : "narula",
         "node_id" : "MDQ6VXNlcjE3NzY0Ng==",
         "organizations_url" : "https://api.github.com/users/narula/orgs",
         "received_events_url" : "https://api.github.com/users/narula/received_events",
         "repos_url" : "https://api.github.com/users/narula/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/narula/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/narula/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/narula"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r485351754"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485351754"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Thanks @hebasto! TIL. It's certainly shorter, but I'm worried people might miss the `!` if reading quickly, and think this function requires `cs_main`.\r\n\r\nIt is not about \"shorter\" :)\r\nSee:\r\n- https://clang.llvm.org/docs/ThreadSafetyAnalysis.html#excludes\r\n- https://clang.llvm.org/docs/ThreadSafetyAnalysis.html#negative-capabilities\r\n\r\n> Could you share why you suggest switching from `void static` to `static void`? Is it for general cleanup?\r\n\r\nE.g., fa0572d0f3b083b4c8e2e883a66e2b198c6779f1 by @MarcoFalke \r\n\r\n",
      "commit_id" : "fe476e0c5130b8e13d5194fd7c98672f87818ba4",
      "created_at" : "2020-09-09T05:44:56Z",
      "diff_hunk" : "@@ -1722,7 +1722,7 @@ static CTransactionRef FindTxForGetData(const CTxMemPool& mempool, const CNode&\n     return {};\n }\n \n-void static ProcessGetData(CNode& pfrom, const CChainParams& chainparams, CConnman& connman, CTxMemPool& mempool, const std::atomic<bool>& interruptMsgProc) LOCKS_EXCLUDED(cs_main)\n+void static ProcessGetData(CNode& pfrom, const CChainParams& chainparams, CConnman& connman, CTxMemPool& mempool, const std::atomic<bool>& interruptMsgProc) EXCLUSIVE_LOCKS_REQUIRED(pfrom.cs_vRecv) LOCKS_EXCLUDED(cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r485351754",
      "id" : 485351754,
      "in_reply_to_id" : 484707451,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM1MTc1NA==",
      "original_commit_id" : "3fe40815bf0e26b58dca03e164972ea70a6aa69d",
      "original_line" : 1725,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 484676711,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-30T00:30:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485351754",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r487585290"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/487585290"
         }
      },
      "author_association" : "MEMBER",
      "body" : "right!",
      "commit_id" : "fe476e0c5130b8e13d5194fd7c98672f87818ba4",
      "created_at" : "2020-09-13T22:29:35Z",
      "diff_hunk" : "@@ -3852,8 +3861,14 @@ bool PeerManager::ProcessMessages(CNode* pfrom, std::atomic<bool>& interruptMsgP\n \n     // this maintains the order of responses\n     // and prevents vRecvGetData to grow unbounded\n-    if (!pfrom->vRecvGetData.empty()) return true;\n-    if (!pfrom->orphan_work_set.empty()) return true;\n+    {\n+        LOCK(pfrom->cs_vRecv);\n+        if (!pfrom->vRecvGetData.empty()) return true;\n+    }\n+    {\n+        LOCK2(cs_main, g_cs_orphans);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r487585290",
      "id" : 487585290,
      "in_reply_to_id" : 484795962,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU4NTI5MA==",
      "original_commit_id" : "3fe40815bf0e26b58dca03e164972ea70a6aa69d",
      "original_line" : 3869,
      "original_position" : 72,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 487345173,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-30T00:30:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/487585290",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/177646?v=4",
         "events_url" : "https://api.github.com/users/narula/events{/privacy}",
         "followers_url" : "https://api.github.com/users/narula/followers",
         "following_url" : "https://api.github.com/users/narula/following{/other_user}",
         "gists_url" : "https://api.github.com/users/narula/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/narula",
         "id" : 177646,
         "login" : "narula",
         "node_id" : "MDQ6VXNlcjE3NzY0Ng==",
         "organizations_url" : "https://api.github.com/users/narula/orgs",
         "received_events_url" : "https://api.github.com/users/narula/received_events",
         "repos_url" : "https://api.github.com/users/narula/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/narula/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/narula/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/narula"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r487697265"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/487697265"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> I don't think it's right to reuse this mutex to guard `vRecvGetData` (despite the name similarities).\r\n\r\nI agree on not reusing of irrelevant mutex. To keep this PR focused, would it more correctly to introduce a new `Mutex m_recvgetdata_mutex`?",
      "commit_id" : "fe476e0c5130b8e13d5194fd7c98672f87818ba4",
      "created_at" : "2020-09-14T07:14:13Z",
      "diff_hunk" : "@@ -825,7 +826,7 @@ class CNode\n \n     RecursiveMutex cs_sendProcessing;\n \n-    std::deque<CInv> vRecvGetData;\n+    std::deque<CInv> vRecvGetData GUARDED_BY(cs_vRecv);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r487697265",
      "id" : 487697265,
      "in_reply_to_id" : 484737211,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY5NzI2NQ==",
      "original_commit_id" : "3fe40815bf0e26b58dca03e164972ea70a6aa69d",
      "original_line" : 829,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 487473240,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-30T00:30:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/487697265",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r487736372"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/487736372"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This would be a slight sequencing change, but perhaps we should either call `ProcessGetData()` here, or not call it in the `GETDATA` processing for consistency. It seems from this comment that the only reason we weren't calling `ProcessGetData()` here was that `cs_main` was being held, which is no longer the case.",
      "commit_id" : "fe476e0c5130b8e13d5194fd7c98672f87818ba4",
      "created_at" : "2020-09-14T08:24:48Z",
      "diff_hunk" : "@@ -2845,36 +2848,36 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             return;\n         }\n \n-        LOCK(cs_main);\n-\n-        const CBlockIndex* pindex = LookupBlockIndex(req.blockhash);\n-        if (!pindex || !(pindex->nStatus & BLOCK_HAVE_DATA)) {\n-            LogPrint(BCLog::NET, \"Peer %d sent us a getblocktxn for a block we don't have\\n\", pfrom.GetId());\n-            return;\n-        }\n+        CInv inv;\n+        {\n+            LOCK(cs_main);\n+            const CBlockIndex* pindex = LookupBlockIndex(req.blockhash);\n+            if (!pindex || !(pindex->nStatus & BLOCK_HAVE_DATA)) {\n+                LogPrint(BCLog::NET, \"Peer %d sent us a getblocktxn for a block we don't have\\n\", pfrom.GetId());\n+                return;\n+            }\n+            if (pindex->nHeight >= ::ChainActive().Height() - MAX_BLOCKTXN_DEPTH) {\n+                CBlock block;\n+                bool ret = ReadBlockFromDisk(block, pindex, m_chainparams.GetConsensus());\n+                assert(ret);\n \n-        if (pindex->nHeight < ::ChainActive().Height() - MAX_BLOCKTXN_DEPTH) {\n+                SendBlockTransactions(pfrom, block, req);\n+                return;\n+            }\n             // If an older block is requested (should never happen in practice,\n             // but can happen in tests) send a block response instead of a\n             // blocktxn response. Sending a full block response instead of a\n             // small blocktxn response is preferable in the case where a peer\n             // might maliciously send lots of getblocktxn requests to trigger\n             // expensive disk reads, because it will require the peer to\n             // actually receive all the data read from disk over the network.\n-            LogPrint(BCLog::NET, \"Peer %d sent us a getblocktxn for a block > %i deep\\n\", pfrom.GetId(), MAX_BLOCKTXN_DEPTH);\n-            CInv inv;\n             inv.type = State(pfrom.GetId())->fWantsCmpctWitness ? MSG_WITNESS_BLOCK : MSG_BLOCK;\n-            inv.hash = req.blockhash;\n-            pfrom.vRecvGetData.push_back(inv);\n-            // The message processing loop will go around again (without pausing) and we'll respond then (without cs_main)\n-            return;\n         }\n \n-        CBlock block;\n-        bool ret = ReadBlockFromDisk(block, pindex, m_chainparams.GetConsensus());\n-        assert(ret);\n-\n-        SendBlockTransactions(pfrom, block, req);\n+        LogPrint(BCLog::NET, \"Peer %d sent us a getblocktxn for a block > %i deep\\n\", pfrom.GetId(), MAX_BLOCKTXN_DEPTH);\n+        inv.hash = req.blockhash;\n+        WITH_LOCK(pfrom.cs_vRecv, pfrom.vRecvGetData.push_back(inv));\n+        // The message processing loop will go around again (without pausing) and we'll respond then (without cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r487736372",
      "id" : 487736372,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzczNjM3Mg==",
      "original_commit_id" : "eadbad9d273edbca08ca1a49cb493292edd411a3",
      "original_line" : 2880,
      "original_position" : 75,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 487526536,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-30T00:30:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/487736372",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r487935532"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/487935532"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I agree on a new mutex; I was wondering about that but assumed @sipa had some reason for suggesting using `cs_vRecv` to guard it in the first place. ",
      "commit_id" : "fe476e0c5130b8e13d5194fd7c98672f87818ba4",
      "created_at" : "2020-09-14T13:51:22Z",
      "diff_hunk" : "@@ -825,7 +826,7 @@ class CNode\n \n     RecursiveMutex cs_sendProcessing;\n \n-    std::deque<CInv> vRecvGetData;\n+    std::deque<CInv> vRecvGetData GUARDED_BY(cs_vRecv);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r487935532",
      "id" : 487935532,
      "in_reply_to_id" : 484737211,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzkzNTUzMg==",
      "original_commit_id" : "3fe40815bf0e26b58dca03e164972ea70a6aa69d",
      "original_line" : 829,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 487789803,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-30T00:30:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/487935532",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/177646?v=4",
         "events_url" : "https://api.github.com/users/narula/events{/privacy}",
         "followers_url" : "https://api.github.com/users/narula/followers",
         "following_url" : "https://api.github.com/users/narula/following{/other_user}",
         "gists_url" : "https://api.github.com/users/narula/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/narula",
         "id" : 177646,
         "login" : "narula",
         "node_id" : "MDQ6VXNlcjE3NzY0Ng==",
         "organizations_url" : "https://api.github.com/users/narula/orgs",
         "received_events_url" : "https://api.github.com/users/narula/received_events",
         "repos_url" : "https://api.github.com/users/narula/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/narula/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/narula/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/narula"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've pushed a new series of commits which move `vRecvGetData` and `orphan_work_set` to `Peer` and then guard them appropriately. It's a bit more of a change, but happy to help move things over there if that's the end goal. \r\n\r\n> I do have some commits that move both `vRecvGetData` and `orphan_work_set` to the `Peer` struct in https://github.com/jnewbery/bitcoin/commits/2020-06-cs-main-split-needs-rebase (everything from\r\n> _END move tx data to net processing // START move work queue data to net processing_ to _END move work queue data to net processing // START move subversion to net_processing_). It's slightly orthogonal to this PR, but perhaps we should just do that now while we're touching these fields?\r\n\r\n@jnewbery I tried to cherry-pick some of your commits but they did not move cleanly given the scope of your branch's change; I also didn't do one of the renames you did to minimize the change. Let me know if there's an appropriate way to credit you.",
      "created_at" : "2020-09-14T13:54:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#issuecomment-692068452",
      "id" : 692068452,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19911",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5MjA2ODQ1Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-14T13:54:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/692068452",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/177646?v=4",
         "events_url" : "https://api.github.com/users/narula/events{/privacy}",
         "followers_url" : "https://api.github.com/users/narula/followers",
         "following_url" : "https://api.github.com/users/narula/following{/other_user}",
         "gists_url" : "https://api.github.com/users/narula/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/narula",
         "id" : 177646,
         "login" : "narula",
         "node_id" : "MDQ6VXNlcjE3NzY0Ng==",
         "organizations_url" : "https://api.github.com/users/narula/orgs",
         "received_events_url" : "https://api.github.com/users/narula/received_events",
         "repos_url" : "https://api.github.com/users/narula/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/narula/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/narula/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/narula"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r487939860"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/487939860"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Would this be a behavior change?",
      "commit_id" : "fe476e0c5130b8e13d5194fd7c98672f87818ba4",
      "created_at" : "2020-09-14T13:55:26Z",
      "diff_hunk" : "@@ -2845,36 +2848,36 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             return;\n         }\n \n-        LOCK(cs_main);\n-\n-        const CBlockIndex* pindex = LookupBlockIndex(req.blockhash);\n-        if (!pindex || !(pindex->nStatus & BLOCK_HAVE_DATA)) {\n-            LogPrint(BCLog::NET, \"Peer %d sent us a getblocktxn for a block we don't have\\n\", pfrom.GetId());\n-            return;\n-        }\n+        CInv inv;\n+        {\n+            LOCK(cs_main);\n+            const CBlockIndex* pindex = LookupBlockIndex(req.blockhash);\n+            if (!pindex || !(pindex->nStatus & BLOCK_HAVE_DATA)) {\n+                LogPrint(BCLog::NET, \"Peer %d sent us a getblocktxn for a block we don't have\\n\", pfrom.GetId());\n+                return;\n+            }\n+            if (pindex->nHeight >= ::ChainActive().Height() - MAX_BLOCKTXN_DEPTH) {\n+                CBlock block;\n+                bool ret = ReadBlockFromDisk(block, pindex, m_chainparams.GetConsensus());\n+                assert(ret);\n \n-        if (pindex->nHeight < ::ChainActive().Height() - MAX_BLOCKTXN_DEPTH) {\n+                SendBlockTransactions(pfrom, block, req);\n+                return;\n+            }\n             // If an older block is requested (should never happen in practice,\n             // but can happen in tests) send a block response instead of a\n             // blocktxn response. Sending a full block response instead of a\n             // small blocktxn response is preferable in the case where a peer\n             // might maliciously send lots of getblocktxn requests to trigger\n             // expensive disk reads, because it will require the peer to\n             // actually receive all the data read from disk over the network.\n-            LogPrint(BCLog::NET, \"Peer %d sent us a getblocktxn for a block > %i deep\\n\", pfrom.GetId(), MAX_BLOCKTXN_DEPTH);\n-            CInv inv;\n             inv.type = State(pfrom.GetId())->fWantsCmpctWitness ? MSG_WITNESS_BLOCK : MSG_BLOCK;\n-            inv.hash = req.blockhash;\n-            pfrom.vRecvGetData.push_back(inv);\n-            // The message processing loop will go around again (without pausing) and we'll respond then (without cs_main)\n-            return;\n         }\n \n-        CBlock block;\n-        bool ret = ReadBlockFromDisk(block, pindex, m_chainparams.GetConsensus());\n-        assert(ret);\n-\n-        SendBlockTransactions(pfrom, block, req);\n+        LogPrint(BCLog::NET, \"Peer %d sent us a getblocktxn for a block > %i deep\\n\", pfrom.GetId(), MAX_BLOCKTXN_DEPTH);\n+        inv.hash = req.blockhash;\n+        WITH_LOCK(pfrom.cs_vRecv, pfrom.vRecvGetData.push_back(inv));\n+        // The message processing loop will go around again (without pausing) and we'll respond then (without cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r487939860",
      "id" : 487939860,
      "in_reply_to_id" : 487736372,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzkzOTg2MA==",
      "original_commit_id" : "eadbad9d273edbca08ca1a49cb493292edd411a3",
      "original_line" : 2880,
      "original_position" : 75,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 487793806,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-30T00:30:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/487939860",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/177646?v=4",
         "events_url" : "https://api.github.com/users/narula/events{/privacy}",
         "followers_url" : "https://api.github.com/users/narula/followers",
         "following_url" : "https://api.github.com/users/narula/following{/other_user}",
         "gists_url" : "https://api.github.com/users/narula/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/narula",
         "id" : 177646,
         "login" : "narula",
         "node_id" : "MDQ6VXNlcjE3NzY0Ng==",
         "organizations_url" : "https://api.github.com/users/narula/orgs",
         "received_events_url" : "https://api.github.com/users/narula/received_events",
         "repos_url" : "https://api.github.com/users/narula/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/narula/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/narula/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/narula"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r488028390"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488028390"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`PeerRef` is a shared pointer, so by passing it by value here, you're incrementing the ref count, and decrementing it again when you leave the function, which incurs a performance cost, since those operations need to be atomic.\r\n\r\nThis function doesn't need to take shared ownership of the underlying `Peer` object, so you should pass by `Peer&` (see http://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#r30-take-smart-pointers-as-parameters-only-to-explicitly-express-lifetime-semantics).",
      "commit_id" : "fe476e0c5130b8e13d5194fd7c98672f87818ba4",
      "created_at" : "2020-09-14T15:33:44Z",
      "diff_hunk" : "@@ -1722,11 +1730,11 @@ static CTransactionRef FindTxForGetData(const CTxMemPool& mempool, const CNode&\n     return {};\n }\n \n-void static ProcessGetData(CNode& pfrom, const CChainParams& chainparams, CConnman& connman, CTxMemPool& mempool, const std::atomic<bool>& interruptMsgProc) LOCKS_EXCLUDED(cs_main)\n+void static ProcessGetData(CNode& pfrom, PeerRef peer, const CChainParams& chainparams, CConnman& connman, CTxMemPool& mempool, const std::atomic<bool>& interruptMsgProc) EXCLUSIVE_LOCKS_REQUIRED(!cs_main, peer->cs_vRecvGetData)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r488028390",
      "id" : 488028390,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAyODM5MA==",
      "original_commit_id" : "e15554c134c55599951e0765b02b520f72750a79",
      "original_line" : 1733,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 487897779,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-30T00:30:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488028390",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r488029389"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488029389"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think it's probably safer to just return if you can't find the `Peer` object here (as all other instances of `GetPeerRef()` except the `FinalizeNode()` call do) rather than assert.",
      "commit_id" : "fe476e0c5130b8e13d5194fd7c98672f87818ba4",
      "created_at" : "2020-09-14T15:35:06Z",
      "diff_hunk" : "@@ -2334,6 +2342,8 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         return;\n     }\n \n+    PeerRef peer = GetPeerRef(pfrom.GetId());\n+    assert(peer);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r488029389",
      "id" : 488029389,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAyOTM4OQ==",
      "original_commit_id" : "e15554c134c55599951e0765b02b520f72750a79",
      "original_line" : 2346,
      "original_position" : 61,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 487897779,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-30T00:30:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488029389",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #19998 (Net: Add CNode::ConnectedViaTor() by hebasto)\n* #19910 (net processing: Move peer_map to PeerManager by jnewbery)\n* #19829 (net processing: Move block inventory state to net_processing by jnewbery)\n* #19498 (Tidy up ProcessOrphanTx by jnewbery)\n* #19107 (p2p: Move all header verification into the network layer, extend logging by troygiorshev)\n* #9245 (Drop IO priority to idle while reading blocks for peer requests and startup verification by luke-jr)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-09-19T13:45:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#issuecomment-695215436",
      "id" : 695215436,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19911",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5NTIxNTQzNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-28T23:02:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/695215436",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-09-29T10:04:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#issuecomment-700602358",
      "id" : 700602358,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19911",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwMDYwMjM1OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-29T10:04:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/700602358",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r497173268"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/497173268"
         }
      },
      "author_association" : "MEMBER",
      "body" : "thanks for the pointer! fixed.",
      "commit_id" : "fe476e0c5130b8e13d5194fd7c98672f87818ba4",
      "created_at" : "2020-09-30T00:19:44Z",
      "diff_hunk" : "@@ -1722,11 +1730,11 @@ static CTransactionRef FindTxForGetData(const CTxMemPool& mempool, const CNode&\n     return {};\n }\n \n-void static ProcessGetData(CNode& pfrom, const CChainParams& chainparams, CConnman& connman, CTxMemPool& mempool, const std::atomic<bool>& interruptMsgProc) LOCKS_EXCLUDED(cs_main)\n+void static ProcessGetData(CNode& pfrom, PeerRef peer, const CChainParams& chainparams, CConnman& connman, CTxMemPool& mempool, const std::atomic<bool>& interruptMsgProc) EXCLUSIVE_LOCKS_REQUIRED(!cs_main, peer->cs_vRecvGetData)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r497173268",
      "id" : 497173268,
      "in_reply_to_id" : 488028390,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE3MzI2OA==",
      "original_commit_id" : "e15554c134c55599951e0765b02b520f72750a79",
      "original_line" : 1733,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 499009276,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-30T00:30:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/497173268",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/177646?v=4",
         "events_url" : "https://api.github.com/users/narula/events{/privacy}",
         "followers_url" : "https://api.github.com/users/narula/followers",
         "following_url" : "https://api.github.com/users/narula/following{/other_user}",
         "gists_url" : "https://api.github.com/users/narula/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/narula",
         "id" : 177646,
         "login" : "narula",
         "node_id" : "MDQ6VXNlcjE3NzY0Ng==",
         "organizations_url" : "https://api.github.com/users/narula/orgs",
         "received_events_url" : "https://api.github.com/users/narula/received_events",
         "repos_url" : "https://api.github.com/users/narula/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/narula/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/narula/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/narula"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r497173408"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/497173408"
         }
      },
      "author_association" : "MEMBER",
      "body" : "addressed.",
      "commit_id" : "fe476e0c5130b8e13d5194fd7c98672f87818ba4",
      "created_at" : "2020-09-30T00:19:53Z",
      "diff_hunk" : "@@ -2334,6 +2342,8 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         return;\n     }\n \n+    PeerRef peer = GetPeerRef(pfrom.GetId());\n+    assert(peer);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r497173408",
      "id" : 497173408,
      "in_reply_to_id" : 488029389,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE3MzQwOA==",
      "original_commit_id" : "e15554c134c55599951e0765b02b520f72750a79",
      "original_line" : 2346,
      "original_position" : 61,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 499009343,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-30T00:30:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/497173408",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/177646?v=4",
         "events_url" : "https://api.github.com/users/narula/events{/privacy}",
         "followers_url" : "https://api.github.com/users/narula/followers",
         "following_url" : "https://api.github.com/users/narula/following{/other_user}",
         "gists_url" : "https://api.github.com/users/narula/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/narula",
         "id" : 177646,
         "login" : "narula",
         "node_id" : "MDQ6VXNlcjE3NzY0Ng==",
         "organizations_url" : "https://api.github.com/users/narula/orgs",
         "received_events_url" : "https://api.github.com/users/narula/received_events",
         "repos_url" : "https://api.github.com/users/narula/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/narula/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/narula/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/narula"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r497435407"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/497435407"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit \"Move m_orphan_work_set to net_processing\": I think you should put this call at the top of `ProcessMessage()` in this commit, rather than putting it here, and then moving it up in a later commit.\r\n\r\nAlternatively, you could change the `ProcessMessage()` signature to take a `Peer&`. I don't think that's necessary, but you may prefer it to fetching the `PeerRef` in `ProcessMessages()` and then again in `ProcessMessage()`.",
      "commit_id" : "fe476e0c5130b8e13d5194fd7c98672f87818ba4",
      "created_at" : "2020-09-30T11:27:17Z",
      "diff_hunk" : "@@ -2984,6 +2987,8 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         }\n \n         std::list<CTransactionRef> lRemovedTxn;\n+        PeerRef peer = GetPeerRef(pfrom.GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r497435407",
      "id" : 497435407,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQzNTQwNw==",
      "original_commit_id" : "418cc40c35f5e34cfb9d19034d746d4abb75cfe3",
      "original_line" : 2990,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 499331075,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-30T11:50:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/497435407",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r497446364"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/497446364"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Since you're touching every line that `vRecvGetData` is on already, you may as well add a scripted-diff commit to this branch that updates the name to modern style guidelines, e.g. something like `m_get_data_requests` or similar. Same for the mutex name - it could be renamed to `m_get_data_requests_mutex` or similar.",
      "commit_id" : "fe476e0c5130b8e13d5194fd7c98672f87818ba4",
      "created_at" : "2020-09-30T11:48:23Z",
      "diff_hunk" : "@@ -488,6 +488,14 @@ struct Peer {\n     /** Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission). */\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n+    /** Set of txids to reconsider once their parent transactions have been accepted **/\n+    std::set<uint256> m_orphan_work_set GUARDED_BY(g_cs_orphans);\n+\n+    /** Protects vRecvGetData **/\n+    Mutex cs_vRecvGetData;\n+    /** Work queue of items requested by this peer **/\n+    std::deque<CInv> vRecvGetData GUARDED_BY(cs_vRecvGetData);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r497446364",
      "id" : 497446364,
      "line" : 497,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ0NjM2NA==",
      "original_commit_id" : "fe476e0c5130b8e13d5194fd7c98672f87818ba4",
      "original_line" : 497,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 10,
      "pull_request_review_id" : 499331075,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-30T11:50:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/497446364",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   }
]
