[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6722#discussion_r40412933"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6722"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/40412933"
         }
      },
      "body" : "travis complains about a missing `mutable bool blockSinceLastRollingFeeUpdate;` here.",
      "commit_id" : "104c63dad6c3b0a463df1829fe41643f99ac6bd5",
      "created_at" : "2015-09-25T09:22:40Z",
      "diff_hunk" : "@@ -284,6 +284,13 @@ class CTxMemPool\n     uint64_t totalTxSize; //! sum of all mempool tx' byte sizes\n     uint64_t cachedInnerUsage; //! sum of dynamic memory usage of all the map elements (NOT the maps themselves)\n \n+    mutable int64_t lastRollingFeeUpdate;\n+    mutable bool blockSinceLastRollingFeeBump;\n+    mutable double rollingMinimumFeeRate; //! minimum fee to get into the pool, decreases exponentially\n+    static const double ROLLING_FEE_HALFLIFE = 60 * 60 * 24;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6722#discussion_r40412933",
      "id" : 40412933,
      "original_commit_id" : "7ef6af92b293417515a36a29fb659c9e9c5c8ed2",
      "original_position" : 16,
      "path" : "src/txmempool.h",
      "position" : 28,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6722",
      "updated_at" : "2015-09-27T03:05:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/40412933",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "One thing that I think is maybe not great about the behavior of this, is let's say we have:\r\n\r\nTXs:\r\nA, Fee 10, Size 1\r\nB, Fee 10, Size 1\r\nC, Fee 21, Size 2\r\n\r\nIf A and B are the min in the set, submitting C should kick them out. Now, let's say B wanted to increase their fee, they would need to go above 21 to get in. As implemented, it doesn't seem to me that two TX's could both raise by 1 to, combined, provide more fee (because it seems tx's get added one at a time?)\r\n\r\nPerhaps a better compromise between these two behaviors would be to have a two part mempool, the inclusion set and the to-be ousted set and trigger a \"GC\" with some frequency. The to be ousted-set can be RBF'd or something.\r\n\r\n\r\nLastly justification on who might take advantage of such a behavior, perhaps a major exchange with a bunch of settlements out at once would want to make sure they all go through expediently and can coordinate increasing them all a hair.\r\n",
      "created_at" : "2015-09-25T12:18:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6722#issuecomment-143201072",
      "id" : 143201072,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6722",
      "updated_at" : "2015-09-25T12:18:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/143201072",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "body" : "I think that my earlier comment is not fully needed, because mempool is a large multiple of block size, currently. Perhaps a more future proof implementation would allow setting:\r\n\r\n- an optional hard memory cap\r\n- a (potentially) dynamic size which is a large multiple of the current block size",
      "created_at" : "2015-09-25T13:52:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6722#issuecomment-143229977",
      "id" : 143229977,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6722",
      "updated_at" : "2015-09-25T13:52:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/143229977",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=3",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6722#discussion_r40453419"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6722"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/40453419"
         }
      },
      "body" : "You can't call this by itself anymore.  Use removeStaged",
      "commit_id" : "104c63dad6c3b0a463df1829fe41643f99ac6bd5",
      "created_at" : "2015-09-25T17:20:39Z",
      "diff_hunk" : "@@ -837,3 +845,111 @@ const CTxMemPool::setEntries & CTxMemPool::GetMemPoolChildren(txiter entry) cons\n     assert(it != mapLinks.end());\n     return it->second.children;\n }\n+\n+CFeeRate CTxMemPool::GetMinFee() const {\n+    LOCK(cs);\n+    if (!blockSinceLastRollingFeeBump)\n+        return CFeeRate(rollingMinimumFeeRate);\n+\n+    int64_t time = GetTime();\n+    if (time > lastRollingFeeUpdate + 10) {\n+        rollingMinimumFeeRate = rollingMinimumFeeRate / pow(2.0, (time - lastRollingFeeUpdate) / ROLLING_FEE_HALFLIFE);\n+        lastRollingFeeUpdate = time;\n+    }\n+    return CFeeRate(rollingMinimumFeeRate);\n+}\n+\n+void CTxMemPool::trackRemovedOrAddFailed(const CFeeRate& rate) {\n+    AssertLockHeld(cs);\n+    if (rate.GetFeePerK() > rollingMinimumFeeRate) {\n+        rollingMinimumFeeRate = rate.GetFeePerK();\n+        blockSinceLastRollingFeeBump = false;\n+    }\n+}\n+\n+bool CTxMemPool::TrimToSize(size_t sizelimit, const CTxMemPoolEntry& toadd) {\n+    AssertLockHeld(cs);\n+\n+    CFeeRate bestFeeRateRemoved;\n+    setEntries stage;\n+    std::set<uint256> protect;\n+    BOOST_FOREACH(const CTxIn& in, toadd.GetTx().vin)\n+        protect.insert(in.prevout.hash);\n+\n+    size_t expsize = DynamicMemoryUsage() + toadd.DynamicMemoryUsage(); // Track the expected resulting memory usage of the mempool.\n+    indexed_transaction_set::nth_index<1>::type::reverse_iterator it = mapTx.get<1>().rbegin();\n+    // Iterate from lowest feerate to highest feerate in the mempool:\n+    while (expsize > sizelimit && it != mapTx.get<1>().rend()) {\n+        if (CompareTxMemPoolEntryByFee()(*it, toadd)) {\n+            // If the transaction's feerate is worse than what we're looking for, we have processed everything in the mempool\n+            // that could improve the staged set. If we don't have an acceptable solution by now, bail out.\n+            break;\n+        }\n+        txiter rootit = mapTx.project<0>(it.base());\n+        rootit--;\n+        if (stage.count(rootit)) {\n+            // If the transaction is already staged for deletion, we know its descendants are already processed, so skip it.\n+            it++;\n+            continue;\n+        }\n+\n+        // Iterate breadth-first over all descendants of transaction 'rootit'...\n+        std::deque<txiter> todo; // List of hashes that we still need to process (descendants of 'rootit').\n+        setEntries now; // Set of tx entries that will need to be added to stage if 'rootit' is included.\n+        CAmount nowfee = 0; // Sum of the fees in 'now'.\n+        size_t nowsize = 0; // Sum of the tx sizes in 'now'.\n+        size_t nowusage = 0; // Sum of the memory usages of transactions in 'now'.\n+        todo.push_back(rootit); // Add 'rootit' to the todo list, to initiate processing its children.\n+        bool good = true; // Whether including 'rootit' (and all its descendants) is a good idea.\n+\n+        while (!todo.empty()) {\n+            const txiter& itnow = todo.front();\n+            if (now.count(itnow))\n+                continue;\n+\n+            const uint256& hashnow = itnow->GetTx().GetHash();\n+            if (protect.count(hashnow)) {\n+                // If this transaction is in the protected set, we're done with 'rootit'.\n+                good = false;\n+                break;\n+            }\n+            // Add 'hashnow' to the 'now' set, and update its statistics.\n+            now.insert(itnow);\n+            nowfee += itnow->GetFee();\n+            nowsize += itnow->GetTxSize();\n+            nowusage += itnow->DynamicMemoryUsage();\n+            todo.pop_front();\n+\n+            // Find dependencies of 'hashnow' and them to todo.\n+            std::map<COutPoint, CInPoint>::iterator iter = mapNextTx.lower_bound(COutPoint(hashnow, 0));\n+            while (iter != mapNextTx.end() && iter->first.hash == hashnow) {\n+                const uint256& nexthash = iter->second.ptx->GetHash();\n+                txiter nextit = mapTx.find(nexthash);\n+                assert(nextit != mapTx.end());\n+                if (!stage.count(nextit) && !now.count(nextit))\n+                    todo.push_back(nextit);\n+                iter++;\n+            }\n+        }\n+\n+        // Check that we aren't removing a set who's total feerate is below that of the set we're removing\n+        // ... and then add now to stage\n+        if (good && (double)nowfee * toadd.GetTxSize() <= (double)toadd.GetFee() * nowsize) {\n+            stage.insert(now.begin(), now.end());\n+            expsize -= nowusage;\n+            bestFeeRateRemoved = std::max(bestFeeRateRemoved, CFeeRate(nowfee, nowsize));\n+        }\n+        it++;\n+    }\n+\n+    if (expsize <= sizelimit) {\n+        BOOST_FOREACH(const txiter& it, stage)\n+            removeUnchecked(it);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6722#discussion_r40453419",
      "id" : 40453419,
      "original_commit_id" : "152dcb6abaa5c218fa98b3d71e3804585ea791a0",
      "original_position" : 152,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6722",
      "updated_at" : "2015-09-27T03:05:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/40453419",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6722#discussion_r40453689"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6722"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/40453689"
         }
      },
      "body" : "It doesn't make sense to bump the rolling fee for a tx that didn't get in.   A very high fee tx might not make it in if there are large packages or transactions (even of low fee rate) at the bottom of the mempool.  That's a problem in and of itself for the tx that doesn't get in, but it's even worse if you make that the new minimum relay rate.",
      "commit_id" : "104c63dad6c3b0a463df1829fe41643f99ac6bd5",
      "created_at" : "2015-09-25T17:23:33Z",
      "diff_hunk" : "@@ -837,3 +845,111 @@ const CTxMemPool::setEntries & CTxMemPool::GetMemPoolChildren(txiter entry) cons\n     assert(it != mapLinks.end());\n     return it->second.children;\n }\n+\n+CFeeRate CTxMemPool::GetMinFee() const {\n+    LOCK(cs);\n+    if (!blockSinceLastRollingFeeBump)\n+        return CFeeRate(rollingMinimumFeeRate);\n+\n+    int64_t time = GetTime();\n+    if (time > lastRollingFeeUpdate + 10) {\n+        rollingMinimumFeeRate = rollingMinimumFeeRate / pow(2.0, (time - lastRollingFeeUpdate) / ROLLING_FEE_HALFLIFE);\n+        lastRollingFeeUpdate = time;\n+    }\n+    return CFeeRate(rollingMinimumFeeRate);\n+}\n+\n+void CTxMemPool::trackRemovedOrAddFailed(const CFeeRate& rate) {\n+    AssertLockHeld(cs);\n+    if (rate.GetFeePerK() > rollingMinimumFeeRate) {\n+        rollingMinimumFeeRate = rate.GetFeePerK();\n+        blockSinceLastRollingFeeBump = false;\n+    }\n+}\n+\n+bool CTxMemPool::TrimToSize(size_t sizelimit, const CTxMemPoolEntry& toadd) {\n+    AssertLockHeld(cs);\n+\n+    CFeeRate bestFeeRateRemoved;\n+    setEntries stage;\n+    std::set<uint256> protect;\n+    BOOST_FOREACH(const CTxIn& in, toadd.GetTx().vin)\n+        protect.insert(in.prevout.hash);\n+\n+    size_t expsize = DynamicMemoryUsage() + toadd.DynamicMemoryUsage(); // Track the expected resulting memory usage of the mempool.\n+    indexed_transaction_set::nth_index<1>::type::reverse_iterator it = mapTx.get<1>().rbegin();\n+    // Iterate from lowest feerate to highest feerate in the mempool:\n+    while (expsize > sizelimit && it != mapTx.get<1>().rend()) {\n+        if (CompareTxMemPoolEntryByFee()(*it, toadd)) {\n+            // If the transaction's feerate is worse than what we're looking for, we have processed everything in the mempool\n+            // that could improve the staged set. If we don't have an acceptable solution by now, bail out.\n+            break;\n+        }\n+        txiter rootit = mapTx.project<0>(it.base());\n+        rootit--;\n+        if (stage.count(rootit)) {\n+            // If the transaction is already staged for deletion, we know its descendants are already processed, so skip it.\n+            it++;\n+            continue;\n+        }\n+\n+        // Iterate breadth-first over all descendants of transaction 'rootit'...\n+        std::deque<txiter> todo; // List of hashes that we still need to process (descendants of 'rootit').\n+        setEntries now; // Set of tx entries that will need to be added to stage if 'rootit' is included.\n+        CAmount nowfee = 0; // Sum of the fees in 'now'.\n+        size_t nowsize = 0; // Sum of the tx sizes in 'now'.\n+        size_t nowusage = 0; // Sum of the memory usages of transactions in 'now'.\n+        todo.push_back(rootit); // Add 'rootit' to the todo list, to initiate processing its children.\n+        bool good = true; // Whether including 'rootit' (and all its descendants) is a good idea.\n+\n+        while (!todo.empty()) {\n+            const txiter& itnow = todo.front();\n+            if (now.count(itnow))\n+                continue;\n+\n+            const uint256& hashnow = itnow->GetTx().GetHash();\n+            if (protect.count(hashnow)) {\n+                // If this transaction is in the protected set, we're done with 'rootit'.\n+                good = false;\n+                break;\n+            }\n+            // Add 'hashnow' to the 'now' set, and update its statistics.\n+            now.insert(itnow);\n+            nowfee += itnow->GetFee();\n+            nowsize += itnow->GetTxSize();\n+            nowusage += itnow->DynamicMemoryUsage();\n+            todo.pop_front();\n+\n+            // Find dependencies of 'hashnow' and them to todo.\n+            std::map<COutPoint, CInPoint>::iterator iter = mapNextTx.lower_bound(COutPoint(hashnow, 0));\n+            while (iter != mapNextTx.end() && iter->first.hash == hashnow) {\n+                const uint256& nexthash = iter->second.ptx->GetHash();\n+                txiter nextit = mapTx.find(nexthash);\n+                assert(nextit != mapTx.end());\n+                if (!stage.count(nextit) && !now.count(nextit))\n+                    todo.push_back(nextit);\n+                iter++;\n+            }\n+        }\n+\n+        // Check that we aren't removing a set who's total feerate is below that of the set we're removing\n+        // ... and then add now to stage\n+        if (good && (double)nowfee * toadd.GetTxSize() <= (double)toadd.GetFee() * nowsize) {\n+            stage.insert(now.begin(), now.end());\n+            expsize -= nowusage;\n+            bestFeeRateRemoved = std::max(bestFeeRateRemoved, CFeeRate(nowfee, nowsize));\n+        }\n+        it++;\n+    }\n+\n+    if (expsize <= sizelimit) {\n+        BOOST_FOREACH(const txiter& it, stage)\n+            removeUnchecked(it);\n+\n+        trackRemovedOrAddFailed(bestFeeRateRemoved);\n+        return true;\n+    } else {\n+        trackRemovedOrAddFailed(CFeeRate(toadd.GetFee(), toadd.GetTxSize()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6722#discussion_r40453689",
      "id" : 40453689,
      "original_commit_id" : "152dcb6abaa5c218fa98b3d71e3804585ea791a0",
      "original_position" : 157,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6722",
      "updated_at" : "2015-09-27T03:05:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/40453689",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6722#discussion_r40453957"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6722"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/40453957"
         }
      },
      "body" : "I'd be concerned about the tradeoff here between one-time cost to stuff the mempool full of very high fee txs, and the length of time that stuffing causes the min relay rate to remain high.   Expecially with 100MB mempool, thats only about 30MB of txs.  So for example at 100k sat / kb fee rate, for 30 BTC you can knock the min relay fee up to 100k satoshis and the effect lasts for some time.",
      "commit_id" : "104c63dad6c3b0a463df1829fe41643f99ac6bd5",
      "created_at" : "2015-09-25T17:26:05Z",
      "diff_hunk" : "@@ -837,3 +845,111 @@ const CTxMemPool::setEntries & CTxMemPool::GetMemPoolChildren(txiter entry) cons\n     assert(it != mapLinks.end());\n     return it->second.children;\n }\n+\n+CFeeRate CTxMemPool::GetMinFee() const {\n+    LOCK(cs);\n+    if (!blockSinceLastRollingFeeBump)\n+        return CFeeRate(rollingMinimumFeeRate);\n+\n+    int64_t time = GetTime();\n+    if (time > lastRollingFeeUpdate + 10) {\n+        rollingMinimumFeeRate = rollingMinimumFeeRate / pow(2.0, (time - lastRollingFeeUpdate) / ROLLING_FEE_HALFLIFE);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6722#discussion_r40453957",
      "id" : 40453957,
      "original_commit_id" : "152dcb6abaa5c218fa98b3d71e3804585ea791a0",
      "original_position" : 61,
      "path" : "src/txmempool.cpp",
      "position" : 61,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6722",
      "updated_at" : "2015-09-27T03:05:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/40453957",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6722#discussion_r40472178"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6722"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/40472178"
         }
      },
      "body" : "Hmm? No a very high fee tx will always evict transactions with lower feerate even if it ends up evicting a very large package to do so.",
      "commit_id" : "104c63dad6c3b0a463df1829fe41643f99ac6bd5",
      "created_at" : "2015-09-25T20:29:02Z",
      "diff_hunk" : "@@ -837,3 +845,111 @@ const CTxMemPool::setEntries & CTxMemPool::GetMemPoolChildren(txiter entry) cons\n     assert(it != mapLinks.end());\n     return it->second.children;\n }\n+\n+CFeeRate CTxMemPool::GetMinFee() const {\n+    LOCK(cs);\n+    if (!blockSinceLastRollingFeeBump)\n+        return CFeeRate(rollingMinimumFeeRate);\n+\n+    int64_t time = GetTime();\n+    if (time > lastRollingFeeUpdate + 10) {\n+        rollingMinimumFeeRate = rollingMinimumFeeRate / pow(2.0, (time - lastRollingFeeUpdate) / ROLLING_FEE_HALFLIFE);\n+        lastRollingFeeUpdate = time;\n+    }\n+    return CFeeRate(rollingMinimumFeeRate);\n+}\n+\n+void CTxMemPool::trackRemovedOrAddFailed(const CFeeRate& rate) {\n+    AssertLockHeld(cs);\n+    if (rate.GetFeePerK() > rollingMinimumFeeRate) {\n+        rollingMinimumFeeRate = rate.GetFeePerK();\n+        blockSinceLastRollingFeeBump = false;\n+    }\n+}\n+\n+bool CTxMemPool::TrimToSize(size_t sizelimit, const CTxMemPoolEntry& toadd) {\n+    AssertLockHeld(cs);\n+\n+    CFeeRate bestFeeRateRemoved;\n+    setEntries stage;\n+    std::set<uint256> protect;\n+    BOOST_FOREACH(const CTxIn& in, toadd.GetTx().vin)\n+        protect.insert(in.prevout.hash);\n+\n+    size_t expsize = DynamicMemoryUsage() + toadd.DynamicMemoryUsage(); // Track the expected resulting memory usage of the mempool.\n+    indexed_transaction_set::nth_index<1>::type::reverse_iterator it = mapTx.get<1>().rbegin();\n+    // Iterate from lowest feerate to highest feerate in the mempool:\n+    while (expsize > sizelimit && it != mapTx.get<1>().rend()) {\n+        if (CompareTxMemPoolEntryByFee()(*it, toadd)) {\n+            // If the transaction's feerate is worse than what we're looking for, we have processed everything in the mempool\n+            // that could improve the staged set. If we don't have an acceptable solution by now, bail out.\n+            break;\n+        }\n+        txiter rootit = mapTx.project<0>(it.base());\n+        rootit--;\n+        if (stage.count(rootit)) {\n+            // If the transaction is already staged for deletion, we know its descendants are already processed, so skip it.\n+            it++;\n+            continue;\n+        }\n+\n+        // Iterate breadth-first over all descendants of transaction 'rootit'...\n+        std::deque<txiter> todo; // List of hashes that we still need to process (descendants of 'rootit').\n+        setEntries now; // Set of tx entries that will need to be added to stage if 'rootit' is included.\n+        CAmount nowfee = 0; // Sum of the fees in 'now'.\n+        size_t nowsize = 0; // Sum of the tx sizes in 'now'.\n+        size_t nowusage = 0; // Sum of the memory usages of transactions in 'now'.\n+        todo.push_back(rootit); // Add 'rootit' to the todo list, to initiate processing its children.\n+        bool good = true; // Whether including 'rootit' (and all its descendants) is a good idea.\n+\n+        while (!todo.empty()) {\n+            const txiter& itnow = todo.front();\n+            if (now.count(itnow))\n+                continue;\n+\n+            const uint256& hashnow = itnow->GetTx().GetHash();\n+            if (protect.count(hashnow)) {\n+                // If this transaction is in the protected set, we're done with 'rootit'.\n+                good = false;\n+                break;\n+            }\n+            // Add 'hashnow' to the 'now' set, and update its statistics.\n+            now.insert(itnow);\n+            nowfee += itnow->GetFee();\n+            nowsize += itnow->GetTxSize();\n+            nowusage += itnow->DynamicMemoryUsage();\n+            todo.pop_front();\n+\n+            // Find dependencies of 'hashnow' and them to todo.\n+            std::map<COutPoint, CInPoint>::iterator iter = mapNextTx.lower_bound(COutPoint(hashnow, 0));\n+            while (iter != mapNextTx.end() && iter->first.hash == hashnow) {\n+                const uint256& nexthash = iter->second.ptx->GetHash();\n+                txiter nextit = mapTx.find(nexthash);\n+                assert(nextit != mapTx.end());\n+                if (!stage.count(nextit) && !now.count(nextit))\n+                    todo.push_back(nextit);\n+                iter++;\n+            }\n+        }\n+\n+        // Check that we aren't removing a set who's total feerate is below that of the set we're removing\n+        // ... and then add now to stage\n+        if (good && (double)nowfee * toadd.GetTxSize() <= (double)toadd.GetFee() * nowsize) {\n+            stage.insert(now.begin(), now.end());\n+            expsize -= nowusage;\n+            bestFeeRateRemoved = std::max(bestFeeRateRemoved, CFeeRate(nowfee, nowsize));\n+        }\n+        it++;\n+    }\n+\n+    if (expsize <= sizelimit) {\n+        BOOST_FOREACH(const txiter& it, stage)\n+            removeUnchecked(it);\n+\n+        trackRemovedOrAddFailed(bestFeeRateRemoved);\n+        return true;\n+    } else {\n+        trackRemovedOrAddFailed(CFeeRate(toadd.GetFee(), toadd.GetTxSize()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6722#discussion_r40472178",
      "id" : 40472178,
      "original_commit_id" : "152dcb6abaa5c218fa98b3d71e3804585ea791a0",
      "original_position" : 157,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6722",
      "updated_at" : "2015-09-27T03:05:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/40472178",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6722#discussion_r40472516"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6722"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/40472516"
         }
      },
      "body" : "Sure, the ROLLING_FEE_HALFLIFE could be dropped a lot. I had originally figured it based on decreasing the mempool right away, but since it now waits at least for one block before it lets the min feerate drop, I think it probably could be dropped a lot. Maybe we even dont want an exponential decrease either.",
      "commit_id" : "104c63dad6c3b0a463df1829fe41643f99ac6bd5",
      "created_at" : "2015-09-25T20:32:56Z",
      "diff_hunk" : "@@ -837,3 +845,111 @@ const CTxMemPool::setEntries & CTxMemPool::GetMemPoolChildren(txiter entry) cons\n     assert(it != mapLinks.end());\n     return it->second.children;\n }\n+\n+CFeeRate CTxMemPool::GetMinFee() const {\n+    LOCK(cs);\n+    if (!blockSinceLastRollingFeeBump)\n+        return CFeeRate(rollingMinimumFeeRate);\n+\n+    int64_t time = GetTime();\n+    if (time > lastRollingFeeUpdate + 10) {\n+        rollingMinimumFeeRate = rollingMinimumFeeRate / pow(2.0, (time - lastRollingFeeUpdate) / ROLLING_FEE_HALFLIFE);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6722#discussion_r40472516",
      "id" : 40472516,
      "original_commit_id" : "152dcb6abaa5c218fa98b3d71e3804585ea791a0",
      "original_position" : 61,
      "path" : "src/txmempool.cpp",
      "position" : 61,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6722",
      "updated_at" : "2015-09-27T03:05:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/40472516",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "@JeremyRubin No, you're right, this breaks relaying of child-pays-for-parent when mempool grows large (assuming the package is not already present). The easy solution is to allow fee calulation of packages together when processing orphans, and then you send your package in reverse-dependancy order.",
      "created_at" : "2015-09-25T20:38:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6722#issuecomment-143347863",
      "id" : 143347863,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6722",
      "updated_at" : "2015-09-25T20:38:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/143347863",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "@TheBlueMatt re: my comment on high fee txs.  I see now, you aren't doing the overall fee check in order to boot a package.  I just assumed the StageTrimToSize logic was the same.  So how do you think about free relay then?  Could you write up a quick intro describing the algorithm as it would help to know how you think about it.  Is the idea that all even though the tx causing the eviction hasn't covered the fees to pay for the evicted packages relay, by boosting the minRelayRate you're essentially forcing all future transactions to do so?\r\n\r\nIt's an interesting idea, one question is how big a sweet spot there is between having the half-life too long  and worrying about the \"cram relayFee high all of a sudden\" attack vs having it too low and perhaps having some vague concern about free relay.\r\n\r\nWhy does your increased relay fee only apply to low priority transactions?  I think it has to apply to all.\r\n",
      "created_at" : "2015-09-25T23:45:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6722#issuecomment-143378272",
      "id" : 143378272,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6722",
      "updated_at" : "2015-09-25T23:45:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/143378272",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "body" : "@morcos see the description of the main commit:\r\n\"This limits mempool by walking the lowest-feerate txn in mempool\r\nwhen it goes over -maxmempool in size, removing them.\r\nIt then sets the minimum relay fee to the maximum fee\r\ntransaction-and-dependant-set it removed, plus the default minimum\r\nrelay fee. After the next block is received, the minimum relay fee\r\nis allowed to decrease exponentially (with a half-life of one day).\r\n\r\nThe minimum -maxmempool size is 10*-limitdescendantsize, as it is\r\neasy for an attacker to play games with the cheapest\r\n-limitdescendantsize transactions.\r\n\r\nNote that this effectively disables high-priority transaction relay\r\niff the mempool becomes large.\"\r\n\r\nAs for your specific questions: Yes, the idea is that you can relay some cheap crap for a bit, driving up the min relay fee by the default min relay fee each time (which was always meant as a \"this is what it costs to send a transaction around the network\" constant, though it hasn't always done a good job of being accurate there).\r\n\r\nThe increased relay fee will effectively apply to low priority transactions, as they will be the package selected by the final TrimToSize call. Thus, priority-based relay will effectively remain enabled until people's mempools fill up.",
      "created_at" : "2015-09-26T00:25:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6722#issuecomment-143382724",
      "id" : 143382724,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6722",
      "updated_at" : "2015-09-26T00:25:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/143382724",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6722#discussion_r40487766"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6722"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/40487766"
         }
      },
      "body" : "need to pop_front() before continuing, otherwise its an infinite loop",
      "commit_id" : "104c63dad6c3b0a463df1829fe41643f99ac6bd5",
      "created_at" : "2015-09-26T00:51:29Z",
      "diff_hunk" : "@@ -837,3 +845,109 @@ const CTxMemPool::setEntries & CTxMemPool::GetMemPoolChildren(txiter entry) cons\n     assert(it != mapLinks.end());\n     return it->second.children;\n }\n+\n+CFeeRate CTxMemPool::GetMinFee() const {\n+    LOCK(cs);\n+    if (!blockSinceLastRollingFeeBump)\n+        return CFeeRate(rollingMinimumFeeRate);\n+\n+    int64_t time = GetTime();\n+    if (time > lastRollingFeeUpdate + 10) {\n+        rollingMinimumFeeRate = rollingMinimumFeeRate / pow(2.0, (time - lastRollingFeeUpdate) / ROLLING_FEE_HALFLIFE);\n+        lastRollingFeeUpdate = time;\n+    }\n+    return CFeeRate(rollingMinimumFeeRate);\n+}\n+\n+void CTxMemPool::trackRemovedOrAddFailed(const CFeeRate& rate) {\n+    AssertLockHeld(cs);\n+    if (rate.GetFeePerK() > rollingMinimumFeeRate) {\n+        rollingMinimumFeeRate = rate.GetFeePerK();\n+        blockSinceLastRollingFeeBump = false;\n+    }\n+}\n+\n+bool CTxMemPool::TrimToSize(size_t sizelimit, const CTxMemPoolEntry& toadd) {\n+    LOCK(cs);\n+\n+    CFeeRate bestFeeRateRemoved;\n+    setEntries stage;\n+    std::set<uint256> protect;\n+    BOOST_FOREACH(const CTxIn& in, toadd.GetTx().vin)\n+        protect.insert(in.prevout.hash);\n+\n+    size_t expsize = DynamicMemoryUsage() + toadd.DynamicMemoryUsage(); // Track the expected resulting memory usage of the mempool.\n+    indexed_transaction_set::nth_index<1>::type::reverse_iterator it = mapTx.get<1>().rbegin();\n+    // Iterate from lowest feerate to highest feerate in the mempool:\n+    while (expsize > sizelimit && it != mapTx.get<1>().rend()) {\n+        if (CompareTxMemPoolEntryByFee()(*it, toadd)) {\n+            // If the transaction's feerate is worse than what we're looking for, we have processed everything in the mempool\n+            // that could improve the staged set. If we don't have an acceptable solution by now, bail out.\n+            break;\n+        }\n+        txiter rootit = mapTx.project<0>(it.base());\n+        rootit--;\n+        if (stage.count(rootit)) {\n+            // If the transaction is already staged for deletion, we know its descendants are already processed, so skip it.\n+            it++;\n+            continue;\n+        }\n+\n+        // Iterate breadth-first over all descendants of transaction 'rootit'...\n+        std::deque<txiter> todo; // List of hashes that we still need to process (descendants of 'rootit').\n+        setEntries now; // Set of tx entries that will need to be added to stage if 'rootit' is included.\n+        CAmount nowfee = 0; // Sum of the fees in 'now'.\n+        size_t nowsize = 0; // Sum of the tx sizes in 'now'.\n+        size_t nowusage = 0; // Sum of the memory usages of transactions in 'now'.\n+        todo.push_back(rootit); // Add 'rootit' to the todo list, to initiate processing its children.\n+        bool good = true; // Whether including 'rootit' (and all its descendants) is a good idea.\n+\n+        while (!todo.empty()) {\n+            const txiter& itnow = todo.front();\n+            if (now.count(itnow))\n+                continue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6722#discussion_r40487766",
      "id" : 40487766,
      "original_commit_id" : "0ae46697fecbb524ec056ace7005e1c291556c72",
      "original_position" : 113,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6722",
      "updated_at" : "2015-09-27T03:05:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/40487766",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "body" : "But in particular the increased relay fee does NOT apply to high priority txs?  That's what I don't understand.  It seems you could use the same stable of high priority inputs over and over to gain free relay.",
      "created_at" : "2015-09-26T00:57:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6722#issuecomment-143386645",
      "id" : 143386645,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6722",
      "updated_at" : "2015-09-26T00:57:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/143386645",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6722#discussion_r40488841"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6722"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/40488841"
         }
      },
      "body" : "LOL, oops...",
      "commit_id" : "104c63dad6c3b0a463df1829fe41643f99ac6bd5",
      "created_at" : "2015-09-26T01:53:09Z",
      "diff_hunk" : "@@ -837,3 +845,109 @@ const CTxMemPool::setEntries & CTxMemPool::GetMemPoolChildren(txiter entry) cons\n     assert(it != mapLinks.end());\n     return it->second.children;\n }\n+\n+CFeeRate CTxMemPool::GetMinFee() const {\n+    LOCK(cs);\n+    if (!blockSinceLastRollingFeeBump)\n+        return CFeeRate(rollingMinimumFeeRate);\n+\n+    int64_t time = GetTime();\n+    if (time > lastRollingFeeUpdate + 10) {\n+        rollingMinimumFeeRate = rollingMinimumFeeRate / pow(2.0, (time - lastRollingFeeUpdate) / ROLLING_FEE_HALFLIFE);\n+        lastRollingFeeUpdate = time;\n+    }\n+    return CFeeRate(rollingMinimumFeeRate);\n+}\n+\n+void CTxMemPool::trackRemovedOrAddFailed(const CFeeRate& rate) {\n+    AssertLockHeld(cs);\n+    if (rate.GetFeePerK() > rollingMinimumFeeRate) {\n+        rollingMinimumFeeRate = rate.GetFeePerK();\n+        blockSinceLastRollingFeeBump = false;\n+    }\n+}\n+\n+bool CTxMemPool::TrimToSize(size_t sizelimit, const CTxMemPoolEntry& toadd) {\n+    LOCK(cs);\n+\n+    CFeeRate bestFeeRateRemoved;\n+    setEntries stage;\n+    std::set<uint256> protect;\n+    BOOST_FOREACH(const CTxIn& in, toadd.GetTx().vin)\n+        protect.insert(in.prevout.hash);\n+\n+    size_t expsize = DynamicMemoryUsage() + toadd.DynamicMemoryUsage(); // Track the expected resulting memory usage of the mempool.\n+    indexed_transaction_set::nth_index<1>::type::reverse_iterator it = mapTx.get<1>().rbegin();\n+    // Iterate from lowest feerate to highest feerate in the mempool:\n+    while (expsize > sizelimit && it != mapTx.get<1>().rend()) {\n+        if (CompareTxMemPoolEntryByFee()(*it, toadd)) {\n+            // If the transaction's feerate is worse than what we're looking for, we have processed everything in the mempool\n+            // that could improve the staged set. If we don't have an acceptable solution by now, bail out.\n+            break;\n+        }\n+        txiter rootit = mapTx.project<0>(it.base());\n+        rootit--;\n+        if (stage.count(rootit)) {\n+            // If the transaction is already staged for deletion, we know its descendants are already processed, so skip it.\n+            it++;\n+            continue;\n+        }\n+\n+        // Iterate breadth-first over all descendants of transaction 'rootit'...\n+        std::deque<txiter> todo; // List of hashes that we still need to process (descendants of 'rootit').\n+        setEntries now; // Set of tx entries that will need to be added to stage if 'rootit' is included.\n+        CAmount nowfee = 0; // Sum of the fees in 'now'.\n+        size_t nowsize = 0; // Sum of the tx sizes in 'now'.\n+        size_t nowusage = 0; // Sum of the memory usages of transactions in 'now'.\n+        todo.push_back(rootit); // Add 'rootit' to the todo list, to initiate processing its children.\n+        bool good = true; // Whether including 'rootit' (and all its descendants) is a good idea.\n+\n+        while (!todo.empty()) {\n+            const txiter& itnow = todo.front();\n+            if (now.count(itnow))\n+                continue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6722#discussion_r40488841",
      "id" : 40488841,
      "original_commit_id" : "0ae46697fecbb524ec056ace7005e1c291556c72",
      "original_position" : 113,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6722",
      "updated_at" : "2015-09-27T03:05:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/40488841",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Hmm, indeed, there is an attack there where you can cause lots of relay for free there. You cant really get much into the mempool (only up to the max package size) and you do have to increase the feerate each time, but only by one satoshi per kb...",
      "created_at" : "2015-09-26T01:59:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6722#issuecomment-143390920",
      "id" : 143390920,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6722",
      "updated_at" : "2015-09-26T01:59:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/143390920",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6722#discussion_r40495966"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6722"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/40495966"
         }
      },
      "body" : "this is a bug.  rootit is an iterator by txid hash, so decrementing it puts you at a completely random transaction.\r\nthe base iterator needs to be decremented before projecting.\r\n\r\n@sdaftuar and i didn't like this oddness, so the first commit in #6557 reverses the feerate sort.  there was no reason to do it the other way in the first place.  maybe you should just grab that?",
      "commit_id" : "104c63dad6c3b0a463df1829fe41643f99ac6bd5",
      "created_at" : "2015-09-26T17:30:15Z",
      "diff_hunk" : "@@ -837,3 +845,111 @@ const CTxMemPool::setEntries & CTxMemPool::GetMemPoolChildren(txiter entry) cons\n     assert(it != mapLinks.end());\n     return it->second.children;\n }\n+\n+CFeeRate CTxMemPool::GetMinFee() const {\n+    LOCK(cs);\n+    if (!blockSinceLastRollingFeeBump)\n+        return CFeeRate(rollingMinimumFeeRate);\n+\n+    int64_t time = GetTime();\n+    if (time > lastRollingFeeUpdate + 10) {\n+        rollingMinimumFeeRate = rollingMinimumFeeRate / pow(2.0, (time - lastRollingFeeUpdate) / ROLLING_FEE_HALFLIFE);\n+        lastRollingFeeUpdate = time;\n+    }\n+    return CFeeRate(rollingMinimumFeeRate);\n+}\n+\n+void CTxMemPool::trackRemovedOrAddFailed(const CFeeRate& rate) {\n+    AssertLockHeld(cs);\n+    if (rate.GetFeePerK() > rollingMinimumFeeRate) {\n+        rollingMinimumFeeRate = rate.GetFeePerK();\n+        blockSinceLastRollingFeeBump = false;\n+    }\n+}\n+\n+bool CTxMemPool::TrimToSize(size_t sizelimit, const CTxMemPoolEntry& toadd) {\n+    LOCK(cs);\n+\n+    CFeeRate bestFeeRateRemoved;\n+    setEntries stage;\n+    std::set<uint256> protect;\n+    BOOST_FOREACH(const CTxIn& in, toadd.GetTx().vin)\n+        protect.insert(in.prevout.hash);\n+\n+    size_t expsize = DynamicMemoryUsage() + toadd.DynamicMemoryUsage(); // Track the expected resulting memory usage of the mempool.\n+    indexed_transaction_set::nth_index<1>::type::reverse_iterator it = mapTx.get<1>().rbegin();\n+    // Iterate from lowest feerate to highest feerate in the mempool:\n+    while (expsize > sizelimit && it != mapTx.get<1>().rend()) {\n+        if (CompareTxMemPoolEntryByFee()(*it, toadd)) {\n+            // If the transaction's feerate is worse than what we're looking for, we have processed everything in the mempool\n+            // that could improve the staged set. If we don't have an acceptable solution by now, bail out.\n+            break;\n+        }\n+        txiter rootit = mapTx.project<0>(it.base());\n+        rootit--;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6722#discussion_r40495966",
      "id" : 40495966,
      "original_commit_id" : "22d846f57374ffc4a71eaf942d3c9ccd252ae956",
      "original_position" : 94,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6722",
      "updated_at" : "2015-09-27T03:05:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/40495966",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6722#discussion_r40499037"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6722"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/40499037"
         }
      },
      "body" : "Keep in mind this is a ratio of 2 different measurements.  Serialized transaction size for descendant limit and mempool memory usage for maxmempool.  There is about a 3x ratio between those measurements.  So a 25MB mempool would actually only fit about 3 maximum sized packages...  (I used 4x as a conservative ratio, and similarly wanted a 10x difference so ended up with 40x between the arguments.)",
      "commit_id" : "104c63dad6c3b0a463df1829fe41643f99ac6bd5",
      "created_at" : "2015-09-26T22:22:38Z",
      "diff_hunk" : "@@ -841,6 +842,12 @@ bool AppInit2(boost::thread_group& threadGroup, CScheduler& scheduler)\n     fCheckBlockIndex = GetBoolArg(\"-checkblockindex\", chainparams.DefaultConsistencyChecks());\n     fCheckpointsEnabled = GetBoolArg(\"-checkpoints\", true);\n \n+    // -mempoollimit limits\n+    int64_t nMempoolSizeLimit = GetArg(\"-maxmempool\", DEFAULT_MAX_MEMPOOL_SIZE) * 1000000;\n+    int64_t nMempoolDescendantSizeLimit = GetArg(\"-limitdescendantsize\", DEFAULT_DESCENDANT_SIZE_LIMIT) * 1000;\n+    if (nMempoolSizeLimit < 0 || nMempoolSizeLimit < nMempoolDescendantSizeLimit * 10)\n+        return InitError(strprintf(_(\"Error: -maxmempool must be at least %d MB\"), GetArg(\"-limitdescendantsize\", DEFAULT_DESCENDANT_SIZE_LIMIT) / 100));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6722#discussion_r40499037",
      "id" : 40499037,
      "original_commit_id" : "22d846f57374ffc4a71eaf942d3c9ccd252ae956",
      "original_position" : 16,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6722",
      "updated_at" : "2015-09-27T03:05:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/40499037",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "body" : "What's wrong with XT's method of discarding a random transaction so that you can't predictably  manipulate the mempool?",
      "created_at" : "2015-09-26T22:30:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6722#issuecomment-143500720",
      "id" : 143500720,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6722",
      "updated_at" : "2015-09-26T22:30:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/143500720",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6762681?v=3",
         "events_url" : "https://api.github.com/users/NanoAkron/events{/privacy}",
         "followers_url" : "https://api.github.com/users/NanoAkron/followers",
         "following_url" : "https://api.github.com/users/NanoAkron/following{/other_user}",
         "gists_url" : "https://api.github.com/users/NanoAkron/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/NanoAkron",
         "id" : 6762681,
         "login" : "NanoAkron",
         "organizations_url" : "https://api.github.com/users/NanoAkron/orgs",
         "received_events_url" : "https://api.github.com/users/NanoAkron/received_events",
         "repos_url" : "https://api.github.com/users/NanoAkron/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/NanoAkron/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/NanoAkron/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/NanoAkron"
      }
   },
   {
      "body" : "@NanoAkron It makes it trivial to DoS the network, among many other issues.",
      "created_at" : "2015-09-26T22:36:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6722#issuecomment-143501742",
      "id" : 143501742,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6722",
      "updated_at" : "2015-09-26T22:36:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/143501742",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6722#discussion_r40499174"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6722"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/40499174"
         }
      },
      "body" : "Oops, yea, my notes to fix this from earlier were saying do something like 100MB, for this reason...Last time I ignore my notes and just do what I think when I'm sick :/",
      "commit_id" : "104c63dad6c3b0a463df1829fe41643f99ac6bd5",
      "created_at" : "2015-09-26T22:38:15Z",
      "diff_hunk" : "@@ -841,6 +842,12 @@ bool AppInit2(boost::thread_group& threadGroup, CScheduler& scheduler)\n     fCheckBlockIndex = GetBoolArg(\"-checkblockindex\", chainparams.DefaultConsistencyChecks());\n     fCheckpointsEnabled = GetBoolArg(\"-checkpoints\", true);\n \n+    // -mempoollimit limits\n+    int64_t nMempoolSizeLimit = GetArg(\"-maxmempool\", DEFAULT_MAX_MEMPOOL_SIZE) * 1000000;\n+    int64_t nMempoolDescendantSizeLimit = GetArg(\"-limitdescendantsize\", DEFAULT_DESCENDANT_SIZE_LIMIT) * 1000;\n+    if (nMempoolSizeLimit < 0 || nMempoolSizeLimit < nMempoolDescendantSizeLimit * 10)\n+        return InitError(strprintf(_(\"Error: -maxmempool must be at least %d MB\"), GetArg(\"-limitdescendantsize\", DEFAULT_DESCENDANT_SIZE_LIMIT) / 100));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6722#discussion_r40499174",
      "id" : 40499174,
      "original_commit_id" : "22d846f57374ffc4a71eaf942d3c9ccd252ae956",
      "original_position" : 16,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6722",
      "updated_at" : "2015-09-27T03:05:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/40499174",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6722#discussion_r40824946"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6722"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/40824946"
         }
      },
      "body" : "These functions will be called every time through even if the mempool wasn't full to start with",
      "commit_id" : "104c63dad6c3b0a463df1829fe41643f99ac6bd5",
      "created_at" : "2015-09-30T17:36:38Z",
      "diff_hunk" : "@@ -837,3 +845,110 @@ const CTxMemPool::setEntries & CTxMemPool::GetMemPoolChildren(txiter entry) cons\n     assert(it != mapLinks.end());\n     return it->second.children;\n }\n+\n+CFeeRate CTxMemPool::GetMinFee() const {\n+    LOCK(cs);\n+    if (!blockSinceLastRollingFeeBump)\n+        return CFeeRate(rollingMinimumFeeRate);\n+\n+    int64_t time = GetTime();\n+    if (time > lastRollingFeeUpdate + 10) {\n+        rollingMinimumFeeRate = rollingMinimumFeeRate / pow(2.0, (time - lastRollingFeeUpdate) / ROLLING_FEE_HALFLIFE);\n+        lastRollingFeeUpdate = time;\n+    }\n+    return CFeeRate(rollingMinimumFeeRate);\n+}\n+\n+void CTxMemPool::trackRemovedOrAddFailed(const CFeeRate& rate) {\n+    AssertLockHeld(cs);\n+    if (rate.GetFeePerK() > rollingMinimumFeeRate) {\n+        rollingMinimumFeeRate = rate.GetFeePerK();\n+        blockSinceLastRollingFeeBump = false;\n+    }\n+}\n+\n+bool CTxMemPool::TrimToSize(size_t sizelimit, const CTxMemPoolEntry& toadd) {\n+    LOCK(cs);\n+\n+    CFeeRate bestFeeRateRemoved;\n+    setEntries stage;\n+    std::set<uint256> protect;\n+    BOOST_FOREACH(const CTxIn& in, toadd.GetTx().vin)\n+        protect.insert(in.prevout.hash);\n+\n+    size_t expsize = DynamicMemoryUsage() + toadd.DynamicMemoryUsage(); // Track the expected resulting memory usage of the mempool.\n+    indexed_transaction_set::nth_index<1>::type::iterator it = mapTx.get<1>().begin();\n+    // Iterate from lowest feerate to highest feerate in the mempool:\n+    while (expsize > sizelimit && it != mapTx.get<1>().end()) {\n+        if (CompareTxMemPoolEntryByFee()(*it, toadd)) {\n+            // If the transaction's feerate is worse than what we're looking for, we have processed everything in the mempool\n+            // that could improve the staged set. If we don't have an acceptable solution by now, bail out.\n+            break;\n+        }\n+        txiter rootit = mapTx.project<0>(it);\n+        if (stage.count(rootit)) {\n+            // If the transaction is already staged for deletion, we know its descendants are already processed, so skip it.\n+            it++;\n+            continue;\n+        }\n+\n+        // Iterate breadth-first over all descendants of transaction 'rootit'...\n+        std::deque<txiter> todo; // List of hashes that we still need to process (descendants of 'rootit').\n+        setEntries now; // Set of tx entries that will need to be added to stage if 'rootit' is included.\n+        CAmount nowfee = 0; // Sum of the fees in 'now'.\n+        size_t nowsize = 0; // Sum of the tx sizes in 'now'.\n+        size_t nowusage = 0; // Sum of the memory usages of transactions in 'now'.\n+        todo.push_back(rootit); // Add 'rootit' to the todo list, to initiate processing its children.\n+        bool good = true; // Whether including 'rootit' (and all its descendants) is a good idea.\n+\n+        while (!todo.empty()) {\n+            const txiter& itnow = todo.front();\n+            if (now.count(itnow)) {\n+                todo.pop_front();\n+                continue;\n+            }\n+\n+            const uint256& hashnow = itnow->GetTx().GetHash();\n+            if (protect.count(hashnow)) {\n+                // If this transaction is in the protected set, we're done with 'rootit'.\n+                good = false;\n+                break;\n+            }\n+            // Add 'hashnow' to the 'now' set, and update its statistics.\n+            now.insert(itnow);\n+            nowfee += itnow->GetFee();\n+            nowsize += itnow->GetTxSize();\n+            nowusage += itnow->DynamicMemoryUsage();\n+            todo.pop_front();\n+\n+            // Find dependencies of 'hashnow' and them to todo.\n+            std::map<COutPoint, CInPoint>::iterator iter = mapNextTx.lower_bound(COutPoint(hashnow, 0));\n+            while (iter != mapNextTx.end() && iter->first.hash == hashnow) {\n+                const uint256& nexthash = iter->second.ptx->GetHash();\n+                txiter nextit = mapTx.find(nexthash);\n+                assert(nextit != mapTx.end());\n+                if (!stage.count(nextit) && !now.count(nextit))\n+                    todo.push_back(nextit);\n+                iter++;\n+            }\n+        }\n+\n+        // Check that we aren't removing a set who's total feerate is below that of the set we're removing\n+        // ... and then add now to stage\n+        if (good && (double)nowfee * toadd.GetTxSize() <= (double)toadd.GetFee() * nowsize) {\n+            stage.insert(now.begin(), now.end());\n+            expsize -= nowusage;\n+            bestFeeRateRemoved = std::max(bestFeeRateRemoved, CFeeRate(nowfee, nowsize));\n+        }\n+        it++;\n+    }\n+\n+    if (expsize <= sizelimit) {\n+        RemoveStaged(stage);\n+        trackRemovedOrAddFailed(bestFeeRateRemoved);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6722#discussion_r40824946",
      "id" : 40824946,
      "original_commit_id" : "104c63dad6c3b0a463df1829fe41643f99ac6bd5",
      "original_position" : 153,
      "path" : "src/txmempool.cpp",
      "position" : 153,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6722",
      "updated_at" : "2015-09-30T17:36:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/40824946",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6722#discussion_r40828264"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6722"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/40828264"
         }
      },
      "body" : "With the way the half-life calculation works, I believe it would take a very long time before mempoolRejectFee will reach 0 again, after an eviction; this in turn would cause us to wait a really long time before being willing to relay low-fee transactions that have high priority.  Perhaps the mempool could round the min fee it returns down to 0 at some point so that this doesn't take forever, or we can adjust the way we use it here to allow for the priority calculation to kick in even if the mempoolRejectFee isn't exactly 0?",
      "commit_id" : "104c63dad6c3b0a463df1829fe41643f99ac6bd5",
      "created_at" : "2015-09-30T18:02:13Z",
      "diff_hunk" : "@@ -879,17 +876,20 @@ bool AcceptToMemoryPool(CTxMemPool& pool, CValidationState &state, const CTransa\n         CAmount nFees = nValueIn-nValueOut;\n         double dPriority = view.GetPriority(tx, chainActive.Height());\n \n-        CTxMemPoolEntry entry(tx, nFees, GetTime(), dPriority, chainActive.Height(), mempool.HasNoInputsOf(tx));\n+        CTxMemPoolEntry entry(tx, nFees, GetTime(), dPriority, chainActive.Height(), pool.HasNoInputsOf(tx));\n         unsigned int nSize = entry.GetTxSize();\n \n         // Don't accept it if it can't get into a block\n-        CAmount txMinFee = GetMinRelayFee(tx, nSize, true);\n+        CAmount txMinFee = GetMinRelayFee(tx, pool, nSize, true);\n         if (fLimitFree && nFees < txMinFee)\n             return state.DoS(0, false, REJECT_INSUFFICIENTFEE, \"insufficient fee\", false,\n                 strprintf(\"%d < %d\", nFees, txMinFee));\n \n-        // Require that free transactions have sufficient priority to be mined in the next block.\n-        if (GetBoolArg(\"-relaypriority\", true) && nFees < ::minRelayTxFee.GetFee(nSize) && !AllowFree(view.GetPriority(tx, chainActive.Height() + 1))) {\n+        CAmount mempoolRejectFee = pool.GetMinFee().GetFee(nSize);\n+        if (mempoolRejectFee > 0 && nFees < ::minRelayTxFee.GetFee(nSize) + mempoolRejectFee) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6722#discussion_r40828264",
      "id" : 40828264,
      "original_commit_id" : "104c63dad6c3b0a463df1829fe41643f99ac6bd5",
      "original_position" : 43,
      "path" : "src/main.cpp",
      "position" : 43,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6722",
      "updated_at" : "2015-09-30T18:02:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/40828264",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6722#discussion_r40832241"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6722"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/40832241"
         }
      },
      "body" : "I think it'd be better to make this default value as large as we think users can reasonably live with. 100MB of memory is only about 30MB of actual transactions, or 30 full blocks.  It seems to me like all the attacks someone could do on a limited mempool involve trying to play games with the effects of eviction, so having a bigger default mempool just causes all attacks to scale up in cost to carry out, because an attacker has to generate more transactions just to trigger eviction.\r\n\r\n#6557 has a 500MB default; if we're concerned that may be too big, how about 250 or 300MB?",
      "commit_id" : "104c63dad6c3b0a463df1829fe41643f99ac6bd5",
      "created_at" : "2015-09-30T18:31:47Z",
      "diff_hunk" : "@@ -51,6 +51,8 @@ static const unsigned int DEFAULT_ANCESTOR_SIZE_LIMIT = 900;\n static const unsigned int DEFAULT_DESCENDANT_LIMIT = 1000;\n /** Default for -limitdescendantsize, maximum kilobytes of in-mempool descendants */\n static const unsigned int DEFAULT_DESCENDANT_SIZE_LIMIT = 2500;\n+/** Default for -maxmempool, maximum megabytes of mempool memory usage */\n+static const unsigned int DEFAULT_MAX_MEMPOOL_SIZE = 100;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6722#discussion_r40832241",
      "id" : 40832241,
      "original_commit_id" : "104c63dad6c3b0a463df1829fe41643f99ac6bd5",
      "original_position" : 5,
      "path" : "src/main.h",
      "position" : 5,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6722",
      "updated_at" : "2015-09-30T18:31:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/40832241",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "I think the `ROLLING_FEE_HALFLIFE` should be 12 hours.  Here's my analysis:\r\nThe purpose of the `rollingMinimumFeeRate` is to strike the right balance between two things.  \r\n- Future transactions should be obligated to pay for the cost of transactions that were evicted (and their own relay fee) otherwise a large package of transactions could be evicted by a small tx with a slightly higher fee rate.  This could happen repeatedly for a bandwidth attack.\r\n- It must decay so an attacker can not pack the mempool full of high fee txs one time and peg the effective min relay rate very high for a long time for the cost of stuffing the mempool once.\r\n\r\nFrom the point of view of the bandwidth attack:  \r\nAssume the prevailing fee rate at the bottom of the mempool is X times the relay rate.  Then a full size 2.5MB package can be evicted from there by paying X+1 on a small 200 byte tx.  Effectively you have now paid the minimum relay fee on (200X + 200) bytes, but have relayed 2.5MB + 200 bytes, so you got free relay of 2.5MB - X * 200 bytes.  \r\n\r\nAs soon as the `rollingMinimumFeeRate` has dropped from X back down to X-1, you can repeat the attack.  At a half-life of 12 hours and assuming X = 20, then it'll take about 53 mins for that to happen.  So you can free relay 47 kB per min.  This seems sufficiently small compared to the bare minimum network relay capacity of 100 kB per min (1 block every 10 mins).  \r\n\r\nSince the decay is exponential, you'll actually take a lot longer than 53 mins to repeat the attack if the prevailing fee rate multiple X is considerably less than 20.   However as the prevailing fee rate climbs the attack could be considered a bigger concern.  This should be addressed by having a default minimum relay rate that is higher.  It seams reasonable that over the long term the default minimum relay rate will not be much less than 1/20th of the prevailing fee rate at the bottom of mempools.\r\n\r\n\r\nFrom the point of view of stuffing the mempool:  \r\nIf we imagine a 100MB mempool, then filling it with 30MB of transactions (sizewise = 100MB of usage) at a 100K sat/KB fee rate  will cost 30 BTC.   \r\n\r\nIn this case access to the network will be blocked for all txs less than 100k feerate for 5 hours while those transactions are mined anyway.  The additional gain the `rollingMinimumFeeRate` gives an attacker is another 7 hours until the decay has brought down the feerate to 50K.   \r\n\r\nSince the attacker could have stopped anything under 50K feerate anyway for 10 hours by just issuing 60MB worth of transactions at that fee rate.  This attack is not significantly worse.\r\n\r\nSo I think 12 hours strikes about the right balance.\r\n",
      "created_at" : "2015-09-30T18:32:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6722#issuecomment-144501017",
      "id" : 144501017,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6722",
      "updated_at" : "2015-09-30T18:32:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/144501017",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6722#discussion_r40833980"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6722"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/40833980"
         }
      },
      "body" : "I haven't thought about how much this is likely to matter but I don't think this is the best way to guess the expected size of the resulting mempool -- it misses the extra overhead from mapLinks, mapNextTx, and the multi_index pointers itself.  \r\n\r\nI think this code here is almost correct:\r\nhttps://github.com/sdaftuar/bitcoin/blob/7008233767bd5e03521d96cde414394975e940d7/src/txmempool.cpp#L797\r\n\r\n[There is an error though; the value of \"9\" that is used in the multi_index memory estimator should actually be a \"6\" I think in both DynamicMemoryUsage and GuessDynamicMemoryUsage.]",
      "commit_id" : "104c63dad6c3b0a463df1829fe41643f99ac6bd5",
      "created_at" : "2015-09-30T18:43:59Z",
      "diff_hunk" : "@@ -837,3 +845,110 @@ const CTxMemPool::setEntries & CTxMemPool::GetMemPoolChildren(txiter entry) cons\n     assert(it != mapLinks.end());\n     return it->second.children;\n }\n+\n+CFeeRate CTxMemPool::GetMinFee() const {\n+    LOCK(cs);\n+    if (!blockSinceLastRollingFeeBump)\n+        return CFeeRate(rollingMinimumFeeRate);\n+\n+    int64_t time = GetTime();\n+    if (time > lastRollingFeeUpdate + 10) {\n+        rollingMinimumFeeRate = rollingMinimumFeeRate / pow(2.0, (time - lastRollingFeeUpdate) / ROLLING_FEE_HALFLIFE);\n+        lastRollingFeeUpdate = time;\n+    }\n+    return CFeeRate(rollingMinimumFeeRate);\n+}\n+\n+void CTxMemPool::trackRemovedOrAddFailed(const CFeeRate& rate) {\n+    AssertLockHeld(cs);\n+    if (rate.GetFeePerK() > rollingMinimumFeeRate) {\n+        rollingMinimumFeeRate = rate.GetFeePerK();\n+        blockSinceLastRollingFeeBump = false;\n+    }\n+}\n+\n+bool CTxMemPool::TrimToSize(size_t sizelimit, const CTxMemPoolEntry& toadd) {\n+    LOCK(cs);\n+\n+    CFeeRate bestFeeRateRemoved;\n+    setEntries stage;\n+    std::set<uint256> protect;\n+    BOOST_FOREACH(const CTxIn& in, toadd.GetTx().vin)\n+        protect.insert(in.prevout.hash);\n+\n+    size_t expsize = DynamicMemoryUsage() + toadd.DynamicMemoryUsage(); // Track the expected resulting memory usage of the mempool.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6722#discussion_r40833980",
      "id" : 40833980,
      "original_commit_id" : "104c63dad6c3b0a463df1829fe41643f99ac6bd5",
      "original_position" : 84,
      "path" : "src/txmempool.cpp",
      "position" : 84,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6722",
      "updated_at" : "2015-09-30T18:43:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/40833980",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6722#discussion_r40836107"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6722"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/40836107"
         }
      },
      "body" : "If you change ```TrimToSize()``` to take as an argument the ancestors of the entry being considered (which is calculated earlier in ```AcceptToMemoryPool()```), then you can get rid of ```protect```, and instead just check that each package root that you consider isn't an ancestor of the entry being added.  (This is what I did in #6557 and I think it helps make the code a lot simpler, especially combined with using ```CalculateDescendants()``` to grab all the descendants instead of writing a new loop here.)",
      "commit_id" : "104c63dad6c3b0a463df1829fe41643f99ac6bd5",
      "created_at" : "2015-09-30T18:58:44Z",
      "diff_hunk" : "@@ -837,3 +845,110 @@ const CTxMemPool::setEntries & CTxMemPool::GetMemPoolChildren(txiter entry) cons\n     assert(it != mapLinks.end());\n     return it->second.children;\n }\n+\n+CFeeRate CTxMemPool::GetMinFee() const {\n+    LOCK(cs);\n+    if (!blockSinceLastRollingFeeBump)\n+        return CFeeRate(rollingMinimumFeeRate);\n+\n+    int64_t time = GetTime();\n+    if (time > lastRollingFeeUpdate + 10) {\n+        rollingMinimumFeeRate = rollingMinimumFeeRate / pow(2.0, (time - lastRollingFeeUpdate) / ROLLING_FEE_HALFLIFE);\n+        lastRollingFeeUpdate = time;\n+    }\n+    return CFeeRate(rollingMinimumFeeRate);\n+}\n+\n+void CTxMemPool::trackRemovedOrAddFailed(const CFeeRate& rate) {\n+    AssertLockHeld(cs);\n+    if (rate.GetFeePerK() > rollingMinimumFeeRate) {\n+        rollingMinimumFeeRate = rate.GetFeePerK();\n+        blockSinceLastRollingFeeBump = false;\n+    }\n+}\n+\n+bool CTxMemPool::TrimToSize(size_t sizelimit, const CTxMemPoolEntry& toadd) {\n+    LOCK(cs);\n+\n+    CFeeRate bestFeeRateRemoved;\n+    setEntries stage;\n+    std::set<uint256> protect;\n+    BOOST_FOREACH(const CTxIn& in, toadd.GetTx().vin)\n+        protect.insert(in.prevout.hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6722#discussion_r40836107",
      "id" : 40836107,
      "original_commit_id" : "104c63dad6c3b0a463df1829fe41643f99ac6bd5",
      "original_position" : 82,
      "path" : "src/txmempool.cpp",
      "position" : 82,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6722",
      "updated_at" : "2015-09-30T18:58:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/40836107",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "concept ACK - prefer 24-48 hours - will do some testing\r\n",
      "created_at" : "2015-09-30T19:40:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6722#issuecomment-144517292",
      "id" : 144517292,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6722",
      "updated_at" : "2015-09-30T19:40:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/144517292",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "body" : "Reorgs should probably be handled differently -- I don't think it makes sense for eviction to take place when calling `AcceptToMemoryPool()` from `DisconnectBlock()`; instead perhaps we can just let the mempool grow during a reorg and trim it down to size at the end?",
      "created_at" : "2015-10-01T00:19:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6722#issuecomment-144581220",
      "id" : 144581220,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6722",
      "updated_at" : "2015-10-01T00:19:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/144581220",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "Addressed a few nits...Things left to do:\r\n\r\n- [ ] Figure out the decay constant/drop min fee to 0 when it gets near 0 (if we decide to push forward with this tomorrow, we should discuss this value)\r\n- [x] Steal code from #6557 to use CalculateDescendants to make the TrimToSize code simpler\r\n- [ ] Write some basic sanity-check test cases",
      "created_at" : "2015-10-01T01:52:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6722#issuecomment-144593118",
      "id" : 144593118,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6722",
      "updated_at" : "2015-10-02T08:48:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/144593118",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Removed more than a third of the lines in TrimToSize and removed some other code in mempool sorting thanks to some suggestions from @morcos and @sdaftuar.",
      "created_at" : "2015-10-02T08:48:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6722#issuecomment-144961886",
      "id" : 144961886,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6722",
      "updated_at" : "2015-10-02T08:48:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/144961886",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "+1 on the half life suggestions.",
      "created_at" : "2015-10-02T13:57:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6722#issuecomment-145028966",
      "id" : 145028966,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6722",
      "updated_at" : "2015-10-02T13:57:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/145028966",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "body" : "OK, did even better and solved an edge case (thanks again to @sdaftuar for suggestions) by just adding the new tx to the mempool first, and then calling TrimToSize blind and checking if the tx is still in mempool afterwards.\r\n\r\nAlso reverted the mempool sorting change after discussion with @morcos on IRC - though it is a win in the \"optimize for maximum mempool feerate\" metric, it seems better to leave it as is because it may result in a larger ending mempool.",
      "created_at" : "2015-10-02T20:44:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6722#issuecomment-145150751",
      "id" : 145150751,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6722",
      "updated_at" : "2015-10-02T20:44:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/145150751",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Incorporated mempool expiry from @sipa, rebased and squashed. Should be reviewable/testable, but needs test cases.",
      "created_at" : "2015-10-02T21:52:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6722#issuecomment-145164748",
      "id" : 145164748,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6722",
      "updated_at" : "2015-10-02T21:52:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/145164748",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "It'd be good to add some design doc comments explaining the intent of this code. CTxMemPool::GetMinFee() especially is quite mysterious and full of magic constants right now, which is easier to understand when you read @sdaftuar's comments, but that's much harder to discover if you're starting from the source code.\r\n\r\nWe also should add a way to get the current minimum relay fee from the RPC interface, e.g. through getmempoolinfo",
      "created_at" : "2015-10-03T17:15:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6722#issuecomment-145269499",
      "id" : 145269499,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6722",
      "updated_at" : "2015-10-03T17:15:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/145269499",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "body" : "Code looks reasonable so far, though I haven't looked into it in enough detail to give a utACK just yet.",
      "created_at" : "2015-10-03T17:16:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6722#issuecomment-145269690",
      "id" : 145269690,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6722",
      "updated_at" : "2015-10-03T17:16:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/145269690",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "body" : "@TheBlueMatt I was just talking with @sdaftuar and now we think the max is required for the sort.  I know you reverted back to max, but I just wanted to memorialize that it is actually necessary.  Otherwise, it might possible to purposefully construct packages which will cause a parent to sort down and get evicted, allowing an attacker to control evicting a particular tx.",
      "created_at" : "2015-10-05T16:28:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6722#issuecomment-145591235",
      "id" : 145591235,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6722",
      "updated_at" : "2015-10-05T16:28:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/145591235",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   }
]
