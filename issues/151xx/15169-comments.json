[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#15921](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15921.html) (Tidy up ValidationState interface by jnewbery)\n* [#15891](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15891.html) (test: Require standard txs in regtest by default by MarcoFalke)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2019-01-15T07:00:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15169#issuecomment-454287296",
      "id" : 454287296,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15169",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ1NDI4NzI5Ng==",
      "updated_at" : "2019-05-08T20:47:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/454287296",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> we could relay transactions from a whitelisted peer that would cause us to be banned by an older peer\r\n\r\nThis seems bad.  The original motivation for making whitelist relay is long long long since dead (*).  Can we just eliminate this behaviour, as it makes whitelisting less useful and isn't useful itself?\r\n\r\nIf there is still any need for forced-relay transactions it could be accomplished by introducing a new P2P message that only whitelisted peers are allowed to use, that carries with it a TX whos relay is forced.\r\n\r\n(*) my recollection is that the original reason that behaviour was added was because people using armory would start armory and their bitcoin node at the same time, and their armory wallet would blast txn to send at bitcoind which would end up in its mempool but not relayed on the network because it had no actual peers up. ... then later attempts by armory to rebroadcast were ineffectual because the txn were already in the node's mempool.   However, because it causes all your peers to be flooded by txn relayed by your whitelisted neighbours it makes whitelisting useless outside of that armory usecase, unless you add the second option to force relay off. \r\n",
      "created_at" : "2019-01-15T20:34:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15169#issuecomment-454540989",
      "id" : 454540989,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15169",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ1NDU0MDk4OQ==",
      "updated_at" : "2019-01-15T20:34:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/454540989",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "On the overall change, sounds interesting but without benchmarks I dunno how exciting it is.  I guess I'm kinda surprised that there is a speedup at all considering that IBD doesn't seem to scale past 15/16 cores... which I'd assumed was due to synchronization overheads in the script validation thread dispatch.",
      "created_at" : "2019-01-15T20:35:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15169#issuecomment-454541281",
      "id" : 454541281,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15169",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ1NDU0MTI4MQ==",
      "updated_at" : "2019-01-15T20:35:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/454541281",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I would love to get rid of the whitelist relay behavior.  Any opinions about whether I should open a new PR for that, or just do it here?\r\n\r\nMy initial benchmark is on a very large transaction that has 640 P2PKH inputs, 2 outputs, and is policy-valid.  I compared this PR with master, and I tried this on two computers, a Power9 workstation (which doesn't have the SHA optimizations) and my laptop (a recent macbook pro).\r\n\r\nWith master (verification threads are unused in mempool acceptance):\r\n\r\n| Computer | Verification Threads | average scriptcheck time | average total atmp time|\r\n|-----------|---------------------|------------------|----------------|\r\n|power9|16|283.0ms|285.6ms|\r\n|macbook pro|8|176.7ms|178.5ms|\r\n\r\nThe \"scriptcheck time\" is a timing I added from just before the first call to CheckInputs(), to just after the second call.  (I compare with the total ATMP time to sanity check that this is a meaningful optimization.)\r\n\r\nWith this PR:\r\n\r\n| Computer | Verification Threads | average scriptcheck time | average total atmp time|\r\n|-----------|---------------------|------------------|----------------|\r\n|power9|16|35.7ms|38.2ms|\r\n|macbook pro|8|40.7ms|42.6ms|\r\n\r\nI'm actually somewhat more interested in benchmarking transactions that use maximal CPU resources but don't get into the mempool, since such transactions are costless for someone to generate (and because they're slower for us to process, at least in this PR as it stands) -- I will try to post those numbers later.  Also, if you have any suggestions for transactions that might be more costly to validate than what I've done so far, please let me know.\r\n",
      "created_at" : "2019-01-15T22:13:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15169#issuecomment-454572075",
      "id" : 454572075,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15169",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ1NDU3MjA3NQ==",
      "updated_at" : "2019-01-15T22:13:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/454572075",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "It would be nice to have the benchmark in master before the changes are made here so that it is easier to see how much each of the two commits change the performance.",
      "created_at" : "2019-01-15T22:29:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15169#issuecomment-454576869",
      "id" : 454576869,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15169",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ1NDU3Njg2OQ==",
      "updated_at" : "2019-01-15T22:29:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/454576869",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15169#discussion_r248093418"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15169"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/248093418"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Perhaps marginally less clear, but as follows, we skip the legacy input count if we don't have parallel threads & we abort the check as soon as we trigger the legacy count condition. \r\n\r\n```c++\r\n    bool parallel_verify = nScriptCheckThreads > 0;\r\n    size_t legacy_inputs_threshold = parallel_verify ? 15 : 0;\r\n    for (size_t i = 0; i < tx.vin.size() && legacy_input_threshold; i++) {\r\n        legacy_inputs_threshold -= tx.vin[i].scriptWitness.IsNull();\r\n    }\r\n    parallel_verify &= legacy_input_threshold == 0; \r\n```\r\n\r\n",
      "commit_id" : "f09e242618b0cfd677c8dc65b687ea75a6e877a2",
      "created_at" : "2019-01-15T22:49:23Z",
      "diff_hunk" : "@@ -1679,6 +1680,30 @@ void ThreadScriptCheck() {\n     scriptcheckqueue.Thread();\n }\n \n+bool RunCheckInputsMaybeParallel(const CTransaction& tx, CValidationState &state, const CCoinsViewCache &inputs, unsigned int flags, bool cacheSigStore, bool cacheFullScriptStore, PrecomputedTransactionData& txdata) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n+{\n+    size_t legacy_inputs = 0;\n+    for (size_t i = 0; i < tx.vin.size(); i++) {\n+        if (tx.vin[i].scriptWitness.IsNull()) {\n+            ++legacy_inputs;\n+        }\n+    }\n+    bool parallel_verify = false;\n+    if (legacy_inputs >= 15 && nScriptCheckThreads) {\n+        parallel_verify = true;\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15169#discussion_r248093418",
      "id" : 248093418,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI0ODA5MzQxOA==",
      "original_commit_id" : "8cd9e2f0a0ee927b648c3ac72913da41c33562f0",
      "original_position" : 52,
      "path" : "src/validation.cpp",
      "position" : 106,
      "pull_request_review_id" : 192903141,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15169",
      "updated_at" : "2019-05-07T17:41:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/248093418",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@sdaftuar on forced relay, I think a PR that defaulted it to off could just be open separately and make it in faster than this work... and this would could continue assuming that issue is resolved elsewhere.",
      "created_at" : "2019-01-16T01:38:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15169#issuecomment-454618309",
      "id" : 454618309,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15169",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ1NDYxODMwOQ==",
      "updated_at" : "2019-01-16T01:38:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/454618309",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2019-01-24T15:15:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15169#issuecomment-457233146",
      "id" : 457233146,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15169",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ1NzIzMzE0Ng==",
      "updated_at" : "2019-01-24T15:15:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/457233146",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   }
]
