[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/7946#discussion_r61073359"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/7946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/61073359"
         }
      },
      "body" : "This is not correct, it needs to iterate through all the blocks that got connected, not just the new tip.",
      "commit_id" : "e8ea3dd5ea65239b2cafff8db1b2d1a8e5ebb963",
      "created_at" : "2016-04-26T12:05:52Z",
      "diff_hunk" : "@@ -2914,13 +2905,23 @@ bool ActivateBestChain(CValidationState &state, const CChainParams& chainparams,\n             if (pindexMostWork == NULL || pindexMostWork == chainActive.Tip())\n                 return true;\n \n-            if (!ActivateBestChainStep(state, chainparams, pindexMostWork, pblock && pblock->GetHash() == pindexMostWork->GetBlockHash() ? pblock : NULL))\n+            if (!ActivateBestChainStep(state, chainparams, pindexMostWork, pblock && pblock->GetHash() == pindexMostWork->GetBlockHash() ? pblock : NULL, txConflicted))\n                 return false;\n \n             pindexNewTip = chainActive.Tip();\n             pindexFork = chainActive.FindFork(pindexOldTip);\n             fInitialDownload = IsInitialBlockDownload();\n         }\n+        // throw all transaction though the signal-interface\n+        // while _not_ holding the cs_main lock\n+        BOOST_FOREACH(const CTransaction &tx, txConflicted) {\n+            SyncWithWallets(tx, pindexNewTip, NULL);\n+        }\n+        // ... and about transactions that got confirmed:\n+        BOOST_FOREACH(const CTransaction &tx, pblock->vtx) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7946#discussion_r61073359",
      "id" : 61073359,
      "original_commit_id" : "480ed4f30f311610b1c91fe8222e3ba4cc717de7",
      "original_position" : 73,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/7946",
      "updated_at" : "2016-05-06T09:47:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/61073359",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "As always when you want to improve the locking a little bit, the change gets quickly more invasive.\r\n\r\nUpdate serval things:\r\n* Fixed @sipa point (iterate though all connected blocks).\r\n* Removed the `CBlock *` parameter from the `SyncTransaction` signal and added `CBlockIndex*` together with `int posInBlock`.\r\n* Updated the wallet logic that it can handle the slightly different signal.",
      "created_at" : "2016-04-26T13:42:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7946#issuecomment-214749314",
      "id" : 214749314,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7946",
      "updated_at" : "2016-04-26T13:42:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/214749314",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "ActivateBestChainStep reuses a vector for ConnectTip's txConflicted to combine results from multiple blocks. ConnectTip passes txConflicted to mempoool.removeForBlock every time.",
      "created_at" : "2016-04-27T14:17:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7946#issuecomment-215098004",
      "id" : 215098004,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7946",
      "updated_at" : "2016-04-27T14:17:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/215098004",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1047859?v=3",
         "events_url" : "https://api.github.com/users/kazcw/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kazcw/followers",
         "following_url" : "https://api.github.com/users/kazcw/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kazcw/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kazcw",
         "id" : 1047859,
         "login" : "kazcw",
         "organizations_url" : "https://api.github.com/users/kazcw/orgs",
         "received_events_url" : "https://api.github.com/users/kazcw/received_events",
         "repos_url" : "https://api.github.com/users/kazcw/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kazcw/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kazcw/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kazcw"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/7946#discussion_r61265115"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/7946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/61265115"
         }
      },
      "body" : "Could put the new loops below this comment with the other non-cs_main notifications",
      "commit_id" : "e8ea3dd5ea65239b2cafff8db1b2d1a8e5ebb963",
      "created_at" : "2016-04-27T14:19:52Z",
      "diff_hunk" : "@@ -2914,13 +2910,21 @@ bool ActivateBestChain(CValidationState &state, const CChainParams& chainparams,\n             if (pindexMostWork == NULL || pindexMostWork == chainActive.Tip())\n                 return true;\n \n-            if (!ActivateBestChainStep(state, chainparams, pindexMostWork, pblock && pblock->GetHash() == pindexMostWork->GetBlockHash() ? pblock : NULL))\n+            if (!ActivateBestChainStep(state, chainparams, pindexMostWork, pblock && pblock->GetHash() == pindexMostWork->GetBlockHash() ? pblock : NULL, txConflicted, txChanged))\n                 return false;\n \n             pindexNewTip = chainActive.Tip();\n             pindexFork = chainActive.FindFork(pindexOldTip);\n             fInitialDownload = IsInitialBlockDownload();\n         }\n+        // throw all transactions though the signal-interface\n+        // while _not_ holding the cs_main lock\n+        BOOST_FOREACH(const CTransaction &tx, txConflicted)\n+            SyncWithWallets(tx, pindexNewTip);\n+        // ... and about transactions that got confirmed:\n+        for(unsigned int i = 0; i < txChanged.size(); i++)\n+            SyncWithWallets(txChanged[i].get<0>(), txChanged[i].get<1>(), txChanged[i].get<2>());\n+\n         // When we reach this point, we switched to a new tip (stored in pindexNewTip).\n \n         // Notifications/callbacks that can run without cs_main",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7946#discussion_r61265115",
      "id" : 61265115,
      "original_commit_id" : "086654e4fd2ab2fa0d6121c18bdcf53a587bd3c4",
      "original_position" : 107,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/7946",
      "updated_at" : "2016-05-06T09:47:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/61265115",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1047859?v=3",
         "events_url" : "https://api.github.com/users/kazcw/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kazcw/followers",
         "following_url" : "https://api.github.com/users/kazcw/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kazcw/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kazcw",
         "id" : 1047859,
         "login" : "kazcw",
         "organizations_url" : "https://api.github.com/users/kazcw/orgs",
         "received_events_url" : "https://api.github.com/users/kazcw/received_events",
         "repos_url" : "https://api.github.com/users/kazcw/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kazcw/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kazcw/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kazcw"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/7946#discussion_r61267490"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/7946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/61267490"
         }
      },
      "body" : "Why not just change this loop to be numeric and then use the `i`?",
      "commit_id" : "e8ea3dd5ea65239b2cafff8db1b2d1a8e5ebb963",
      "created_at" : "2016-04-27T14:33:08Z",
      "diff_hunk" : "@@ -1224,7 +1224,14 @@ int CWallet::ScanForWalletTransactions(CBlockIndex* pindexStart, bool fUpdate)\n             ReadBlockFromDisk(block, pindex, Params().GetConsensus());\n             BOOST_FOREACH(CTransaction& tx, block.vtx)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7946#discussion_r61267490",
      "id" : 61267490,
      "original_commit_id" : "086654e4fd2ab2fa0d6121c18bdcf53a587bd3c4",
      "original_position" : 50,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/7946",
      "updated_at" : "2016-05-06T09:47:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/61267490",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1047859?v=3",
         "events_url" : "https://api.github.com/users/kazcw/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kazcw/followers",
         "following_url" : "https://api.github.com/users/kazcw/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kazcw/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kazcw",
         "id" : 1047859,
         "login" : "kazcw",
         "organizations_url" : "https://api.github.com/users/kazcw/orgs",
         "received_events_url" : "https://api.github.com/users/kazcw/received_events",
         "repos_url" : "https://api.github.com/users/kazcw/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kazcw/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kazcw/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kazcw"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/7946#discussion_r61269025"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/7946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/61269025"
         }
      },
      "body" : "Could remove the null-check; pindex has already been dereferenced",
      "commit_id" : "e8ea3dd5ea65239b2cafff8db1b2d1a8e5ebb963",
      "created_at" : "2016-04-27T14:39:01Z",
      "diff_hunk" : "@@ -3276,30 +3283,18 @@ CWalletKey::CWalletKey(int64_t nExpires)\n     nTimeExpires = nExpires;\n }\n \n-int CMerkleTx::SetMerkleBranch(const CBlock& block)\n+int CMerkleTx::SetMerkleBranch(const CBlockIndex* pindex, int posInBlock)\n {\n     AssertLockHeld(cs_main);\n     CBlock blockTmp;\n \n     // Update the tx's hashBlock\n-    hashBlock = block.GetHash();\n+    hashBlock = pindex->GetBlockHash();\n \n-    // Locate the transaction\n-    for (nIndex = 0; nIndex < (int)block.vtx.size(); nIndex++)\n-        if (block.vtx[nIndex] == *(CTransaction*)this)\n-            break;\n-    if (nIndex == (int)block.vtx.size())\n-    {\n-        nIndex = -1;\n-        LogPrintf(\"ERROR: SetMerkleBranch(): couldn't find tx in block\\n\");\n-        return 0;\n-    }\n+    // set the position of the transaction in the block\n+    nIndex = posInBlock;\n \n     // Is the tx in a block that's in the main chain\n-    BlockMap::iterator mi = mapBlockIndex.find(hashBlock);\n-    if (mi == mapBlockIndex.end())\n-        return 0;\n-    const CBlockIndex* pindex = (*mi).second;\n     if (!pindex || !chainActive.Contains(pindex))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7946#discussion_r61269025",
      "id" : 61269025,
      "original_commit_id" : "086654e4fd2ab2fa0d6121c18bdcf53a587bd3c4",
      "original_position" : 96,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/7946",
      "updated_at" : "2016-05-06T09:47:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/61269025",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1047859?v=3",
         "events_url" : "https://api.github.com/users/kazcw/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kazcw/followers",
         "following_url" : "https://api.github.com/users/kazcw/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kazcw/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kazcw",
         "id" : 1047859,
         "login" : "kazcw",
         "organizations_url" : "https://api.github.com/users/kazcw/orgs",
         "received_events_url" : "https://api.github.com/users/kazcw/received_events",
         "repos_url" : "https://api.github.com/users/kazcw/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kazcw/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kazcw/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kazcw"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/7946#discussion_r62308291"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/7946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/62308291"
         }
      },
      "body" : "Right. This loop is stupid at this point. The transaction always have a `posInBlock`. Will update.",
      "commit_id" : "e8ea3dd5ea65239b2cafff8db1b2d1a8e5ebb963",
      "created_at" : "2016-05-06T09:40:00Z",
      "diff_hunk" : "@@ -1224,7 +1224,14 @@ int CWallet::ScanForWalletTransactions(CBlockIndex* pindexStart, bool fUpdate)\n             ReadBlockFromDisk(block, pindex, Params().GetConsensus());\n             BOOST_FOREACH(CTransaction& tx, block.vtx)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7946#discussion_r62308291",
      "id" : 62308291,
      "original_commit_id" : "086654e4fd2ab2fa0d6121c18bdcf53a587bd3c4",
      "original_position" : 50,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/7946",
      "updated_at" : "2016-05-06T09:47:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/62308291",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "@kazcw Thanks for the detailed code review!\r\n\r\nAdded a squashme commit with fixed for issues found by @kazcw.",
      "created_at" : "2016-05-06T09:48:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7946#issuecomment-217399685",
      "id" : 217399685,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7946",
      "updated_at" : "2016-05-06T09:48:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/217399685",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "You know what, I misread. `txConflicted` is an out-only parameter all the way down the call stack, so it was fine without the `txConflictedCurrent`. Sorry about that.",
      "created_at" : "2016-05-06T13:57:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7946#issuecomment-217447475",
      "id" : 217447475,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7946",
      "updated_at" : "2016-05-06T13:57:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/217447475",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1047859?v=3",
         "events_url" : "https://api.github.com/users/kazcw/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kazcw/followers",
         "following_url" : "https://api.github.com/users/kazcw/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kazcw/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kazcw",
         "id" : 1047859,
         "login" : "kazcw",
         "organizations_url" : "https://api.github.com/users/kazcw/orgs",
         "received_events_url" : "https://api.github.com/users/kazcw/received_events",
         "repos_url" : "https://api.github.com/users/kazcw/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kazcw/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kazcw/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kazcw"
      }
   }
]
