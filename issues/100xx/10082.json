{
   "assignee" : null,
   "assignees" : [],
   "body" : "This PR adds a TestNode class to the test_framework.py module. The goals for this are twofold:\r\n\r\n1. Remove global state from utils.py\r\n\r\nThere are currently several global state variables in utils.py (COVERAGE_DIR, PortSeed and bitcoind_processes). Having global state variables in the utils module is bad practice and makes importing from utils quite brittle.\r\n\r\n2. Present a cleaner interface to the test writer\r\n\r\nTo create a node with an RPC and a P2P connection, the test writer currently needs to write something like this:\r\n\r\n```python\r\n        self.nodes = []\r\n        self.nodes.append(start_node(0, self.options.tmpdir))\r\n        node0 = SingleNodeConnCB()\r\n        connections = []\r\n        connections.append(NodeConn('127.0.0.1', p2p_port(0), self.nodes[0], node0))\r\n        node0.add_connection(connections[0])\r\n```\r\n\r\nThat places a lot of burden on the test writer to use arguments like `self.options.tmpdir` and `p2p_port(0)` which he/she shouldn't really need to know about. It'd be far better if the test writer could just call up a TestNode instance which would take care of state, process tracking, RPC connections and P2P connections.\r\n\r\nThis PR puts global state, process tracking and RPC connections in the TestNode class. A future PR can add P2P connections to the TestNode class.\r\n\r\nThe final commit also makes `start_nodes()` and `stop_nodes()` start and stop the nodes in parallel. This speeds up test execution by around 20%.\r\n\r\nTravis run with this PR: https://travis-ci.org/jnewbery/bitcoin/jobs/215105506\r\n```\r\nTEST                           | PASSED | DURATION\r\nfundrawtransaction.py          | True   | 33 s\r\nwallet-hd.py                   | True   | 46 s\r\nsegwit.py                      | True   | 31 s\r\nwalletbackup.py                | True   | 117 s\r\np2p-compactblocks.py           | True   | 84 s\r\nwallet.py                      | True   | 46 s\r\nwallet-accounts.py             | True   | 9 s\r\nwallet-dump.py                 | True   | 11 s\r\nlisttransactions.py            | True   | 35 s\r\nsendheaders.py                 | True   | 28 s\r\nimportmulti.py                 | True   | 11 s\r\nzapwallettxes.py               | True   | 15 s\r\nmerkle_blocks.py               | True   | 6 s\r\nmempool_limit.py               | True   | 14 s\r\nabandonconflict.py             | True   | 15 s\r\nreceivedby.py                  | True   | 21 s\r\nrawtransactions.py             | True   | 16 s\r\nreindex.py                     | True   | 14 s\r\nbip68-112-113-p2p.py           | True   | 31 s\r\nmempool_resurrect_test.py      | True   | 3 s\r\np2p-segwit.py                  | True   | 123 s\r\ntxn_doublespend.py --mineblock | True   | 6 s\r\ntxn_clone.py                   | True   | 5 s\r\nmempool_spendcoinbase.py       | True   | 3 s\r\nrest.py                        | True   | 9 s\r\ngetchaintips.py                | True   | 12 s\r\nhttpbasics.py                  | True   | 3 s\r\nmulti_rpc.py                   | True   | 3 s\r\nmempool_reorg.py               | True   | 11 s\r\nproxy_test.py                  | True   | 5 s\r\nsignrawtransactions.py         | True   | 3 s\r\ndecodescript.py                | True   | 3 s\r\nblockchain.py                  | True   | 4 s\r\ndisablewallet.py               | True   | 2 s\r\np2p-mempool.py                 | True   | 3 s\r\nkeypool.py                     | True   | 7 s\r\nnodehandling.py                | True   | 14 s\r\ninvalidblockrequest.py         | True   | 5 s\r\ninvalidtxrequest.py            | True   | 4 s\r\nprioritise_transaction.py      | True   | 11 s\r\npreciousblock.py               | True   | 5 s\r\nimportprunedfunds.py           | True   | 4 s\r\nsignmessages.py                | True   | 3 s\r\np2p-versionbits-warning.py     | True   | 13 s\r\nnulldummy.py                   | True   | 6 s\r\nrpcnamedargs.py                | True   | 3 s\r\nimport-rescan.py               | True   | 9 s\r\np2p-fullblocktest.py           | True   | 296 s\r\nzmq_test.py                    | True   | 4 s\r\np2p-leaktests.py               | True   | 8 s\r\nbumpfee.py                     | True   | 15 s\r\nlistsinceblock.py              | True   | 12 s\r\nALL                            | True   | 1200 s (accumulated)\r\n\r\nRuntime: 305 s\r\n```\r\n\r\nWithout this PR: https://travis-ci.org/bitcoin/bitcoin/jobs/214988556\r\n```\r\nTEST                           | STATUS  | DURATION\r\nfundrawtransaction.py          | Passed  | 39 s\r\nwallet-hd.py                   | Passed  | 51 s\r\nsegwit.py                      | Passed  | 38 s\r\np2p-compactblocks.py           | Passed  | 91 s\r\nwallet-accounts.py             | Passed  | 9 s\r\nwalletbackup.py                | Passed  | 157 s\r\nwallet-dump.py                 | Passed  | 9 s\r\nwallet.py                      | Passed  | 88 s\r\nlisttransactions.py            | Passed  | 36 s\r\nsendheaders.py                 | Passed  | 31 s\r\nzapwallettxes.py               | Passed  | 17 s\r\nimportmulti.py                 | Passed  | 17 s\r\nmempool_limit.py               | Passed  | 12 s\r\nmerkle_blocks.py               | Passed  | 14 s\r\nabandonconflict.py             | Passed  | 20 s\r\nreceivedby.py                  | Passed  | 34 s\r\np2p-segwit.py                  | Passed  | 134 s\r\nreindex.py                     | Passed  | 13 s\r\nrawtransactions.py             | Passed  | 23 s\r\nbip68-112-113-p2p.py           | Passed  | 30 s\r\nmempool_resurrect_test.py      | Passed  | 3 s\r\ntxn_doublespend.py --mineblock | Passed  | 14 s\r\ntxn_clone.py                   | Passed  | 14 s\r\np2p-fullblocktest.py           | Passed  | 306 s\r\nmempool_spendcoinbase.py       | Passed  | 3 s\r\nhttpbasics.py                  | Passed  | 8 s\r\nrest.py                        | Passed  | 14 s\r\nmulti_rpc.py                   | Passed  | 4 s\r\nmempool_reorg.py               | Passed  | 15 s\r\nsignrawtransactions.py         | Passed  | 3 s\r\ngetchaintips.py                | Passed  | 34 s\r\ndecodescript.py                | Passed  | 3 s\r\ndisablewallet.py               | Passed  | 2 s\r\nproxy_test.py                  | Passed  | 12 s\r\nblockchain.py                  | Passed  | 5 s\r\np2p-mempool.py                 | Passed  | 3 s\r\nkeypool.py                     | Passed  | 7 s\r\ninvalidblockrequest.py         | Passed  | 4 s\r\ninvalidtxrequest.py            | Passed  | 4 s\r\nnodehandling.py                | Passed  | 21 s\r\nprioritise_transaction.py      | Passed  | 12 s\r\nsignmessages.py                | Passed  | 3 s\r\np2p-versionbits-warning.py     | Passed  | 11 s\r\nimportprunedfunds.py           | Passed  | 6 s\r\npreciousblock.py               | Passed  | 9 s\r\nnulldummy.py                   | Passed  | 4 s\r\nrpcnamedargs.py                | Passed  | 3 s\r\np2p-leaktests.py               | Passed  | 9 s\r\nbumpfee.py                     | Passed  | 14 s\r\nimport-rescan.py               | Passed  | 21 s\r\nzmq_test.py                    | Passed  | 20 s\r\nlistsinceblock.py              | Passed  | 34 s\r\nALL                            | True    | 1488 s (accumulated)\r\n\r\nRuntime: 385 s\r\n```\r\n\r\nThis PR is a very large changeset. However, I've tried to break it down into digestible commits, each of which moves towards the final goal. If reviewers are only able to review a subset of the commits, I'm happy to break this PR into smaller parts.",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 0,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10082/comments",
   "created_at" : "2017-03-26T04:53:39Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10082/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/10082",
   "id" : 217027444,
   "labels" : [],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10082/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "number" : 10082,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/10082.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10082",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/10082.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10082"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "title" : "[tests] Add a TestNode class to test_Framework.py",
   "updated_at" : "2017-03-26T04:53:39Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10082",
   "user" : {
      "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
      "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
      "followers_url" : "https://api.github.com/users/jnewbery/followers",
      "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/jnewbery",
      "id" : 1063656,
      "login" : "jnewbery",
      "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
      "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
      "repos_url" : "https://api.github.com/users/jnewbery/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/jnewbery"
   }
}
