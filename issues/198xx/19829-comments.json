[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #19910 (net processing: Move peer_map to PeerManager by jnewbery)\n* #19776 (net, rpc: expose high bandwidth mode state via getpeerinfo by theStack)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-08-28T21:21:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-683152078",
      "id" : 683152078,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4MzE1MjA3OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-18T13:21:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/683152078",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r479586353"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479586353"
         }
      },
      "author_association" : "MEMBER",
      "body" : "\"Discovered at version message exchange. Used at tip update, to decide if our chain is fresh enough compared to peer's one to be worthy of headers announcement.\" ?",
      "commit_id" : "a70f328879350558cf2b225b22a4acf69e623c63",
      "created_at" : "2020-08-29T00:49:49Z",
      "diff_hunk" : "@@ -488,6 +488,9 @@ struct Peer {\n     /** Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission). */\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n+    /** Starting height of this peer */\n+    std::atomic<int> nStartingHeight{-1};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r479586353",
      "id" : 479586353,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU4NjM1Mw==",
      "original_commit_id" : "cc2c15fd73979e60e63526cc071c1fd025c3a7e3",
      "original_line" : 492,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 478083375,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-01T10:53:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479586353",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r479588290"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479588290"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What's the distinction you loose by dropping `unfiltered blocks to relay` ?\r\n\r\nI guess this is a reference to sort done at headers announcement, L4218 src/net_processing.cpp:\r\nhttps://github.com/bitcoin/bitcoin/blob/1cf73fb8eba3b89a30d5e943deaec5052a8b21b7/src/net_processing.cpp#L4218\r\n\r\nBefore to announce headers, we check both with regards to peer's context (\"Does this header connect to known peer's tip ?\") and our context (\"Does this header is part of best chain ?\"). It wasn't a clear comment, so yes either drop it or extend ?",
      "commit_id" : "a70f328879350558cf2b225b22a4acf69e623c63",
      "created_at" : "2020-08-29T01:06:25Z",
      "diff_hunk" : "@@ -928,9 +922,6 @@ class CNode\n     // m_tx_relay == nullptr if we're not relaying transactions with this peer\n     std::unique_ptr<TxRelay> m_tx_relay;\n \n-    // Used for headers announcements - unfiltered blocks to relay",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r479588290",
      "id" : 479588290,
      "line" : 989,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU4ODI5MA==",
      "original_commit_id" : "3ee51652e93fc41c750713070200f98014d64bf3",
      "original_line" : 989,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 36,
      "pull_request_review_id" : 478083375,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-01T10:53:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479588290",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r479590868"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479590868"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`vBlockHashesToAnnounce` is a list of block hashes not headers ? With regards to renaming follow-up commit, I would lean towards the most verbose option `m_blockids_for_inv_relay/m_blockids_for_headers_relay` to denotate that these vectors contain an identifier even if the endgoal is to relay the identifiee (either block or headers).",
      "commit_id" : "a70f328879350558cf2b225b22a4acf69e623c63",
      "created_at" : "2020-08-29T01:30:53Z",
      "diff_hunk" : "@@ -488,6 +488,14 @@ struct Peer {\n     /** Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission). */\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n+    /** Protects block inventory data members */\n+    RecursiveMutex m_block_inv_mutex;\n+    /** List of block ids we still have announce.\n+     * There is no final sorting before sending, as they are always sent\n+     * immediately and in the order requested. */\n+    std::vector<uint256> vInventoryBlockToSend GUARDED_BY(m_block_inv_mutex);\n+    /** List of headers to relay */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r479590868",
      "id" : 479590868,
      "line" : 497,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU5MDg2OA==",
      "original_commit_id" : "3ee51652e93fc41c750713070200f98014d64bf3",
      "original_line" : 497,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 10,
      "pull_request_review_id" : 478083375,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-01T10:53:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479590868",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r479628361"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479628361"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The comment doesn't need to document _everything_ that the variable is used for. That's what the code does.",
      "commit_id" : "a70f328879350558cf2b225b22a4acf69e623c63",
      "created_at" : "2020-08-29T09:02:28Z",
      "diff_hunk" : "@@ -488,6 +488,9 @@ struct Peer {\n     /** Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission). */\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n+    /** Starting height of this peer */\n+    std::atomic<int> nStartingHeight{-1};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r479628361",
      "id" : 479628361,
      "in_reply_to_id" : 479586353,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTYyODM2MQ==",
      "original_commit_id" : "cc2c15fd73979e60e63526cc071c1fd025c3a7e3",
      "original_line" : 492,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 478112685,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-01T10:53:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479628361",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r479629760"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479629760"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ok, I'll update the comment to \"List of block ids to announce headers for\".\r\n\r\n> I would lean towards the most verbose option m_blockids_for_inv_relay/m_blockids_for_headers_relay\r\n\r\nSure. I'll update.",
      "commit_id" : "a70f328879350558cf2b225b22a4acf69e623c63",
      "created_at" : "2020-08-29T09:19:00Z",
      "diff_hunk" : "@@ -488,6 +488,14 @@ struct Peer {\n     /** Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission). */\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n+    /** Protects block inventory data members */\n+    RecursiveMutex m_block_inv_mutex;\n+    /** List of block ids we still have announce.\n+     * There is no final sorting before sending, as they are always sent\n+     * immediately and in the order requested. */\n+    std::vector<uint256> vInventoryBlockToSend GUARDED_BY(m_block_inv_mutex);\n+    /** List of headers to relay */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r479629760",
      "id" : 479629760,
      "in_reply_to_id" : 479590868,
      "line" : 497,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTYyOTc2MA==",
      "original_commit_id" : "3ee51652e93fc41c750713070200f98014d64bf3",
      "original_line" : 497,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 10,
      "pull_request_review_id" : 478113517,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-01T10:53:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479629760",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r479629856"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479629856"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think drop it.",
      "commit_id" : "a70f328879350558cf2b225b22a4acf69e623c63",
      "created_at" : "2020-08-29T09:20:07Z",
      "diff_hunk" : "@@ -928,9 +922,6 @@ class CNode\n     // m_tx_relay == nullptr if we're not relaying transactions with this peer\n     std::unique_ptr<TxRelay> m_tx_relay;\n \n-    // Used for headers announcements - unfiltered blocks to relay",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r479629856",
      "id" : 479629856,
      "in_reply_to_id" : 479588290,
      "line" : 989,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTYyOTg1Ng==",
      "original_commit_id" : "3ee51652e93fc41c750713070200f98014d64bf3",
      "original_line" : 989,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 36,
      "pull_request_review_id" : 478113570,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-01T10:53:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479629856",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review @ariard . I've addressed your comments.",
      "created_at" : "2020-08-29T09:27:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-683264367",
      "id" : 683264367,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4MzI2NDM2Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-29T09:27:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/683264367",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-09-02T14:27:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-685773362",
      "id" : 685773362,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4NTc3MzM2Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-02T14:27:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/685773362",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased",
      "created_at" : "2020-09-02T15:26:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-685811311",
      "id" : 685811311,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4NTgxMTMxMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-02T15:26:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/685811311",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2020-09-02T15:34:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-685817072",
      "id" : 685817072,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4NTgxNzA3Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-02T15:34:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/685817072",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-09-03T13:20:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-686485715",
      "id" : 686485715,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4NjQ4NTcxNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-03T13:20:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/686485715",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "rebased",
      "created_at" : "2020-09-03T15:56:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-686588115",
      "id" : 686588115,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4NjU4ODExNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-03T15:56:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/686588115",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.",
      "created_at" : "2020-09-05T07:06:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-687563790",
      "id" : 687563790,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4NzU2Mzc5MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-05T07:06:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/687563790",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r483928636"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483928636"
         }
      },
      "author_association" : "MEMBER",
      "body" : "e04fb9a2df9f4d77c587bd25c608ce806c97ea45\r\nCould using of `RecursiveMutex` type be avoided?\r\n(as there was `Mutex cs_inventory;`)",
      "commit_id" : "a70f328879350558cf2b225b22a4acf69e623c63",
      "created_at" : "2020-09-05T08:46:00Z",
      "diff_hunk" : "@@ -488,6 +488,14 @@ struct Peer {\n     /** Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission). */\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n+    /** Protects block inventory data members */\n+    RecursiveMutex m_block_inv_mutex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r483928636",
      "id" : 483928636,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzkyODYzNg==",
      "original_commit_id" : "e04fb9a2df9f4d77c587bd25c608ce806c97ea45",
      "original_line" : 492,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 483041519,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-01T10:53:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483928636",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r483929087"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483929087"
         }
      },
      "author_association" : "MEMBER",
      "body" : "575c5f55cc44348f0ebc7740c90013b96bdb8c27\r\nIt is good for concurrency to limit the lock scope. But is it safe to call `func` on potentially stale `peer_copies`?",
      "commit_id" : "a70f328879350558cf2b225b22a4acf69e623c63",
      "created_at" : "2020-09-05T08:51:13Z",
      "diff_hunk" : "@@ -505,6 +505,24 @@ using PeerRef = std::shared_ptr<Peer>;\n Mutex g_peer_mutex;\n static std::map<NodeId, PeerRef> g_peer_map GUARDED_BY(g_peer_mutex);\n \n+/** Get a reference to each Peer, then call a function on each of them */\n+template<typename Callable>\n+void ForEachPeer(Callable&& func)\n+{\n+    std::vector<PeerRef> peer_copies;\n+    {\n+        LOCK(g_peer_mutex);\n+        peer_copies.reserve(g_peer_map.size());\n+        for (auto peer : g_peer_map) {\n+            peer_copies.push_back(peer.second);\n+        }\n+    }\n+\n+    for (auto&& peer : peer_copies) {\n+        func(peer);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r483929087",
      "id" : 483929087,
      "line" : 536,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzkyOTA4Nw==",
      "original_commit_id" : "575c5f55cc44348f0ebc7740c90013b96bdb8c27",
      "original_line" : 536,
      "original_position" : 18,
      "original_start_line" : 512,
      "path" : "src/net_processing.cpp",
      "position" : 42,
      "pull_request_review_id" : 483041519,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : 526,
      "start_side" : "RIGHT",
      "updated_at" : "2020-10-01T10:53:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483929087",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r483933383"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483933383"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good catch! `cs_inventory` was a RecursiveMutex when I opened this PR, and I missed the change when I rebased. Fixed.",
      "commit_id" : "a70f328879350558cf2b225b22a4acf69e623c63",
      "created_at" : "2020-09-05T09:41:20Z",
      "diff_hunk" : "@@ -488,6 +488,14 @@ struct Peer {\n     /** Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission). */\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n+    /** Protects block inventory data members */\n+    RecursiveMutex m_block_inv_mutex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r483933383",
      "id" : 483933383,
      "in_reply_to_id" : 483928636,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzkzMzM4Mw==",
      "original_commit_id" : "e04fb9a2df9f4d77c587bd25c608ce806c97ea45",
      "original_line" : 492,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 483044394,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-01T10:53:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483933383",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r483933457"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483933457"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes. `peer_copies` holds shared_ptr references, so the objects pointed to can't be destructed while it's in scope.",
      "commit_id" : "a70f328879350558cf2b225b22a4acf69e623c63",
      "created_at" : "2020-09-05T09:42:16Z",
      "diff_hunk" : "@@ -505,6 +505,24 @@ using PeerRef = std::shared_ptr<Peer>;\n Mutex g_peer_mutex;\n static std::map<NodeId, PeerRef> g_peer_map GUARDED_BY(g_peer_mutex);\n \n+/** Get a reference to each Peer, then call a function on each of them */\n+template<typename Callable>\n+void ForEachPeer(Callable&& func)\n+{\n+    std::vector<PeerRef> peer_copies;\n+    {\n+        LOCK(g_peer_mutex);\n+        peer_copies.reserve(g_peer_map.size());\n+        for (auto peer : g_peer_map) {\n+            peer_copies.push_back(peer.second);\n+        }\n+    }\n+\n+    for (auto&& peer : peer_copies) {\n+        func(peer);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r483933457",
      "id" : 483933457,
      "in_reply_to_id" : 483929087,
      "line" : 536,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzkzMzQ1Nw==",
      "original_commit_id" : "575c5f55cc44348f0ebc7740c90013b96bdb8c27",
      "original_line" : 536,
      "original_position" : 18,
      "original_start_line" : 512,
      "path" : "src/net_processing.cpp",
      "position" : 42,
      "pull_request_review_id" : 483044446,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : 526,
      "start_side" : "RIGHT",
      "updated_at" : "2020-10-01T10:53:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483933457",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review @hebasto . I've addressed both of your comments.",
      "created_at" : "2020-09-05T09:42:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-687580549",
      "id" : 687580549,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4NzU4MDU0OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-05T09:42:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/687580549",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r483933970"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483933970"
         }
      },
      "author_association" : "MEMBER",
      "body" : "#19347 is yours, btw :)",
      "commit_id" : "a70f328879350558cf2b225b22a4acf69e623c63",
      "created_at" : "2020-09-05T09:48:56Z",
      "diff_hunk" : "@@ -488,6 +488,14 @@ struct Peer {\n     /** Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission). */\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n+    /** Protects block inventory data members */\n+    RecursiveMutex m_block_inv_mutex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r483933970",
      "id" : 483933970,
      "in_reply_to_id" : 483928636,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzkzMzk3MA==",
      "original_commit_id" : "e04fb9a2df9f4d77c587bd25c608ce806c97ea45",
      "original_line" : 492,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 483044795,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-01T10:53:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483933970",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r483934204"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483934204"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I mean not language safety rather client behavior safety: if another thread removes a `peer` from the `g_peer_map`, can we rely on result of `func(peer)`?",
      "commit_id" : "a70f328879350558cf2b225b22a4acf69e623c63",
      "created_at" : "2020-09-05T09:51:52Z",
      "diff_hunk" : "@@ -505,6 +505,24 @@ using PeerRef = std::shared_ptr<Peer>;\n Mutex g_peer_mutex;\n static std::map<NodeId, PeerRef> g_peer_map GUARDED_BY(g_peer_mutex);\n \n+/** Get a reference to each Peer, then call a function on each of them */\n+template<typename Callable>\n+void ForEachPeer(Callable&& func)\n+{\n+    std::vector<PeerRef> peer_copies;\n+    {\n+        LOCK(g_peer_mutex);\n+        peer_copies.reserve(g_peer_map.size());\n+        for (auto peer : g_peer_map) {\n+            peer_copies.push_back(peer.second);\n+        }\n+    }\n+\n+    for (auto&& peer : peer_copies) {\n+        func(peer);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r483934204",
      "id" : 483934204,
      "in_reply_to_id" : 483929087,
      "line" : 536,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzkzNDIwNA==",
      "original_commit_id" : "575c5f55cc44348f0ebc7740c90013b96bdb8c27",
      "original_line" : 536,
      "original_position" : 18,
      "original_start_line" : 512,
      "path" : "src/net_processing.cpp",
      "position" : 42,
      "pull_request_review_id" : 483044925,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : 526,
      "start_side" : "RIGHT",
      "updated_at" : "2020-10-01T10:53:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483934204",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r483935273"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483935273"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, because peer still exists in that case.",
      "commit_id" : "a70f328879350558cf2b225b22a4acf69e623c63",
      "created_at" : "2020-09-05T10:05:20Z",
      "diff_hunk" : "@@ -505,6 +505,24 @@ using PeerRef = std::shared_ptr<Peer>;\n Mutex g_peer_mutex;\n static std::map<NodeId, PeerRef> g_peer_map GUARDED_BY(g_peer_mutex);\n \n+/** Get a reference to each Peer, then call a function on each of them */\n+template<typename Callable>\n+void ForEachPeer(Callable&& func)\n+{\n+    std::vector<PeerRef> peer_copies;\n+    {\n+        LOCK(g_peer_mutex);\n+        peer_copies.reserve(g_peer_map.size());\n+        for (auto peer : g_peer_map) {\n+            peer_copies.push_back(peer.second);\n+        }\n+    }\n+\n+    for (auto&& peer : peer_copies) {\n+        func(peer);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r483935273",
      "id" : 483935273,
      "in_reply_to_id" : 483929087,
      "line" : 536,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzkzNTI3Mw==",
      "original_commit_id" : "575c5f55cc44348f0ebc7740c90013b96bdb8c27",
      "original_line" : 536,
      "original_position" : 18,
      "original_start_line" : 512,
      "path" : "src/net_processing.cpp",
      "position" : 42,
      "pull_request_review_id" : 483045575,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : 526,
      "start_side" : "RIGHT",
      "updated_at" : "2020-10-01T10:53:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483935273",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r483935288"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483935288"
         }
      },
      "author_association" : "MEMBER",
      "body" : ":flushed: ",
      "commit_id" : "a70f328879350558cf2b225b22a4acf69e623c63",
      "created_at" : "2020-09-05T10:05:39Z",
      "diff_hunk" : "@@ -488,6 +488,14 @@ struct Peer {\n     /** Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission). */\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n+    /** Protects block inventory data members */\n+    RecursiveMutex m_block_inv_mutex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r483935288",
      "id" : 483935288,
      "in_reply_to_id" : 483928636,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzkzNTI4OA==",
      "original_commit_id" : "e04fb9a2df9f4d77c587bd25c608ce806c97ea45",
      "original_line" : 492,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 483045586,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-01T10:53:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483935288",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-09-07T17:39:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-688451759",
      "id" : 688451759,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4ODQ1MTc1OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-07T17:39:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/688451759",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "rebased",
      "created_at" : "2020-09-07T18:51:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-688473718",
      "id" : 688473718,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4ODQ3MzcxOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-07T18:51:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/688473718",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-09-08T20:45:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-689126592",
      "id" : 689126592,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4OTEyNjU5Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-08T20:45:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/689126592",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "rebased",
      "created_at" : "2020-09-08T21:44:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-689152626",
      "id" : 689152626,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4OTE1MjYyNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-08T21:44:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/689152626",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-09-26T17:21:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-699523574",
      "id" : 699523574,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5OTUyMzU3NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-26T17:21:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/699523574",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "rebased",
      "created_at" : "2020-09-28T09:50:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-699903877",
      "id" : 699903877,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5OTkwMzg3Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-28T09:50:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/699903877",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r495931907"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/495931907"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 8d3a068 I suppose this is placed at the top of the function, instead of where it is used 150 lines below, as you plan to add more uses of it to this function.",
      "commit_id" : "a70f328879350558cf2b225b22a4acf69e623c63",
      "created_at" : "2020-09-28T13:18:52Z",
      "diff_hunk" : "@@ -1542,6 +1582,7 @@ static void RelayAddress(const CAddress& addr, bool fReachable, const CConnman&\n \n void static ProcessGetBlockData(CNode& pfrom, const CChainParams& chainparams, const CInv& inv, CConnman& connman)\n {\n+    PeerRef peer = GetPeerRef(pfrom.GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r495931907",
      "id" : 495931907,
      "line" : 1586,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTkzMTkwNw==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 1586,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 89,
      "pull_request_review_id" : 497502164,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-01T10:53:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/495931907",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r495978760"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/495978760"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit 85e7deb, perhaps go a bit further in the added comment to clarify that the refcount is often > 1 here.\r\n\r\nIn my testing, adding `assert(peer.use_count() <= 1);` after this line as suggested in https://github.com/bitcoin/bitcoin/pull/19607#discussion_r470173964 causes bitcoind on mainnet to halt nearly immediately after net processing begins and 1-2 peers start to connect.",
      "commit_id" : "a70f328879350558cf2b225b22a4acf69e623c63",
      "created_at" : "2020-09-28T14:23:45Z",
      "diff_hunk" : "@@ -913,6 +948,10 @@ void PeerManager::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTime) {\n     LOCK(cs_main);\n     int misbehavior{0};\n     {\n+        // We remove the Peer object from g_peer_map here, but it's not guaranteed that\n+        // we'll destruct Peer here since another thread could potentially still hold\n+        // a reference to the object. Be careful not to do any processing here that\n+        // assumes Peer won't be changed before it's destructed.\n         PeerRef peer = GetPeerRef(nodeid);\n         assert(peer != nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r495978760",
      "id" : 495978760,
      "line" : 957,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk3ODc2MA==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 957,
      "original_position" : 58,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 59,
      "pull_request_review_id" : 497502164,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-01T10:53:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/495978760",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496054882"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496054882"
         }
      },
      "author_association" : "MEMBER",
      "body" : "cff5d286 What are your plans with respect to this function `ForEachPeer()` in your roadmap...end game interface, or more of an intermediary step?",
      "commit_id" : "a70f328879350558cf2b225b22a4acf69e623c63",
      "created_at" : "2020-09-28T15:49:03Z",
      "diff_hunk" : "@@ -502,6 +519,24 @@ using PeerRef = std::shared_ptr<Peer>;\n Mutex g_peer_mutex;\n static std::map<NodeId, PeerRef> g_peer_map GUARDED_BY(g_peer_mutex);\n \n+/** Get a reference to each Peer, then call a function on each of them */\n+template<typename Callable>\n+void ForEachPeer(Callable&& func)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496054882",
      "id" : 496054882,
      "line" : 524,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA1NDg4Mg==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 524,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 30,
      "pull_request_review_id" : 497502164,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-01T10:53:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496054882",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496056128"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496056128"
         }
      },
      "author_association" : "MEMBER",
      "body" : "9b14eb372 verified manually that this displays as before, as there is no GUI test coverage. Unfortunately, it is broken at this commit and returns only the initial value of `-1` until 3 commits later at f27a1e221d.",
      "commit_id" : "a70f328879350558cf2b225b22a4acf69e623c63",
      "created_at" : "2020-09-28T15:50:47Z",
      "diff_hunk" : "@@ -1148,6 +1147,8 @@ void RPCConsole::updateNodeDetail(const CNodeCombinedStats *stats)\n             ui->peerCommonHeight->setText(QString(\"%1\").arg(stats->nodeStateStats.nCommonHeight));\n         else\n             ui->peerCommonHeight->setText(tr(\"Unknown\"));\n+\n+        ui->peerHeight->setText(QString::number(stats->nodeStateStats.m_starting_height));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496056128",
      "id" : 496056128,
      "line" : 1151,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA1NjEyOA==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 1151,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/qt/rpcconsole.cpp",
      "position" : 13,
      "pull_request_review_id" : 497502164,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-01T10:53:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496056128",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496058069"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496058069"
         }
      },
      "author_association" : "MEMBER",
      "body" : "9b14eb37 verified this functions as before per `./src/bitcoin-cli getpeerinfo | grep 'startingheight' | sort`, as there appear to be no functional tests for `getpeerinfo#startingheight`. As above, it is broken at this commit and returns only the initial value of `-1`. Functionality returns 3 commits later at f27a1e221d.",
      "commit_id" : "a70f328879350558cf2b225b22a4acf69e623c63",
      "created_at" : "2020-09-28T15:53:27Z",
      "diff_hunk" : "@@ -202,14 +202,14 @@ static RPCHelpMan getpeerinfo()\n             // addnode is deprecated in v0.21 for removal in v0.22\n             obj.pushKV(\"addnode\", stats.m_manual_connection);\n         }\n-        obj.pushKV(\"startingheight\", stats.nStartingHeight);\n         if (fStateStats) {\n             if (IsDeprecatedRPCEnabled(\"banscore\")) {\n                 // banscore is deprecated in v0.21 for removal in v0.22\n                 obj.pushKV(\"banscore\", statestats.m_misbehavior_score);\n             }\n             obj.pushKV(\"synced_headers\", statestats.nSyncHeight);\n             obj.pushKV(\"synced_blocks\", statestats.nCommonHeight);\n+            obj.pushKV(\"startingheight\", statestats.m_starting_height);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496058069",
      "id" : 496058069,
      "line" : 212,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA1ODA2OQ==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 212,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 12,
      "pull_request_review_id" : 497502164,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-01T10:53:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496058069",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496068251"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496068251"
         }
      },
      "author_association" : "MEMBER",
      "body" : "9b14eb372 `m_starting_height` presumably still needs to be `std::atomic_int`? \r\n\r\nIf you retouch, perhaps `s/height/block height/` for the Doxygen doc.",
      "commit_id" : "a70f328879350558cf2b225b22a4acf69e623c63",
      "created_at" : "2020-09-28T16:09:02Z",
      "diff_hunk" : "@@ -488,6 +488,23 @@ struct Peer {\n     /** Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission). */\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n+    /** Protects block inventory data members */\n+    Mutex m_block_inv_mutex;\n+    /** List of block ids we still have announce.\n+     * There is no final sorting before sending, as they are always sent\n+     * immediately and in the order requested. */\n+    std::vector<uint256> m_blocks_for_inv_relay GUARDED_BY(m_block_inv_mutex);\n+    /** List of headers to relay */\n+    std::vector<uint256> m_blocks_for_headers_relay GUARDED_BY(m_block_inv_mutex);\n+\n+    /** Starting height of this peer */\n+    std::atomic<int> m_starting_height{-1};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496068251",
      "id" : 496068251,
      "line" : 501,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA2ODI1MQ==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 501,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 14,
      "pull_request_review_id" : 497502164,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-01T10:53:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496068251",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496071488"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496071488"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In general, is there a plan to eventually no longer need to set `PeerRef peer = GetPeerRef(...)` in many net processing methods? ",
      "commit_id" : "a70f328879350558cf2b225b22a4acf69e623c63",
      "created_at" : "2020-09-28T16:14:03Z",
      "diff_hunk" : "@@ -2334,6 +2375,7 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         return;\n     }\n \n+    PeerRef peer = GetPeerRef(pfrom.GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496071488",
      "id" : 496071488,
      "line" : 2379,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA3MTQ4OA==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 2379,
      "original_position" : 124,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 125,
      "pull_request_review_id" : 497502164,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-01T10:53:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496071488",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496080304"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496080304"
         }
      },
      "author_association" : "MEMBER",
      "body" : "f27a1e221 nit, while touching this and lines 4334 and 4366 (3 places), if so inclined\r\n```suggestion\r\n                for (const uint256& hash : peer->m_blocks_for_headers_relay) {\r\n```",
      "commit_id" : "a70f328879350558cf2b225b22a4acf69e623c63",
      "created_at" : "2020-09-28T16:27:33Z",
      "diff_hunk" : "@@ -4196,7 +4239,7 @@ bool PeerManager::SendMessages(CNode* pto)\n                 // Try to find first header that our peer doesn't have, and\n                 // then send all headers past that one.  If we come across any\n                 // headers that aren't on ::ChainActive(), give up.\n-                for (const uint256 &hash : pto->vBlockHashesToAnnounce) {\n+                for (const uint256 &hash : peer->m_blocks_for_headers_relay) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496080304",
      "id" : 496080304,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA4MDMwNA==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 4242,
      "original_position" : 226,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 497502164,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-01T10:53:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496080304",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496082768"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496082768"
         }
      },
      "author_association" : "MEMBER",
      "body" : "8d3a068 nit, remove extra line created by this deletion",
      "commit_id" : "a70f328879350558cf2b225b22a4acf69e623c63",
      "created_at" : "2020-09-28T16:31:28Z",
      "diff_hunk" : "@@ -940,8 +940,6 @@ class CNode\n     mapMsgCmdSize mapRecvBytesPerMsgCmd GUARDED_BY(cs_vRecv);\n \n public:\n-    uint256 hashContinue;\n-    std::atomic<int> nStartingHeight{-1};\n ",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496082768",
      "id" : 496082768,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA4Mjc2OA==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 943,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 497502164,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-01T10:53:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496082768",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496083616"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496083616"
         }
      },
      "author_association" : "MEMBER",
      "body" : "8d3a068 pico-nits, `s/a INV/an INV/` and `s/them/it|the peer/`",
      "commit_id" : "a70f328879350558cf2b225b22a4acf69e623c63",
      "created_at" : "2020-09-28T16:32:58Z",
      "diff_hunk" : "@@ -488,6 +488,23 @@ struct Peer {\n     /** Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission). */\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n+    /** Protects block inventory data members */\n+    Mutex m_block_inv_mutex;\n+    /** List of block ids we still have announce.\n+     * There is no final sorting before sending, as they are always sent\n+     * immediately and in the order requested. */\n+    std::vector<uint256> m_blocks_for_inv_relay GUARDED_BY(m_block_inv_mutex);\n+    /** List of headers to relay */\n+    std::vector<uint256> m_blocks_for_headers_relay GUARDED_BY(m_block_inv_mutex);\n+\n+    /** Starting height of this peer */\n+    std::atomic<int> m_starting_height{-1};\n+    /** The final block hash in a INV message. When the peer requests this",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496083616",
      "id" : 496083616,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA4MzYxNg==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 502,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 497502164,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-01T10:53:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496083616",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496090875"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496090875"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 9b14eb37 is it safe to remove `LOCK(pnode->cs_inventory);` this early? Another lock doesn't replace it until 3 commits later in f27a1e22.",
      "commit_id" : "a70f328879350558cf2b225b22a4acf69e623c63",
      "created_at" : "2020-09-28T16:44:55Z",
      "diff_hunk" : "@@ -1399,11 +1439,11 @@ void PeerManager::UpdatedBlockTip(const CBlockIndex *pindexNew, const CBlockInde\n             }\n         }\n         // Relay inventory, but don't relay old inventory during initial block download.\n-        m_connman.ForEachNode([nNewHeight, &vHashes](CNode* pnode) {\n-            LOCK(pnode->cs_inventory);\n-            if (nNewHeight > (pnode->nStartingHeight != -1 ? pnode->nStartingHeight - 2000 : 0)) {\n+        ForEachPeer([nNewHeight, &vHashes](const PeerRef& peer) {\n+            LOCK(peer->m_block_inv_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496090875",
      "id" : 496090875,
      "line" : 1444,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA5MDg3NQ==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 1444,
      "original_position" : 76,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 77,
      "pull_request_review_id" : 497502164,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-01T10:53:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496090875",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496578664"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496578664"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Correct. Future commits will use `peer` throughout the function, and there's no downside to holding on to the object for a bit longer.",
      "commit_id" : "a70f328879350558cf2b225b22a4acf69e623c63",
      "created_at" : "2020-09-29T09:35:59Z",
      "diff_hunk" : "@@ -1542,6 +1582,7 @@ static void RelayAddress(const CAddress& addr, bool fReachable, const CConnman&\n \n void static ProcessGetBlockData(CNode& pfrom, const CChainParams& chainparams, const CInv& inv, CConnman& connman)\n {\n+    PeerRef peer = GetPeerRef(pfrom.GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496578664",
      "id" : 496578664,
      "in_reply_to_id" : 495931907,
      "line" : 1586,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjU3ODY2NA==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 1586,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 89,
      "pull_request_review_id" : 498287785,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-01T10:53:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496578664",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496581548"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496581548"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "a70f328879350558cf2b225b22a4acf69e623c63",
      "created_at" : "2020-09-29T09:40:26Z",
      "diff_hunk" : "@@ -913,6 +948,10 @@ void PeerManager::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTime) {\n     LOCK(cs_main);\n     int misbehavior{0};\n     {\n+        // We remove the Peer object from g_peer_map here, but it's not guaranteed that\n+        // we'll destruct Peer here since another thread could potentially still hold\n+        // a reference to the object. Be careful not to do any processing here that\n+        // assumes Peer won't be changed before it's destructed.\n         PeerRef peer = GetPeerRef(nodeid);\n         assert(peer != nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496581548",
      "id" : 496581548,
      "in_reply_to_id" : 495978760,
      "line" : 957,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjU4MTU0OA==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 957,
      "original_position" : 58,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 59,
      "pull_request_review_id" : 498291388,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-01T10:53:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496581548",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496582845"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496582845"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, potentially we could just pass a `Peer&` to many of the private functions (just as `CNodeState*` is passed to some of the functions now).",
      "commit_id" : "a70f328879350558cf2b225b22a4acf69e623c63",
      "created_at" : "2020-09-29T09:42:29Z",
      "diff_hunk" : "@@ -2334,6 +2375,7 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         return;\n     }\n \n+    PeerRef peer = GetPeerRef(pfrom.GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496582845",
      "id" : 496582845,
      "in_reply_to_id" : 496071488,
      "line" : 2379,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjU4Mjg0NQ==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 2379,
      "original_position" : 124,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 125,
      "pull_request_review_id" : 498292946,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-01T10:53:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496582845",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496647277"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496647277"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "a70f328879350558cf2b225b22a4acf69e623c63",
      "created_at" : "2020-09-29T11:38:21Z",
      "diff_hunk" : "@@ -940,8 +940,6 @@ class CNode\n     mapMsgCmdSize mapRecvBytesPerMsgCmd GUARDED_BY(cs_vRecv);\n \n public:\n-    uint256 hashContinue;\n-    std::atomic<int> nStartingHeight{-1};\n ",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496647277",
      "id" : 496647277,
      "in_reply_to_id" : 496082768,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY0NzI3Nw==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 943,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 498376974,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-01T10:53:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496647277",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496647768"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496647768"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't have a strong opinion. I've done it this way here to minimize the difference in logic, but if people want to change the internal implementation later, I'm fine with that.",
      "commit_id" : "a70f328879350558cf2b225b22a4acf69e623c63",
      "created_at" : "2020-09-29T11:39:17Z",
      "diff_hunk" : "@@ -502,6 +519,24 @@ using PeerRef = std::shared_ptr<Peer>;\n Mutex g_peer_mutex;\n static std::map<NodeId, PeerRef> g_peer_map GUARDED_BY(g_peer_mutex);\n \n+/** Get a reference to each Peer, then call a function on each of them */\n+template<typename Callable>\n+void ForEachPeer(Callable&& func)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496647768",
      "id" : 496647768,
      "in_reply_to_id" : 496054882,
      "line" : 524,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY0Nzc2OA==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 524,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 30,
      "pull_request_review_id" : 498377624,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-01T10:53:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496647768",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496647935"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496647935"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oops. I think this was a bad rebase. Should be fixed now.",
      "commit_id" : "a70f328879350558cf2b225b22a4acf69e623c63",
      "created_at" : "2020-09-29T11:39:36Z",
      "diff_hunk" : "@@ -1148,6 +1147,8 @@ void RPCConsole::updateNodeDetail(const CNodeCombinedStats *stats)\n             ui->peerCommonHeight->setText(QString(\"%1\").arg(stats->nodeStateStats.nCommonHeight));\n         else\n             ui->peerCommonHeight->setText(tr(\"Unknown\"));\n+\n+        ui->peerHeight->setText(QString::number(stats->nodeStateStats.m_starting_height));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496647935",
      "id" : 496647935,
      "in_reply_to_id" : 496056128,
      "line" : 1151,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY0NzkzNQ==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 1151,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/qt/rpcconsole.cpp",
      "position" : 13,
      "pull_request_review_id" : 498377856,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-01T10:53:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496647935",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496648070"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496648070"
         }
      },
      "author_association" : "MEMBER",
      "body" : "As above, should now be fixed.",
      "commit_id" : "a70f328879350558cf2b225b22a4acf69e623c63",
      "created_at" : "2020-09-29T11:39:49Z",
      "diff_hunk" : "@@ -202,14 +202,14 @@ static RPCHelpMan getpeerinfo()\n             // addnode is deprecated in v0.21 for removal in v0.22\n             obj.pushKV(\"addnode\", stats.m_manual_connection);\n         }\n-        obj.pushKV(\"startingheight\", stats.nStartingHeight);\n         if (fStateStats) {\n             if (IsDeprecatedRPCEnabled(\"banscore\")) {\n                 // banscore is deprecated in v0.21 for removal in v0.22\n                 obj.pushKV(\"banscore\", statestats.m_misbehavior_score);\n             }\n             obj.pushKV(\"synced_headers\", statestats.nSyncHeight);\n             obj.pushKV(\"synced_blocks\", statestats.nCommonHeight);\n+            obj.pushKV(\"startingheight\", statestats.m_starting_height);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496648070",
      "id" : 496648070,
      "in_reply_to_id" : 496058069,
      "line" : 212,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY0ODA3MA==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 212,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 12,
      "pull_request_review_id" : 498378020,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-01T10:53:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496648070",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496649424"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496649424"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> m_starting_height presumably still needs to be std::atomic_int?\r\n\r\nI don't understand. It's a `std::atomic<int>` before and after this PR.\r\n\r\n> If you retouch, perhaps s/height/block height/ for the Doxygen doc.\r\n\r\nI've updated the Doxygen comment to be clearer.",
      "commit_id" : "a70f328879350558cf2b225b22a4acf69e623c63",
      "created_at" : "2020-09-29T11:42:04Z",
      "diff_hunk" : "@@ -488,6 +488,23 @@ struct Peer {\n     /** Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission). */\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n+    /** Protects block inventory data members */\n+    Mutex m_block_inv_mutex;\n+    /** List of block ids we still have announce.\n+     * There is no final sorting before sending, as they are always sent\n+     * immediately and in the order requested. */\n+    std::vector<uint256> m_blocks_for_inv_relay GUARDED_BY(m_block_inv_mutex);\n+    /** List of headers to relay */\n+    std::vector<uint256> m_blocks_for_headers_relay GUARDED_BY(m_block_inv_mutex);\n+\n+    /** Starting height of this peer */\n+    std::atomic<int> m_starting_height{-1};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496649424",
      "id" : 496649424,
      "in_reply_to_id" : 496068251,
      "line" : 501,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY0OTQyNA==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 501,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 14,
      "pull_request_review_id" : 498379591,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-01T10:53:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496649424",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496652482"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496652482"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "a70f328879350558cf2b225b22a4acf69e623c63",
      "created_at" : "2020-09-29T11:47:52Z",
      "diff_hunk" : "@@ -4196,7 +4239,7 @@ bool PeerManager::SendMessages(CNode* pto)\n                 // Try to find first header that our peer doesn't have, and\n                 // then send all headers past that one.  If we come across any\n                 // headers that aren't on ::ChainActive(), give up.\n-                for (const uint256 &hash : pto->vBlockHashesToAnnounce) {\n+                for (const uint256 &hash : peer->m_blocks_for_headers_relay) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496652482",
      "id" : 496652482,
      "in_reply_to_id" : 496080304,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY1MjQ4Mg==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 4242,
      "original_position" : 226,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 498383510,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-01T10:53:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496652482",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496653268"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496653268"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fixed",
      "commit_id" : "a70f328879350558cf2b225b22a4acf69e623c63",
      "created_at" : "2020-09-29T11:49:25Z",
      "diff_hunk" : "@@ -488,6 +488,23 @@ struct Peer {\n     /** Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission). */\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n+    /** Protects block inventory data members */\n+    Mutex m_block_inv_mutex;\n+    /** List of block ids we still have announce.\n+     * There is no final sorting before sending, as they are always sent\n+     * immediately and in the order requested. */\n+    std::vector<uint256> m_blocks_for_inv_relay GUARDED_BY(m_block_inv_mutex);\n+    /** List of headers to relay */\n+    std::vector<uint256> m_blocks_for_headers_relay GUARDED_BY(m_block_inv_mutex);\n+\n+    /** Starting height of this peer */\n+    std::atomic<int> m_starting_height{-1};\n+    /** The final block hash in a INV message. When the peer requests this",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496653268",
      "id" : 496653268,
      "in_reply_to_id" : 496083616,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY1MzI2OA==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 502,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 498384511,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-01T10:53:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496653268",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496653399"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496653399"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oops. Bad rebase. Should be fixed now.",
      "commit_id" : "a70f328879350558cf2b225b22a4acf69e623c63",
      "created_at" : "2020-09-29T11:49:38Z",
      "diff_hunk" : "@@ -1399,11 +1439,11 @@ void PeerManager::UpdatedBlockTip(const CBlockIndex *pindexNew, const CBlockInde\n             }\n         }\n         // Relay inventory, but don't relay old inventory during initial block download.\n-        m_connman.ForEachNode([nNewHeight, &vHashes](CNode* pnode) {\n-            LOCK(pnode->cs_inventory);\n-            if (nNewHeight > (pnode->nStartingHeight != -1 ? pnode->nStartingHeight - 2000 : 0)) {\n+        ForEachPeer([nNewHeight, &vHashes](const PeerRef& peer) {\n+            LOCK(peer->m_block_inv_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r496653399",
      "id" : 496653399,
      "in_reply_to_id" : 496090875,
      "line" : 1444,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY1MzM5OQ==",
      "original_commit_id" : "8d3a0684ba749c35161b121da442e07e5ba594a4",
      "original_line" : 1444,
      "original_position" : 76,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 77,
      "pull_request_review_id" : 498384642,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-01T10:53:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/496653399",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the very thorough review, @jonatack. I've addressed all of your comments.",
      "created_at" : "2020-09-29T11:54:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-700652906",
      "id" : 700652906,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwMDY1MjkwNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-29T11:54:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/700652906",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r498128377"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/498128377"
         }
      },
      "author_association" : "MEMBER",
      "body" : "0a9839058c\r\n```bash\r\nnet_processing.cpp: In function âbool GetNodeStateStats(NodeId, CNodeStateStats&)â:\r\nnet_processing.cpp:982:11: error: âstruct CNodeStateStatsâ has no member named âm_starting_heightâ; did you mean ânStartingHeightâ?\r\n  982 |     stats.m_starting_height = peer->m_starting_height;\r\n      |           ^~~~~~~~~~~~~~~~~\r\n      |           nStartingHeight\r\n```",
      "commit_id" : "a70f328879350558cf2b225b22a4acf69e623c63",
      "created_at" : "2020-10-01T10:03:17Z",
      "diff_hunk" : "@@ -971,6 +1011,7 @@ bool GetNodeStateStats(NodeId nodeid, CNodeStateStats &stats) {\n     PeerRef peer = GetPeerRef(nodeid);\n     if (peer == nullptr) return false;\n     stats.m_misbehavior_score = WITH_LOCK(peer->m_misbehavior_mutex, return peer->m_misbehavior_score);\n+    stats.m_starting_height = peer->m_starting_height;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r498128377",
      "id" : 498128377,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODEyODM3Nw==",
      "original_commit_id" : "1a9e1911673e2e643e9ad9b6ff412ce34e7af72f",
      "original_line" : 1014,
      "original_position" : 65,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 500193857,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-01T10:53:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/498128377",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r498154958"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/498154958"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fixed",
      "commit_id" : "a70f328879350558cf2b225b22a4acf69e623c63",
      "created_at" : "2020-10-01T10:53:12Z",
      "diff_hunk" : "@@ -971,6 +1011,7 @@ bool GetNodeStateStats(NodeId nodeid, CNodeStateStats &stats) {\n     PeerRef peer = GetPeerRef(nodeid);\n     if (peer == nullptr) return false;\n     stats.m_misbehavior_score = WITH_LOCK(peer->m_misbehavior_mutex, return peer->m_misbehavior_score);\n+    stats.m_starting_height = peer->m_starting_height;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#discussion_r498154958",
      "id" : 498154958,
      "in_reply_to_id" : 498128377,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODE1NDk1OA==",
      "original_commit_id" : "1a9e1911673e2e643e9ad9b6ff412ce34e7af72f",
      "original_line" : 1014,
      "original_position" : 65,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 500228247,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19829",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-01T10:53:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/498154958",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks @jonatack . I fixed the bad rebase.",
      "created_at" : "2020-10-01T10:53:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-702054221",
      "id" : 702054221,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwMjA1NDIyMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-01T10:53:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/702054221",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "commits f9136f4bf, 7199d81968, 8ff3e9319c11 and 40ea4a42d9\r\n```diff\r\nnet_processing.cpp: In function âbool GetNodeStateStats(NodeId, CNodeStateStats&)â:\r\nnet_processing.cpp:982/1000/1009: error: âstruct CNodeStateStatsâ has no member named ânStartingHeightâ; did you mean âm_starting_heightâ?\r\n  982 |     stats.nStartingHeight = peer->nStartingHeight;\r\n      |           ^~~~~~~~~~~~~~~\r\n      |           m_starting_height\r\n```\r\n(we'll get there!)",
      "created_at" : "2020-10-01T13:32:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-702137666",
      "id" : 702137666,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwMjEzNzY2Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-01T13:32:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/702137666",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Oops. Sorry Jon. Should be good now.",
      "created_at" : "2020-10-01T18:01:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-702303723",
      "id" : 702303723,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwMjMwMzcyMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-01T18:01:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/702303723",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-10-19T02:49:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-711480527",
      "id" : 711480527,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcxMTQ4MDUyNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-19T02:49:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/711480527",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased",
      "created_at" : "2020-10-19T08:16:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-711816616",
      "id" : 711816616,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcxMTgxNjYxNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-19T08:16:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/711816616",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased",
      "created_at" : "2020-11-19T11:10:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19829#issuecomment-730300986",
      "id" : 730300986,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19829",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczMDMwMDk4Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-19T11:10:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/730300986",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   }
]
