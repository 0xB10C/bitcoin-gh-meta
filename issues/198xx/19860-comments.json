[
   {
      "author_association" : "MEMBER",
      "body" : "Draft until #19724 is merged.",
      "created_at" : "2020-09-02T14:07:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19860#issuecomment-685761138",
      "id" : 685761138,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19860",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4NTc2MTEzOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-02T14:07:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/685761138",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "There is an interesting overlap with #19858 (periodic BLOCK_RELAY conns to sync tips).\r\n\r\n I think those temporarily BLOCK_RELAY conns probably should be selected similarly to the existent new `BLOCK_RELAY` conns, meaning diversified by both `set_connected_full_relay` and `set_connected_block_relay`. If many of our peers are Sybils, it also would improve the chance of not connecting to the same netgroup.\r\n\r\nSimilarly to the work in this PR, I think we better select them as diverse as we can. If an attacker is capable to influence this selection, making it less diverse (by dropping one of the checks) won't really help neither with the robustness of these selected connections nor with their privacy.",
      "created_at" : "2020-09-02T14:12:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19860#issuecomment-685764141",
      "id" : 685764141,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19860",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4NTc2NDE0MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-02T14:14:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/685764141",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Prevents BLOCK_RELAY connections from affecting our further full-relay peer selection, because otherwise, an attacker with sufficient ADDR-related capabilities may infer to which netgroups those (supposedly more private) connections belong.\r\n\r\nDo you have a way to model what an attacker's capability would need to be in order to deduce something like this?  On the face of it, it seems strange to me make this kind of peering behavior dependent of the order in which we connect peers (full-relay first or block-relay first), and in particular, my presumption would be that it's more important to aim for peer netgroup diversity (as a first-order solution to being eclipsed) than it is to worry about inference based on that diversity (which is a second-order concern with regards to eclipse attacks) -- but if the inference capability is strong then perhaps I'm mistaken in thinking that?",
      "created_at" : "2020-09-02T15:27:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19860#issuecomment-685812232",
      "id" : 685812232,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19860",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4NTgxMjIzMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-02T15:27:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/685812232",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19860#discussion_r482217837"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19860"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/482217837"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: Would be a bit clearer IMO to use the `Is` prefix or similar to distinguish between the interrogative and the imperative.",
      "commit_id" : "c63c87507a7246183d8c055ea5fc54413ff38626",
      "created_at" : "2020-09-02T16:51:39Z",
      "diff_hunk" : "@@ -861,6 +861,12 @@ class CNode\n         return m_conn_type == ConnectionType::INBOUND;\n     }\n \n+    /* Whether we send addr messages over this connection */\n+    bool RelayAddrsWithConn() const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19860#discussion_r482217837",
      "id" : 482217837,
      "line" : 907,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjIxNzgzNw==",
      "original_commit_id" : "f26b0ddac590ac96e86fe043de744747e834ec0e",
      "original_line" : 865,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 102,
      "pull_request_review_id" : 481013853,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19860",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-02T16:51:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/482217837",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5470?v=4",
         "events_url" : "https://api.github.com/users/Empact/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Empact/followers",
         "following_url" : "https://api.github.com/users/Empact/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Empact/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Empact",
         "id" : 5470,
         "login" : "Empact",
         "node_id" : "MDQ6VXNlcjU0NzA=",
         "organizations_url" : "https://api.github.com/users/Empact/orgs",
         "received_events_url" : "https://api.github.com/users/Empact/received_events",
         "repos_url" : "https://api.github.com/users/Empact/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Empact/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Empact/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Empact"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19860#discussion_r482222193"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19860"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/482222193"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: I don't believe the `> >` construction is necessary anymore here. See other uses`<*>>` in the codebase.",
      "commit_id" : "c63c87507a7246183d8c055ea5fc54413ff38626",
      "created_at" : "2020-09-02T16:58:11Z",
      "diff_hunk" : "@@ -1830,7 +1830,8 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\n         // Only connect out to one peer per network group (/16 for IPv4).\n         int nOutboundFullRelay = 0;\n         int nOutboundBlockRelay = 0;\n-        std::set<std::vector<unsigned char> > setConnected;\n+        std::set<std::vector<unsigned char> > set_connected_full_relay;\n+        std::set<std::vector<unsigned char> > set_connected_block_relay;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19860#discussion_r482222193",
      "id" : 482222193,
      "line" : 1834,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjIyMjE5Mw==",
      "original_commit_id" : "c63c87507a7246183d8c055ea5fc54413ff38626",
      "original_line" : 1834,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 6,
      "pull_request_review_id" : 481019518,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19860",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-02T16:58:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/482222193",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5470?v=4",
         "events_url" : "https://api.github.com/users/Empact/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Empact/followers",
         "following_url" : "https://api.github.com/users/Empact/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Empact/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Empact",
         "id" : 5470,
         "login" : "Empact",
         "node_id" : "MDQ6VXNlcjU0NzA=",
         "organizations_url" : "https://api.github.com/users/Empact/orgs",
         "received_events_url" : "https://api.github.com/users/Empact/received_events",
         "repos_url" : "https://api.github.com/users/Empact/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Empact/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Empact/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Empact"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #19843 (Refactoring and minor improvement for self-advertisements by naumenkogs)\n* #19829 ([net processing] Move block inventory state to net_processing by jnewbery)\n* #19794 (p2p: Remove fGetAddr flag by mzumsande)\n* #19763 (net: don't try to relay to the address' originator by vasild)\n* #19725 ([RPC] Add connection type to getpeerinfo, improve logs by amitiuttarwar)\n* #19724 ([net] Cleanup connection types- followups by amitiuttarwar)\n* #17785 (p2p: Unify Send and Receive protocol versions by hebasto)\n* #17428 (p2p: Try to preserve outbound block-relay-only connections during restart by hebasto)\n* #17194 (p2p: Avoid forwarding ADDR messages to SPV nodes by naumenkogs)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-09-02T17:27:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19860#issuecomment-685885260",
      "id" : 685885260,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19860",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4NTg4NTI2MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-03T00:23:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/685885260",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19860#discussion_r482751269"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19860"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/482751269"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not my work: see #19724 this is based on.",
      "commit_id" : "c63c87507a7246183d8c055ea5fc54413ff38626",
      "created_at" : "2020-09-03T07:03:40Z",
      "diff_hunk" : "@@ -861,6 +861,12 @@ class CNode\n         return m_conn_type == ConnectionType::INBOUND;\n     }\n \n+    /* Whether we send addr messages over this connection */\n+    bool RelayAddrsWithConn() const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19860#discussion_r482751269",
      "id" : 482751269,
      "in_reply_to_id" : 482217837,
      "line" : 907,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc1MTI2OQ==",
      "original_commit_id" : "f26b0ddac590ac96e86fe043de744747e834ec0e",
      "original_line" : 865,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 102,
      "pull_request_review_id" : 481549835,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19860",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-03T07:03:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/482751269",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@sdaftuar I agree that immediate diversity is more important than theoretical anti-inference. But since it's easy to get confused here, I want to point out that after the second commit:\r\n- *new* block relay conns are made with full diversity, same as before\r\n- *new* full relay conns are made distinct w.r.t. existing full relay conns\r\n\r\nThe difference is only that *existing* block relay conns don't affect *new* full relay conns.\r\n\r\nSo, like, just 2 of the existing peers, for now, won't participate in diversity enforcement. If we have more (say 8 block relay conns), we might introduce some randomness: like 4 conns are used to diversify new full conns, and 4 are hidden.\r\n\r\n>Do you have a way to model what an attacker's capability would need to be in order to deduce something like this?\r\n\r\nNo, not right now. I just assume an attacker can influence what our AddrMan has. The influence shouldn't even be that strong, they just have to force us to connect to a set of (given by them) peers on-demand with some probability.\r\n\r\nFor example, they exploited eviction and made us connect to them (via regular conns) exclusively. Now to eclipse us they have to find out about our block-relay-only conns and potentially disrupt those. May be feasible with these capabilities and enough protocol knowledge :)\r\nSince block-relay-only conns are created (sort of) specifically to handle scenarios like this, I wanna make them more robust.\r\n\r\n-----------------\r\n\r\nIf this is not convincing, I can drop the commit until when/if I can actually demostrate a feasible attack.\r\n",
      "created_at" : "2020-09-03T07:20:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19860#issuecomment-686305852",
      "id" : 686305852,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19860",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4NjMwNTg1Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-03T07:22:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/686305852",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   }
]
