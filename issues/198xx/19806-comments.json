[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #19792 (rpc: Add dumpcoinstats by fjahr)\n* #19775 (test: Activate segwit in TestChain100Setup by MarcoFalke)\n* #19652 (Add thread safety annotations to Mempool{Info}ToJSON() by hebasto)\n* #19521 (Coinstats Index (without UTXO set hash) by fjahr)\n* #19306 (refactor: Replace RecursiveMutex with Mutex in CTxMemPool by hebasto)\n* #19245 ([WIP DONOTMERGE] Replace boost::filesystem with std::filesystem (in c++17) by kiminuo)\n* #19145 (Add hash_type MUHASH for gettxoutsetinfo by fjahr)\n* #18731 (refactor: Make CCheckQueue RAII-styled by hebasto)\n* #18689 (rpc: allow dumptxoutset to dump human-readable data by pierreN)\n* #14053 (Add address-based index (attempt 4?) by marcinja)\n* #9384 (CCoinsViewCache code cleanup & deduplication by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-08-26T01:08:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19806#issuecomment-680400991",
      "id" : 680400991,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19806",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4MDQwMDk5MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-26T01:08:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/680400991",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-08-26T06:56:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19806#issuecomment-680696759",
      "id" : 680696759,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19806",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4MDY5Njc1OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-26T06:56:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/680696759",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19806#discussion_r479626183"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19806"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479626183"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "What is your reasoning behind calling the utxo set hash `assumeutxo` here? It makes it harder for me to reason about but i may be in the minority and this is easier for the casual user. Was that your intention? If we have different hashes in the future and they might be used for assumeutxo as well it would be probably best to use the explicit name for this type of hash `hash_serialized_2`.",
      "commit_id" : "2cb1f842dc904f66293148568090f4980da96557",
      "created_at" : "2020-08-29T08:35:22Z",
      "diff_hunk" : "@@ -5269,6 +5270,34 @@ CChainState& ChainstateManager::InitializeChainstate(const uint256& snapshot_blo\n     return *to_modify;\n }\n \n+/**\n+ * Return the expected assumeutxo value for a given height, if one exists.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19806#discussion_r479626183",
      "id" : 479626183,
      "line" : 5275,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTYyNjE4Mw==",
      "original_commit_id" : "d6396c4be4e3960ffcfe57d7479ab413058103b9",
      "original_line" : 5274,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 23,
      "pull_request_review_id" : 478110745,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19806",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-29T10:48:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479626183",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19806#discussion_r479626276"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19806"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479626276"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This makes me a bit uncomfortable because we can't test the actual functionality of this function with this. Do you plan to keep this or change it in a follow-up with changes to the testing framework that allow for a better test?",
      "commit_id" : "2cb1f842dc904f66293148568090f4980da96557",
      "created_at" : "2020-08-29T08:36:46Z",
      "diff_hunk" : "@@ -5269,6 +5270,34 @@ CChainState& ChainstateManager::InitializeChainstate(const uint256& snapshot_blo\n     return *to_modify;\n }\n \n+/**\n+ * Return the expected assumeutxo value for a given height, if one exists.\n+ *\n+ * @param height[in]         Get the assumeutxo value for this height.\n+ * @param expected_out[out]  Set to the expected assumeutxo hash value if one exists.\n+ *\n+ * @returns bool - false if no assumeutxo value exists for the given height.\n+ */\n+static bool ExpectedAssumeutxo(int height, uint256& expected_out)\n+{\n+    const CChainParams& params = ::Params();\n+\n+    if (params.NetworkIDString() == \"regtest\") {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19806#discussion_r479626276",
      "id" : 479626276,
      "line" : 5286,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTYyNjI3Ng==",
      "original_commit_id" : "d6396c4be4e3960ffcfe57d7479ab413058103b9",
      "original_line" : 5285,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 34,
      "pull_request_review_id" : 478110745,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19806",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-29T10:48:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479626276",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19806#discussion_r479634348"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19806"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479634348"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n    const bool snapshot_ok = this->PopulateAndValidateSnapshot(\r\n```",
      "commit_id" : "2cb1f842dc904f66293148568090f4980da96557",
      "created_at" : "2020-08-29T10:16:09Z",
      "diff_hunk" : "@@ -5298,6 +5298,256 @@ static bool ExpectedAssumeutxo(int height, uint256& expected_out)\n     return true;\n }\n \n+bool ChainstateManager::ActivateSnapshot(\n+        CAutoFile* coins_file,\n+        SnapshotMetadata metadata,\n+        bool in_memory)\n+{\n+    uint256 base_blockhash = metadata.m_base_blockhash;\n+\n+    // Can't activate a snapshot more than once.\n+    assert(!this->SnapshotBlockhash());\n+    int64_t current_coinsdb_cache_size{0};\n+    int64_t current_coinstip_cache_size{0};\n+\n+    // Cache percentages to allocate to each chainstate.\n+    constexpr float ibd_cache_perc = 0.01;\n+    constexpr float snapshot_cache_perc = 0.99;\n+\n+    {\n+        LOCK(::cs_main);\n+        // Resize the coins caches to ensure we're not exceeding memory limits.\n+        //\n+        // Allocate the majority of the cache to the incoming snapshot chainstate, since\n+        // (optimistically) getting to its tip will be the top priority. We'll need to call\n+        // `MaybeRebalanceCaches()` once we're done with this function to ensure\n+        // the right allocation (including the possibility that no snapshot was activated\n+        // and that we should restore the active chainstate caches to their original size).\n+        //\n+        current_coinsdb_cache_size = ::ChainstateActive().m_coinsdb_cache_size_bytes;\n+        current_coinstip_cache_size = ::ChainstateActive().m_coinstip_cache_size_bytes;\n+\n+        // Temporarily resize the active coins cache to make room for the newly-created\n+        // snapshot chain.\n+        ::ChainstateActive().ResizeCoinsCaches(\n+            current_coinstip_cache_size * ibd_cache_perc,\n+            current_coinsdb_cache_size * ibd_cache_perc);\n+    }\n+\n+    auto snapshot_chainstate = MakeUnique<CChainState>(m_blockman, base_blockhash);\n+\n+    {\n+        LOCK(::cs_main);\n+        snapshot_chainstate->InitCoinsDB(\n+            current_coinsdb_cache_size * snapshot_cache_perc, in_memory, false, \"chainstate\");\n+        snapshot_chainstate->InitCoinsCache(current_coinstip_cache_size * snapshot_cache_perc);\n+    }\n+\n+    bool snapshot_ok = this->PopulateAndValidateSnapshot(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19806#discussion_r479634348",
      "id" : 479634348,
      "line" : 5347,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTYzNDM0OA==",
      "original_commit_id" : "bdf182e81e8e03b4670059a718159e03dd35fbe4",
      "original_line" : 5346,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 95,
      "pull_request_review_id" : 478110745,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19806",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-29T10:48:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479634348",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19806#discussion_r479636397"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19806"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479636397"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I assume it wouldn't work because of a divide by zero error in the progress function? Shouldn't that be rather dealt with at that layer?",
      "commit_id" : "2cb1f842dc904f66293148568090f4980da96557",
      "created_at" : "2020-08-29T10:42:35Z",
      "diff_hunk" : "@@ -407,3 +411,25 @@ bool CCoinsViewDB::Upgrade() {\n     LogPrintf(\"[%s].\\n\", ShutdownRequested() ? \"CANCELLED\" : \"DONE\");\n     return !ShutdownRequested();\n }\n+\n+bool CCoinsViewDB::SetNChainTx(unsigned int n_chain_tx)\n+{\n+    return m_db->Write(DB_NCHAINTX, n_chain_tx, /*fsync*/ true);\n+}\n+\n+unsigned int CCoinsViewDB::GetNChainTx()\n+{\n+    // We choose 1 and not 0 because, in the unlikely event that we can't read\n+    // a value from this key, we don't want LoadBlockIndex() to malfunction for\n+    // snapshot chainstates being loaded. Returning 1 here will break the\n+    // progress= measure, but returning 0 would cause us to not be able to add\n+    // chain tips for the snapshot chainstate. This shouldn't happen and is",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19806#discussion_r479636397",
      "id" : 479636397,
      "line" : 430,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTYzNjM5Nw==",
      "original_commit_id" : "3cd76cd1b2bf73b92914f42e5e9757eff3e3e847",
      "original_line" : 426,
      "original_position" : 27,
      "original_start_line" : 425,
      "path" : "src/txdb.cpp",
      "position" : 48,
      "pull_request_review_id" : 478110745,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19806",
      "side" : "RIGHT",
      "start_line" : 429,
      "start_side" : "RIGHT",
      "updated_at" : "2020-08-29T10:48:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479636397",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19806#discussion_r479649888"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19806"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479649888"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "One alternative way would be hardcode a pre-mined chain into the test and use it, similar to what signet does here: https://github.com/bitcoin/bitcoin/pull/18267/commits/6206c2e8e87fcc70848e4a0fab871d5fd9ea6b16",
      "commit_id" : "2cb1f842dc904f66293148568090f4980da96557",
      "created_at" : "2020-08-29T13:28:00Z",
      "diff_hunk" : "@@ -5269,6 +5270,34 @@ CChainState& ChainstateManager::InitializeChainstate(const uint256& snapshot_blo\n     return *to_modify;\n }\n \n+/**\n+ * Return the expected assumeutxo value for a given height, if one exists.\n+ *\n+ * @param height[in]         Get the assumeutxo value for this height.\n+ * @param expected_out[out]  Set to the expected assumeutxo hash value if one exists.\n+ *\n+ * @returns bool - false if no assumeutxo value exists for the given height.\n+ */\n+static bool ExpectedAssumeutxo(int height, uint256& expected_out)\n+{\n+    const CChainParams& params = ::Params();\n+\n+    if (params.NetworkIDString() == \"regtest\") {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19806#discussion_r479649888",
      "id" : 479649888,
      "in_reply_to_id" : 479626276,
      "line" : 5286,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTY0OTg4OA==",
      "original_commit_id" : "d6396c4be4e3960ffcfe57d7479ab413058103b9",
      "original_line" : 5285,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 34,
      "pull_request_review_id" : 478128208,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19806",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-29T13:28:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479649888",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   }
]
