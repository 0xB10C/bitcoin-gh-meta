[
   {
      "author_association" : "MEMBER",
      "body" : "Build failing\r\n```\r\nnet_processing.cpp:2478:27: error: writing variable 'm_next_local_addr_send' requires holding mutex 'pfrom.cs_sendProcessing' exclusively [-Werror,-Wthread-safety-analysis]\r\n                    pfrom.m_next_local_addr_send = PoissonNextSend(current_time, AVG_LOCAL_ADDRESS_BROADCAST_INTERVAL);\r\n```",
      "created_at" : "2020-08-31T12:37:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#issuecomment-683752038",
      "id" : 683752038,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19843",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4Mzc1MjAzOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-31T12:37:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/683752038",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.",
      "created_at" : "2020-08-31T12:38:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#issuecomment-683752544",
      "id" : 683752544,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19843",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4Mzc1MjU0NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-04T08:38:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/683752544",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-09-03T13:20:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#issuecomment-686485681",
      "id" : 686485681,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19843",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4NjQ4NTY4MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-03T13:20:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/686485681",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.",
      "created_at" : "2020-09-21T07:46:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#issuecomment-695957307",
      "id" : 695957307,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19843",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5NTk1NzMwNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-21T07:46:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/695957307",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r498937654"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/498937654"
         }
      },
      "author_association" : "MEMBER",
      "body" : "shouldn't the `cs_sendProcessing` be acquired here? I'm slightly confused because I'd expect a CI job to fail since `m_next_local_addr_send` has the `GUARDED_BY(cs_sendProcessing)` safety annotation. am I missing something? ",
      "commit_id" : "b77272e96576cb693b1ce273cd31acb1aa35c53b",
      "created_at" : "2020-10-02T16:53:50Z",
      "diff_hunk" : "@@ -4140,7 +4130,9 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n         int64_t nNow = GetTimeMicros();\n         auto current_time = GetTime<std::chrono::microseconds>();\n \n-        if (pto->RelayAddrsWithConn() && !::ChainstateActive().IsInitialBlockDownload() && pto->m_next_local_addr_send < current_time) {\n+        if (pto->RelayAddrsWithConn() && !m_chainman.ActiveChainstate().IsInitialBlockDownload() && fListen &&\n+            pto->fSuccessfullyConnected && pto->m_next_local_addr_send < current_time) {\n+\n             AdvertiseLocal(pto);\n             pto->m_next_local_addr_send = PoissonNextSend(current_time, AVG_LOCAL_ADDRESS_BROADCAST_INTERVAL);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r498937654",
      "id" : 498937654,
      "line" : 4104,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkzNzY1NA==",
      "original_commit_id" : "ba4735db2050634a654ca7facda054be7aca7bd9",
      "original_line" : 4104,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 35,
      "pull_request_review_id" : 501296232,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-06T11:13:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/498937654",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r499276450"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499276450"
         }
      },
      "author_association" : "NONE",
      "body" : "Is it the case that this entire `SendMessages` call is locked? https://github.com/bitcoin/bitcoin/blob/df2129a2349b1877049f250551f49a4592e73765/src/net.cpp#L2164-L2168",
      "commit_id" : "b77272e96576cb693b1ce273cd31acb1aa35c53b",
      "created_at" : "2020-10-04T18:47:01Z",
      "diff_hunk" : "@@ -4140,7 +4130,9 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n         int64_t nNow = GetTimeMicros();\n         auto current_time = GetTime<std::chrono::microseconds>();\n \n-        if (pto->RelayAddrsWithConn() && !::ChainstateActive().IsInitialBlockDownload() && pto->m_next_local_addr_send < current_time) {\n+        if (pto->RelayAddrsWithConn() && !m_chainman.ActiveChainstate().IsInitialBlockDownload() && fListen &&\n+            pto->fSuccessfullyConnected && pto->m_next_local_addr_send < current_time) {\n+\n             AdvertiseLocal(pto);\n             pto->m_next_local_addr_send = PoissonNextSend(current_time, AVG_LOCAL_ADDRESS_BROADCAST_INTERVAL);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r499276450",
      "id" : 499276450,
      "in_reply_to_id" : 498937654,
      "line" : 4104,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTI3NjQ1MA==",
      "original_commit_id" : "ba4735db2050634a654ca7facda054be7aca7bd9",
      "original_line" : 4104,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 35,
      "pull_request_review_id" : 501649004,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-06T11:13:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499276450",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/4276679?v=4",
         "events_url" : "https://api.github.com/users/robot-dreams/events{/privacy}",
         "followers_url" : "https://api.github.com/users/robot-dreams/followers",
         "following_url" : "https://api.github.com/users/robot-dreams/following{/other_user}",
         "gists_url" : "https://api.github.com/users/robot-dreams/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/robot-dreams",
         "id" : 4276679,
         "login" : "robot-dreams",
         "node_id" : "MDQ6VXNlcjQyNzY2Nzk=",
         "organizations_url" : "https://api.github.com/users/robot-dreams/orgs",
         "received_events_url" : "https://api.github.com/users/robot-dreams/received_events",
         "repos_url" : "https://api.github.com/users/robot-dreams/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/robot-dreams/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/robot-dreams/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/robot-dreams"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@amitiuttarwar how would you suggest to split the first commit into two? I'd be happy to take suggestions :)\r\nI don't see a way to do it, because the refactor is to merge two *a little different* chunks of code into one (`AdvertiseLocal`). \r\n\r\nThe only way I see is to add a flag to `AdvertiseLocal` to discern the two, and then drop the flag right in the next commit (\"behaviour change\"). But do you think that would make the code easier to follow? :)",
      "created_at" : "2020-10-05T08:17:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#issuecomment-703478443",
      "id" : 703478443,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19843",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwMzQ3ODQ0Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-05T08:17:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/703478443",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r499743996"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499743996"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n    // In absence of other information, we assume that the locally seen address is the \"best\" addr for peers to refer to our node.\r\n```",
      "commit_id" : "b77272e96576cb693b1ce273cd31acb1aa35c53b",
      "created_at" : "2020-10-05T17:01:36Z",
      "diff_hunk" : "@@ -193,30 +193,30 @@ bool IsPeerAddrLocalGood(CNode *pnode)\n            IsReachable(addrLocal.GetNetwork());\n }\n \n-// pushes our own address to a peer\n void AdvertiseLocal(CNode *pnode)\n {\n-    if (fListen && pnode->fSuccessfullyConnected)\n+    assert(fListen);\n+    // First consider our \"best\" addr for the peer, as seen locally.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r499743996",
      "id" : 499743996,
      "line" : 205,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc0Mzk5Ng==",
      "original_commit_id" : "ba4735db2050634a654ca7facda054be7aca7bd9",
      "original_line" : 205,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 55,
      "pull_request_review_id" : 502251184,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-06T11:13:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499743996",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r499747657"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499747657"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This comment confuses me. If Peer_A gave us \"the address it tells us that it sees us as\", why would we need to give Peer_A our address?\r\n\r\nIs this comment supposed to mean that we sometimes refer to ourselves as the address that another peer gave us? I.e. we heard from Peer_A that they know us as `addrRemote`, and we sometimes announce our address to another peer `Peer_B` as `addrRemote` instead of `addrLocal`?",
      "commit_id" : "b77272e96576cb693b1ce273cd31acb1aa35c53b",
      "created_at" : "2020-10-05T17:08:25Z",
      "diff_hunk" : "@@ -193,30 +193,30 @@ bool IsPeerAddrLocalGood(CNode *pnode)\n            IsReachable(addrLocal.GetNetwork());\n }\n \n-// pushes our own address to a peer\n void AdvertiseLocal(CNode *pnode)\n {\n-    if (fListen && pnode->fSuccessfullyConnected)\n+    assert(fListen);\n+    // First consider our \"best\" addr for the peer, as seen locally.\n+    CAddress addrLocal = GetLocalAddress(&pnode->addr, pnode->GetLocalServices());\n+\n+    if (gArgs.GetBoolArg(\"-addrmantest\", false)) {\n+        // use IPv4 loopback during addrmantest\n+        addrLocal = CAddress(CService(LookupNumeric(\"127.0.0.1\", GetListenPort())), pnode->GetLocalServices());\n+    }\n+\n+    // If discovery is enabled, sometimes give our peer the address it\n+    // tells us that it sees us as in case it has a better idea of our\n+    // address than we do.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r499747657",
      "id" : 499747657,
      "line" : 217,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc0NzY1Nw==",
      "original_commit_id" : "ba4735db2050634a654ca7facda054be7aca7bd9",
      "original_line" : 217,
      "original_position" : 19,
      "original_start_line" : 207,
      "path" : "src/net.cpp",
      "position" : 67,
      "pull_request_review_id" : 502251184,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : 215,
      "start_side" : "RIGHT",
      "updated_at" : "2020-10-06T11:13:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499747657",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r499749612"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499749612"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I am not sure whether I am understanding this right. Is this suggesting that we keep track of each `addr` that some peer refers to us as separately, or are we catering to the possibility that our IP from remote looks different than what we see locally?",
      "commit_id" : "b77272e96576cb693b1ce273cd31acb1aa35c53b",
      "created_at" : "2020-10-05T17:12:10Z",
      "diff_hunk" : "@@ -193,30 +193,30 @@ bool IsPeerAddrLocalGood(CNode *pnode)\n            IsReachable(addrLocal.GetNetwork());\n }\n \n-// pushes our own address to a peer\n void AdvertiseLocal(CNode *pnode)\n {\n-    if (fListen && pnode->fSuccessfullyConnected)\n+    assert(fListen);\n+    // First consider our \"best\" addr for the peer, as seen locally.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r499749612",
      "id" : 499749612,
      "in_reply_to_id" : 499743996,
      "line" : 205,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc0OTYxMg==",
      "original_commit_id" : "ba4735db2050634a654ca7facda054be7aca7bd9",
      "original_line" : 205,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 55,
      "pull_request_review_id" : 502251184,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-06T11:13:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499749612",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r499752581"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499752581"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It looks to me as if we are updating here the address that we think we are reachable on per the information of a peer. Would it be possible for different peers to see us at different addresses (e.g. if our node has a client in our LAN)? How do we verify that the address is a good address to adopt?",
      "commit_id" : "b77272e96576cb693b1ce273cd31acb1aa35c53b",
      "created_at" : "2020-10-05T17:17:23Z",
      "diff_hunk" : "@@ -193,30 +193,30 @@ bool IsPeerAddrLocalGood(CNode *pnode)\n            IsReachable(addrLocal.GetNetwork());\n }\n \n-// pushes our own address to a peer\n void AdvertiseLocal(CNode *pnode)\n {\n-    if (fListen && pnode->fSuccessfullyConnected)\n+    assert(fListen);\n+    // First consider our \"best\" addr for the peer, as seen locally.\n+    CAddress addrLocal = GetLocalAddress(&pnode->addr, pnode->GetLocalServices());\n+\n+    if (gArgs.GetBoolArg(\"-addrmantest\", false)) {\n+        // use IPv4 loopback during addrmantest\n+        addrLocal = CAddress(CService(LookupNumeric(\"127.0.0.1\", GetListenPort())), pnode->GetLocalServices());\n+    }\n+\n+    // If discovery is enabled, sometimes give our peer the address it\n+    // tells us that it sees us as in case it has a better idea of our\n+    // address than we do.\n+    FastRandomContext rng;\n+    if (IsPeerAddrLocalGood(pnode) && (!addrLocal.IsRoutable() ||\n+         rng.randbits((GetnScore(addrLocal) > LOCAL_MANUAL) ? 3 : 1) == 0))\n     {\n-        CAddress addrLocal = GetLocalAddress(&pnode->addr, pnode->GetLocalServices());\n-        if (gArgs.GetBoolArg(\"-addrmantest\", false)) {\n-            // use IPv4 loopback during addrmantest\n-            addrLocal = CAddress(CService(LookupNumeric(\"127.0.0.1\", GetListenPort())), pnode->GetLocalServices());\n-        }\n-        // If discovery is enabled, sometimes give our peer the address it\n-        // tells us that it sees us as in case it has a better idea of our\n-        // address than we do.\n-        FastRandomContext rng;\n-        if (IsPeerAddrLocalGood(pnode) && (!addrLocal.IsRoutable() ||\n-             rng.randbits((GetnScore(addrLocal) > LOCAL_MANUAL) ? 3 : 1) == 0))\n-        {\n-            addrLocal.SetIP(pnode->GetAddrLocal());\n-        }\n-        if (addrLocal.IsRoutable() || gArgs.GetBoolArg(\"-addrmantest\", false))\n-        {\n-            LogPrint(BCLog::NET, \"AdvertiseLocal: advertising address %s\\n\", addrLocal.ToString());\n-            pnode->PushAddress(addrLocal, rng);\n-        }\n+        addrLocal.SetIP(pnode->GetAddrLocal());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r499752581",
      "id" : 499752581,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc1MjU4MQ==",
      "original_commit_id" : "ba4735db2050634a654ca7facda054be7aca7bd9",
      "original_line" : 214,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 502251184,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-06T11:13:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499752581",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r499753279"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499753279"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n * to relay to a given node as scheduled. The relay is not guaranteed.\r\n```",
      "commit_id" : "b77272e96576cb693b1ce273cd31acb1aa35c53b",
      "created_at" : "2020-10-05T17:18:38Z",
      "diff_hunk" : "@@ -614,6 +614,11 @@ enum\n };\n \n bool IsPeerAddrLocalGood(CNode *pnode);\n+\n+/**\n+ * Adds our \"best\" local address to the batch of addresses we are planning\n+ * to relay a given node as scheduled. The relay is not guaranteed.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r499753279",
      "id" : 499753279,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc1MzI3OQ==",
      "original_commit_id" : "ba4735db2050634a654ca7facda054be7aca7bd9",
      "original_line" : 620,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 502251184,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-06T11:13:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499753279",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r499763658"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499763658"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Since `addrLocal` seems to be a local variable here, would it make sense to change it to `addr_local`? My understanding is that per style guide variable symbols should prefer to use snake_case.",
      "commit_id" : "b77272e96576cb693b1ce273cd31acb1aa35c53b",
      "created_at" : "2020-10-05T17:37:38Z",
      "diff_hunk" : "@@ -193,30 +193,30 @@ bool IsPeerAddrLocalGood(CNode *pnode)\n            IsReachable(addrLocal.GetNetwork());\n }\n \n-// pushes our own address to a peer\n void AdvertiseLocal(CNode *pnode)\n {\n-    if (fListen && pnode->fSuccessfullyConnected)\n+    assert(fListen);\n+    // First consider our \"best\" addr for the peer, as seen locally.\n+    CAddress addrLocal = GetLocalAddress(&pnode->addr, pnode->GetLocalServices());\n+\n+    if (gArgs.GetBoolArg(\"-addrmantest\", false)) {\n+        // use IPv4 loopback during addrmantest\n+        addrLocal = CAddress(CService(LookupNumeric(\"127.0.0.1\", GetListenPort())), pnode->GetLocalServices());\n+    }\n+\n+    // If discovery is enabled, sometimes give our peer the address it\n+    // tells us that it sees us as in case it has a better idea of our\n+    // address than we do.\n+    FastRandomContext rng;\n+    if (IsPeerAddrLocalGood(pnode) && (!addrLocal.IsRoutable() ||\n+         rng.randbits((GetnScore(addrLocal) > LOCAL_MANUAL) ? 3 : 1) == 0))\n     {\n-        CAddress addrLocal = GetLocalAddress(&pnode->addr, pnode->GetLocalServices());\n-        if (gArgs.GetBoolArg(\"-addrmantest\", false)) {\n-            // use IPv4 loopback during addrmantest\n-            addrLocal = CAddress(CService(LookupNumeric(\"127.0.0.1\", GetListenPort())), pnode->GetLocalServices());\n-        }\n-        // If discovery is enabled, sometimes give our peer the address it\n-        // tells us that it sees us as in case it has a better idea of our\n-        // address than we do.\n-        FastRandomContext rng;\n-        if (IsPeerAddrLocalGood(pnode) && (!addrLocal.IsRoutable() ||\n-             rng.randbits((GetnScore(addrLocal) > LOCAL_MANUAL) ? 3 : 1) == 0))\n-        {\n-            addrLocal.SetIP(pnode->GetAddrLocal());\n-        }\n-        if (addrLocal.IsRoutable() || gArgs.GetBoolArg(\"-addrmantest\", false))\n-        {\n-            LogPrint(BCLog::NET, \"AdvertiseLocal: advertising address %s\\n\", addrLocal.ToString());\n-            pnode->PushAddress(addrLocal, rng);\n-        }\n+        addrLocal.SetIP(pnode->GetAddrLocal());\n+    }\n+    if (addrLocal.IsRoutable() || gArgs.GetBoolArg(\"-addrmantest\", false))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r499763658",
      "id" : 499763658,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc2MzY1OA==",
      "original_commit_id" : "ba4735db2050634a654ca7facda054be7aca7bd9",
      "original_line" : 216,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 502251184,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-06T11:13:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499763658",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r499922947"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499922947"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ahhh ð¡  that makes sense. thanks! ",
      "commit_id" : "b77272e96576cb693b1ce273cd31acb1aa35c53b",
      "created_at" : "2020-10-05T23:19:36Z",
      "diff_hunk" : "@@ -4140,7 +4130,9 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n         int64_t nNow = GetTimeMicros();\n         auto current_time = GetTime<std::chrono::microseconds>();\n \n-        if (pto->RelayAddrsWithConn() && !::ChainstateActive().IsInitialBlockDownload() && pto->m_next_local_addr_send < current_time) {\n+        if (pto->RelayAddrsWithConn() && !m_chainman.ActiveChainstate().IsInitialBlockDownload() && fListen &&\n+            pto->fSuccessfullyConnected && pto->m_next_local_addr_send < current_time) {\n+\n             AdvertiseLocal(pto);\n             pto->m_next_local_addr_send = PoissonNextSend(current_time, AVG_LOCAL_ADDRESS_BROADCAST_INTERVAL);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r499922947",
      "id" : 499922947,
      "in_reply_to_id" : 498937654,
      "line" : 4104,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkyMjk0Nw==",
      "original_commit_id" : "ba4735db2050634a654ca7facda054be7aca7bd9",
      "original_line" : 4104,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 35,
      "pull_request_review_id" : 502484802,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-06T11:13:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499922947",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500055283"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500055283"
         }
      },
      "author_association" : "MEMBER",
      "body" : ">we keep track of each addr that some peer refers to us as separately, or are we catering to the possibility that our IP from remote looks different than what we see locally?\r\n\r\nSort of both :)\r\nA remote peer always tells us via which IP they see us (within VERSION message, see `addrMe` field there). Then, we store this to consider in future. Among all these options, we sometimes choose the best to advertise it to a remote peer instead of advertising what *we think* is our local addr. ",
      "commit_id" : "b77272e96576cb693b1ce273cd31acb1aa35c53b",
      "created_at" : "2020-10-06T07:17:53Z",
      "diff_hunk" : "@@ -193,30 +193,30 @@ bool IsPeerAddrLocalGood(CNode *pnode)\n            IsReachable(addrLocal.GetNetwork());\n }\n \n-// pushes our own address to a peer\n void AdvertiseLocal(CNode *pnode)\n {\n-    if (fListen && pnode->fSuccessfullyConnected)\n+    assert(fListen);\n+    // First consider our \"best\" addr for the peer, as seen locally.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500055283",
      "id" : 500055283,
      "in_reply_to_id" : 499743996,
      "line" : 205,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA1NTI4Mw==",
      "original_commit_id" : "ba4735db2050634a654ca7facda054be7aca7bd9",
      "original_line" : 205,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 55,
      "pull_request_review_id" : 502646382,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-06T11:13:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500055283",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500056598"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500056598"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Hopefully [this](https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500055283) comment answers.\r\n\r\nWhy we give it to them? Because we ask them to *forward* our self-announcement to other nodes. Peer_A is not supposed currently to modify an `ADDR` they receive, so they just take what we give them and forward it.\r\n\r\nYou are right that they could, but it has other implications...",
      "commit_id" : "b77272e96576cb693b1ce273cd31acb1aa35c53b",
      "created_at" : "2020-10-06T07:20:24Z",
      "diff_hunk" : "@@ -193,30 +193,30 @@ bool IsPeerAddrLocalGood(CNode *pnode)\n            IsReachable(addrLocal.GetNetwork());\n }\n \n-// pushes our own address to a peer\n void AdvertiseLocal(CNode *pnode)\n {\n-    if (fListen && pnode->fSuccessfullyConnected)\n+    assert(fListen);\n+    // First consider our \"best\" addr for the peer, as seen locally.\n+    CAddress addrLocal = GetLocalAddress(&pnode->addr, pnode->GetLocalServices());\n+\n+    if (gArgs.GetBoolArg(\"-addrmantest\", false)) {\n+        // use IPv4 loopback during addrmantest\n+        addrLocal = CAddress(CService(LookupNumeric(\"127.0.0.1\", GetListenPort())), pnode->GetLocalServices());\n+    }\n+\n+    // If discovery is enabled, sometimes give our peer the address it\n+    // tells us that it sees us as in case it has a better idea of our\n+    // address than we do.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500056598",
      "id" : 500056598,
      "in_reply_to_id" : 499747657,
      "line" : 217,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA1NjU5OA==",
      "original_commit_id" : "ba4735db2050634a654ca7facda054be7aca7bd9",
      "original_line" : 217,
      "original_position" : 19,
      "original_start_line" : 207,
      "path" : "src/net.cpp",
      "position" : 67,
      "pull_request_review_id" : 502648040,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : 215,
      "start_side" : "RIGHT",
      "updated_at" : "2020-10-06T11:13:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500056598",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500059166"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500059166"
         }
      },
      "author_association" : "MEMBER",
      "body" : ">Would it be possible for different peers to see us at different addresses (e.g. if our node has a client in our LAN)?\r\n\r\nYes, see `SeenLocal` and `GetLocal`, it's an under-documented scoring scheme.\r\n\r\nYou are right that it's not the most robust feature, someone can trick us to believe something wrong, but the harm is limited I guess.\r\n\r\nThis feature is definitely worth extra research and documenting.",
      "commit_id" : "b77272e96576cb693b1ce273cd31acb1aa35c53b",
      "created_at" : "2020-10-06T07:25:21Z",
      "diff_hunk" : "@@ -193,30 +193,30 @@ bool IsPeerAddrLocalGood(CNode *pnode)\n            IsReachable(addrLocal.GetNetwork());\n }\n \n-// pushes our own address to a peer\n void AdvertiseLocal(CNode *pnode)\n {\n-    if (fListen && pnode->fSuccessfullyConnected)\n+    assert(fListen);\n+    // First consider our \"best\" addr for the peer, as seen locally.\n+    CAddress addrLocal = GetLocalAddress(&pnode->addr, pnode->GetLocalServices());\n+\n+    if (gArgs.GetBoolArg(\"-addrmantest\", false)) {\n+        // use IPv4 loopback during addrmantest\n+        addrLocal = CAddress(CService(LookupNumeric(\"127.0.0.1\", GetListenPort())), pnode->GetLocalServices());\n+    }\n+\n+    // If discovery is enabled, sometimes give our peer the address it\n+    // tells us that it sees us as in case it has a better idea of our\n+    // address than we do.\n+    FastRandomContext rng;\n+    if (IsPeerAddrLocalGood(pnode) && (!addrLocal.IsRoutable() ||\n+         rng.randbits((GetnScore(addrLocal) > LOCAL_MANUAL) ? 3 : 1) == 0))\n     {\n-        CAddress addrLocal = GetLocalAddress(&pnode->addr, pnode->GetLocalServices());\n-        if (gArgs.GetBoolArg(\"-addrmantest\", false)) {\n-            // use IPv4 loopback during addrmantest\n-            addrLocal = CAddress(CService(LookupNumeric(\"127.0.0.1\", GetListenPort())), pnode->GetLocalServices());\n-        }\n-        // If discovery is enabled, sometimes give our peer the address it\n-        // tells us that it sees us as in case it has a better idea of our\n-        // address than we do.\n-        FastRandomContext rng;\n-        if (IsPeerAddrLocalGood(pnode) && (!addrLocal.IsRoutable() ||\n-             rng.randbits((GetnScore(addrLocal) > LOCAL_MANUAL) ? 3 : 1) == 0))\n-        {\n-            addrLocal.SetIP(pnode->GetAddrLocal());\n-        }\n-        if (addrLocal.IsRoutable() || gArgs.GetBoolArg(\"-addrmantest\", false))\n-        {\n-            LogPrint(BCLog::NET, \"AdvertiseLocal: advertising address %s\\n\", addrLocal.ToString());\n-            pnode->PushAddress(addrLocal, rng);\n-        }\n+        addrLocal.SetIP(pnode->GetAddrLocal());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500059166",
      "id" : 500059166,
      "in_reply_to_id" : 499752581,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA1OTE2Ng==",
      "original_commit_id" : "ba4735db2050634a654ca7facda054be7aca7bd9",
      "original_line" : 214,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 502651465,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-06T11:13:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500059166",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500060454"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500060454"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Even though it looks like I rewrote the whole method, most of the changes is just moving the code out of the `{}` block. I chose to preserve variable names to make review easier. I prefer to not touch existing variable names, unless it's really easy, or if I'm changing their type for example.",
      "commit_id" : "b77272e96576cb693b1ce273cd31acb1aa35c53b",
      "created_at" : "2020-10-06T07:27:43Z",
      "diff_hunk" : "@@ -193,30 +193,30 @@ bool IsPeerAddrLocalGood(CNode *pnode)\n            IsReachable(addrLocal.GetNetwork());\n }\n \n-// pushes our own address to a peer\n void AdvertiseLocal(CNode *pnode)\n {\n-    if (fListen && pnode->fSuccessfullyConnected)\n+    assert(fListen);\n+    // First consider our \"best\" addr for the peer, as seen locally.\n+    CAddress addrLocal = GetLocalAddress(&pnode->addr, pnode->GetLocalServices());\n+\n+    if (gArgs.GetBoolArg(\"-addrmantest\", false)) {\n+        // use IPv4 loopback during addrmantest\n+        addrLocal = CAddress(CService(LookupNumeric(\"127.0.0.1\", GetListenPort())), pnode->GetLocalServices());\n+    }\n+\n+    // If discovery is enabled, sometimes give our peer the address it\n+    // tells us that it sees us as in case it has a better idea of our\n+    // address than we do.\n+    FastRandomContext rng;\n+    if (IsPeerAddrLocalGood(pnode) && (!addrLocal.IsRoutable() ||\n+         rng.randbits((GetnScore(addrLocal) > LOCAL_MANUAL) ? 3 : 1) == 0))\n     {\n-        CAddress addrLocal = GetLocalAddress(&pnode->addr, pnode->GetLocalServices());\n-        if (gArgs.GetBoolArg(\"-addrmantest\", false)) {\n-            // use IPv4 loopback during addrmantest\n-            addrLocal = CAddress(CService(LookupNumeric(\"127.0.0.1\", GetListenPort())), pnode->GetLocalServices());\n-        }\n-        // If discovery is enabled, sometimes give our peer the address it\n-        // tells us that it sees us as in case it has a better idea of our\n-        // address than we do.\n-        FastRandomContext rng;\n-        if (IsPeerAddrLocalGood(pnode) && (!addrLocal.IsRoutable() ||\n-             rng.randbits((GetnScore(addrLocal) > LOCAL_MANUAL) ? 3 : 1) == 0))\n-        {\n-            addrLocal.SetIP(pnode->GetAddrLocal());\n-        }\n-        if (addrLocal.IsRoutable() || gArgs.GetBoolArg(\"-addrmantest\", false))\n-        {\n-            LogPrint(BCLog::NET, \"AdvertiseLocal: advertising address %s\\n\", addrLocal.ToString());\n-            pnode->PushAddress(addrLocal, rng);\n-        }\n+        addrLocal.SetIP(pnode->GetAddrLocal());\n+    }\n+    if (addrLocal.IsRoutable() || gArgs.GetBoolArg(\"-addrmantest\", false))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500060454",
      "id" : 500060454,
      "in_reply_to_id" : 499763658,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA2MDQ1NA==",
      "original_commit_id" : "ba4735db2050634a654ca7facda054be7aca7bd9",
      "original_line" : 216,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 502653188,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-06T11:13:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500060454",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Per @amitiuttarwar 's suggestion, here's one way I might split your first commit 89c77a015a3ad14d1c05b4b975ed6532392e4654 into two separate parts for easier review:\r\n\r\n* Refactoring-only changes: e4bca91105d580d11d977e397b78cee28728ef8f\r\n* Behavior changes: 1ca2235aaa3cba43e2a1dbccaa89aa8577f91152\r\n\r\nAlternatively, here's a more fine-grained approach, in which I split your first commit 89c77a015a3ad14d1c05b4b975ed6532392e4654 into 8 separate commits, 5 refactoring only commits and 3 behavior changes:\r\n\r\na0a422c34cfd6514d0cc445bd784d3ee1a2d1749...e2c1c58d8d602cd413e435b03d3c634fb2c5bbd6\r\n\r\nThe more fine-grained approach might also be helpful for PR Review Club participants who are trying to understand exactly what changed in your first commit.",
      "created_at" : "2020-10-06T08:59:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#issuecomment-704131702",
      "id" : 704131702,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19843",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwNDEzMTcwMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-06T08:59:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/704131702",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/4276679?v=4",
         "events_url" : "https://api.github.com/users/robot-dreams/events{/privacy}",
         "followers_url" : "https://api.github.com/users/robot-dreams/followers",
         "following_url" : "https://api.github.com/users/robot-dreams/following{/other_user}",
         "gists_url" : "https://api.github.com/users/robot-dreams/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/robot-dreams",
         "id" : 4276679,
         "login" : "robot-dreams",
         "node_id" : "MDQ6VXNlcjQyNzY2Nzk=",
         "organizations_url" : "https://api.github.com/users/robot-dreams/orgs",
         "received_events_url" : "https://api.github.com/users/robot-dreams/received_events",
         "repos_url" : "https://api.github.com/users/robot-dreams/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/robot-dreams/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/robot-dreams/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/robot-dreams"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500140568"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500140568"
         }
      },
      "author_association" : "MEMBER",
      "body" : "join with line above while you're touching this",
      "commit_id" : "b77272e96576cb693b1ce273cd31acb1aa35c53b",
      "created_at" : "2020-10-06T09:38:08Z",
      "diff_hunk" : "@@ -193,30 +193,30 @@ bool IsPeerAddrLocalGood(CNode *pnode)\n            IsReachable(addrLocal.GetNetwork());\n }\n \n-// pushes our own address to a peer\n void AdvertiseLocal(CNode *pnode)\n {\n-    if (fListen && pnode->fSuccessfullyConnected)\n+    assert(fListen);\n+    // First consider our \"best\" addr for the peer, as seen locally.\n+    CAddress addrLocal = GetLocalAddress(&pnode->addr, pnode->GetLocalServices());\n+\n+    if (gArgs.GetBoolArg(\"-addrmantest\", false)) {\n+        // use IPv4 loopback during addrmantest\n+        addrLocal = CAddress(CService(LookupNumeric(\"127.0.0.1\", GetListenPort())), pnode->GetLocalServices());\n+    }\n+\n+    // If discovery is enabled, sometimes give our peer the address it\n+    // tells us that it sees us as in case it has a better idea of our\n+    // address than we do.\n+    FastRandomContext rng;\n+    if (IsPeerAddrLocalGood(pnode) && (!addrLocal.IsRoutable() ||\n+         rng.randbits((GetnScore(addrLocal) > LOCAL_MANUAL) ? 3 : 1) == 0))\n     {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500140568",
      "id" : 500140568,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE0MDU2OA==",
      "original_commit_id" : "85c9839e57d06bc194d804d3e8efcf84320a9f7d",
      "original_line" : 213,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 502759047,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-06T11:13:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500140568",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500140845"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500140845"
         }
      },
      "author_association" : "MEMBER",
      "body" : "add blank line above and join `{` below onto this line.",
      "commit_id" : "b77272e96576cb693b1ce273cd31acb1aa35c53b",
      "created_at" : "2020-10-06T09:38:34Z",
      "diff_hunk" : "@@ -193,30 +193,30 @@ bool IsPeerAddrLocalGood(CNode *pnode)\n            IsReachable(addrLocal.GetNetwork());\n }\n \n-// pushes our own address to a peer\n void AdvertiseLocal(CNode *pnode)\n {\n-    if (fListen && pnode->fSuccessfullyConnected)\n+    assert(fListen);\n+    // First consider our \"best\" addr for the peer, as seen locally.\n+    CAddress addrLocal = GetLocalAddress(&pnode->addr, pnode->GetLocalServices());\n+\n+    if (gArgs.GetBoolArg(\"-addrmantest\", false)) {\n+        // use IPv4 loopback during addrmantest\n+        addrLocal = CAddress(CService(LookupNumeric(\"127.0.0.1\", GetListenPort())), pnode->GetLocalServices());\n+    }\n+\n+    // If discovery is enabled, sometimes give our peer the address it\n+    // tells us that it sees us as in case it has a better idea of our\n+    // address than we do.\n+    FastRandomContext rng;\n+    if (IsPeerAddrLocalGood(pnode) && (!addrLocal.IsRoutable() ||\n+         rng.randbits((GetnScore(addrLocal) > LOCAL_MANUAL) ? 3 : 1) == 0))\n     {\n-        CAddress addrLocal = GetLocalAddress(&pnode->addr, pnode->GetLocalServices());\n-        if (gArgs.GetBoolArg(\"-addrmantest\", false)) {\n-            // use IPv4 loopback during addrmantest\n-            addrLocal = CAddress(CService(LookupNumeric(\"127.0.0.1\", GetListenPort())), pnode->GetLocalServices());\n-        }\n-        // If discovery is enabled, sometimes give our peer the address it\n-        // tells us that it sees us as in case it has a better idea of our\n-        // address than we do.\n-        FastRandomContext rng;\n-        if (IsPeerAddrLocalGood(pnode) && (!addrLocal.IsRoutable() ||\n-             rng.randbits((GetnScore(addrLocal) > LOCAL_MANUAL) ? 3 : 1) == 0))\n-        {\n-            addrLocal.SetIP(pnode->GetAddrLocal());\n-        }\n-        if (addrLocal.IsRoutable() || gArgs.GetBoolArg(\"-addrmantest\", false))\n-        {\n-            LogPrint(BCLog::NET, \"AdvertiseLocal: advertising address %s\\n\", addrLocal.ToString());\n-            pnode->PushAddress(addrLocal, rng);\n-        }\n+        addrLocal.SetIP(pnode->GetAddrLocal());\n+    }\n+    if (addrLocal.IsRoutable() || gArgs.GetBoolArg(\"-addrmantest\", false))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500140845",
      "id" : 500140845,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE0MDg0NQ==",
      "original_commit_id" : "85c9839e57d06bc194d804d3e8efcf84320a9f7d",
      "original_line" : 216,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 502759047,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-06T11:13:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500140845",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500141353"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500141353"
         }
      },
      "author_association" : "MEMBER",
      "body" : "s/Adds/Add/ (make function doxygen comments the indicative case)",
      "commit_id" : "b77272e96576cb693b1ce273cd31acb1aa35c53b",
      "created_at" : "2020-10-06T09:39:23Z",
      "diff_hunk" : "@@ -614,6 +614,11 @@ enum\n };\n \n bool IsPeerAddrLocalGood(CNode *pnode);\n+\n+/**\n+ * Adds our \"best\" local address to the batch of addresses we are planning",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500141353",
      "id" : 500141353,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE0MTM1Mw==",
      "original_commit_id" : "85c9839e57d06bc194d804d3e8efcf84320a9f7d",
      "original_line" : 619,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 502759047,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-06T11:13:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500141353",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500142152"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500142152"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Since you're completely refactoring this function and both call sites, you may as well fix the signature to take a `CNode&` instead of a `CNode*`. I think you may also be able to make it a const reference.",
      "commit_id" : "b77272e96576cb693b1ce273cd31acb1aa35c53b",
      "created_at" : "2020-10-06T09:40:41Z",
      "diff_hunk" : "@@ -193,30 +193,30 @@ bool IsPeerAddrLocalGood(CNode *pnode)\n            IsReachable(addrLocal.GetNetwork());\n }\n \n-// pushes our own address to a peer\n void AdvertiseLocal(CNode *pnode)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500142152",
      "id" : 500142152,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE0MjE1Mg==",
      "original_commit_id" : "85c9839e57d06bc194d804d3e8efcf84320a9f7d",
      "original_line" : 196,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 502759047,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-06T11:13:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500142152",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500142539"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500142539"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Please don't change `::ChainstateActive` to `m_chainman.ActiveChainstate` in this PR. It adds noise for reviewers.",
      "commit_id" : "b77272e96576cb693b1ce273cd31acb1aa35c53b",
      "created_at" : "2020-10-06T09:41:20Z",
      "diff_hunk" : "@@ -2476,19 +2476,12 @@ void PeerLogicValidation::ProcessMessage(CNode& pfrom, const std::string& msg_ty\n             // We skip these operations for BLOCK_RELAY peers to avoid\n             // potentially leaking information about our BLOCK_RELAY\n             // connections via the addrman or address relay.\n-            if (fListen && !::ChainstateActive().IsInitialBlockDownload())\n+            if (fListen && !m_chainman.ActiveChainstate().IsInitialBlockDownload())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500142539",
      "id" : 500142539,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE0MjUzOQ==",
      "original_commit_id" : "85c9839e57d06bc194d804d3e8efcf84320a9f7d",
      "original_line" : 2479,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 502759047,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-06T11:13:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500142539",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500142933"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500142933"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This mutex shouldn't actually be guarding `m_next_local_addr_send`. See https://github.com/bitcoin/bitcoin/pull/13123#issuecomment-647505130. You may as well remove that annotation if you're touching all the places where this variable is used.",
      "commit_id" : "b77272e96576cb693b1ce273cd31acb1aa35c53b",
      "created_at" : "2020-10-06T09:42:02Z",
      "diff_hunk" : "@@ -2476,19 +2476,12 @@ void PeerLogicValidation::ProcessMessage(CNode& pfrom, const std::string& msg_ty\n             // We skip these operations for BLOCK_RELAY peers to avoid\n             // potentially leaking information about our BLOCK_RELAY\n             // connections via the addrman or address relay.\n-            if (fListen && !::ChainstateActive().IsInitialBlockDownload())\n+            if (fListen && !m_chainman.ActiveChainstate().IsInitialBlockDownload())\n             {\n-                CAddress addr = GetLocalAddress(&pfrom.addr, pfrom.GetLocalServices());\n-                FastRandomContext insecure_rand;\n-                if (addr.IsRoutable())\n-                {\n-                    LogPrint(BCLog::NET, \"ProcessMessages: advertising address %s\\n\", addr.ToString());\n-                    pfrom.PushAddress(addr, insecure_rand);\n-                } else if (IsPeerAddrLocalGood(&pfrom)) {\n-                    addr.SetIP(addrMe);\n-                    LogPrint(BCLog::NET, \"ProcessMessages: advertising address %s\\n\", addr.ToString());\n-                    pfrom.PushAddress(addr, insecure_rand);\n-                }\n+                AdvertiseLocal(&pfrom);\n+                const auto current_time = GetTime<std::chrono::microseconds>();\n+                LOCK(pfrom.cs_sendProcessing);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500142933",
      "id" : 500142933,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE0MjkzMw==",
      "original_commit_id" : "85c9839e57d06bc194d804d3e8efcf84320a9f7d",
      "original_line" : 2483,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 502759047,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-06T11:13:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500142933",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500182214"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500182214"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think const reference is possible due to `PushAddress` call.",
      "commit_id" : "b77272e96576cb693b1ce273cd31acb1aa35c53b",
      "created_at" : "2020-10-06T10:53:19Z",
      "diff_hunk" : "@@ -193,30 +193,30 @@ bool IsPeerAddrLocalGood(CNode *pnode)\n            IsReachable(addrLocal.GetNetwork());\n }\n \n-// pushes our own address to a peer\n void AdvertiseLocal(CNode *pnode)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#discussion_r500182214",
      "id" : 500182214,
      "in_reply_to_id" : 500142152,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDE4MjIxNA==",
      "original_commit_id" : "85c9839e57d06bc194d804d3e8efcf84320a9f7d",
      "original_line" : 196,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 502814691,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19843",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-06T11:13:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500182214",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@jnewbery thanks for the feedback, all addressed.\r\nI agree with your hesitation regarding the further commit. It probably doesn't change behavior at all, I just thought it would make it easier to understand what's going on (despite adding 2 extra lines).\r\n\r\nLet's see others' preferences, I'm fine with dropping this commit too.",
      "created_at" : "2020-10-06T11:11:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19843#issuecomment-704197957",
      "id" : 704197957,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19843",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwNDE5Nzk1Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-06T11:11:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/704197957",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   }
]
