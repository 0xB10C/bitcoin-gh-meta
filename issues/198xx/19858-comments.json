[
   {
      "author_association" : "MEMBER",
      "body" : "This implements something similar to what is discussed in #16859.\r\n\r\nMarking this as draft for now, as it builds on top of #19724.",
      "created_at" : "2020-09-01T21:10:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19858#issuecomment-685134274",
      "id" : 685134274,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19858",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4NTEzNDI3NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-01T21:10:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/685134274",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #19843 (Refactoring and minor improvement for self-advertisements by naumenkogs)\n* #19829 ([net processing] Move block inventory state to net_processing by jnewbery)\n* #19794 (p2p: Remove fGetAddr flag by mzumsande)\n* #19791 ([net processing] Move Misbehaving() to PeerManager by jnewbery)\n* #19725 ([RPC] Add connection type to getpeerinfo, improve logs by amitiuttarwar)\n* #17785 (p2p: Unify Send and Receive protocol versions by hebasto)\n* #17428 (p2p: Try to preserve outbound block-relay-only connections during restart by hebasto)\n* #17194 (p2p: Avoid forwarding ADDR messages to SPV nodes by naumenkogs)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-09-01T23:51:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19858#issuecomment-685192705",
      "id" : 685192705,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19858",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4NTE5MjcwNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-01T23:51:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/685192705",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19858#discussion_r481853670"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/481853670"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Perhaps it's a good opportunity to refactor this function:\r\n- rename `GetExtraOutboundCount` -> `GetExtraFullOutboundCount`\r\n- rename `int nOutbound` -> `uint32_t full_outbound_peers`",
      "commit_id" : "f0975e75646e5b28699694ccf89d081d687ad090",
      "created_at" : "2020-09-02T07:55:25Z",
      "diff_hunk" : "@@ -1760,12 +1760,12 @@ int CConnman::GetExtraOutboundCount()\n     {\n         LOCK(cs_vNodes);\n         for (const CNode* pnode : vNodes) {\n-            if (pnode->fSuccessfullyConnected && !pnode->fDisconnect && pnode->IsOutboundOrBlockRelayConn()) {\n+            if (pnode->fSuccessfullyConnected && !pnode->fDisconnect && pnode->IsFullOutboundConn()) {\n                 ++nOutbound;\n             }\n         }\n     }\n-    return std::max(nOutbound - m_max_outbound_full_relay - m_max_outbound_block_relay, 0);\n+    return std::max(nOutbound - m_max_outbound_full_relay, 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19858#discussion_r481853670",
      "id" : 481853670,
      "line" : 1768,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg1MzY3MA==",
      "original_commit_id" : "720f1125992022ae71dbfd3cf47f4d8761aab99c",
      "original_line" : 1768,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 11,
      "pull_request_review_id" : 480571773,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19858",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-02T07:55:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/481853670",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19858#discussion_r481864952"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/481864952"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Should be along the following \"ignore non-outbound-full-relay peers\"?\r\nOr probably even better: \"Consider only outbound full-relay peers not already marked for disconnection\"?",
      "commit_id" : "f0975e75646e5b28699694ccf89d081d687ad090",
      "created_at" : "2020-09-02T08:08:21Z",
      "diff_hunk" : "@@ -3961,13 +3961,11 @@ void PeerLogicValidation::EvictExtraOutboundPeers(int64_t time_in_seconds)\n             AssertLockHeld(cs_main);\n \n             // Ignore non-outbound peers, or nodes marked for disconnect already",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19858#discussion_r481864952",
      "id" : 481864952,
      "line" : 4008,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg2NDk1Mg==",
      "original_commit_id" : "d3612a1fd0e61ee131feab9585bc199440547680",
      "original_line" : 3963,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 130,
      "pull_request_review_id" : 480581377,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19858",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-02T08:08:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/481864952",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2020-09-02T08:09:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19858#issuecomment-685431218",
      "id" : 685431218,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19858",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4NTQzMTIxOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-02T08:09:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/685431218",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19858#discussion_r481871155"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/481871155"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`nBlockRelay` doesn't seem to follow the code conventions we have for vars",
      "commit_id" : "f0975e75646e5b28699694ccf89d081d687ad090",
      "created_at" : "2020-09-02T08:15:20Z",
      "diff_hunk" : "@@ -1768,6 +1768,20 @@ int CConnman::GetExtraOutboundCount()\n     return std::max(nOutbound - m_max_outbound_full_relay, 0);\n }\n \n+int CConnman::GetExtraBlockRelayCount()\n+{\n+    int nBlockRelay = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19858#discussion_r481871155",
      "id" : 481871155,
      "line" : 1773,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg3MTE1NQ==",
      "original_commit_id" : "f0975e75646e5b28699694ccf89d081d687ad090",
      "original_line" : 1773,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 16,
      "pull_request_review_id" : 480586630,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19858",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-02T08:15:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/481871155",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK\r\n\r\nThe most interesting question seems to be the eviction criteria after this new block-relay peer gave us a new block, and we want to evict someone.\r\n\r\nI think the \"evict the youngest\" approach is reasonable: it would be very hard for an attacker to control our block-relay-only connections by just serving blocks faster when we connect to them periodically. They'd have to also maintain very long-lived connections to evict honest peers rather than their own Sybils.\r\n\r\n--------\r\n\r\nWe still have a couple places with `m_tx_relay == nullptr`, and in some of them we mention `block-relay-only` in a related comment. Should we converge at least those to `IsBlockOnlyConn()` check?\r\n\r\n",
      "created_at" : "2020-09-02T08:25:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19858#issuecomment-685440307",
      "id" : 685440307,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19858",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4NTQ0MDMwNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-02T08:25:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/685440307",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   }
]
