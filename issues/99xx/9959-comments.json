[
   {
      "body" : "Update OP with a correction and a more relevant statistic.",
      "created_at" : "2017-03-09T19:10:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9959#issuecomment-285449398",
      "id" : 285449398,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9959",
      "updated_at" : "2017-03-09T19:10:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/285449398",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9959#discussion_r105249723"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9959"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105249723"
         }
      },
      "body" : "Might make more sense to put these on the class, rather than pass by-reference?",
      "commit_id" : "03a407662b008fe030d81bb54dfd3b677b248392",
      "created_at" : "2017-03-09T19:27:22Z",
      "diff_hunk" : "@@ -177,7 +179,11 @@ std::unique_ptr<CBlockTemplate> BlockAssembler::CreateNewBlock(const CScript& sc\n     // transaction (which in most cases can be a no-op).\n     fIncludeWitness = IsWitnessEnabled(pindexPrev, chainparams.GetConsensus());\n \n-    addPackageTxs();\n+    int nPackagesSelected = 0;\n+    int nDescendantsUpdated = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9959#discussion_r105249723",
      "id" : 105249723,
      "original_commit_id" : "03a407662b008fe030d81bb54dfd3b677b248392",
      "original_position" : 15,
      "path" : "src/miner.cpp",
      "position" : 15,
      "pull_request_review_id" : 26120724,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9959",
      "updated_at" : "2017-03-09T19:33:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105249723",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9959#discussion_r105250148"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9959"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105250148"
         }
      },
      "body" : "The old code used 50 for this. Does 1000 work good enough in practice?",
      "commit_id" : "03a407662b008fe030d81bb54dfd3b677b248392",
      "created_at" : "2017-03-09T19:29:06Z",
      "diff_hunk" : "@@ -358,6 +370,12 @@ void BlockAssembler::addPackageTxs()\n \n     CTxMemPool::indexed_transaction_set::index<ancestor_score>::type::iterator mi = mempool.mapTx.get<ancestor_score>().begin();\n     CTxMemPool::txiter iter;\n+\n+    // Limit the number of attempts to add transactions to the block when it is\n+    // close to full.\n+    const int64_t MAX_CONSECUTIVE_FAILURES = 1000;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9959#discussion_r105250148",
      "id" : 105250148,
      "original_commit_id" : "03a407662b008fe030d81bb54dfd3b677b248392",
      "original_position" : 76,
      "path" : "src/miner.cpp",
      "position" : 76,
      "pull_request_review_id" : 26120724,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9959",
      "updated_at" : "2017-03-09T19:33:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105250148",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9959#discussion_r105250686"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9959"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105250686"
         }
      },
      "body" : "Perhaps the additional condition(s) should be before incrementing, or we could end up just aborting immediately as we approach the max block weight even if we could easily fit a few more txs in.",
      "commit_id" : "03a407662b008fe030d81bb54dfd3b677b248392",
      "created_at" : "2017-03-09T19:31:31Z",
      "diff_hunk" : "@@ -419,6 +437,14 @@ void BlockAssembler::addPackageTxs()\n                 mapModifiedTx.get<ancestor_score>().erase(modit);\n                 failedTx.insert(iter);\n             }\n+\n+            ++nConsecutiveFailed;\n+\n+            if (nConsecutiveFailed > MAX_CONSECUTIVE_FAILURES && nBlockWeight >\n+                    nBlockMaxWeight - 4000) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9959#discussion_r105250686",
      "id" : 105250686,
      "original_commit_id" : "03a407662b008fe030d81bb54dfd3b677b248392",
      "original_position" : 90,
      "path" : "src/miner.cpp",
      "position" : 90,
      "pull_request_review_id" : 26120724,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9959",
      "updated_at" : "2017-03-09T19:33:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105250686",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "body" : "utACK 03a407662b008fe030d81bb54dfd3b677b248392, didnt bother to benchmark, should be obvious wins, even if minor.",
      "created_at" : "2017-03-09T20:05:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9959#issuecomment-285465536",
      "id" : 285465536,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9959",
      "updated_at" : "2017-03-09T20:05:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/285465536",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9959#discussion_r105396576"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9959"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105396576"
         }
      },
      "body" : "I'm working on a refactor of the `BlockAssembler` members separately (as part of a patch to exclude recent transactions from new blocks, when the fee difference is negligible), so I'd prefer to defer the decision of whether to include this in the class until I'm ready to PR that patch.",
      "commit_id" : "03a407662b008fe030d81bb54dfd3b677b248392",
      "created_at" : "2017-03-10T13:33:49Z",
      "diff_hunk" : "@@ -177,7 +179,11 @@ std::unique_ptr<CBlockTemplate> BlockAssembler::CreateNewBlock(const CScript& sc\n     // transaction (which in most cases can be a no-op).\n     fIncludeWitness = IsWitnessEnabled(pindexPrev, chainparams.GetConsensus());\n \n-    addPackageTxs();\n+    int nPackagesSelected = 0;\n+    int nDescendantsUpdated = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9959#discussion_r105396576",
      "id" : 105396576,
      "original_commit_id" : "03a407662b008fe030d81bb54dfd3b677b248392",
      "original_position" : 15,
      "path" : "src/miner.cpp",
      "position" : 15,
      "pull_request_review_id" : 26276554,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9959",
      "updated_at" : "2017-03-10T13:33:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105396576",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9959#discussion_r105396657"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9959"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105396657"
         }
      },
      "body" : "Yes, well I also tried setting this to 100 and the performance was not really distinguishable.",
      "commit_id" : "03a407662b008fe030d81bb54dfd3b677b248392",
      "created_at" : "2017-03-10T13:34:25Z",
      "diff_hunk" : "@@ -358,6 +370,12 @@ void BlockAssembler::addPackageTxs()\n \n     CTxMemPool::indexed_transaction_set::index<ancestor_score>::type::iterator mi = mempool.mapTx.get<ancestor_score>().begin();\n     CTxMemPool::txiter iter;\n+\n+    // Limit the number of attempts to add transactions to the block when it is\n+    // close to full.\n+    const int64_t MAX_CONSECUTIVE_FAILURES = 1000;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9959#discussion_r105396657",
      "id" : 105396657,
      "original_commit_id" : "03a407662b008fe030d81bb54dfd3b677b248392",
      "original_position" : 76,
      "path" : "src/miner.cpp",
      "position" : 76,
      "pull_request_review_id" : 26276653,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9959",
      "updated_at" : "2017-03-10T13:34:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105396657",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9959#discussion_r105396891"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9959"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105396891"
         }
      },
      "body" : "I'm not following; every time we add a new tx to the block we reset the counter...  Can you clarify?",
      "commit_id" : "03a407662b008fe030d81bb54dfd3b677b248392",
      "created_at" : "2017-03-10T13:36:00Z",
      "diff_hunk" : "@@ -419,6 +437,14 @@ void BlockAssembler::addPackageTxs()\n                 mapModifiedTx.get<ancestor_score>().erase(modit);\n                 failedTx.insert(iter);\n             }\n+\n+            ++nConsecutiveFailed;\n+\n+            if (nConsecutiveFailed > MAX_CONSECUTIVE_FAILURES && nBlockWeight >\n+                    nBlockMaxWeight - 4000) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9959#discussion_r105396891",
      "id" : 105396891,
      "original_commit_id" : "03a407662b008fe030d81bb54dfd3b677b248392",
      "original_position" : 90,
      "path" : "src/miner.cpp",
      "position" : 90,
      "pull_request_review_id" : 26276914,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9959",
      "updated_at" : "2017-03-10T13:36:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105396891",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "Is this worth backporting (my vote would be weak yes)?",
      "created_at" : "2017-03-24T21:24:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9959#issuecomment-289146625",
      "id" : 289146625,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9959",
      "updated_at" : "2017-03-24T21:25:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/289146625",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   }
]
