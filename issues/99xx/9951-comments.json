[
   {
      "body" : "Great!\r\nConcept ACK.\r\nNeeds rebase.",
      "created_at" : "2017-03-09T08:02:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9951#issuecomment-285281844",
      "id" : 285281844,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9951",
      "updated_at" : "2017-03-09T08:02:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/285281844",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "Yep needed trivial rebase for #9643.",
      "created_at" : "2017-03-09T08:18:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9951#issuecomment-285284819",
      "id" : 285284819,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9951",
      "updated_at" : "2017-03-09T08:18:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/285284819",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9951#discussion_r105120742"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9951"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105120742"
         }
      },
      "body" : "This unique_ptr here bothers me. The interface shouldn't care what kind of pointer is used. I think I'm going to change this to take a `CWalletDBWrapper&`, then replace the call sites with `CWalletDB(*dbw)`. That's better than `CWalletDB(dbw.get())` at least.\r\nEdit: done",
      "commit_id" : "e3e51fdd3a9491ab4a07baed0a0f52b47ef70140",
      "created_at" : "2017-03-09T09:35:17Z",
      "diff_hunk" : "@@ -112,11 +112,19 @@ class CKeyMetadata\n     }\n };\n \n-/** Access to the wallet database */\n-class CWalletDB : public CDB\n+/** Access to the wallet database.\n+ * This should really be named CWalletDBBatch, as it represents a single transaction at the\n+ * database. It will be committed when the object goes out of scope.\n+ * Optionally (on by default) it will flush to disk as well.\n+ */\n+class CWalletDB\n {\n public:\n-    CWalletDB(const std::string& strFilename, const char* pszMode = \"r+\", bool _fFlushOnClose = true) : CDB(strFilename, pszMode, _fFlushOnClose)\n+    /** Takes a std::unique_ptr reference to avoid having to use",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9951#discussion_r105120742",
      "id" : 105120742,
      "original_commit_id" : "4ab3a72687c67379df0634c7c62ff88477b2af15",
      "original_position" : 15,
      "path" : "src/wallet/walletdb.h",
      "position" : null,
      "pull_request_review_id" : 25983520,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9951",
      "updated_at" : "2017-03-09T17:08:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105120742",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9951#discussion_r105191282"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9951"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105191282"
         }
      },
      "body" : "Better to use `const std::string& strFileName`, no copying and it's clear it won't be modified.",
      "commit_id" : "e3e51fdd3a9491ab4a07baed0a0f52b47ef70140",
      "created_at" : "2017-03-09T15:32:39Z",
      "diff_hunk" : "@@ -359,13 +359,12 @@ void CDBEnv::CheckpointLSN(const std::string& strFile)\n }\n \n \n-CDB::CDB(const std::string& strFilename, const char* pszMode, bool fFlushOnCloseIn) : pdb(NULL), activeTxn(NULL)\n+CDB::CDB(CWalletDBWrapper &dbw, const char* pszMode, bool fFlushOnCloseIn) : pdb(NULL), activeTxn(NULL)\n {\n     int ret;\n     fReadOnly = (!strchr(pszMode, '+') && !strchr(pszMode, 'w'));\n     fFlushOnClose = fFlushOnCloseIn;\n-    if (strFilename.empty())\n-        return;\n+    std::string strFilename = dbw.strWalletFile;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9951#discussion_r105191282",
      "id" : 105191282,
      "original_commit_id" : "757f0a7261c0b23f26aa9cf76eea8e83d9097d7d",
      "original_position" : 12,
      "path" : "src/wallet/db.cpp",
      "position" : null,
      "pull_request_review_id" : 26058623,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9951",
      "updated_at" : "2017-03-09T17:08:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105191282",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1225267?v=3",
         "events_url" : "https://api.github.com/users/benma/events{/privacy}",
         "followers_url" : "https://api.github.com/users/benma/followers",
         "following_url" : "https://api.github.com/users/benma/following{/other_user}",
         "gists_url" : "https://api.github.com/users/benma/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/benma",
         "id" : 1225267,
         "login" : "benma",
         "organizations_url" : "https://api.github.com/users/benma/orgs",
         "received_events_url" : "https://api.github.com/users/benma/received_events",
         "repos_url" : "https://api.github.com/users/benma/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/benma/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/benma/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/benma"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9951#discussion_r105191328"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9951"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105191328"
         }
      },
      "body" : "same",
      "commit_id" : "e3e51fdd3a9491ab4a07baed0a0f52b47ef70140",
      "created_at" : "2017-03-09T15:32:47Z",
      "diff_hunk" : "@@ -472,8 +471,11 @@ bool CDBEnv::RemoveDb(const std::string& strFile)\n     return (rc == 0);\n }\n \n-bool CDB::Rewrite(const std::string& strFile, const char* pszSkip)\n+bool CDB::Rewrite(CWalletDBWrapper &dbw, const char* pszSkip)\n {\n+    if (!dbw.env)\n+        return true;\n+    std::string strFile = dbw.strWalletFile;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9951#discussion_r105191328",
      "id" : 105191328,
      "original_commit_id" : "757f0a7261c0b23f26aa9cf76eea8e83d9097d7d",
      "original_position" : 25,
      "path" : "src/wallet/db.cpp",
      "position" : null,
      "pull_request_review_id" : 26058623,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9951",
      "updated_at" : "2017-03-09T17:08:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105191328",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1225267?v=3",
         "events_url" : "https://api.github.com/users/benma/events{/privacy}",
         "followers_url" : "https://api.github.com/users/benma/followers",
         "following_url" : "https://api.github.com/users/benma/following{/other_user}",
         "gists_url" : "https://api.github.com/users/benma/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/benma",
         "id" : 1225267,
         "login" : "benma",
         "organizations_url" : "https://api.github.com/users/benma/orgs",
         "received_events_url" : "https://api.github.com/users/benma/received_events",
         "repos_url" : "https://api.github.com/users/benma/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/benma/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/benma/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/benma"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9951#discussion_r105191387"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9951"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105191387"
         }
      },
      "body" : "same",
      "commit_id" : "e3e51fdd3a9491ab4a07baed0a0f52b47ef70140",
      "created_at" : "2017-03-09T15:32:58Z",
      "diff_hunk" : "@@ -596,9 +598,13 @@ void CDBEnv::Flush(bool fShutdown)\n     }\n }\n \n-bool CDB::PeriodicFlush(std::string strFile)\n+bool CDB::PeriodicFlush(CWalletDBWrapper *dbw)\n {\n     bool ret = false;\n+    if (!dbw) {\n+        return true;\n+    }\n+    std::string strFile = dbw->strWalletFile;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9951#discussion_r105191387",
      "id" : 105191387,
      "original_commit_id" : "757f0a7261c0b23f26aa9cf76eea8e83d9097d7d",
      "original_position" : 49,
      "path" : "src/wallet/db.cpp",
      "position" : null,
      "pull_request_review_id" : 26058623,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9951",
      "updated_at" : "2017-03-09T17:08:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105191387",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1225267?v=3",
         "events_url" : "https://api.github.com/users/benma/events{/privacy}",
         "followers_url" : "https://api.github.com/users/benma/followers",
         "following_url" : "https://api.github.com/users/benma/following{/other_user}",
         "gists_url" : "https://api.github.com/users/benma/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/benma",
         "id" : 1225267,
         "login" : "benma",
         "organizations_url" : "https://api.github.com/users/benma/orgs",
         "received_events_url" : "https://api.github.com/users/benma/received_events",
         "repos_url" : "https://api.github.com/users/benma/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/benma/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/benma/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/benma"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9951#discussion_r105191688"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9951"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105191688"
         }
      },
      "body" : "Better to move the check to the top, above `bool ret`.",
      "commit_id" : "e3e51fdd3a9491ab4a07baed0a0f52b47ef70140",
      "created_at" : "2017-03-09T15:34:08Z",
      "diff_hunk" : "@@ -596,9 +598,13 @@ void CDBEnv::Flush(bool fShutdown)\n     }\n }\n \n-bool CDB::PeriodicFlush(std::string strFile)\n+bool CDB::PeriodicFlush(CWalletDBWrapper *dbw)\n {\n     bool ret = false;\n+    if (!dbw) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9951#discussion_r105191688",
      "id" : 105191688,
      "original_commit_id" : "757f0a7261c0b23f26aa9cf76eea8e83d9097d7d",
      "original_position" : 46,
      "path" : "src/wallet/db.cpp",
      "position" : null,
      "pull_request_review_id" : 26058623,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9951",
      "updated_at" : "2017-03-09T17:08:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105191688",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1225267?v=3",
         "events_url" : "https://api.github.com/users/benma/events{/privacy}",
         "followers_url" : "https://api.github.com/users/benma/followers",
         "following_url" : "https://api.github.com/users/benma/following{/other_user}",
         "gists_url" : "https://api.github.com/users/benma/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/benma",
         "id" : 1225267,
         "login" : "benma",
         "organizations_url" : "https://api.github.com/users/benma/orgs",
         "received_events_url" : "https://api.github.com/users/benma/received_events",
         "repos_url" : "https://api.github.com/users/benma/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/benma/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/benma/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/benma"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9951#discussion_r105191969"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9951"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105191969"
         }
      },
      "body" : "Inconsistent style with using/skipping braces (above, you used braces, here, you don't). I'd add them.",
      "commit_id" : "e3e51fdd3a9491ab4a07baed0a0f52b47ef70140",
      "created_at" : "2017-03-09T15:35:16Z",
      "diff_hunk" : "@@ -633,3 +639,44 @@ bool CDB::PeriodicFlush(std::string strFile)\n \n     return ret;\n }\n+\n+bool CWalletDBWrapper::Rewrite(const char* pszSkip)\n+{\n+    return CDB::Rewrite(*this, pszSkip);\n+}\n+\n+bool CWalletDBWrapper::Backup(const std::string& strDest)\n+{\n+    if (!env)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9951#discussion_r105191969",
      "id" : 105191969,
      "original_commit_id" : "757f0a7261c0b23f26aa9cf76eea8e83d9097d7d",
      "original_position" : 65,
      "path" : "src/wallet/db.cpp",
      "position" : null,
      "pull_request_review_id" : 26058623,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9951",
      "updated_at" : "2017-03-09T17:08:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105191969",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1225267?v=3",
         "events_url" : "https://api.github.com/users/benma/events{/privacy}",
         "followers_url" : "https://api.github.com/users/benma/followers",
         "following_url" : "https://api.github.com/users/benma/following{/other_user}",
         "gists_url" : "https://api.github.com/users/benma/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/benma",
         "id" : 1225267,
         "login" : "benma",
         "organizations_url" : "https://api.github.com/users/benma/orgs",
         "received_events_url" : "https://api.github.com/users/benma/received_events",
         "repos_url" : "https://api.github.com/users/benma/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/benma/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/benma/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/benma"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9951#discussion_r105192424"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9951"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105192424"
         }
      },
      "body" : "const std::string",
      "commit_id" : "e3e51fdd3a9491ab4a07baed0a0f52b47ef70140",
      "created_at" : "2017-03-09T15:37:01Z",
      "diff_hunk" : "@@ -87,6 +87,33 @@ class CDBEnv\n \n extern CDBEnv bitdb;\n \n+/** An instance of this class represents one database.\n+ * For BerkeleyDB this is just a (env, strWalletFile) tuple.\n+ **/\n+class CWalletDBWrapper\n+{\n+public:\n+    CWalletDBWrapper(CDBEnv *env_in, const std::string &strWalletFile_in):\n+        env(env_in), strWalletFile(strWalletFile_in)\n+    {\n+    }\n+\n+    /** Rewrite the entire database on disk, with the exception of key pszSkip if non-zero\n+     */\n+    bool Rewrite(const char* pszSkip=nullptr);\n+\n+    /** Back up the entire database to a file.\n+     */\n+    bool Backup(const std::string& strDest);\n+\n+    /** Get a name for this database, for debugging etc.\n+     */\n+    std::string GetName() { return strWalletFile; }\n+\n+    CDBEnv *env;\n+    std::string strWalletFile;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9951#discussion_r105192424",
      "id" : 105192424,
      "original_commit_id" : "757f0a7261c0b23f26aa9cf76eea8e83d9097d7d",
      "original_position" : 28,
      "path" : "src/wallet/db.h",
      "position" : null,
      "pull_request_review_id" : 26058623,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9951",
      "updated_at" : "2017-03-09T17:08:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105192424",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1225267?v=3",
         "events_url" : "https://api.github.com/users/benma/events{/privacy}",
         "followers_url" : "https://api.github.com/users/benma/followers",
         "following_url" : "https://api.github.com/users/benma/following{/other_user}",
         "gists_url" : "https://api.github.com/users/benma/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/benma",
         "id" : 1225267,
         "login" : "benma",
         "organizations_url" : "https://api.github.com/users/benma/orgs",
         "received_events_url" : "https://api.github.com/users/benma/received_events",
         "repos_url" : "https://api.github.com/users/benma/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/benma/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/benma/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/benma"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9951#discussion_r105192897"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9951"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105192897"
         }
      },
      "body" : "`std::string GetName() const`\r\n\r\nYou have this function, and the public `strWalletFile`, which you access directly in other places. Maybe `strWalletFile` should be made private, or alternatively, this function removed.",
      "commit_id" : "e3e51fdd3a9491ab4a07baed0a0f52b47ef70140",
      "created_at" : "2017-03-09T15:38:31Z",
      "diff_hunk" : "@@ -87,6 +87,33 @@ class CDBEnv\n \n extern CDBEnv bitdb;\n \n+/** An instance of this class represents one database.\n+ * For BerkeleyDB this is just a (env, strWalletFile) tuple.\n+ **/\n+class CWalletDBWrapper\n+{\n+public:\n+    CWalletDBWrapper(CDBEnv *env_in, const std::string &strWalletFile_in):\n+        env(env_in), strWalletFile(strWalletFile_in)\n+    {\n+    }\n+\n+    /** Rewrite the entire database on disk, with the exception of key pszSkip if non-zero\n+     */\n+    bool Rewrite(const char* pszSkip=nullptr);\n+\n+    /** Back up the entire database to a file.\n+     */\n+    bool Backup(const std::string& strDest);\n+\n+    /** Get a name for this database, for debugging etc.\n+     */\n+    std::string GetName() { return strWalletFile; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9951#discussion_r105192897",
      "id" : 105192897,
      "original_commit_id" : "757f0a7261c0b23f26aa9cf76eea8e83d9097d7d",
      "original_position" : 25,
      "path" : "src/wallet/db.h",
      "position" : null,
      "pull_request_review_id" : 26058623,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9951",
      "updated_at" : "2017-03-09T17:08:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105192897",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1225267?v=3",
         "events_url" : "https://api.github.com/users/benma/events{/privacy}",
         "followers_url" : "https://api.github.com/users/benma/followers",
         "following_url" : "https://api.github.com/users/benma/following{/other_user}",
         "gists_url" : "https://api.github.com/users/benma/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/benma",
         "id" : 1225267,
         "login" : "benma",
         "organizations_url" : "https://api.github.com/users/benma/orgs",
         "received_events_url" : "https://api.github.com/users/benma/received_events",
         "repos_url" : "https://api.github.com/users/benma/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/benma/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/benma/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/benma"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9951#discussion_r105193519"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9951"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105193519"
         }
      },
      "body" : "`GetName() const`",
      "commit_id" : "e3e51fdd3a9491ab4a07baed0a0f52b47ef70140",
      "created_at" : "2017-03-09T15:40:52Z",
      "diff_hunk" : "@@ -653,17 +653,35 @@ class CWallet : public CCryptoKeyStore, public CValidationInterface\n      */\n     bool AddWatchOnly(const CScript& dest) override;\n \n+    std::unique_ptr<CWalletDBWrapper> dbw;\n+\n public:\n     /*\n      * Main wallet lock.\n      * This lock protects all the fields added by CWallet\n      *   except for:\n      *      fFileBacked (immutable after instantiation)\n-     *      strWalletFile (immutable after instantiation)\n      */\n     mutable CCriticalSection cs_wallet;\n \n-    const std::string strWalletFile;\n+    /** Get database handle used by this wallet. Ideally this function would\n+     * not be necessary.\n+     */\n+    CWalletDBWrapper *GetDBHandle()\n+    {\n+        return dbw.get();\n+    }\n+\n+    /** Get a name for this wallet for logging/debugging purposes.\n+     */\n+    std::string GetName()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9951#discussion_r105193519",
      "id" : 105193519,
      "original_commit_id" : "757f0a7261c0b23f26aa9cf76eea8e83d9097d7d",
      "original_position" : 27,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 26058623,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9951",
      "updated_at" : "2017-03-09T17:08:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105193519",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1225267?v=3",
         "events_url" : "https://api.github.com/users/benma/events{/privacy}",
         "followers_url" : "https://api.github.com/users/benma/followers",
         "following_url" : "https://api.github.com/users/benma/following{/other_user}",
         "gists_url" : "https://api.github.com/users/benma/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/benma",
         "id" : 1225267,
         "login" : "benma",
         "organizations_url" : "https://api.github.com/users/benma/orgs",
         "received_events_url" : "https://api.github.com/users/benma/received_events",
         "repos_url" : "https://api.github.com/users/benma/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/benma/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/benma/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/benma"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9951#discussion_r105193794"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9951"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105193794"
         }
      },
      "body" : "Maybe it is a matter of personal preference, but I always find it odd to put an `else` when the `if` returns.",
      "commit_id" : "e3e51fdd3a9491ab4a07baed0a0f52b47ef70140",
      "created_at" : "2017-03-09T15:41:48Z",
      "diff_hunk" : "@@ -653,17 +653,35 @@ class CWallet : public CCryptoKeyStore, public CValidationInterface\n      */\n     bool AddWatchOnly(const CScript& dest) override;\n \n+    std::unique_ptr<CWalletDBWrapper> dbw;\n+\n public:\n     /*\n      * Main wallet lock.\n      * This lock protects all the fields added by CWallet\n      *   except for:\n      *      fFileBacked (immutable after instantiation)\n-     *      strWalletFile (immutable after instantiation)\n      */\n     mutable CCriticalSection cs_wallet;\n \n-    const std::string strWalletFile;\n+    /** Get database handle used by this wallet. Ideally this function would\n+     * not be necessary.\n+     */\n+    CWalletDBWrapper *GetDBHandle()\n+    {\n+        return dbw.get();\n+    }\n+\n+    /** Get a name for this wallet for logging/debugging purposes.\n+     */\n+    std::string GetName()\n+    {\n+        if (dbw) {\n+            return dbw->GetName();\n+        } else {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9951#discussion_r105193794",
      "id" : 105193794,
      "original_commit_id" : "757f0a7261c0b23f26aa9cf76eea8e83d9097d7d",
      "original_position" : 31,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 26058623,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9951",
      "updated_at" : "2017-03-09T17:08:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105193794",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1225267?v=3",
         "events_url" : "https://api.github.com/users/benma/events{/privacy}",
         "followers_url" : "https://api.github.com/users/benma/followers",
         "following_url" : "https://api.github.com/users/benma/following{/other_user}",
         "gists_url" : "https://api.github.com/users/benma/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/benma",
         "id" : 1225267,
         "login" : "benma",
         "organizations_url" : "https://api.github.com/users/benma/orgs",
         "received_events_url" : "https://api.github.com/users/benma/received_events",
         "repos_url" : "https://api.github.com/users/benma/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/benma/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/benma/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/benma"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9951#discussion_r105200324"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9951"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105200324"
         }
      },
      "body" : "They are subtly different, only happen to be the same for BerkeleyDB: \r\n\r\n- `GetName` is an an abstract name to refer to the database object for logging or troubleshooting. It should exist for any version of CDBWrapper.\r\n- `strWalletFile` is an implementation detail that only exists for BerkeleyDB. Other databases may have completely different connection descriptions, which do not involve simply a string. So this is private to the low-level implementation (CDB, CWalletDBWrapper), the higher-level stuff (such as CWallet) should not refer to it.",
      "commit_id" : "e3e51fdd3a9491ab4a07baed0a0f52b47ef70140",
      "created_at" : "2017-03-09T16:04:32Z",
      "diff_hunk" : "@@ -87,6 +87,33 @@ class CDBEnv\n \n extern CDBEnv bitdb;\n \n+/** An instance of this class represents one database.\n+ * For BerkeleyDB this is just a (env, strWalletFile) tuple.\n+ **/\n+class CWalletDBWrapper\n+{\n+public:\n+    CWalletDBWrapper(CDBEnv *env_in, const std::string &strWalletFile_in):\n+        env(env_in), strWalletFile(strWalletFile_in)\n+    {\n+    }\n+\n+    /** Rewrite the entire database on disk, with the exception of key pszSkip if non-zero\n+     */\n+    bool Rewrite(const char* pszSkip=nullptr);\n+\n+    /** Back up the entire database to a file.\n+     */\n+    bool Backup(const std::string& strDest);\n+\n+    /** Get a name for this database, for debugging etc.\n+     */\n+    std::string GetName() { return strWalletFile; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9951#discussion_r105200324",
      "id" : 105200324,
      "original_commit_id" : "757f0a7261c0b23f26aa9cf76eea8e83d9097d7d",
      "original_position" : 25,
      "path" : "src/wallet/db.h",
      "position" : null,
      "pull_request_review_id" : 26068144,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9951",
      "updated_at" : "2017-03-09T17:08:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105200324",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9951#discussion_r105200892"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9951"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105200892"
         }
      },
      "body" : "I prefer to keep it this way. We have no guideline on this in `doc/developer-notes.md`, and I personally find it easier to follow the control flow this way.",
      "commit_id" : "e3e51fdd3a9491ab4a07baed0a0f52b47ef70140",
      "created_at" : "2017-03-09T16:06:30Z",
      "diff_hunk" : "@@ -653,17 +653,35 @@ class CWallet : public CCryptoKeyStore, public CValidationInterface\n      */\n     bool AddWatchOnly(const CScript& dest) override;\n \n+    std::unique_ptr<CWalletDBWrapper> dbw;\n+\n public:\n     /*\n      * Main wallet lock.\n      * This lock protects all the fields added by CWallet\n      *   except for:\n      *      fFileBacked (immutable after instantiation)\n-     *      strWalletFile (immutable after instantiation)\n      */\n     mutable CCriticalSection cs_wallet;\n \n-    const std::string strWalletFile;\n+    /** Get database handle used by this wallet. Ideally this function would\n+     * not be necessary.\n+     */\n+    CWalletDBWrapper *GetDBHandle()\n+    {\n+        return dbw.get();\n+    }\n+\n+    /** Get a name for this wallet for logging/debugging purposes.\n+     */\n+    std::string GetName()\n+    {\n+        if (dbw) {\n+            return dbw->GetName();\n+        } else {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9951#discussion_r105200892",
      "id" : 105200892,
      "original_commit_id" : "757f0a7261c0b23f26aa9cf76eea8e83d9097d7d",
      "original_position" : 31,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 26068751,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9951",
      "updated_at" : "2017-03-09T17:08:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105200892",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9951#discussion_r105201207"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9951"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105201207"
         }
      },
      "body" : "Could make this clearer using \"friend\" I guess.",
      "commit_id" : "e3e51fdd3a9491ab4a07baed0a0f52b47ef70140",
      "created_at" : "2017-03-09T16:07:43Z",
      "diff_hunk" : "@@ -87,6 +87,33 @@ class CDBEnv\n \n extern CDBEnv bitdb;\n \n+/** An instance of this class represents one database.\n+ * For BerkeleyDB this is just a (env, strWalletFile) tuple.\n+ **/\n+class CWalletDBWrapper\n+{\n+public:\n+    CWalletDBWrapper(CDBEnv *env_in, const std::string &strWalletFile_in):\n+        env(env_in), strWalletFile(strWalletFile_in)\n+    {\n+    }\n+\n+    /** Rewrite the entire database on disk, with the exception of key pszSkip if non-zero\n+     */\n+    bool Rewrite(const char* pszSkip=nullptr);\n+\n+    /** Back up the entire database to a file.\n+     */\n+    bool Backup(const std::string& strDest);\n+\n+    /** Get a name for this database, for debugging etc.\n+     */\n+    std::string GetName() { return strWalletFile; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9951#discussion_r105201207",
      "id" : 105201207,
      "original_commit_id" : "757f0a7261c0b23f26aa9cf76eea8e83d9097d7d",
      "original_position" : 25,
      "path" : "src/wallet/db.h",
      "position" : null,
      "pull_request_review_id" : 26069122,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9951",
      "updated_at" : "2017-03-09T17:08:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105201207",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9951#discussion_r105201563"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9951"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105201563"
         }
      },
      "body" : "Agreed.",
      "commit_id" : "e3e51fdd3a9491ab4a07baed0a0f52b47ef70140",
      "created_at" : "2017-03-09T16:09:01Z",
      "diff_hunk" : "@@ -359,13 +359,12 @@ void CDBEnv::CheckpointLSN(const std::string& strFile)\n }\n \n \n-CDB::CDB(const std::string& strFilename, const char* pszMode, bool fFlushOnCloseIn) : pdb(NULL), activeTxn(NULL)\n+CDB::CDB(CWalletDBWrapper &dbw, const char* pszMode, bool fFlushOnCloseIn) : pdb(NULL), activeTxn(NULL)\n {\n     int ret;\n     fReadOnly = (!strchr(pszMode, '+') && !strchr(pszMode, 'w'));\n     fFlushOnClose = fFlushOnCloseIn;\n-    if (strFilename.empty())\n-        return;\n+    std::string strFilename = dbw.strWalletFile;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9951#discussion_r105201563",
      "id" : 105201563,
      "original_commit_id" : "757f0a7261c0b23f26aa9cf76eea8e83d9097d7d",
      "original_position" : 12,
      "path" : "src/wallet/db.cpp",
      "position" : null,
      "pull_request_review_id" : 26069514,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9951",
      "updated_at" : "2017-03-09T17:08:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105201563",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9951#discussion_r105201911"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9951"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105201911"
         }
      },
      "body" : "Yes the brace should be after",
      "commit_id" : "e3e51fdd3a9491ab4a07baed0a0f52b47ef70140",
      "created_at" : "2017-03-09T16:10:20Z",
      "diff_hunk" : "@@ -633,3 +639,44 @@ bool CDB::PeriodicFlush(std::string strFile)\n \n     return ret;\n }\n+\n+bool CWalletDBWrapper::Rewrite(const char* pszSkip)\n+{\n+    return CDB::Rewrite(*this, pszSkip);\n+}\n+\n+bool CWalletDBWrapper::Backup(const std::string& strDest)\n+{\n+    if (!env)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9951#discussion_r105201911",
      "id" : 105201911,
      "original_commit_id" : "757f0a7261c0b23f26aa9cf76eea8e83d9097d7d",
      "original_position" : 65,
      "path" : "src/wallet/db.cpp",
      "position" : null,
      "pull_request_review_id" : 26069855,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9951",
      "updated_at" : "2017-03-09T17:08:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105201911",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9951#discussion_r105202223"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9951"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105202223"
         }
      },
      "body" : "Yes good catch.",
      "commit_id" : "e3e51fdd3a9491ab4a07baed0a0f52b47ef70140",
      "created_at" : "2017-03-09T16:11:29Z",
      "diff_hunk" : "@@ -653,17 +653,35 @@ class CWallet : public CCryptoKeyStore, public CValidationInterface\n      */\n     bool AddWatchOnly(const CScript& dest) override;\n \n+    std::unique_ptr<CWalletDBWrapper> dbw;\n+\n public:\n     /*\n      * Main wallet lock.\n      * This lock protects all the fields added by CWallet\n      *   except for:\n      *      fFileBacked (immutable after instantiation)\n-     *      strWalletFile (immutable after instantiation)\n      */\n     mutable CCriticalSection cs_wallet;\n \n-    const std::string strWalletFile;\n+    /** Get database handle used by this wallet. Ideally this function would\n+     * not be necessary.\n+     */\n+    CWalletDBWrapper *GetDBHandle()\n+    {\n+        return dbw.get();\n+    }\n+\n+    /** Get a name for this wallet for logging/debugging purposes.\n+     */\n+    std::string GetName()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9951#discussion_r105202223",
      "id" : 105202223,
      "original_commit_id" : "757f0a7261c0b23f26aa9cf76eea8e83d9097d7d",
      "original_position" : 27,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 26070180,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9951",
      "updated_at" : "2017-03-09T17:08:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105202223",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Fixed @benma's nits.",
      "created_at" : "2017-03-09T16:46:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9951#issuecomment-285408213",
      "id" : 285408213,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9951",
      "updated_at" : "2017-03-09T16:46:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/285408213",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9951#discussion_r105220521"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9951"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105220521"
         }
      },
      "body" : "`const std::string strFile;` ?",
      "commit_id" : "e3e51fdd3a9491ab4a07baed0a0f52b47ef70140",
      "created_at" : "2017-03-09T17:20:47Z",
      "diff_hunk" : "@@ -87,6 +87,36 @@ class CDBEnv\n \n extern CDBEnv bitdb;\n \n+/** An instance of this class represents one database.\n+ * For BerkeleyDB this is just a (env, strFile) tuple.\n+ **/\n+class CWalletDBWrapper\n+{\n+    friend class CDB;\n+public:\n+    CWalletDBWrapper(CDBEnv *env_in, const std::string &strFile_in):\n+        env(env_in), strFile(strFile_in)\n+    {\n+    }\n+\n+    /** Rewrite the entire database on disk, with the exception of key pszSkip if non-zero\n+     */\n+    bool Rewrite(const char* pszSkip=nullptr);\n+\n+    /** Back up the entire database to a file.\n+     */\n+    bool Backup(const std::string& strDest);\n+\n+    /** Get a name for this database, for debugging etc.\n+     */\n+    std::string GetName() const { return strFile; }\n+\n+private:\n+    /** BerkeleyDB specific */\n+    CDBEnv *env;\n+    std::string strFile;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9951#discussion_r105220521",
      "id" : 105220521,
      "original_commit_id" : "b2db6c3a08811f509bb9a848144343816d11bf20",
      "original_position" : 31,
      "path" : "src/wallet/db.h",
      "position" : 47,
      "pull_request_review_id" : 26089636,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9951",
      "updated_at" : "2017-03-09T17:20:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105220521",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1225267?v=3",
         "events_url" : "https://api.github.com/users/benma/events{/privacy}",
         "followers_url" : "https://api.github.com/users/benma/followers",
         "following_url" : "https://api.github.com/users/benma/following{/other_user}",
         "gists_url" : "https://api.github.com/users/benma/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/benma",
         "id" : 1225267,
         "login" : "benma",
         "organizations_url" : "https://api.github.com/users/benma/orgs",
         "received_events_url" : "https://api.github.com/users/benma/received_events",
         "repos_url" : "https://api.github.com/users/benma/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/benma/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/benma/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/benma"
      }
   },
   {
      "body" : "For my understanding: the refactor to support a different db backend than BerkeleyDB is not finished with this PR, right? It is a bit hard to see through `CDBEnv`, `CDB` and `CWalletDBWrapper`, but `CDB` looks half-finished: it still refers to the walletFile string in most functions instead of going through `CWalletDBWrapper`.\r\n\r\nAlso, berkeley-specific fields are in `CWalletDBWrapper`. If you want to use a different backend that doesn't rely on a filename, where would that fit in? Would that end up in two classes inheriting from `CWalletDBWrapper`, and moving the berkeley-specific stuff out of it?\r\n\r\n> The eventual goal of \"CWalletDBWrapper\" is like \"CDBWrapper\", to move further database functionality there from \"CDB\" (which is really a \"CDBBatch\", a database transaction object). Not renaming it nor CWalletDB here to not interfere unduly much with other open wallet pull\r\n\r\nIn the end, is there even a need for the class `CDB` anymore? ",
      "created_at" : "2017-03-09T18:06:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9951#issuecomment-285431311",
      "id" : 285431311,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9951",
      "updated_at" : "2017-03-09T18:06:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/285431311",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1225267?v=3",
         "events_url" : "https://api.github.com/users/benma/events{/privacy}",
         "followers_url" : "https://api.github.com/users/benma/followers",
         "following_url" : "https://api.github.com/users/benma/following{/other_user}",
         "gists_url" : "https://api.github.com/users/benma/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/benma",
         "id" : 1225267,
         "login" : "benma",
         "organizations_url" : "https://api.github.com/users/benma/orgs",
         "received_events_url" : "https://api.github.com/users/benma/received_events",
         "repos_url" : "https://api.github.com/users/benma/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/benma/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/benma/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/benma"
      }
   }
]
