[
   {
      "author_association" : "MEMBER",
      "body" : "My assumption is that those TODOs would be taken care of as part of #18807. Is that correct @amitiuttarwar ?",
      "created_at" : "2020-05-06T00:42:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18895#issuecomment-624381434",
      "id" : 624381434,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18895",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyNDM4MTQzNA==",
      "updated_at" : "2020-05-06T00:42:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/624381434",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@fanquake sorry for the confusion ð\r\n@gzhao408 offered to implement these follow ups, so I asked her to open a PR so I & others could review. I was thinking (now that this PR is open), I'd update #18807 to let reviewers know, & focus that PR on updates to release notes and tests. \r\ndoes that seem reasonable? ",
      "created_at" : "2020-05-06T02:02:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18895#issuecomment-624404573",
      "id" : 624404573,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18895",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyNDQwNDU3Mw==",
      "updated_at" : "2020-05-06T02:02:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/624404573",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> does that seem reasonable?\r\n\r\n@amitiuttarwar Yea of course. Just wanted to clarify that you weren't both working on the same changes in parallel.",
      "created_at" : "2020-05-06T02:06:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18895#issuecomment-624405490",
      "id" : 624405490,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18895",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyNDQwNTQ5MA==",
      "updated_at" : "2020-05-06T02:06:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/624405490",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@fanquake thanks!\r\n\r\nConcept ACK :) will review soon ",
      "created_at" : "2020-05-06T02:11:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18895#issuecomment-624406521",
      "id" : 624406521,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18895",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyNDQwNjUyMQ==",
      "updated_at" : "2020-05-06T02:11:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/624406521",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18895#discussion_r420908838"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18895"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420908838"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n        if (m_mempool.exists(txid)) {\r\n```\r\n\r\nstyle-nit: (feel free to ignore)\r\n\r\nWhen an `if` has an else branch, I generally recommend not using inversion in the condition, just to avoid double negation, which can make code harder to read. Obviously not an issue here, so feel free to ignore.\r\n\r\nHowever, while this fights the symptom (unbroadcast txid exists), it doesn't prevent it from happening. Also, `RelayTransaction` is hopefully already a noop if the txid does not exist.\r\n\r\nWhat do you think about adding this check to the mempool member function that adds the unbroadcast transactions to the set? This way, the error will be caught as early as possible.",
      "commit_id" : "7abdadf113a4071bc73eff14cefa8ebaa6ae101d",
      "created_at" : "2020-05-06T16:02:54Z",
      "diff_hunk" : "@@ -815,7 +815,12 @@ void PeerLogicValidation::ReattemptInitialBroadcast(CScheduler& scheduler) const\n     std::set<uint256> unbroadcast_txids = m_mempool.GetUnbroadcastTxs();\n \n     for (const uint256& txid : unbroadcast_txids) {\n-        RelayTransaction(txid, *connman);\n+        // Sanity check: all unbroadcast txns should exist in the mempool\n+        if (!m_mempool.exists(txid)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18895#discussion_r420908838",
      "id" : 420908838,
      "line" : 819,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDkwODgzOA==",
      "original_commit_id" : "7abdadf113a4071bc73eff14cefa8ebaa6ae101d",
      "original_line" : 819,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 6,
      "pull_request_review_id" : 406762220,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18895",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-06T16:07:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420908838",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18895#discussion_r420910109"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18895"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420910109"
         }
      },
      "author_association" : "MEMBER",
      "body" : "style-nit: instead of a \"blind cast\" I slightly prefer the one that enables compile time checks and fails compilation in case it should be impossible to cast without loss of precision.\r\n\r\n```suggestion\r\n    ret.pushKV(\"unbroadcastsize\", int64_t{pool.GetUnbroadcastTxs().size())};\r\n```",
      "commit_id" : "7abdadf113a4071bc73eff14cefa8ebaa6ae101d",
      "created_at" : "2020-05-06T16:04:46Z",
      "diff_hunk" : "@@ -1389,6 +1391,7 @@ UniValue MempoolInfoToJSON(const CTxMemPool& pool)\n     ret.pushKV(\"maxmempool\", (int64_t) maxmempool);\n     ret.pushKV(\"mempoolminfee\", ValueFromAmount(std::max(pool.GetMinFee(maxmempool), ::minRelayTxFee).GetFeePerK()));\n     ret.pushKV(\"minrelaytxfee\", ValueFromAmount(::minRelayTxFee.GetFeePerK()));\n+    ret.pushKV(\"unbroadcastsize\", (int64_t)pool.GetUnbroadcastTxs().size());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18895#discussion_r420910109",
      "id" : 420910109,
      "line" : 1394,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDkxMDEwOQ==",
      "original_commit_id" : "7abdadf113a4071bc73eff14cefa8ebaa6ae101d",
      "original_line" : 1394,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 20,
      "pull_request_review_id" : 406762220,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18895",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-06T16:07:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420910109",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18895#discussion_r421008446"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18895"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421008446"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Good point about inversion on an if+else, I'll rearrange to make it more clear.\r\n\r\nYeah, I think it'd make sense to add this check to `AddUnbroadcastTx` ([here](https://github.com/bitcoin/bitcoin/blob/7bcc42b4035b878719d13201286e322989b415c5/src/txmempool.h#L705)).\r\nApart from making sure we only add txids that exist in the mempool to unbroadcast, I think this sanity check helps if a tx was removed from the mempool but somehow stayed in the unbroadcast set - which shouldn't happen, but just in case?",
      "commit_id" : "7abdadf113a4071bc73eff14cefa8ebaa6ae101d",
      "created_at" : "2020-05-06T18:37:28Z",
      "diff_hunk" : "@@ -815,7 +815,12 @@ void PeerLogicValidation::ReattemptInitialBroadcast(CScheduler& scheduler) const\n     std::set<uint256> unbroadcast_txids = m_mempool.GetUnbroadcastTxs();\n \n     for (const uint256& txid : unbroadcast_txids) {\n-        RelayTransaction(txid, *connman);\n+        // Sanity check: all unbroadcast txns should exist in the mempool\n+        if (!m_mempool.exists(txid)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18895#discussion_r421008446",
      "id" : 421008446,
      "in_reply_to_id" : 420908838,
      "line" : 819,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAwODQ0Ng==",
      "original_commit_id" : "7abdadf113a4071bc73eff14cefa8ebaa6ae101d",
      "original_line" : 819,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 6,
      "pull_request_review_id" : 406885157,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18895",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-06T18:37:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421008446",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/gzhao408/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gzhao408/followers",
         "following_url" : "https://api.github.com/users/gzhao408/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gzhao408/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gzhao408",
         "id" : 25183001,
         "login" : "gzhao408",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/gzhao408/orgs",
         "received_events_url" : "https://api.github.com/users/gzhao408/received_events",
         "repos_url" : "https://api.github.com/users/gzhao408/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gzhao408/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gzhao408/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gzhao408"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18895#discussion_r421014509"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18895"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421014509"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Jup, better to do the check in two places than in one. This needs a mempool lookup, but the cost doesn't seem too much, as this is only done every 10 minutes or when a new transaction is added to the mempool anyway.",
      "commit_id" : "7abdadf113a4071bc73eff14cefa8ebaa6ae101d",
      "created_at" : "2020-05-06T18:47:28Z",
      "diff_hunk" : "@@ -815,7 +815,12 @@ void PeerLogicValidation::ReattemptInitialBroadcast(CScheduler& scheduler) const\n     std::set<uint256> unbroadcast_txids = m_mempool.GetUnbroadcastTxs();\n \n     for (const uint256& txid : unbroadcast_txids) {\n-        RelayTransaction(txid, *connman);\n+        // Sanity check: all unbroadcast txns should exist in the mempool\n+        if (!m_mempool.exists(txid)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18895#discussion_r421014509",
      "id" : 421014509,
      "in_reply_to_id" : 420908838,
      "line" : 819,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAxNDUwOQ==",
      "original_commit_id" : "7abdadf113a4071bc73eff14cefa8ebaa6ae101d",
      "original_line" : 819,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 6,
      "pull_request_review_id" : 406892494,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18895",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-06T18:47:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421014509",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK. Code looks good, will do ACK when @MarcoFalke comments are addressed.",
      "created_at" : "2020-05-07T13:21:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18895#issuecomment-625251641",
      "id" : 625251641,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18895",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyNTI1MTY0MQ==",
      "updated_at" : "2020-05-07T13:21:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/625251641",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   }
]
