[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #18592 (rpc: replace raw pointers with shared_ptrs by brakmic)\n* #18452 (qt: Fix shutdown when waitfor* cmds are called from RPC console by hebasto)\n* #18354 (Protect wallet by using shared pointers by bvbfan)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-04-29T10:56:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18814#issuecomment-621127303",
      "id" : 621127303,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18814",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMTEyNzMwMw==",
      "updated_at" : "2020-04-29T10:56:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/621127303",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18814#discussion_r417262916"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18814"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417262916"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think this could introduce a bug where wallet never relocks.\r\n\r\nIn case where walletpassphrase is called from two threads, first thread sets `pwallet->nRelockTime` and is interrupted after constructing lambda but before invoking rpcRunLater. Second thread sets `pwallet->nRelockTime` to a different value and calls `rpcRunLater`, and then first thread wakes up and calls `rpcRunLater`.\r\n\r\nLambda from second thread never runs because lambda from first thread replaced it. But lambda from first thread has the wrong `relock_time` value so never relocks the wallet.\r\n\r\nSimplest fix might be adding relock time to timer names \"lockwallet(%s,%i)\" above to make them unique",
      "commit_id" : "5a0486cd15c26e5e587f56f331dec3a7756407b2",
      "created_at" : "2020-04-29T12:04:35Z",
      "diff_hunk" : "@@ -1957,9 +1959,11 @@ static UniValue walletpassphrase(const JSONRPCRequest& request)\n     // wallet before the following callback is called. If a valid shared pointer\n     // is acquired in the callback then the wallet is still loaded.\n     std::weak_ptr<CWallet> weak_wallet = wallet;\n-    pwallet->chain().rpcRunLater(strprintf(\"lockwallet(%s)\", pwallet->GetName()), [weak_wallet] {\n+    pwallet->chain().rpcRunLater(strprintf(\"lockwallet(%s)\", pwallet->GetName()), [weak_wallet, relock_time] {\n         if (auto shared_wallet = weak_wallet.lock()) {\n             LOCK(shared_wallet->cs_wallet);\n+            // Skip if this is not the most recent rpcRunLater callback.\n+            if (shared_wallet->nRelockTime != relock_time) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18814#discussion_r417262916",
      "id" : 417262916,
      "line" : 1966,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI2MjkxNg==",
      "original_commit_id" : "5a0486cd15c26e5e587f56f331dec3a7756407b2",
      "original_line" : 1966,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : 25,
      "pull_request_review_id" : 402600925,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18814",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-29T12:04:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417262916",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Would be nice to write a test for this",
      "created_at" : "2020-04-29T12:22:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18814#issuecomment-621167692",
      "id" : 621167692,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18814",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMTE2NzY5Mg==",
      "updated_at" : "2020-04-29T12:22:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/621167692",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18814#discussion_r417276244"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18814"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417276244"
         }
      },
      "author_association" : "MEMBER",
      "body" : "That would make timers list grow - they are never removed, just replaced.\r\n\r\n",
      "commit_id" : "5a0486cd15c26e5e587f56f331dec3a7756407b2",
      "created_at" : "2020-04-29T12:29:09Z",
      "diff_hunk" : "@@ -1957,9 +1959,11 @@ static UniValue walletpassphrase(const JSONRPCRequest& request)\n     // wallet before the following callback is called. If a valid shared pointer\n     // is acquired in the callback then the wallet is still loaded.\n     std::weak_ptr<CWallet> weak_wallet = wallet;\n-    pwallet->chain().rpcRunLater(strprintf(\"lockwallet(%s)\", pwallet->GetName()), [weak_wallet] {\n+    pwallet->chain().rpcRunLater(strprintf(\"lockwallet(%s)\", pwallet->GetName()), [weak_wallet, relock_time] {\n         if (auto shared_wallet = weak_wallet.lock()) {\n             LOCK(shared_wallet->cs_wallet);\n+            // Skip if this is not the most recent rpcRunLater callback.\n+            if (shared_wallet->nRelockTime != relock_time) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18814#discussion_r417276244",
      "id" : 417276244,
      "in_reply_to_id" : 417262916,
      "line" : 1966,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzI3NjI0NA==",
      "original_commit_id" : "5a0486cd15c26e5e587f56f331dec3a7756407b2",
      "original_line" : 1966,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : 25,
      "pull_request_review_id" : 402617630,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18814",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-29T12:29:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417276244",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for reviewing @ryanofsky. I'll address that case.\r\n\r\n@MarcoFalke probably a unit test no?",
      "created_at" : "2020-04-29T12:38:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18814#issuecomment-621176155",
      "id" : 621176155,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18814",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMTE3NjE1NQ==",
      "updated_at" : "2020-04-29T12:38:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/621176155",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   }
]
