{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "MEMBER",
   "body" : "When answering GETDATA messages, some tests are employed to verify whether the recipient should in fact know we have that transaction (e.g. it has to be in the relay map, or in the mempool - but only if it's been there longer than our most recent BIP37 answer for that peer).\r\n\r\nI believe it is however still possible to GETDATA a transaction that we have just learned about (from another peer, or from our local wallet), and answer it before we have announced it to the requesting peer. Since we keep track of exactly the set of transactions we have recently learned that we haven't told each peer about - `setInventoryTxToSend` which is used to batch up what to announce - it's trivial to turn those into NOTFOUND responses instead.\r\n\r\nThe condition for responding now becomes:\r\n\r\n```\r\n  (not in setInventoryTxToSend) AND\r\n  (\r\n    (in relay map) OR\r\n    (\r\n      (in mempool) AND\r\n      (old enough that it could have expired from relay map) AND\r\n      (older then our last getmempool response)\r\n    )\r\n  )\r\n```",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 1,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18861/comments",
   "created_at" : "2020-05-04T07:20:31Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18861/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/18861",
   "id" : 611656010,
   "labels" : [
      {
         "color" : "006b75",
         "default" : false,
         "description" : null,
         "id" : 98298007,
         "name" : "P2P",
         "node_id" : "MDU6TGFiZWw5ODI5ODAwNw==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/P2P"
      },
      {
         "color" : "5319e7",
         "default" : false,
         "description" : null,
         "id" : 249581124,
         "name" : "Privacy",
         "node_id" : "MDU6TGFiZWwyNDk1ODExMjQ=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Privacy"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18861/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDExOlB1bGxSZXF1ZXN0NDEyNzc4ODEy",
   "number" : 18861,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/18861.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18861",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/18861.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18861"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "title" : "Do not answer GETDATA for to-be-announced tx",
   "updated_at" : "2020-05-04T07:52:14Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18861",
   "user" : {
      "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
      "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
      "followers_url" : "https://api.github.com/users/sipa/followers",
      "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/sipa",
      "id" : 548488,
      "login" : "sipa",
      "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
      "organizations_url" : "https://api.github.com/users/sipa/orgs",
      "received_events_url" : "https://api.github.com/users/sipa/received_events",
      "repos_url" : "https://api.github.com/users/sipa/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/sipa"
   }
}
