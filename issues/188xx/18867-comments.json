[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18867#discussion_r419431163"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18867"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/419431163"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n                if (e.what() != std::string{\"Attempted to overwrite an unspent coin (when possible_overwrite is false)\"}) raise e;\r\n```\r\n\r\nCould `expected_code_path` be removed with this fixup? If yes, that seems preferable, as it is less code.",
      "commit_id" : "ab7af9323e55bd035d2680a84e986675c7757ee3",
      "created_at" : "2020-05-04T13:22:40Z",
      "diff_hunk" : "@@ -0,0 +1,295 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <amount.h>\n+#include <chainparams.h>\n+#include <chainparamsbase.h>\n+#include <coins.h>\n+#include <consensus/tx_verify.h>\n+#include <consensus/validation.h>\n+#include <key.h>\n+#include <node/coinstats.h>\n+#include <optional.h>\n+#include <policy/policy.h>\n+#include <primitives/transaction.h>\n+#include <pubkey.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <validation.h>\n+\n+#include <cstdint>\n+#include <limits>\n+#include <string>\n+#include <vector>\n+\n+namespace {\n+const Coin EMPTY_COIN{};\n+\n+bool operator==(const Coin& a, const Coin& b)\n+{\n+    if (a.IsSpent() && b.IsSpent()) return true;\n+    return static_cast<bool>(a.fCoinBase) == static_cast<bool>(b.fCoinBase) && a.nHeight == b.nHeight && a.out == b.out;\n+}\n+} // namespace\n+\n+void initialize()\n+{\n+    static const ECCVerifyHandle ecc_verify_handle;\n+    ECC_Start();\n+    SelectParams(CBaseChainParams::REGTEST);\n+}\n+\n+void test_one_input(const std::vector<uint8_t>& buffer)\n+{\n+    FuzzedDataProvider fuzzed_data_provider{buffer.data(), buffer.size()};\n+    CCoinsView backend_coins_view;\n+    CCoinsViewCache coins_view_cache{&backend_coins_view};\n+    COutPoint random_out_point;\n+    Coin random_coin;\n+    CMutableTransaction random_mutable_transaction;\n+    while (fuzzed_data_provider.ConsumeBool()) {\n+        switch (fuzzed_data_provider.ConsumeIntegralInRange<int>(0, 9)) {\n+        case 0: {\n+            if (random_coin.IsSpent()) {\n+                break;\n+            }\n+            Coin coin = random_coin;\n+            bool expected_code_path = false;\n+            try {\n+                coins_view_cache.AddCoin(random_out_point, std::move(coin), fuzzed_data_provider.ConsumeBool());\n+                expected_code_path = true;\n+            } catch (const std::logic_error& e) {\n+                if (e.what() == std::string{\"Attempted to overwrite an unspent coin (when possible_overwrite is false)\"}) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18867#discussion_r419431163",
      "id" : 419431163,
      "line" : 64,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQzMTE2Mw==",
      "original_commit_id" : "b5f971a16ecbfcb0487b274f09516f17dfa19ab6",
      "original_line" : 64,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/test/fuzz/coins_view.cpp",
      "position" : 64,
      "pull_request_review_id" : 404980944,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18867",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-22T14:50:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/419431163",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18867#discussion_r419432165"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18867"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/419432165"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n            Coin move_to;\r\n```",
      "commit_id" : "ab7af9323e55bd035d2680a84e986675c7757ee3",
      "created_at" : "2020-05-04T13:24:15Z",
      "diff_hunk" : "@@ -0,0 +1,295 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <amount.h>\n+#include <chainparams.h>\n+#include <chainparamsbase.h>\n+#include <coins.h>\n+#include <consensus/tx_verify.h>\n+#include <consensus/validation.h>\n+#include <key.h>\n+#include <node/coinstats.h>\n+#include <optional.h>\n+#include <policy/policy.h>\n+#include <primitives/transaction.h>\n+#include <pubkey.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <validation.h>\n+\n+#include <cstdint>\n+#include <limits>\n+#include <string>\n+#include <vector>\n+\n+namespace {\n+const Coin EMPTY_COIN{};\n+\n+bool operator==(const Coin& a, const Coin& b)\n+{\n+    if (a.IsSpent() && b.IsSpent()) return true;\n+    return static_cast<bool>(a.fCoinBase) == static_cast<bool>(b.fCoinBase) && a.nHeight == b.nHeight && a.out == b.out;\n+}\n+} // namespace\n+\n+void initialize()\n+{\n+    static const ECCVerifyHandle ecc_verify_handle;\n+    ECC_Start();\n+    SelectParams(CBaseChainParams::REGTEST);\n+}\n+\n+void test_one_input(const std::vector<uint8_t>& buffer)\n+{\n+    FuzzedDataProvider fuzzed_data_provider{buffer.data(), buffer.size()};\n+    CCoinsView backend_coins_view;\n+    CCoinsViewCache coins_view_cache{&backend_coins_view};\n+    COutPoint random_out_point;\n+    Coin random_coin;\n+    CMutableTransaction random_mutable_transaction;\n+    while (fuzzed_data_provider.ConsumeBool()) {\n+        switch (fuzzed_data_provider.ConsumeIntegralInRange<int>(0, 9)) {\n+        case 0: {\n+            if (random_coin.IsSpent()) {\n+                break;\n+            }\n+            Coin coin = random_coin;\n+            bool expected_code_path = false;\n+            try {\n+                coins_view_cache.AddCoin(random_out_point, std::move(coin), fuzzed_data_provider.ConsumeBool());\n+                expected_code_path = true;\n+            } catch (const std::logic_error& e) {\n+                if (e.what() == std::string{\"Attempted to overwrite an unspent coin (when possible_overwrite is false)\"}) {\n+                    expected_code_path = true;\n+                }\n+            }\n+            assert(expected_code_path);\n+            break;\n+        }\n+        case 1: {\n+            (void)coins_view_cache.Flush();\n+            break;\n+        }\n+        case 2: {\n+            coins_view_cache.SetBestBlock(ConsumeUInt256(fuzzed_data_provider));\n+            break;\n+        }\n+        case 3: {\n+            Coin coin;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18867#discussion_r419432165",
      "id" : 419432165,
      "line" : 80,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQzMjE2NQ==",
      "original_commit_id" : "b5f971a16ecbfcb0487b274f09516f17dfa19ab6",
      "original_line" : 80,
      "original_position" : 80,
      "original_start_line" : null,
      "path" : "src/test/fuzz/coins_view.cpp",
      "position" : 80,
      "pull_request_review_id" : 404982232,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18867",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-24T15:34:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/419432165",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18867#discussion_r419440744"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18867"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/419440744"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The current formulation is intentional. The problem with doing it the way you suggest is that the `throw;` line (I assume `raise e;` was a typo :)) will not be covered. That would be bad for `src/test/fuzz/` where I want literally 100% line coverage to be able to see fuzzing harness gaps where our inputs are not able to reach :)",
      "commit_id" : "ab7af9323e55bd035d2680a84e986675c7757ee3",
      "created_at" : "2020-05-04T13:36:09Z",
      "diff_hunk" : "@@ -0,0 +1,295 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <amount.h>\n+#include <chainparams.h>\n+#include <chainparamsbase.h>\n+#include <coins.h>\n+#include <consensus/tx_verify.h>\n+#include <consensus/validation.h>\n+#include <key.h>\n+#include <node/coinstats.h>\n+#include <optional.h>\n+#include <policy/policy.h>\n+#include <primitives/transaction.h>\n+#include <pubkey.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <validation.h>\n+\n+#include <cstdint>\n+#include <limits>\n+#include <string>\n+#include <vector>\n+\n+namespace {\n+const Coin EMPTY_COIN{};\n+\n+bool operator==(const Coin& a, const Coin& b)\n+{\n+    if (a.IsSpent() && b.IsSpent()) return true;\n+    return static_cast<bool>(a.fCoinBase) == static_cast<bool>(b.fCoinBase) && a.nHeight == b.nHeight && a.out == b.out;\n+}\n+} // namespace\n+\n+void initialize()\n+{\n+    static const ECCVerifyHandle ecc_verify_handle;\n+    ECC_Start();\n+    SelectParams(CBaseChainParams::REGTEST);\n+}\n+\n+void test_one_input(const std::vector<uint8_t>& buffer)\n+{\n+    FuzzedDataProvider fuzzed_data_provider{buffer.data(), buffer.size()};\n+    CCoinsView backend_coins_view;\n+    CCoinsViewCache coins_view_cache{&backend_coins_view};\n+    COutPoint random_out_point;\n+    Coin random_coin;\n+    CMutableTransaction random_mutable_transaction;\n+    while (fuzzed_data_provider.ConsumeBool()) {\n+        switch (fuzzed_data_provider.ConsumeIntegralInRange<int>(0, 9)) {\n+        case 0: {\n+            if (random_coin.IsSpent()) {\n+                break;\n+            }\n+            Coin coin = random_coin;\n+            bool expected_code_path = false;\n+            try {\n+                coins_view_cache.AddCoin(random_out_point, std::move(coin), fuzzed_data_provider.ConsumeBool());\n+                expected_code_path = true;\n+            } catch (const std::logic_error& e) {\n+                if (e.what() == std::string{\"Attempted to overwrite an unspent coin (when possible_overwrite is false)\"}) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18867#discussion_r419440744",
      "id" : 419440744,
      "in_reply_to_id" : 419431163,
      "line" : 64,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQ0MDc0NA==",
      "original_commit_id" : "b5f971a16ecbfcb0487b274f09516f17dfa19ab6",
      "original_line" : 64,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/test/fuzz/coins_view.cpp",
      "position" : 64,
      "pull_request_review_id" : 404992786,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18867",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-22T14:50:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/419440744",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "nice, Concept ACK",
      "created_at" : "2020-05-04T15:42:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18867#issuecomment-623541065",
      "id" : 623541065,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18867",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMzU0MTA2NQ==",
      "updated_at" : "2020-05-04T15:42:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/623541065",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/45598?v=4",
         "events_url" : "https://api.github.com/users/jb55/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jb55/followers",
         "following_url" : "https://api.github.com/users/jb55/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jb55/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jb55",
         "id" : 45598,
         "login" : "jb55",
         "node_id" : "MDQ6VXNlcjQ1NTk4",
         "organizations_url" : "https://api.github.com/users/jb55/orgs",
         "received_events_url" : "https://api.github.com/users/jb55/received_events",
         "repos_url" : "https://api.github.com/users/jb55/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jb55/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jb55/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jb55"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK https://github.com/bitcoin/bitcoin/pull/18867/commits/b5f971a16ecbfcb0487b274f09516f17dfa19ab6",
      "created_at" : "2020-05-13T19:39:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18867#issuecomment-628204316",
      "id" : 628204316,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18867",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyODIwNDMxNg==",
      "updated_at" : "2020-05-13T19:39:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/628204316",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@MarcoFalke Would you mind reviewing? :)",
      "created_at" : "2020-05-18T20:12:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18867#issuecomment-630410609",
      "id" : 630410609,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18867",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMDQxMDYwOQ==",
      "updated_at" : "2020-05-18T20:12:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/630410609",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased! :)",
      "created_at" : "2020-05-22T14:50:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18867#issuecomment-632732323",
      "id" : 632732323,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18867",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMjczMjMyMw==",
      "updated_at" : "2020-05-22T14:50:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/632732323",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18867#discussion_r429644533"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18867"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429644533"
         }
      },
      "author_association" : "MEMBER",
      "body" : "any reason to use static cast here? this seems to silence any sanitizers that check for overflow if the cast value was not 0 or 1",
      "commit_id" : "ab7af9323e55bd035d2680a84e986675c7757ee3",
      "created_at" : "2020-05-24T14:50:16Z",
      "diff_hunk" : "@@ -0,0 +1,295 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <amount.h>\n+#include <chainparams.h>\n+#include <chainparamsbase.h>\n+#include <coins.h>\n+#include <consensus/tx_verify.h>\n+#include <consensus/validation.h>\n+#include <key.h>\n+#include <node/coinstats.h>\n+#include <policy/policy.h>\n+#include <primitives/transaction.h>\n+#include <pubkey.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <validation.h>\n+\n+#include <cstdint>\n+#include <limits>\n+#include <optional>\n+#include <string>\n+#include <vector>\n+\n+namespace {\n+const Coin EMPTY_COIN{};\n+\n+bool operator==(const Coin& a, const Coin& b)\n+{\n+    if (a.IsSpent() && b.IsSpent()) return true;\n+    return static_cast<bool>(a.fCoinBase) == static_cast<bool>(b.fCoinBase) && a.nHeight == b.nHeight && a.out == b.out;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18867#discussion_r429644533",
      "id" : 429644533,
      "line" : 33,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY0NDUzMw==",
      "original_commit_id" : "ab7af9323e55bd035d2680a84e986675c7757ee3",
      "original_line" : 33,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/test/fuzz/coins_view.cpp",
      "position" : 33,
      "pull_request_review_id" : 404982232,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18867",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-24T15:34:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429644533",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18867#discussion_r429645870"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18867"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429645870"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n                coins_view_cache.AddCoin(random_out_point, std::move(coin), possible_overwrite);\r\n```",
      "commit_id" : "ab7af9323e55bd035d2680a84e986675c7757ee3",
      "created_at" : "2020-05-24T15:05:08Z",
      "diff_hunk" : "@@ -0,0 +1,295 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <amount.h>\n+#include <chainparams.h>\n+#include <chainparamsbase.h>\n+#include <coins.h>\n+#include <consensus/tx_verify.h>\n+#include <consensus/validation.h>\n+#include <key.h>\n+#include <node/coinstats.h>\n+#include <policy/policy.h>\n+#include <primitives/transaction.h>\n+#include <pubkey.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <validation.h>\n+\n+#include <cstdint>\n+#include <limits>\n+#include <optional>\n+#include <string>\n+#include <vector>\n+\n+namespace {\n+const Coin EMPTY_COIN{};\n+\n+bool operator==(const Coin& a, const Coin& b)\n+{\n+    if (a.IsSpent() && b.IsSpent()) return true;\n+    return static_cast<bool>(a.fCoinBase) == static_cast<bool>(b.fCoinBase) && a.nHeight == b.nHeight && a.out == b.out;\n+}\n+} // namespace\n+\n+void initialize()\n+{\n+    static const ECCVerifyHandle ecc_verify_handle;\n+    ECC_Start();\n+    SelectParams(CBaseChainParams::REGTEST);\n+}\n+\n+void test_one_input(const std::vector<uint8_t>& buffer)\n+{\n+    FuzzedDataProvider fuzzed_data_provider{buffer.data(), buffer.size()};\n+    CCoinsView backend_coins_view;\n+    CCoinsViewCache coins_view_cache{&backend_coins_view};\n+    COutPoint random_out_point;\n+    Coin random_coin;\n+    CMutableTransaction random_mutable_transaction;\n+    while (fuzzed_data_provider.ConsumeBool()) {\n+        switch (fuzzed_data_provider.ConsumeIntegralInRange<int>(0, 9)) {\n+        case 0: {\n+            if (random_coin.IsSpent()) {\n+                break;\n+            }\n+            Coin coin = random_coin;\n+            bool expected_code_path = false;\n+            try {\n+                coins_view_cache.AddCoin(random_out_point, std::move(coin), fuzzed_data_provider.ConsumeBool());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18867#discussion_r429645870",
      "id" : 429645870,
      "line" : 61,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY0NTg3MA==",
      "original_commit_id" : "ab7af9323e55bd035d2680a84e986675c7757ee3",
      "original_line" : 61,
      "original_position" : 61,
      "original_start_line" : null,
      "path" : "src/test/fuzz/coins_view.cpp",
      "position" : 61,
      "pull_request_review_id" : 404982232,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18867",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-24T15:34:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429645870",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18867#discussion_r429645933"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18867"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429645933"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n                    assert(possible_overwrite);\r\n```\r\n\r\nCould make this check a bit stricter?",
      "commit_id" : "ab7af9323e55bd035d2680a84e986675c7757ee3",
      "created_at" : "2020-05-24T15:05:44Z",
      "diff_hunk" : "@@ -0,0 +1,295 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <amount.h>\n+#include <chainparams.h>\n+#include <chainparamsbase.h>\n+#include <coins.h>\n+#include <consensus/tx_verify.h>\n+#include <consensus/validation.h>\n+#include <key.h>\n+#include <node/coinstats.h>\n+#include <policy/policy.h>\n+#include <primitives/transaction.h>\n+#include <pubkey.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <validation.h>\n+\n+#include <cstdint>\n+#include <limits>\n+#include <optional>\n+#include <string>\n+#include <vector>\n+\n+namespace {\n+const Coin EMPTY_COIN{};\n+\n+bool operator==(const Coin& a, const Coin& b)\n+{\n+    if (a.IsSpent() && b.IsSpent()) return true;\n+    return static_cast<bool>(a.fCoinBase) == static_cast<bool>(b.fCoinBase) && a.nHeight == b.nHeight && a.out == b.out;\n+}\n+} // namespace\n+\n+void initialize()\n+{\n+    static const ECCVerifyHandle ecc_verify_handle;\n+    ECC_Start();\n+    SelectParams(CBaseChainParams::REGTEST);\n+}\n+\n+void test_one_input(const std::vector<uint8_t>& buffer)\n+{\n+    FuzzedDataProvider fuzzed_data_provider{buffer.data(), buffer.size()};\n+    CCoinsView backend_coins_view;\n+    CCoinsViewCache coins_view_cache{&backend_coins_view};\n+    COutPoint random_out_point;\n+    Coin random_coin;\n+    CMutableTransaction random_mutable_transaction;\n+    while (fuzzed_data_provider.ConsumeBool()) {\n+        switch (fuzzed_data_provider.ConsumeIntegralInRange<int>(0, 9)) {\n+        case 0: {\n+            if (random_coin.IsSpent()) {\n+                break;\n+            }\n+            Coin coin = random_coin;\n+            bool expected_code_path = false;\n+            try {\n+                coins_view_cache.AddCoin(random_out_point, std::move(coin), fuzzed_data_provider.ConsumeBool());\n+                expected_code_path = true;\n+            } catch (const std::logic_error& e) {\n+                if (e.what() == std::string{\"Attempted to overwrite an unspent coin (when possible_overwrite is false)\"}) {\n+                    expected_code_path = true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18867#discussion_r429645933",
      "id" : 429645933,
      "line" : 65,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY0NTkzMw==",
      "original_commit_id" : "ab7af9323e55bd035d2680a84e986675c7757ee3",
      "original_line" : 65,
      "original_position" : 65,
      "original_start_line" : null,
      "path" : "src/test/fuzz/coins_view.cpp",
      "position" : 65,
      "pull_request_review_id" : 404982232,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18867",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-24T15:34:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429645933",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18867#discussion_r429646754"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18867"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429646754"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What is this doing? How is this different from the fuzz engine running case 6 -> case 9?",
      "commit_id" : "ab7af9323e55bd035d2680a84e986675c7757ee3",
      "created_at" : "2020-05-24T15:15:02Z",
      "diff_hunk" : "@@ -0,0 +1,295 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <amount.h>\n+#include <chainparams.h>\n+#include <chainparamsbase.h>\n+#include <coins.h>\n+#include <consensus/tx_verify.h>\n+#include <consensus/validation.h>\n+#include <key.h>\n+#include <node/coinstats.h>\n+#include <policy/policy.h>\n+#include <primitives/transaction.h>\n+#include <pubkey.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <validation.h>\n+\n+#include <cstdint>\n+#include <limits>\n+#include <optional>\n+#include <string>\n+#include <vector>\n+\n+namespace {\n+const Coin EMPTY_COIN{};\n+\n+bool operator==(const Coin& a, const Coin& b)\n+{\n+    if (a.IsSpent() && b.IsSpent()) return true;\n+    return static_cast<bool>(a.fCoinBase) == static_cast<bool>(b.fCoinBase) && a.nHeight == b.nHeight && a.out == b.out;\n+}\n+} // namespace\n+\n+void initialize()\n+{\n+    static const ECCVerifyHandle ecc_verify_handle;\n+    ECC_Start();\n+    SelectParams(CBaseChainParams::REGTEST);\n+}\n+\n+void test_one_input(const std::vector<uint8_t>& buffer)\n+{\n+    FuzzedDataProvider fuzzed_data_provider{buffer.data(), buffer.size()};\n+    CCoinsView backend_coins_view;\n+    CCoinsViewCache coins_view_cache{&backend_coins_view};\n+    COutPoint random_out_point;\n+    Coin random_coin;\n+    CMutableTransaction random_mutable_transaction;\n+    while (fuzzed_data_provider.ConsumeBool()) {\n+        switch (fuzzed_data_provider.ConsumeIntegralInRange<int>(0, 9)) {\n+        case 0: {\n+            if (random_coin.IsSpent()) {\n+                break;\n+            }\n+            Coin coin = random_coin;\n+            bool expected_code_path = false;\n+            try {\n+                coins_view_cache.AddCoin(random_out_point, std::move(coin), fuzzed_data_provider.ConsumeBool());\n+                expected_code_path = true;\n+            } catch (const std::logic_error& e) {\n+                if (e.what() == std::string{\"Attempted to overwrite an unspent coin (when possible_overwrite is false)\"}) {\n+                    expected_code_path = true;\n+                }\n+            }\n+            assert(expected_code_path);\n+            break;\n+        }\n+        case 1: {\n+            (void)coins_view_cache.Flush();\n+            break;\n+        }\n+        case 2: {\n+            coins_view_cache.SetBestBlock(ConsumeUInt256(fuzzed_data_provider));\n+            break;\n+        }\n+        case 3: {\n+            Coin coin;\n+            (void)coins_view_cache.SpendCoin(random_out_point, fuzzed_data_provider.ConsumeBool() ? &coin : nullptr);\n+            break;\n+        }\n+        case 4: {\n+            coins_view_cache.Uncache(random_out_point);\n+            break;\n+        }\n+        case 5: {\n+            if (fuzzed_data_provider.ConsumeBool()) {\n+                backend_coins_view = CCoinsView{};\n+            }\n+            coins_view_cache.SetBackend(backend_coins_view);\n+            break;\n+        }\n+        case 6: {\n+            const std::optional<COutPoint> opt_out_point = ConsumeDeserializable<COutPoint>(fuzzed_data_provider);\n+            if (!opt_out_point) {\n+                break;\n+            }\n+            random_out_point = *opt_out_point;\n+            break;\n+        }\n+        case 7: {\n+            const std::optional<Coin> opt_coin = ConsumeDeserializable<Coin>(fuzzed_data_provider);\n+            if (!opt_coin) {\n+                break;\n+            }\n+            random_coin = *opt_coin;\n+            break;\n+        }\n+        case 8: {\n+            const std::optional<CMutableTransaction> opt_mutable_transaction = ConsumeDeserializable<CMutableTransaction>(fuzzed_data_provider);\n+            if (!opt_mutable_transaction) {\n+                break;\n+            }\n+            random_mutable_transaction = *opt_mutable_transaction;\n+            break;\n+        }\n+        case 9: {\n+            CCoinsMap coins_map;\n+            while (fuzzed_data_provider.ConsumeBool()) {\n+                CCoinsCacheEntry coins_cache_entry;\n+                coins_cache_entry.flags = fuzzed_data_provider.ConsumeIntegral<unsigned char>();\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    coins_cache_entry.coin = random_coin;\n+                } else {\n+                    const std::optional<Coin> opt_coin = ConsumeDeserializable<Coin>(fuzzed_data_provider);\n+                    if (!opt_coin) {\n+                        break;\n+                    }\n+                    coins_cache_entry.coin = *opt_coin;\n+                }\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    const std::optional<COutPoint> opt_out_point = ConsumeDeserializable<COutPoint>(fuzzed_data_provider);\n+                    if (!opt_out_point) {\n+                        break;\n+                    }\n+                    random_out_point = *opt_out_point;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18867#discussion_r429646754",
      "id" : 429646754,
      "line" : 138,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY0Njc1NA==",
      "original_commit_id" : "ab7af9323e55bd035d2680a84e986675c7757ee3",
      "original_line" : 138,
      "original_position" : 138,
      "original_start_line" : null,
      "path" : "src/test/fuzz/coins_view.cpp",
      "position" : 138,
      "pull_request_review_id" : 404982232,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18867",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-24T15:34:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429646754",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18867#discussion_r429647249"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18867"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429647249"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Note to myself only: I thought about putting a more strict assert here, but the exception doesn't give any hints which coin failed, so I don't think this is possible for now.",
      "commit_id" : "ab7af9323e55bd035d2680a84e986675c7757ee3",
      "created_at" : "2020-05-24T15:20:14Z",
      "diff_hunk" : "@@ -0,0 +1,295 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <amount.h>\n+#include <chainparams.h>\n+#include <chainparamsbase.h>\n+#include <coins.h>\n+#include <consensus/tx_verify.h>\n+#include <consensus/validation.h>\n+#include <key.h>\n+#include <node/coinstats.h>\n+#include <policy/policy.h>\n+#include <primitives/transaction.h>\n+#include <pubkey.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <validation.h>\n+\n+#include <cstdint>\n+#include <limits>\n+#include <optional>\n+#include <string>\n+#include <vector>\n+\n+namespace {\n+const Coin EMPTY_COIN{};\n+\n+bool operator==(const Coin& a, const Coin& b)\n+{\n+    if (a.IsSpent() && b.IsSpent()) return true;\n+    return static_cast<bool>(a.fCoinBase) == static_cast<bool>(b.fCoinBase) && a.nHeight == b.nHeight && a.out == b.out;\n+}\n+} // namespace\n+\n+void initialize()\n+{\n+    static const ECCVerifyHandle ecc_verify_handle;\n+    ECC_Start();\n+    SelectParams(CBaseChainParams::REGTEST);\n+}\n+\n+void test_one_input(const std::vector<uint8_t>& buffer)\n+{\n+    FuzzedDataProvider fuzzed_data_provider{buffer.data(), buffer.size()};\n+    CCoinsView backend_coins_view;\n+    CCoinsViewCache coins_view_cache{&backend_coins_view};\n+    COutPoint random_out_point;\n+    Coin random_coin;\n+    CMutableTransaction random_mutable_transaction;\n+    while (fuzzed_data_provider.ConsumeBool()) {\n+        switch (fuzzed_data_provider.ConsumeIntegralInRange<int>(0, 9)) {\n+        case 0: {\n+            if (random_coin.IsSpent()) {\n+                break;\n+            }\n+            Coin coin = random_coin;\n+            bool expected_code_path = false;\n+            try {\n+                coins_view_cache.AddCoin(random_out_point, std::move(coin), fuzzed_data_provider.ConsumeBool());\n+                expected_code_path = true;\n+            } catch (const std::logic_error& e) {\n+                if (e.what() == std::string{\"Attempted to overwrite an unspent coin (when possible_overwrite is false)\"}) {\n+                    expected_code_path = true;\n+                }\n+            }\n+            assert(expected_code_path);\n+            break;\n+        }\n+        case 1: {\n+            (void)coins_view_cache.Flush();\n+            break;\n+        }\n+        case 2: {\n+            coins_view_cache.SetBestBlock(ConsumeUInt256(fuzzed_data_provider));\n+            break;\n+        }\n+        case 3: {\n+            Coin coin;\n+            (void)coins_view_cache.SpendCoin(random_out_point, fuzzed_data_provider.ConsumeBool() ? &coin : nullptr);\n+            break;\n+        }\n+        case 4: {\n+            coins_view_cache.Uncache(random_out_point);\n+            break;\n+        }\n+        case 5: {\n+            if (fuzzed_data_provider.ConsumeBool()) {\n+                backend_coins_view = CCoinsView{};\n+            }\n+            coins_view_cache.SetBackend(backend_coins_view);\n+            break;\n+        }\n+        case 6: {\n+            const std::optional<COutPoint> opt_out_point = ConsumeDeserializable<COutPoint>(fuzzed_data_provider);\n+            if (!opt_out_point) {\n+                break;\n+            }\n+            random_out_point = *opt_out_point;\n+            break;\n+        }\n+        case 7: {\n+            const std::optional<Coin> opt_coin = ConsumeDeserializable<Coin>(fuzzed_data_provider);\n+            if (!opt_coin) {\n+                break;\n+            }\n+            random_coin = *opt_coin;\n+            break;\n+        }\n+        case 8: {\n+            const std::optional<CMutableTransaction> opt_mutable_transaction = ConsumeDeserializable<CMutableTransaction>(fuzzed_data_provider);\n+            if (!opt_mutable_transaction) {\n+                break;\n+            }\n+            random_mutable_transaction = *opt_mutable_transaction;\n+            break;\n+        }\n+        case 9: {\n+            CCoinsMap coins_map;\n+            while (fuzzed_data_provider.ConsumeBool()) {\n+                CCoinsCacheEntry coins_cache_entry;\n+                coins_cache_entry.flags = fuzzed_data_provider.ConsumeIntegral<unsigned char>();\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    coins_cache_entry.coin = random_coin;\n+                } else {\n+                    const std::optional<Coin> opt_coin = ConsumeDeserializable<Coin>(fuzzed_data_provider);\n+                    if (!opt_coin) {\n+                        break;\n+                    }\n+                    coins_cache_entry.coin = *opt_coin;\n+                }\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    const std::optional<COutPoint> opt_out_point = ConsumeDeserializable<COutPoint>(fuzzed_data_provider);\n+                    if (!opt_out_point) {\n+                        break;\n+                    }\n+                    random_out_point = *opt_out_point;\n+                }\n+                coins_map.emplace(random_out_point, std::move(coins_cache_entry));\n+            }\n+            bool expected_code_path = false;\n+            try {\n+                coins_view_cache.BatchWrite(coins_map, fuzzed_data_provider.ConsumeBool() ? ConsumeUInt256(fuzzed_data_provider) : coins_view_cache.GetBestBlock());\n+                expected_code_path = true;\n+            } catch (const std::logic_error& e) {\n+                if (e.what() == std::string{\"FRESH flag misapplied to coin that exists in parent cache\"}) {\n+                    expected_code_path = true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18867#discussion_r429647249",
      "id" : 429647249,
      "line" : 148,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY0NzI0OQ==",
      "original_commit_id" : "ab7af9323e55bd035d2680a84e986675c7757ee3",
      "original_line" : 148,
      "original_position" : 148,
      "original_start_line" : null,
      "path" : "src/test/fuzz/coins_view.cpp",
      "position" : 148,
      "pull_request_review_id" : 404982232,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18867",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-24T15:34:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429647249",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18867#discussion_r429647975"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18867"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429647975"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`                    assert(possible_overwrite);`",
      "commit_id" : "ab7af9323e55bd035d2680a84e986675c7757ee3",
      "created_at" : "2020-05-24T15:28:26Z",
      "diff_hunk" : "@@ -0,0 +1,295 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <amount.h>\n+#include <chainparams.h>\n+#include <chainparamsbase.h>\n+#include <coins.h>\n+#include <consensus/tx_verify.h>\n+#include <consensus/validation.h>\n+#include <key.h>\n+#include <node/coinstats.h>\n+#include <policy/policy.h>\n+#include <primitives/transaction.h>\n+#include <pubkey.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <validation.h>\n+\n+#include <cstdint>\n+#include <limits>\n+#include <optional>\n+#include <string>\n+#include <vector>\n+\n+namespace {\n+const Coin EMPTY_COIN{};\n+\n+bool operator==(const Coin& a, const Coin& b)\n+{\n+    if (a.IsSpent() && b.IsSpent()) return true;\n+    return static_cast<bool>(a.fCoinBase) == static_cast<bool>(b.fCoinBase) && a.nHeight == b.nHeight && a.out == b.out;\n+}\n+} // namespace\n+\n+void initialize()\n+{\n+    static const ECCVerifyHandle ecc_verify_handle;\n+    ECC_Start();\n+    SelectParams(CBaseChainParams::REGTEST);\n+}\n+\n+void test_one_input(const std::vector<uint8_t>& buffer)\n+{\n+    FuzzedDataProvider fuzzed_data_provider{buffer.data(), buffer.size()};\n+    CCoinsView backend_coins_view;\n+    CCoinsViewCache coins_view_cache{&backend_coins_view};\n+    COutPoint random_out_point;\n+    Coin random_coin;\n+    CMutableTransaction random_mutable_transaction;\n+    while (fuzzed_data_provider.ConsumeBool()) {\n+        switch (fuzzed_data_provider.ConsumeIntegralInRange<int>(0, 9)) {\n+        case 0: {\n+            if (random_coin.IsSpent()) {\n+                break;\n+            }\n+            Coin coin = random_coin;\n+            bool expected_code_path = false;\n+            try {\n+                coins_view_cache.AddCoin(random_out_point, std::move(coin), fuzzed_data_provider.ConsumeBool());\n+                expected_code_path = true;\n+            } catch (const std::logic_error& e) {\n+                if (e.what() == std::string{\"Attempted to overwrite an unspent coin (when possible_overwrite is false)\"}) {\n+                    expected_code_path = true;\n+                }\n+            }\n+            assert(expected_code_path);\n+            break;\n+        }\n+        case 1: {\n+            (void)coins_view_cache.Flush();\n+            break;\n+        }\n+        case 2: {\n+            coins_view_cache.SetBestBlock(ConsumeUInt256(fuzzed_data_provider));\n+            break;\n+        }\n+        case 3: {\n+            Coin coin;\n+            (void)coins_view_cache.SpendCoin(random_out_point, fuzzed_data_provider.ConsumeBool() ? &coin : nullptr);\n+            break;\n+        }\n+        case 4: {\n+            coins_view_cache.Uncache(random_out_point);\n+            break;\n+        }\n+        case 5: {\n+            if (fuzzed_data_provider.ConsumeBool()) {\n+                backend_coins_view = CCoinsView{};\n+            }\n+            coins_view_cache.SetBackend(backend_coins_view);\n+            break;\n+        }\n+        case 6: {\n+            const std::optional<COutPoint> opt_out_point = ConsumeDeserializable<COutPoint>(fuzzed_data_provider);\n+            if (!opt_out_point) {\n+                break;\n+            }\n+            random_out_point = *opt_out_point;\n+            break;\n+        }\n+        case 7: {\n+            const std::optional<Coin> opt_coin = ConsumeDeserializable<Coin>(fuzzed_data_provider);\n+            if (!opt_coin) {\n+                break;\n+            }\n+            random_coin = *opt_coin;\n+            break;\n+        }\n+        case 8: {\n+            const std::optional<CMutableTransaction> opt_mutable_transaction = ConsumeDeserializable<CMutableTransaction>(fuzzed_data_provider);\n+            if (!opt_mutable_transaction) {\n+                break;\n+            }\n+            random_mutable_transaction = *opt_mutable_transaction;\n+            break;\n+        }\n+        case 9: {\n+            CCoinsMap coins_map;\n+            while (fuzzed_data_provider.ConsumeBool()) {\n+                CCoinsCacheEntry coins_cache_entry;\n+                coins_cache_entry.flags = fuzzed_data_provider.ConsumeIntegral<unsigned char>();\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    coins_cache_entry.coin = random_coin;\n+                } else {\n+                    const std::optional<Coin> opt_coin = ConsumeDeserializable<Coin>(fuzzed_data_provider);\n+                    if (!opt_coin) {\n+                        break;\n+                    }\n+                    coins_cache_entry.coin = *opt_coin;\n+                }\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    const std::optional<COutPoint> opt_out_point = ConsumeDeserializable<COutPoint>(fuzzed_data_provider);\n+                    if (!opt_out_point) {\n+                        break;\n+                    }\n+                    random_out_point = *opt_out_point;\n+                }\n+                coins_map.emplace(random_out_point, std::move(coins_cache_entry));\n+            }\n+            bool expected_code_path = false;\n+            try {\n+                coins_view_cache.BatchWrite(coins_map, fuzzed_data_provider.ConsumeBool() ? ConsumeUInt256(fuzzed_data_provider) : coins_view_cache.GetBestBlock());\n+                expected_code_path = true;\n+            } catch (const std::logic_error& e) {\n+                if (e.what() == std::string{\"FRESH flag misapplied to coin that exists in parent cache\"}) {\n+                    expected_code_path = true;\n+                }\n+            }\n+            assert(expected_code_path);\n+            break;\n+        }\n+        }\n+    }\n+\n+    {\n+        const Coin& coin_using_access_coin = coins_view_cache.AccessCoin(random_out_point);\n+        const bool exists_using_access_coin = !(coin_using_access_coin == EMPTY_COIN);\n+        const bool exists_using_have_coin = coins_view_cache.HaveCoin(random_out_point);\n+        const bool exists_using_have_coin_in_cache = coins_view_cache.HaveCoinInCache(random_out_point);\n+        Coin coin_using_get_coin;\n+        const bool exists_using_get_coin = coins_view_cache.GetCoin(random_out_point, coin_using_get_coin);\n+        if (exists_using_get_coin) {\n+            assert(coin_using_get_coin == coin_using_access_coin);\n+        }\n+        assert((exists_using_access_coin && exists_using_have_coin_in_cache && exists_using_have_coin && exists_using_get_coin) ||\n+               (!exists_using_access_coin && !exists_using_have_coin_in_cache && !exists_using_have_coin && !exists_using_get_coin));\n+        const bool exists_using_have_coin_in_backend = backend_coins_view.HaveCoin(random_out_point);\n+        if (exists_using_have_coin_in_backend) {\n+            assert(exists_using_have_coin);\n+        }\n+        Coin coin_using_backend_get_coin;\n+        if (backend_coins_view.GetCoin(random_out_point, coin_using_backend_get_coin)) {\n+            assert(exists_using_have_coin_in_backend);\n+            assert(coin_using_get_coin == coin_using_backend_get_coin);\n+        } else {\n+            assert(!exists_using_have_coin_in_backend);\n+        }\n+    }\n+\n+    {\n+        bool expected_code_path = false;\n+        try {\n+            (void)coins_view_cache.Cursor();\n+        } catch (const std::logic_error&) {\n+            expected_code_path = true;\n+        }\n+        assert(expected_code_path);\n+        (void)coins_view_cache.DynamicMemoryUsage();\n+        (void)coins_view_cache.EstimateSize();\n+        (void)coins_view_cache.GetBestBlock();\n+        (void)coins_view_cache.GetCacheSize();\n+        (void)coins_view_cache.GetHeadBlocks();\n+        (void)coins_view_cache.HaveInputs(CTransaction{random_mutable_transaction});\n+    }\n+\n+    {\n+        const CCoinsViewCursor* coins_view_cursor = backend_coins_view.Cursor();\n+        assert(coins_view_cursor == nullptr);\n+        (void)backend_coins_view.EstimateSize();\n+        (void)backend_coins_view.GetBestBlock();\n+        (void)backend_coins_view.GetHeadBlocks();\n+    }\n+\n+    if (fuzzed_data_provider.ConsumeBool()) {\n+        switch (fuzzed_data_provider.ConsumeIntegralInRange<int>(0, 6)) {\n+        case 0: {\n+            const CTransaction transaction{random_mutable_transaction};\n+            bool is_spent = false;\n+            for (const CTxOut& tx_out : transaction.vout) {\n+                if (Coin{tx_out, 0, transaction.IsCoinBase()}.IsSpent()) {\n+                    is_spent = true;\n+                }\n+            }\n+            if (is_spent) {\n+                // Avoid:\n+                // coins.cpp:69: void CCoinsViewCache::AddCoin(const COutPoint &, Coin &&, bool): Assertion `!coin.IsSpent()' failed.\n+                break;\n+            }\n+            bool expected_code_path = false;\n+            try {\n+                AddCoins(coins_view_cache, transaction, fuzzed_data_provider.ConsumeIntegral<int>(), fuzzed_data_provider.ConsumeBool());\n+                expected_code_path = true;\n+            } catch (const std::logic_error& e) {\n+                if (e.what() == std::string{\"Attempted to overwrite an unspent coin (when possible_overwrite is false)\"}) {\n+                    expected_code_path = true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18867#discussion_r429647975",
      "id" : 429647975,
      "line" : 227,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY0Nzk3NQ==",
      "original_commit_id" : "ab7af9323e55bd035d2680a84e986675c7757ee3",
      "original_line" : 227,
      "original_position" : 227,
      "original_start_line" : null,
      "path" : "src/test/fuzz/coins_view.cpp",
      "position" : 227,
      "pull_request_review_id" : 404982232,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18867",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-24T15:35:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429647975",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18867#discussion_r429648160"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18867"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429648160"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n            CAmount tx_fee_out;\r\n```",
      "commit_id" : "ab7af9323e55bd035d2680a84e986675c7757ee3",
      "created_at" : "2020-05-24T15:30:45Z",
      "diff_hunk" : "@@ -0,0 +1,295 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <amount.h>\n+#include <chainparams.h>\n+#include <chainparamsbase.h>\n+#include <coins.h>\n+#include <consensus/tx_verify.h>\n+#include <consensus/validation.h>\n+#include <key.h>\n+#include <node/coinstats.h>\n+#include <policy/policy.h>\n+#include <primitives/transaction.h>\n+#include <pubkey.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <validation.h>\n+\n+#include <cstdint>\n+#include <limits>\n+#include <optional>\n+#include <string>\n+#include <vector>\n+\n+namespace {\n+const Coin EMPTY_COIN{};\n+\n+bool operator==(const Coin& a, const Coin& b)\n+{\n+    if (a.IsSpent() && b.IsSpent()) return true;\n+    return static_cast<bool>(a.fCoinBase) == static_cast<bool>(b.fCoinBase) && a.nHeight == b.nHeight && a.out == b.out;\n+}\n+} // namespace\n+\n+void initialize()\n+{\n+    static const ECCVerifyHandle ecc_verify_handle;\n+    ECC_Start();\n+    SelectParams(CBaseChainParams::REGTEST);\n+}\n+\n+void test_one_input(const std::vector<uint8_t>& buffer)\n+{\n+    FuzzedDataProvider fuzzed_data_provider{buffer.data(), buffer.size()};\n+    CCoinsView backend_coins_view;\n+    CCoinsViewCache coins_view_cache{&backend_coins_view};\n+    COutPoint random_out_point;\n+    Coin random_coin;\n+    CMutableTransaction random_mutable_transaction;\n+    while (fuzzed_data_provider.ConsumeBool()) {\n+        switch (fuzzed_data_provider.ConsumeIntegralInRange<int>(0, 9)) {\n+        case 0: {\n+            if (random_coin.IsSpent()) {\n+                break;\n+            }\n+            Coin coin = random_coin;\n+            bool expected_code_path = false;\n+            try {\n+                coins_view_cache.AddCoin(random_out_point, std::move(coin), fuzzed_data_provider.ConsumeBool());\n+                expected_code_path = true;\n+            } catch (const std::logic_error& e) {\n+                if (e.what() == std::string{\"Attempted to overwrite an unspent coin (when possible_overwrite is false)\"}) {\n+                    expected_code_path = true;\n+                }\n+            }\n+            assert(expected_code_path);\n+            break;\n+        }\n+        case 1: {\n+            (void)coins_view_cache.Flush();\n+            break;\n+        }\n+        case 2: {\n+            coins_view_cache.SetBestBlock(ConsumeUInt256(fuzzed_data_provider));\n+            break;\n+        }\n+        case 3: {\n+            Coin coin;\n+            (void)coins_view_cache.SpendCoin(random_out_point, fuzzed_data_provider.ConsumeBool() ? &coin : nullptr);\n+            break;\n+        }\n+        case 4: {\n+            coins_view_cache.Uncache(random_out_point);\n+            break;\n+        }\n+        case 5: {\n+            if (fuzzed_data_provider.ConsumeBool()) {\n+                backend_coins_view = CCoinsView{};\n+            }\n+            coins_view_cache.SetBackend(backend_coins_view);\n+            break;\n+        }\n+        case 6: {\n+            const std::optional<COutPoint> opt_out_point = ConsumeDeserializable<COutPoint>(fuzzed_data_provider);\n+            if (!opt_out_point) {\n+                break;\n+            }\n+            random_out_point = *opt_out_point;\n+            break;\n+        }\n+        case 7: {\n+            const std::optional<Coin> opt_coin = ConsumeDeserializable<Coin>(fuzzed_data_provider);\n+            if (!opt_coin) {\n+                break;\n+            }\n+            random_coin = *opt_coin;\n+            break;\n+        }\n+        case 8: {\n+            const std::optional<CMutableTransaction> opt_mutable_transaction = ConsumeDeserializable<CMutableTransaction>(fuzzed_data_provider);\n+            if (!opt_mutable_transaction) {\n+                break;\n+            }\n+            random_mutable_transaction = *opt_mutable_transaction;\n+            break;\n+        }\n+        case 9: {\n+            CCoinsMap coins_map;\n+            while (fuzzed_data_provider.ConsumeBool()) {\n+                CCoinsCacheEntry coins_cache_entry;\n+                coins_cache_entry.flags = fuzzed_data_provider.ConsumeIntegral<unsigned char>();\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    coins_cache_entry.coin = random_coin;\n+                } else {\n+                    const std::optional<Coin> opt_coin = ConsumeDeserializable<Coin>(fuzzed_data_provider);\n+                    if (!opt_coin) {\n+                        break;\n+                    }\n+                    coins_cache_entry.coin = *opt_coin;\n+                }\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    const std::optional<COutPoint> opt_out_point = ConsumeDeserializable<COutPoint>(fuzzed_data_provider);\n+                    if (!opt_out_point) {\n+                        break;\n+                    }\n+                    random_out_point = *opt_out_point;\n+                }\n+                coins_map.emplace(random_out_point, std::move(coins_cache_entry));\n+            }\n+            bool expected_code_path = false;\n+            try {\n+                coins_view_cache.BatchWrite(coins_map, fuzzed_data_provider.ConsumeBool() ? ConsumeUInt256(fuzzed_data_provider) : coins_view_cache.GetBestBlock());\n+                expected_code_path = true;\n+            } catch (const std::logic_error& e) {\n+                if (e.what() == std::string{\"FRESH flag misapplied to coin that exists in parent cache\"}) {\n+                    expected_code_path = true;\n+                }\n+            }\n+            assert(expected_code_path);\n+            break;\n+        }\n+        }\n+    }\n+\n+    {\n+        const Coin& coin_using_access_coin = coins_view_cache.AccessCoin(random_out_point);\n+        const bool exists_using_access_coin = !(coin_using_access_coin == EMPTY_COIN);\n+        const bool exists_using_have_coin = coins_view_cache.HaveCoin(random_out_point);\n+        const bool exists_using_have_coin_in_cache = coins_view_cache.HaveCoinInCache(random_out_point);\n+        Coin coin_using_get_coin;\n+        const bool exists_using_get_coin = coins_view_cache.GetCoin(random_out_point, coin_using_get_coin);\n+        if (exists_using_get_coin) {\n+            assert(coin_using_get_coin == coin_using_access_coin);\n+        }\n+        assert((exists_using_access_coin && exists_using_have_coin_in_cache && exists_using_have_coin && exists_using_get_coin) ||\n+               (!exists_using_access_coin && !exists_using_have_coin_in_cache && !exists_using_have_coin && !exists_using_get_coin));\n+        const bool exists_using_have_coin_in_backend = backend_coins_view.HaveCoin(random_out_point);\n+        if (exists_using_have_coin_in_backend) {\n+            assert(exists_using_have_coin);\n+        }\n+        Coin coin_using_backend_get_coin;\n+        if (backend_coins_view.GetCoin(random_out_point, coin_using_backend_get_coin)) {\n+            assert(exists_using_have_coin_in_backend);\n+            assert(coin_using_get_coin == coin_using_backend_get_coin);\n+        } else {\n+            assert(!exists_using_have_coin_in_backend);\n+        }\n+    }\n+\n+    {\n+        bool expected_code_path = false;\n+        try {\n+            (void)coins_view_cache.Cursor();\n+        } catch (const std::logic_error&) {\n+            expected_code_path = true;\n+        }\n+        assert(expected_code_path);\n+        (void)coins_view_cache.DynamicMemoryUsage();\n+        (void)coins_view_cache.EstimateSize();\n+        (void)coins_view_cache.GetBestBlock();\n+        (void)coins_view_cache.GetCacheSize();\n+        (void)coins_view_cache.GetHeadBlocks();\n+        (void)coins_view_cache.HaveInputs(CTransaction{random_mutable_transaction});\n+    }\n+\n+    {\n+        const CCoinsViewCursor* coins_view_cursor = backend_coins_view.Cursor();\n+        assert(coins_view_cursor == nullptr);\n+        (void)backend_coins_view.EstimateSize();\n+        (void)backend_coins_view.GetBestBlock();\n+        (void)backend_coins_view.GetHeadBlocks();\n+    }\n+\n+    if (fuzzed_data_provider.ConsumeBool()) {\n+        switch (fuzzed_data_provider.ConsumeIntegralInRange<int>(0, 6)) {\n+        case 0: {\n+            const CTransaction transaction{random_mutable_transaction};\n+            bool is_spent = false;\n+            for (const CTxOut& tx_out : transaction.vout) {\n+                if (Coin{tx_out, 0, transaction.IsCoinBase()}.IsSpent()) {\n+                    is_spent = true;\n+                }\n+            }\n+            if (is_spent) {\n+                // Avoid:\n+                // coins.cpp:69: void CCoinsViewCache::AddCoin(const COutPoint &, Coin &&, bool): Assertion `!coin.IsSpent()' failed.\n+                break;\n+            }\n+            bool expected_code_path = false;\n+            try {\n+                AddCoins(coins_view_cache, transaction, fuzzed_data_provider.ConsumeIntegral<int>(), fuzzed_data_provider.ConsumeBool());\n+                expected_code_path = true;\n+            } catch (const std::logic_error& e) {\n+                if (e.what() == std::string{\"Attempted to overwrite an unspent coin (when possible_overwrite is false)\"}) {\n+                    expected_code_path = true;\n+                }\n+            }\n+            assert(expected_code_path);\n+            break;\n+        }\n+        case 1: {\n+            (void)AreInputsStandard(CTransaction{random_mutable_transaction}, coins_view_cache);\n+            break;\n+        }\n+        case 2: {\n+            TxValidationState state;\n+            CAmount tx_fee;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18867#discussion_r429648160",
      "id" : 429648160,
      "line" : 239,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY0ODE2MA==",
      "original_commit_id" : "ab7af9323e55bd035d2680a84e986675c7757ee3",
      "original_line" : 239,
      "original_position" : 239,
      "original_start_line" : null,
      "path" : "src/test/fuzz/coins_view.cpp",
      "position" : 239,
      "pull_request_review_id" : 404982232,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18867",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-24T15:34:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429648160",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18867#discussion_r429648269"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18867"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429648269"
         }
      },
      "author_association" : "MEMBER",
      "body" : "can `assert(MoneyRange(tx_fee_out));` when check was successful?",
      "commit_id" : "ab7af9323e55bd035d2680a84e986675c7757ee3",
      "created_at" : "2020-05-24T15:32:01Z",
      "diff_hunk" : "@@ -0,0 +1,295 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <amount.h>\n+#include <chainparams.h>\n+#include <chainparamsbase.h>\n+#include <coins.h>\n+#include <consensus/tx_verify.h>\n+#include <consensus/validation.h>\n+#include <key.h>\n+#include <node/coinstats.h>\n+#include <policy/policy.h>\n+#include <primitives/transaction.h>\n+#include <pubkey.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n+#include <test/fuzz/fuzz.h>\n+#include <test/fuzz/util.h>\n+#include <validation.h>\n+\n+#include <cstdint>\n+#include <limits>\n+#include <optional>\n+#include <string>\n+#include <vector>\n+\n+namespace {\n+const Coin EMPTY_COIN{};\n+\n+bool operator==(const Coin& a, const Coin& b)\n+{\n+    if (a.IsSpent() && b.IsSpent()) return true;\n+    return static_cast<bool>(a.fCoinBase) == static_cast<bool>(b.fCoinBase) && a.nHeight == b.nHeight && a.out == b.out;\n+}\n+} // namespace\n+\n+void initialize()\n+{\n+    static const ECCVerifyHandle ecc_verify_handle;\n+    ECC_Start();\n+    SelectParams(CBaseChainParams::REGTEST);\n+}\n+\n+void test_one_input(const std::vector<uint8_t>& buffer)\n+{\n+    FuzzedDataProvider fuzzed_data_provider{buffer.data(), buffer.size()};\n+    CCoinsView backend_coins_view;\n+    CCoinsViewCache coins_view_cache{&backend_coins_view};\n+    COutPoint random_out_point;\n+    Coin random_coin;\n+    CMutableTransaction random_mutable_transaction;\n+    while (fuzzed_data_provider.ConsumeBool()) {\n+        switch (fuzzed_data_provider.ConsumeIntegralInRange<int>(0, 9)) {\n+        case 0: {\n+            if (random_coin.IsSpent()) {\n+                break;\n+            }\n+            Coin coin = random_coin;\n+            bool expected_code_path = false;\n+            try {\n+                coins_view_cache.AddCoin(random_out_point, std::move(coin), fuzzed_data_provider.ConsumeBool());\n+                expected_code_path = true;\n+            } catch (const std::logic_error& e) {\n+                if (e.what() == std::string{\"Attempted to overwrite an unspent coin (when possible_overwrite is false)\"}) {\n+                    expected_code_path = true;\n+                }\n+            }\n+            assert(expected_code_path);\n+            break;\n+        }\n+        case 1: {\n+            (void)coins_view_cache.Flush();\n+            break;\n+        }\n+        case 2: {\n+            coins_view_cache.SetBestBlock(ConsumeUInt256(fuzzed_data_provider));\n+            break;\n+        }\n+        case 3: {\n+            Coin coin;\n+            (void)coins_view_cache.SpendCoin(random_out_point, fuzzed_data_provider.ConsumeBool() ? &coin : nullptr);\n+            break;\n+        }\n+        case 4: {\n+            coins_view_cache.Uncache(random_out_point);\n+            break;\n+        }\n+        case 5: {\n+            if (fuzzed_data_provider.ConsumeBool()) {\n+                backend_coins_view = CCoinsView{};\n+            }\n+            coins_view_cache.SetBackend(backend_coins_view);\n+            break;\n+        }\n+        case 6: {\n+            const std::optional<COutPoint> opt_out_point = ConsumeDeserializable<COutPoint>(fuzzed_data_provider);\n+            if (!opt_out_point) {\n+                break;\n+            }\n+            random_out_point = *opt_out_point;\n+            break;\n+        }\n+        case 7: {\n+            const std::optional<Coin> opt_coin = ConsumeDeserializable<Coin>(fuzzed_data_provider);\n+            if (!opt_coin) {\n+                break;\n+            }\n+            random_coin = *opt_coin;\n+            break;\n+        }\n+        case 8: {\n+            const std::optional<CMutableTransaction> opt_mutable_transaction = ConsumeDeserializable<CMutableTransaction>(fuzzed_data_provider);\n+            if (!opt_mutable_transaction) {\n+                break;\n+            }\n+            random_mutable_transaction = *opt_mutable_transaction;\n+            break;\n+        }\n+        case 9: {\n+            CCoinsMap coins_map;\n+            while (fuzzed_data_provider.ConsumeBool()) {\n+                CCoinsCacheEntry coins_cache_entry;\n+                coins_cache_entry.flags = fuzzed_data_provider.ConsumeIntegral<unsigned char>();\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    coins_cache_entry.coin = random_coin;\n+                } else {\n+                    const std::optional<Coin> opt_coin = ConsumeDeserializable<Coin>(fuzzed_data_provider);\n+                    if (!opt_coin) {\n+                        break;\n+                    }\n+                    coins_cache_entry.coin = *opt_coin;\n+                }\n+                if (fuzzed_data_provider.ConsumeBool()) {\n+                    const std::optional<COutPoint> opt_out_point = ConsumeDeserializable<COutPoint>(fuzzed_data_provider);\n+                    if (!opt_out_point) {\n+                        break;\n+                    }\n+                    random_out_point = *opt_out_point;\n+                }\n+                coins_map.emplace(random_out_point, std::move(coins_cache_entry));\n+            }\n+            bool expected_code_path = false;\n+            try {\n+                coins_view_cache.BatchWrite(coins_map, fuzzed_data_provider.ConsumeBool() ? ConsumeUInt256(fuzzed_data_provider) : coins_view_cache.GetBestBlock());\n+                expected_code_path = true;\n+            } catch (const std::logic_error& e) {\n+                if (e.what() == std::string{\"FRESH flag misapplied to coin that exists in parent cache\"}) {\n+                    expected_code_path = true;\n+                }\n+            }\n+            assert(expected_code_path);\n+            break;\n+        }\n+        }\n+    }\n+\n+    {\n+        const Coin& coin_using_access_coin = coins_view_cache.AccessCoin(random_out_point);\n+        const bool exists_using_access_coin = !(coin_using_access_coin == EMPTY_COIN);\n+        const bool exists_using_have_coin = coins_view_cache.HaveCoin(random_out_point);\n+        const bool exists_using_have_coin_in_cache = coins_view_cache.HaveCoinInCache(random_out_point);\n+        Coin coin_using_get_coin;\n+        const bool exists_using_get_coin = coins_view_cache.GetCoin(random_out_point, coin_using_get_coin);\n+        if (exists_using_get_coin) {\n+            assert(coin_using_get_coin == coin_using_access_coin);\n+        }\n+        assert((exists_using_access_coin && exists_using_have_coin_in_cache && exists_using_have_coin && exists_using_get_coin) ||\n+               (!exists_using_access_coin && !exists_using_have_coin_in_cache && !exists_using_have_coin && !exists_using_get_coin));\n+        const bool exists_using_have_coin_in_backend = backend_coins_view.HaveCoin(random_out_point);\n+        if (exists_using_have_coin_in_backend) {\n+            assert(exists_using_have_coin);\n+        }\n+        Coin coin_using_backend_get_coin;\n+        if (backend_coins_view.GetCoin(random_out_point, coin_using_backend_get_coin)) {\n+            assert(exists_using_have_coin_in_backend);\n+            assert(coin_using_get_coin == coin_using_backend_get_coin);\n+        } else {\n+            assert(!exists_using_have_coin_in_backend);\n+        }\n+    }\n+\n+    {\n+        bool expected_code_path = false;\n+        try {\n+            (void)coins_view_cache.Cursor();\n+        } catch (const std::logic_error&) {\n+            expected_code_path = true;\n+        }\n+        assert(expected_code_path);\n+        (void)coins_view_cache.DynamicMemoryUsage();\n+        (void)coins_view_cache.EstimateSize();\n+        (void)coins_view_cache.GetBestBlock();\n+        (void)coins_view_cache.GetCacheSize();\n+        (void)coins_view_cache.GetHeadBlocks();\n+        (void)coins_view_cache.HaveInputs(CTransaction{random_mutable_transaction});\n+    }\n+\n+    {\n+        const CCoinsViewCursor* coins_view_cursor = backend_coins_view.Cursor();\n+        assert(coins_view_cursor == nullptr);\n+        (void)backend_coins_view.EstimateSize();\n+        (void)backend_coins_view.GetBestBlock();\n+        (void)backend_coins_view.GetHeadBlocks();\n+    }\n+\n+    if (fuzzed_data_provider.ConsumeBool()) {\n+        switch (fuzzed_data_provider.ConsumeIntegralInRange<int>(0, 6)) {\n+        case 0: {\n+            const CTransaction transaction{random_mutable_transaction};\n+            bool is_spent = false;\n+            for (const CTxOut& tx_out : transaction.vout) {\n+                if (Coin{tx_out, 0, transaction.IsCoinBase()}.IsSpent()) {\n+                    is_spent = true;\n+                }\n+            }\n+            if (is_spent) {\n+                // Avoid:\n+                // coins.cpp:69: void CCoinsViewCache::AddCoin(const COutPoint &, Coin &&, bool): Assertion `!coin.IsSpent()' failed.\n+                break;\n+            }\n+            bool expected_code_path = false;\n+            try {\n+                AddCoins(coins_view_cache, transaction, fuzzed_data_provider.ConsumeIntegral<int>(), fuzzed_data_provider.ConsumeBool());\n+                expected_code_path = true;\n+            } catch (const std::logic_error& e) {\n+                if (e.what() == std::string{\"Attempted to overwrite an unspent coin (when possible_overwrite is false)\"}) {\n+                    expected_code_path = true;\n+                }\n+            }\n+            assert(expected_code_path);\n+            break;\n+        }\n+        case 1: {\n+            (void)AreInputsStandard(CTransaction{random_mutable_transaction}, coins_view_cache);\n+            break;\n+        }\n+        case 2: {\n+            TxValidationState state;\n+            CAmount tx_fee;\n+            const CTransaction transaction{random_mutable_transaction};\n+            if (ContainsSpentInput(transaction, coins_view_cache)) {\n+                // Avoid:\n+                // consensus/tx_verify.cpp:171: bool Consensus::CheckTxInputs(const CTransaction &, TxValidationState &, const CCoinsViewCache &, int, CAmount &): Assertion `!coin.IsSpent()' failed.\n+                break;\n+            }\n+            try {\n+                (void)Consensus::CheckTxInputs(transaction, state, coins_view_cache, fuzzed_data_provider.ConsumeIntegralInRange<int>(0, std::numeric_limits<int>::max()), tx_fee);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18867#discussion_r429648269",
      "id" : 429648269,
      "line" : 247,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY0ODI2OQ==",
      "original_commit_id" : "ab7af9323e55bd035d2680a84e986675c7757ee3",
      "original_line" : 247,
      "original_position" : 247,
      "original_start_line" : null,
      "path" : "src/test/fuzz/coins_view.cpp",
      "position" : 247,
      "pull_request_review_id" : 404982232,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18867",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-24T15:34:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429648269",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@MarcoFalke Thanks a lot for a very good review! All feedback addressed :)",
      "created_at" : "2020-05-25T10:07:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18867#issuecomment-633494293",
      "id" : 633494293,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18867",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMzQ5NDI5Mw==",
      "updated_at" : "2020-05-25T10:07:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/633494293",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   }
]
