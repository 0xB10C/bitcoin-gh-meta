[
   {
      "author_association" : "MEMBER",
      "body" : "This is an alternative to my preferred fix #18840",
      "created_at" : "2020-05-01T15:35:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18842#issuecomment-622437145",
      "id" : 622437145,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18842",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMjQzNzE0NQ==",
      "updated_at" : "2020-05-01T15:35:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/622437145",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/18842#issuecomment-622437145\r\n\r\n> This is an alternative to my preferred fix #18840\r\n\r\nfa3fdbfa89719797bba3b044b96caa984c5ff4be does seem a little fragile. I guess I was thinking of something more like:\r\n\r\n```diff\r\ndiff --git a/src/interfaces/chain.cpp b/src/interfaces/chain.cpp\r\nindex 0e7641ae320..8b288e62ff7 100644\r\n--- a/src/interfaces/chain.cpp\r\n+++ b/src/interfaces/chain.cpp\r\n@@ -309,6 +309,11 @@ public:\r\n         LOCK(::mempool.cs);\r\n         return IsRBFOptIn(tx, ::mempool);\r\n     }\r\n+    bool isInMempool(const uint256& txid) override\r\n+    {\r\n+        LOCK(::mempool.cs);\r\n+        return ::mempool.exists(txid);\r\n+    }\r\n     bool hasDescendantsInMempool(const uint256& txid) override\r\n     {\r\n         LOCK(::mempool.cs);\r\ndiff --git a/src/interfaces/chain.h b/src/interfaces/chain.h\r\nindex fb77c81cdcb..c76a361f261 100644\r\n--- a/src/interfaces/chain.h\r\n+++ b/src/interfaces/chain.h\r\n@@ -185,6 +185,9 @@ public:\r\n     //! Check if transaction is RBF opt in.\r\n     virtual RBFTransactionState isRBFOptIn(const CTransaction& tx) = 0;\r\n \r\n+    //! Check if transaction is in mempool.\r\n+    virtual bool isInMempool(const uint256& txid) = 0;\r\n+\r\n     //! Check if transaction has descendants in mempool.\r\n     virtual bool hasDescendantsInMempool(const uint256& txid) = 0;\r\n \r\ndiff --git a/src/wallet/wallet.cpp b/src/wallet/wallet.cpp\r\nindex 7a6deab1a8c..833414d4880 100644\r\n--- a/src/wallet/wallet.cpp\r\n+++ b/src/wallet/wallet.cpp\r\n@@ -707,6 +707,12 @@ bool CWallet::MarkReplaced(const uint256& originalHash, const uint256& newHash)\r\n \r\n     wtx.mapValue[\"replaced_by_txid\"] = newHash.ToString();\r\n \r\n+    // Refresh mempool status without waiting for transactionRemovedFromMempool\r\n+    // notification so the wallet is in an internally consistent state and\r\n+    // immediately knows the old transaction should not be considered trusted\r\n+    // and is eligible to be abandoned\r\n+    wtx.fInMempool = chain().isInMempool(originalHash);\r\n+\r\n     WalletBatch batch(*database, \"r+\");\r\n \r\n     bool success = true;\r\n```\r\n",
      "created_at" : "2020-05-01T17:45:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18842#issuecomment-622489245",
      "id" : 622489245,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18842",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMjQ4OTI0NQ==",
      "updated_at" : "2020-05-01T17:45:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/622489245",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.\r\n\r\nThis looks a bug to me, a test would be nice.\r\n\r\n@ryanofsky how could `chain().isInMempool(originalHash)` be true?\r\n\r\nI find odd that `mapValue[\"replaces_txid\"]` is updated in feebumper and `mapValue[\"replaced_by_txid\"]` is updated in wallet. Maybe we could move `CWallet::MarkReplaced` to feebumper.",
      "created_at" : "2020-08-15T00:13:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18842#issuecomment-674318296",
      "id" : 674318296,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18842",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3NDMxODI5Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-15T00:13:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/674318296",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #19980 (refactor: Some wallet cleanups by promag)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-09-20T04:22:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18842#issuecomment-695690717",
      "id" : 695690717,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18842",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5NTY5MDcxNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-20T04:22:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/695690717",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   }
]
