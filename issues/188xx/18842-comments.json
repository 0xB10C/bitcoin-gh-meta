[
   {
      "author_association" : "MEMBER",
      "body" : "This is an alternative to my preferred fix #18840",
      "created_at" : "2020-05-01T15:35:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18842#issuecomment-622437145",
      "id" : 622437145,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18842",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMjQzNzE0NQ==",
      "updated_at" : "2020-05-01T15:35:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/622437145",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/18842#issuecomment-622437145\r\n\r\n> This is an alternative to my preferred fix #18840\r\n\r\nfa3fdbfa89719797bba3b044b96caa984c5ff4be does seem a little fragile. I guess I was thinking of something more like:\r\n\r\n```diff\r\ndiff --git a/src/interfaces/chain.cpp b/src/interfaces/chain.cpp\r\nindex 0e7641ae320..8b288e62ff7 100644\r\n--- a/src/interfaces/chain.cpp\r\n+++ b/src/interfaces/chain.cpp\r\n@@ -309,6 +309,11 @@ public:\r\n         LOCK(::mempool.cs);\r\n         return IsRBFOptIn(tx, ::mempool);\r\n     }\r\n+    bool isInMempool(const uint256& txid) override\r\n+    {\r\n+        LOCK(::mempool.cs);\r\n+        return ::mempool.exists(txid);\r\n+    }\r\n     bool hasDescendantsInMempool(const uint256& txid) override\r\n     {\r\n         LOCK(::mempool.cs);\r\ndiff --git a/src/interfaces/chain.h b/src/interfaces/chain.h\r\nindex fb77c81cdcb..c76a361f261 100644\r\n--- a/src/interfaces/chain.h\r\n+++ b/src/interfaces/chain.h\r\n@@ -185,6 +185,9 @@ public:\r\n     //! Check if transaction is RBF opt in.\r\n     virtual RBFTransactionState isRBFOptIn(const CTransaction& tx) = 0;\r\n \r\n+    //! Check if transaction is in mempool.\r\n+    virtual bool isInMempool(const uint256& txid) = 0;\r\n+\r\n     //! Check if transaction has descendants in mempool.\r\n     virtual bool hasDescendantsInMempool(const uint256& txid) = 0;\r\n \r\ndiff --git a/src/wallet/wallet.cpp b/src/wallet/wallet.cpp\r\nindex 7a6deab1a8c..833414d4880 100644\r\n--- a/src/wallet/wallet.cpp\r\n+++ b/src/wallet/wallet.cpp\r\n@@ -707,6 +707,12 @@ bool CWallet::MarkReplaced(const uint256& originalHash, const uint256& newHash)\r\n \r\n     wtx.mapValue[\"replaced_by_txid\"] = newHash.ToString();\r\n \r\n+    // Refresh mempool status without waiting for transactionRemovedFromMempool\r\n+    // notification so the wallet is in an internally consistent state and\r\n+    // immediately knows the old transaction should not be considered trusted\r\n+    // and is eligible to be abandoned\r\n+    wtx.fInMempool = chain().isInMempool(originalHash);\r\n+\r\n     WalletBatch batch(*database, \"r+\");\r\n \r\n     bool success = true;\r\n```\r\n",
      "created_at" : "2020-05-01T17:45:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18842#issuecomment-622489245",
      "id" : 622489245,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18842",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMjQ4OTI0NQ==",
      "updated_at" : "2020-05-01T17:45:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/622489245",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   }
]
