[
   {
      "body" : "> event_base_loopbreak was not doing what I expected it to. What I expected was that it sets a timeout, given that no other pending events it would exit in N seconds. However, what it does was delay the event loop exit with N seconds, even if nothing is pending.\r\n\r\n~~Sounds like you wanted `event_base_loopexit`? Ref:~~\r\n\r\n> The next event_base_loop() iteration after the given timer expires will complete normally (handling all queued events) then exit without blocking for events again.\r\n\r\n~~In any case, `event_base_loopbreak` should still exit immediately, stopping any `loop`s after the next event:~~\r\n\r\n> event_base_loop() will abort the loop after the next event is completed; event_base_loopbreak() is typically invoked from this event's callback. This behavior is analogous to the \"break;\" statement.\r\n\r\nAre you sure this isn't symptomatic of something else?\r\n\r\nReference: http://www.wangafu.net/~nickm/libevent-2.0/doxygen/html/event_8h.html#a07a7599e478e4031fa8cf52e26d8aa1e\r\n\r\n**edit**: Right, never mind, you were using `event_base_loopexit`, hence the confusion.  You're OP makes it sound like you switched from `event_base_loopbreak`.",
      "created_at" : "2015-11-11T21:01:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6990#issuecomment-155908505",
      "id" : 155908505,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6990",
      "updated_at" : "2015-11-11T21:28:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/155908505",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/413395?v=3",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6990#discussion_r44586134"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6990"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/44586134"
         }
      },
      "body" : "Out of interest, why do we have to wait [a hard coded timeout]?  Why can't we wait for all events to finish (and maybe just ignore all new incoming connections?)",
      "commit_id" : "856be4fe46bfc4194afc10f424a03a5fb09af76a",
      "created_at" : "2015-11-11T21:06:00Z",
      "diff_hunk" : "@@ -480,6 +475,14 @@ void StopHTTPServer()\n         workQueue->WaitExit();\n         delete workQueue;\n     }\n+    if (eventBase) {\n+        LogPrint(\"http\", \"Waiting for HTTP event thread to exit\\n\");\n+        // Give event loop a few seconds to exit (to send back last RPC responses), then break it\n+        if (!threadHTTP.try_join_for(boost::chrono::milliseconds(2000))) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6990#discussion_r44586134",
      "id" : 44586134,
      "original_commit_id" : "856be4fe46bfc4194afc10f424a03a5fb09af76a",
      "original_position" : 42,
      "path" : "src/httpserver.cpp",
      "position" : 42,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6990",
      "updated_at" : "2015-11-11T21:06:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/44586134",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/413395?v=3",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "body" : "utACK",
      "created_at" : "2015-11-11T21:06:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6990#issuecomment-155910770",
      "id" : 155910770,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6990",
      "updated_at" : "2015-11-11T21:06:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/155910770",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/413395?v=3",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6990#discussion_r44586809"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6990"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/44586809"
         }
      },
      "body" : "> all events to finish\r\n\r\nmay take a long time (minutes) depending what was going in in the past?",
      "commit_id" : "856be4fe46bfc4194afc10f424a03a5fb09af76a",
      "created_at" : "2015-11-11T21:11:48Z",
      "diff_hunk" : "@@ -480,6 +475,14 @@ void StopHTTPServer()\n         workQueue->WaitExit();\n         delete workQueue;\n     }\n+    if (eventBase) {\n+        LogPrint(\"http\", \"Waiting for HTTP event thread to exit\\n\");\n+        // Give event loop a few seconds to exit (to send back last RPC responses), then break it\n+        if (!threadHTTP.try_join_for(boost::chrono::milliseconds(2000))) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6990#discussion_r44586809",
      "id" : 44586809,
      "original_commit_id" : "856be4fe46bfc4194afc10f424a03a5fb09af76a",
      "original_position" : 42,
      "path" : "src/httpserver.cpp",
      "position" : 42,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6990",
      "updated_at" : "2015-11-11T21:11:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/44586809",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=3",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6990#discussion_r44588682"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6990"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/44588682"
         }
      },
      "body" : "@MarcoFalke but this doesn't stop new connections (or is that done elsewhere?) in that waiting time.  So conceptually, the status quo could be the same?\r\nThat is, new connections coming in, old ones still finishing. ",
      "commit_id" : "856be4fe46bfc4194afc10f424a03a5fb09af76a",
      "created_at" : "2015-11-11T21:27:44Z",
      "diff_hunk" : "@@ -480,6 +475,14 @@ void StopHTTPServer()\n         workQueue->WaitExit();\n         delete workQueue;\n     }\n+    if (eventBase) {\n+        LogPrint(\"http\", \"Waiting for HTTP event thread to exit\\n\");\n+        // Give event loop a few seconds to exit (to send back last RPC responses), then break it\n+        if (!threadHTTP.try_join_for(boost::chrono::milliseconds(2000))) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6990#discussion_r44588682",
      "id" : 44588682,
      "original_commit_id" : "856be4fe46bfc4194afc10f424a03a5fb09af76a",
      "original_position" : 42,
      "path" : "src/httpserver.cpp",
      "position" : 42,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6990",
      "updated_at" : "2015-11-11T21:28:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/44588682",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/413395?v=3",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   }
]
