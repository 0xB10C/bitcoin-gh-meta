[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK\r\n\r\nWill code-review tomorrow. At a first glance, most parts of the diff look straight-forward, the change in the rate-limiting logic (swapping the if conditions) needs probably most attention.\r\nTo speed up review, adding links to each of the review comments in #22387 that are tackled in this PR could be a good idea.\r\n\r\n(the AppVeyor CI build fail seems to be not caused by this PR's changes, by the way)",
      "created_at" : "2021-08-02T20:50:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22604#issuecomment-891323675",
      "id" : 891323675,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22604",
      "node_id" : "IC_kwDOABII5841IIUb",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-02T20:50:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/891323675",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22604#discussion_r681266426"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22604"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/681266426"
         }
      },
      "author_association" : "MEMBER",
      "body" : "addresses the feedback here: https://github.com/bitcoin/bitcoin/pull/22387/files#r665882202",
      "commit_id" : "b7c4b058ba2625a39666636253620bc08a41c501",
      "created_at" : "2021-08-02T20:57:47Z",
      "diff_hunk" : "@@ -241,14 +241,14 @@ struct Peer {\n     std::atomic_bool m_wants_addrv2{false};\n     /** Whether this peer has already sent us a getaddr message. */\n     bool m_getaddr_recvd{false};\n-    /** Number of addr messages that can be processed from this peer. Start at 1 to\n+    /** Number of addresses that can be processed from this peer. Start at 1 to",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22604#discussion_r681266426",
      "id" : 681266426,
      "line" : 244,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MTI2NjQyNg==",
      "original_commit_id" : "b7c4b058ba2625a39666636253620bc08a41c501",
      "original_line" : 244,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 14,
      "pull_request_review_id" : 720587355,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22604",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-02T21:02:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/681266426",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22604#discussion_r681266812"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22604"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/681266812"
         }
      },
      "author_association" : "MEMBER",
      "body" : "proposed here: https://github.com/bitcoin/bitcoin/pull/22387/files#r672410564",
      "commit_id" : "b7c4b058ba2625a39666636253620bc08a41c501",
      "created_at" : "2021-08-02T20:58:24Z",
      "diff_hunk" : "@@ -2817,11 +2817,12 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                 return;\n \n             // Apply rate limiting.\n-            if (rate_limited) {\n-                if (peer->m_addr_token_bucket < 1.0) {\n+            if (peer->m_addr_token_bucket < 1.0) {\n+                if (rate_limited) {\n                     ++num_rate_limit;\n                     continue;\n                 }\n+            } else {\n                 peer->m_addr_token_bucket -= 1.0;\n             }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22604#discussion_r681266812",
      "id" : 681266812,
      "line" : 2827,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MTI2NjgxMg==",
      "original_commit_id" : "b7c4b058ba2625a39666636253620bc08a41c501",
      "original_line" : 2827,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 39,
      "pull_request_review_id" : 720587355,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22604",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-02T21:02:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/681266812",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22604#discussion_r681267120"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22604"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/681267120"
         }
      },
      "author_association" : "MEMBER",
      "body" : "suggested here: https://github.com/bitcoin/bitcoin/pull/22387/files#r672414835",
      "commit_id" : "b7c4b058ba2625a39666636253620bc08a41c501",
      "created_at" : "2021-08-02T20:58:57Z",
      "diff_hunk" : "@@ -2849,12 +2850,8 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n         peer->m_addr_processed += num_proc;\n         peer->m_addr_rate_limited += num_rate_limit;\n-        LogPrint(BCLog::NET, \"Received addr: %u addresses (%u processed, %u rate-limited) from peer=%d%s\\n\",\n-                 vAddr.size(),\n-                 num_proc,\n-                 num_rate_limit,\n-                 pfrom.GetId(),\n-                 fLogIPs ? \", peeraddr=\" + pfrom.addr.ToString() : \"\");\n+        LogPrint(BCLog::NET, \"Received addr: %u addresses (%u processed, %u rate-limited) from peer=%d\\n\",\n+                 vAddr.size(), num_proc, num_rate_limit, pfrom.GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22604#discussion_r681267120",
      "id" : 681267120,
      "line" : 2854,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MTI2NzEyMA==",
      "original_commit_id" : "b7c4b058ba2625a39666636253620bc08a41c501",
      "original_line" : 2854,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 52,
      "pull_request_review_id" : 720587355,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22604",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-02T21:02:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/681267120",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22604#discussion_r681267369"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22604"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/681267369"
         }
      },
      "author_association" : "MEMBER",
      "body" : "mentioned here: https://github.com/bitcoin/bitcoin/pull/22387/files#r672417898",
      "commit_id" : "b7c4b058ba2625a39666636253620bc08a41c501",
      "created_at" : "2021-08-02T20:59:22Z",
      "diff_hunk" : "@@ -150,6 +150,8 @@ static RPCHelpMan getpeerinfo()\n                             {\n                                 {RPCResult::Type::NUM, \"n\", \"The heights of blocks we're currently asking from this peer\"},\n                             }},\n+                            {RPCResult::Type::NUM, \"addr_processed\", \"The total number of addresses processed, excluding those dropped due to rate limiting\"},\n+                            {RPCResult::Type::NUM, \"addr_rate_limited\", \"The total number of addresses dropped due to rate limiting\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22604#discussion_r681267369",
      "id" : 681267369,
      "line" : 154,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MTI2NzM2OQ==",
      "original_commit_id" : "b7c4b058ba2625a39666636253620bc08a41c501",
      "original_line" : 154,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 5,
      "pull_request_review_id" : 720587355,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22604",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-02T21:02:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/681267369",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22604#discussion_r681267728"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22604"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/681267728"
         }
      },
      "author_association" : "MEMBER",
      "body" : "review feedback here: https://github.com/bitcoin/bitcoin/pull/22387/files#r671144448",
      "commit_id" : "b7c4b058ba2625a39666636253620bc08a41c501",
      "created_at" : "2021-08-02T21:00:04Z",
      "diff_hunk" : "@@ -257,45 +257,45 @@ def send_addrs_and_test_rate_limiting(self, peer, no_relay, new_addrs, total_add\n             assert_equal(addrs_rate_limited, max(0, total_addrs - peer.tokens))\n \n     def rate_limit_tests(self):\n-\n         self.mocktime = int(time.time())\n         self.restart_node(0, [])\n         self.nodes[0].setmocktime(self.mocktime)\n \n-        for contype, no_relay in [(\"outbound-full-relay\", False), (\"block-relay-only\", True), (\"inbound\", False)]:\n-            self.log.info(f'Test rate limiting of addr processing for {contype} peers')\n-            if contype == \"inbound\":\n+        for conn_type, no_relay in [(\"outbound-full-relay\", False), (\"block-relay-only\", True), (\"inbound\", False)]:\n+            self.log.info(f'Test rate limiting of addr processing for {conn_type} peers')\n+            if conn_type == \"inbound\":\n                 peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n             else:\n-                peer = self.nodes[0].add_outbound_p2p_connection(AddrReceiver(), p2p_idx=0, connection_type=contype)\n+                peer = self.nodes[0].add_outbound_p2p_connection(AddrReceiver(), p2p_idx=0, connection_type=conn_type)\n \n             # Send 600 addresses. For all but the block-relay-only peer this should result in addresses being processed.\n-            self.send_addrs_and_test_rate_limiting(peer, no_relay, 600, 600)\n+            self.send_addrs_and_test_rate_limiting(peer, no_relay, new_addrs=600, total_addrs=600)\n \n             # Send 600 more addresses. For the outbound-full-relay peer (which we send a GETADDR, and thus will\n             # process up to 1001 incoming addresses), this means more addresses will be processed.\n-            self.send_addrs_and_test_rate_limiting(peer, no_relay, 600, 1200)\n+            self.send_addrs_and_test_rate_limiting(peer, no_relay, new_addrs=600, total_addrs=1200)\n \n             # Send 10 more. As we reached the processing limit for all nodes, no more addresses should be procesesd.\n-            self.send_addrs_and_test_rate_limiting(peer, no_relay, 10, 1210)\n+            self.send_addrs_and_test_rate_limiting(peer, no_relay, new_addrs=10, total_addrs=1210)\n \n             # Advance the time by 100 seconds, permitting the processing of 10 more addresses.\n             # Send 200 and verify that 10 are processed.\n             self.mocktime += 100\n             self.nodes[0].setmocktime(self.mocktime)\n             peer.increment_tokens(10)\n \n-            self.send_addrs_and_test_rate_limiting(peer, no_relay, 200, 1410)\n+            self.send_addrs_and_test_rate_limiting(peer, no_relay, new_addrs=200, total_addrs=1410)\n \n             # Advance the time by 1000 seconds, permitting the processing of 100 more addresses.\n             # Send 200 and verify that 100 are processed.\n             self.mocktime += 1000\n             self.nodes[0].setmocktime(self.mocktime)\n             peer.increment_tokens(100)\n \n-            self.send_addrs_and_test_rate_limiting(peer, no_relay, 200, 1610)\n+            self.send_addrs_and_test_rate_limiting(peer, no_relay, new_addrs=200, total_addrs=1610)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22604#discussion_r681267728",
      "id" : 681267728,
      "line" : 295,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MTI2NzcyOA==",
      "original_commit_id" : "b7c4b058ba2625a39666636253620bc08a41c501",
      "original_line" : 295,
      "original_position" : 58,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 58,
      "pull_request_review_id" : 720587355,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22604",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-02T21:02:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/681267728",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2021-08-02T21:07:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22604#issuecomment-891333553",
      "id" : 891333553,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22604",
      "node_id" : "IC_kwDOABII5841IKux",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-02T21:07:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/891333553",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   }
]
