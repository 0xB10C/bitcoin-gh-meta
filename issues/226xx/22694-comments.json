[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Tagging @theuni @hebasto @dongcarl since we discussed this a bit",
      "created_at" : "2021-08-16T16:15:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22694#issuecomment-899637959",
      "id" : 899637959,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22694",
      "node_id" : "IC_kwDOABII5841n2LH",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-16T16:15:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/899637959",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I missed the discussion so am probably missing some context. One potential issue could be that depends build logs become a bit less usable, if they end up being a mashup of overlapping build jobs, rather than packages being built sequentially?\r\n\r\nAre there more benefits / depends improvements you have in mind, other than just faster builds, which are dependent on this change? I think the fact that we currently have (slower) sequential builds is somewhat offset by heavy caching, and that packages are updated infrequently. A builder is going to see the most benefit from parallelism when doing an initial build (and download) from scratch.\r\n\r\n",
      "created_at" : "2021-08-17T04:05:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22694#issuecomment-899976719",
      "id" : 899976719,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22694",
      "node_id" : "IC_kwDOABII5841pI4P",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-17T04:05:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/899976719",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> I missed the discussion so am probably missing some context. One potential issue could be that depends build logs become a bit less usable, if they end up being a mashup of overlapping build jobs, rather than packages being built sequentially?\r\n\r\nmake has a command line option to synchronize its output. See https://www.gnu.org/software/make/manual/make.html#Terminal-Output.\r\n\r\n\r\n> Are there more benefits / depends improvements you have in mind, other than just faster builds, which are dependent on this change?\r\n\r\nNo, just performance.\r\n\r\n\r\n> I think the fact that we currently have (slower) sequential builds is somewhat offset by heavy caching, and that packages are updated infrequently. A builder is going to see the most benefit from parallelism when doing an initial build (and download) from scratch.\r\n\r\nAgree.\r\n\r\n",
      "created_at" : "2021-08-17T12:23:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22694#issuecomment-900251206",
      "id" : 900251206,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22694",
      "node_id" : "IC_kwDOABII5841qL5G",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-17T12:23:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/900251206",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/74753?v=4",
         "events_url" : "https://api.github.com/users/dgoncharov/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dgoncharov/followers",
         "following_url" : "https://api.github.com/users/dgoncharov/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dgoncharov/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dgoncharov",
         "id" : 74753,
         "login" : "dgoncharov",
         "node_id" : "MDQ6VXNlcjc0NzUz",
         "organizations_url" : "https://api.github.com/users/dgoncharov/orgs",
         "received_events_url" : "https://api.github.com/users/dgoncharov/received_events",
         "repos_url" : "https://api.github.com/users/dgoncharov/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dgoncharov/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dgoncharov/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dgoncharov"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Just removing `.NOTPARALLEL`\r\n\r\n```diff\r\n--- a/depends/Makefile\r\n+++ b/depends/Makefile\r\n@@ -1,5 +1,3 @@\r\n-.NOTPARALLEL :\r\n-\r\n # Pattern rule to print variables, e.g. make print-top_srcdir\r\n print-%: FORCE\r\n        @echo '$*'='$($*)'\r\n```\r\n\r\nis not working as expected.\r\n\r\nWith `make -j 8 -C depends` many packages have not being built at all.",
      "created_at" : "2021-08-17T13:45:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22694#issuecomment-900312006",
      "id" : 900312006,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22694",
      "node_id" : "IC_kwDOABII5841qavG",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-17T13:45:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/900312006",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> make has a command line option to synchronize its output. \r\n\r\nAs long as this is integrated into depends, so that users get useful make output by default.\r\n\r\n> is not working as expected.\r\n> With make -j 8 -C depends many packages have not being built at all.\r\n\r\nI was seeing issues too, maybe the original reason that `.NOTPARALLEL` was added, and it looked like miniupnpc might be the problem, however I can build with `.NOTPARALLEL` removed, using `gmake -C depends -j9 --output-sync --no-print-directory`  and it's building all packages.\r\n\r\nWith everything downloaded, a full depends build actually seems to be slower for me, with `.NOTPARALLEL` removed. Will perform better benchmarks soon.",
      "created_at" : "2021-08-18T07:37:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22694#issuecomment-900891230",
      "id" : 900891230,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22694",
      "node_id" : "IC_kwDOABII5841soJe",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-18T07:37:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/900891230",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> Just removing `.NOTPARALLEL`\r\n> is not working as expected.\r\n> With `make -j 8 -C depends` many packages have not being built at all.\r\n\r\nSome of the packages depend on other packages. E.g. fontconfig depends on freetype. i suspect rules are missing which would tell make about this dependency. It will take a few days before i can properly look at it and provide a more precise answer.\r\n\r\n",
      "created_at" : "2021-08-18T14:13:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22694#issuecomment-901150361",
      "id" : 901150361,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22694",
      "node_id" : "IC_kwDOABII5841tnaZ",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-18T14:13:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/901150361",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/74753?v=4",
         "events_url" : "https://api.github.com/users/dgoncharov/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dgoncharov/followers",
         "following_url" : "https://api.github.com/users/dgoncharov/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dgoncharov/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dgoncharov",
         "id" : 74753,
         "login" : "dgoncharov",
         "node_id" : "MDQ6VXNlcjc0NzUz",
         "organizations_url" : "https://api.github.com/users/dgoncharov/orgs",
         "received_events_url" : "https://api.github.com/users/dgoncharov/received_events",
         "repos_url" : "https://api.github.com/users/dgoncharov/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dgoncharov/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dgoncharov/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dgoncharov"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> > make has a command line option to synchronize its output.\r\n> As long as this is integrated into depends, so that users get useful make output by default.\r\n\r\nThere is another pr which adds -r to MAKEFLAGS. https://github.com/bitcoin/bitcoin/pull/22126. We could as well add -O.\r\nAnother option is to leave this to the user to specify this option.\r\n",
      "created_at" : "2021-08-18T14:15:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22694#issuecomment-901152687",
      "id" : 901152687,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22694",
      "node_id" : "IC_kwDOABII5841tn-v",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-18T14:15:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/901152687",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/74753?v=4",
         "events_url" : "https://api.github.com/users/dgoncharov/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dgoncharov/followers",
         "following_url" : "https://api.github.com/users/dgoncharov/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dgoncharov/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dgoncharov",
         "id" : 74753,
         "login" : "dgoncharov",
         "node_id" : "MDQ6VXNlcjc0NzUz",
         "organizations_url" : "https://api.github.com/users/dgoncharov/orgs",
         "received_events_url" : "https://api.github.com/users/dgoncharov/received_events",
         "repos_url" : "https://api.github.com/users/dgoncharov/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dgoncharov/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dgoncharov/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dgoncharov"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "The reason of the failure without `.NOTPARALLEL` is a race for `$(host_prefix)` directory.\r\n\r\nWith the following diff:\r\n```diff\r\ndiff --git a/depends/Makefile b/depends/Makefile\r\nindex a3b9cd209..72198f71e 100644\r\n--- a/depends/Makefile\r\n+++ b/depends/Makefile\r\n@@ -1,5 +1,3 @@\r\n-.NOTPARALLEL :\r\n-\r\n # Pattern rule to print variables, e.g. make print-top_srcdir\r\n print-%: FORCE\r\n        @echo '$*'='$($*)'\r\ndiff --git a/depends/funcs.mk b/depends/funcs.mk\r\nindex 34a030fab..975d5d29e 100644\r\n--- a/depends/funcs.mk\r\n+++ b/depends/funcs.mk\r\n@@ -207,7 +207,7 @@ $($(1)_preprocessed): | $($(1)_extracted)\r\n        $(AT)touch $$@\r\n $($(1)_configured): | $($(1)_dependencies) $($(1)_preprocessed)\r\n        $(AT)echo Configuring $(1)...\r\n-       $(AT)rm -rf $(host_prefix); mkdir -p $(host_prefix)/lib; cd $(host_prefix); $(foreach package,$($(1)_all_dependencies), tar --no-same-owner -xf $($(package)_cached); )\r\n+       $(AT)mkdir -p $(host_prefix)/lib; cd $(host_prefix); $(foreach package,$($(1)_all_dependencies), tar --no-same-owner -xf $($(package)_cached); )\r\n        $(AT)mkdir -p $$(@D)\r\n        $(AT)+cd $$(@D); $($(1)_config_env) $(call $(1)_config_cmds, $(1))\r\n        $(AT)touch $$@\r\n```\r\n\r\nI've got\r\n```\r\n$ make -C depends clean\r\n$ time make -j 9 -C depends\r\n...\r\n\r\nreal\t4m23,409s\r\nuser\t25m18,663s\r\nsys\t1m58,159s\r\n```\r\n\r\n---\r\n\r\nOn master (b6a8e68b4e11be3aa5ceff8c483594f8e576faaf):\r\n```\r\n$ make -C depends clean\r\n$ time make -j 9 -C depends\r\n...\r\n\r\nreal\t6m13,353s\r\nuser\t24m18,275s\r\nsys\t2m5,152s\r\n```",
      "created_at" : "2021-08-19T21:46:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22694#issuecomment-902270208",
      "id" : 902270208,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22694",
      "node_id" : "IC_kwDOABII5841x40A",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-19T21:46:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/902270208",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   }
]
