[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "See also https://en.wikipedia.org/wiki/Principle_of_least_astonishment",
      "created_at" : "2021-08-06T15:17:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22651#issuecomment-894331601",
      "id" : 894331601,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22651",
      "node_id" : "IC_kwDOABII5841TmrR",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-06T15:17:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/894331601",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept/Approach ACK. It may be good to have functional test coverage (or make it a separate function with unit tests).",
      "created_at" : "2021-08-06T15:32:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22651#issuecomment-894340417",
      "id" : 894340417,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22651",
      "node_id" : "IC_kwDOABII5841To1B",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-06T18:48:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/894340417",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22651#discussion_r684419652"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/684419652"
         }
      },
      "author_association" : "MEMBER",
      "body" : "A function seems nicer than a localvar here (optionally declare in header file for unit testing)\r\n```diff\r\n+bool AllowOutboundOnion()\r\n+{\r\n+    if (!gArgs.IsArgSet(\"-onlynet\")) return true;\r\n+    for (const auto& net : gArgs.GetArgs(\"-onlynet\")) {\r\n+        if (ParseNetwork(net) == NET_ONION) return true;\r\n+    }\r\n+    return false;\r\n+}\r\n          // Now that we know Tor is running, possibly set the proxy for onion addresses.\r\n-        bool allow_outbound_onion{true};\r\n-        if (gArgs.IsArgSet(\"-onlynet\")) {\r\n-            allow_outbound_onion = false;\r\n-            for (const auto& net : gArgs.GetArgs(\"-onlynet\")) {\r\n-                if (ParseNetwork(net) == NET_ONION) {\r\n-                    allow_outbound_onion = true;\r\n-                    break;\r\n-                }\r\n-            }\r\n-        }\r\n-        if (gArgs.GetArg(\"-onion\", \"\") == \"\" && allow_outbound_onion) {\r\n+        if (gArgs.GetArg(\"-onion\", \"\").empty() && AllowOutboundOnion()) {\r\n```\r\n",
      "commit_id" : "4f4c7d8b117e8a9cfb2430d2fc9f420ef48b4f6d",
      "created_at" : "2021-08-06T18:12:03Z",
      "diff_hunk" : "@@ -373,9 +373,18 @@ void TorController::auth_cb(TorControlConnection& _conn, const TorControlReply&\n     if (reply.code == 250) {\n         LogPrint(BCLog::TOR, \"tor: Authentication successful\\n\");\n \n-        // Now that we know Tor is running setup the proxy for onion addresses\n-        // if -onion isn't set to something else.\n-        if (gArgs.GetArg(\"-onion\", \"\") == \"\") {\n+        // Now that we know Tor is running, possibly set the proxy for onion addresses.\n+        bool allow_outbound_onion{true};\n+        if (gArgs.IsArgSet(\"-onlynet\")) {\n+            allow_outbound_onion = false;\n+            for (const auto& net : gArgs.GetArgs(\"-onlynet\")) {\n+                if (ParseNetwork(net) == NET_ONION) {\n+                    allow_outbound_onion = true;\n+                    break;\n+                }\n+            }\n+        }\n+        if (gArgs.GetArg(\"-onion\", \"\") == \"\" && allow_outbound_onion) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22651#discussion_r684419652",
      "id" : 684419652,
      "line" : 387,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NDQxOTY1Mg==",
      "original_commit_id" : "4f4c7d8b117e8a9cfb2430d2fc9f420ef48b4f6d",
      "original_line" : 387,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/torcontrol.cpp",
      "position" : 18,
      "pull_request_review_id" : 724602061,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-06T18:43:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/684419652",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22651#discussion_r684429929"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/684429929"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Tested with this patch on mainnet:\r\n- `onlynet=i2p`: only I2P outbound connections are made (i2pd 2.23)\r\n- `onlynet=ipv4`: only IPv4 outbound connections are made\r\n- `onlynet=onion`: only onion outbound connections are made (tor 0.4.6)",
      "commit_id" : "4f4c7d8b117e8a9cfb2430d2fc9f420ef48b4f6d",
      "created_at" : "2021-08-06T18:31:42Z",
      "diff_hunk" : "@@ -373,9 +373,18 @@ void TorController::auth_cb(TorControlConnection& _conn, const TorControlReply&\n     if (reply.code == 250) {\n         LogPrint(BCLog::TOR, \"tor: Authentication successful\\n\");\n \n-        // Now that we know Tor is running setup the proxy for onion addresses\n-        // if -onion isn't set to something else.\n-        if (gArgs.GetArg(\"-onion\", \"\") == \"\") {\n+        // Now that we know Tor is running, possibly set the proxy for onion addresses.\n+        bool allow_outbound_onion{true};\n+        if (gArgs.IsArgSet(\"-onlynet\")) {\n+            allow_outbound_onion = false;\n+            for (const auto& net : gArgs.GetArgs(\"-onlynet\")) {\n+                if (ParseNetwork(net) == NET_ONION) {\n+                    allow_outbound_onion = true;\n+                    break;\n+                }\n+            }\n+        }\n+        if (gArgs.GetArg(\"-onion\", \"\") == \"\" && allow_outbound_onion) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22651#discussion_r684429929",
      "id" : 684429929,
      "in_reply_to_id" : 684419652,
      "line" : 387,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NDQyOTkyOQ==",
      "original_commit_id" : "4f4c7d8b117e8a9cfb2430d2fc9f420ef48b4f6d",
      "original_line" : 387,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/torcontrol.cpp",
      "position" : 18,
      "pull_request_review_id" : 724615495,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-06T18:31:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/684429929",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> See also https://en.wikipedia.org/wiki/Principle_of_least_astonishment\r\n\r\nThis link says \"The behavior should not astonish or surprise users\"\r\n\r\nI am surprised by lot of things in Bitcoin Core ð\r\n\r\nConcept ACK. Doesn't make sense to create outbound connections with onion peers if `onlynet=i2p` is used.",
      "created_at" : "2021-08-06T18:34:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22651#issuecomment-894444992",
      "id" : 894444992,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22651",
      "node_id" : "IC_kwDOABII5841UCXA",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-06T18:34:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/894444992",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/13405205?v=4",
         "events_url" : "https://api.github.com/users/prayank23/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prayank23/followers",
         "following_url" : "https://api.github.com/users/prayank23/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prayank23/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prayank23",
         "id" : 13405205,
         "login" : "prayank23",
         "node_id" : "MDQ6VXNlcjEzNDA1MjA1",
         "organizations_url" : "https://api.github.com/users/prayank23/orgs",
         "received_events_url" : "https://api.github.com/users/prayank23/received_events",
         "repos_url" : "https://api.github.com/users/prayank23/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prayank23/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prayank23/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prayank23"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22651#discussion_r684434758"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/684434758"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Tested combinations (all tests using the proposed function version ;)\r\n- `onlynet=i2p` and `onlynet=onion`: only I2P and onion outbound connections are made\r\n- `onlynet=ipv4` and `onlynet=onion`: only IPv4 and onion outbound connections are made\r\n- `onlynet=ipv4` and `onlynet=i2p`: only IPv4 and I2P outbound connections are made\r\n\r\n(Test coverage for these cases--single onlynet and combinations--would be great.)",
      "commit_id" : "4f4c7d8b117e8a9cfb2430d2fc9f420ef48b4f6d",
      "created_at" : "2021-08-06T18:40:19Z",
      "diff_hunk" : "@@ -373,9 +373,18 @@ void TorController::auth_cb(TorControlConnection& _conn, const TorControlReply&\n     if (reply.code == 250) {\n         LogPrint(BCLog::TOR, \"tor: Authentication successful\\n\");\n \n-        // Now that we know Tor is running setup the proxy for onion addresses\n-        // if -onion isn't set to something else.\n-        if (gArgs.GetArg(\"-onion\", \"\") == \"\") {\n+        // Now that we know Tor is running, possibly set the proxy for onion addresses.\n+        bool allow_outbound_onion{true};\n+        if (gArgs.IsArgSet(\"-onlynet\")) {\n+            allow_outbound_onion = false;\n+            for (const auto& net : gArgs.GetArgs(\"-onlynet\")) {\n+                if (ParseNetwork(net) == NET_ONION) {\n+                    allow_outbound_onion = true;\n+                    break;\n+                }\n+            }\n+        }\n+        if (gArgs.GetArg(\"-onion\", \"\") == \"\" && allow_outbound_onion) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22651#discussion_r684434758",
      "id" : 684434758,
      "in_reply_to_id" : 684419652,
      "line" : 387,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NDQzNDc1OA==",
      "original_commit_id" : "4f4c7d8b117e8a9cfb2430d2fc9f420ef48b4f6d",
      "original_line" : 387,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/torcontrol.cpp",
      "position" : 18,
      "pull_request_review_id" : 724621467,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-06T18:41:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/684434758",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22651#discussion_r684460683"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/684460683"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is normally 9150 on Windows so can we use #ifdef here? Although not sure if it is out of scope for this PR\r\n\r\n```suggestion\r\n#ifdef WIN32 \r\n            CService resolved(LookupNumeric(\"127.0.0.1\", 9150));\r\n#else\r\n            CService resolved(LookupNumeric(\"127.0.0.1\", 9050));\r\n#endif\r\n```",
      "commit_id" : "4f4c7d8b117e8a9cfb2430d2fc9f420ef48b4f6d",
      "created_at" : "2021-08-06T19:30:24Z",
      "diff_hunk" : "@@ -373,9 +373,18 @@ void TorController::auth_cb(TorControlConnection& _conn, const TorControlReply&\n     if (reply.code == 250) {\n         LogPrint(BCLog::TOR, \"tor: Authentication successful\\n\");\n \n-        // Now that we know Tor is running setup the proxy for onion addresses\n-        // if -onion isn't set to something else.\n-        if (gArgs.GetArg(\"-onion\", \"\") == \"\") {\n+        // Now that we know Tor is running, possibly set the proxy for onion addresses.\n+        bool allow_outbound_onion{true};\n+        if (gArgs.IsArgSet(\"-onlynet\")) {\n+            allow_outbound_onion = false;\n+            for (const auto& net : gArgs.GetArgs(\"-onlynet\")) {\n+                if (ParseNetwork(net) == NET_ONION) {\n+                    allow_outbound_onion = true;\n+                    break;\n+                }\n+            }\n+        }\n+        if (gArgs.GetArg(\"-onion\", \"\") == \"\" && allow_outbound_onion) {\n             CService resolved(LookupNumeric(\"127.0.0.1\", 9050));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22651#discussion_r684460683",
      "id" : 684460683,
      "line" : 388,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NDQ2MDY4Mw==",
      "original_commit_id" : "4f4c7d8b117e8a9cfb2430d2fc9f420ef48b4f6d",
      "original_line" : 388,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/torcontrol.cpp",
      "position" : 19,
      "pull_request_review_id" : 724654762,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-06T19:34:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/684460683",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/13405205?v=4",
         "events_url" : "https://api.github.com/users/prayank23/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prayank23/followers",
         "following_url" : "https://api.github.com/users/prayank23/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prayank23/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prayank23",
         "id" : 13405205,
         "login" : "prayank23",
         "node_id" : "MDQ6VXNlcjEzNDA1MjA1",
         "organizations_url" : "https://api.github.com/users/prayank23/orgs",
         "received_events_url" : "https://api.github.com/users/prayank23/received_events",
         "repos_url" : "https://api.github.com/users/prayank23/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prayank23/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prayank23/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prayank23"
      }
   }
]
