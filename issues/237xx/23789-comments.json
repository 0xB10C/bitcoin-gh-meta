[
   {
      "author_association" : "MEMBER",
      "body" : "Obviously this will fail tests and need docs fixed up. I'll do that unless there are NACKs.",
      "created_at" : "2021-12-15T20:17:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23789#issuecomment-995181272",
      "id" : 995181272,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23789",
      "node_id" : "IC_kwDOABII5847UULY",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/995181272/reactions"
      },
      "updated_at" : "2021-12-15T20:17:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/995181272",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2021-12-15T20:28:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23789#issuecomment-995189037",
      "id" : 995189037,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23789",
      "node_id" : "IC_kwDOABII5847UWEt",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/995189037/reactions"
      },
      "updated_at" : "2021-12-15T20:28:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/995189037",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4500994?v=4",
         "events_url" : "https://api.github.com/users/kristapsk/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kristapsk/followers",
         "following_url" : "https://api.github.com/users/kristapsk/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kristapsk/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kristapsk",
         "id" : 4500994,
         "login" : "kristapsk",
         "node_id" : "MDQ6VXNlcjQ1MDA5OTQ=",
         "organizations_url" : "https://api.github.com/users/kristapsk/orgs",
         "received_events_url" : "https://api.github.com/users/kristapsk/received_events",
         "repos_url" : "https://api.github.com/users/kristapsk/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kristapsk/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kristapsk/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kristapsk"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23789#discussion_r770029609"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23789"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/770029609"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Unknown witness versions should be included here too.",
      "commit_id" : "26682d5bf413189163b2aec0be9483f29a1cbb04",
      "created_at" : "2021-12-15T20:50:15Z",
      "diff_hunk" : "@@ -1935,29 +1935,58 @@ OutputType CWallet::TransactionChangeType(const std::optional<OutputType>& chang\n         return *change_type;\n     }\n \n-    // if m_default_address_type is legacy, use legacy address as change (even\n-    // if some of the outputs are P2WPKH or P2WSH).\n+    // if m_default_address_type is legacy, use legacy address as change.\n     if (m_default_address_type == OutputType::LEGACY) {\n         return OutputType::LEGACY;\n     }\n \n-    // if any destination is P2WPKH or P2WSH, use P2WPKH for the change\n-    // output.\n+    bool any_tr{false};\n+    bool any_wpkh{false};\n+    bool any_sh{false};\n+    bool any_pkh{false};\n+\n     for (const auto& recipient : vecSend) {\n-        // Check if any destination contains a witness program:\n-        int witnessversion = 0;\n-        std::vector<unsigned char> witnessprogram;\n-        if (recipient.scriptPubKey.IsWitnessProgram(witnessversion, witnessprogram)) {\n-            if (GetScriptPubKeyMan(OutputType::BECH32M, true)) {\n-                return OutputType::BECH32M;\n-            } else if (GetScriptPubKeyMan(OutputType::BECH32, true)) {\n-                return OutputType::BECH32;\n-            } else {\n-                return m_default_address_type;\n-            }\n-        }\n+        std::vector<std::vector<uint8_t>> dummy;\n+        const TxoutType type{Solver(recipient.scriptPubKey, dummy)};\n+        if (type == TxoutType::WITNESS_V1_TAPROOT) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23789#discussion_r770029609",
      "id" : 770029609,
      "line" : 1951,
      "node_id" : "PRRC_kwDOABII584t5bgp",
      "original_commit_id" : "26682d5bf413189163b2aec0be9483f29a1cbb04",
      "original_line" : 1951,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 33,
      "pull_request_review_id" : 833389512,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23789",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/770029609/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-15T20:50:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/770029609",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23789#discussion_r770033339"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23789"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/770033339"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'd say no. Otherwise, it will be trivial for chain-analysis to determine the change type if the outputs are {v2, v1, v0} and the input is {v1}",
      "commit_id" : "26682d5bf413189163b2aec0be9483f29a1cbb04",
      "created_at" : "2021-12-15T20:56:32Z",
      "diff_hunk" : "@@ -1935,29 +1935,58 @@ OutputType CWallet::TransactionChangeType(const std::optional<OutputType>& chang\n         return *change_type;\n     }\n \n-    // if m_default_address_type is legacy, use legacy address as change (even\n-    // if some of the outputs are P2WPKH or P2WSH).\n+    // if m_default_address_type is legacy, use legacy address as change.\n     if (m_default_address_type == OutputType::LEGACY) {\n         return OutputType::LEGACY;\n     }\n \n-    // if any destination is P2WPKH or P2WSH, use P2WPKH for the change\n-    // output.\n+    bool any_tr{false};\n+    bool any_wpkh{false};\n+    bool any_sh{false};\n+    bool any_pkh{false};\n+\n     for (const auto& recipient : vecSend) {\n-        // Check if any destination contains a witness program:\n-        int witnessversion = 0;\n-        std::vector<unsigned char> witnessprogram;\n-        if (recipient.scriptPubKey.IsWitnessProgram(witnessversion, witnessprogram)) {\n-            if (GetScriptPubKeyMan(OutputType::BECH32M, true)) {\n-                return OutputType::BECH32M;\n-            } else if (GetScriptPubKeyMan(OutputType::BECH32, true)) {\n-                return OutputType::BECH32;\n-            } else {\n-                return m_default_address_type;\n-            }\n-        }\n+        std::vector<std::vector<uint8_t>> dummy;\n+        const TxoutType type{Solver(recipient.scriptPubKey, dummy)};\n+        if (type == TxoutType::WITNESS_V1_TAPROOT) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23789#discussion_r770033339",
      "id" : 770033339,
      "in_reply_to_id" : 770029609,
      "line" : 1951,
      "node_id" : "PRRC_kwDOABII584t5ca7",
      "original_commit_id" : "26682d5bf413189163b2aec0be9483f29a1cbb04",
      "original_line" : 1951,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 33,
      "pull_request_review_id" : 833394975,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23789",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/770033339/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-15T20:56:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/770033339",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23789#discussion_r770041173"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23789"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/770041173"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, but the intention is to use `OutputType::BECH32M` for future witness versions too. v2 outputs will have bech32m addresses. If you had a v2 descriptor as active, it would take the slot that tr descriptors would currently occupy so a tx with a taproot output would have a v2 as change under this logic.",
      "commit_id" : "26682d5bf413189163b2aec0be9483f29a1cbb04",
      "created_at" : "2021-12-15T21:09:19Z",
      "diff_hunk" : "@@ -1935,29 +1935,58 @@ OutputType CWallet::TransactionChangeType(const std::optional<OutputType>& chang\n         return *change_type;\n     }\n \n-    // if m_default_address_type is legacy, use legacy address as change (even\n-    // if some of the outputs are P2WPKH or P2WSH).\n+    // if m_default_address_type is legacy, use legacy address as change.\n     if (m_default_address_type == OutputType::LEGACY) {\n         return OutputType::LEGACY;\n     }\n \n-    // if any destination is P2WPKH or P2WSH, use P2WPKH for the change\n-    // output.\n+    bool any_tr{false};\n+    bool any_wpkh{false};\n+    bool any_sh{false};\n+    bool any_pkh{false};\n+\n     for (const auto& recipient : vecSend) {\n-        // Check if any destination contains a witness program:\n-        int witnessversion = 0;\n-        std::vector<unsigned char> witnessprogram;\n-        if (recipient.scriptPubKey.IsWitnessProgram(witnessversion, witnessprogram)) {\n-            if (GetScriptPubKeyMan(OutputType::BECH32M, true)) {\n-                return OutputType::BECH32M;\n-            } else if (GetScriptPubKeyMan(OutputType::BECH32, true)) {\n-                return OutputType::BECH32;\n-            } else {\n-                return m_default_address_type;\n-            }\n-        }\n+        std::vector<std::vector<uint8_t>> dummy;\n+        const TxoutType type{Solver(recipient.scriptPubKey, dummy)};\n+        if (type == TxoutType::WITNESS_V1_TAPROOT) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23789#discussion_r770041173",
      "id" : 770041173,
      "in_reply_to_id" : 770029609,
      "line" : 1951,
      "node_id" : "PRRC_kwDOABII584t5eVV",
      "original_commit_id" : "26682d5bf413189163b2aec0be9483f29a1cbb04",
      "original_line" : 1951,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 33,
      "pull_request_review_id" : 833406302,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23789",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/770041173/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-15T21:09:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/770041173",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23789#discussion_r770044571"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23789"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/770044571"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is impossible to do unless the specification of v2 is known.\r\n\r\nIf I use UNKNOWN here and V2 is specified, then UNKNOWN will *not* match V2. Before V2 is defined, it is not possible to match it. As soon as V2 is defined, it can be matched. So this is something for a follow-up when the time is right.",
      "commit_id" : "26682d5bf413189163b2aec0be9483f29a1cbb04",
      "created_at" : "2021-12-15T21:14:51Z",
      "diff_hunk" : "@@ -1935,29 +1935,58 @@ OutputType CWallet::TransactionChangeType(const std::optional<OutputType>& chang\n         return *change_type;\n     }\n \n-    // if m_default_address_type is legacy, use legacy address as change (even\n-    // if some of the outputs are P2WPKH or P2WSH).\n+    // if m_default_address_type is legacy, use legacy address as change.\n     if (m_default_address_type == OutputType::LEGACY) {\n         return OutputType::LEGACY;\n     }\n \n-    // if any destination is P2WPKH or P2WSH, use P2WPKH for the change\n-    // output.\n+    bool any_tr{false};\n+    bool any_wpkh{false};\n+    bool any_sh{false};\n+    bool any_pkh{false};\n+\n     for (const auto& recipient : vecSend) {\n-        // Check if any destination contains a witness program:\n-        int witnessversion = 0;\n-        std::vector<unsigned char> witnessprogram;\n-        if (recipient.scriptPubKey.IsWitnessProgram(witnessversion, witnessprogram)) {\n-            if (GetScriptPubKeyMan(OutputType::BECH32M, true)) {\n-                return OutputType::BECH32M;\n-            } else if (GetScriptPubKeyMan(OutputType::BECH32, true)) {\n-                return OutputType::BECH32;\n-            } else {\n-                return m_default_address_type;\n-            }\n-        }\n+        std::vector<std::vector<uint8_t>> dummy;\n+        const TxoutType type{Solver(recipient.scriptPubKey, dummy)};\n+        if (type == TxoutType::WITNESS_V1_TAPROOT) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23789#discussion_r770044571",
      "id" : 770044571,
      "in_reply_to_id" : 770029609,
      "line" : 1951,
      "node_id" : "PRRC_kwDOABII584t5fKb",
      "original_commit_id" : "26682d5bf413189163b2aec0be9483f29a1cbb04",
      "original_line" : 1951,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 33,
      "pull_request_review_id" : 833411072,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23789",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/770044571/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-15T21:14:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/770044571",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23789#discussion_r770053349"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23789"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/770053349"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Sure, but I think we should handle UNKNOWN here too as one of the explicitly stated goals of bech32(m) is to allow sending to future segwit versions without needing to know about them. When a new version's TxoutType is added, it needs to be added here as well, but we should always handle UNKNOWN regardless.",
      "commit_id" : "26682d5bf413189163b2aec0be9483f29a1cbb04",
      "created_at" : "2021-12-15T21:29:11Z",
      "diff_hunk" : "@@ -1935,29 +1935,58 @@ OutputType CWallet::TransactionChangeType(const std::optional<OutputType>& chang\n         return *change_type;\n     }\n \n-    // if m_default_address_type is legacy, use legacy address as change (even\n-    // if some of the outputs are P2WPKH or P2WSH).\n+    // if m_default_address_type is legacy, use legacy address as change.\n     if (m_default_address_type == OutputType::LEGACY) {\n         return OutputType::LEGACY;\n     }\n \n-    // if any destination is P2WPKH or P2WSH, use P2WPKH for the change\n-    // output.\n+    bool any_tr{false};\n+    bool any_wpkh{false};\n+    bool any_sh{false};\n+    bool any_pkh{false};\n+\n     for (const auto& recipient : vecSend) {\n-        // Check if any destination contains a witness program:\n-        int witnessversion = 0;\n-        std::vector<unsigned char> witnessprogram;\n-        if (recipient.scriptPubKey.IsWitnessProgram(witnessversion, witnessprogram)) {\n-            if (GetScriptPubKeyMan(OutputType::BECH32M, true)) {\n-                return OutputType::BECH32M;\n-            } else if (GetScriptPubKeyMan(OutputType::BECH32, true)) {\n-                return OutputType::BECH32;\n-            } else {\n-                return m_default_address_type;\n-            }\n-        }\n+        std::vector<std::vector<uint8_t>> dummy;\n+        const TxoutType type{Solver(recipient.scriptPubKey, dummy)};\n+        if (type == TxoutType::WITNESS_V1_TAPROOT) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23789#discussion_r770053349",
      "id" : 770053349,
      "in_reply_to_id" : 770029609,
      "line" : 1951,
      "node_id" : "PRRC_kwDOABII584t5hTl",
      "original_commit_id" : "26682d5bf413189163b2aec0be9483f29a1cbb04",
      "original_line" : 1951,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 33,
      "pull_request_review_id" : 833422986,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23789",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/770053349/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-15T21:29:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/770053349",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2021-12-15T22:33:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23789#issuecomment-995266886",
      "id" : 995266886,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23789",
      "node_id" : "IC_kwDOABII5847UpFG",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/995266886/reactions"
      },
      "updated_at" : "2021-12-15T22:33:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/995266886",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/13405205?v=4",
         "events_url" : "https://api.github.com/users/prayank23/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prayank23/followers",
         "following_url" : "https://api.github.com/users/prayank23/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prayank23/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prayank23",
         "id" : 13405205,
         "login" : "prayank23",
         "node_id" : "MDQ6VXNlcjEzNDA1MjA1",
         "organizations_url" : "https://api.github.com/users/prayank23/orgs",
         "received_events_url" : "https://api.github.com/users/prayank23/received_events",
         "repos_url" : "https://api.github.com/users/prayank23/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prayank23/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prayank23/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prayank23"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23789#discussion_r770268256"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23789"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/770268256"
         }
      },
      "author_association" : "MEMBER",
      "body" : "UNKNOWN is handled. Obviously it is impossible to match, but it is treated like any other type that can't be matched (wsh, pk, raw multisig, raw data, ...).\r\n\r\nHappy to add a comment, but the algorithm is:\r\n\r\n* find any types that can theoretically be matched\r\n* try to match them if there is a spkman\r\n* fallback to bech32(m) (Note: This will happen if *all* outputs are unmatchable. For example all are v2)",
      "commit_id" : "26682d5bf413189163b2aec0be9483f29a1cbb04",
      "created_at" : "2021-12-16T06:59:06Z",
      "diff_hunk" : "@@ -1935,29 +1935,58 @@ OutputType CWallet::TransactionChangeType(const std::optional<OutputType>& chang\n         return *change_type;\n     }\n \n-    // if m_default_address_type is legacy, use legacy address as change (even\n-    // if some of the outputs are P2WPKH or P2WSH).\n+    // if m_default_address_type is legacy, use legacy address as change.\n     if (m_default_address_type == OutputType::LEGACY) {\n         return OutputType::LEGACY;\n     }\n \n-    // if any destination is P2WPKH or P2WSH, use P2WPKH for the change\n-    // output.\n+    bool any_tr{false};\n+    bool any_wpkh{false};\n+    bool any_sh{false};\n+    bool any_pkh{false};\n+\n     for (const auto& recipient : vecSend) {\n-        // Check if any destination contains a witness program:\n-        int witnessversion = 0;\n-        std::vector<unsigned char> witnessprogram;\n-        if (recipient.scriptPubKey.IsWitnessProgram(witnessversion, witnessprogram)) {\n-            if (GetScriptPubKeyMan(OutputType::BECH32M, true)) {\n-                return OutputType::BECH32M;\n-            } else if (GetScriptPubKeyMan(OutputType::BECH32, true)) {\n-                return OutputType::BECH32;\n-            } else {\n-                return m_default_address_type;\n-            }\n-        }\n+        std::vector<std::vector<uint8_t>> dummy;\n+        const TxoutType type{Solver(recipient.scriptPubKey, dummy)};\n+        if (type == TxoutType::WITNESS_V1_TAPROOT) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23789#discussion_r770268256",
      "id" : 770268256,
      "in_reply_to_id" : 770029609,
      "line" : 1951,
      "node_id" : "PRRC_kwDOABII584t6Vxg",
      "original_commit_id" : "26682d5bf413189163b2aec0be9483f29a1cbb04",
      "original_line" : 1951,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 33,
      "pull_request_review_id" : 833705982,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23789",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/770268256/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-16T06:59:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/770268256",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
