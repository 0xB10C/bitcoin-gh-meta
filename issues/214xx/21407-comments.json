[
   {
      "author_association" : "MEMBER",
      "body" : "Is this from the OOM raised by the new fuzzer? Approach ACK; a test may be good.",
      "created_at" : "2021-03-10T12:54:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21407#issuecomment-795373018",
      "id" : 795373018,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21407",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5NTM3MzAxOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-10T12:54:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/795373018",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't think so. To demonstrate the problem this PR is fixing a fuzz seed would have to supply all the data to cause OOM, whereas the [output](https://github.com/bitcoin/bitcoin/pull/21387#issuecomment-795334306) of the OOM you reported reads \"will not generate inputs larger than 1048576 bytes\".",
      "created_at" : "2021-03-10T12:59:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21407#issuecomment-795378332",
      "id" : 795378332,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21407",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5NTM3ODMzMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-10T12:59:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/795378332",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept and code review ACK 32b63eb166470b05795f39ab01bc57d62abf79e7",
      "created_at" : "2021-03-10T14:16:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21407#issuecomment-795472083",
      "id" : 795472083,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21407",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5NTQ3MjA4Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-10T14:16:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/795472083",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #21387 (fuzz: test the I2P Session public interface by vasild)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-03-10T16:43:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21407#issuecomment-795714357",
      "id" : 795714357,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21407",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5NTcxNDM1Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-10T16:43:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/795714357",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK\r\n\r\nHappy this was caught so soon after I2P merge, and more importantly before release: we're doing something right :)\r\n\r\n@vasild May I ask how you found this issue?\r\n\r\nIf it wasn't found using the the I2P fuzzer awaiting review, could you add a fuzzing harness which would have been able to catch this issue (\"regression fuzzing\")?",
      "created_at" : "2021-03-10T22:23:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21407#issuecomment-796227143",
      "id" : 796227143,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21407",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5NjIyNzE0Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-10T22:23:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/796227143",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@practicalswift,\r\n> how you found this issue?\r\n\r\nExactly the right question! :)\r\n\r\nIt was not found by #21387, but a problem in it put this in front of my eyes. While fuzzing with #21387 I noticed that there is one slow case which was unexpected because the fuzz test is very small and should be quick.\r\n\r\nIt turned out that once the fuzz data is exhausted `FuzzedSock::Recv()` will keep returning `-1` and setting `errno` to `EAGAIN` forever. So `RecvUntilTerminator()` was (properly) re-calling `Recv()` zillion times before it gave up due to a timeout. This was fixed in the test by https://github.com/bitcoin/bitcoin/pull/21387/commits/5e085082fae5b90507aca3277800bfb367705617 but it made me think what's the worse that can happen with a `Recv()` that never returns a terminator.\r\n\r\n> we're doing something right\r\n\r\nThat is adding tests that increase the coverage, I guess :)",
      "created_at" : "2021-03-11T09:08:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21407#issuecomment-796585929",
      "id" : 796585929,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21407",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5NjU4NTkyOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-11T09:08:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/796585929",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21407#discussion_r592229682"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21407"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/592229682"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The dereference operator `operator*()` does not check if this optional contains a value, which may be more efficient than `value()` (https://en.cppreference.com/w/cpp/utility/optional/value). As `has_value()` is already checked, can also do (maybe not worth it but as a note):\r\n\r\n```diff\r\n         if (max_data.has_value()) {\r\n-            if (data.size() >= max_data.value()) {\r\n+            const size_t bytes{data.size()};\r\n+            if (bytes >= *max_data) {\r\n                 throw std::runtime_error(\r\n-                    strprintf(\"Received too many bytes without a terminator (%u)\", data.size()));\r\n+                    strprintf(\"Received too many bytes without a terminator (%u)\", bytes));\r\n             }\r\n-            peek_bytes = std::min(sizeof(buf), max_data.value() - data.size());\r\n+            peek_bytes = std::min(sizeof(buf), *max_data - bytes);\r\n         }\r\n ```\r\n",
      "commit_id" : "32b63eb166470b05795f39ab01bc57d62abf79e7",
      "created_at" : "2021-03-11T10:11:39Z",
      "diff_hunk" : "@@ -191,8 +192,17 @@ std::string Sock::RecvUntilTerminator(uint8_t terminator,\n \n     for (;;) {\n         char buf[512];\n+        size_t peek_bytes{sizeof(buf)};\n \n-        const ssize_t peek_ret{Recv(buf, sizeof(buf), MSG_PEEK)};\n+        if (max_data.has_value()) {\n+            if (data.size() >= max_data.value()) {\n+                throw std::runtime_error(\n+                    strprintf(\"Received too many bytes without a terminator (%u)\", data.size()));\n+            }\n+            peek_bytes = std::min(sizeof(buf), max_data.value() - data.size());\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21407#discussion_r592229682",
      "id" : 592229682,
      "line" : 203,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MjIyOTY4Mg==",
      "original_commit_id" : "32b63eb166470b05795f39ab01bc57d62abf79e7",
      "original_line" : 203,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/util/sock.cpp",
      "position" : 23,
      "pull_request_review_id" : 609586826,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21407",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-11T10:23:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/592229682",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21407#discussion_r592260224"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21407"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/592260224"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah, there is more than one way to write this. I chose the current one because I think the performance of `operator*` is negligible in this case and I find `.value()` more readable. Also\r\n```cpp\r\nif (max_data.has_value()) {\r\n```\r\ncan be written as\r\n```cpp\r\nif (max_data) {\r\n```\r\nbut I don't like those \"hidden\" casts and somehow prefer the former. The latter raises the question: \"given that `max_data` represents a number, did the programmer intend to check for non-zero value instead of whether the optional has value or not?\"\r\n\r\nI also prefer explicit comparisons (avoid implicit cast to boolean):\r\n```cpp\r\nif (foo != 0) { // makes it obvious that foo is a number\r\nif (foo != nullptr) { // makes it obvious that foo is a pointer\r\nif (foo) { // use this only if foo is a boolean\r\n```",
      "commit_id" : "32b63eb166470b05795f39ab01bc57d62abf79e7",
      "created_at" : "2021-03-11T10:54:37Z",
      "diff_hunk" : "@@ -191,8 +192,17 @@ std::string Sock::RecvUntilTerminator(uint8_t terminator,\n \n     for (;;) {\n         char buf[512];\n+        size_t peek_bytes{sizeof(buf)};\n \n-        const ssize_t peek_ret{Recv(buf, sizeof(buf), MSG_PEEK)};\n+        if (max_data.has_value()) {\n+            if (data.size() >= max_data.value()) {\n+                throw std::runtime_error(\n+                    strprintf(\"Received too many bytes without a terminator (%u)\", data.size()));\n+            }\n+            peek_bytes = std::min(sizeof(buf), max_data.value() - data.size());\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21407#discussion_r592260224",
      "id" : 592260224,
      "in_reply_to_id" : 592229682,
      "line" : 203,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MjI2MDIyNA==",
      "original_commit_id" : "32b63eb166470b05795f39ab01bc57d62abf79e7",
      "original_line" : 203,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/util/sock.cpp",
      "position" : 23,
      "pull_request_review_id" : 609631235,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21407",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-11T10:54:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/592260224",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21407#discussion_r592261547"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21407"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/592261547"
         }
      },
      "author_association" : "MEMBER",
      "body" : "not sure what is more idiomatic\r\n```suggestion\r\n                                            std::optional<size_t> max_data = {}) const;\r\n```",
      "commit_id" : "32b63eb166470b05795f39ab01bc57d62abf79e7",
      "created_at" : "2021-03-11T10:56:26Z",
      "diff_hunk" : "@@ -135,13 +136,16 @@ class Sock\n      * @param[in] terminator Character up to which to read from the socket.\n      * @param[in] timeout Timeout for the entire operation.\n      * @param[in] interrupt If this is signaled then the operation is canceled.\n+     * @param[in] max_data The maximum amount of data (in bytes) to receive without\n+     * a terminator before giving up. Use `std::nullopt` to avoid this limit.\n      * @return The data that has been read, without the terminating character.\n      * @throws std::runtime_error if the operation cannot be completed. In this case some bytes may\n      * have been consumed from the socket.\n      */\n     virtual std::string RecvUntilTerminator(uint8_t terminator,\n                                             std::chrono::milliseconds timeout,\n-                                            CThreadInterrupt& interrupt) const;\n+                                            CThreadInterrupt& interrupt,\n+                                            std::optional<size_t> max_data = std::nullopt) const;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21407#discussion_r592261547",
      "id" : 592261547,
      "line" : 148,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MjI2MTU0Nw==",
      "original_commit_id" : "32b63eb166470b05795f39ab01bc57d62abf79e7",
      "original_line" : 148,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/util/sock.h",
      "position" : 22,
      "pull_request_review_id" : 609632835,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21407",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-11T10:56:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/592261547",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21407#discussion_r592262205"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21407"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/592262205"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I generally agree. It was more of a note to expose options.",
      "commit_id" : "32b63eb166470b05795f39ab01bc57d62abf79e7",
      "created_at" : "2021-03-11T10:57:20Z",
      "diff_hunk" : "@@ -191,8 +192,17 @@ std::string Sock::RecvUntilTerminator(uint8_t terminator,\n \n     for (;;) {\n         char buf[512];\n+        size_t peek_bytes{sizeof(buf)};\n \n-        const ssize_t peek_ret{Recv(buf, sizeof(buf), MSG_PEEK)};\n+        if (max_data.has_value()) {\n+            if (data.size() >= max_data.value()) {\n+                throw std::runtime_error(\n+                    strprintf(\"Received too many bytes without a terminator (%u)\", data.size()));\n+            }\n+            peek_bytes = std::min(sizeof(buf), max_data.value() - data.size());\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21407#discussion_r592262205",
      "id" : 592262205,
      "in_reply_to_id" : 592229682,
      "line" : 203,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MjI2MjIwNQ==",
      "original_commit_id" : "32b63eb166470b05795f39ab01bc57d62abf79e7",
      "original_line" : 203,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/util/sock.cpp",
      "position" : 23,
      "pull_request_review_id" : 609633652,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21407",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-11T10:59:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/592262205",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Do we need to make the new param max_data optional?\r\n\r\nI think it is good to have the possibility for the old behavior (unlimited), which fits well with `std::optional` - \"if the limit is not set, then it is unlimited\".",
      "created_at" : "2021-03-11T11:17:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21407#issuecomment-796662855",
      "id" : 796662855,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21407",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5NjY2Mjg1NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-11T11:17:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/796662855",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Appended a new commit with a unit test to ensure that the added functionality of `Sock::RecvUntilTerminator()` works as expected.\r\n\r\nThis is not a regression test that would fail if the bug being fixed by this PR resurfaces. I am working on that too, but it will require the changes from #21387 and will be in a separate PR of its own.",
      "created_at" : "2021-03-11T15:31:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21407#issuecomment-796821419",
      "id" : 796821419,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21407",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5NjgyMTQxOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-11T15:31:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/796821419",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   }
]
