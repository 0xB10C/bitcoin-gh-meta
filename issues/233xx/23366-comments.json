[
   {
      "author_association" : "MEMBER",
      "body" : "Also the same bug was observed on the master branch recently:\r\n- https://github.com/bitcoin/bitcoin/commit/22a90186496aea8025316bc5616905ffcf1aeb29 -- [log](https://api.cirrus-ci.com/v1/task/6008336282812416/logs/ci.log)\r\n- https://github.com/bitcoin/bitcoin/commit/23a7d56df2dd42b16e5d9748aad5630e448becd7 -- [log](https://api.cirrus-ci.com/v1/task/6464283501395968/logs/ci.log)",
      "created_at" : "2021-10-27T05:06:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/23366#issuecomment-952542538",
      "id" : 952542538,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23366",
      "node_id" : "IC_kwDOABII5844xqVK",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/952542538/reactions"
      },
      "updated_at" : "2021-10-27T05:17:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/952542538",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Indeed, this is not an issue with  #15719, but with master",
      "created_at" : "2021-10-27T08:21:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/23366#issuecomment-952659398",
      "id" : 952659398,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23366",
      "node_id" : "IC_kwDOABII5844yG3G",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/952659398/reactions"
      },
      "updated_at" : "2021-10-27T08:21:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/952659398",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Indeed, this is not an issue with #15719, but with master\r\n\r\nSuggested suppression in #23370.",
      "created_at" : "2021-10-27T08:45:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/23366#issuecomment-952681950",
      "id" : 952681950,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23366",
      "node_id" : "IC_kwDOABII5844yMXe",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/952681950/reactions"
      },
      "updated_at" : "2021-10-27T08:45:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/952681950",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Looking at https://cirrus-ci.com/github/bitcoin/bitcoin/master, I guess this problem does not happen reliably on master, but is nondeterministic? IIRC, when I was seeing similar TSAN errors months ago in #15719, the problem seemed to be deterministic and would happen every time.\r\n\r\nThe `chainstate_update_tip` was added a month ago in 673a5bd3377929a0a6a62eda8b560e47bc2cca0c from #21526 by @jamesob, so maybe James could look at stack traces and clarify whether it is expected that there might be multiple threads writing to cout at same time.\r\n\r\n**I think the TSAN suppression seems safe, but am not completely confident about it. And even if it is thread safe it still means multiple threads could be writing to stdout at the same time and producing garbled output.**\r\n\r\nAlso, I'm not sure why this bug would start happening now if #21526 was merged a month ago, so wondering if something else might have changed recently? Or if this happens infrequently enough to not be noticed? Or if this was noticed but was just ignored a little while?\r\n\r\nWould be nice if there was a way to easily grep cirrus logs and find all the instances of this.",
      "created_at" : "2021-10-27T11:36:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/23366#issuecomment-952830424",
      "id" : 952830424,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23366",
      "node_id" : "IC_kwDOABII5844ywnY",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/952830424/reactions"
      },
      "updated_at" : "2021-10-27T11:36:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/952830424",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "As mentioned `std::cout` is supposed to be threadsafe: https://eel.is/c++draft/iostream.objects#overview-7\r\n\r\nThe problem is, it seems that io manipulators are *not* threadsafe: the stream members are not atomic, and there are no locks: https://github.com/llvm/llvm-project/blob/release/12.x/libcxx/include/ios#L372\r\n\r\nBut many methods call `ios.width(0)` so that `std::setw()` is only valid for one output: https://en.cppreference.com/w/cpp/io/ios_base/width\r\n\r\nThis is done here: https://github.com/llvm/llvm-project/blob/main/libcxx/include/locale#L1400 which is called whenever e.g. `operator<<(char const*)` is called. \r\n\r\nSo even when the standard says that concurrent access to `cout` isn't supposed to have any data races, this is one right there. Not sure what to do about that.",
      "created_at" : "2021-11-07T16:45:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/23366#issuecomment-962643450",
      "id" : 962643450,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23366",
      "node_id" : "IC_kwDOABII5845YMX6",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/962643450/reactions"
      },
      "updated_at" : "2021-11-07T16:45:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/962643450",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/14386?v=4",
         "events_url" : "https://api.github.com/users/martinus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/martinus/followers",
         "following_url" : "https://api.github.com/users/martinus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/martinus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/martinus",
         "id" : 14386,
         "login" : "martinus",
         "node_id" : "MDQ6VXNlcjE0Mzg2",
         "organizations_url" : "https://api.github.com/users/martinus/orgs",
         "received_events_url" : "https://api.github.com/users/martinus/received_events",
         "repos_url" : "https://api.github.com/users/martinus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/martinus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/martinus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/martinus"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Interesting that no one else ran into this before us. Maybe a bug should be reported, since I couldn't find any https://bugs.llvm.org/buglist.cgi?quicksearch=race%20ios_base&list_id=226152",
      "created_at" : "2021-11-08T09:01:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/23366#issuecomment-962941266",
      "id" : 962941266,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23366",
      "node_id" : "IC_kwDOABII5845ZVFS",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/962941266/reactions"
      },
      "updated_at" : "2021-11-08T09:01:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/962941266",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
