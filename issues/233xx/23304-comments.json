[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.",
      "created_at" : "2021-10-19T08:30:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23304#issuecomment-946483206",
      "id" : 946483206,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23304",
      "node_id" : "IC_kwDOABII5844ajAG",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/946483206/reactions"
      },
      "updated_at" : "2021-11-03T15:24:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/946483206",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Ready for review, supersedes #23277 ",
      "created_at" : "2021-11-03T13:15:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23304#issuecomment-959047507",
      "id" : 959047507,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23304",
      "node_id" : "IC_kwDOABII5845KedT",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/959047507/reactions"
      },
      "updated_at" : "2021-11-03T13:15:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/959047507",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK, thanks for adding a test!",
      "created_at" : "2021-11-29T11:17:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23304#issuecomment-981538843",
      "id" : 981538843,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23304",
      "node_id" : "IC_kwDOABII5846gRgb",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/981538843/reactions"
      },
      "updated_at" : "2021-11-29T11:17:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/981538843",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23304#discussion_r784438902"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/784438902"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Since you're touching this, please make it braces or same line to be inline with the style guide",
      "commit_id" : "38c949ae1b0abe6fd3eae82c59dcb75b98006f42",
      "created_at" : "2022-01-14T01:10:13Z",
      "diff_hunk" : "@@ -1258,44 +1258,70 @@ bool LegacyScriptPubKeyMan::TopUp(unsigned int kpSize)\n     if (!CanGenerateKeys()) {\n         return false;\n     }\n-    {\n-        LOCK(cs_KeyStore);\n \n-        if (m_storage.IsLocked()) return false;\n+    if (!TopUpChain(m_hd_chain, kpSize)) {\n+        return false;\n+    }\n+    for (auto& [chain_id, chain] : m_inactive_hd_chains) {\n+        if (!TopUpChain(chain, kpSize)) {\n+            return false;\n+        }\n+    }\n+    NotifyCanGetAddressesChanged();\n+    return true;\n+}\n+\n+bool LegacyScriptPubKeyMan::TopUpChain(CHDChain& chain, unsigned int kpSize)\n+{\n+    LOCK(cs_KeyStore);\n \n-        // Top up key pool\n-        unsigned int nTargetSize;\n-        if (kpSize > 0)\n-            nTargetSize = kpSize;\n-        else\n-            nTargetSize = std::max(gArgs.GetIntArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+    if (m_storage.IsLocked()) return false;\n \n-        // count amount of available keys (internal, external)\n-        // make sure the keypool of external and internal keys fits the user selected target (-keypool)\n-        int64_t missingExternal = std::max(std::max((int64_t) nTargetSize, (int64_t) 1) - (int64_t)setExternalKeyPool.size(), (int64_t) 0);\n-        int64_t missingInternal = std::max(std::max((int64_t) nTargetSize, (int64_t) 1) - (int64_t)setInternalKeyPool.size(), (int64_t) 0);\n+    // Top up key pool\n+    unsigned int nTargetSize;\n+    if (kpSize > 0)\n+        nTargetSize = kpSize;\n+    else\n+        nTargetSize = std::max(gArgs.GetIntArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23304#discussion_r784438902",
      "id" : 784438902,
      "line" : 1285,
      "node_id" : "PRRC_kwDOABII584uwZZ2",
      "original_commit_id" : "38c949ae1b0abe6fd3eae82c59dcb75b98006f42",
      "original_line" : 1285,
      "original_position" : 116,
      "original_start_line" : 1282,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 116,
      "pull_request_review_id" : 852397699,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23304",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/784438902/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1282,
      "start_side" : "RIGHT",
      "updated_at" : "2022-01-14T01:14:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/784438902",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6443210?v=4",
         "events_url" : "https://api.github.com/users/PastaPastaPasta/events{/privacy}",
         "followers_url" : "https://api.github.com/users/PastaPastaPasta/followers",
         "following_url" : "https://api.github.com/users/PastaPastaPasta/following{/other_user}",
         "gists_url" : "https://api.github.com/users/PastaPastaPasta/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/PastaPastaPasta",
         "id" : 6443210,
         "login" : "PastaPastaPasta",
         "node_id" : "MDQ6VXNlcjY0NDMyMTA=",
         "organizations_url" : "https://api.github.com/users/PastaPastaPasta/orgs",
         "received_events_url" : "https://api.github.com/users/PastaPastaPasta/received_events",
         "repos_url" : "https://api.github.com/users/PastaPastaPasta/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/PastaPastaPasta/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/PastaPastaPasta/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/PastaPastaPasta"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23304#discussion_r784439016"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/784439016"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "please make this not use c-style cast\r\n\r\n```\r\nint64_t{1}",
      "commit_id" : "38c949ae1b0abe6fd3eae82c59dcb75b98006f42",
      "created_at" : "2022-01-14T01:10:34Z",
      "diff_hunk" : "@@ -1258,44 +1258,70 @@ bool LegacyScriptPubKeyMan::TopUp(unsigned int kpSize)\n     if (!CanGenerateKeys()) {\n         return false;\n     }\n-    {\n-        LOCK(cs_KeyStore);\n \n-        if (m_storage.IsLocked()) return false;\n+    if (!TopUpChain(m_hd_chain, kpSize)) {\n+        return false;\n+    }\n+    for (auto& [chain_id, chain] : m_inactive_hd_chains) {\n+        if (!TopUpChain(chain, kpSize)) {\n+            return false;\n+        }\n+    }\n+    NotifyCanGetAddressesChanged();\n+    return true;\n+}\n+\n+bool LegacyScriptPubKeyMan::TopUpChain(CHDChain& chain, unsigned int kpSize)\n+{\n+    LOCK(cs_KeyStore);\n \n-        // Top up key pool\n-        unsigned int nTargetSize;\n-        if (kpSize > 0)\n-            nTargetSize = kpSize;\n-        else\n-            nTargetSize = std::max(gArgs.GetIntArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+    if (m_storage.IsLocked()) return false;\n \n-        // count amount of available keys (internal, external)\n-        // make sure the keypool of external and internal keys fits the user selected target (-keypool)\n-        int64_t missingExternal = std::max(std::max((int64_t) nTargetSize, (int64_t) 1) - (int64_t)setExternalKeyPool.size(), (int64_t) 0);\n-        int64_t missingInternal = std::max(std::max((int64_t) nTargetSize, (int64_t) 1) - (int64_t)setInternalKeyPool.size(), (int64_t) 0);\n+    // Top up key pool\n+    unsigned int nTargetSize;\n+    if (kpSize > 0)\n+        nTargetSize = kpSize;\n+    else\n+        nTargetSize = std::max(gArgs.GetIntArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+    int64_t target = std::max((int64_t) nTargetSize, (int64_t) 1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23304#discussion_r784439016",
      "id" : 784439016,
      "line" : 1286,
      "node_id" : "PRRC_kwDOABII584uwZbo",
      "original_commit_id" : "38c949ae1b0abe6fd3eae82c59dcb75b98006f42",
      "original_line" : 1286,
      "original_position" : 117,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 117,
      "pull_request_review_id" : 852397699,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23304",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/784439016/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-14T01:14:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/784439016",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6443210?v=4",
         "events_url" : "https://api.github.com/users/PastaPastaPasta/events{/privacy}",
         "followers_url" : "https://api.github.com/users/PastaPastaPasta/followers",
         "following_url" : "https://api.github.com/users/PastaPastaPasta/following{/other_user}",
         "gists_url" : "https://api.github.com/users/PastaPastaPasta/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/PastaPastaPasta",
         "id" : 6443210,
         "login" : "PastaPastaPasta",
         "node_id" : "MDQ6VXNlcjY0NDMyMTA=",
         "organizations_url" : "https://api.github.com/users/PastaPastaPasta/orgs",
         "received_events_url" : "https://api.github.com/users/PastaPastaPasta/received_events",
         "repos_url" : "https://api.github.com/users/PastaPastaPasta/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/PastaPastaPasta/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/PastaPastaPasta/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/PastaPastaPasta"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23304#discussion_r784439275"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/784439275"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "same line\r\n```suggestion\r\n    if (!IsHDEnabled() || !m_storage.CanSupportFeature(FEATURE_HD_SPLIT)) {\r\n```",
      "commit_id" : "38c949ae1b0abe6fd3eae82c59dcb75b98006f42",
      "created_at" : "2022-01-14T01:11:20Z",
      "diff_hunk" : "@@ -1258,44 +1258,70 @@ bool LegacyScriptPubKeyMan::TopUp(unsigned int kpSize)\n     if (!CanGenerateKeys()) {\n         return false;\n     }\n-    {\n-        LOCK(cs_KeyStore);\n \n-        if (m_storage.IsLocked()) return false;\n+    if (!TopUpChain(m_hd_chain, kpSize)) {\n+        return false;\n+    }\n+    for (auto& [chain_id, chain] : m_inactive_hd_chains) {\n+        if (!TopUpChain(chain, kpSize)) {\n+            return false;\n+        }\n+    }\n+    NotifyCanGetAddressesChanged();\n+    return true;\n+}\n+\n+bool LegacyScriptPubKeyMan::TopUpChain(CHDChain& chain, unsigned int kpSize)\n+{\n+    LOCK(cs_KeyStore);\n \n-        // Top up key pool\n-        unsigned int nTargetSize;\n-        if (kpSize > 0)\n-            nTargetSize = kpSize;\n-        else\n-            nTargetSize = std::max(gArgs.GetIntArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+    if (m_storage.IsLocked()) return false;\n \n-        // count amount of available keys (internal, external)\n-        // make sure the keypool of external and internal keys fits the user selected target (-keypool)\n-        int64_t missingExternal = std::max(std::max((int64_t) nTargetSize, (int64_t) 1) - (int64_t)setExternalKeyPool.size(), (int64_t) 0);\n-        int64_t missingInternal = std::max(std::max((int64_t) nTargetSize, (int64_t) 1) - (int64_t)setInternalKeyPool.size(), (int64_t) 0);\n+    // Top up key pool\n+    unsigned int nTargetSize;\n+    if (kpSize > 0)\n+        nTargetSize = kpSize;\n+    else\n+        nTargetSize = std::max(gArgs.GetIntArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+    int64_t target = std::max((int64_t) nTargetSize, (int64_t) 1);\n+\n+    // count amount of available keys (internal, external)\n+    // make sure the keypool of external and internal keys fits the user selected target (-keypool)\n+    int64_t missingExternal;\n+    int64_t missingInternal;\n+    if (chain == m_hd_chain) {\n+        missingExternal = std::max(target - (int64_t)setExternalKeyPool.size(), (int64_t) 0);\n+        missingInternal = std::max(target - (int64_t)setInternalKeyPool.size(), (int64_t) 0);\n+    } else {\n+        missingExternal = std::max(target - (chain.nExternalChainCounter - chain.m_next_external_index), (int64_t) 0);\n+        missingInternal = std::max(target - (chain.nInternalChainCounter - chain.m_next_internal_index), (int64_t) 0);\n+    }\n \n-        if (!IsHDEnabled() || !m_storage.CanSupportFeature(FEATURE_HD_SPLIT))\n-        {\n-            // don't create extra internal keys\n-            missingInternal = 0;\n+    if (!IsHDEnabled() || !m_storage.CanSupportFeature(FEATURE_HD_SPLIT))\n+    {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23304#discussion_r784439275",
      "id" : 784439275,
      "line" : 1301,
      "node_id" : "PRRC_kwDOABII584uwZfr",
      "original_commit_id" : "38c949ae1b0abe6fd3eae82c59dcb75b98006f42",
      "original_line" : 1301,
      "original_position" : 136,
      "original_start_line" : 1300,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 136,
      "pull_request_review_id" : 852397699,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23304",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/784439275/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1300,
      "start_side" : "RIGHT",
      "updated_at" : "2022-01-14T01:14:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/784439275",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6443210?v=4",
         "events_url" : "https://api.github.com/users/PastaPastaPasta/events{/privacy}",
         "followers_url" : "https://api.github.com/users/PastaPastaPasta/followers",
         "following_url" : "https://api.github.com/users/PastaPastaPasta/following{/other_user}",
         "gists_url" : "https://api.github.com/users/PastaPastaPasta/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/PastaPastaPasta",
         "id" : 6443210,
         "login" : "PastaPastaPasta",
         "node_id" : "MDQ6VXNlcjY0NDMyMTA=",
         "organizations_url" : "https://api.github.com/users/PastaPastaPasta/orgs",
         "received_events_url" : "https://api.github.com/users/PastaPastaPasta/received_events",
         "repos_url" : "https://api.github.com/users/PastaPastaPasta/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/PastaPastaPasta/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/PastaPastaPasta/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/PastaPastaPasta"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23304#discussion_r784439378"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/784439378"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n    for (int64_t i = missingInternal + missingExternal; i--;) {\r\n```",
      "commit_id" : "38c949ae1b0abe6fd3eae82c59dcb75b98006f42",
      "created_at" : "2022-01-14T01:11:42Z",
      "diff_hunk" : "@@ -1258,44 +1258,70 @@ bool LegacyScriptPubKeyMan::TopUp(unsigned int kpSize)\n     if (!CanGenerateKeys()) {\n         return false;\n     }\n-    {\n-        LOCK(cs_KeyStore);\n \n-        if (m_storage.IsLocked()) return false;\n+    if (!TopUpChain(m_hd_chain, kpSize)) {\n+        return false;\n+    }\n+    for (auto& [chain_id, chain] : m_inactive_hd_chains) {\n+        if (!TopUpChain(chain, kpSize)) {\n+            return false;\n+        }\n+    }\n+    NotifyCanGetAddressesChanged();\n+    return true;\n+}\n+\n+bool LegacyScriptPubKeyMan::TopUpChain(CHDChain& chain, unsigned int kpSize)\n+{\n+    LOCK(cs_KeyStore);\n \n-        // Top up key pool\n-        unsigned int nTargetSize;\n-        if (kpSize > 0)\n-            nTargetSize = kpSize;\n-        else\n-            nTargetSize = std::max(gArgs.GetIntArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+    if (m_storage.IsLocked()) return false;\n \n-        // count amount of available keys (internal, external)\n-        // make sure the keypool of external and internal keys fits the user selected target (-keypool)\n-        int64_t missingExternal = std::max(std::max((int64_t) nTargetSize, (int64_t) 1) - (int64_t)setExternalKeyPool.size(), (int64_t) 0);\n-        int64_t missingInternal = std::max(std::max((int64_t) nTargetSize, (int64_t) 1) - (int64_t)setInternalKeyPool.size(), (int64_t) 0);\n+    // Top up key pool\n+    unsigned int nTargetSize;\n+    if (kpSize > 0)\n+        nTargetSize = kpSize;\n+    else\n+        nTargetSize = std::max(gArgs.GetIntArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n+    int64_t target = std::max((int64_t) nTargetSize, (int64_t) 1);\n+\n+    // count amount of available keys (internal, external)\n+    // make sure the keypool of external and internal keys fits the user selected target (-keypool)\n+    int64_t missingExternal;\n+    int64_t missingInternal;\n+    if (chain == m_hd_chain) {\n+        missingExternal = std::max(target - (int64_t)setExternalKeyPool.size(), (int64_t) 0);\n+        missingInternal = std::max(target - (int64_t)setInternalKeyPool.size(), (int64_t) 0);\n+    } else {\n+        missingExternal = std::max(target - (chain.nExternalChainCounter - chain.m_next_external_index), (int64_t) 0);\n+        missingInternal = std::max(target - (chain.nInternalChainCounter - chain.m_next_internal_index), (int64_t) 0);\n+    }\n \n-        if (!IsHDEnabled() || !m_storage.CanSupportFeature(FEATURE_HD_SPLIT))\n-        {\n-            // don't create extra internal keys\n-            missingInternal = 0;\n+    if (!IsHDEnabled() || !m_storage.CanSupportFeature(FEATURE_HD_SPLIT))\n+    {\n+        // don't create extra internal keys\n+        missingInternal = 0;\n+    }\n+    bool internal = false;\n+    WalletBatch batch(m_storage.GetDatabase());\n+    for (int64_t i = missingInternal + missingExternal; i--;)\n+    {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23304#discussion_r784439378",
      "id" : 784439378,
      "line" : 1308,
      "node_id" : "PRRC_kwDOABII584uwZhS",
      "original_commit_id" : "38c949ae1b0abe6fd3eae82c59dcb75b98006f42",
      "original_line" : 1308,
      "original_position" : 143,
      "original_start_line" : 1307,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 143,
      "pull_request_review_id" : 852397699,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23304",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/784439378/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1307,
      "start_side" : "RIGHT",
      "updated_at" : "2022-01-14T01:14:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/784439378",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6443210?v=4",
         "events_url" : "https://api.github.com/users/PastaPastaPasta/events{/privacy}",
         "followers_url" : "https://api.github.com/users/PastaPastaPasta/followers",
         "following_url" : "https://api.github.com/users/PastaPastaPasta/following{/other_user}",
         "gists_url" : "https://api.github.com/users/PastaPastaPasta/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/PastaPastaPasta",
         "id" : 6443210,
         "login" : "PastaPastaPasta",
         "node_id" : "MDQ6VXNlcjY0NDMyMTA=",
         "organizations_url" : "https://api.github.com/users/PastaPastaPasta/orgs",
         "received_events_url" : "https://api.github.com/users/PastaPastaPasta/received_events",
         "repos_url" : "https://api.github.com/users/PastaPastaPasta/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/PastaPastaPasta/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/PastaPastaPasta/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/PastaPastaPasta"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23304#discussion_r784439520"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/784439520"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n    bool TopUpChain(CHDChain& chain, unsigned int size);\r\n```",
      "commit_id" : "38c949ae1b0abe6fd3eae82c59dcb75b98006f42",
      "created_at" : "2022-01-14T01:12:05Z",
      "diff_hunk" : "@@ -354,6 +354,7 @@ class LegacyScriptPubKeyMan : public ScriptPubKeyMan, public FillableSigningProv\n      */\n     bool TopUpInactiveHDChain(const CKeyID seed_id, int64_t index, bool internal);\n \n+    bool TopUpChain(CHDChain& chain ,unsigned int size);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23304#discussion_r784439520",
      "id" : 784439520,
      "line" : 357,
      "node_id" : "PRRC_kwDOABII584uwZjg",
      "original_commit_id" : "38c949ae1b0abe6fd3eae82c59dcb75b98006f42",
      "original_line" : 357,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : 4,
      "pull_request_review_id" : 852397699,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23304",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/784439520/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-14T01:14:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/784439520",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6443210?v=4",
         "events_url" : "https://api.github.com/users/PastaPastaPasta/events{/privacy}",
         "followers_url" : "https://api.github.com/users/PastaPastaPasta/followers",
         "following_url" : "https://api.github.com/users/PastaPastaPasta/following{/other_user}",
         "gists_url" : "https://api.github.com/users/PastaPastaPasta/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/PastaPastaPasta",
         "id" : 6443210,
         "login" : "PastaPastaPasta",
         "node_id" : "MDQ6VXNlcjY0NDMyMTA=",
         "organizations_url" : "https://api.github.com/users/PastaPastaPasta/orgs",
         "received_events_url" : "https://api.github.com/users/PastaPastaPasta/received_events",
         "repos_url" : "https://api.github.com/users/PastaPastaPasta/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/PastaPastaPasta/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/PastaPastaPasta/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/PastaPastaPasta"
      }
   }
]
