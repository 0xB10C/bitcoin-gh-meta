[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#15206](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15206.html) (Immediately disconnect on invalid net message checksum by jonasschnelli)\n* [#15197](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15197.html) (Refactor and slightly stricter p2p message processing by jonasschnelli)\n* [#14046](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/14046.html) (net: Refactor message parsing (CNetMessage), adds flexibility by jonasschnelli)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2019-06-13T11:13:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16202#issuecomment-501659119",
      "id" : 501659119,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16202",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwMTY1OTExOQ==",
      "updated_at" : "2019-07-19T11:51:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/501659119",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16202#discussion_r306343247"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16202"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306343247"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Shouldn't these both methods be part of the private interface given they are version-message specific ?",
      "commit_id" : "e85d88de78a3866119eb10d00e6d74732e300e98",
      "created_at" : "2019-07-23T14:15:41Z",
      "diff_hunk" : "@@ -647,7 +659,12 @@ class TransportDeserializer {\n         hdrbuf.SetVersion(nVersionIn);\n         vRecv.SetVersion(nVersionIn);\n     }\n-\n+    bool OversizedMessageDetected() const {\n+        return (in_data && hdr.nMessageSize > MAX_PROTOCOL_MESSAGE_LENGTH);\n+    }\n+    int Read(const char *pch, unsigned int nBytes) {\n+        return in_data ? readData(pch, nBytes) : readHeader(pch, nBytes);\n+    }\n     int readHeader(const char *pch, unsigned int nBytes);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16202#discussion_r306343247",
      "id" : 306343247,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNjM0MzI0Nw==",
      "original_commit_id" : "7bd4dd216094729a69f53a1916d66350f1099892",
      "original_position" : 48,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 265439462,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16202",
      "updated_at" : "2019-07-25T11:07:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306343247",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16202#discussion_r306343873"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16202"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306343873"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: if it's a public interface maybe add a short line of comment on what is expected for every method",
      "commit_id" : "e85d88de78a3866119eb10d00e6d74732e300e98",
      "created_at" : "2019-07-23T14:16:47Z",
      "diff_hunk" : "@@ -605,6 +605,18 @@ class CNetMessage {\n  * transport protocol agnostic CNetMessage (command & payload)\n  */\n class TransportDeserializer {\n+public:\n+    virtual void Reset() = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16202#discussion_r306343873",
      "id" : 306343873,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNjM0Mzg3Mw==",
      "original_commit_id" : "7bd4dd216094729a69f53a1916d66350f1099892",
      "original_position" : 5,
      "path" : "src/net.h",
      "position" : 42,
      "pull_request_review_id" : 265439462,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16202",
      "updated_at" : "2019-07-25T11:07:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306343873",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16202#discussion_r306352424"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16202"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306352424"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "IMO, you may also move more members in the private interface, what's the reason to have `in_data` as public ?",
      "commit_id" : "e85d88de78a3866119eb10d00e6d74732e300e98",
      "created_at" : "2019-07-23T14:31:29Z",
      "diff_hunk" : "@@ -605,6 +605,18 @@ class CNetMessage {\n  * transport protocol agnostic CNetMessage (command & payload)\n  */\n class TransportDeserializer {\n+public:\n+    virtual void Reset() = 0;\n+    virtual bool Complete() const = 0;\n+    virtual bool OversizedMessageDetected() const = 0;\n+    virtual void SetVersion(int nVersionIn) = 0;\n+    virtual int Read(const char *pch, unsigned int nBytes) = 0;\n+    virtual CNetMessage GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time) = 0;\n+    virtual ~TransportDeserializer() {}\n+};\n+\n+class V1TransportDeserializer : public TransportDeserializer\n+{",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16202#discussion_r306352424",
      "id" : 306352424,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNjM1MjQyNA==",
      "original_commit_id" : "7bd4dd216094729a69f53a1916d66350f1099892",
      "original_position" : 15,
      "path" : "src/net.h",
      "position" : 57,
      "pull_request_review_id" : 265439462,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16202",
      "updated_at" : "2019-07-25T11:07:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306352424",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16202#discussion_r306364952"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16202"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306364952"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit : wonder if this change shouldn't be part of first commit",
      "commit_id" : "e85d88de78a3866119eb10d00e6d74732e300e98",
      "created_at" : "2019-07-23T14:52:29Z",
      "diff_hunk" : "@@ -581,13 +576,13 @@ bool CNode::ReceiveMsgBytes(const char *pch, unsigned int nBytes, bool& complete\n         pch += handled;\n         nBytes -= handled;\n \n-        if (m_deserializer->complete()) {\n+        if (m_deserializer->Complete()) {\n             // decompose a transport agnostic CNetMessage from the deserializer\n             CNetMessage msg = m_deserializer->GetMessage(Params().MessageStart(), nTimeMicros);\n \n             //store received bytes per message command\n             //to prevent a memory DOS, only allow valid commands\n-            mapMsgCmdSize::iterator i = mapRecvBytesPerMsgCmd.find(m_deserializer->hdr.pchCommand);\n+            mapMsgCmdSize::iterator i = mapRecvBytesPerMsgCmd.find(msg.m_command);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16202#discussion_r306364952",
      "id" : 306364952,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNjM2NDk1Mg==",
      "original_commit_id" : "7bd4dd216094729a69f53a1916d66350f1099892",
      "original_position" : 33,
      "path" : "src/net.cpp",
      "position" : 44,
      "pull_request_review_id" : 265439462,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16202",
      "updated_at" : "2019-07-25T11:07:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306364952",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16202#discussion_r306382732"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16202"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306382732"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Isn't this check redundant with first check in `IsValid` ? Furthermore isn't netmagic validity a subset of header one,  and so you may remove it completely and only rely on `m_valid_header` ?",
      "commit_id" : "e85d88de78a3866119eb10d00e6d74732e300e98",
      "created_at" : "2019-07-23T15:23:22Z",
      "diff_hunk" : "@@ -678,14 +679,40 @@ int CNetMessage::readData(const char *pch, unsigned int nBytes)\n     return nCopy;\n }\n \n-const uint256& CNetMessage::GetMessageHash() const\n+const uint256& TransportDeserializer::GetMessageHash() const\n {\n     assert(complete());\n     if (data_hash.IsNull())\n         hasher.Finalize(data_hash.begin());\n     return data_hash;\n }\n \n+CNetMessage TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time) {\n+    // decompose a single CNetMessage from the TransportDeserializer\n+    CNetMessage msg(vRecv);\n+\n+    // store state about valid header, netmagic and checksum\n+    msg.m_valid_header = hdr.IsValid(message_start);\n+    msg.m_valid_netmagic = (memcmp(hdr.pchMessageStart, message_start, CMessageHeader::MESSAGE_START_SIZE) == 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16202#discussion_r306382732",
      "id" : 306382732,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNjM4MjczMg==",
      "original_commit_id" : "2cd45b2f4e8cfdb2eac3c886bec10653b4a066b5",
      "original_position" : 100,
      "path" : "src/net.cpp",
      "position" : 99,
      "pull_request_review_id" : 265439462,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16202",
      "updated_at" : "2019-07-25T11:07:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306382732",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16202#discussion_r306388229"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16202"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306388229"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "So next step would be to move these transport-protocol-specific fields in the Transport Deserializer ? If a `CNetMessage` doesn't have a valid_header it shouldn't succeed deserialization right ?",
      "commit_id" : "e85d88de78a3866119eb10d00e6d74732e300e98",
      "created_at" : "2019-07-23T15:33:24Z",
      "diff_hunk" : "@@ -570,8 +570,39 @@ class CNodeStats\n \n \n \n-\n+/** Transport protocol agnostic message container.\n+ * Ideally it should only contain receive time, payload,\n+ * command and size.\n+ */\n class CNetMessage {\n+public:\n+    CDataStream m_recv;              // received message data\n+    int64_t m_time;                  // time (in microseconds) of message receipt.\n+    bool m_valid_netmagic;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16202#discussion_r306388229",
      "id" : 306388229,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNjM4ODIyOQ==",
      "original_commit_id" : "2cd45b2f4e8cfdb2eac3c886bec10653b4a066b5",
      "original_position" : 13,
      "path" : "src/net.h",
      "position" : 13,
      "pull_request_review_id" : 265439462,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16202",
      "updated_at" : "2019-07-25T11:07:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306388229",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16202#discussion_r306396755"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16202"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306396755"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: \"check header\"",
      "commit_id" : "e85d88de78a3866119eb10d00e6d74732e300e98",
      "created_at" : "2019-07-23T15:49:38Z",
      "diff_hunk" : "@@ -3274,49 +3274,45 @@ bool PeerLogicValidation::ProcessMessages(CNode* pfrom, std::atomic<bool>& inter\n             return false;\n         // Just take one message\n         msgs.splice(msgs.begin(), pfrom->vProcessMsg, pfrom->vProcessMsg.begin());\n-        pfrom->nProcessQueueSize -= msgs.front().vRecv.size() + CMessageHeader::HEADER_SIZE;\n+        pfrom->nProcessQueueSize -= msgs.front().m_recv.size() + CMessageHeader::HEADER_SIZE;\n         pfrom->fPauseRecv = pfrom->nProcessQueueSize > connman->GetReceiveFloodSize();\n         fMoreWork = !pfrom->vProcessMsg.empty();\n     }\n     CNetMessage& msg(msgs.front());\n \n     msg.SetVersion(pfrom->GetRecvVersion());\n     // Scan for message start\n-    if (memcmp(msg.hdr.pchMessageStart, chainparams.MessageStart(), CMessageHeader::MESSAGE_START_SIZE) != 0) {\n-        LogPrint(BCLog::NET, \"PROCESSMESSAGE: INVALID MESSAGESTART %s peer=%d\\n\", SanitizeString(msg.hdr.GetCommand()), pfrom->GetId());\n+    if (!msg.m_valid_netmagic) {\n+        LogPrint(BCLog::NET, \"PROCESSMESSAGE: INVALID MESSAGESTART %s peer=%d\\n\", SanitizeString(msg.m_command), pfrom->GetId());\n         pfrom->fDisconnect = true;\n         return false;\n     }\n \n     // Read header",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16202#discussion_r306396755",
      "id" : 306396755,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNjM5Njc1NQ==",
      "original_commit_id" : "2cd45b2f4e8cfdb2eac3c886bec10653b4a066b5",
      "original_position" : 21,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 265439462,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16202",
      "updated_at" : "2019-07-25T11:07:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306396755",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16202#discussion_r306397371"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16202"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306397371"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "And if yes, I think checks in `ProcessMessages` won't have anymore a reason to exist?",
      "commit_id" : "e85d88de78a3866119eb10d00e6d74732e300e98",
      "created_at" : "2019-07-23T15:50:45Z",
      "diff_hunk" : "@@ -647,7 +659,12 @@ class TransportDeserializer {\n         hdrbuf.SetVersion(nVersionIn);\n         vRecv.SetVersion(nVersionIn);\n     }\n-\n+    bool OversizedMessageDetected() const {\n+        return (in_data && hdr.nMessageSize > MAX_PROTOCOL_MESSAGE_LENGTH);\n+    }\n+    int Read(const char *pch, unsigned int nBytes) {\n+        return in_data ? readData(pch, nBytes) : readHeader(pch, nBytes);\n+    }\n     int readHeader(const char *pch, unsigned int nBytes);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16202#discussion_r306397371",
      "id" : 306397371,
      "in_reply_to_id" : 306343247,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNjM5NzM3MQ==",
      "original_commit_id" : "7bd4dd216094729a69f53a1916d66350f1099892",
      "original_position" : 48,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 265439462,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16202",
      "updated_at" : "2019-07-25T11:07:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306397371",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16202#discussion_r306648411"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16202"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306648411"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I agree with that they should be private methods (will fix).\r\nBut I don't think we should make behavioral changes in this PR that's why I tried to not move the checks.\r\nPRs that \"optimize\" those checks are #15206 and #15197.",
      "commit_id" : "e85d88de78a3866119eb10d00e6d74732e300e98",
      "created_at" : "2019-07-24T06:40:48Z",
      "diff_hunk" : "@@ -647,7 +659,12 @@ class TransportDeserializer {\n         hdrbuf.SetVersion(nVersionIn);\n         vRecv.SetVersion(nVersionIn);\n     }\n-\n+    bool OversizedMessageDetected() const {\n+        return (in_data && hdr.nMessageSize > MAX_PROTOCOL_MESSAGE_LENGTH);\n+    }\n+    int Read(const char *pch, unsigned int nBytes) {\n+        return in_data ? readData(pch, nBytes) : readHeader(pch, nBytes);\n+    }\n     int readHeader(const char *pch, unsigned int nBytes);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16202#discussion_r306648411",
      "id" : 306648411,
      "in_reply_to_id" : 306343247,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNjY0ODQxMQ==",
      "original_commit_id" : "7bd4dd216094729a69f53a1916d66350f1099892",
      "original_position" : 48,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 265817301,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16202",
      "updated_at" : "2019-07-25T11:07:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306648411",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16202#discussion_r306650400"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16202"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306650400"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes. It's redundant for the same reason as said above. Further optimizations would change the behavior of v1 decomposing.\r\n\r\n`ProcessMessages()` happens after de-queuing deserialized messages. If we would check during deserialization (and disconnect), we would change the behavior.\r\n\r\nAlso, `ProcessMessages()` differentiates between invalid netmagic and invalid header. It tolerates invalid headers (while not invalid netmagics), thus we need a way to transport those check-states without breaking the current behavior.\r\n\r\nSince this PR aims to do a refactoring, I don't think behavioral changes are ideal here.",
      "commit_id" : "e85d88de78a3866119eb10d00e6d74732e300e98",
      "created_at" : "2019-07-24T06:48:17Z",
      "diff_hunk" : "@@ -678,14 +679,40 @@ int CNetMessage::readData(const char *pch, unsigned int nBytes)\n     return nCopy;\n }\n \n-const uint256& CNetMessage::GetMessageHash() const\n+const uint256& TransportDeserializer::GetMessageHash() const\n {\n     assert(complete());\n     if (data_hash.IsNull())\n         hasher.Finalize(data_hash.begin());\n     return data_hash;\n }\n \n+CNetMessage TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time) {\n+    // decompose a single CNetMessage from the TransportDeserializer\n+    CNetMessage msg(vRecv);\n+\n+    // store state about valid header, netmagic and checksum\n+    msg.m_valid_header = hdr.IsValid(message_start);\n+    msg.m_valid_netmagic = (memcmp(hdr.pchMessageStart, message_start, CMessageHeader::MESSAGE_START_SIZE) == 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16202#discussion_r306650400",
      "id" : 306650400,
      "in_reply_to_id" : 306382732,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNjY1MDQwMA==",
      "original_commit_id" : "2cd45b2f4e8cfdb2eac3c886bec10653b4a066b5",
      "original_position" : 100,
      "path" : "src/net.cpp",
      "position" : 99,
      "pull_request_review_id" : 265819896,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16202",
      "updated_at" : "2019-07-25T11:07:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306650400",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16202#discussion_r306650745"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16202"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306650745"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Next step would be to further avoid transport-specific stuff in `ProcessMessages()`. I think  #15206 and #15197 are a good next step (would need rebase after this).",
      "commit_id" : "e85d88de78a3866119eb10d00e6d74732e300e98",
      "created_at" : "2019-07-24T06:49:35Z",
      "diff_hunk" : "@@ -570,8 +570,39 @@ class CNodeStats\n \n \n \n-\n+/** Transport protocol agnostic message container.\n+ * Ideally it should only contain receive time, payload,\n+ * command and size.\n+ */\n class CNetMessage {\n+public:\n+    CDataStream m_recv;              // received message data\n+    int64_t m_time;                  // time (in microseconds) of message receipt.\n+    bool m_valid_netmagic;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16202#discussion_r306650745",
      "id" : 306650745,
      "in_reply_to_id" : 306388229,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNjY1MDc0NQ==",
      "original_commit_id" : "2cd45b2f4e8cfdb2eac3c886bec10653b4a066b5",
      "original_position" : 13,
      "path" : "src/net.h",
      "position" : 13,
      "pull_request_review_id" : 265820339,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16202",
      "updated_at" : "2019-07-25T11:07:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306650745",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16202#discussion_r306878168"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16202"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306878168"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ok thanks, going to check them once they are rebased",
      "commit_id" : "e85d88de78a3866119eb10d00e6d74732e300e98",
      "created_at" : "2019-07-24T15:32:19Z",
      "diff_hunk" : "@@ -570,8 +570,39 @@ class CNodeStats\n \n \n \n-\n+/** Transport protocol agnostic message container.\n+ * Ideally it should only contain receive time, payload,\n+ * command and size.\n+ */\n class CNetMessage {\n+public:\n+    CDataStream m_recv;              // received message data\n+    int64_t m_time;                  // time (in microseconds) of message receipt.\n+    bool m_valid_netmagic;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16202#discussion_r306878168",
      "id" : 306878168,
      "in_reply_to_id" : 306388229,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNjg3ODE2OA==",
      "original_commit_id" : "2cd45b2f4e8cfdb2eac3c886bec10653b4a066b5",
      "original_position" : 13,
      "path" : "src/net.h",
      "position" : 13,
      "pull_request_review_id" : 266106052,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16202",
      "updated_at" : "2019-07-25T14:14:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306878168",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16202#discussion_r306880677"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16202"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306880677"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ah yes exact, you may have a valid netmagic and an invalid header and get accepted. \r\n\r\nOkay, I agree if these points are addressed later in behavioral changes specific PRs that's better than everything at once. ",
      "commit_id" : "e85d88de78a3866119eb10d00e6d74732e300e98",
      "created_at" : "2019-07-24T15:37:19Z",
      "diff_hunk" : "@@ -678,14 +679,40 @@ int CNetMessage::readData(const char *pch, unsigned int nBytes)\n     return nCopy;\n }\n \n-const uint256& CNetMessage::GetMessageHash() const\n+const uint256& TransportDeserializer::GetMessageHash() const\n {\n     assert(complete());\n     if (data_hash.IsNull())\n         hasher.Finalize(data_hash.begin());\n     return data_hash;\n }\n \n+CNetMessage TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time) {\n+    // decompose a single CNetMessage from the TransportDeserializer\n+    CNetMessage msg(vRecv);\n+\n+    // store state about valid header, netmagic and checksum\n+    msg.m_valid_header = hdr.IsValid(message_start);\n+    msg.m_valid_netmagic = (memcmp(hdr.pchMessageStart, message_start, CMessageHeader::MESSAGE_START_SIZE) == 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16202#discussion_r306880677",
      "id" : 306880677,
      "in_reply_to_id" : 306382732,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNjg4MDY3Nw==",
      "original_commit_id" : "2cd45b2f4e8cfdb2eac3c886bec10653b4a066b5",
      "original_position" : 100,
      "path" : "src/net.cpp",
      "position" : 99,
      "pull_request_review_id" : 266109372,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16202",
      "updated_at" : "2019-07-25T11:07:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306880677",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks @ariard for the review.\r\nFixed those points/nits. Mainly the private declaration of members and methods of the `V1TransportDeserializer` class. ",
      "created_at" : "2019-07-25T11:09:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16202#issuecomment-515002359",
      "id" : 515002359,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16202",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxNTAwMjM1OQ==",
      "updated_at" : "2019-07-25T11:09:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/515002359",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16202#discussion_r307326085"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16202"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/307326085"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: s/retruns/returns/",
      "commit_id" : "e85d88de78a3866119eb10d00e6d74732e300e98",
      "created_at" : "2019-07-25T14:28:35Z",
      "diff_hunk" : "@@ -570,56 +570,115 @@ class CNodeStats\n \n \n \n-\n+/** Transport protocol agnostic message container.\n+ * Ideally it should only contain receive time, payload,\n+ * command and size.\n+ */\n class CNetMessage {\n+public:\n+    CDataStream m_recv;              // received message data\n+    int64_t m_time;                  // time (in microseconds) of message receipt.\n+    bool m_valid_netmagic;\n+    bool m_valid_header;\n+    bool m_valid_checksum;\n+    uint32_t m_message_size;         // size of the payload\n+    uint32_t m_raw_message_size;     // used wire size of the message (including header/checksum)\n+    std::string m_command;\n+\n+    CNetMessage(const CDataStream& recv_in) : m_recv(recv_in) {\n+        m_time = 0;\n+        m_valid_netmagic = false;\n+        m_valid_header = false;\n+        m_valid_checksum = false;\n+        m_message_size = 0;\n+        m_raw_message_size = 0;\n+    }\n+\n+    void SetVersion(int nVersionIn)\n+    {\n+        m_recv.SetVersion(nVersionIn);\n+    }\n+};\n+\n+/** The TransportDeserializer takes care of holding and deserializing the\n+ * network receive buffer. It can deserialize the network buffer into a\n+ * transport protocol agnostic CNetMessage (command & payload)\n+ */\n+class TransportDeserializer {\n+public:\n+    // prepare for next message\n+    virtual void Reset() = 0;\n+    // retruns true if the current deserialization is complete",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16202#discussion_r307326085",
      "id" : 307326085,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNzMyNjA4NQ==",
      "original_commit_id" : "e85d88de78a3866119eb10d00e6d74732e300e98",
      "original_position" : 43,
      "path" : "src/net.h",
      "position" : 43,
      "pull_request_review_id" : 266664679,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16202",
      "updated_at" : "2019-07-25T14:29:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/307326085",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept and approach ACK.\r\n\r\nI'll go through the code in more detail soon, but one thing I noticed is that this introduces an unnecessary copy of the message payload in the `GetMessage()` function. It can be avoided by moving the `CDataStream`: https://github.com/sipa/bitcoin/tree/pr16202",
      "created_at" : "2019-07-29T22:56:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16202#issuecomment-516192751",
      "id" : 516192751,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16202",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxNjE5Mjc1MQ==",
      "updated_at" : "2019-07-29T22:56:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/516192751",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   }
]
