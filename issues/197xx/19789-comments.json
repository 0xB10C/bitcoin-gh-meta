[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Ping @adaminsky ",
      "created_at" : "2020-08-24T15:54:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/19789#issuecomment-679212073",
      "id" : 679212073,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19789",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3OTIxMjA3Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-24T15:54:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/679212073",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I can reproduce this, and I made a simple proof of concept test which seems to show this might be a problem with `thread_local` variables on macOS. I get the following error before the `AddressSanitizer:DEADLYSIGNAL` output:\r\n```\r\n/usr/local/opt/llvm/bin/../include/c++/v1/string:2728:44: runtime error: member call on misaligned address 0x000000000001 for type 'std::__1::basic_string<char> *', which requires 8 byte alignment\r\n```\r\n\r\nI think the issue is that the address for `util::ThreadGetInternalName()`, which comes from a `thread_local` variable, is not 8 byte aligned because macOS does not enforce any alignment for `thread_local` variables. clang seems to require that `thread_local` variables be treated similarly to global variables, so they must be properly aligned which may throw off the address sanitizer.\r\n\r\nThis small example creates a very similar error when compiled with `clang++ -g -O3 -fsanitize=address,undefined test.cpp -o test`.\r\n```c++\r\n#include <iostream>\r\n\r\nstatic thread_local std::string tstr = \"test1\";\r\nstd::string global = \"test2\";\r\n\r\nint main() {\r\n    std::cout << \"<\" + global + \">\" << std::endl; // Works fine\r\n    std::cout << \"<\" + tstr + \">\" << std::endl;   // Error\r\n}\r\n```\r\nThe `-O3` flag is important because when I try `-O1`, no error is found. The alignment problem can be seen by using a debugger to print the addresses of `global` and `tstr` to see how the first is correctly aligned and the second isn't. I think the above program should work correctly if I am using a `thread_local` variable correctly, so this could be an llvm issue.",
      "created_at" : "2020-08-25T21:24:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/19789#issuecomment-680277495",
      "id" : 680277495,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19789",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4MDI3NzQ5NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-25T21:24:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/680277495",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/29065991?v=4",
         "events_url" : "https://api.github.com/users/adaminsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/adaminsky/followers",
         "following_url" : "https://api.github.com/users/adaminsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/adaminsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/adaminsky",
         "id" : 29065991,
         "login" : "adaminsky",
         "node_id" : "MDQ6VXNlcjI5MDY1OTkx",
         "organizations_url" : "https://api.github.com/users/adaminsky/orgs",
         "received_events_url" : "https://api.github.com/users/adaminsky/received_events",
         "repos_url" : "https://api.github.com/users/adaminsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/adaminsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/adaminsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/adaminsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "It happens in the `process_messages` harness with varying regularity (depending on optimization flags) on my mac only with `-fsanitize=address,undefined` set (rather than just `-fsanitize=address`). I think all we can do here is add an asan suppression. What do you think @practicalswift ?",
      "created_at" : "2020-09-02T03:28:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/19789#issuecomment-685268087",
      "id" : 685268087,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19789",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4NTI2ODA4Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-02T03:28:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/685268087",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "+1\r\n\r\nI reproduced this unintentionally while testing #19065.",
      "created_at" : "2020-10-18T20:38:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/19789#issuecomment-711419220",
      "id" : 711419220,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19789",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcxMTQxOTIyMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-18T20:38:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/711419220",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@Crypt-iQ Sorry, I don't have any Mac to test on and I haven't seen this issue under Linux. I'm afraid I'll have to let someone else tackle this issue :)",
      "created_at" : "2020-10-18T20:44:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/19789#issuecomment-711420031",
      "id" : 711420031,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19789",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcxMTQyMDAzMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-18T20:44:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/711420031",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> I can reproduce this, and I made a simple proof of concept test which seems to show this might be a problem with `thread_local` variables on macOS. I get the following error before the `AddressSanitizer:DEADLYSIGNAL` output:\r\n> \r\n> ```\r\n> /usr/local/opt/llvm/bin/../include/c++/v1/string:2728:44: runtime error: member call on misaligned address 0x000000000001 for type 'std::__1::basic_string<char> *', which requires 8 byte alignment\r\n> ```\r\n\r\nThat's an interesting find, I'm not sure it's the same one though, because the OP got a Segmentation Violation while you got a misaligned read.\r\nNevertheless you should report this to: https://bugs.llvm.org with the full details(clang version, Xcode version, full sanitizer output).",
      "created_at" : "2020-10-22T13:31:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/19789#issuecomment-714496212",
      "id" : 714496212,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19789",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcxNDQ5NjIxMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-22T13:31:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/714496212",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2167860?v=4",
         "events_url" : "https://api.github.com/users/elichai/events{/privacy}",
         "followers_url" : "https://api.github.com/users/elichai/followers",
         "following_url" : "https://api.github.com/users/elichai/following{/other_user}",
         "gists_url" : "https://api.github.com/users/elichai/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/elichai",
         "id" : 2167860,
         "login" : "elichai",
         "node_id" : "MDQ6VXNlcjIxNjc4NjA=",
         "organizations_url" : "https://api.github.com/users/elichai/orgs",
         "received_events_url" : "https://api.github.com/users/elichai/received_events",
         "repos_url" : "https://api.github.com/users/elichai/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/elichai/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/elichai/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/elichai"
      }
   }
]
