[
   {
      "author_association" : "MEMBER",
      "body" : "I'm not 100% convinced about replacing `IsAddrRelayPeer()` with `RelayAddrsWithConn()`  9345f9c9d47a88987606d1421823914a4c48dbf9. \r\n\r\nPros: \r\n- It is more direct to check the connection type instead of a (missing) data structure based on the connection type.\r\n- Easy to update logic in the future \r\n- Less mental overhead, less code touch points to glean intention. \r\n\r\nCons: \r\n- We are now checking the same conditional in two places- [[1](https://github.com/bitcoin/bitcoin/pull/19724/commits/9345f9c9d47a88987606d1421823914a4c48dbf9#diff-1a8b9d1ad0a6fda5e751286c73102fc2R867)] & [[2](https://github.com/bitcoin/bitcoin/blob/master/src/net.cpp#L2783)], and need to manually ensure they do not fall out of sync. \r\n\r\nCurious to hear what other reviewers think is preferable. ",
      "created_at" : "2020-08-14T22:32:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19724#issuecomment-674298044",
      "id" : 674298044,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19724",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3NDI5ODA0NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-14T22:59:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/674298044",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@amitiuttarwar I think it makes sense to make the addr-relay decision depend on the connection type. That should be the most authoritative information about the connection. Sure, it's duplication, but if we accidentally forget to create the necessary data structures, test will fail; if we accidentally create them if they're not needed, at worst we've wasted a bit of memory we're already ok with for other nodes.",
      "created_at" : "2020-08-14T23:53:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19724#issuecomment-674314573",
      "id" : 674314573,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19724",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3NDMxNDU3Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-14T23:53:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/674314573",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19724#discussion_r470950246"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19724"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/470950246"
         }
      },
      "author_association" : "MEMBER",
      "body" : "style-nit:\r\n\r\n```suggestion\r\n                switch (pnode->m_conn_type) {\r\n```\r\n\r\nif you decide to do style-fixups, it would probably be good to do all of them in one go or not at all. Maybe with clang-format-diff?   https://github.com/bitcoin/bitcoin/tree/master/contrib/devtools#clang-format-diffpy ",
      "commit_id" : "b672f8d84f8d4562fe8e228abd35c85a66bdbf4c",
      "created_at" : "2020-08-15T07:38:46Z",
      "diff_hunk" : "@@ -1841,11 +1841,11 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\n                 // but inbound and manual peers do not use our outbound slots. Inbound peers\n                 // also have the added issue that they could be attacker controlled and used\n                 // to prevent us from connecting to particular hosts if we used them here.\n-                switch(pnode->m_conn_type){\n+                switch (pnode->m_conn_type){",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19724#discussion_r470950246",
      "id" : 470950246,
      "line" : 1844,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk1MDI0Ng==",
      "original_commit_id" : "b672f8d84f8d4562fe8e228abd35c85a66bdbf4c",
      "original_line" : 1844,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 5,
      "pull_request_review_id" : 467955141,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19724",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-15T07:38:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/470950246",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19724#discussion_r470962473"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19724"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/470962473"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If we're cleaning this up, we should really clean it up and move the `connman.MarkAddressGood()` out of this if statement, since it's not related to address advertising at all. Having it in the same conditional is a trap for developers to fall into.\r\n\r\n(specifically, a developer might think \"we don't need to advertise our address to FEELER connections, since we disconnect before we actually send the ADDR or GETADDR messages, so we can remove FEELER from AdvertiseAddressToConn\", but doing that breaks our FEELER connection logic, because `MarkAddressGood()` needs to be called to mark the address as good)\r\n\r\ncc @sdaftuar ",
      "commit_id" : "b672f8d84f8d4562fe8e228abd35c85a66bdbf4c",
      "created_at" : "2020-08-15T10:16:06Z",
      "diff_hunk" : "@@ -2433,9 +2433,8 @@ void ProcessMessage(\n         UpdatePreferredDownload(pfrom, State(pfrom.GetId()));\n         }\n \n-        if (!pfrom.IsInboundConn() && pfrom.IsAddrRelayPeer())\n+        if (pfrom.AdvertiseAddressToConn())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19724#discussion_r470962473",
      "id" : 470962473,
      "line" : 2436,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk2MjQ3Mw==",
      "original_commit_id" : "b672f8d84f8d4562fe8e228abd35c85a66bdbf4c",
      "original_line" : 2436,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 32,
      "pull_request_review_id" : 467962627,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19724",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-15T10:16:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/470962473",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Strong strong concept ACK.\r\n\r\nI think it'd be good to extract everything in the `while (!interruptNet)` in `ThreadOpenConnections()` into its own function since deeply nested while/for/if blocks obscure control flow and are very often the sources of bugs. Doing that might be scope creep for this PR though.",
      "created_at" : "2020-08-15T10:18:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19724#issuecomment-674379263",
      "id" : 674379263,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19724",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3NDM3OTI2Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-15T10:18:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/674379263",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19724#discussion_r471019849"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19724"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/471019849"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I was looking at this more and I believe we should leave the MarkAddressGood call in the if-block, though it needs an explanationâ the reason (I think) is that we donât want block-relay connections to leave a trace in the addrman that could be leaked by an attacker sniffing our addr responses.\r\n\r\nSo this just needs a comment explaining why itâs in here.\r\n",
      "commit_id" : "b672f8d84f8d4562fe8e228abd35c85a66bdbf4c",
      "created_at" : "2020-08-15T18:08:07Z",
      "diff_hunk" : "@@ -2433,9 +2433,8 @@ void ProcessMessage(\n         UpdatePreferredDownload(pfrom, State(pfrom.GetId()));\n         }\n \n-        if (!pfrom.IsInboundConn() && pfrom.IsAddrRelayPeer())\n+        if (pfrom.AdvertiseAddressToConn())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19724#discussion_r471019849",
      "id" : 471019849,
      "in_reply_to_id" : 470962473,
      "line" : 2436,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTAxOTg0OQ==",
      "original_commit_id" : "b672f8d84f8d4562fe8e228abd35c85a66bdbf4c",
      "original_line" : 2436,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 32,
      "pull_request_review_id" : 468009053,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19724",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-15T18:08:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/471019849",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19724#discussion_r471090087"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19724"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/471090087"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can you explain this a bit? I think you're saying that if we connect out to a peer that we use for block-relay-only we don't want to mark it as good (essentially move it from New to Tried and update the last successful connect time) because then another peer might be able to tell that we've connected to them?\r\n\r\nMy understanding of how we respond to `getaddr` messages is that we'll respond with (up to) 1000 records taken at random from all records, regardless of whether they're in New or Tried, so marking a peer as good won't change whether we include it in `addr` responses.",
      "commit_id" : "b672f8d84f8d4562fe8e228abd35c85a66bdbf4c",
      "created_at" : "2020-08-16T09:38:35Z",
      "diff_hunk" : "@@ -2433,9 +2433,8 @@ void ProcessMessage(\n         UpdatePreferredDownload(pfrom, State(pfrom.GetId()));\n         }\n \n-        if (!pfrom.IsInboundConn() && pfrom.IsAddrRelayPeer())\n+        if (pfrom.AdvertiseAddressToConn())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19724#discussion_r471090087",
      "id" : 471090087,
      "in_reply_to_id" : 470962473,
      "line" : 2436,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTA5MDA4Nw==",
      "original_commit_id" : "b672f8d84f8d4562fe8e228abd35c85a66bdbf4c",
      "original_line" : 2436,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 32,
      "pull_request_review_id" : 468049187,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19724",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-16T09:38:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/471090087",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   }
]
