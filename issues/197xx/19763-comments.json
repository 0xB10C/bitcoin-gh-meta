[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I stumbled into this while testing https://github.com/bitcoin/bitcoin/pull/19728.",
      "created_at" : "2020-08-18T19:50:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19763#issuecomment-675679253",
      "id" : 675679253,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19763",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3NTY3OTI1Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-18T19:50:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/675679253",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This behavior is intentional, and the hash-based logic to determine where to send exploits it (there is a comment about `m_addr_known` in `RelayAddress`).\r\n\r\nThe idea is that every incoming addr is only relayed to a fixed subset of 1 or 2 peers during windows of 24 hours. This means that if the same address is relayed again, it will go to the same peers (and likely not be sent at all as they already know it). This change would permit someone to unjustly give their address better propagation by sending it repeatedly.",
      "created_at" : "2020-08-18T19:53:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19763#issuecomment-675680772",
      "id" : 675680772,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19763",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3NTY4MDc3Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-18T19:53:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/675680772",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Alright, I see the problem this would cause.\r\n\r\nThe condition added in this PR `!pnode->m_addr_known->contains(addr)` is too strong. I only intended to avoid relaying to the node that sent us the address, trying to avoid this adverse scenario:\r\n\r\n* let node0 have connections to 8 other nodes: node1, ..., node8.\r\n* node5 sends some address to node0\r\n* node0 is about to relay it to 2 \"random\" nodes and picks node3 and node5\r\n* node5 already knows the address and so is skipped by `PushAddress()`\r\n* the address is relayed to just node3 - one node instead of two :bomb:.\r\n\r\nLooks like the chance of this happening is ~~1/8, or 12.5%~~ 1/4, or 25%.\r\n\r\n> This means that if the same address is relayed again, it will go to the same peers (and likely not be sent at all as they already know it)\r\n\r\nIs this \"likely\" actually \"for sure\"? Is this correct: \"This means that the same address will not be re-relayed again in 24h because we would attempt to send it to the same peers and this will be a noop by `PushAddress()`\"? (assuming the list of peers does not change).",
      "created_at" : "2020-08-18T20:33:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19763#issuecomment-675698521",
      "id" : 675698521,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19763",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3NTY5ODUyMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-19T08:12:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/675698521",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@vasild Ah, I see. That's a good point, and should probably be improved. I think we can just make sure that the originating node is skipped in the list of considered candidates?",
      "created_at" : "2020-08-18T20:37:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19763#issuecomment-675703311",
      "id" : 675703311,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19763",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3NTcwMzMxMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-18T20:37:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/675703311",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> make sure that the originating node is skipped in the list of considered candidates\r\n\r\nExactly! Done in e80a80b and extended a test so that it fails without this fix.\r\n\r\nReopened for review.",
      "created_at" : "2020-08-19T10:44:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19763#issuecomment-676127052",
      "id" : 676127052,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19763",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3NjEyNzA1Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-19T10:44:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/676127052",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Interesting. Will review.",
      "created_at" : "2020-08-19T16:08:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19763#issuecomment-676519017",
      "id" : 676519017,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19763",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3NjUxOTAxNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-19T16:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/676519017",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2020-08-19T19:11:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19763#issuecomment-676609042",
      "id" : 676609042,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19763",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3NjYwOTA0Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-19T19:11:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/676609042",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "What if the same address is relayed again but from a different peer? I think the list of nodes the address would be relayed to might not be the same, because now it depends on the address AND the origin and not just the address, so the list would only be deterministic for the same origin.",
      "created_at" : "2020-08-19T19:49:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19763#issuecomment-676626905",
      "id" : 676626905,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19763",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3NjYyNjkwNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-19T19:49:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/676626905",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@dergoegge, the [hashKey](https://github.com/bitcoin/bitcoin/blob/e80a80b25/src/net_processing.cpp#L1514) of each relay-to candidate does not depend on the originator. Can you elaborate? I think the list of nodes the address would be relayed to does not depend on the originator, except that the originator will be skipped if he happens to be one of the two chosen nodes and in his place another node will be selected.\r\n\r\nNotice that `CSipHasher(hasher).Write(pnode->GetId()).Finalize()` creates a temporary which is destroyed before the next candidate is evaluated.",
      "created_at" : "2020-08-20T07:47:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19763#issuecomment-677434516",
      "id" : 677434516,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19763",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3NzQzNDUxNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-20T07:47:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/677434516",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "@vasild while trying to come up with an example i realised that you are right and that i didn't fully understand how `sortfunc` works (even though it has \"sort\" in the name ð), sorry. ",
      "created_at" : "2020-08-20T09:30:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19763#issuecomment-677488472",
      "id" : 677488472,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19763",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3NzQ4ODQ3Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-20T09:30:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/677488472",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #19724 ([net] Cleanup connection types- followups by amitiuttarwar)\n* #19704 (Net processing: move ProcessMessage() to PeerLogicValidation by jnewbery)\n* #19499 (p2p: Make timeout mockable and type safe, speed up test by MarcoFalke)\n* #18642 (Use std::chrono for the time to rotate destination of addr messages + tests by naumenkogs)\n* #17194 (p2p: Avoid forwarding ADDR messages to SPV nodes by naumenkogs)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-08-20T19:53:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19763#issuecomment-677870688",
      "id" : 677870688,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19763",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3Nzg3MDY4OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-20T19:53:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/677870688",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   }
]
