[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6261#discussion_r32088146"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/32088146"
         }
      },
      "body" : "Harmonize the two LogPrint() calls.  No reason to omit strCommand diagnostic output on this first LogPrint() here.",
      "commit_id" : "31c808d601fdbf657e229fabcf2465a1923eb93f",
      "created_at" : "2015-06-10T04:55:14Z",
      "diff_hunk" : "@@ -3760,6 +3765,36 @@ std::string GetWarnings(const std::string& strFor)\n // Messages\n //\n \n+static std::map<std::string, size_t> maxMessageSizes = boost::assign::map_list_of\n+    (\"addr\", 2+1000*30)\n+    (\"getaddr\",0)\n+    (\"getdata\", 2+MAX_INV_SZ*36)\n+    (\"inv\", 2+MAX_INV_SZ*36)\n+    (\"mempool\",0)\n+    (\"notfound\", 2+MAX_INV_SZ*36)\n+    (\"ping\",8)\n+    (\"pong\",8)\n+    (\"verack\", 0)\n+    ;\n+\n+bool static SanityCheckMessage(CNode* peer, const CNetMessage& msg)\n+{\n+    if (msg.hdr.nMessageSize > MAX_PROTOCOL_MESSAGE_LENGTH) {\n+        LogPrint(\"net\", \"Oversized message from peer=%i, disconnecting\", peer->GetId());\n+        return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6261#discussion_r32088146",
      "id" : 32088146,
      "original_commit_id" : "fc820b39c5778afd1b3f1020b22684192493f642",
      "original_position" : 53,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6261",
      "updated_at" : "2015-06-10T13:48:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/32088146",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6261#discussion_r32088223"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/32088223"
         }
      },
      "body" : "Code is correct.  However, it seems odd to put this in CNode. </nit>",
      "commit_id" : "31c808d601fdbf657e229fabcf2465a1923eb93f",
      "created_at" : "2015-06-10T04:58:01Z",
      "diff_hunk" : "@@ -2017,6 +2015,22 @@ void CNode::AbortMessage() UNLOCK_FUNCTION(cs_vSend)\n     LogPrint(\"net\", \"(aborted)\\n\");\n }\n \n+unsigned int CNode::FinalizeHeader(CDataStream& s)\n+{\n+    // Set the size\n+    unsigned int nSize = s.size() - CMessageHeader::HEADER_SIZE;\n+    WriteLE32((uint8_t*)&s[CMessageHeader::MESSAGE_SIZE_OFFSET], nSize);\n+\n+    // Set the checksum\n+    uint256 hash = Hash(s.begin() + CMessageHeader::HEADER_SIZE, s.end());\n+    unsigned int nChecksum = 0;\n+    memcpy(&nChecksum, &hash, sizeof(nChecksum));\n+    assert(s.size () >= CMessageHeader::CHECKSUM_OFFSET + sizeof(nChecksum));\n+    memcpy((char*)&s[CMessageHeader::CHECKSUM_OFFSET], &nChecksum, sizeof(nChecksum));\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6261#discussion_r32088223",
      "id" : 32088223,
      "original_commit_id" : "fc820b39c5778afd1b3f1020b22684192493f642",
      "original_position" : 31,
      "path" : "src/net.cpp",
      "position" : 31,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6261",
      "updated_at" : "2015-06-10T13:48:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/32088223",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "body" : "ut ACK modulo comments\r\n",
      "created_at" : "2015-06-10T04:58:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6261#issuecomment-110588705",
      "id" : 110588705,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6261",
      "updated_at" : "2015-06-10T04:58:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/110588705",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "body" : "Addressed @jgarzik comments -- FinalizeHeader moved to CNetMessage (I considered moving it to CNetHeader, but didn't want to make protocol.h dependent on CDataStream).  And unified the log message (and remembered to SanitizeString(command) at the very last moment).",
      "created_at" : "2015-06-10T13:50:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6261#issuecomment-110761701",
      "id" : 110761701,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6261",
      "updated_at" : "2015-06-10T13:50:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/110761701",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "body" : "Concept ACK, though I would just pass a pointer to CNetMessage rather than a wrapper-and-then-auto-unwrapped boost reference object.",
      "created_at" : "2015-06-14T13:27:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6261#issuecomment-111827108",
      "id" : 111827108,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6261",
      "updated_at" : "2015-06-14T13:27:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/111827108",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "@sipa: it'll be std::cref() when we move to C++11... and passing a reference is, in my opinion, cleaner than passing a pointer since the routine doesn't have to worry about checking for NULL.",
      "created_at" : "2015-06-26T18:10:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6261#issuecomment-115821371",
      "id" : 115821371,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6261",
      "updated_at" : "2015-06-26T18:10:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/115821371",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6261#discussion_r33404109"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/33404109"
         }
      },
      "body" : "Why did you choose to not directly pass the NodeId? It seems it's the only field used in here.",
      "commit_id" : "31c808d601fdbf657e229fabcf2465a1923eb93f",
      "created_at" : "2015-06-26T23:15:25Z",
      "diff_hunk" : "@@ -3765,6 +3770,32 @@ std::string GetWarnings(const std::string& strFor)\n // Messages\n //\n \n+static std::map<std::string, size_t> maxMessageSizes = boost::assign::map_list_of\n+    (\"addr\", 2+1000*30)\n+    (\"getaddr\",0)\n+    (\"getdata\", 2+MAX_INV_SZ*36)\n+    (\"inv\", 2+MAX_INV_SZ*36)\n+    (\"mempool\",0)\n+    (\"notfound\", 2+MAX_INV_SZ*36)\n+    (\"ping\",8)\n+    (\"pong\",8)\n+    (\"verack\", 0)\n+    ;\n+\n+bool static SanityCheckMessage(CNode* peer, const CNetMessage& msg)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6261#discussion_r33404109",
      "id" : 33404109,
      "original_commit_id" : "31c808d601fdbf657e229fabcf2465a1923eb93f",
      "original_position" : 49,
      "path" : "src/main.cpp",
      "position" : 49,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6261",
      "updated_at" : "2015-06-26T23:15:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/33404109",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6261#discussion_r33404350"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/33404350"
         }
      },
      "body" : "``s.size()`` returns ``size_t``, so we have ``unsigned int = size_t - int``... is this correct?",
      "commit_id" : "31c808d601fdbf657e229fabcf2465a1923eb93f",
      "created_at" : "2015-06-26T23:19:39Z",
      "diff_hunk" : "@@ -564,6 +562,22 @@ bool CNode::ReceiveMsgBytes(const char *pch, unsigned int nBytes)\n     return true;\n }\n \n+unsigned int CNetMessage::FinalizeHeader(CDataStream& s)\n+{\n+    // Set the size\n+    unsigned int nSize = s.size() - CMessageHeader::HEADER_SIZE;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6261#discussion_r33404350",
      "id" : 33404350,
      "original_commit_id" : "31c808d601fdbf657e229fabcf2465a1923eb93f",
      "original_position" : 22,
      "path" : "src/net.cpp",
      "position" : 22,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6261",
      "updated_at" : "2015-06-26T23:19:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/33404350",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "body" : "@dgenr8 is seeing peer disconnections due to this code (it is part of the BIP101 pull request), especially with 'addr' messages. I need to investigate why.\r\n\r\nAnd I like detecting misbehavior early, but this should work with the existing Misbehaving() logic. I think I see a path to get there:\r\n\r\n1) Refactor mapNodeState so it is protected by it's own lock instead of cs_main. \r\n2) Rework this pull request to call Misbehaving() for oversize messages; never immediately disconnect.",
      "created_at" : "2015-07-13T16:27:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6261#issuecomment-120986538",
      "id" : 120986538,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6261",
      "updated_at" : "2015-07-13T16:27:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/120986538",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "body" : "@gavinandresen 1000 addr messages is 3 + 1000*30 bytes, as the serialized vector length for sizes over 253 takes 3 bytes,",
      "created_at" : "2015-07-13T16:35:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6261#issuecomment-120988215",
      "id" : 120988215,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6261",
      "updated_at" : "2015-07-13T16:35:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/120988215",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   }
]
