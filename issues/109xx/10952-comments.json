[
   {
      "body" : "So you still need to write a default key unless we're going to bump the wallet version again for this, because otherwise you'll make it backwards incompatible with software without this patch.\r\n\r\nOtherwise, Concept ACK!",
      "created_at" : "2017-07-29T21:37:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10952#issuecomment-318861268",
      "id" : 318861268,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10952",
      "updated_at" : "2017-07-29T21:37:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/318861268",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "How about bump the wallet version again? If there are any other wallet changes that need a version bump, we could do them all at the same time.",
      "created_at" : "2017-07-29T21:56:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10952#issuecomment-318862222",
      "id" : 318862222,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10952",
      "updated_at" : "2017-07-29T21:56:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/318862222",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "body" : "I would be fine with that but I think it might be easier to get this bugfix merged without it.",
      "created_at" : "2017-07-30T00:41:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10952#issuecomment-318869295",
      "id" : 318869295,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10952",
      "updated_at" : "2017-07-30T00:41:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/318869295",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "Sounds like maybe something that we should look into for 15, then, though I'd really like to look into the source of the corruption here, rather than patching over it.",
      "created_at" : "2017-07-30T14:36:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10952#issuecomment-318905869",
      "id" : 318905869,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10952",
      "updated_at" : "2017-07-30T14:36:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/318905869",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "@gmaxwell I added `WriteDefaultKey` back in so that a default key will be written to maintain backwards compatibility. The key will not be read in.",
      "created_at" : "2017-07-31T18:18:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10952#issuecomment-319152439",
      "id" : 319152439,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10952",
      "updated_at" : "2017-07-31T18:18:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/319152439",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "body" : "I really dont think this is the right way to fix this issue. Can we instead ensure that, if the wallet has keys but vchDefaultKey is invalid, an error is printed like \"your wallet is corrupted, seems you disk is silently corrupting things\", and then make sure -salvagewallet is able to properly recover from this state?",
      "created_at" : "2017-08-03T16:15:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10952#issuecomment-320017634",
      "id" : 320017634,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10952",
      "updated_at" : "2017-08-03T16:15:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/320017634",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "I have updated this with a few changes.\r\n\r\nI removed the defaultkey writing again. New wallets will no longer have a default key. If a defaultkey is found in the wallet, it must be valid, otherwise it will exit with a wallet corruption error.\r\n\r\nIt turns out that `-salvagewallet` may have been the cause of all of these issues. `-salvagewallet` apparently does not write a default key to the wallet, which with an encrypted wallet and with HD enabled, will cause the aforementioned runtime exception and crash. If a user does have a corrupted default key, then `-salvagewallet` will remove it, as it did in the past.",
      "created_at" : "2017-08-03T23:44:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10952#issuecomment-320118820",
      "id" : 320118820,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10952",
      "updated_at" : "2017-08-03T23:44:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/320118820",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10952#discussion_r131300813"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10952"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/131300813"
         }
      },
      "body" : "Can you call `walletInstance->TopUpKeyPool();` here instead of this entire section? No need to waste a key and an address book entry for this.",
      "commit_id" : "8f3ea174a717cfea2bfd3abcd12b63651cb74c4a",
      "created_at" : "2017-08-04T02:30:17Z",
      "diff_hunk" : "@@ -3958,11 +3947,13 @@ CWallet* CWallet::CreateWalletFromFile(const std::string walletFile)\n             if (!walletInstance->SetHDMasterKey(masterPubKey))\n                 throw std::runtime_error(std::string(__func__) + \": Storing master key failed\");\n         }\n-        CPubKey newDefaultKey;\n-        if (walletInstance->GetKeyFromPool(newDefaultKey, false)) {\n-            walletInstance->SetDefaultKey(newDefaultKey);\n-            if (!walletInstance->SetAddressBook(walletInstance->vchDefaultKey.GetID(), \"\", \"receive\")) {\n-                InitError(_(\"Cannot write default address\") += \"\\n\");\n+\n+        // Generate an address for the address book and to fill the keypool\n+        CPubKey key;\n+        if (walletInstance->GetKeyFromPool(key, false)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10952#discussion_r131300813",
      "id" : 131300813,
      "original_commit_id" : "8f3ea174a717cfea2bfd3abcd12b63651cb74c4a",
      "original_position" : 60,
      "path" : "src/wallet/wallet.cpp",
      "position" : 60,
      "pull_request_review_id" : 54268014,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10952",
      "updated_at" : "2017-08-04T02:38:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/131300813",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10952#discussion_r131301391"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10952"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/131301391"
         }
      },
      "body" : "\"defaultkey\" is not part of `IsKeyType`, so this failure will just be a non-critical warning upon loading. I assume that's intentional?",
      "commit_id" : "8f3ea174a717cfea2bfd3abcd12b63651cb74c4a",
      "created_at" : "2017-08-04T02:36:50Z",
      "diff_hunk" : "@@ -452,7 +447,13 @@ ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n         }\n         else if (strType == \"defaultkey\")\n         {\n-            ssValue >> pwallet->vchDefaultKey;\n+            CPubKey vchPubKey;\n+            ssKey >> vchPubKey;\n+            if (!vchPubKey.IsValid())\n+            {\n+                strErr = \"Error reading wallet database: Default Key corrupt\";",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10952#discussion_r131301391",
      "id" : 131301391,
      "original_commit_id" : "8f3ea174a717cfea2bfd3abcd12b63651cb74c4a",
      "original_position" : 21,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 21,
      "pull_request_review_id" : 54268014,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10952",
      "updated_at" : "2017-08-04T02:38:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/131301391",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10952#discussion_r131301415"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10952"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/131301415"
         }
      },
      "body" : "Code style nit: `{` on the same like as `if`.",
      "commit_id" : "8f3ea174a717cfea2bfd3abcd12b63651cb74c4a",
      "created_at" : "2017-08-04T02:37:09Z",
      "diff_hunk" : "@@ -452,7 +447,13 @@ ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n         }\n         else if (strType == \"defaultkey\")\n         {\n-            ssValue >> pwallet->vchDefaultKey;\n+            CPubKey vchPubKey;\n+            ssKey >> vchPubKey;\n+            if (!vchPubKey.IsValid())\n+            {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10952#discussion_r131301415",
      "id" : 131301415,
      "original_commit_id" : "8f3ea174a717cfea2bfd3abcd12b63651cb74c4a",
      "original_position" : 20,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 20,
      "pull_request_review_id" : 54268014,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10952",
      "updated_at" : "2017-08-04T02:38:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/131301415",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   }
]
