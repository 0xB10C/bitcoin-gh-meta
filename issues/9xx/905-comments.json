[
   {
      "body" : "ACK; I really like having unit tests for the coin selection algorithm.",
      "created_at" : "2012-02-28T14:09:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/905#issuecomment-4216347",
      "id" : 4216347,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/905",
      "updated_at" : "2012-02-28T14:09:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/4216347",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/905#discussion_r655273"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/905"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/655273"
         }
      },
      "body" : "The random_shuffle was deleted here, but I don't see any calls to randomize the coins selected.  A random_shuffle of the result of AvailableCoins should probably be done so coin selection is unpredictable.\n\nA unit test to test randomness  that calls SelectCoins two times to get (say) 5 out of 100 coins, all of the same value/age, and fails if exactly the same coins are selected would also be nifty.",
      "commit_id" : "7895e3c2b3eca40f358a69c70a89912b30ace34d",
      "created_at" : "2012-04-06T15:24:23Z",
      "diff_hunk" : "@@ -857,54 +882,32 @@ bool CWallet::SelectCoinsMinConf(int64 nTargetValue, int nConfMine, int nConfThe\n     vector<pair<int64, pair<const CWalletTx*,unsigned int> > > vValue;\n     int64 nTotalLower = 0;\n \n-    CRITICAL_BLOCK(cs_wallet)\n+    BOOST_FOREACH(COutput output, vCoins)\n     {\n-       vector<const CWalletTx*> vCoins;\n-       vCoins.reserve(mapWallet.size());\n-       for (map<uint256, CWalletTx>::const_iterator it = mapWallet.begin(); it != mapWallet.end(); ++it)\n-           vCoins.push_back(&(*it).second);\n-       random_shuffle(vCoins.begin(), vCoins.end(), GetRandInt);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/905#discussion_r655273",
      "id" : 655273,
      "original_commit_id" : "ec0e83664f149193ce42c64d7fd13cd1aa268be8",
      "original_position" : 45,
      "path" : "src/wallet.cpp",
      "position" : 60,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/905",
      "updated_at" : "2012-04-07T19:45:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/655273",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "body" : "@gavinandresen I noticed that the shuffle was missing some time ago.  It has been added back in in #1017 which is my current branch for these changes, and includes the coincontrol and lesschange changes too.\r\n\r\nI'll also add a new unit test for randomness too.\r\n\r\nDo you need this pull request with just the refactoring updated too?  I merged these related changes all together to make them easier to keep up to date.",
      "created_at" : "2012-04-07T16:11:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/905#issuecomment-5009670",
      "id" : 5009670,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/905",
      "updated_at" : "2012-04-07T16:11:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/5009670",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/573356?v=3",
         "events_url" : "https://api.github.com/users/dooglus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dooglus/followers",
         "following_url" : "https://api.github.com/users/dooglus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dooglus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dooglus",
         "id" : 573356,
         "login" : "dooglus",
         "organizations_url" : "https://api.github.com/users/dooglus/orgs",
         "received_events_url" : "https://api.github.com/users/dooglus/received_events",
         "repos_url" : "https://api.github.com/users/dooglus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dooglus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dooglus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dooglus"
      }
   },
   {
      "body" : "Notice that the coins are sorted into order before running the stochastic approximation:\r\n\r\n    // Solve subset sum by stochastic approximation\r\n    sort(vValue.rbegin(), vValue.rend());\r\n\r\nand so the shuffle's work will be undone in the case you propose.  The only times the shuffle has any effect is if:\r\n\r\n  1. there are multiple coins with the exact value requested (e.g. have 1,1,1 and request 1), or\r\n  2. there is no coin with the exact value requested, and the sum of coins smaller than the sum requested is less than the sum requested, and there are a multiple coins of the same value all representing the smallest value that is larger than the sum requested (e.g. have 1,1,1,5,5,6 and request 4; sum of smaller coins = 3 < requested 4; smallest value larger than requested 4 is 5; there are multiple 5 coins).  I'll add tests for both these cases to make sure the shuffle is happening.\r\n\r\nI added your suggested \"4-from-100 identical\" test to check that different random coins were being selected each time.  It ran the test 100 times.  And every time it failed on iterations 49 and 51.  It turns out that this is because rand() is being used in the stochastic approximation code:\r\n\r\n    if (nPass == 0 ? rand() % 2 : !vfIncluded[i])\r\n\r\nand rand() isn't being seeded, so returns the same sequence each time bitcoin is run.  See new bug #1057.\r\n\r\nIf I use GetRandInt(2) instead of rand()%2 then the tests fail occasionally, but randomly.  It turns out that selecting 4 coins from a sorted list of 100 often picks the same 4.  So I'll pick 50 from 100 instead to minimise the chance of a random identical selection.",
      "created_at" : "2012-04-07T17:28:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/905#issuecomment-5010163",
      "id" : 5010163,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/905",
      "updated_at" : "2012-04-07T17:28:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/5010163",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/573356?v=3",
         "events_url" : "https://api.github.com/users/dooglus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dooglus/followers",
         "following_url" : "https://api.github.com/users/dooglus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dooglus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dooglus",
         "id" : 573356,
         "login" : "dooglus",
         "organizations_url" : "https://api.github.com/users/dooglus/orgs",
         "received_events_url" : "https://api.github.com/users/dooglus/received_events",
         "repos_url" : "https://api.github.com/users/dooglus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dooglus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dooglus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dooglus"
      }
   },
   {
      "body" : "I've merged my latest changes to the unit tests from lesschange-v0.6.0 (#1017) back onto this branch.  There are also tests for sub-cent change suggested by Luke here: https://github.com/bitcoin/bitcoin/pull/898#issuecomment-4199968 which didn't get into this branch before.",
      "created_at" : "2012-04-07T18:48:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/905#issuecomment-5010683",
      "id" : 5010683,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/905",
      "updated_at" : "2012-04-07T18:49:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/5010683",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/573356?v=3",
         "events_url" : "https://api.github.com/users/dooglus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dooglus/followers",
         "following_url" : "https://api.github.com/users/dooglus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dooglus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dooglus",
         "id" : 573356,
         "login" : "dooglus",
         "organizations_url" : "https://api.github.com/users/dooglus/orgs",
         "received_events_url" : "https://api.github.com/users/dooglus/received_events",
         "repos_url" : "https://api.github.com/users/dooglus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dooglus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dooglus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dooglus"
      }
   },
   {
      "body" : "Is this superceded or not?",
      "created_at" : "2012-06-12T18:49:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/905#issuecomment-6279094",
      "id" : 6279094,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/905",
      "updated_at" : "2012-06-12T18:49:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/6279094",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Closing; I pulled 1416 which was an updated version.\n",
      "created_at" : "2012-06-14T01:42:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/905#issuecomment-6318602",
      "id" : 6318602,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/905",
      "updated_at" : "2012-06-14T01:42:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/6318602",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   }
]
