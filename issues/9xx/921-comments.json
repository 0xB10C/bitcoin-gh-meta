[
   {
      "body" : "Are you running 0.6 release candidate 1?\r\n\r\nIf you are, please upgrade to release candidate 2.  If you can't upgrade for some reason, you need to run with the -paytoscripthashtime=1333238400  flag to get onto the right blockchain.\r\n",
      "created_at" : "2012-03-08T14:39:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/921#issuecomment-4392262",
      "id" : 4392262,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/921",
      "updated_at" : "2012-03-08T14:39:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/4392262",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "body" : "I was running the latest git HEAD.  It's newer than rc2, and I was also using the ...hashtime flag, having been affected by the blockchain fork earlier in the day.\r\n\r\nThe issue I'm reporting is that the checkmark appears some time before the 99% progress bar disappears, giving conflicting information.  I don't know what is happening in the time between the orange circle changing to a green checkmark and the progress bar disappearing, but it can take several seconds to happen.",
      "created_at" : "2012-03-08T19:49:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/921#issuecomment-4400736",
      "id" : 4400736,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/921",
      "updated_at" : "2012-03-08T19:49:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/4400736",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/949112?v=3",
         "events_url" : "https://api.github.com/users/bitaussie/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bitaussie/followers",
         "following_url" : "https://api.github.com/users/bitaussie/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bitaussie/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bitaussie",
         "id" : 949112,
         "login" : "bitaussie",
         "organizations_url" : "https://api.github.com/users/bitaussie/orgs",
         "received_events_url" : "https://api.github.com/users/bitaussie/received_events",
         "repos_url" : "https://api.github.com/users/bitaussie/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bitaussie/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bitaussie/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bitaussie"
      }
   },
   {
      "body" : "It's still happening in git HEAD and official v0.6.0 release.\r\n\r\nScreenshot:\r\n\r\n![](http://i40.tinypic.com/200po3p.png)\r\n\r\nAnd:\r\n\r\n![](http://i43.tinypic.com/28sprv7.png)",
      "created_at" : "2012-04-13T10:37:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/921#issuecomment-5112222",
      "id" : 5112222,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/921",
      "updated_at" : "2012-04-13T10:41:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/5112222",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/573356?v=3",
         "events_url" : "https://api.github.com/users/dooglus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dooglus/followers",
         "following_url" : "https://api.github.com/users/dooglus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dooglus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dooglus",
         "id" : 573356,
         "login" : "dooglus",
         "organizations_url" : "https://api.github.com/users/dooglus/orgs",
         "received_events_url" : "https://api.github.com/users/dooglus/received_events",
         "repos_url" : "https://api.github.com/users/dooglus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dooglus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dooglus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dooglus"
      }
   },
   {
      "body" : "Perhaps this can be fixed by a small edit in bitcoingui.cpp.\r\n\r\nChange line ~555 from:\r\n\"if(secs < 90*60)\" to \"if(secs < 90*60 && count == nTotalBlocks)\"\r\n\r\nCould you try it?",
      "created_at" : "2012-04-13T10:59:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/921#issuecomment-5112460",
      "id" : 5112460,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/921",
      "updated_at" : "2012-04-13T10:59:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/5112460",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "body" : "I'll try it.  I need to let the blockchain advance with bitcoin-qt shut down so there's something to catch up, so it will take a while.\r\n\r\nYour change looks right though.  The code was previously saying \"if we have a block that's less than 90 minutes old then were up to date\".\r\n\r\nI often see the client gets stuck with 1 or 2 blocks to download; probably due to the mini blockchain forks which keep happening when non BIP-16 clients generate a block that BIP-16 clients won't accept.",
      "created_at" : "2012-04-13T15:27:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/921#issuecomment-5116960",
      "id" : 5116960,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/921",
      "updated_at" : "2012-04-13T15:27:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/5116960",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/573356?v=3",
         "events_url" : "https://api.github.com/users/dooglus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dooglus/followers",
         "following_url" : "https://api.github.com/users/dooglus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dooglus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dooglus",
         "id" : 573356,
         "login" : "dooglus",
         "organizations_url" : "https://api.github.com/users/dooglus/orgs",
         "received_events_url" : "https://api.github.com/users/dooglus/received_events",
         "repos_url" : "https://api.github.com/users/dooglus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dooglus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dooglus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dooglus"
      }
   },
   {
      "body" : "If you say my change works I'll create a small pull-request asap :).",
      "created_at" : "2012-04-13T16:16:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/921#issuecomment-5118062",
      "id" : 5118062,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/921",
      "updated_at" : "2012-04-13T16:16:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/5118062",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "body" : "I tried it.  It works sometimes, but mostly it just leaves the spinning orange circle icon showing.\r\n\r\nIt turns out that typically, count is 175517 and nTotalBlocks is 168000.\r\n\r\nnTotalBlocks is from GetNumBlocksOfPeers() in main.cpp:\r\n  return std::max(cPeerBlockCounts.median(), Checkpoints::GetTotalBlocksEstimate());\r\n\r\nand cPeerBlockCounts has 2 values in it when we check, the initial 0 and 175517 from the first peer we connected to.  The median of these two is 87758 and so max() returns the highest checkpoint: 168000\r\n\r\nI can modify the code to ignore the initial 0 in the vector, but that doesn't help with the other problems:\r\n\r\nEven as new connections come in and fill the (5 slot) cPeerBlockCounts vector, the spinner icon keeps spinning.  It will only be changed when setNumBlocks() is run again, which is only triggered by a numBlocksChanged signal.  This also causes the tooltip on the checkmark to say things like \"last received block was generated 3 minutes ago\" for 10 minutes at a time.  The \"3 minutes ago\" is generated once, and not updated as the newest block ages.\r\n\r\nSometimes when I run bitcoin-qt we have 2 connections before the median is checked, and in that case the green check mark appears correctly because the median of [0, correct, correct] is correct.\r\n\r\nWhen a new block is generated my client gets it pretty quickly, but the vector used to calculate nTotalBlocks is only updated when we first connect to each peer, and so doesn't reflect the new blockchain length:\r\n\r\n    SetBestChain: new best=0000000000000226709b  height=175523  work=292688024487397697436\r\n    block counts: [ 140700 175522 175522 175522 175522 ] median 175522, max 175522\r\n\r\nand so the icon goes back to the orange spinner.",
      "created_at" : "2012-04-13T16:53:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/921#issuecomment-5118854",
      "id" : 5118854,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/921",
      "updated_at" : "2012-04-13T16:53:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/5118854",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/573356?v=3",
         "events_url" : "https://api.github.com/users/dooglus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dooglus/followers",
         "following_url" : "https://api.github.com/users/dooglus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dooglus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dooglus",
         "id" : 573356,
         "login" : "dooglus",
         "organizations_url" : "https://api.github.com/users/dooglus/orgs",
         "received_events_url" : "https://api.github.com/users/dooglus/received_events",
         "repos_url" : "https://api.github.com/users/dooglus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dooglus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dooglus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dooglus"
      }
   },
   {
      "body" : "It should be count >= nTotalBlocks. After the initial block chain download, count will exceed nTotalBlocks.",
      "created_at" : "2012-04-13T18:57:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/921#issuecomment-5122799",
      "id" : 5122799,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/921",
      "updated_at" : "2012-04-13T18:57:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/5122799",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "@laanwj The problem with that is that I often see nTotalBlocks = 168000 (the most recent checkpoint), so your proposed condition is true, and the green check mark is shown incorrectly.  See my comment 2 up from this one for details of why that happens.\r\n\r\nEven if we fix the median code to ignore the 0 value, there's still a problem if the first peer we connect to is still downloading the blockchain.  We'll set nTotalBlocks to the number of blocks that peer has, see that we have more, and so show the green checkmark.",
      "created_at" : "2012-04-13T19:53:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/921#issuecomment-5123768",
      "id" : 5123768,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/921",
      "updated_at" : "2012-04-13T19:54:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/5123768",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/573356?v=3",
         "events_url" : "https://api.github.com/users/dooglus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dooglus/followers",
         "following_url" : "https://api.github.com/users/dooglus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dooglus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dooglus",
         "id" : 573356,
         "login" : "dooglus",
         "organizations_url" : "https://api.github.com/users/dooglus/orgs",
         "received_events_url" : "https://api.github.com/users/dooglus/received_events",
         "repos_url" : "https://api.github.com/users/dooglus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dooglus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dooglus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dooglus"
      }
   },
   {
      "body" : "If that's the solution, you can open the pull-request :). I'm off now, cya!",
      "created_at" : "2012-04-13T19:58:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/921#issuecomment-5123834",
      "id" : 5123834,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/921",
      "updated_at" : "2012-04-13T19:58:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/5123834",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "body" : "@dooglus that's why we should check *both* secs < 90*60 and count >= nTotalBlocks. \r\n\r\nYou complaint was that the progress bar is shown with the green checkmark. The progress bar is only shown when count < nTotalBlocks.\r\n\r\nSo the proposed change will mean they are never shown at the same time.\r\n\r\nWe use the last checkpoint as initial estimation of the total number of blocks, but this will quickly change as soon as some connections are made. That's on purpose, nTotalBlocks is always going to be lagging with the current protocol.\r\n\r\n",
      "created_at" : "2012-04-14T05:24:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/921#issuecomment-5129007",
      "id" : 5129007,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/921",
      "updated_at" : "2012-04-14T05:26:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/5129007",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   }
]
