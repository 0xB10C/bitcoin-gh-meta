[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#22762](https://github.com/bitcoin/bitcoin/pull/22762) (Raise InitError when peers.dat is invalid or corrupted by MarcoFalke)\n* [#22567](https://github.com/bitcoin/bitcoin/pull/22567) (test: Implicitly sync after generate* to preempt races and intermittent test failures by MarcoFalke)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-08-30T00:18:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22831#issuecomment-907908544",
      "id" : 907908544,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22831",
      "node_id" : "IC_kwDOABII5842HZXA",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-10T12:09:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/907908544",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22831#discussion_r698233066"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22831"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/698233066"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The file is .2 MB, so I am wondering if there is a way to generate it with a few lines of python? Can `addpeeraddress` fill the tried table?",
      "commit_id" : "c8a603590697004e2759dbdf971b5f40041342d7",
      "created_at" : "2021-08-30T06:45:27Z",
      "diff_hunk" : "@@ -38,6 +41,10 @@ class AsmapTest(BitcoinTestFramework):\n     def set_test_params(self):\n         self.num_nodes = 1\n \n+    def set_peers_dat(self):\n+        peers_data = os.path.join(os.path.dirname(os.path.realpath(__file__)), 'data/peers.dat')\n+        shutil.copyfile(peers_data, os.path.join(self.datadir, 'peers.dat'))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22831#discussion_r698233066",
      "id" : 698233066,
      "line" : 46,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5ODIzMzA2Ng==",
      "original_commit_id" : "6d9da9bc9695ba262d36d444bffce87e0f2481cc",
      "original_line" : 46,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "test/functional/feature_asmap.py",
      "position" : 18,
      "pull_request_review_id" : 741320625,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22831",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-30T06:45:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/698233066",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22831#discussion_r698235542"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22831"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/698235542"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Didn't immediately see how to add tried entries programmatically but I think the file can be much smaller if concept ack.",
      "commit_id" : "c8a603590697004e2759dbdf971b5f40041342d7",
      "created_at" : "2021-08-30T06:50:22Z",
      "diff_hunk" : "@@ -38,6 +41,10 @@ class AsmapTest(BitcoinTestFramework):\n     def set_test_params(self):\n         self.num_nodes = 1\n \n+    def set_peers_dat(self):\n+        peers_data = os.path.join(os.path.dirname(os.path.realpath(__file__)), 'data/peers.dat')\n+        shutil.copyfile(peers_data, os.path.join(self.datadir, 'peers.dat'))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22831#discussion_r698235542",
      "id" : 698235542,
      "in_reply_to_id" : 698233066,
      "line" : 46,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5ODIzNTU0Mg==",
      "original_commit_id" : "6d9da9bc9695ba262d36d444bffce87e0f2481cc",
      "original_line" : 46,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "test/functional/feature_asmap.py",
      "position" : 18,
      "pull_request_review_id" : 741323656,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22831",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-30T06:50:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/698235542",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22831#discussion_r698262027"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22831"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/698262027"
         }
      },
      "author_association" : "MEMBER",
      "body" : "An alternative is always to add the data to https://github.com/bitcoin-core/qa-assets, which doesn't slow down the main repo clone at all.",
      "commit_id" : "c8a603590697004e2759dbdf971b5f40041342d7",
      "created_at" : "2021-08-30T07:36:54Z",
      "diff_hunk" : "@@ -38,6 +41,10 @@ class AsmapTest(BitcoinTestFramework):\n     def set_test_params(self):\n         self.num_nodes = 1\n \n+    def set_peers_dat(self):\n+        peers_data = os.path.join(os.path.dirname(os.path.realpath(__file__)), 'data/peers.dat')\n+        shutil.copyfile(peers_data, os.path.join(self.datadir, 'peers.dat'))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22831#discussion_r698262027",
      "id" : 698262027,
      "in_reply_to_id" : 698233066,
      "line" : 46,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5ODI2MjAyNw==",
      "original_commit_id" : "6d9da9bc9695ba262d36d444bffce87e0f2481cc",
      "original_line" : 46,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "test/functional/feature_asmap.py",
      "position" : 18,
      "pull_request_review_id" : 741358818,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22831",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-30T07:37:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/698262027",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22831#discussion_r698317771"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22831"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/698317771"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Reduced the `peers.dat` size 20x while still ensuring the test passes/fails\r\n\r\nbefore\r\n```\r\n236 KB\r\nAddrman checks started: new 3157, tried 96, total 3253\r\n```\r\nafter\r\n```\r\n11.9 KB\r\nAddrman checks started: new 95, tried 3, total 98\r\n```\r\n\r\nFiles in `test/functional/data` for me locally\r\n```\r\n$ ls -l test/functional/data\r\n-rw-r--r-- 1 88238 Jun  5 16:07 blockheader_testnet3.hex\r\n-rw-r--r-- 1  8056 Aug 28 23:27 invalid_txs.py\r\n-rw-r--r-- 1 12137 Aug 30 11:12 peers.dat\r\ndrwxr-xr-x 2  4096 Aug 19 14:46 __pycache__\r\n-rw-r--r-- 1  3431 Jun  5 16:07 rpc_bip67.json\r\n-rw-r--r-- 1 57899 Jun  5 16:07 rpc_getblockstats.json\r\n-rw-r--r-- 1 47236 Jun  5 16:07 rpc_psbt.json\r\n```\r\n\r\n",
      "commit_id" : "2fb6933d19007613a25d56f18a767c8d2c6ef2be",
      "created_at" : "2021-08-30T09:01:19Z",
      "diff_hunk" : "@@ -38,6 +41,10 @@ class AsmapTest(BitcoinTestFramework):\n     def set_test_params(self):\n         self.num_nodes = 1\n \n+    def set_peers_dat(self):\n+        peers_data = os.path.join(os.path.dirname(os.path.realpath(__file__)), 'data/peers.dat')\n+        shutil.copyfile(peers_data, os.path.join(self.datadir, 'peers.dat'))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22831#discussion_r698317771",
      "id" : 698317771,
      "in_reply_to_id" : 698233066,
      "line" : 49,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5ODMxNzc3MQ==",
      "original_commit_id" : "6d9da9bc9695ba262d36d444bffce87e0f2481cc",
      "original_line" : 49,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "test/functional/feature_asmap.py",
      "position" : 26,
      "pull_request_review_id" : 741430423,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22831",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-30T09:17:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/698317771",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22831#discussion_r698318885"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22831"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/698318885"
         }
      },
      "author_association" : "MEMBER",
      "body" : "(The new -checkaddrman option and logging is super helpful :)",
      "commit_id" : "2fb6933d19007613a25d56f18a767c8d2c6ef2be",
      "created_at" : "2021-08-30T09:02:58Z",
      "diff_hunk" : "@@ -38,6 +41,10 @@ class AsmapTest(BitcoinTestFramework):\n     def set_test_params(self):\n         self.num_nodes = 1\n \n+    def set_peers_dat(self):\n+        peers_data = os.path.join(os.path.dirname(os.path.realpath(__file__)), 'data/peers.dat')\n+        shutil.copyfile(peers_data, os.path.join(self.datadir, 'peers.dat'))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22831#discussion_r698318885",
      "id" : 698318885,
      "in_reply_to_id" : 698233066,
      "line" : 49,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5ODMxODg4NQ==",
      "original_commit_id" : "6d9da9bc9695ba262d36d444bffce87e0f2481cc",
      "original_line" : 49,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "test/functional/feature_asmap.py",
      "position" : 26,
      "pull_request_review_id" : 741431851,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22831",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-30T09:02:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/698318885",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Re-pushed with a 20x smaller `peers.dat` containing 95 new and 3 tried entries (we need a few entries in the tried table for the asmap/addrman regression test) along with some docs per `git diff c8a6035 792c9c2`.\r\n",
      "created_at" : "2021-08-30T10:44:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22831#issuecomment-908238584",
      "id" : 908238584,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22831",
      "node_id" : "IC_kwDOABII5842Ip74",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-30T10:44:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/908238584",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Maybe still include docs on how to generate the file? (See also https://github.com/bitcoin/bitcoin/pull/16796#pullrequestreview-285574484)\r\nCan be in the commit message or a separate file.",
      "created_at" : "2021-08-30T13:03:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22831#issuecomment-908323916",
      "id" : 908323916,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22831",
      "node_id" : "IC_kwDOABII5842I-xM",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-30T13:03:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/908323916",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Maybe still include docs on how to generate the file? (See also [#16796 (review)](https://github.com/bitcoin/bitcoin/pull/16796#pullrequestreview-285574484))\r\n> Can be in the commit message or a separate file.\r\n\r\nGood idea. Done in the commit message.",
      "created_at" : "2021-08-30T18:41:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22831#issuecomment-908591411",
      "id" : 908591411,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22831",
      "node_id" : "IC_kwDOABII5842KAEz",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-31T07:20:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/908591411",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "concept ACK, thanks for adding tests. I think squashing cf90c5a7d5116468d42a812d5eed93a2ac56a248 & 80dbd9b0f46f2b12a9e6359e1aaf4c706b57f20b would make sense, because the functional test seems like the easiest way to verify the contents of the `peers.dat` file. ",
      "created_at" : "2021-08-31T20:52:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22831#issuecomment-909627569",
      "id" : 909627569,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22831",
      "node_id" : "IC_kwDOABII5842N9Cx",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-31T20:52:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/909627569",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22831#discussion_r701895523"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22831"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/701895523"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why making this assignment twice? The line `node.addrman->m_asmap = asmap;` is literally repeated? I think it could be done afterwards?",
      "commit_id" : "d5070688feb68fac59b076411f1d84131726098e",
      "created_at" : "2021-09-03T13:33:51Z",
      "diff_hunk" : "@@ -1184,10 +1213,12 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n         } else {\n             // Addrman can be in an inconsistent state after failure, reset it\n             node.addrman = std::make_unique<CAddrMan>(/* deterministic */ false, /* consistency_check_ratio */ check_addrman);\n+            node.addrman->m_asmap = asmap;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22831#discussion_r701895523",
      "id" : 701895523,
      "line" : 1216,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMTg5NTUyMw==",
      "original_commit_id" : "0cdfe7fc9040bcecc6cb71c455b386659a8340fa",
      "original_line" : 1216,
      "original_position" : 47,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 47,
      "pull_request_review_id" : 746112693,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22831",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-03T13:33:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/701895523",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22831#discussion_r701896544"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22831"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/701896544"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah, I realized that's the whole point of this commit.",
      "commit_id" : "d5070688feb68fac59b076411f1d84131726098e",
      "created_at" : "2021-09-03T13:35:14Z",
      "diff_hunk" : "@@ -1184,10 +1213,12 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n         } else {\n             // Addrman can be in an inconsistent state after failure, reset it\n             node.addrman = std::make_unique<CAddrMan>(/* deterministic */ false, /* consistency_check_ratio */ check_addrman);\n+            node.addrman->m_asmap = asmap;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22831#discussion_r701896544",
      "id" : 701896544,
      "in_reply_to_id" : 701895523,
      "line" : 1216,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMTg5NjU0NA==",
      "original_commit_id" : "0cdfe7fc9040bcecc6cb71c455b386659a8340fa",
      "original_line" : 1216,
      "original_position" : 47,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 47,
      "pull_request_review_id" : 746114121,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22831",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-03T13:35:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/701896544",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I think squashing [cf90c5a](https://github.com/bitcoin/bitcoin/commit/cf90c5a7d5116468d42a812d5eed93a2ac56a248) & [80dbd9b](https://github.com/bitcoin/bitcoin/commit/80dbd9b0f46f2b12a9e6359e1aaf4c706b57f20b) would make sense, because the functional test seems like the easiest way to verify the contents of the `peers.dat` file.\r\n\r\nThey began as the same commit together, then I realized that it makes more sense for them to be separate:\r\n\r\n- the file addition is a standalone change that can be used for other tests (I have some ideas)\r\n- so that people can find the data file commit easily, see its documentation, how it was generated, maybe generate a new one (more addresses, or with tor v2 peers, etc.), or perhaps to revert it someday if we have a way to call `CAddrMan::MakeTried()` from the tests to move addresses into the tried table or to mock it\r\n- the commit messages are very different\r\n\r\nThe easiest way to test the peers.dat file is to copy it to a datadir, start a node, and run commands on it like `-addrinfo`, `getnodeaddresses`, etc. Edit: added \"how to test\" info to the commit message.",
      "created_at" : "2021-09-03T15:08:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22831#issuecomment-912608978",
      "id" : 912608978,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22831",
      "node_id" : "IC_kwDOABII5842ZU7S",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-10T14:04:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/912608978",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-09-06T10:57:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22831#issuecomment-913554583",
      "id" : 913554583,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22831",
      "node_id" : "IC_kwDOABII5842c7yX",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-06T10:57:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/913554583",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased, improved the commit messages, added additional test coverage, and renamed the test file to `feature_addrman_asmap.py`. Updated the PR title and description.",
      "created_at" : "2021-09-06T12:42:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22831#issuecomment-913619889",
      "id" : 913619889,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22831",
      "node_id" : "IC_kwDOABII5842dLux",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-06T12:44:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/913619889",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-09-08T07:52:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22831#issuecomment-915004722",
      "id" : 915004722,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22831",
      "node_id" : "IC_kwDOABII5842id0y",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-08T07:52:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/915004722",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased and merged the addrman and asmap tests into one test file.",
      "created_at" : "2021-09-08T15:11:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22831#issuecomment-915326635",
      "id" : 915326635,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22831",
      "node_id" : "IC_kwDOABII5842jsar",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-08T15:11:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/915326635",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22831#discussion_r704550576"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22831"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/704550576"
         }
      },
      "author_association" : "MEMBER",
      "body" : "An alternative to adding a binary file would be to hack something together with the `serialize_addrman` function in this file",
      "commit_id" : "4cda5cf42118bcaf15ea3951d5189af8db6aa365",
      "created_at" : "2021-09-08T15:48:01Z",
      "diff_hunk" : "@@ -0,0 +1,184 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020-2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test addrman/checkaddrman/asmap functionality.\"\"\"\n+\n+import os\n+import shutil\n+import struct\n+\n+from test_framework.messages import ser_uint256, hash256\n+from test_framework.p2p import MAGIC_BYTES\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+\n+DEFAULT_ASMAP_FILENAME = \"ip_asn.map\"  # defined in src/init.cpp\n+ASMAP = \"../../src/test/data/asmap.raw\"  # path to unit test skeleton asmap\n+VERSION = \"fec61fa21a9f46f3b17bdcd660d7f4cd90b966aad3aec593c99b35f0aca15853\"\n+\n+\n+def expected_messages(filename):\n+    return [\n+        f'Opened asmap file \"{filename}\" (59 bytes) from disk',\n+        f\"Using asmap version {VERSION} for IP bucketing\",\n+    ]\n+\n+\n+def serialize_addrman(*, format=1, lowest_compatible=3):\n+    new = []\n+    tried = []\n+    INCOMPATIBILITY_BASE = 32\n+    r = MAGIC_BYTES[\"regtest\"]\n+    r += struct.pack(\"B\", format)\n+    r += struct.pack(\"B\", INCOMPATIBILITY_BASE + lowest_compatible)\n+    r += ser_uint256(1)\n+    r += struct.pack(\"i\", len(new))\n+    r += struct.pack(\"i\", len(tried))\n+    ADDRMAN_NEW_BUCKET_COUNT = 1 << 10\n+    r += struct.pack(\"i\", ADDRMAN_NEW_BUCKET_COUNT ^ (1 << 30))\n+    for _ in range(ADDRMAN_NEW_BUCKET_COUNT):\n+        r += struct.pack(\"i\", 0)\n+    checksum = hash256(r)\n+    r += checksum\n+    return r\n+\n+\n+def write_addrman(peers_dat, **kwargs):\n+    with open(peers_dat, \"wb\") as f:\n+        f.write(serialize_addrman(**kwargs))\n+\n+\n+class AddrmanAsmapTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+\n+    def set_peers_dat(self):\n+        \"\"\"Copy a peers.dat containing tried table entries into the data directory.\"\"\"\n+        peers_data = os.path.join(os.path.dirname(os.path.realpath(__file__)), \"data/peers.dat\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22831#discussion_r704550576",
      "id" : 704550576,
      "line" : 59,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNDU1MDU3Ng==",
      "original_commit_id" : "4cda5cf42118bcaf15ea3951d5189af8db6aa365",
      "original_line" : 59,
      "original_position" : 59,
      "original_start_line" : null,
      "path" : "test/functional/feature_addrman_asmap.py",
      "position" : 59,
      "pull_request_review_id" : 749323336,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22831",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-08T15:48:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/704550576",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22831#discussion_r705086054"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22831"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/705086054"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I agree, it would be a logical next step if this is merged but this can do the job for now.\r\n\r\n(For now I think it's fundamental to have these regression tests in place quickly, given the number of recent bugs that escaped review, the reproducible criticality of the last bug that this adds a test for, and the addrman/asmap refactoring taking place.)",
      "commit_id" : "b549fc53a35759876e416751c0093aa6205b6b48",
      "created_at" : "2021-09-09T08:01:33Z",
      "diff_hunk" : "@@ -0,0 +1,184 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020-2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test addrman/checkaddrman/asmap functionality.\"\"\"\n+\n+import os\n+import shutil\n+import struct\n+\n+from test_framework.messages import ser_uint256, hash256\n+from test_framework.p2p import MAGIC_BYTES\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+\n+DEFAULT_ASMAP_FILENAME = \"ip_asn.map\"  # defined in src/init.cpp\n+ASMAP = \"../../src/test/data/asmap.raw\"  # path to unit test skeleton asmap\n+VERSION = \"fec61fa21a9f46f3b17bdcd660d7f4cd90b966aad3aec593c99b35f0aca15853\"\n+\n+\n+def expected_messages(filename):\n+    return [\n+        f'Opened asmap file \"{filename}\" (59 bytes) from disk',\n+        f\"Using asmap version {VERSION} for IP bucketing\",\n+    ]\n+\n+\n+def serialize_addrman(*, format=1, lowest_compatible=3):\n+    new = []\n+    tried = []\n+    INCOMPATIBILITY_BASE = 32\n+    r = MAGIC_BYTES[\"regtest\"]\n+    r += struct.pack(\"B\", format)\n+    r += struct.pack(\"B\", INCOMPATIBILITY_BASE + lowest_compatible)\n+    r += ser_uint256(1)\n+    r += struct.pack(\"i\", len(new))\n+    r += struct.pack(\"i\", len(tried))\n+    ADDRMAN_NEW_BUCKET_COUNT = 1 << 10\n+    r += struct.pack(\"i\", ADDRMAN_NEW_BUCKET_COUNT ^ (1 << 30))\n+    for _ in range(ADDRMAN_NEW_BUCKET_COUNT):\n+        r += struct.pack(\"i\", 0)\n+    checksum = hash256(r)\n+    r += checksum\n+    return r\n+\n+\n+def write_addrman(peers_dat, **kwargs):\n+    with open(peers_dat, \"wb\") as f:\n+        f.write(serialize_addrman(**kwargs))\n+\n+\n+class AddrmanAsmapTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+\n+    def set_peers_dat(self):\n+        \"\"\"Copy a peers.dat containing tried table entries into the data directory.\"\"\"\n+        peers_data = os.path.join(os.path.dirname(os.path.realpath(__file__)), \"data/peers.dat\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22831#discussion_r705086054",
      "id" : 705086054,
      "in_reply_to_id" : 704550576,
      "line" : 59,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNTA4NjA1NA==",
      "original_commit_id" : "4cda5cf42118bcaf15ea3951d5189af8db6aa365",
      "original_line" : 59,
      "original_position" : 59,
      "original_start_line" : null,
      "path" : "test/functional/feature_addrman_asmap.py",
      "position" : 59,
      "pull_request_review_id" : 750010565,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22831",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-09T08:01:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/705086054",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Sorry, needs rebase again. Maybe split out the merge of the two files into a separate pull, or at least the first commit? Review of the later commits will be easier after getting the full picture first.",
      "created_at" : "2021-09-10T09:45:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22831#issuecomment-916776358",
      "id" : 916776358,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22831",
      "node_id" : "IC_kwDOABII5842pOWm",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-10T09:45:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/916776358",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-09-10T10:03:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22831#issuecomment-916786907",
      "id" : 916786907,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22831",
      "node_id" : "IC_kwDOABII5842pQ7b",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-10T10:03:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/916786907",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Sorry, needs rebase again.\n\nIt's all good, this was the merge order that made sense to me.",
      "created_at" : "2021-09-10T10:37:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22831#issuecomment-916806485",
      "id" : 916806485,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22831",
      "node_id" : "IC_kwDOABII5842pVtV",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-10T10:37:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/916806485",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22831#discussion_r706154132"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22831"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706154132"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm not sure mentioning initialization order here is needed/wanted, as `-checkaddrman` is just a generic check for corruption. I also don't think we should leak implementation details like `CAddrman::Check()`. Naming the function doesn't add value, and it's the kind of thing that just becomes outdated / needs changing again in a change like #22872.",
      "commit_id" : "b549fc53a35759876e416751c0093aa6205b6b48",
      "created_at" : "2021-09-10T12:50:20Z",
      "diff_hunk" : "@@ -12,7 +12,10 @@\n \n 3. `bitcoind -asmap=<relative path>`, using the unit test skeleton asmap\n \n-4. `bitcoind -asmap/-asmap=` with no file specified, using the default asmap\n+4. `bitcoind -asmap/-asmap=` with no file specified, using the default asmap,\n+    combined with `-checkaddrman=1` as a regression test to ensure the correct\n+    order of asmap/addrman initialization on bitcoind startup, failing which\n+    the addrman tried table became corrupted and CAddrman::Check() aborted.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22831#discussion_r706154132",
      "id" : 706154132,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNjE1NDEzMg==",
      "original_commit_id" : "916d54ac4569a9d462c40224724bf6027c349963",
      "original_line" : 18,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "test/functional/feature_asmap.py",
      "position" : null,
      "pull_request_review_id" : 751374672,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22831",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-10T13:19:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706154132",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22831#discussion_r706167603"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22831"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706167603"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 0ab75d87b7ff1cb6ebb69ffe68342b88403230b9: This commit is confusing because it adds an addrman test to `feature_asmap.py`, which from what I can see is basically the same test that is [already in feature_addrman.py](https://github.com/bitcoin/bitcoin/blob/053a5fc7d912d597cd6dc7376b479420d1eae1c0/test/functional/feature_addrman.py#L82), with the addition of `-checkaddrman`, so isn't actually asmap specific? Later in this PR the two files get merged together, so either this new version or the existing version essentially gets deleted. Why not just add `-checkaddrman` to the existing test after the merge, rather than another commit which is essentially duplicate code.",
      "commit_id" : "b549fc53a35759876e416751c0093aa6205b6b48",
      "created_at" : "2021-09-10T13:09:31Z",
      "diff_hunk" : "@@ -98,6 +100,14 @@ def test_empty_asmap(self):\n         self.node.assert_start_raises_init_error(extra_args=['-asmap'], expected_msg=msg)\n         os.remove(self.default_asmap)\n \n+    def test_missing_peers_dat_with_addrman_checks(self):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22831#discussion_r706167603",
      "id" : 706167603,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNjE2NzYwMw==",
      "original_commit_id" : "0ab75d87b7ff1cb6ebb69ffe68342b88403230b9",
      "original_line" : 103,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "test/functional/feature_asmap.py",
      "position" : null,
      "pull_request_review_id" : 751374672,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22831",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-10T13:19:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706167603",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : ">> Rebased and merged the addrman and asmap tests into one test file.\r\n\r\n> Why? We are actively untangling addrman and asmap functionality, so I'm not sure why it now makes sense to combine the addrman and asmap functional tests into one place. This seems like the opposite of what we should be doing. cc @jnewbery.\r\n\r\nI agree. The main benefit of modularizing our components is the ability to then test them in isolation.",
      "created_at" : "2021-09-10T13:24:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22831#issuecomment-916902316",
      "id" : 916902316,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22831",
      "node_id" : "IC_kwDOABII5842ptGs",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-10T13:24:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/916902316",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22831#discussion_r706184008"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22831"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706184008"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This commit was earlier.\r\n\r\nThe goal was to have minimum regression tests in place before the fix, or all the refactoring, or at least as soon as possible, to reduce the chance of accidentally adding more critical bugs.\r\n\r\nI'm trying to catch up to a moving target and may slim this back down to just the first regression test.",
      "commit_id" : "b549fc53a35759876e416751c0093aa6205b6b48",
      "created_at" : "2021-09-10T13:31:27Z",
      "diff_hunk" : "@@ -98,6 +100,14 @@ def test_empty_asmap(self):\n         self.node.assert_start_raises_init_error(extra_args=['-asmap'], expected_msg=msg)\n         os.remove(self.default_asmap)\n \n+    def test_missing_peers_dat_with_addrman_checks(self):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22831#discussion_r706184008",
      "id" : 706184008,
      "in_reply_to_id" : 706167603,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNjE4NDAwOA==",
      "original_commit_id" : "0ab75d87b7ff1cb6ebb69ffe68342b88403230b9",
      "original_line" : 103,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "test/functional/feature_asmap.py",
      "position" : null,
      "pull_request_review_id" : 751414503,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22831",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-10T13:31:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706184008",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> > > Rebased and merged the addrman and asmap tests into one test file.\r\n> \r\n> > Why? We are actively untangling addrman and asmap functionality, so I'm not sure why it now makes sense to combine the addrman and asmap functional tests into one place. This seems like the opposite of what we should be doing. cc @jnewbery.\r\n> \r\n> I agree. The main benefit of modularizing our components is the ability to then test them in isolation.\r\n\r\nThe untested interaction between addrman and asmap was the source of (one of the) most critical bugs we've seen in a good while, so it makes sense to test that interaction -- at least during the refactoring.  The two files don't have to be consolidated, but they do have a lot in common--including mocking an addrman, which could be the first step to not needing a `peers.dat` test file. It's also quicker and easier to manually run one test file than two on these refactorings, and at the moment I have to cherry-pick these tests onto each addrman/asmap PR branch.",
      "created_at" : "2021-09-10T13:34:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22831#issuecomment-916908896",
      "id" : 916908896,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22831",
      "node_id" : "IC_kwDOABII5842putg",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-10T13:49:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/916908896",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22831#discussion_r706190957"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22831"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706190957"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I agree, and all this is removed in the commit that consolidates the tests.",
      "commit_id" : "b549fc53a35759876e416751c0093aa6205b6b48",
      "created_at" : "2021-09-10T13:40:37Z",
      "diff_hunk" : "@@ -12,7 +12,10 @@\n \n 3. `bitcoind -asmap=<relative path>`, using the unit test skeleton asmap\n \n-4. `bitcoind -asmap/-asmap=` with no file specified, using the default asmap\n+4. `bitcoind -asmap/-asmap=` with no file specified, using the default asmap,\n+    combined with `-checkaddrman=1` as a regression test to ensure the correct\n+    order of asmap/addrman initialization on bitcoind startup, failing which\n+    the addrman tried table became corrupted and CAddrman::Check() aborted.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22831#discussion_r706190957",
      "id" : 706190957,
      "in_reply_to_id" : 706154132,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNjE5MDk1Nw==",
      "original_commit_id" : "916d54ac4569a9d462c40224724bf6027c349963",
      "original_line" : 18,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "test/functional/feature_asmap.py",
      "position" : null,
      "pull_request_review_id" : 751423973,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22831",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-10T13:40:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706190957",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "If people don't like merging the two files, but you need access to addrman mocking, one solution would be to import the `write_addrman` helper into the asmap test.",
      "created_at" : "2021-09-10T13:48:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22831#issuecomment-916918240",
      "id" : 916918240,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22831",
      "node_id" : "IC_kwDOABII5842pw_g",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-10T13:48:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/916918240",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK - I'm surprised and disconcerted that some minimal version of this wasn't packaged with #22791, which would've allowed unambiguous demonstration of the fix.",
      "created_at" : "2021-09-10T14:27:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22831#issuecomment-916947058",
      "id" : 916947058,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22831",
      "node_id" : "IC_kwDOABII5842p4By",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-10T14:27:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/916947058",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22831#discussion_r706229663"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22831"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706229663"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done, slimmed down the doc.\r\n\r\n```diff\r\n 4. `bitcoind -asmap/-asmap=` with no file specified, using the default asmap\r\n+    combined with `-checkaddrman=1`\r\n```\r\n",
      "commit_id" : "22a17be0b9b56e0b35cfc5d1376e51b1e6dc0ed6",
      "created_at" : "2021-09-10T14:29:49Z",
      "diff_hunk" : "@@ -12,7 +12,10 @@\n \n 3. `bitcoind -asmap=<relative path>`, using the unit test skeleton asmap\n \n-4. `bitcoind -asmap/-asmap=` with no file specified, using the default asmap\n+4. `bitcoind -asmap/-asmap=` with no file specified, using the default asmap,\n+    combined with `-checkaddrman=1` as a regression test to ensure the correct\n+    order of asmap/addrman initialization on bitcoind startup, failing which\n+    the addrman tried table became corrupted and CAddrman::Check() aborted.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22831#discussion_r706229663",
      "id" : 706229663,
      "in_reply_to_id" : 706154132,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNjIyOTY2Mw==",
      "original_commit_id" : "916d54ac4569a9d462c40224724bf6027c349963",
      "original_line" : 18,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "test/functional/feature_asmap.py",
      "position" : null,
      "pull_request_review_id" : 751476541,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22831",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-10T14:29:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706229663",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22831#discussion_r706229906"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22831"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706229906"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Dropped",
      "commit_id" : "22a17be0b9b56e0b35cfc5d1376e51b1e6dc0ed6",
      "created_at" : "2021-09-10T14:30:04Z",
      "diff_hunk" : "@@ -98,6 +100,14 @@ def test_empty_asmap(self):\n         self.node.assert_start_raises_init_error(extra_args=['-asmap'], expected_msg=msg)\n         os.remove(self.default_asmap)\n \n+    def test_missing_peers_dat_with_addrman_checks(self):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22831#discussion_r706229906",
      "id" : 706229906,
      "in_reply_to_id" : 706167603,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNjIyOTkwNg==",
      "original_commit_id" : "0ab75d87b7ff1cb6ebb69ffe68342b88403230b9",
      "original_line" : 103,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "test/functional/feature_asmap.py",
      "position" : null,
      "pull_request_review_id" : 751476834,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22831",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-10T14:30:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706229906",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Concept ACK - I'm surprised and disconcerted that some minimal version of this wasn't packaged with #22791, which would've allowed unambiguous demonstration of the fix.\r\n\r\nI agree. Writing a regression test is the first step to take after finding and reproducing a severe bug.\r\n\r\nSlimmed this pull down to the original two commits that focus on regression test coverage for the issue. The additional addrman test coverage can be done in a follow-up.\r\n\r\nPer the PR description:\r\n\r\nHow to reproduce the bug\r\n- `git checkout 181a1207`, build, and launch bitcoind with the `-asmap` and `-checkaddrman=1` configuration options enabled\r\n- restart bitcoind\r\n- bitcoind aborts on the second call to the addrman consistency checks in `CAddrMan::Check()`\r\n\r\nHow to test the test\r\n- `git checkout 181a1207`, build, and run `test/functional/feature_asmap.py`. Output:\r\n\r\n```\r\nAssertionError: Unexpected stderr bitcoind: ./addrman.h:739: void CAddrMan::Check() const: Assertion `false' failed.\r\n```",
      "created_at" : "2021-09-10T14:36:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22831#issuecomment-916953660",
      "id" : 916953660,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22831",
      "node_id" : "IC_kwDOABII5842p5o8",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-10T15:25:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/916953660",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22831#discussion_r706261953"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22831"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706261953"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Obviously not a blocker, but if the file is removed after this is merged, then it would be better to not commit it in the first place and use `serialize_addrman` (or similar) from the beginning.",
      "commit_id" : "22a17be0b9b56e0b35cfc5d1376e51b1e6dc0ed6",
      "created_at" : "2021-09-10T15:10:57Z",
      "diff_hunk" : "@@ -0,0 +1,184 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020-2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test addrman/checkaddrman/asmap functionality.\"\"\"\n+\n+import os\n+import shutil\n+import struct\n+\n+from test_framework.messages import ser_uint256, hash256\n+from test_framework.p2p import MAGIC_BYTES\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+\n+DEFAULT_ASMAP_FILENAME = \"ip_asn.map\"  # defined in src/init.cpp\n+ASMAP = \"../../src/test/data/asmap.raw\"  # path to unit test skeleton asmap\n+VERSION = \"fec61fa21a9f46f3b17bdcd660d7f4cd90b966aad3aec593c99b35f0aca15853\"\n+\n+\n+def expected_messages(filename):\n+    return [\n+        f'Opened asmap file \"{filename}\" (59 bytes) from disk',\n+        f\"Using asmap version {VERSION} for IP bucketing\",\n+    ]\n+\n+\n+def serialize_addrman(*, format=1, lowest_compatible=3):\n+    new = []\n+    tried = []\n+    INCOMPATIBILITY_BASE = 32\n+    r = MAGIC_BYTES[\"regtest\"]\n+    r += struct.pack(\"B\", format)\n+    r += struct.pack(\"B\", INCOMPATIBILITY_BASE + lowest_compatible)\n+    r += ser_uint256(1)\n+    r += struct.pack(\"i\", len(new))\n+    r += struct.pack(\"i\", len(tried))\n+    ADDRMAN_NEW_BUCKET_COUNT = 1 << 10\n+    r += struct.pack(\"i\", ADDRMAN_NEW_BUCKET_COUNT ^ (1 << 30))\n+    for _ in range(ADDRMAN_NEW_BUCKET_COUNT):\n+        r += struct.pack(\"i\", 0)\n+    checksum = hash256(r)\n+    r += checksum\n+    return r\n+\n+\n+def write_addrman(peers_dat, **kwargs):\n+    with open(peers_dat, \"wb\") as f:\n+        f.write(serialize_addrman(**kwargs))\n+\n+\n+class AddrmanAsmapTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+\n+    def set_peers_dat(self):\n+        \"\"\"Copy a peers.dat containing tried table entries into the data directory.\"\"\"\n+        peers_data = os.path.join(os.path.dirname(os.path.realpath(__file__)), \"data/peers.dat\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22831#discussion_r706261953",
      "id" : 706261953,
      "in_reply_to_id" : 704550576,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNjI2MTk1Mw==",
      "original_commit_id" : "4cda5cf42118bcaf15ea3951d5189af8db6aa365",
      "original_line" : 59,
      "original_position" : 59,
      "original_start_line" : null,
      "path" : "test/functional/feature_addrman_asmap.py",
      "position" : null,
      "pull_request_review_id" : 751520000,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22831",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-10T15:10:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706261953",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22831#discussion_r706272259"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22831"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706272259"
         }
      },
      "author_association" : "MEMBER",
      "body" : "+1 to approach of `serialize_addrman` function.",
      "commit_id" : "22a17be0b9b56e0b35cfc5d1376e51b1e6dc0ed6",
      "created_at" : "2021-09-10T15:24:42Z",
      "diff_hunk" : "@@ -0,0 +1,184 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020-2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test addrman/checkaddrman/asmap functionality.\"\"\"\n+\n+import os\n+import shutil\n+import struct\n+\n+from test_framework.messages import ser_uint256, hash256\n+from test_framework.p2p import MAGIC_BYTES\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+\n+DEFAULT_ASMAP_FILENAME = \"ip_asn.map\"  # defined in src/init.cpp\n+ASMAP = \"../../src/test/data/asmap.raw\"  # path to unit test skeleton asmap\n+VERSION = \"fec61fa21a9f46f3b17bdcd660d7f4cd90b966aad3aec593c99b35f0aca15853\"\n+\n+\n+def expected_messages(filename):\n+    return [\n+        f'Opened asmap file \"{filename}\" (59 bytes) from disk',\n+        f\"Using asmap version {VERSION} for IP bucketing\",\n+    ]\n+\n+\n+def serialize_addrman(*, format=1, lowest_compatible=3):\n+    new = []\n+    tried = []\n+    INCOMPATIBILITY_BASE = 32\n+    r = MAGIC_BYTES[\"regtest\"]\n+    r += struct.pack(\"B\", format)\n+    r += struct.pack(\"B\", INCOMPATIBILITY_BASE + lowest_compatible)\n+    r += ser_uint256(1)\n+    r += struct.pack(\"i\", len(new))\n+    r += struct.pack(\"i\", len(tried))\n+    ADDRMAN_NEW_BUCKET_COUNT = 1 << 10\n+    r += struct.pack(\"i\", ADDRMAN_NEW_BUCKET_COUNT ^ (1 << 30))\n+    for _ in range(ADDRMAN_NEW_BUCKET_COUNT):\n+        r += struct.pack(\"i\", 0)\n+    checksum = hash256(r)\n+    r += checksum\n+    return r\n+\n+\n+def write_addrman(peers_dat, **kwargs):\n+    with open(peers_dat, \"wb\") as f:\n+        f.write(serialize_addrman(**kwargs))\n+\n+\n+class AddrmanAsmapTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+\n+    def set_peers_dat(self):\n+        \"\"\"Copy a peers.dat containing tried table entries into the data directory.\"\"\"\n+        peers_data = os.path.join(os.path.dirname(os.path.realpath(__file__)), \"data/peers.dat\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22831#discussion_r706272259",
      "id" : 706272259,
      "in_reply_to_id" : 704550576,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNjI3MjI1OQ==",
      "original_commit_id" : "4cda5cf42118bcaf15ea3951d5189af8db6aa365",
      "original_line" : 59,
      "original_position" : 59,
      "original_start_line" : null,
      "path" : "test/functional/feature_addrman_asmap.py",
      "position" : null,
      "pull_request_review_id" : 751533679,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22831",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-10T15:24:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706272259",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22831#discussion_r706283142"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22831"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706283142"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Happy to look at it as a follow-up (or leave it for someone), but this does the job and by common sense ought to have been the first step in a responsible fix (or at least part of it), rather than ignored after https://github.com/bitcoin/bitcoin/pull/22791#issuecomment-907856179 while embarking on many refactoring and changes, no matter how desirable they may have been. Foot-dragging and bikeshedding doesn't seem appropriate here compared to the gravity of the bug that is covered.",
      "commit_id" : "22a17be0b9b56e0b35cfc5d1376e51b1e6dc0ed6",
      "created_at" : "2021-09-10T15:39:27Z",
      "diff_hunk" : "@@ -0,0 +1,184 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020-2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test addrman/checkaddrman/asmap functionality.\"\"\"\n+\n+import os\n+import shutil\n+import struct\n+\n+from test_framework.messages import ser_uint256, hash256\n+from test_framework.p2p import MAGIC_BYTES\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+\n+DEFAULT_ASMAP_FILENAME = \"ip_asn.map\"  # defined in src/init.cpp\n+ASMAP = \"../../src/test/data/asmap.raw\"  # path to unit test skeleton asmap\n+VERSION = \"fec61fa21a9f46f3b17bdcd660d7f4cd90b966aad3aec593c99b35f0aca15853\"\n+\n+\n+def expected_messages(filename):\n+    return [\n+        f'Opened asmap file \"{filename}\" (59 bytes) from disk',\n+        f\"Using asmap version {VERSION} for IP bucketing\",\n+    ]\n+\n+\n+def serialize_addrman(*, format=1, lowest_compatible=3):\n+    new = []\n+    tried = []\n+    INCOMPATIBILITY_BASE = 32\n+    r = MAGIC_BYTES[\"regtest\"]\n+    r += struct.pack(\"B\", format)\n+    r += struct.pack(\"B\", INCOMPATIBILITY_BASE + lowest_compatible)\n+    r += ser_uint256(1)\n+    r += struct.pack(\"i\", len(new))\n+    r += struct.pack(\"i\", len(tried))\n+    ADDRMAN_NEW_BUCKET_COUNT = 1 << 10\n+    r += struct.pack(\"i\", ADDRMAN_NEW_BUCKET_COUNT ^ (1 << 30))\n+    for _ in range(ADDRMAN_NEW_BUCKET_COUNT):\n+        r += struct.pack(\"i\", 0)\n+    checksum = hash256(r)\n+    r += checksum\n+    return r\n+\n+\n+def write_addrman(peers_dat, **kwargs):\n+    with open(peers_dat, \"wb\") as f:\n+        f.write(serialize_addrman(**kwargs))\n+\n+\n+class AddrmanAsmapTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+\n+    def set_peers_dat(self):\n+        \"\"\"Copy a peers.dat containing tried table entries into the data directory.\"\"\"\n+        peers_data = os.path.join(os.path.dirname(os.path.realpath(__file__)), \"data/peers.dat\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22831#discussion_r706283142",
      "id" : 706283142,
      "in_reply_to_id" : 704550576,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNjI4MzE0Mg==",
      "original_commit_id" : "4cda5cf42118bcaf15ea3951d5189af8db6aa365",
      "original_line" : 59,
      "original_position" : 59,
      "original_start_line" : null,
      "path" : "test/functional/feature_addrman_asmap.py",
      "position" : null,
      "pull_request_review_id" : 751547894,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22831",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-10T15:39:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706283142",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   }
]
