[
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK, I think this makes onlynet closer to what users expect, clearing up all kind of exceptions that have to be documented. Thanks!",
      "created_at" : "2021-08-30T13:20:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22834#issuecomment-908337743",
      "id" : 908337743,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22834",
      "node_id" : "IC_kwDOABII5842JCJP",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-30T13:21:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/908337743",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "With this PR, one could use for example `-onlynet=ipv6 -onion=127.0.0.1:9050` and Bitcoin Core will not automatically connect to `.onion` hosts. However one could later use the `addnode` RPC to manually connect to an `.onion` host. This matches the current behavior in `master` wrt other networks, e.g. `-onlynet=ipv6` and later `addnode` to an ipv4 host.",
      "created_at" : "2021-08-30T14:35:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22834#issuecomment-908396174",
      "id" : 908396174,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22834",
      "node_id" : "IC_kwDOABII5842JQaO",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-30T14:35:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/908396174",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22834#discussion_r698592051"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/698592051"
         }
      },
      "author_association" : "MEMBER",
      "body" : "(Initial drive-by review.) Every onlynet question I've received has been about using -onlynet=onion, -onlynet=i2p, or both together, so it may be reasonable to address what node operators seem most interested in and minimize confusion, by using the hidden networks for the onlynet examples in both `doc/tor.md` and `doc/i2p.md` (unless you use all of them in the examples to illustrate that it is possible, which is what I did in #22648, but no strong opinion on whether that is helpful)\r\n```suggestion\r\n                    onlynet=onion, onlynet=i2p.\r\n```",
      "commit_id" : "7b821b9d4c5e60ae3b79d2ee9c398852c850fc0d",
      "created_at" : "2021-08-30T15:35:17Z",
      "diff_hunk" : "@@ -57,11 +57,7 @@ outgoing connections, but more is possible.\n     -onlynet=onion  Make outgoing connections only to .onion addresses. Incoming\n                     connections are not affected by this option. This option can be\n                     specified multiple times to allow multiple network types, e.g.\n-                    onlynet=ipv4, onlynet=ipv6, onlynet=onion, onlynet=i2p.\n-                    Warning: if you use -onlynet with values other than onion, and\n-                    the -onion or -proxy option is set, then outgoing onion\n-                    connections will still be made; use -noonion or -onion=0 to\n-                    disable outbound onion connections in this case.\n+                    onlynet=ipv6, onlynet=onion.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22834#discussion_r698592051",
      "id" : 698592051,
      "line" : 60,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5ODU5MjA1MQ==",
      "original_commit_id" : "7b821b9d4c5e60ae3b79d2ee9c398852c850fc0d",
      "original_line" : 60,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "doc/tor.md",
      "position" : 9,
      "pull_request_review_id" : 741788733,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22834",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-30T15:47:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/698592051",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22834#discussion_r698600479"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/698600479"
         }
      },
      "author_association" : "MEMBER",
      "body" : "naming nit, `onlynet` or maybe `onlynet_str` might be a clearer iterator name for `onlynets`, and `net` is often used for passing a `Network` enum, e.g. in `src/net.h::IsReachable()` and `SetReachable()`)\r\n```suggestion\r\n    return std::any_of(onlynets.begin(), onlynets.end(), [&addr](const auto& onlynet) {\r\n```",
      "commit_id" : "7b821b9d4c5e60ae3b79d2ee9c398852c850fc0d",
      "created_at" : "2021-08-30T15:46:28Z",
      "diff_hunk" : "@@ -113,6 +113,22 @@ std::map<CNetAddr, LocalServiceInfo> mapLocalHost GUARDED_BY(cs_mapLocalHost);\n static bool vfLimited[NET_MAX] GUARDED_BY(cs_mapLocalHost) = {};\n std::string strSubVersion;\n \n+/**\n+ * Check if making an automatic outbound connection to the given address is allowed.\n+ * Could be restricted by the `-onlynet` configuration option.\n+ * @return true if allowed\n+ */\n+static bool OutboundConnectionAllowedTo(const CNetAddr& addr)\n+{\n+    if (!gArgs.IsArgSet(\"-onlynet\")) {\n+        return true;\n+    }\n+    const auto onlynets = gArgs.GetArgs(\"-onlynet\");\n+    return std::any_of(onlynets.begin(), onlynets.end(), [&addr](const auto& net) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22834#discussion_r698600479",
      "id" : 698600479,
      "line" : 127,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5ODYwMDQ3OQ==",
      "original_commit_id" : "7b821b9d4c5e60ae3b79d2ee9c398852c850fc0d",
      "original_line" : 127,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 15,
      "pull_request_review_id" : 741788733,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22834",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-30T15:47:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/698600479",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "(Feel free to ignore my comments until you re-push.) \r\n\r\nDo you plan to add functional tests like in #22651?",
      "created_at" : "2021-08-30T15:51:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22834#issuecomment-908457560",
      "id" : 908457560,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22834",
      "node_id" : "IC_kwDOABII5842JfZY",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-30T15:51:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/908457560",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#22766](https://github.com/bitcoin/bitcoin/pull/22766) (refactor: Clarify and disable unused ArgsManager flags by ryanofsky)\n* [#16545](https://github.com/bitcoin/bitcoin/pull/16545) (refactor: Implement missing error checking for ArgsManager flags by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-08-30T22:34:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22834#issuecomment-908750635",
      "id" : 908750635,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22834",
      "node_id" : "IC_kwDOABII5842Km8r",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-30T22:34:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/908750635",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22834#discussion_r699293514"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/699293514"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ok, I will update this as per above. I changed it because it was using onlynet with all possible networks which looked strange to me.",
      "commit_id" : "7b821b9d4c5e60ae3b79d2ee9c398852c850fc0d",
      "created_at" : "2021-08-31T12:53:58Z",
      "diff_hunk" : "@@ -57,11 +57,7 @@ outgoing connections, but more is possible.\n     -onlynet=onion  Make outgoing connections only to .onion addresses. Incoming\n                     connections are not affected by this option. This option can be\n                     specified multiple times to allow multiple network types, e.g.\n-                    onlynet=ipv4, onlynet=ipv6, onlynet=onion, onlynet=i2p.\n-                    Warning: if you use -onlynet with values other than onion, and\n-                    the -onion or -proxy option is set, then outgoing onion\n-                    connections will still be made; use -noonion or -onion=0 to\n-                    disable outbound onion connections in this case.\n+                    onlynet=ipv6, onlynet=onion.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22834#discussion_r699293514",
      "id" : 699293514,
      "in_reply_to_id" : 698592051,
      "line" : 60,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5OTI5MzUxNA==",
      "original_commit_id" : "7b821b9d4c5e60ae3b79d2ee9c398852c850fc0d",
      "original_line" : 60,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "doc/tor.md",
      "position" : 9,
      "pull_request_review_id" : 742686359,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22834",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-31T12:53:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/699293514",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22834#discussion_r699294332"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/699294332"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I will optimize this because it will be called frequently (not as in https://github.com/bitcoin/bitcoin/pull/22651, once per startup). `std::unordered_set` has a lookup time `O(1)`.",
      "commit_id" : "7b821b9d4c5e60ae3b79d2ee9c398852c850fc0d",
      "created_at" : "2021-08-31T12:54:59Z",
      "diff_hunk" : "@@ -113,6 +113,22 @@ std::map<CNetAddr, LocalServiceInfo> mapLocalHost GUARDED_BY(cs_mapLocalHost);\n static bool vfLimited[NET_MAX] GUARDED_BY(cs_mapLocalHost) = {};\n std::string strSubVersion;\n \n+/**\n+ * Check if making an automatic outbound connection to the given address is allowed.\n+ * Could be restricted by the `-onlynet` configuration option.\n+ * @return true if allowed\n+ */\n+static bool OutboundConnectionAllowedTo(const CNetAddr& addr)\n+{\n+    if (!gArgs.IsArgSet(\"-onlynet\")) {\n+        return true;\n+    }\n+    const auto onlynets = gArgs.GetArgs(\"-onlynet\");\n+    return std::any_of(onlynets.begin(), onlynets.end(), [&addr](const auto& net) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22834#discussion_r699294332",
      "id" : 699294332,
      "in_reply_to_id" : 698600479,
      "line" : 127,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5OTI5NDMzMg==",
      "original_commit_id" : "7b821b9d4c5e60ae3b79d2ee9c398852c850fc0d",
      "original_line" : 127,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 15,
      "pull_request_review_id" : 742687538,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22834",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-31T12:54:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/699294332",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Do you plan to add functional tests like in #22651?\r\n\r\nIt would be good. I wonder how to test this deterministically. I guess I would want to have an addrman with just addresses from one network and use onlynet another network and check that a connection is never attempted, or something like that.",
      "created_at" : "2021-08-31T12:57:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22834#issuecomment-909211602",
      "id" : 909211602,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22834",
      "node_id" : "IC_kwDOABII5842MXfS",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-31T12:57:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/909211602",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK\r\n\r\nStarted testing today and need to test lot of combinations with onlynet. Sharing things that I observed during basic tests:\r\n\r\n1. `onlynet=i2p` with `proxy=127.0.0.1:9050` does not create any outbound connections to onion nodes using PR branch however it connects to onion node with Master branch. â \r\n\r\n    1.1 Run node 1:\r\n     ```\r\n     bitcoind -regtest=1 -port=18333 -rpcport=18222 -rpcuser=user1 -rpcpassword=pass1 -datadir=/home/prayank/node1 -debug=net\r\n     ```\r\n     1.2 Run node 2:\r\n     ```\r\n     bitcoind -regtest=1 -port=18777 -rpcport=18666 -rpcuser=user2 -rpcpassword=pass2 -onlynet=i2p -i2psam=127.0.0.1:7656 -proxy=127.0.0.1:9050 -datadir=/home/prayank/node2 -debug=net\r\n     ```\r\n     1.3 Copy onion address for node 1 and add it in peers.dat for node2:\r\n     ```\r\n     bitcoin-cli -rpcport=18666 -rpcuser=user2 -rpcpassword=pass2 addpeeraddress \"6w724ckwacu2sdfitjr6otzfi4hfutxqqcc5mju2gc2ufguysb447gqd.onion\" 18444\r\n     ```\r\n     1.4 Wait for few seconds and node 2 will create an outbound connection with node 1 on Master branch. It should fail on PR branch.\r\n     \r\n     Master branch: https://pastebin.com/raw/krvahBf7\r\n     PR branch: https://pastebin.com/raw/P6uwLtxf\r\n\r\n2. Onion service and i2p service are not created when `proxy=127.0.0.1:9050` is used. (Master and PR branch) :warning:\r\n     \r\n     \r\n     ",
      "created_at" : "2021-08-31T15:19:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22834#issuecomment-909335451",
      "id" : 909335451,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22834",
      "node_id" : "IC_kwDOABII5842M1ub",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-31T15:24:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/909335451",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/13405205?v=4",
         "events_url" : "https://api.github.com/users/prayank23/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prayank23/followers",
         "following_url" : "https://api.github.com/users/prayank23/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prayank23/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prayank23",
         "id" : 13405205,
         "login" : "prayank23",
         "node_id" : "MDQ6VXNlcjEzNDA1MjA1",
         "organizations_url" : "https://api.github.com/users/prayank23/orgs",
         "received_events_url" : "https://api.github.com/users/prayank23/received_events",
         "repos_url" : "https://api.github.com/users/prayank23/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prayank23/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prayank23/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prayank23"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Concept ACK! Glad there's a full fix for this now.",
      "created_at" : "2021-09-01T02:44:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22834#issuecomment-909824016",
      "id" : 909824016,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22834",
      "node_id" : "IC_kwDOABII5842OtAQ",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-01T02:44:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/909824016",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/24482484?v=4",
         "events_url" : "https://api.github.com/users/Rspigler/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Rspigler/followers",
         "following_url" : "https://api.github.com/users/Rspigler/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Rspigler/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Rspigler",
         "id" : 24482484,
         "login" : "Rspigler",
         "node_id" : "MDQ6VXNlcjI0NDgyNDg0",
         "organizations_url" : "https://api.github.com/users/Rspigler/orgs",
         "received_events_url" : "https://api.github.com/users/Rspigler/received_events",
         "repos_url" : "https://api.github.com/users/Rspigler/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Rspigler/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Rspigler/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Rspigler"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22834#discussion_r700290402"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/700290402"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done.",
      "commit_id" : "0ea0de64385c0150e179885a792d615005e20841",
      "created_at" : "2021-09-01T14:49:54Z",
      "diff_hunk" : "@@ -57,11 +57,7 @@ outgoing connections, but more is possible.\n     -onlynet=onion  Make outgoing connections only to .onion addresses. Incoming\n                     connections are not affected by this option. This option can be\n                     specified multiple times to allow multiple network types, e.g.\n-                    onlynet=ipv4, onlynet=ipv6, onlynet=onion, onlynet=i2p.\n-                    Warning: if you use -onlynet with values other than onion, and\n-                    the -onion or -proxy option is set, then outgoing onion\n-                    connections will still be made; use -noonion or -onion=0 to\n-                    disable outbound onion connections in this case.\n+                    onlynet=ipv6, onlynet=onion.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22834#discussion_r700290402",
      "id" : 700290402,
      "in_reply_to_id" : 698592051,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMDI5MDQwMg==",
      "original_commit_id" : "7b821b9d4c5e60ae3b79d2ee9c398852c850fc0d",
      "original_line" : 60,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "doc/tor.md",
      "position" : null,
      "pull_request_review_id" : 744033554,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22834",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-01T14:49:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/700290402",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22834#discussion_r700290807"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/700290807"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done (optimized).",
      "commit_id" : "0ea0de64385c0150e179885a792d615005e20841",
      "created_at" : "2021-09-01T14:50:21Z",
      "diff_hunk" : "@@ -113,6 +113,22 @@ std::map<CNetAddr, LocalServiceInfo> mapLocalHost GUARDED_BY(cs_mapLocalHost);\n static bool vfLimited[NET_MAX] GUARDED_BY(cs_mapLocalHost) = {};\n std::string strSubVersion;\n \n+/**\n+ * Check if making an automatic outbound connection to the given address is allowed.\n+ * Could be restricted by the `-onlynet` configuration option.\n+ * @return true if allowed\n+ */\n+static bool OutboundConnectionAllowedTo(const CNetAddr& addr)\n+{\n+    if (!gArgs.IsArgSet(\"-onlynet\")) {\n+        return true;\n+    }\n+    const auto onlynets = gArgs.GetArgs(\"-onlynet\");\n+    return std::any_of(onlynets.begin(), onlynets.end(), [&addr](const auto& net) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22834#discussion_r700290807",
      "id" : 700290807,
      "in_reply_to_id" : 698600479,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMDI5MDgwNw==",
      "original_commit_id" : "7b821b9d4c5e60ae3b79d2ee9c398852c850fc0d",
      "original_line" : 127,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 744034141,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22834",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-01T14:50:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/700290807",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "`7b821b9d4c...0ea0de6438`: optimize `OutboundConnectionAllowedTo()` for a fast lookup coz it is called frequently, plus some rewording in the docs.",
      "created_at" : "2021-09-01T14:51:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22834#issuecomment-910362016",
      "id" : 910362016,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22834",
      "node_id" : "IC_kwDOABII5842QwWg",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-01T14:51:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/910362016",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@prayank23, thanks for looking into this! So all is working as expected. `-logips=1` will improve your log output a tiny bit. I also tested this manually by adding a printout inside `OutboundConnectionAllowedTo()`, with `-onlynet=i2p -onion=127.0.0.1:9050` it is called many times with `*.onion` addresses and returns `false` as expected.\r\n\r\nA room for improvement (out of the scope of this PR): with `-onlynet=X` if addrman contains a small percentage of `X` addresses, `CConnman::ThreadOpenConnections()` will loop many times trying non-`X` addresses which get rejected either by the existent `IsReachable()` check or by the newly added `OutboundConnectionAllowedTo()`. It takes __seconds__ to select an I2P address for example. `CAddrMan::Select()` could be smarter and take a `onlynets` argument and somehow return addresses that only belong to the requested networks fast.",
      "created_at" : "2021-09-01T15:07:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22834#issuecomment-910377602",
      "id" : 910377602,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22834",
      "node_id" : "IC_kwDOABII5842Q0KC",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-01T15:07:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/910377602",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2021-09-01T16:02:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22834#issuecomment-910427409",
      "id" : 910427409,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22834",
      "node_id" : "IC_kwDOABII5842RAUR",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-01T16:02:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/910427409",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Day 2 of testing `onlynet`\r\n\r\n| ipv4          | ipv6          | onion         | i2p           | logs           | Comments           |  \r\n| ------------- | ------------- | ------------- | ------------- | -------------  |  -------------     |\r\n|   :large_blue_circle:  |      |               |               |        https://pastebin.com/raw/nq5kXqYK          |  No issues          :white_check_mark:          |\r\n|      |   :large_blue_circle:  |                |               |      https://pastebin.com/raw/6atF1HLD            |  Doesn't work       :x:             | \r\n|      |      |    :large_blue_circle:          |               |       https://pastebin.com/raw/9bwY0Nbw           |   No issues      :white_check_mark:             | \r\n|      |      |       |           :large_blue_circle:            |       https://pastebin.com/raw/mhW371kx           |   No issues    :white_check_mark:      |\r\n\r\n> So all is working as expected\r\n\r\nNeed to test more things. `onlynet=ipv6` did not work as expected today.\r\n\r\n> -logips=1 will improve your log output a tiny bit\r\n\r\nThanks. Will try this tomorrow.\r\n\r\n> CAddrMan::Select() could be smarter and take a onlynets argument and somehow return addresses that only belong to the requested networks fast.\r\n\r\nYes we can try this. ",
      "created_at" : "2021-09-01T19:13:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22834#issuecomment-910608011",
      "id" : 910608011,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22834",
      "node_id" : "IC_kwDOABII5842RsaL",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-01T19:13:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/910608011",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/13405205?v=4",
         "events_url" : "https://api.github.com/users/prayank23/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prayank23/followers",
         "following_url" : "https://api.github.com/users/prayank23/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prayank23/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prayank23",
         "id" : 13405205,
         "login" : "prayank23",
         "node_id" : "MDQ6VXNlcjEzNDA1MjA1",
         "organizations_url" : "https://api.github.com/users/prayank23/orgs",
         "received_events_url" : "https://api.github.com/users/prayank23/received_events",
         "repos_url" : "https://api.github.com/users/prayank23/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prayank23/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prayank23/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prayank23"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I wonder about the interactions of the new `OutboundConnectionAllowedTo()` with `IsReachable()`, which is how `-onlynet` also influences things - it seems complicated  to  have both `OutboundConnectionAllowedTo()` and `IsReachable()` doing similar things with subtle differences, and depending on the situation one or the other is effective.\r\n\r\nMy understanding is that `IsReachable()` will still be able to violate the `-onlynet` option sometimes (if `-proxy` , `-onion` in `init.cpp` or `torcontrol.cpp` call  `SetReachable()` after the `-onlynet` arg was evaluated).\r\nBecause addrman acceptance is gated by `IsReachable()`, I think we could still accept addrs from networks excluded by `-onlynet` into addrman that we no longer would make outgoing connections to - leading to futile connection attempts.\r\n\r\nWould it be possible as an alternative approach to get Reachable in line with `-onlynet` expectations (e.g. by moving the `-onlynet` block in init.cpp below the  `-onion` and `-proxy` blocks and also not calling `SetReachable()` from torcontrol if `-onlynet` excludes onions?) Or would there be negative side effects with other callers of `IsReachable()`?",
      "created_at" : "2021-09-01T23:28:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22834#issuecomment-910893133",
      "id" : 910893133,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22834",
      "node_id" : "IC_kwDOABII5842SyBN",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-01T23:30:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/910893133",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   }
]
