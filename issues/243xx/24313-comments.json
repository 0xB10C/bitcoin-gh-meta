[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#23578](https://github.com/bitcoin/bitcoin/pull/23578) (Add external signer taproot support by Sjors)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-02-11T10:51:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24313#issuecomment-1036079376",
      "id" : 1036079376,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24313",
      "node_id" : "IC_kwDOABII5849wVEQ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1036079376/reactions"
      },
      "updated_at" : "2022-02-11T10:51:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1036079376",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24313#discussion_r804643817"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24313"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/804643817"
         }
      },
      "author_association" : "MEMBER",
      "body" : "c83ab3059 The printed addresses correspond to the updated mocks. I think you intended to remove this line, though.",
      "commit_id" : "803387f054daefe5932153a41a0fa7e2a03e0fcb",
      "created_at" : "2022-02-11T13:24:55Z",
      "diff_hunk" : "@@ -111,8 +111,10 @@ def test_valid_signer(self):\n         assert_equal(address_info['hdkeypath'], \"m/44'/1'/0'/0/0\")\n \n         self.log.info('Test walletdisplayaddress')\n-        result = hww.walletdisplayaddress(address1)\n-        assert_equal(result, {\"address\": address1})\n+        for address in [address1, address2, address3]:\n+            print(address)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24313#discussion_r804643817",
      "id" : 804643817,
      "line" : 115,
      "node_id" : "PRRC_kwDOABII584v9ePp",
      "original_commit_id" : "803387f054daefe5932153a41a0fa7e2a03e0fcb",
      "original_line" : 115,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "test/functional/wallet_signer.py",
      "position" : 7,
      "pull_request_review_id" : 880174100,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24313",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/804643817/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-11T13:34:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/804643817",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24313#discussion_r804645583"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24313"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/804645583"
         }
      },
      "author_association" : "MEMBER",
      "body" : "c83ab3059 since you're touching this line\r\n```suggestion\r\n  std::optional<bilingual_str> DisplayAddress(const CTxDestination& dest, const ExternalSigner& signer) const;\r\n```",
      "commit_id" : "803387f054daefe5932153a41a0fa7e2a03e0fcb",
      "created_at" : "2022-02-11T13:26:47Z",
      "diff_hunk" : "@@ -27,7 +29,11 @@ class ExternalSignerScriptPubKeyMan : public DescriptorScriptPubKeyMan\n \n   static ExternalSigner GetExternalSigner();\n \n-  bool DisplayAddress(const CScript scriptPubKey, const ExternalSigner &signer) const;\n+  /**\n+  * Display address on the device and verify that the returned value matches.\n+  * @returns an error message or nullopt\n+  */\n+  std::optional<bilingual_str> DisplayAddress(const CTxDestination& dest, const ExternalSigner &signer) const;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24313#discussion_r804645583",
      "id" : 804645583,
      "line" : 36,
      "node_id" : "PRRC_kwDOABII584v9erP",
      "original_commit_id" : "803387f054daefe5932153a41a0fa7e2a03e0fcb",
      "original_line" : 36,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/wallet/external_signer_scriptpubkeyman.h",
      "position" : 18,
      "pull_request_review_id" : 880174100,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24313",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/804645583/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-11T13:34:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/804645583",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24313#discussion_r804647298"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24313"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/804647298"
         }
      },
      "author_association" : "MEMBER",
      "body" : "c83ab3059 \r\n```diff\r\n@@ -54,11 +54,11 @@ ExternalSigner ExternalSignerScriptPubKeyMan::GetExternalSigner() {\r\n std::optional<bilingual_str> ExternalSignerScriptPubKeyMan::DisplayAddress(const CTxDestination& dest, const ExternalSigner &signer) const\r\n {\r\n     // TODO: avoid the need to infer a descriptor from inside a descriptor wallet\r\n-    CScript scriptPubKey = GetScriptForDestination(dest);\r\n+    const CScript& scriptPubKey = GetScriptForDestination(dest);\r\n     auto provider = GetSolvingProvider(scriptPubKey);\r\n     auto descriptor = InferDescriptor(scriptPubKey, *provider);\r\n \r\n-    UniValue result = signer.DisplayAddress(descriptor->ToString());\r\n+    const UniValue& result = signer.DisplayAddress(descriptor->ToString());\r\n```\r\n",
      "commit_id" : "803387f054daefe5932153a41a0fa7e2a03e0fcb",
      "created_at" : "2022-02-11T13:28:36Z",
      "diff_hunk" : "@@ -49,15 +51,26 @@ ExternalSigner ExternalSignerScriptPubKeyMan::GetExternalSigner() {\n     return signers[0];\n }\n \n-bool ExternalSignerScriptPubKeyMan::DisplayAddress(const CScript scriptPubKey, const ExternalSigner &signer) const\n+std::optional<bilingual_str> ExternalSignerScriptPubKeyMan::DisplayAddress(const CTxDestination& dest, const ExternalSigner &signer) const\n {\n     // TODO: avoid the need to infer a descriptor from inside a descriptor wallet\n+    CScript scriptPubKey = GetScriptForDestination(dest);\n     auto provider = GetSolvingProvider(scriptPubKey);\n     auto descriptor = InferDescriptor(scriptPubKey, *provider);\n \n-    signer.DisplayAddress(descriptor->ToString());\n-    // TODO inspect result\n-    return true;\n+    UniValue result = signer.DisplayAddress(descriptor->ToString());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24313#discussion_r804647298",
      "id" : 804647298,
      "line" : 61,
      "node_id" : "PRRC_kwDOABII584v9fGC",
      "original_commit_id" : "803387f054daefe5932153a41a0fa7e2a03e0fcb",
      "original_line" : 61,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/wallet/external_signer_scriptpubkeyman.cpp",
      "position" : 24,
      "pull_request_review_id" : 880174100,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24313",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/804647298/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-11T13:34:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/804647298",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24313#discussion_r804652937"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24313"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/804652937"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Tests of these new errors would be nice, not sure how feasible this would be.",
      "commit_id" : "803387f054daefe5932153a41a0fa7e2a03e0fcb",
      "created_at" : "2022-02-11T13:34:19Z",
      "diff_hunk" : "@@ -49,15 +51,26 @@ ExternalSigner ExternalSignerScriptPubKeyMan::GetExternalSigner() {\n     return signers[0];\n }\n \n-bool ExternalSignerScriptPubKeyMan::DisplayAddress(const CScript scriptPubKey, const ExternalSigner &signer) const\n+std::optional<bilingual_str> ExternalSignerScriptPubKeyMan::DisplayAddress(const CTxDestination& dest, const ExternalSigner &signer) const\n {\n     // TODO: avoid the need to infer a descriptor from inside a descriptor wallet\n+    CScript scriptPubKey = GetScriptForDestination(dest);\n     auto provider = GetSolvingProvider(scriptPubKey);\n     auto descriptor = InferDescriptor(scriptPubKey, *provider);\n \n-    signer.DisplayAddress(descriptor->ToString());\n-    // TODO inspect result\n-    return true;\n+    UniValue result = signer.DisplayAddress(descriptor->ToString());\n+\n+    const UniValue& error = find_value(result, \"error\");\n+    if (error.isStr()) return strprintf(_(\"Signer returned error: %s\"), error.getValStr());\n+\n+    const UniValue& ret_address = find_value(result, \"address\");\n+    if (!ret_address.isStr()) return _(\"Signer did not echo address\");\n+\n+    if (ret_address.getValStr() != EncodeDestination(dest)) {\n+        return strprintf(_(\"Signer echoed unexpected address %s\"), ret_address.getValStr());\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24313#discussion_r804652937",
      "id" : 804652937,
      "line" : 71,
      "node_id" : "PRRC_kwDOABII584v9geJ",
      "original_commit_id" : "803387f054daefe5932153a41a0fa7e2a03e0fcb",
      "original_line" : 71,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/wallet/external_signer_scriptpubkeyman.cpp",
      "position" : 34,
      "pull_request_review_id" : 880174100,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24313",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/804652937/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-11T13:35:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/804652937",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24313#discussion_r805223204"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24313"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/805223204"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Won't this break older external signers?",
      "commit_id" : "803387f054daefe5932153a41a0fa7e2a03e0fcb",
      "created_at" : "2022-02-13T01:21:35Z",
      "diff_hunk" : "@@ -49,15 +51,26 @@ ExternalSigner ExternalSignerScriptPubKeyMan::GetExternalSigner() {\n     return signers[0];\n }\n \n-bool ExternalSignerScriptPubKeyMan::DisplayAddress(const CScript scriptPubKey, const ExternalSigner &signer) const\n+std::optional<bilingual_str> ExternalSignerScriptPubKeyMan::DisplayAddress(const CTxDestination& dest, const ExternalSigner &signer) const\n {\n     // TODO: avoid the need to infer a descriptor from inside a descriptor wallet\n+    CScript scriptPubKey = GetScriptForDestination(dest);\n     auto provider = GetSolvingProvider(scriptPubKey);\n     auto descriptor = InferDescriptor(scriptPubKey, *provider);\n \n-    signer.DisplayAddress(descriptor->ToString());\n-    // TODO inspect result\n-    return true;\n+    UniValue result = signer.DisplayAddress(descriptor->ToString());\n+\n+    const UniValue& error = find_value(result, \"error\");\n+    if (error.isStr()) return strprintf(_(\"Signer returned error: %s\"), error.getValStr());\n+\n+    const UniValue& ret_address = find_value(result, \"address\");\n+    if (!ret_address.isStr()) return _(\"Signer did not echo address\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24313#discussion_r805223204",
      "id" : 805223204,
      "line" : 67,
      "node_id" : "PRRC_kwDOABII584v_rsk",
      "original_commit_id" : "803387f054daefe5932153a41a0fa7e2a03e0fcb",
      "original_line" : 67,
      "original_position" : 30,
      "original_start_line" : 66,
      "path" : "src/wallet/external_signer_scriptpubkeyman.cpp",
      "position" : 30,
      "pull_request_review_id" : 880904295,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24313",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/805223204/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 66,
      "start_side" : "RIGHT",
      "updated_at" : "2022-02-13T01:21:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/805223204",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24313#discussion_r808915455"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24313"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/808915455"
         }
      },
      "author_association" : "MEMBER",
      "body" : "HWI has always done this, we just didn't check. That said, it's not (yet) in the spec (which may be a bit outdated) so other signer software might not do this. Do you know of any? cc @achow101 \r\n\r\n https://github.com/bitcoin/bitcoin/blob/master/doc/external-signer.md#displayaddress-optional",
      "commit_id" : "803387f054daefe5932153a41a0fa7e2a03e0fcb",
      "created_at" : "2022-02-17T10:47:40Z",
      "diff_hunk" : "@@ -49,15 +51,26 @@ ExternalSigner ExternalSignerScriptPubKeyMan::GetExternalSigner() {\n     return signers[0];\n }\n \n-bool ExternalSignerScriptPubKeyMan::DisplayAddress(const CScript scriptPubKey, const ExternalSigner &signer) const\n+std::optional<bilingual_str> ExternalSignerScriptPubKeyMan::DisplayAddress(const CTxDestination& dest, const ExternalSigner &signer) const\n {\n     // TODO: avoid the need to infer a descriptor from inside a descriptor wallet\n+    CScript scriptPubKey = GetScriptForDestination(dest);\n     auto provider = GetSolvingProvider(scriptPubKey);\n     auto descriptor = InferDescriptor(scriptPubKey, *provider);\n \n-    signer.DisplayAddress(descriptor->ToString());\n-    // TODO inspect result\n-    return true;\n+    UniValue result = signer.DisplayAddress(descriptor->ToString());\n+\n+    const UniValue& error = find_value(result, \"error\");\n+    if (error.isStr()) return strprintf(_(\"Signer returned error: %s\"), error.getValStr());\n+\n+    const UniValue& ret_address = find_value(result, \"address\");\n+    if (!ret_address.isStr()) return _(\"Signer did not echo address\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24313#discussion_r808915455",
      "id" : 808915455,
      "in_reply_to_id" : 805223204,
      "line" : 67,
      "node_id" : "PRRC_kwDOABII584wNxH_",
      "original_commit_id" : "803387f054daefe5932153a41a0fa7e2a03e0fcb",
      "original_line" : 67,
      "original_position" : 30,
      "original_start_line" : 66,
      "path" : "src/wallet/external_signer_scriptpubkeyman.cpp",
      "position" : 30,
      "pull_request_review_id" : 885772256,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24313",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/808915455/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 66,
      "start_side" : "RIGHT",
      "updated_at" : "2022-02-17T10:47:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/808915455",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24313#discussion_r808915864"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24313"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/808915864"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This particular one should be doable.",
      "commit_id" : "803387f054daefe5932153a41a0fa7e2a03e0fcb",
      "created_at" : "2022-02-17T10:48:08Z",
      "diff_hunk" : "@@ -49,15 +51,26 @@ ExternalSigner ExternalSignerScriptPubKeyMan::GetExternalSigner() {\n     return signers[0];\n }\n \n-bool ExternalSignerScriptPubKeyMan::DisplayAddress(const CScript scriptPubKey, const ExternalSigner &signer) const\n+std::optional<bilingual_str> ExternalSignerScriptPubKeyMan::DisplayAddress(const CTxDestination& dest, const ExternalSigner &signer) const\n {\n     // TODO: avoid the need to infer a descriptor from inside a descriptor wallet\n+    CScript scriptPubKey = GetScriptForDestination(dest);\n     auto provider = GetSolvingProvider(scriptPubKey);\n     auto descriptor = InferDescriptor(scriptPubKey, *provider);\n \n-    signer.DisplayAddress(descriptor->ToString());\n-    // TODO inspect result\n-    return true;\n+    UniValue result = signer.DisplayAddress(descriptor->ToString());\n+\n+    const UniValue& error = find_value(result, \"error\");\n+    if (error.isStr()) return strprintf(_(\"Signer returned error: %s\"), error.getValStr());\n+\n+    const UniValue& ret_address = find_value(result, \"address\");\n+    if (!ret_address.isStr()) return _(\"Signer did not echo address\");\n+\n+    if (ret_address.getValStr() != EncodeDestination(dest)) {\n+        return strprintf(_(\"Signer echoed unexpected address %s\"), ret_address.getValStr());\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24313#discussion_r808915864",
      "id" : 808915864,
      "in_reply_to_id" : 804652937,
      "line" : 71,
      "node_id" : "PRRC_kwDOABII584wNxOY",
      "original_commit_id" : "803387f054daefe5932153a41a0fa7e2a03e0fcb",
      "original_line" : 71,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/wallet/external_signer_scriptpubkeyman.cpp",
      "position" : 34,
      "pull_request_review_id" : 885772770,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24313",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/808915864/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-17T10:48:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/808915864",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24313#discussion_r810557973"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24313"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/810557973"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    return !error;\r\n```",
      "commit_id" : "803387f054daefe5932153a41a0fa7e2a03e0fcb",
      "created_at" : "2022-02-20T01:55:12Z",
      "diff_hunk" : "@@ -560,13 +560,16 @@ bool WalletModel::bumpFee(uint256 hash, uint256& new_hash)\n bool WalletModel::displayAddress(std::string sAddress)\n {\n     CTxDestination dest = DecodeDestination(sAddress);\n-    bool res = false;\n+    std::optional<bilingual_str> error;\n     try {\n-        res = m_wallet->displayAddress(dest);\n+        error = m_wallet->displayAddress(dest);\n     } catch (const std::runtime_error& e) {\n         QMessageBox::critical(nullptr, tr(\"Can't display address\"), e.what());\n     }\n-    return res;\n+    if (error) {\n+        QMessageBox::warning(nullptr, tr(\"Signer error\"), QString::fromStdString(error->translated));\n+    }\n+    return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24313#discussion_r810557973",
      "id" : 810557973,
      "line" : 572,
      "node_id" : "PRRC_kwDOABII584wUCIV",
      "original_commit_id" : "803387f054daefe5932153a41a0fa7e2a03e0fcb",
      "original_line" : 572,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/qt/walletmodel.cpp",
      "position" : 16,
      "pull_request_review_id" : 887981731,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24313",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/810557973/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-20T01:55:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/810557973",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   }
]
