[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#24201](https://github.com/bitcoin/bitcoin/pull/24201) (p2p: Avoid InitError when downgrading peers.dat by junderw)\n* [#23962](https://github.com/bitcoin/bitcoin/pull/23962) (Use int32_t type for transaction size/weight consistently by hebasto)\n* [#17786](https://github.com/bitcoin/bitcoin/pull/17786) (refactor: Nuke policy/fees->mempool circular dependencies by hebasto)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-02-11T11:00:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24312#issuecomment-1036087605",
      "id" : 1036087605,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24312",
      "node_id" : "IC_kwDOABII5849wXE1",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1036087605/reactions"
      },
      "updated_at" : "2022-02-11T11:00:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1036087605",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24312#discussion_r804604731"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24312"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/804604731"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Doubt: If I understood it correctly, changing the type of `lowest_compatible` to 32-bit signed integer would have been enough. So was there any specific reason to choose a 64-bit integer for the type?",
      "commit_id" : "fa4f9311c75923f74303b4988ba9cc5f779039aa",
      "created_at" : "2022-02-11T12:29:09Z",
      "diff_hunk" : "@@ -246,12 +246,12 @@ void AddrManImpl::Unserialize(Stream& s_)\n \n     uint8_t compat;\n     s >> compat;\n-    const uint8_t lowest_compatible = compat - INCOMPATIBILITY_BASE;\n-    if (lowest_compatible > FILE_FORMAT) {\n+    const int lowest_compatible{int{compat} - int{INCOMPATIBILITY_BASE}};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24312#discussion_r804604731",
      "id" : 804604731,
      "line" : 249,
      "node_id" : "PRRC_kwDOABII584v9Us7",
      "original_commit_id" : "fa4f9311c75923f74303b4988ba9cc5f779039aa",
      "original_line" : 249,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : 6,
      "pull_request_review_id" : 880115024,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24312",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/804604731/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-11T12:34:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/804604731",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/85434418?v=4",
         "events_url" : "https://api.github.com/users/shaavan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/shaavan/followers",
         "following_url" : "https://api.github.com/users/shaavan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/shaavan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/shaavan",
         "id" : 85434418,
         "login" : "shaavan",
         "node_id" : "MDQ6VXNlcjg1NDM0NDE4",
         "organizations_url" : "https://api.github.com/users/shaavan/orgs",
         "received_events_url" : "https://api.github.com/users/shaavan/received_events",
         "repos_url" : "https://api.github.com/users/shaavan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/shaavan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/shaavan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/shaavan"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24312#discussion_r804607822"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24312"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/804607822"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: \r\n```suggestion\r\n            \"Unsupported format of addrman database: %u. It is compatible with formats >=%i, \"\r\n```",
      "commit_id" : "fa4f9311c75923f74303b4988ba9cc5f779039aa",
      "created_at" : "2022-02-11T12:33:40Z",
      "diff_hunk" : "@@ -246,12 +246,12 @@ void AddrManImpl::Unserialize(Stream& s_)\n \n     uint8_t compat;\n     s >> compat;\n-    const uint8_t lowest_compatible = compat - INCOMPATIBILITY_BASE;\n-    if (lowest_compatible > FILE_FORMAT) {\n+    const int lowest_compatible{int{compat} - int{INCOMPATIBILITY_BASE}};\n+    if (lowest_compatible < 0 || lowest_compatible > FILE_FORMAT) {\n         throw std::ios_base::failure(strprintf(\n-            \"Unsupported format of addrman database: %u. It is compatible with formats >=%u, \"\n+            \"Unsupported format of addrman database: %i. It is compatible with formats >=%u, \"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24312#discussion_r804607822",
      "id" : 804607822,
      "line" : 252,
      "node_id" : "PRRC_kwDOABII584v9VdO",
      "original_commit_id" : "fa4f9311c75923f74303b4988ba9cc5f779039aa",
      "original_line" : 252,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : 10,
      "pull_request_review_id" : 880115024,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24312",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/804607822/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-11T12:34:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/804607822",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/85434418?v=4",
         "events_url" : "https://api.github.com/users/shaavan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/shaavan/followers",
         "following_url" : "https://api.github.com/users/shaavan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/shaavan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/shaavan",
         "id" : 85434418,
         "login" : "shaavan",
         "node_id" : "MDQ6VXNlcjg1NDM0NDE4",
         "organizations_url" : "https://api.github.com/users/shaavan/orgs",
         "received_events_url" : "https://api.github.com/users/shaavan/received_events",
         "repos_url" : "https://api.github.com/users/shaavan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/shaavan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/shaavan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/shaavan"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24312#discussion_r804618105"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24312"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/804618105"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`int` *is* 32-bit on all of our supported platforms. See compat/assumptions.h. I could change to int32_t, but is there a reason?",
      "commit_id" : "fa4f9311c75923f74303b4988ba9cc5f779039aa",
      "created_at" : "2022-02-11T12:49:00Z",
      "diff_hunk" : "@@ -246,12 +246,12 @@ void AddrManImpl::Unserialize(Stream& s_)\n \n     uint8_t compat;\n     s >> compat;\n-    const uint8_t lowest_compatible = compat - INCOMPATIBILITY_BASE;\n-    if (lowest_compatible > FILE_FORMAT) {\n+    const int lowest_compatible{int{compat} - int{INCOMPATIBILITY_BASE}};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24312#discussion_r804618105",
      "id" : 804618105,
      "in_reply_to_id" : 804604731,
      "line" : 249,
      "node_id" : "PRRC_kwDOABII584v9X95",
      "original_commit_id" : "fa4f9311c75923f74303b4988ba9cc5f779039aa",
      "original_line" : 249,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : 6,
      "pull_request_review_id" : 880133866,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24312",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/804618105/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-11T12:49:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/804618105",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24312#discussion_r804719310"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24312"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/804719310"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> is there a reason?\r\n\r\nNot any specific reason. This was more of a question out of curiosity rather than a doubt. I have observed that we avoid going with a higher size type for the variable when we can sufficiently work with a smaller size type; that's why I asked the question.\r\n\r\n> See compat/assumptions.h.\r\n\r\nLet me take a look through it.",
      "commit_id" : "fa4f9311c75923f74303b4988ba9cc5f779039aa",
      "created_at" : "2022-02-11T14:48:28Z",
      "diff_hunk" : "@@ -246,12 +246,12 @@ void AddrManImpl::Unserialize(Stream& s_)\n \n     uint8_t compat;\n     s >> compat;\n-    const uint8_t lowest_compatible = compat - INCOMPATIBILITY_BASE;\n-    if (lowest_compatible > FILE_FORMAT) {\n+    const int lowest_compatible{int{compat} - int{INCOMPATIBILITY_BASE}};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24312#discussion_r804719310",
      "id" : 804719310,
      "in_reply_to_id" : 804604731,
      "line" : 249,
      "node_id" : "PRRC_kwDOABII584v9wrO",
      "original_commit_id" : "fa4f9311c75923f74303b4988ba9cc5f779039aa",
      "original_line" : 249,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : 6,
      "pull_request_review_id" : 880276297,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24312",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/804719310/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-11T14:48:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/804719310",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/85434418?v=4",
         "events_url" : "https://api.github.com/users/shaavan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/shaavan/followers",
         "following_url" : "https://api.github.com/users/shaavan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/shaavan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/shaavan",
         "id" : 85434418,
         "login" : "shaavan",
         "node_id" : "MDQ6VXNlcjg1NDM0NDE4",
         "organizations_url" : "https://api.github.com/users/shaavan/orgs",
         "received_events_url" : "https://api.github.com/users/shaavan/received_events",
         "repos_url" : "https://api.github.com/users/shaavan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/shaavan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/shaavan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/shaavan"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24312#discussion_r804788437"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24312"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/804788437"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think it should be like this:\r\n\r\n```cpp\r\nif (compat < INCOMPATIBILITY_BASE) {\r\n    throw std::ios_base::failure(strprintf(\"Corrupted peers.dat: the compat value is lower than the expected 32\"));\r\n}\r\n// original code follows that is now guaranteed not to underflow\r\nconst uint8_t lowest_compatible = compat - INCOMPATIBILITY_BASE;\r\n...\r\n```\r\n\r\nThe proposed change in this PR is ok in a sense that it will fix the underflow if too low value is read from disk. However, if that happens, then the printed message would be puzzling and we have to adjust that too. Normally, the meaning of the message is this:\r\n\r\n> it is compatible with >=7, but I can only read up to 5 (so it is too high for me because 7>5)\r\n\r\nand with a bricked `peers.dat` it could be:\r\n\r\n> it is compatible with >=-10, but I can only read up to 5 (so it is too high for me because -10>5)\r\n\r\nit is puzzling because -10 is not higher than 5.",
      "commit_id" : "fa4f9311c75923f74303b4988ba9cc5f779039aa",
      "created_at" : "2022-02-11T16:01:10Z",
      "diff_hunk" : "@@ -246,12 +246,12 @@ void AddrManImpl::Unserialize(Stream& s_)\n \n     uint8_t compat;\n     s >> compat;\n-    const uint8_t lowest_compatible = compat - INCOMPATIBILITY_BASE;\n-    if (lowest_compatible > FILE_FORMAT) {\n+    const int lowest_compatible{int{compat} - int{INCOMPATIBILITY_BASE}};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24312#discussion_r804788437",
      "id" : 804788437,
      "line" : 249,
      "node_id" : "PRRC_kwDOABII584v-BjV",
      "original_commit_id" : "fa4f9311c75923f74303b4988ba9cc5f779039aa",
      "original_line" : 249,
      "original_position" : 6,
      "original_start_line" : 249,
      "path" : "src/addrman.cpp",
      "position" : 6,
      "pull_request_review_id" : 880372333,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24312",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/804788437/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 249,
      "start_side" : "LEFT",
      "updated_at" : "2022-02-11T16:02:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/804788437",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I wish we had a hidden RPC for:\r\n\r\nI wish we don't. Generally I am not a fan of baking test code into the production system, unless there is a need for it.",
      "created_at" : "2022-02-12T07:18:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24312#issuecomment-1037037446",
      "id" : 1037037446,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24312",
      "node_id" : "IC_kwDOABII5849z--G",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1037037446/reactions"
      },
      "updated_at" : "2022-02-12T07:18:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1037037446",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
