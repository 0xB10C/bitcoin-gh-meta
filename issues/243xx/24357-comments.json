[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#22052](https://github.com/bitcoin/bitcoin/pull/22052) (net: remove non-blocking bool from interface by Bushstar)\n* [#21878](https://github.com/bitcoin/bitcoin/pull/21878) (Make all networking code mockable by vasild)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-02-17T08:10:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24357#issuecomment-1042676966",
      "id" : 1042676966,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24357",
      "node_id" : "IC_kwDOABII584-Jfzm",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1042676966/reactions"
      },
      "updated_at" : "2022-02-17T08:10:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1042676966",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2022-03-09T16:56:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24357#issuecomment-1063144289",
      "id" : 1063144289,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24357",
      "node_id" : "IC_kwDOABII584_Xkth",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1063144289/reactions"
      },
      "updated_at" : "2022-03-09T16:56:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1063144289",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24357#discussion_r827476824"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24357"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/827476824"
         }
      },
      "author_association" : "MEMBER",
      "body" : "03c630e\r\n```suggestion\r\n     * `setsockopt(/*sockfd=*/this->Get(), level, opt_name, opt_val, opt_len)`. Code that uses this\r\n```\r\n(same for `getsockopt` just above)",
      "commit_id" : "aaf8d7ed1fbcd2f1a90e4f02d50ca7d2864587d0",
      "created_at" : "2022-03-15T22:47:51Z",
      "diff_hunk" : "@@ -115,6 +115,22 @@ class Sock\n                                          void* opt_val,\n                                          socklen_t* opt_len) const;\n \n+    /**\n+     * setsockopt(2) wrapper. Equivalent to\n+     * `setsockopt(this->Get(), level, opt_name, opt_val, opt_len)`. Code that uses this",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24357#discussion_r827476824",
      "id" : 827476824,
      "line" : 120,
      "node_id" : "PRRC_kwDOABII584xUktY",
      "original_commit_id" : "aaf8d7ed1fbcd2f1a90e4f02d50ca7d2864587d0",
      "original_line" : 120,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/util/sock.h",
      "position" : 6,
      "pull_request_review_id" : 910912260,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24357",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/827476824/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-15T23:27:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/827476824",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24357#discussion_r827477981"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24357"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/827477981"
         }
      },
      "author_association" : "MEMBER",
      "body" : "03c630e Placing all the `SetSockOpt()` declaration parameters on the same line, like in the definition, would be more consistent and easier to compare with the definition. ",
      "commit_id" : "aaf8d7ed1fbcd2f1a90e4f02d50ca7d2864587d0",
      "created_at" : "2022-03-15T22:50:13Z",
      "diff_hunk" : "@@ -115,6 +115,22 @@ class Sock\n                                          void* opt_val,\n                                          socklen_t* opt_len) const;\n \n+    /**\n+     * setsockopt(2) wrapper. Equivalent to\n+     * `setsockopt(this->Get(), level, opt_name, opt_val, opt_len)`. Code that uses this\n+     * wrapper can be unit tested if this method is overridden by a mock Sock implementation.\n+     */\n+    [[nodiscard]] virtual int SetSockOpt(int level,\n+                                         int opt_name,\n+                                         const void* opt_val,\n+                                         socklen_t opt_len) const;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24357#discussion_r827477981",
      "id" : 827477981,
      "line" : 126,
      "node_id" : "PRRC_kwDOABII584xUk_d",
      "original_commit_id" : "aaf8d7ed1fbcd2f1a90e4f02d50ca7d2864587d0",
      "original_line" : 126,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/util/sock.h",
      "position" : 12,
      "pull_request_review_id" : 910912260,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24357",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/827477981/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-15T23:27:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/827477981",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24357#discussion_r827489776"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24357"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/827489776"
         }
      },
      "author_association" : "MEMBER",
      "body" : "7c914fe2 These 3 error messages would be easier to read and review if they were on one line like the two pre-existing ones in the same `BindListenPort()` function. Also, the first added one is formatted differently from the next two added ones in this commit. Each being on one line would be simpler to write and to read.",
      "commit_id" : "aaf8d7ed1fbcd2f1a90e4f02d50ca7d2864587d0",
      "created_at" : "2022-03-15T23:13:20Z",
      "diff_hunk" : "@@ -2382,17 +2385,32 @@ bool CConnman::BindListenPort(const CService& addrBind, bilingual_str& strError,\n \n     // Allow binding if the port is still in TIME_WAIT state after\n     // the program was closed and restarted.\n-    setsockopt(sock->Get(), SOL_SOCKET, SO_REUSEADDR, (sockopt_arg_type)&nOne, sizeof(int));\n+    if (sock->SetSockOpt(SOL_SOCKET, SO_REUSEADDR, (sockopt_arg_type)&nOne, sizeof(int)) == SOCKET_ERROR) {\n+        strError =\n+            strprintf(Untranslated(\"Error setting SO_REUSEADDR on socket: %s, continuing anyway\"),\n+                      NetworkErrorString(WSAGetLastError()));\n+        LogPrintf(\"%s\\n\", strError.original);\n+    }\n \n     // some systems don't have IPV6_V6ONLY but are always v6only; others do have the option\n     // and enable it by default or not. Try to enable it, if possible.\n     if (addrBind.IsIPv6()) {\n #ifdef IPV6_V6ONLY\n-        setsockopt(sock->Get(), IPPROTO_IPV6, IPV6_V6ONLY, (sockopt_arg_type)&nOne, sizeof(int));\n+        if (sock->SetSockOpt(IPPROTO_IPV6, IPV6_V6ONLY, (sockopt_arg_type)&nOne, sizeof(int)) == SOCKET_ERROR) {\n+            strError = strprintf(\n+                Untranslated(\"Error setting IPV6_V6ONLY on socket: %s, continuing anyway\"),\n+                NetworkErrorString(WSAGetLastError()));\n+            LogPrintf(\"%s\\n\", strError.original);\n+        }\n #endif\n #ifdef WIN32\n         int nProtLevel = PROTECTION_LEVEL_UNRESTRICTED;\n-        setsockopt(sock->Get(), IPPROTO_IPV6, IPV6_PROTECTION_LEVEL, (const char*)&nProtLevel, sizeof(int));\n+        if (sock->SetSockOpt(IPPROTO_IPV6, IPV6_PROTECTION_LEVEL, (const char*)&nProtLevel, sizeof(int)) == SOCKET_ERROR) {\n+            strError = strprintf(\n+                Untranslated(\"Error setting IPV6_PROTECTION_LEVEL on socket: %s, continuing anyway\"),\n+                NetworkErrorString(WSAGetLastError()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24357#discussion_r827489776",
      "id" : 827489776,
      "line" : 2411,
      "node_id" : "PRRC_kwDOABII584xUn3w",
      "original_commit_id" : "aaf8d7ed1fbcd2f1a90e4f02d50ca7d2864587d0",
      "original_line" : 2411,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 42,
      "pull_request_review_id" : 910912260,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24357",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/827489776/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-15T23:27:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/827489776",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   }
]
