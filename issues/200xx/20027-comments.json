[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #20044 (Make all of net_processing (and some of net) use std::chrono types by sipa)\n* #19893 (test: Remove or explain syncwithvalidationinterfacequeue by MarcoFalke)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-09-28T03:53:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20027#issuecomment-699754735",
      "id" : 699754735,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20027",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5OTc1NDczNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-30T09:38:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/699754735",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20027#discussion_r495713665"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20027"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/495713665"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is not type safe, because someone could changed the type of current_time to have more or less precision than it has now. Please see the `count_` helpers.",
      "commit_id" : "d7fad1690c27bf270774da6eebc4ef8b550caf09",
      "created_at" : "2020-09-28T06:27:33Z",
      "diff_hunk" : "@@ -4155,7 +4154,7 @@ bool PeerManager::SendMessages(CNode* pto)\n             // Only actively request headers from a single peer, unless we're close to today.\n             if ((nSyncStarted == 0 && fFetch) || pindexBestHeader->GetBlockTime() > GetAdjustedTime() - 24 * 60 * 60) {\n                 state.fSyncStarted = true;\n-                state.nHeadersSyncTimeout = GetTimeMicros() + HEADERS_DOWNLOAD_TIMEOUT_BASE + HEADERS_DOWNLOAD_TIMEOUT_PER_HEADER * (GetAdjustedTime() - pindexBestHeader->GetBlockTime())/(consensusParams.nPowTargetSpacing);\n+                state.nHeadersSyncTimeout = current_time.count() + HEADERS_DOWNLOAD_TIMEOUT_BASE + HEADERS_DOWNLOAD_TIMEOUT_PER_HEADER * (GetAdjustedTime() - pindexBestHeader->GetBlockTime())/(consensusParams.nPowTargetSpacing);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20027#discussion_r495713665",
      "id" : 495713665,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTcxMzY2NQ==",
      "original_commit_id" : "1281d7d31d3c3ff0e97d15f83385f3c33f181d76",
      "original_line" : 4157,
      "original_position" : 40,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 497216637,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20027",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-07T23:24:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/495713665",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20027#discussion_r495714998"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20027"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/495714998"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is there any reason to subtract the time it took to send previous messages from the next send? It probably doesn't matter too much, because we assume that sending all messages is instantaneous, but getting the current time is also trivial complexity, so I have a slight preference to keep the getter here.",
      "commit_id" : "d7fad1690c27bf270774da6eebc4ef8b550caf09",
      "created_at" : "2020-09-28T06:31:18Z",
      "diff_hunk" : "@@ -4636,7 +4632,6 @@ bool PeerManager::SendMessages(CNode* pto)\n             !pto->HasPermission(PF_FORCERELAY) // peers with the forcerelay permission should not filter txs to us\n         ) {\n             CAmount currentFilter = m_mempool.GetMinFee(gArgs.GetArg(\"-maxmempool\", DEFAULT_MAX_MEMPOOL_SIZE) * 1000000).GetFeePerK();\n-            int64_t timeNow = GetTimeMicros();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20027#discussion_r495714998",
      "id" : 495714998,
      "line" : 4632,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTcxNDk5OA==",
      "original_commit_id" : "1281d7d31d3c3ff0e97d15f83385f3c33f181d76",
      "original_line" : 4632,
      "original_position" : 120,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 120,
      "pull_request_review_id" : 497216637,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20027",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-07T23:24:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/495714998",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20027#discussion_r495715257"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20027"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/495715257"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can you explain why this is needed, what this is trying to achieve? #19893 ",
      "commit_id" : "d7fad1690c27bf270774da6eebc4ef8b550caf09",
      "created_at" : "2020-09-28T06:32:05Z",
      "diff_hunk" : "@@ -64,6 +64,10 @@ def run_test(self):\n         # Transaction should be rebroadcast approximately 24 hours in the future,\n         # but can range from 12-36. So bump 36 hours to be sure.\n         node.setmocktime(now + 36 * 60 * 60)\n+        # Give some time for trickle to occur\n+        time.sleep(1)\n+        node.syncwithvalidationinterfacequeue()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20027#discussion_r495715257",
      "id" : 495715257,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTcxNTI1Nw==",
      "original_commit_id" : "1281d7d31d3c3ff0e97d15f83385f3c33f181d76",
      "original_line" : 69,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "test/functional/wallet_resendwallettransactions.py",
      "position" : null,
      "pull_request_review_id" : 497216637,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20027",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-07T23:24:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/495715257",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20027#discussion_r495715858"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20027"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/495715858"
         }
      },
      "author_association" : "MEMBER",
      "body" : "none of the `.count` in this scope are type safe (see comment above)",
      "commit_id" : "d7fad1690c27bf270774da6eebc4ef8b550caf09",
      "created_at" : "2020-09-28T06:33:45Z",
      "diff_hunk" : "@@ -4647,24 +4642,24 @@ bool PeerManager::SendMessages(CNode* pto)\n                 if (pto->m_tx_relay->lastSentFeeFilter == MAX_FILTER) {\n                     // Send the current filter if we sent MAX_FILTER previously\n                     // and made it out of IBD.\n-                    pto->m_tx_relay->nextSendTimeFeeFilter = timeNow - 1;\n+                    pto->m_tx_relay->nextSendTimeFeeFilter = current_time.count() - 1;\n                 }\n             }\n-            if (timeNow > pto->m_tx_relay->nextSendTimeFeeFilter) {\n+            if (current_time.count() > pto->m_tx_relay->nextSendTimeFeeFilter) {\n                 CAmount filterToSend = g_filter_rounder.round(currentFilter);\n                 // We always have a fee filter of at least minRelayTxFee\n                 filterToSend = std::max(filterToSend, ::minRelayTxFee.GetFeePerK());\n                 if (filterToSend != pto->m_tx_relay->lastSentFeeFilter) {\n                     m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::FEEFILTER, filterToSend));\n                     pto->m_tx_relay->lastSentFeeFilter = filterToSend;\n                 }\n-                pto->m_tx_relay->nextSendTimeFeeFilter = PoissonNextSend(timeNow, AVG_FEEFILTER_BROADCAST_INTERVAL);\n+                pto->m_tx_relay->nextSendTimeFeeFilter = PoissonNextSend(current_time.count(), AVG_FEEFILTER_BROADCAST_INTERVAL);\n             }\n             // If the fee filter has changed substantially and it's still more than MAX_FEEFILTER_CHANGE_DELAY\n             // until scheduled broadcast, then move the broadcast to within MAX_FEEFILTER_CHANGE_DELAY.\n-            else if (timeNow + MAX_FEEFILTER_CHANGE_DELAY * 1000000 < pto->m_tx_relay->nextSendTimeFeeFilter &&\n+            else if (current_time.count() + MAX_FEEFILTER_CHANGE_DELAY * 1000000 < pto->m_tx_relay->nextSendTimeFeeFilter &&\n                      (currentFilter < 3 * pto->m_tx_relay->lastSentFeeFilter / 4 || currentFilter > 4 * pto->m_tx_relay->lastSentFeeFilter / 3)) {\n-                pto->m_tx_relay->nextSendTimeFeeFilter = timeNow + GetRandInt(MAX_FEEFILTER_CHANGE_DELAY) * 1000000;\n+                pto->m_tx_relay->nextSendTimeFeeFilter = current_time.count() + GetRandInt(MAX_FEEFILTER_CHANGE_DELAY) * 1000000;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20027#discussion_r495715858",
      "id" : 495715858,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTcxNTg1OA==",
      "original_commit_id" : "1281d7d31d3c3ff0e97d15f83385f3c33f181d76",
      "original_line" : 4662,
      "original_position" : 150,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 497216637,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20027",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-07T23:24:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/495715858",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2020-09-28T06:42:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20027#issuecomment-699808948",
      "id" : 699808948,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20027",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5OTgwODk0OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-28T06:42:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/699808948",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20027#discussion_r495725021"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20027"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/495725021"
         }
      },
      "author_association" : "MEMBER",
      "body" : "That's indeed better, done.\r\n\r\nA bit more abstractly, I don't think that's very different from the risk of `nHeadersSyncTimeout` being changed to represent a time in nanoseconds instead of microseconds, for example. We're mixing std::chrono types with integers, and the conversions will always involve these risks. The correct approach is to get rid of all of those, and replace them all with `std::chrono` types. I'm happy to look into that as follow-up PR.",
      "commit_id" : "d7fad1690c27bf270774da6eebc4ef8b550caf09",
      "created_at" : "2020-09-28T06:56:50Z",
      "diff_hunk" : "@@ -4155,7 +4154,7 @@ bool PeerManager::SendMessages(CNode* pto)\n             // Only actively request headers from a single peer, unless we're close to today.\n             if ((nSyncStarted == 0 && fFetch) || pindexBestHeader->GetBlockTime() > GetAdjustedTime() - 24 * 60 * 60) {\n                 state.fSyncStarted = true;\n-                state.nHeadersSyncTimeout = GetTimeMicros() + HEADERS_DOWNLOAD_TIMEOUT_BASE + HEADERS_DOWNLOAD_TIMEOUT_PER_HEADER * (GetAdjustedTime() - pindexBestHeader->GetBlockTime())/(consensusParams.nPowTargetSpacing);\n+                state.nHeadersSyncTimeout = current_time.count() + HEADERS_DOWNLOAD_TIMEOUT_BASE + HEADERS_DOWNLOAD_TIMEOUT_PER_HEADER * (GetAdjustedTime() - pindexBestHeader->GetBlockTime())/(consensusParams.nPowTargetSpacing);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20027#discussion_r495725021",
      "id" : 495725021,
      "in_reply_to_id" : 495713665,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTcyNTAyMQ==",
      "original_commit_id" : "1281d7d31d3c3ff0e97d15f83385f3c33f181d76",
      "original_line" : 4157,
      "original_position" : 40,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 497231451,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20027",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-07T23:24:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/495725021",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20027#discussion_r495728306"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20027"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/495728306"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I generally think we're making way too many time calls already, and I doubt microsecond precisions matters at all for the fee filter sending.",
      "commit_id" : "d7fad1690c27bf270774da6eebc4ef8b550caf09",
      "created_at" : "2020-09-28T07:04:39Z",
      "diff_hunk" : "@@ -4636,7 +4632,6 @@ bool PeerManager::SendMessages(CNode* pto)\n             !pto->HasPermission(PF_FORCERELAY) // peers with the forcerelay permission should not filter txs to us\n         ) {\n             CAmount currentFilter = m_mempool.GetMinFee(gArgs.GetArg(\"-maxmempool\", DEFAULT_MAX_MEMPOOL_SIZE) * 1000000).GetFeePerK();\n-            int64_t timeNow = GetTimeMicros();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20027#discussion_r495728306",
      "id" : 495728306,
      "in_reply_to_id" : 495714998,
      "line" : 4632,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTcyODMwNg==",
      "original_commit_id" : "1281d7d31d3c3ff0e97d15f83385f3c33f181d76",
      "original_line" : 4632,
      "original_position" : 120,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 120,
      "pull_request_review_id" : 497235758,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20027",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-07T23:24:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/495728306",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20027#discussion_r495728533"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20027"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/495728533"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I copied it from elsewhere; it works fine without the `syncwithvalidationinterfacequeue` call, so I've removed it.",
      "commit_id" : "d7fad1690c27bf270774da6eebc4ef8b550caf09",
      "created_at" : "2020-09-28T07:05:10Z",
      "diff_hunk" : "@@ -64,6 +64,10 @@ def run_test(self):\n         # Transaction should be rebroadcast approximately 24 hours in the future,\n         # but can range from 12-36. So bump 36 hours to be sure.\n         node.setmocktime(now + 36 * 60 * 60)\n+        # Give some time for trickle to occur\n+        time.sleep(1)\n+        node.syncwithvalidationinterfacequeue()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20027#discussion_r495728533",
      "id" : 495728533,
      "in_reply_to_id" : 495715257,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTcyODUzMw==",
      "original_commit_id" : "1281d7d31d3c3ff0e97d15f83385f3c33f181d76",
      "original_line" : 69,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "test/functional/wallet_resendwallettransactions.py",
      "position" : null,
      "pull_request_review_id" : 497236054,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20027",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-07T23:24:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/495728533",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20027#discussion_r495728640"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20027"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/495728640"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "d7fad1690c27bf270774da6eebc4ef8b550caf09",
      "created_at" : "2020-09-28T07:05:22Z",
      "diff_hunk" : "@@ -4647,24 +4642,24 @@ bool PeerManager::SendMessages(CNode* pto)\n                 if (pto->m_tx_relay->lastSentFeeFilter == MAX_FILTER) {\n                     // Send the current filter if we sent MAX_FILTER previously\n                     // and made it out of IBD.\n-                    pto->m_tx_relay->nextSendTimeFeeFilter = timeNow - 1;\n+                    pto->m_tx_relay->nextSendTimeFeeFilter = current_time.count() - 1;\n                 }\n             }\n-            if (timeNow > pto->m_tx_relay->nextSendTimeFeeFilter) {\n+            if (current_time.count() > pto->m_tx_relay->nextSendTimeFeeFilter) {\n                 CAmount filterToSend = g_filter_rounder.round(currentFilter);\n                 // We always have a fee filter of at least minRelayTxFee\n                 filterToSend = std::max(filterToSend, ::minRelayTxFee.GetFeePerK());\n                 if (filterToSend != pto->m_tx_relay->lastSentFeeFilter) {\n                     m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::FEEFILTER, filterToSend));\n                     pto->m_tx_relay->lastSentFeeFilter = filterToSend;\n                 }\n-                pto->m_tx_relay->nextSendTimeFeeFilter = PoissonNextSend(timeNow, AVG_FEEFILTER_BROADCAST_INTERVAL);\n+                pto->m_tx_relay->nextSendTimeFeeFilter = PoissonNextSend(current_time.count(), AVG_FEEFILTER_BROADCAST_INTERVAL);\n             }\n             // If the fee filter has changed substantially and it's still more than MAX_FEEFILTER_CHANGE_DELAY\n             // until scheduled broadcast, then move the broadcast to within MAX_FEEFILTER_CHANGE_DELAY.\n-            else if (timeNow + MAX_FEEFILTER_CHANGE_DELAY * 1000000 < pto->m_tx_relay->nextSendTimeFeeFilter &&\n+            else if (current_time.count() + MAX_FEEFILTER_CHANGE_DELAY * 1000000 < pto->m_tx_relay->nextSendTimeFeeFilter &&\n                      (currentFilter < 3 * pto->m_tx_relay->lastSentFeeFilter / 4 || currentFilter > 4 * pto->m_tx_relay->lastSentFeeFilter / 3)) {\n-                pto->m_tx_relay->nextSendTimeFeeFilter = timeNow + GetRandInt(MAX_FEEFILTER_CHANGE_DELAY) * 1000000;\n+                pto->m_tx_relay->nextSendTimeFeeFilter = current_time.count() + GetRandInt(MAX_FEEFILTER_CHANGE_DELAY) * 1000000;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20027#discussion_r495728640",
      "id" : 495728640,
      "in_reply_to_id" : 495715858,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTcyODY0MA==",
      "original_commit_id" : "1281d7d31d3c3ff0e97d15f83385f3c33f181d76",
      "original_line" : 4662,
      "original_position" : 150,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 497236177,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20027",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-07T23:24:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/495728640",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2020-09-28T13:13:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20027#issuecomment-699998356",
      "id" : 699998356,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20027",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5OTk5ODM1Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-28T13:13:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/699998356",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20027#discussion_r500665474"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20027"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500665474"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm not sure it's a good idea to link mockable time to network delays in general -- if you bump the mocktime by a hours/days that shouldn't risk triggering \"hey this peer hasn't said anything for ages, let's disconnect\" conditions, and equally if you backdate the mocktime for some reason, that shouldn't cause network tasks to say \"oh, we decided we don't need to do anything until time t, which is apparently years away\" and effectively hang. Having to tweak tests feels a bit like a canary...\r\n\r\nMy intuition for this was we have two sorts of delays -- short ones (<30s) that just prevent us busy looping when there's nothing to actually do and don't generally need to be precisely controlled, and long ones (minutes/hours/days) that are human visible and that we'll obviously need mocktime to test because minutes/hours/days is effectively forever.\r\n\r\nBut maybe we've really got two different sorts of mocking that we want to do -- \"set the time to X\" and it stays there until we're ready to set it to some different time \"Y\" (what we've got now), and \"everything that was going to happen in the next 5 minutes, get it done now\" (something more like what the `mockscheduler` rpc does)? You could implement the latter by bumping the system clock (rather than replacing it), and only allowing the bump amount to increase.\r\n\r\nI suspect at a minimum we'd want to switch to the `std::chrono::time_point` abstraction and use different clocks so that we could tell these cases apart by type, but that doesn't seem like a good thing to dive into immediately before feature freeze. (I had a sketch I was working on a while back at https://github.com/ajtowns/bitcoin/commits/201908-systime fwiw)\r\n\r\nAnd mocktime is only relevant for regtest, so the downsides of this approach are pretty limited (presumably to just these test case changes)",
      "commit_id" : "d7fad1690c27bf270774da6eebc4ef8b550caf09",
      "created_at" : "2020-10-07T00:14:01Z",
      "diff_hunk" : "@@ -158,23 +158,19 @@ def test_spurious_notfound(self):\n         self.nodes[0].p2ps[0].send_message(msg_notfound(vec=[CInv(MSG_TX, 1)]))\n \n     def run_test(self):\n-        # Setup the p2p connections\n-        self.peers = []\n-        for node in self.nodes:\n-            for _ in range(NUM_INBOUND):\n-                self.peers.append(node.add_p2p_connection(TestP2PConn()))\n-\n-        self.log.info(\"Nodes are setup with {} incoming connections each\".format(NUM_INBOUND))\n-\n-        self.test_spurious_notfound()\n-\n-        # Test the in-flight max first, because we want no transactions in\n-        # flight ahead of this test.\n-        self.test_in_flight_max()\n-\n-        self.test_inv_block()\n-\n-        self.test_tx_requests()\n+        # Run each test against new bitcoind instances, as setting mocktimes has long-term effects on when\n+        # the next trickle relay event happens.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20027#discussion_r500665474",
      "id" : 500665474,
      "line" : 162,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY2NTQ3NA==",
      "original_commit_id" : "e5c0223614d61d3d885b1c7eaf5ee095cd7d15ed",
      "original_line" : 162,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "test/functional/p2p_tx_download.py",
      "position" : 22,
      "pull_request_review_id" : 503443240,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20027",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-07T23:24:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500665474",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20027#discussion_r500671894"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20027"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500671894"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "a) We're not actually sending the messages there, just moving them in memory to a different queue, so it should take microseconds\r\nb) This is often only called in intervals of 100ms, and randomly delayed depending on how long it takes to deal with other peers, so accuracy won't be that fine-grained anyway\r\nc) The only times affected by not using an updated timestamp here are ones chosen in comparison to 5min or 10min intervals\r\n\r\nSo I don't see how not using a bumped time here can have any meaningful impact?",
      "commit_id" : "d7fad1690c27bf270774da6eebc4ef8b550caf09",
      "created_at" : "2020-10-07T00:36:53Z",
      "diff_hunk" : "@@ -4636,7 +4632,6 @@ bool PeerManager::SendMessages(CNode* pto)\n             !pto->HasPermission(PF_FORCERELAY) // peers with the forcerelay permission should not filter txs to us\n         ) {\n             CAmount currentFilter = m_mempool.GetMinFee(gArgs.GetArg(\"-maxmempool\", DEFAULT_MAX_MEMPOOL_SIZE) * 1000000).GetFeePerK();\n-            int64_t timeNow = GetTimeMicros();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20027#discussion_r500671894",
      "id" : 500671894,
      "in_reply_to_id" : 495714998,
      "line" : 4632,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY3MTg5NA==",
      "original_commit_id" : "1281d7d31d3c3ff0e97d15f83385f3c33f181d76",
      "original_line" : 4632,
      "original_position" : 120,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 120,
      "pull_request_review_id" : 503443240,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20027",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-07T23:24:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500671894",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20027#discussion_r500672498"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20027"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500672498"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Swich to `count_microseconds(GetTime<std::chrono::microseconds>())` and lose the `<int64_t>` ?",
      "commit_id" : "d7fad1690c27bf270774da6eebc4ef8b550caf09",
      "created_at" : "2020-10-07T00:39:20Z",
      "diff_hunk" : "@@ -559,7 +559,7 @@ static bool MarkBlockAsReceived(const uint256& hash) EXCLUSIVE_LOCKS_REQUIRED(cs\n         }\n         if (state->vBlocksInFlight.begin() == itInFlight->second.second) {\n             // First block on the queue was received, update the start download time for the next one\n-            state->nDownloadingSince = std::max(state->nDownloadingSince, GetTimeMicros());\n+            state->nDownloadingSince = std::max<int64_t>(state->nDownloadingSince, GetTime<std::chrono::microseconds>().count());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20027#discussion_r500672498",
      "id" : 500672498,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY3MjQ5OA==",
      "original_commit_id" : "e5c0223614d61d3d885b1c7eaf5ee095cd7d15ed",
      "original_line" : 562,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 503443240,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20027",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-07T23:24:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500672498",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20027#discussion_r500685197"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20027"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500685197"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Not really directly related? I think this makes sense for instances where time isn't increasing, which can happen with mocktime or (I think) on systems that return cached values of the system time.",
      "commit_id" : "d7fad1690c27bf270774da6eebc4ef8b550caf09",
      "created_at" : "2020-10-07T01:29:56Z",
      "diff_hunk" : "@@ -3610,7 +3610,7 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n                     // Matching pong received, this ping is no longer outstanding\n                     bPingFinished = true;\n                     const auto ping_time = ping_end - pfrom.m_ping_start.load();\n-                    if (ping_time.count() > 0) {\n+                    if (ping_time.count() >= 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20027#discussion_r500685197",
      "id" : 500685197,
      "line" : 3640,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY4NTE5Nw==",
      "original_commit_id" : "e5c0223614d61d3d885b1c7eaf5ee095cd7d15ed",
      "original_line" : 3640,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 23,
      "pull_request_review_id" : 503443240,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20027",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-07T23:24:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500685197",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK e5c0223614d61d3d885b1c7eaf5ee095cd7d15ed",
      "created_at" : "2020-10-07T08:41:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20027#issuecomment-704786679",
      "id" : 704786679,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20027",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwNDc4NjY3OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-07T08:41:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/704786679",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20027#discussion_r501350411"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20027"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/501350411"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think we'll indeed a number of timers for different purposes, eventually:\r\n* System time (possibly adjusted by peer data), for use in block and wallet transaction timestamps (as they have an absolute UNIX epoch as reference ).\r\n* Steady time, mockable, for timing application level events (tx relay, pinging, addr rebroadcast, ...).\r\n* Steady time, for avoiding busy looping (like select() timeout, message handler 100ms delay, ...).\r\n\r\nThe last one indeed I think shouldn't be mockable, but things like ping timeouts I think should be. It just becomes too complicated when multiple clocks are mixed within one layer of the code - even if it means using a mockable clock for some delays that are in practice very short.\r\n\r\nAs for dealing with the fact that making small delays mockable complicates testing, I think the best solution is a \"add X to mock time offset, but keep the clock running\", if that's what you meant.",
      "commit_id" : "d7fad1690c27bf270774da6eebc4ef8b550caf09",
      "created_at" : "2020-10-07T22:40:35Z",
      "diff_hunk" : "@@ -158,23 +158,19 @@ def test_spurious_notfound(self):\n         self.nodes[0].p2ps[0].send_message(msg_notfound(vec=[CInv(MSG_TX, 1)]))\n \n     def run_test(self):\n-        # Setup the p2p connections\n-        self.peers = []\n-        for node in self.nodes:\n-            for _ in range(NUM_INBOUND):\n-                self.peers.append(node.add_p2p_connection(TestP2PConn()))\n-\n-        self.log.info(\"Nodes are setup with {} incoming connections each\".format(NUM_INBOUND))\n-\n-        self.test_spurious_notfound()\n-\n-        # Test the in-flight max first, because we want no transactions in\n-        # flight ahead of this test.\n-        self.test_in_flight_max()\n-\n-        self.test_inv_block()\n-\n-        self.test_tx_requests()\n+        # Run each test against new bitcoind instances, as setting mocktimes has long-term effects on when\n+        # the next trickle relay event happens.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20027#discussion_r501350411",
      "id" : 501350411,
      "in_reply_to_id" : 500665474,
      "line" : 162,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM1MDQxMQ==",
      "original_commit_id" : "e5c0223614d61d3d885b1c7eaf5ee095cd7d15ed",
      "original_line" : 162,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "test/functional/p2p_tx_download.py",
      "position" : 22,
      "pull_request_review_id" : 504317027,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20027",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-07T23:24:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/501350411",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20027#discussion_r501365107"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20027"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/501365107"
         }
      },
      "author_association" : "MEMBER",
      "body" : "WIthout this you see \"timing mishap\" errors in the function test logs.",
      "commit_id" : "d7fad1690c27bf270774da6eebc4ef8b550caf09",
      "created_at" : "2020-10-07T23:23:46Z",
      "diff_hunk" : "@@ -3610,7 +3610,7 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n                     // Matching pong received, this ping is no longer outstanding\n                     bPingFinished = true;\n                     const auto ping_time = ping_end - pfrom.m_ping_start.load();\n-                    if (ping_time.count() > 0) {\n+                    if (ping_time.count() >= 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20027#discussion_r501365107",
      "id" : 501365107,
      "in_reply_to_id" : 500685197,
      "line" : 3640,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM2NTEwNw==",
      "original_commit_id" : "e5c0223614d61d3d885b1c7eaf5ee095cd7d15ed",
      "original_line" : 3640,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 23,
      "pull_request_review_id" : 504333764,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20027",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-07T23:24:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/501365107",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20027#discussion_r501365295"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20027"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/501365295"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "d7fad1690c27bf270774da6eebc4ef8b550caf09",
      "created_at" : "2020-10-07T23:24:18Z",
      "diff_hunk" : "@@ -559,7 +559,7 @@ static bool MarkBlockAsReceived(const uint256& hash) EXCLUSIVE_LOCKS_REQUIRED(cs\n         }\n         if (state->vBlocksInFlight.begin() == itInFlight->second.second) {\n             // First block on the queue was received, update the start download time for the next one\n-            state->nDownloadingSince = std::max(state->nDownloadingSince, GetTimeMicros());\n+            state->nDownloadingSince = std::max<int64_t>(state->nDownloadingSince, GetTime<std::chrono::microseconds>().count());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20027#discussion_r501365295",
      "id" : 501365295,
      "in_reply_to_id" : 500672498,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM2NTI5NQ==",
      "original_commit_id" : "e5c0223614d61d3d885b1c7eaf5ee095cd7d15ed",
      "original_line" : 562,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 504333957,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20027",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-07T23:24:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/501365295",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20027#discussion_r501380053"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20027"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/501380053"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Right, but I mean you already see those errors without the other changes in this patch.",
      "commit_id" : "d7fad1690c27bf270774da6eebc4ef8b550caf09",
      "created_at" : "2020-10-08T00:14:54Z",
      "diff_hunk" : "@@ -3610,7 +3610,7 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n                     // Matching pong received, this ping is no longer outstanding\n                     bPingFinished = true;\n                     const auto ping_time = ping_end - pfrom.m_ping_start.load();\n-                    if (ping_time.count() > 0) {\n+                    if (ping_time.count() >= 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20027#discussion_r501380053",
      "id" : 501380053,
      "in_reply_to_id" : 500685197,
      "line" : 3640,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM4MDA1Mw==",
      "original_commit_id" : "e5c0223614d61d3d885b1c7eaf5ee095cd7d15ed",
      "original_line" : 3640,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 23,
      "pull_request_review_id" : 504350760,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20027",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-08T00:14:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/501380053",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   }
]
