[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5993#discussion_r28135098"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5993"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/28135098"
         }
      },
      "body" : "Given that you're changing the function, can you also pass const CChainParams& params ? ",
      "commit_id" : "8ea15d0154c63b622c09d20dc2b3f6d517624f5e",
      "created_at" : "2015-04-10T10:29:58Z",
      "diff_hunk" : "@@ -81,13 +81,10 @@ class TxPriorityCompare\n void UpdateTime(CBlockHeader* pblock, const CBlockIndex* pindexPrev)\n {\n     pblock->nTime = std::max(pindexPrev->GetMedianTimePast()+1, GetAdjustedTime());\n-\n-    // Updating time can change work required on testnet:\n-    if (Params().AllowMinDifficultyBlocks())\n-        pblock->nBits = GetNextWorkRequired(pindexPrev, pblock, Params().GetConsensus());\n+    pblock->nBits = GetNextWorkRequired(pindexPrev, pblock, Params().GetConsensus());\n }\n \n-CBlockTemplate* CreateNewBlock(const CScript& scriptPubKeyIn)\n+CBlockTemplate* CreateNewBlock(const CScript& scriptPubKeyIn, CBlockIndex*& pindexPrev)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5993#discussion_r28135098",
      "id" : 28135098,
      "original_commit_id" : "8ea15d0154c63b622c09d20dc2b3f6d517624f5e",
      "original_position" : 12,
      "path" : "src/miner.cpp",
      "position" : 12,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5993",
      "updated_at" : "2015-04-10T10:29:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/28135098",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5993#discussion_r28135210"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5993"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/28135210"
         }
      },
      "body" : "Is it really that important to pass uint256& hash ? Maybe better to pass CBlock *pblock directly is cleaner?",
      "commit_id" : "8ea15d0154c63b622c09d20dc2b3f6d517624f5e",
      "created_at" : "2015-04-10T10:32:34Z",
      "diff_hunk" : "@@ -435,6 +421,36 @@ static bool ProcessBlockFound(CBlock* pblock, CWallet& wallet, CReserveKey& rese\n     return true;\n }\n \n+bool MineBlock(CReserveKey& reservekey, uint256& hash)\n+{\n+    unsigned int nExtraNonce = 0;\n+\n+    while (true) {\n+        CBlockIndex *pindexPrev = NULL;\n+\n+        auto_ptr<CBlockTemplate> pblocktemplate(CreateNewBlockWithKey(reservekey, pindexPrev));\n+        if (!pblocktemplate.get()) {\n+            return false;\n+        }\n+\n+        CBlock *pblock = &pblocktemplate->block;\n+        IncrementExtraNonce(pblock, pindexPrev, nExtraNonce);\n+\n+        while (true) {\n+            if (ScanHash(pblock, pindexPrev, 0x1000)) {\n+                CValidationState state;\n+                if (ProcessNewBlock(state, NULL, pblock)) {\n+                    hash = pblock->GetHash();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5993#discussion_r28135210",
      "id" : 28135210,
      "original_commit_id" : "8ea15d0154c63b622c09d20dc2b3f6d517624f5e",
      "original_position" : 118,
      "path" : "src/miner.cpp",
      "position" : 118,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5993",
      "updated_at" : "2015-04-10T10:33:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/28135210",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5993#discussion_r28135321"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5993"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/28135321"
         }
      },
      "body" : "Not worth copying a whole block, imho...",
      "commit_id" : "8ea15d0154c63b622c09d20dc2b3f6d517624f5e",
      "created_at" : "2015-04-10T10:35:14Z",
      "diff_hunk" : "@@ -435,6 +421,36 @@ static bool ProcessBlockFound(CBlock* pblock, CWallet& wallet, CReserveKey& rese\n     return true;\n }\n \n+bool MineBlock(CReserveKey& reservekey, uint256& hash)\n+{\n+    unsigned int nExtraNonce = 0;\n+\n+    while (true) {\n+        CBlockIndex *pindexPrev = NULL;\n+\n+        auto_ptr<CBlockTemplate> pblocktemplate(CreateNewBlockWithKey(reservekey, pindexPrev));\n+        if (!pblocktemplate.get()) {\n+            return false;\n+        }\n+\n+        CBlock *pblock = &pblocktemplate->block;\n+        IncrementExtraNonce(pblock, pindexPrev, nExtraNonce);\n+\n+        while (true) {\n+            if (ScanHash(pblock, pindexPrev, 0x1000)) {\n+                CValidationState state;\n+                if (ProcessNewBlock(state, NULL, pblock)) {\n+                    hash = pblock->GetHash();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5993#discussion_r28135321",
      "id" : 28135321,
      "original_commit_id" : "8ea15d0154c63b622c09d20dc2b3f6d517624f5e",
      "original_position" : 118,
      "path" : "src/miner.cpp",
      "position" : 118,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5993",
      "updated_at" : "2015-04-10T10:35:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/28135321",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5993#discussion_r28135398"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5993"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/28135398"
         }
      },
      "body" : "The problem wasn't accesing the nonce inside scanhash but outside of it, so passing ```int64_t nMaxIter``` doesn't solve it. It is this while (and the one inside mineblock that should turn in to fors). In the case of regtest, updating the extra nonce every time scanhash fails is probably good enough, as in https://github.com/bitcoin/bitcoin/pull/4793/files#diff-c2c990fee1c3381462640e80ae7db0d0R156",
      "commit_id" : "8ea15d0154c63b622c09d20dc2b3f6d517624f5e",
      "created_at" : "2015-04-10T10:37:34Z",
      "diff_hunk" : "@@ -476,52 +492,28 @@ void static BitcoinMiner(CWallet *pwallet)\n             // Search\n             //\n             int64_t nStart = GetTime();\n-            arith_uint256 hashTarget = arith_uint256().SetCompact(pblock->nBits);\n-            uint256 hash;\n-            uint32_t nNonce = 0;\n             while (true) {\n                 // Check if something found\n-                if (ScanHash(pblock, nNonce, &hash))\n-                {\n-                    if (UintToArith256(hash) <= hashTarget)\n-                    {\n-                        // Found a solution\n-                        pblock->nNonce = nNonce;\n-                        assert(hash == pblock->GetHash());\n-\n-                        SetThreadPriority(THREAD_PRIORITY_NORMAL);\n-                        LogPrintf(\"BitcoinMiner:\\n\");\n-                        LogPrintf(\"proof-of-work found  \\n  hash: %s  \\ntarget: %s\\n\", hash.GetHex(), hashTarget.GetHex());\n-                        ProcessBlockFound(pblock, *pwallet, reservekey);\n-                        SetThreadPriority(THREAD_PRIORITY_LOWEST);\n-\n-                        // In regression test mode, stop mining after a block is found.\n-                        if (Params().MineBlocksOnDemand())\n-                            throw boost::thread_interrupted();\n+                if (ScanHash(pblock, pindexPrev, 0x1000)) {\n+                    SetThreadPriority(THREAD_PRIORITY_NORMAL);\n+                    LogPrintf(\"BitcoinMiner:\\n\");\n+                    LogPrintf(\"proof-of-work found  \\n\");\n+                    ProcessBlockFound(pblock, *pwallet, reservekey);\n+                    SetThreadPriority(THREAD_PRIORITY_LOWEST);\n \n-                        break;\n-                    }\n+                    break;\n                 }\n-\n-                // Check for stop or if block needs to be rebuilt\n                 boost::this_thread::interruption_point();\n+\n                 // Regtest mode doesn't require peers\n                 if (vNodes.empty() && Params().MiningRequiresPeers())\n                     break;\n-                if (nNonce >= 0xffff0000)\n+                if (pblock->nNonce >= 0xffff0000)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5993#discussion_r28135398",
      "id" : 28135398,
      "original_commit_id" : "8ea15d0154c63b622c09d20dc2b3f6d517624f5e",
      "original_position" : 189,
      "path" : "src/miner.cpp",
      "position" : 189,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5993",
      "updated_at" : "2015-04-10T10:37:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/28135398",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5993#discussion_r28135436"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5993"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/28135436"
         }
      },
      "body" : "Can you replace this with CheckProofOfWork directly?\r\nMaybe with ```if (((uint16_t*)&hash)[15] == 0 && CheckProofOfWork(pblock->GetHash(), pblock->nBits, params))``` as in https://github.com/bitcoin/bitcoin/pull/4793/files#diff-4a59b408ad3778278c3aeffa7da33c3cR384 ?",
      "commit_id" : "8ea15d0154c63b622c09d20dc2b3f6d517624f5e",
      "created_at" : "2015-04-10T10:38:38Z",
      "diff_hunk" : "@@ -364,46 +360,36 @@ void IncrementExtraNonce(CBlock* pblock, CBlockIndex* pindexPrev, unsigned int&\n //\n \n //\n-// ScanHash scans nonces looking for a hash with at least some zero bits.\n-// The nonce is usually preserved between calls, but periodically or if the\n-// nonce is 0xffff0000 or above, the block is rebuilt and nNonce starts over at\n-// zero.\n+// ScanHash iterates up to nMaxIter nonces in order to find a block with\n+// valid proof of work. It returns false after that.\n //\n-bool static ScanHash(const CBlockHeader *pblock, uint32_t& nNonce, uint256 *phash)\n+bool static ScanHash(CBlockHeader *pblock, CBlockIndex *pindexPrev, int64_t nMaxIter)\n {\n-    // Write the first 76 bytes of the block header to a double-SHA256 state.\n-    CHash256 hasher;\n-    CDataStream ss(SER_NETWORK, PROTOCOL_VERSION);\n-    ss << *pblock;\n-    assert(ss.size() == 80);\n-    hasher.Write((unsigned char*)&ss[0], 76);\n+    UpdateTime(pblock, pindexPrev);\n \n-    while (true) {\n-        nNonce++;\n+    uint256 hash;\n+    arith_uint256 hashTarget = arith_uint256().SetCompact(pblock->nBits);\n \n-        // Write the last 4 bytes of the block header (the nonce) to a copy of\n-        // the double-SHA256 state, and compute the result.\n-        CHash256(hasher).Write((unsigned char*)&nNonce, 4).Finalize((unsigned char*)phash);\n+    while (nMaxIter--) {\n+        pblock->nNonce++;\n+        hash = pblock->GetHash();\n \n-        // Return the nonce if the hash has at least some zero bits,\n-        // caller will check if it has enough to reach the target\n-        if (((uint16_t*)phash)[15] == 0)\n+        if (UintToArith256(hash) <= hashTarget)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5993#discussion_r28135436",
      "id" : 28135436,
      "original_commit_id" : "8ea15d0154c63b622c09d20dc2b3f6d517624f5e",
      "original_position" : 70,
      "path" : "src/miner.cpp",
      "position" : 70,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5993",
      "updated_at" : "2015-04-10T10:38:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/28135436",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   }
]
