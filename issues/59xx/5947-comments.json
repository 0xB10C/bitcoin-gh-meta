[
   {
      "body" : "As suggested by @gmaxwell : changed names from \"SybilCheck\" to \"PartitionCheck\"\r\n\r\nHe also suggested replacing the boost::math::poisson calculations with hard-coded constants to get rid of the dependency on boost/math/distributions. I think the purpose of the code is clearer doing the calculations here, and it is easier to update if \"we\" decide that 4 hours or 1-false-positive-in-50-years either need to change or need to become command-line params.\r\n\r\n@sipa volunteered in IRC to write a little scheduler to avoid the VM overhead of another boost::thread, this will be rebased if that happens.\r\n",
      "created_at" : "2015-03-26T18:40:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5947#issuecomment-86663033",
      "id" : 86663033,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5947",
      "updated_at" : "2015-03-26T18:40:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/86663033",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/5947#discussion_r27348055"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5947"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/27348055"
         }
      },
      "body" : "The chain target spacing doesn't matter, only the independent sample interval.  You are taking an independent sample every SPAN_SECONDS, so this should be\r\n```c++\r\ndouble alertThreshold = 1.0 / (FIFTY_YEARS / SPAN_SECONDS);\r\n```\r\nThis works out to 5 or fewer, or 48 or more blocks.  It might be worth randomly using a higher p-value, so an attacker doesn't know exactly what to target.",
      "commit_id" : "687fc39bccdd5cb8a2d6e34e2566da7a90c1425d",
      "created_at" : "2015-03-28T20:10:56Z",
      "diff_hunk" : "@@ -1670,6 +1671,63 @@ void ThreadScriptCheck() {\n     scriptcheckqueue.Thread();\n }\n \n+//\n+// Called periodically asynchronously; alerts if it smells like\n+// we're being fed a bad chain (blocks being generated much\n+// too slowly or too quickly).\n+//\n+void ThreadPartitionCheck(bool (*initialDownloadCheck)(), CCriticalSection& cs, const CChain& chain, const CChainParams& params) {\n+    if (initialDownloadCheck()) return;\n+\n+    static int64_t lastAlertTime = 0;\n+    int64_t now = GetAdjustedTime();\n+    if (lastAlertTime > now-60*60*24) return; // Alert at most once per day\n+\n+    const int SPAN_HOURS=4;\n+    const int SPAN_SECONDS=SPAN_HOURS*60*60;\n+    int BLOCKS_EXPECTED = SPAN_SECONDS / params.TargetSpacing();\n+\n+    boost::math::poisson_distribution<double> poisson(BLOCKS_EXPECTED);\n+\n+    std::string strWarning;\n+    int64_t startTime = GetAdjustedTime()-SPAN_SECONDS;\n+\n+    LOCK(cs);\n+    int h = chain.Height();\n+    while (h > 0 && chain[h]->GetBlockTime() >= startTime)\n+        --h;\n+    int nBlocks = chain.Height()-h;\n+\n+    // How likely is it to find that many by chance?\n+    double p = boost::math::pdf(poisson, nBlocks);\n+\n+    LogPrint(\"partitioncheck\", \"%s : Found %d blocks in the last %d hours\\n\", __func__, nBlocks, SPAN_HOURS);\n+    LogPrint(\"partitioncheck\", \"%s : likelihood: %g\\n\", __func__, p);\n+\n+    // Aim for one false-positive about every fifty years of normal running:\n+    const int FIFTY_YEARS = 50*365*24*60*60;\n+    double alertThreshold = 1.0 / (FIFTY_YEARS / params.TargetSpacing());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5947#discussion_r27348055",
      "id" : 27348055,
      "original_commit_id" : "687fc39bccdd5cb8a2d6e34e2566da7a90c1425d",
      "original_position" : 47,
      "path" : "src/main.cpp",
      "position" : 47,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/5947",
      "updated_at" : "2015-03-28T20:10:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/27348055",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4284124?v=3",
         "events_url" : "https://api.github.com/users/dgenr8/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dgenr8/followers",
         "following_url" : "https://api.github.com/users/dgenr8/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dgenr8/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dgenr8",
         "id" : 4284124,
         "login" : "dgenr8",
         "organizations_url" : "https://api.github.com/users/dgenr8/orgs",
         "received_events_url" : "https://api.github.com/users/dgenr8/received_events",
         "repos_url" : "https://api.github.com/users/dgenr8/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dgenr8/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dgenr8/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dgenr8"
      }
   },
   {
      "body" : "Fixed the threshold calculation (thanks @dgenr8 ).  RE: making the threshold semi-random so attackers don't know exactly what block generation rate to target: block-finding is already a random process, I don't think we need to add more randomness; or, in other words, unless the attacker has an absolutely astounding amount of hashing power (in which case all sorts of assumptions fall apart) their block generation rate will be random anyway.\r\n",
      "created_at" : "2015-03-30T18:05:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5947#issuecomment-87775930",
      "id" : 87775930,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5947",
      "updated_at" : "2015-03-30T18:05:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/87775930",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "body" : "@gavinandresen Ok, it was just a \"random\" idea anyway ;)",
      "created_at" : "2015-03-30T21:01:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5947#issuecomment-87830343",
      "id" : 87830343,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5947",
      "updated_at" : "2015-03-30T21:01:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/87830343",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4284124?v=3",
         "events_url" : "https://api.github.com/users/dgenr8/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dgenr8/followers",
         "following_url" : "https://api.github.com/users/dgenr8/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dgenr8/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dgenr8",
         "id" : 4284124,
         "login" : "dgenr8",
         "organizations_url" : "https://api.github.com/users/dgenr8/orgs",
         "received_events_url" : "https://api.github.com/users/dgenr8/received_events",
         "repos_url" : "https://api.github.com/users/dgenr8/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dgenr8/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dgenr8/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dgenr8"
      }
   },
   {
      "body" : "Tweaked to use CScheduler from #5964 instead of spawning Yet Another Thread.",
      "created_at" : "2015-04-02T18:25:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5947#issuecomment-89000579",
      "id" : 89000579,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5947",
      "updated_at" : "2015-04-02T18:25:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/89000579",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "body" : "Looks like the earlier tweak was lost in the rebase.",
      "created_at" : "2015-04-04T04:00:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5947#issuecomment-89497144",
      "id" : 89497144,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5947",
      "updated_at" : "2015-04-04T04:00:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/89497144",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4284124?v=3",
         "events_url" : "https://api.github.com/users/dgenr8/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dgenr8/followers",
         "following_url" : "https://api.github.com/users/dgenr8/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dgenr8/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dgenr8",
         "id" : 4284124,
         "login" : "dgenr8",
         "organizations_url" : "https://api.github.com/users/dgenr8/orgs",
         "received_events_url" : "https://api.github.com/users/dgenr8/received_events",
         "repos_url" : "https://api.github.com/users/dgenr8/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dgenr8/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dgenr8/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dgenr8"
      }
   },
   {
      "body" : "Tweak re-applied; I'm going to wait for #5964 to get merged before rebasing to fix the merge conflict.\r\n",
      "created_at" : "2015-04-10T17:00:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/5947#issuecomment-91621753",
      "id" : 91621753,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5947",
      "updated_at" : "2015-04-10T17:00:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/91621753",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   }
]
