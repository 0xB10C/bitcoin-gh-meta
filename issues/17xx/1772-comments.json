[
   {
      "body" : "Maybe we should not call select at all when there is no work to do? (ie, hSocketMax == 0). Or am I overlooking something?\n\nEdit: I think I am. Select without fds should effectively be a sleep() of the specified duration. So why is it returning errors at all?\n\n",
      "created_at" : "2012-09-02T06:51:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1772#issuecomment-8219507",
      "id" : 8219507,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1772",
      "updated_at" : "2012-09-02T06:54:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/8219507",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "select returns 10022, when the 3 fds parameters are 0, which is the case when we have no net or a faulty proxy was supplied.",
      "created_at" : "2012-09-02T09:50:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1772#issuecomment-8220433",
      "id" : 8220433,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1772",
      "updated_at" : "2012-09-02T09:50:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/8220433",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "body" : "But does it still pause for the \"timeout\" duration in that case? Or is it a busy loop, erroring out immediately and causing 100% CPU usage?",
      "created_at" : "2012-09-02T10:24:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1772#issuecomment-8220639",
      "id" : 8220639,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1772",
      "updated_at" : "2012-09-02T10:25:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/8220639",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "``int nSelect = select(hSocketMax + 1, &fdsetRecv, &fdsetSend, &fdsetError, &timeout);``\n\nThe timeout parameter defines the maximum time for ``select()`` to wait, but when we have a failed net all fdsetX variables have their .fd_count set to 0 and so I assume select fails imediately.\n\nBut we have a timeout some lines below ``Sleep(timeout.tv_usec/1000);``, which prevents a 100% CPU usage IMO.\n\nEdit: And I can confirm, that Qt nearly idles, when I have set a non working proxy.",
      "created_at" : "2012-09-02T11:04:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1772#issuecomment-8220879",
      "id" : 8220879,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1772",
      "updated_at" : "2012-09-02T11:05:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/8220879",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "body" : "Perhaps @sipa can comment here and ACK or suggest a better solution?",
      "created_at" : "2012-09-02T11:19:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1772#issuecomment-8220967",
      "id" : 8220967,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1772",
      "updated_at" : "2012-09-02T11:19:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/8220967",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "body" : "Ok, the timeout is already OK. Hadn't seen that.\n",
      "created_at" : "2012-09-02T11:30:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1772#issuecomment-8221027",
      "id" : 8221027,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1772",
      "updated_at" : "2012-09-04T17:28:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/8221027",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "@gmaxwell @sipa and others...\nCan another core dev please take a look and ACK this one? As a fix I would like to see it in the next RC.",
      "created_at" : "2012-09-04T16:06:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1772#issuecomment-8268668",
      "id" : 8268668,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1772",
      "updated_at" : "2012-09-04T16:06:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/8268668",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/1772#discussion_r1525240"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/1772"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1525240"
         }
      },
      "body" : "BTW this <= here is interesting.\n\nhSocketMax is the *maximum* socket number. Which means that, if it is 0 (which it is initialized with), we still pass 1 into select (which  has a parameter \"maximum fd+1\", not \"maximum fd\"). \n\nSo what happens if there is nothing to do? hSocketMax will be 0, however 1 will be passed into select, even though no fds have been set with FD_SET.\n\nHmm the code is fishy. Maybe we should track the maximum of (hSocket+1) instead of hSocket, so we can distinguish the cases *only fd 0 set* and *no fds set*. This also means that we don't have to increase the number before passing it into select.\n",
      "commit_id" : "8207857f401bc1a48f863be646c5a508a7cdfe9c",
      "created_at" : "2012-09-04T17:26:59Z",
      "diff_hunk" : "@@ -781,10 +781,9 @@ void ThreadSocketHandler2(void* parg)\n             return;\n         if (nSelect == SOCKET_ERROR)\n         {\n-            int nErr = WSAGetLastError();\n-            if (hSocketMax != INVALID_SOCKET)\n+            if ((hSocketMax != INVALID_SOCKET) && (hSocketMax != (SOCKET)0))\n             {\n-                printf(\"socket select error %d\\n\", nErr);\n+                printf(\"socket select error %d\\n\", WSAGetLastError());\n                 for (unsigned int i = 0; i <= hSocketMax; i++)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1772#discussion_r1525240",
      "id" : 1525240,
      "original_commit_id" : "8207857f401bc1a48f863be646c5a508a7cdfe9c",
      "original_position" : 10,
      "path" : "src/net.cpp",
      "position" : 10,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/1772",
      "updated_at" : "2012-09-04T17:44:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1525240",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/1772#discussion_r1526844"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/1772"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1526844"
         }
      },
      "body" : "At least on Windows, the first parameter of select is ignored ``nfds [in] Ignored. The nfds parameter is included only for compatibility with Berkeley sockets.``, which should be no cause for an error then.\n\nSo hSocketMax is 0, when hListenSocket is 0 or all pnode->hSocket are 0. This results in all fdset vars to contain .fd_count == 0, which results in the select() 10022 error code (``The time-out value is not valid, or all three descriptor parameters were null.``).\n\nThe longer I think about it, the more I feel like NOT calling select() when all fdset vars are empty, which of course is perhaps more expensive in that part of the code, then simply ignoring 10022 - via a check for hSocketMax == 0, which is true, when there are simply none ;).\n\nEdit: That is such a part in the code, where I'm really missing more documentation :-D!",
      "commit_id" : "8207857f401bc1a48f863be646c5a508a7cdfe9c",
      "created_at" : "2012-09-04T19:44:10Z",
      "diff_hunk" : "@@ -781,10 +781,9 @@ void ThreadSocketHandler2(void* parg)\n             return;\n         if (nSelect == SOCKET_ERROR)\n         {\n-            int nErr = WSAGetLastError();\n-            if (hSocketMax != INVALID_SOCKET)\n+            if ((hSocketMax != INVALID_SOCKET) && (hSocketMax != (SOCKET)0))\n             {\n-                printf(\"socket select error %d\\n\", nErr);\n+                printf(\"socket select error %d\\n\", WSAGetLastError());\n                 for (unsigned int i = 0; i <= hSocketMax; i++)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1772#discussion_r1526844",
      "id" : 1526844,
      "original_commit_id" : "8207857f401bc1a48f863be646c5a508a7cdfe9c",
      "original_position" : 10,
      "path" : "src/net.cpp",
      "position" : 10,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/1772",
      "updated_at" : "2012-09-04T19:47:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1526844",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/1772#discussion_r1526899"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/1772"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1526899"
         }
      },
      "body" : "The point is that we currently cannot distinguish between *no fds* and *a single fd, 0*. Which is wrong. If you make hSocketMax to be max(hSocket+1) this is easy to detect, as the value will be 0 for no fds and 1 for the single fd 0 case. And as a plus, we then pass the correct nfds on UNIX in both cases.\n\n(also, if you do that, you could decide to skip the select when hSocketMax==0. You cannot do so right now, as it has two meanings and thus is ambigious)\n",
      "commit_id" : "8207857f401bc1a48f863be646c5a508a7cdfe9c",
      "created_at" : "2012-09-04T19:51:53Z",
      "diff_hunk" : "@@ -781,10 +781,9 @@ void ThreadSocketHandler2(void* parg)\n             return;\n         if (nSelect == SOCKET_ERROR)\n         {\n-            int nErr = WSAGetLastError();\n-            if (hSocketMax != INVALID_SOCKET)\n+            if ((hSocketMax != INVALID_SOCKET) && (hSocketMax != (SOCKET)0))\n             {\n-                printf(\"socket select error %d\\n\", nErr);\n+                printf(\"socket select error %d\\n\", WSAGetLastError());\n                 for (unsigned int i = 0; i <= hSocketMax; i++)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1772#discussion_r1526899",
      "id" : 1526899,
      "original_commit_id" : "8207857f401bc1a48f863be646c5a508a7cdfe9c",
      "original_position" : 10,
      "path" : "src/net.cpp",
      "position" : 10,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/1772",
      "updated_at" : "2012-09-04T19:51:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1526899",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/1772#discussion_r1527124"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/1772"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1527124"
         }
      },
      "body" : "I'm thinking for minutes now, but have no clue, where you would like to place max(hSocket + 1) or do you mean max(hSocketMax, hSocket + 1)? And even then it makes no sense yet...",
      "commit_id" : "8207857f401bc1a48f863be646c5a508a7cdfe9c",
      "created_at" : "2012-09-04T20:14:15Z",
      "diff_hunk" : "@@ -781,10 +781,9 @@ void ThreadSocketHandler2(void* parg)\n             return;\n         if (nSelect == SOCKET_ERROR)\n         {\n-            int nErr = WSAGetLastError();\n-            if (hSocketMax != INVALID_SOCKET)\n+            if ((hSocketMax != INVALID_SOCKET) && (hSocketMax != (SOCKET)0))\n             {\n-                printf(\"socket select error %d\\n\", nErr);\n+                printf(\"socket select error %d\\n\", WSAGetLastError());\n                 for (unsigned int i = 0; i <= hSocketMax; i++)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1772#discussion_r1527124",
      "id" : 1527124,
      "original_commit_id" : "8207857f401bc1a48f863be646c5a508a7cdfe9c",
      "original_position" : 10,
      "path" : "src/net.cpp",
      "position" : 10,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/1772",
      "updated_at" : "2012-09-04T20:14:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1527124",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/1772#discussion_r1527218"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/1772"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1527218"
         }
      },
      "body" : "Yes,\n\n    hSocketMax = max(hSocketMax, hListenSocket + 1);\n    ...\n    hSocketMax = max(hSocketMax, pnode->hSocket + 1);\n\nThen change the select line to (ie, remove the + 1)\n\n        int nSelect = select(hSocketMax, &fdsetRecv, &fdsetSend, &fdsetError, &timeout);\n\nAnd change this loop to < i.s.o <=:\n\n                for (unsigned int i = 0; i < hSocketMax; i++)\n                    FD_SET(i, &fdsetRecv);\n\nOnly after that, you can check for hSocketMax==0 and be sure that it means \"no sockets\".\n",
      "commit_id" : "8207857f401bc1a48f863be646c5a508a7cdfe9c",
      "created_at" : "2012-09-04T20:21:28Z",
      "diff_hunk" : "@@ -781,10 +781,9 @@ void ThreadSocketHandler2(void* parg)\n             return;\n         if (nSelect == SOCKET_ERROR)\n         {\n-            int nErr = WSAGetLastError();\n-            if (hSocketMax != INVALID_SOCKET)\n+            if ((hSocketMax != INVALID_SOCKET) && (hSocketMax != (SOCKET)0))\n             {\n-                printf(\"socket select error %d\\n\", nErr);\n+                printf(\"socket select error %d\\n\", WSAGetLastError());\n                 for (unsigned int i = 0; i <= hSocketMax; i++)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1772#discussion_r1527218",
      "id" : 1527218,
      "original_commit_id" : "8207857f401bc1a48f863be646c5a508a7cdfe9c",
      "original_position" : 10,
      "path" : "src/net.cpp",
      "position" : 10,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/1772",
      "updated_at" : "2012-09-04T20:21:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1527218",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/1772#discussion_r1527632"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/1772"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1527632"
         }
      },
      "body" : "I found out that setting an invalid -proxy leads to not even entering the BOOST_FOREACH loops, as vhListenSocket and vNodes are empty. That means hSocketMax simply keeps the init value of 0, which leads to 10022 spam.\n\nI also did some research for the first select()-parameter and found this:\n<pre>The first parameter to select() is the maximum file descriptor that is set in the structs PLUS ONE. That is, if you have 20 file descriptors in the sets, and the maximum value a file descriptor has is 123, then the value passed as the first parameter must be 124.</pre>\nThis makes me think the + 1 before hSocketMax in select() is indeed correct and valid.",
      "commit_id" : "8207857f401bc1a48f863be646c5a508a7cdfe9c",
      "created_at" : "2012-09-04T20:50:37Z",
      "diff_hunk" : "@@ -781,10 +781,9 @@ void ThreadSocketHandler2(void* parg)\n             return;\n         if (nSelect == SOCKET_ERROR)\n         {\n-            int nErr = WSAGetLastError();\n-            if (hSocketMax != INVALID_SOCKET)\n+            if ((hSocketMax != INVALID_SOCKET) && (hSocketMax != (SOCKET)0))\n             {\n-                printf(\"socket select error %d\\n\", nErr);\n+                printf(\"socket select error %d\\n\", WSAGetLastError());\n                 for (unsigned int i = 0; i <= hSocketMax; i++)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1772#discussion_r1527632",
      "id" : 1527632,
      "original_commit_id" : "8207857f401bc1a48f863be646c5a508a7cdfe9c",
      "original_position" : 10,
      "path" : "src/net.cpp",
      "position" : 10,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/1772",
      "updated_at" : "2012-09-04T20:51:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1527632",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/1772#discussion_r1527717"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/1772"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1527717"
         }
      },
      "body" : "Yes, that's what I am trying to say all the time. The +1 is valid, however\nit is better to do it at different places, so you can distinguish between\nthe two conditions that I mentioned. Currently you *can not* reliably\ndetect the condition that causes the error.",
      "commit_id" : "8207857f401bc1a48f863be646c5a508a7cdfe9c",
      "created_at" : "2012-09-04T20:55:59Z",
      "diff_hunk" : "@@ -781,10 +781,9 @@ void ThreadSocketHandler2(void* parg)\n             return;\n         if (nSelect == SOCKET_ERROR)\n         {\n-            int nErr = WSAGetLastError();\n-            if (hSocketMax != INVALID_SOCKET)\n+            if ((hSocketMax != INVALID_SOCKET) && (hSocketMax != (SOCKET)0))\n             {\n-                printf(\"socket select error %d\\n\", nErr);\n+                printf(\"socket select error %d\\n\", WSAGetLastError());\n                 for (unsigned int i = 0; i <= hSocketMax; i++)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1772#discussion_r1527717",
      "id" : 1527717,
      "original_commit_id" : "8207857f401bc1a48f863be646c5a508a7cdfe9c",
      "original_position" : 10,
      "path" : "src/net.cpp",
      "position" : 10,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/1772",
      "updated_at" : "2012-09-04T20:55:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1527717",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/1772#discussion_r1527978"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/1772"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1527978"
         }
      },
      "body" : "When I now read the first comment all that makes sense ^^ you are such a patient person :-P.\n\nWith your new code we would pass hSocketMax == 0 to select(), when -proxy is invalid (no BOOST_FOREACH pass), I'm not sure if this is valid. But you are right, when hSocketMax stays 0, we have no fds set, but I'm not sure if it can ever become 1. It would be 1, if vhListenSocket or vNodes is not empty and the contained sockets are == 0.\n\nvhListenSocket is empty, when we are not listening and vNodes if we are not connected to any peers IMO.",
      "commit_id" : "8207857f401bc1a48f863be646c5a508a7cdfe9c",
      "created_at" : "2012-09-04T21:23:01Z",
      "diff_hunk" : "@@ -781,10 +781,9 @@ void ThreadSocketHandler2(void* parg)\n             return;\n         if (nSelect == SOCKET_ERROR)\n         {\n-            int nErr = WSAGetLastError();\n-            if (hSocketMax != INVALID_SOCKET)\n+            if ((hSocketMax != INVALID_SOCKET) && (hSocketMax != (SOCKET)0))\n             {\n-                printf(\"socket select error %d\\n\", nErr);\n+                printf(\"socket select error %d\\n\", WSAGetLastError());\n                 for (unsigned int i = 0; i <= hSocketMax; i++)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1772#discussion_r1527978",
      "id" : 1527978,
      "original_commit_id" : "8207857f401bc1a48f863be646c5a508a7cdfe9c",
      "original_position" : 10,
      "path" : "src/net.cpp",
      "position" : 10,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/1772",
      "updated_at" : "2012-09-04T21:45:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1527978",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "body" : "hSocketMax+1 is not valid, when zero FDs are in the fd set.\nhSocketMax+1 is valid when fds are set.\n\nWe should not be passing \"nfds == 1\" to select, when that is clearly not the case.  That is the bug that must be fixed here.\n\nWe always pass a timeout, therefore select always has \"work\" even if zero fds are indicated.\n",
      "created_at" : "2012-09-05T03:04:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1772#issuecomment-8286351",
      "id" : 8286351,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1772",
      "updated_at" : "2012-09-05T03:04:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/8286351",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "body" : "Can you test and verify that #1786 addresses your problem (or at least changes the behavior a bit)?",
      "created_at" : "2012-09-05T03:30:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1772#issuecomment-8286681",
      "id" : 8286681,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1772",
      "updated_at" : "2012-09-05T03:30:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/8286681",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "body" : "Automatic sanity-testing: PASSED, see http://jenkins.bluematt.me/pull-tester/8207857f401bc1a48f863be646c5a508a7cdfe9c for binaries and test log.",
      "created_at" : "2012-09-05T12:01:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1772#issuecomment-8295696",
      "id" : 8295696,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1772",
      "updated_at" : "2012-09-05T12:01:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/8295696",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2110907?v=3",
         "events_url" : "https://api.github.com/users/BitcoinPullTester/events{/privacy}",
         "followers_url" : "https://api.github.com/users/BitcoinPullTester/followers",
         "following_url" : "https://api.github.com/users/BitcoinPullTester/following{/other_user}",
         "gists_url" : "https://api.github.com/users/BitcoinPullTester/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/BitcoinPullTester",
         "id" : 2110907,
         "login" : "BitcoinPullTester",
         "organizations_url" : "https://api.github.com/users/BitcoinPullTester/orgs",
         "received_events_url" : "https://api.github.com/users/BitcoinPullTester/received_events",
         "repos_url" : "https://api.github.com/users/BitcoinPullTester/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/BitcoinPullTester/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/BitcoinPullTester/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/BitcoinPullTester"
      }
   },
   {
      "body" : "Closing in favor of #1786!",
      "created_at" : "2012-09-05T20:14:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1772#issuecomment-8312313",
      "id" : 8312313,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1772",
      "updated_at" : "2012-09-05T20:14:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/8312313",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   }
]
