[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10286#discussion_r114424119"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10286"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114424119"
         }
      },
      "body" : "In commit \"Add a CValidationInterface::TransactionRemovedFromMempool\"\r\n\r\nWhat does this imply? Just that if there are any new calls to `addUnchecked`, the caller also needs to signal `TransactionAddedToMempool` not to break the wallet? Would say this in the comment explicitly if this is the case.",
      "commit_id" : "74df7e737b4843e1c9c8828e681a5117b77b7274",
      "created_at" : "2017-05-02T21:01:49Z",
      "diff_hunk" : "@@ -511,6 +511,9 @@ class CTxMemPool\n     // to track size/count of descendant transactions.  First version of\n     // addUnchecked can be used to have it call CalculateMemPoolAncestors(), and\n     // then invoke the second version.\n+    // Note that addUnchecked is ONLY called from ATMP during normal operation,\n+    // and any other callers may break wallet's in-mempool tracking (due to\n+    // lack of CValidationInterface::TransactionAddedToMempool callbacks).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10286#discussion_r114424119",
      "id" : 114424119,
      "original_commit_id" : "1b6b0c9911a7429c001f74d1b58645f0716988fb",
      "original_position" : 6,
      "path" : "src/txmempool.h",
      "position" : null,
      "pull_request_review_id" : 35889308,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10286",
      "updated_at" : "2017-05-03T19:20:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114424119",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10286#discussion_r114424864"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10286"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114424864"
         }
      },
      "body" : "In commit \"Add a CValidationInterface::TransactionRemovedFromMempool\"\r\n\r\nUnclear to me what a normal operation is. Comment might be clearer mentioning a not normal counterexample.",
      "commit_id" : "74df7e737b4843e1c9c8828e681a5117b77b7274",
      "created_at" : "2017-05-02T21:05:07Z",
      "diff_hunk" : "@@ -511,6 +511,9 @@ class CTxMemPool\n     // to track size/count of descendant transactions.  First version of\n     // addUnchecked can be used to have it call CalculateMemPoolAncestors(), and\n     // then invoke the second version.\n+    // Note that addUnchecked is ONLY called from ATMP during normal operation,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10286#discussion_r114424864",
      "id" : 114424864,
      "original_commit_id" : "1b6b0c9911a7429c001f74d1b58645f0716988fb",
      "original_position" : 4,
      "path" : "src/txmempool.h",
      "position" : null,
      "pull_request_review_id" : 35889308,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10286",
      "updated_at" : "2017-05-03T19:20:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114424864",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10286#discussion_r114427322"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10286"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114427322"
         }
      },
      "body" : "In commit \"Add CWallet::BlockUntilSyncedToCurrentChain()\"\r\n\r\nDoes \"some things might block forever\" just mean this wait might block forever? If so, maybe be more concrete and say something like \"lastBlockProcessed will not be rewound back to chainActive.Tip().\" Otherwise it would be good to clarify what some things is referring to.",
      "commit_id" : "74df7e737b4843e1c9c8828e681a5117b77b7274",
      "created_at" : "2017-05-02T21:16:09Z",
      "diff_hunk" : "@@ -1150,6 +1156,50 @@ void CWallet::BlockDisconnected(const std::shared_ptr<const CBlock>& pblock) {\n \n \n \n+void CWallet::BlockUntilSyncedToCurrentChain() {\n+    const CBlockIndex* initialChainTip;\n+    {\n+        LOCK(cs_main);\n+        initialChainTip = chainActive.Tip();\n+    }\n+    AssertLockNotHeld(cs_main);\n+    AssertLockNotHeld(cs_wallet);\n+    std::unique_lock<std::mutex> lock(lastBlockProcessedMutex);\n+\n+    assert(lastBlockProcessed);\n+\n+    auto pred = [this, initialChainTip] {\n+            if (this->lastBlockProcessed == initialChainTip) {\n+                return true;\n+            }\n+            if (this->lastBlockProcessed->GetAncestor(initialChainTip->nHeight) == initialChainTip) {\n+                return true;\n+            }\n+            // Catch the race condition where the wallet may have caught up and\n+            // moved past initialChainTip through a reorg before we could get\n+            // lastBlockProcessedMutex.\n+            // This should be exceedingly rare in regular usage, so potentially\n+            // eating 100ms to retry this lock should be fine (not TRY_LOCKing\n+            // here would be a lock inversion against lastBlockProcessedMutex)\n+            TRY_LOCK(cs_main, mainLocked);\n+            if (mainLocked) {\n+                if (this->lastBlockProcessed == chainActive.Tip()) {\n+                    return true;\n+                }\n+                // If the user called invalidatechain some things might block",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10286#discussion_r114427322",
      "id" : 114427322,
      "original_commit_id" : "f651d58a3b841ff7d8e4917881da6f6a8f8ec42f",
      "original_position" : 47,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 35889308,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10286",
      "updated_at" : "2017-05-03T19:20:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114427322",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10286#discussion_r114427544"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10286"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114427544"
         }
      },
      "body" : "In commit \"Add CWallet::BlockUntilSyncedToCurrentChain()\"\r\n\r\nStray tab here",
      "commit_id" : "74df7e737b4843e1c9c8828e681a5117b77b7274",
      "created_at" : "2017-05-02T21:17:11Z",
      "diff_hunk" : "@@ -1108,6 +1117,14 @@ class CWallet : public CCryptoKeyStore, public CValidationInterface\n        If possibleOldChain is provided, the parameters from the old chain (version)\n        will be preserved. */\n     bool SetHDMasterKey(const CPubKey& key, CHDChain *possibleOldChain = nullptr);\n+\n+    /**\n+     * Blocks until the wallet state is up-to-date to /at least/ the current\n+     * chain at the time this function is entered\n+     * Obviously holding cs_main/cs_wallet when going into this call may cause\n+\t * deadlock",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10286#discussion_r114427544",
      "id" : 114427544,
      "original_commit_id" : "f651d58a3b841ff7d8e4917881da6f6a8f8ec42f",
      "original_position" : 32,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 35889308,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10286",
      "updated_at" : "2017-05-03T19:20:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114427544",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10286#discussion_r114430207"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10286"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114430207"
         }
      },
      "body" : "In commit \"Add calls to CWallet::BlockUntilSyncedToCurrentChain() in RPCs\"\r\n\r\nCan you give an example of specific bug that could occur without these BlockUntilSynced calls and is prevented by adding them? I looked at some of the old issues (#9584, #9148, etc), but they're confusing and I don't know how much of the information is up to date.\r\n\r\nIt would be great if `BlockUntilSyncedToCurrentChain` had a comment that made it clearer when it does and doesn't need to be called, and what consistency issues it is and isn't supposed to solve.\r\n\r\nMaybe there should also be a bullet point in the new [RPC interface guidelines](https://github.com/bitcoin/bitcoin/blob/master/doc/developer-notes.md#rpc-interface-guidelines) about what kind of consistency wallet RPCs are expected to have.",
      "commit_id" : "74df7e737b4843e1c9c8828e681a5117b77b7274",
      "created_at" : "2017-05-02T21:30:07Z",
      "diff_hunk" : "@@ -2648,6 +2712,10 @@ UniValue fundrawtransaction(const JSONRPCRequest& request)\n \n     RPCTypeCheck(request.params, boost::assign::list_of(UniValue::VSTR));\n \n+    // Make sure the results are valid at least up to the most recent block",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10286#discussion_r114430207",
      "id" : 114430207,
      "original_commit_id" : "ec4df8c633f0297eaa6f74304ad058bb5413a2ee",
      "original_position" : 180,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : 180,
      "pull_request_review_id" : 35889308,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10286",
      "updated_at" : "2017-05-03T19:20:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114430207",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10286#discussion_r114434508"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10286"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114434508"
         }
      },
      "body" : "In commit \"Fix zmq tests now that txn/blocks are unordered\"\r\n\r\nMaybe assert `msg[0] != topic` above this line to confirm actually receive distinct `hashtx` and `hashblock` messages (not two hashblocks).",
      "commit_id" : "74df7e737b4843e1c9c8828e681a5117b77b7274",
      "created_at" : "2017-05-02T21:52:37Z",
      "diff_hunk" : "@@ -56,17 +56,25 @@ def run_test(self):\n         self.log.info(\"listen...\")\n         msg = self.zmqSubSocket.recv_multipart()\n         topic = msg[0]\n-        assert_equal(topic, b\"hashtx\")\n         body = msg[1]\n         msgSequence = struct.unpack('<I', msg[-1])[-1]\n-        assert_equal(msgSequence, 0) #must be sequence 0 on hashtx\n+        assert_equal(msgSequence, 0) #must be sequence 0 on hashtx/block\n+\n+        if topic == b\"hashblock\":\n+            blkhash = bytes_to_hex_str(body)\n+        else:\n+            assert_equal(topic, b\"hashtx\")\n \n         msg = self.zmqSubSocket.recv_multipart()\n         topic = msg[0]",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10286#discussion_r114434508",
      "id" : 114434508,
      "original_commit_id" : "6fb571977d9cc41793a594688e5071dd5bbd864d",
      "original_position" : 16,
      "path" : "test/functional/zmq_test.py",
      "position" : null,
      "pull_request_review_id" : 35889308,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10286",
      "updated_at" : "2017-05-03T19:20:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114434508",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10286#discussion_r114630924"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10286"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114630924"
         }
      },
      "body" : "Updated the comment to mention that addUnchecked is only called from ATMP outside of tests period. I think the implication is that we need to fix the strong-coupling here.",
      "commit_id" : "74df7e737b4843e1c9c8828e681a5117b77b7274",
      "created_at" : "2017-05-03T19:20:18Z",
      "diff_hunk" : "@@ -511,6 +511,9 @@ class CTxMemPool\n     // to track size/count of descendant transactions.  First version of\n     // addUnchecked can be used to have it call CalculateMemPoolAncestors(), and\n     // then invoke the second version.\n+    // Note that addUnchecked is ONLY called from ATMP during normal operation,\n+    // and any other callers may break wallet's in-mempool tracking (due to\n+    // lack of CValidationInterface::TransactionAddedToMempool callbacks).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10286#discussion_r114630924",
      "id" : 114630924,
      "original_commit_id" : "1b6b0c9911a7429c001f74d1b58645f0716988fb",
      "original_position" : 6,
      "path" : "src/txmempool.h",
      "position" : null,
      "pull_request_review_id" : 36113880,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10286",
      "updated_at" : "2017-05-03T19:20:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114630924",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Rebased and fixed @ryanofsky's mostly-comment nits :).",
      "created_at" : "2017-05-03T19:20:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10286#issuecomment-299009278",
      "id" : 299009278,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10286",
      "updated_at" : "2017-05-03T19:20:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/299009278",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   }
]
