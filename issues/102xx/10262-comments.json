[
   {
      "body" : "Same behavior here with builds >12.1\r\nHave a look at https://github.com/bitcoin/bitcoin/issues/9056\r\nIt was closed because of having 8 correct outgoing connections but the real problem was the recover of the dropped incoming connection after the external IP change",
      "created_at" : "2017-04-25T07:19:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/10262#issuecomment-296938684",
      "id" : 296938684,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10262",
      "updated_at" : "2017-04-25T07:19:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/296938684",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/22350883?v=3",
         "events_url" : "https://api.github.com/users/Real-Duke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Real-Duke/followers",
         "following_url" : "https://api.github.com/users/Real-Duke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Real-Duke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Real-Duke",
         "id" : 22350883,
         "login" : "Real-Duke",
         "organizations_url" : "https://api.github.com/users/Real-Duke/orgs",
         "received_events_url" : "https://api.github.com/users/Real-Duke/received_events",
         "repos_url" : "https://api.github.com/users/Real-Duke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Real-Duke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Real-Duke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Real-Duke"
      }
   },
   {
      "body" : "Glad to hear this was observed before. \r\nFor the record, I left my node struggling to establish inbound connections to 8333 for 6 more hours but it never could (it was logging `inv sent in violation of protocol` all the time) so I stopped it.",
      "created_at" : "2017-04-25T10:58:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/10262#issuecomment-296994819",
      "id" : 296994819,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10262",
      "updated_at" : "2017-04-25T10:58:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/296994819",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/13134193?v=3",
         "events_url" : "https://api.github.com/users/unsystemizer/events{/privacy}",
         "followers_url" : "https://api.github.com/users/unsystemizer/followers",
         "following_url" : "https://api.github.com/users/unsystemizer/following{/other_user}",
         "gists_url" : "https://api.github.com/users/unsystemizer/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/unsystemizer",
         "id" : 13134193,
         "login" : "unsystemizer",
         "organizations_url" : "https://api.github.com/users/unsystemizer/orgs",
         "received_events_url" : "https://api.github.com/users/unsystemizer/received_events",
         "repos_url" : "https://api.github.com/users/unsystemizer/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/unsystemizer/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/unsystemizer/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/unsystemizer"
      }
   },
   {
      "body" : "Wait, now I'm confused, incoming or outgoing connections? If your IP changes it is expected that you may not have any incoming connections for a while - no one knows where to connect for some time while your IP propagates around the network. Outgoing is a different story, however.\n\nOn April 23, 2017 5:20:53 AM EDT, unsystemizer <notifications@github.com> wrote:\n>### Describe the issue\n>\n>If External IP changes, server sometimes loses incoming connections\n>until daemon is restarted.\n>\n>### Can you reliably reproduce the issue?\n>\n>Yes, although it can take several attempts.\n>\n>#### If so, please list the steps to reproduce below:\n>\n>1. On the router configure port forwarding to 8333 (TCP & UDP)\n>2. On the server, run `bitcoind -listen=1 -server=1 -upnp=1 -debug=net\n>-onlynet=ipv4 -blocksonly = 1`, then disable pppoe, wait 10 mins,\n>enable it again and wait for it to again receive incoming connections. \n>Sometimes I need to try 2-3 times and wait 10-15 minutes until I\n>re-enable pppoe. I'm not sure if it's simply a matter of trying several\n>times or the length of disconnection.\n>\n>### Expected vs. Actual behaviour\n>\n>Expected: router continues forwarding incoming 8333 to $lan-ip:8333 and\n>bitcoind server continues accepting incoming connections.\n>\n>Actual: `AdvertiseLocal` changes to the new IP and `ProcessMessages`\n>also shows the new external IP address, but incoming connections to\n>bitcoind never recover.  Only outgoing connections to the network\n>recover.\n>\n>### What version of bitcoin-core are you using?\n>\n>* `\"/Satoshi:0.14.1/UASF-Segwit:0.3(BIP148)/\"` (` v0.14.1.0-g1809845`)\n>\n>### Any extra information that might be useful in the debugging\n>process.\n>\n>With Port Forwarding set up, uPnP shouldn't be required. But I tried\n>Port Forwarding alone, same issue.\n>I first built using \"default\" (from build-unix.md) instructions, and\n>then one more time with libupnp explicitly enabled. \n>External port-check to $router-ip:8333 confirms the port is open after\n>router (pppoe) restart.\n>\n>Errors I get after external connections start failing: \n>\n>```\n>2017-04-23 08:29:21 sending headers (82 bytes) peer=22\n>2017-04-23 08:29:21 received: inv (217 bytes) peer=23\n>2017-04-23 08:29:21 got inv: tx\n>8c7eb2218f2440aa729c43ab7ec01a0b4a21967b5cdf6c024989fb2cb73128f3  new\n>peer=23\n>2017-04-23 08:29:21 transaction\n>(8c7eb2218f2440aa729c43ab7ec01a0b4a21967b5cdf6c024989fb2cb73128f3) inv\n>sent in violation of protocol peer=23\n>2017-04-23 08:29:21 got inv: tx\n>c45cd995af1eb3f3e93827d50ce20b497f097ceb11c17786cd279012ada6099b  new\n>peer=23\n>2017-04-23 08:29:21 transaction\n>(c45cd995af1eb3f3e93827d50ce20b497f097ceb11c17786cd279012ada6099b) inv\n>sent in violation of protocol peer=23\n>2017-04-23 08:29:21 got inv: tx\n>55d0122ba1e9ff679ea0faccb03dee635bab4b82f0de10dc642f23ab42b31757  new\n>peer=23\n>2017-04-23 08:29:21 transaction\n>(55d0122ba1e9ff679ea0faccb03dee635bab4b82f0de10dc642f23ab42b31757) inv\n>sent in violation of protocol peer=23\n>2017-04-23 08:29:21 got inv: tx\n>5cc62dd856948bbb208fbf621d2a40b0c7cb290a47589947d7f1a378adac08f3  new\n>peer=23\n>2017-04-23 08:29:21 transaction\n>(5cc62dd856948bbb208fbf621d2a40b0c7cb290a47589947d7f1a378adac08f3) inv\n>sent in violation of protocol peer=23\n>2017-04-23 08:29:21 got inv: tx\n>a0b8c68dfdc0f46be908da01a130c6b7c5fc558eaabf8345c395091e1954ed0c  new\n>peer=23\n>2017-04-23 08:29:21 transaction\n>(a0b8c68dfdc0f46be908da01a130c6b7c5fc558eaabf8345c395091e1954ed0c) inv\n>sent in violation of protocol peer=23\n>2017-04-23 08:29:21 got inv: tx\n>f350743826f242945bd471f584238d95b9b702bb5c2d51e3a152b5e64da92144  new\n>peer=23\n>2017-04-23 08:29:21 transaction\n>(f350743826f242945bd471f584238d95b9b702bb5c2d51e3a152b5e64da92144) inv\n>sent in violation of protocol peer=23\n>```\n>\n>A more detailed log which shows two pppoe restarts (the second attempt\n>was successful) can be found here (free pastebin, so it's going to\n>remain for 30 days):\n>https://pastebin.com/TiYpEnJe\n",
      "created_at" : "2017-04-25T12:25:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/10262#issuecomment-297013616",
      "id" : 297013616,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10262",
      "updated_at" : "2017-04-25T12:25:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/297013616",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Incoming connections are dropped and won't be recovered. Outgoing is fine because you stay with the 8 outgoing connections after an IP change. But normaly within minutes you have also ~6 to 9 incoming connnections again! The longer the node runs it becomes more and more.\r\nI have discovered this on my side with all builds after 0.12.1\r\nMaybe thats the reason why there are still so many 0.12.1 Nodes listened on Bitnodes?\r\nhttps://bitnodes.21.co/nodes/",
      "created_at" : "2017-04-25T19:38:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/10262#issuecomment-297141805",
      "id" : 297141805,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10262",
      "updated_at" : "2017-04-25T19:38:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/297141805",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/22350883?v=3",
         "events_url" : "https://api.github.com/users/Real-Duke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Real-Duke/followers",
         "following_url" : "https://api.github.com/users/Real-Duke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Real-Duke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Real-Duke",
         "id" : 22350883,
         "login" : "Real-Duke",
         "organizations_url" : "https://api.github.com/users/Real-Duke/orgs",
         "received_events_url" : "https://api.github.com/users/Real-Duke/received_events",
         "repos_url" : "https://api.github.com/users/Real-Duke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Real-Duke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Real-Duke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Real-Duke"
      }
   },
   {
      "body" : "@TheBlueMatt - \"Not have any incoming connections for a while\": I left my node online for 7-8 hours after the IP change and it still didn't recover. That seems like \"a while\", but if this isn't considered enough, then it should probably be documented what recovery time is considered reasonable. Although I don't think with 0.14.1 (the one I have now) they ever recover. \r\n\r\nI just looked again:\r\n\r\na) `cat debug.log | grep AdvertiseLocal` - last external IP change (after I submitted this bug report) was almost 3 days ago.\r\n\r\n```\r\n$ cat debug.log | grep AdvertiseLocal\r\n2017-04-23 18:06:58 AdvertiseLocal: advertising address A.B.C.D:8333\r\n$ date\r\nWed Apr 26 03:46:52 UCT 2017\r\n```\r\n\r\nb) Check incoming connections to port 8333 - there are none. Outgoing: 8, all OK.\r\nc) Use bitnodes.21.co to check my node's status using the current External IP - status is green. \r\n\r\nFrom this it would appear that even 2 1/2 days after the change, bitcoind server doesn't recover. \r\n\r\nIf there's a better way to debug this, please let me know. \r\n",
      "created_at" : "2017-04-26T04:03:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/10262#issuecomment-297231844",
      "id" : 297231844,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10262",
      "updated_at" : "2017-04-26T04:07:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/297231844",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/13134193?v=3",
         "events_url" : "https://api.github.com/users/unsystemizer/events{/privacy}",
         "followers_url" : "https://api.github.com/users/unsystemizer/followers",
         "following_url" : "https://api.github.com/users/unsystemizer/following{/other_user}",
         "gists_url" : "https://api.github.com/users/unsystemizer/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/unsystemizer",
         "id" : 13134193,
         "login" : "unsystemizer",
         "organizations_url" : "https://api.github.com/users/unsystemizer/orgs",
         "received_events_url" : "https://api.github.com/users/unsystemizer/received_events",
         "repos_url" : "https://api.github.com/users/unsystemizer/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/unsystemizer/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/unsystemizer/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/unsystemizer"
      }
   },
   {
      "body" : "\"c) Use bitnodes.21.co to check my node's status using the current External IP - status is green.\"\r\n\r\n100%  same here! But if I click on the next page \"Activate Node\" I see him with status \"Pending\"\r\nand 5 minutes later as \"Down\" (Check on external IP still -green- !)\r\nBut now it becomes courious: ~15 minutes after activating the node on bitnodes my node starts to recover the connections...**but nothing happens until I activate it on this page!**\r\nYou can see it on my statpage: http://real-duke.mooo.com:47541/\r\nI hit the activate button at 7.20 CEST this morning, new Internet connection was established at 5.00 CEST\r\nhttps://bitnodes.21.co/nodes/46.59.159.232-8333/\r\n",
      "created_at" : "2017-04-26T08:38:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/10262#issuecomment-297294476",
      "id" : 297294476,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10262",
      "updated_at" : "2017-04-26T08:44:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/297294476",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/22350883?v=3",
         "events_url" : "https://api.github.com/users/Real-Duke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Real-Duke/followers",
         "following_url" : "https://api.github.com/users/Real-Duke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Real-Duke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Real-Duke",
         "id" : 22350883,
         "login" : "Real-Duke",
         "organizations_url" : "https://api.github.com/users/Real-Duke/orgs",
         "received_events_url" : "https://api.github.com/users/Real-Duke/received_events",
         "repos_url" : "https://api.github.com/users/Real-Duke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Real-Duke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Real-Duke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Real-Duke"
      }
   },
   {
      "body" : "```\r\n$ cat debug.log | grep AdvertiseLocal\r\n2017-04-23 18:06:58 AdvertiseLocal: advertising address A.B.C.D:8333\r\n```\r\nIs this A.B.C.D here your old or new address?",
      "created_at" : "2017-04-26T08:45:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/10262#issuecomment-297297746",
      "id" : 297297746,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10262",
      "updated_at" : "2017-04-26T08:45:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/297297746",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   }
]
