[
   {
      "author_association" : "MEMBER",
      "body" : "So this code has been wrong for 7 years? Why do we only notice the effect now?",
      "created_at" : "2020-01-07T13:31:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17887#issuecomment-571586468",
      "id" : 571586468,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17887",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3MTU4NjQ2OA==",
      "updated_at" : "2020-01-07T13:31:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/571586468",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> So this code has been wrong for 7 years? Why do we only notice the effect now?\r\n\r\nItâs likely this issue only started occurring with the introduction of APFS, which is quite recent.",
      "created_at" : "2020-01-07T13:32:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17887#issuecomment-571587229",
      "id" : 571587229,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17887",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3MTU4NzIyOQ==",
      "updated_at" : "2020-01-07T13:32:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/571587229",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@sipa I suspect the OS eventually reclaims pre-allocated space, but it seems block files are not suffering from this kind of issue, so I'm honestly not sure. The docs clearly indicate we were using it wrong, though.\r\n\r\nEdit:\r\n> Itâs likely this issue only started occurring with the introduction of APFS, which is quite recent.\r\n\r\nThat is probably more likely.",
      "created_at" : "2020-01-07T13:33:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17887#issuecomment-571587438",
      "id" : 571587438,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17887",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3MTU4NzQzOA==",
      "updated_at" : "2020-01-07T13:34:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/571587438",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/250224?v=4",
         "events_url" : "https://api.github.com/users/kallewoof/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kallewoof/followers",
         "following_url" : "https://api.github.com/users/kallewoof/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kallewoof/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kallewoof",
         "id" : 250224,
         "login" : "kallewoof",
         "node_id" : "MDQ6VXNlcjI1MDIyNA==",
         "organizations_url" : "https://api.github.com/users/kallewoof/orgs",
         "received_events_url" : "https://api.github.com/users/kallewoof/received_events",
         "repos_url" : "https://api.github.com/users/kallewoof/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kallewoof/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kallewoof"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "On my machine (APFS encrypted volume), I was seeing rev00002.dat hitting 20 MB around block 135k. After this patch (running up to block 191106, then shutting down) I see\r\n```Bash\r\n$ du -ch *.dat\r\n128M\tblk00000.dat\r\n128M\tblk00001.dat\r\n128M\tblk00002.dat\r\n128M\tblk00003.dat\r\n128M\tblk00004.dat\r\n128M\tblk00005.dat\r\n128M\tblk00006.dat\r\n128M\tblk00007.dat\r\n128M\tblk00008.dat\r\n128M\tblk00009.dat\r\n128M\tblk00010.dat\r\n128M\tblk00011.dat\r\n128M\tblk00012.dat\r\n128M\tblk00013.dat\r\n128M\tblk00014.dat\r\n128M\tblk00015.dat\r\n128M\tblk00016.dat\r\n 48M\tblk00017.dat\r\n 20M\trev00000.dat\r\n 17M\trev00001.dat\r\n 17M\trev00002.dat\r\n 17M\trev00003.dat\r\n 17M\trev00004.dat\r\n 18M\trev00005.dat\r\n 18M\trev00006.dat\r\n 19M\trev00007.dat\r\n 19M\trev00008.dat\r\n 18M\trev00009.dat\r\n 18M\trev00010.dat\r\n 19M\trev00011.dat\r\n 19M\trev00012.dat\r\n 19M\trev00013.dat\r\n 19M\trev00014.dat\r\n 18M\trev00015.dat\r\n 19M\trev00016.dat\r\n5.1M\trev00017.dat\r\n2.5G\ttotal\r\n```\r\n\r\nMaster (~same block, after shutdown):\r\n```Bash\r\n$ du -ch *.dat\r\n128M\tblk00000.dat\r\n128M\tblk00001.dat\r\n128M\tblk00002.dat\r\n128M\tblk00003.dat\r\n128M\tblk00004.dat\r\n128M\tblk00005.dat\r\n128M\tblk00006.dat\r\n128M\tblk00007.dat\r\n128M\tblk00008.dat\r\n128M\tblk00009.dat\r\n128M\tblk00010.dat\r\n128M\tblk00011.dat\r\n128M\tblk00012.dat\r\n128M\tblk00013.dat\r\n128M\tblk00014.dat\r\n128M\tblk00015.dat\r\n128M\tblk00016.dat\r\n144M\tblk00017.dat\r\n 19M\trev00000.dat\r\n 17M\trev00001.dat\r\n 16M\trev00002.dat\r\n 17M\trev00003.dat\r\n 17M\trev00004.dat\r\n 18M\trev00005.dat\r\n 18M\trev00006.dat\r\n 36M\trev00007.dat\r\n 51M\trev00008.dat\r\n 18M\trev00009.dat\r\n 18M\trev00010.dat\r\n 18M\trev00011.dat\r\n162M\trev00012.dat\r\n 67M\trev00013.dat\r\n126M\trev00014.dat\r\n 51M\trev00015.dat\r\n 67M\trev00016.dat\r\n 21M\trev00017.dat\r\n3.0G\ttotal\r\n```\r\n\r\nBoth runs were after `rm -rf $BITCOINDIR`.\r\n\r\n`grep 'Pre-allocating'` results for master run, minus a small part of the start: https://pastebin.com/dXLLcRQa\r\n\r\nLooking closely at the run on master, the files are blowing up 2x in size until they are no longer used, at which point they are **sometimes** truncated to their actual size. The blow-up applies to blk files as well, but these are always truncated down after use (see blk00017.dat, which is too large because it isn't finished yet; this was after shutting Bitcoin Core down).\r\n\r\nRunning on this PR, the 2x blowup is not occurring for either files.\r\n\r\nRunning macos 10.14.6 (Mojave). User is running Catalina, so perhaps I would see the problem more often if I upgraded.",
      "created_at" : "2020-01-07T13:43:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17887#issuecomment-571591432",
      "id" : 571591432,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17887",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3MTU5MTQzMg==",
      "updated_at" : "2020-01-07T15:33:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/571591432",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/250224?v=4",
         "events_url" : "https://api.github.com/users/kallewoof/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kallewoof/followers",
         "following_url" : "https://api.github.com/users/kallewoof/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kallewoof/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kallewoof",
         "id" : 250224,
         "login" : "kallewoof",
         "node_id" : "MDQ6VXNlcjI1MDIyNA==",
         "organizations_url" : "https://api.github.com/users/kallewoof/orgs",
         "received_events_url" : "https://api.github.com/users/kallewoof/received_events",
         "repos_url" : "https://api.github.com/users/kallewoof/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kallewoof/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kallewoof"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#17884](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/17884.html) (utils: Use fallback for macOS in AllocateFileRange by IPGlider)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-01-07T13:54:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17887#issuecomment-571595731",
      "id" : 571595731,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17887",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3MTU5NTczMQ==",
      "updated_at" : "2020-01-07T13:54:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/571595731",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Enlightening read: https://www.mail-archive.com/filesystem-dev@lists.apple.com/msg00226.html",
      "created_at" : "2020-01-07T16:11:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17887#issuecomment-571654678",
      "id" : 571654678,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17887",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3MTY1NDY3OA==",
      "updated_at" : "2020-01-07T16:11:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/571654678",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/250224?v=4",
         "events_url" : "https://api.github.com/users/kallewoof/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kallewoof/followers",
         "following_url" : "https://api.github.com/users/kallewoof/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kallewoof/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kallewoof",
         "id" : 250224,
         "login" : "kallewoof",
         "node_id" : "MDQ6VXNlcjI1MDIyNA==",
         "organizations_url" : "https://api.github.com/users/kallewoof/orgs",
         "received_events_url" : "https://api.github.com/users/kallewoof/received_events",
         "repos_url" : "https://api.github.com/users/kallewoof/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kallewoof/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kallewoof"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Tested on MacOS 10.15.2 on an APFS volume and the problem disappears. Also tested on a mounted HFS+ disk volume and the problem disappears.",
      "created_at" : "2020-01-07T19:03:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17887#issuecomment-571725182",
      "id" : 571725182,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17887",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3MTcyNTE4Mg==",
      "updated_at" : "2020-01-07T19:03:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/571725182",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/54533?v=4",
         "events_url" : "https://api.github.com/users/IPGlider/events{/privacy}",
         "followers_url" : "https://api.github.com/users/IPGlider/followers",
         "following_url" : "https://api.github.com/users/IPGlider/following{/other_user}",
         "gists_url" : "https://api.github.com/users/IPGlider/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/IPGlider",
         "id" : 54533,
         "login" : "IPGlider",
         "node_id" : "MDQ6VXNlcjU0NTMz",
         "organizations_url" : "https://api.github.com/users/IPGlider/orgs",
         "received_events_url" : "https://api.github.com/users/IPGlider/received_events",
         "repos_url" : "https://api.github.com/users/IPGlider/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/IPGlider/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/IPGlider/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/IPGlider"
      }
   }
]
