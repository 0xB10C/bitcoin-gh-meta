[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.",
      "created_at" : "2020-01-07T18:33:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17892#issuecomment-571713613",
      "id" : 571713613,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17892",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3MTcxMzYxMw==",
      "updated_at" : "2020-01-08T08:02:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/571713613",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thread-safety annotations (`GUARDED_BY` etc.) seems to be missing? :)",
      "created_at" : "2020-01-07T21:29:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17892#issuecomment-571781435",
      "id" : 571781435,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17892",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3MTc4MTQzNQ==",
      "updated_at" : "2020-01-07T21:29:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/571781435",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@practicalswift Thanks for the nudge. My apologies, though... I ended up scratching this solution for a much simpler one (see updated code).",
      "created_at" : "2020-01-08T03:41:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17892#issuecomment-571878001",
      "id" : 571878001,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17892",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3MTg3ODAwMQ==",
      "updated_at" : "2020-01-08T03:41:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/571878001",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/250224?v=4",
         "events_url" : "https://api.github.com/users/kallewoof/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kallewoof/followers",
         "following_url" : "https://api.github.com/users/kallewoof/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kallewoof/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kallewoof",
         "id" : 250224,
         "login" : "kallewoof",
         "node_id" : "MDQ6VXNlcjI1MDIyNA==",
         "organizations_url" : "https://api.github.com/users/kallewoof/orgs",
         "received_events_url" : "https://api.github.com/users/kallewoof/received_events",
         "repos_url" : "https://api.github.com/users/kallewoof/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kallewoof/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kallewoof"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Some stats: after syncing my mac up to ~ block 186k, the blocks dir looks like this:\r\n```bash\r\n$ du -ch *.dat\r\n128M\tblk00000.dat\r\n128M\tblk00001.dat\r\n128M\tblk00002.dat\r\n128M\tblk00003.dat\r\n128M\tblk00004.dat\r\n128M\tblk00005.dat\r\n128M\tblk00006.dat\r\n128M\tblk00007.dat\r\n128M\tblk00008.dat\r\n128M\tblk00009.dat\r\n128M\tblk00010.dat\r\n128M\tblk00011.dat\r\n128M\tblk00012.dat\r\n128M\tblk00013.dat\r\n144M\tblk00014.dat\r\n 19M\trev00000.dat\r\n 16M\trev00001.dat\r\n 16M\trev00002.dat\r\n 16M\trev00003.dat\r\n 16M\trev00004.dat\r\n 17M\trev00005.dat\r\n 17M\trev00006.dat\r\n 17M\trev00007.dat\r\n 18M\trev00008.dat\r\n 17M\trev00009.dat\r\n 17M\trev00010.dat\r\n 17M\trev00011.dat\r\n 18M\trev00012.dat\r\n171M\trev00013.dat\r\n 21M\trev00014.dat\r\n2.3G\ttotal\r\n```\r\nThe fact the blk for 14 and rev files for 13-14 are bloated is due to a separate bug (see #17887).\r\n\r\nNote that rev 13 is still huge despite us moving on to rev 14. When blk 14 is *finalized*, it will truncate rev 13 down to its right size. It may be worthwhile to actually finalize current and previous twice, to avoid this, but since we are more or less guaranteed to again pre-allocate into X-1, this seems unnecessary, and #17887 will make this have significantly less impact.\r\n",
      "created_at" : "2020-01-08T03:54:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17892#issuecomment-571880370",
      "id" : 571880370,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17892",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3MTg4MDM3MA==",
      "updated_at" : "2020-01-08T03:54:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/571880370",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/250224?v=4",
         "events_url" : "https://api.github.com/users/kallewoof/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kallewoof/followers",
         "following_url" : "https://api.github.com/users/kallewoof/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kallewoof/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kallewoof",
         "id" : 250224,
         "login" : "kallewoof",
         "node_id" : "MDQ6VXNlcjI1MDIyNA==",
         "organizations_url" : "https://api.github.com/users/kallewoof/orgs",
         "received_events_url" : "https://api.github.com/users/kallewoof/received_events",
         "repos_url" : "https://api.github.com/users/kallewoof/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kallewoof/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kallewoof"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I can confirm the bug. I've run into it multiple times. Kalle is convinced that we are at fault, although I'm not so sure, and I think this might even be an Apple bug. It only shows up on APFS, and the implementation of rsync which ships with macOS also suffers from the same issue.\r\n\r\nBut in any case, if we can fix it on our end we should, and this should be pretty high priority. It can end up wasting hundreds of gigabytes of space during an IBD, in some cases exhausting the file on 512GB drives in a way that is very non-intuitive to figure out and fix as a user.",
      "created_at" : "2020-01-08T08:14:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17892#issuecomment-571938255",
      "id" : 571938255,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17892",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3MTkzODI1NQ==",
      "updated_at" : "2020-01-08T08:14:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/571938255",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/69154?v=4",
         "events_url" : "https://api.github.com/users/maaku/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maaku/followers",
         "following_url" : "https://api.github.com/users/maaku/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maaku/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maaku",
         "id" : 69154,
         "login" : "maaku",
         "node_id" : "MDQ6VXNlcjY5MTU0",
         "organizations_url" : "https://api.github.com/users/maaku/orgs",
         "received_events_url" : "https://api.github.com/users/maaku/received_events",
         "repos_url" : "https://api.github.com/users/maaku/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maaku/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maaku/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maaku"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "ACK 0508072e1a45c339a181d24c2edfc88e3cd5201f built locally. All tests pass. I see the blow-up happening and the files being truncated as the following blk file is opened and the previous is finalized.\r\n\r\nHere rev00004.dat is still not truncated since we are on blk00005.dat\r\n```\r\n128M\tblk00000.dat\r\n128M\tblk00001.dat\r\n128M\tblk00002.dat\r\n128M\tblk00003.dat\r\n128M\tblk00004.dat\r\n576M\tblk00005.dat\r\n 19M\trev00000.dat\r\n 16M\trev00001.dat\r\n 16M\trev00002.dat\r\n 16M\trev00003.dat\r\n153M\trev00004.dat\r\n136M\trev00005.dat\r\n```\r\n\r\nIn the next step blk00005.dat has been finalized and rev00004.dat is truncated.\r\n```\r\n128M\tblk00000.dat\r\n128M\tblk00001.dat\r\n128M\tblk00002.dat\r\n128M\tblk00003.dat\r\n128M\tblk00004.dat\r\n128M\tblk00005.dat\r\n 16M\tblk00006.dat\r\n 19M\trev00000.dat\r\n 16M\trev00001.dat\r\n 16M\trev00002.dat\r\n 16M\trev00003.dat\r\n 16M\trev00004.dat\r\n153M\trev00005.dat\r\n1.0M\trev00006.dat\r\n```",
      "created_at" : "2020-01-20T20:15:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17892#issuecomment-576416961",
      "id" : 576416961,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17892",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3NjQxNjk2MQ==",
      "updated_at" : "2020-01-20T20:15:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/576416961",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/20860124?v=4",
         "events_url" : "https://api.github.com/users/eriknylund/events{/privacy}",
         "followers_url" : "https://api.github.com/users/eriknylund/followers",
         "following_url" : "https://api.github.com/users/eriknylund/following{/other_user}",
         "gists_url" : "https://api.github.com/users/eriknylund/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/eriknylund",
         "id" : 20860124,
         "login" : "eriknylund",
         "node_id" : "MDQ6VXNlcjIwODYwMTI0",
         "organizations_url" : "https://api.github.com/users/eriknylund/orgs",
         "received_events_url" : "https://api.github.com/users/eriknylund/received_events",
         "repos_url" : "https://api.github.com/users/eriknylund/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/eriknylund/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/eriknylund/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/eriknylund"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17892#discussion_r368713120"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17892"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/368713120"
         }
      },
      "author_association" : "NONE",
      "body" : "```suggestion\r\n    int previous_undo_file = fFinalize && nLastBlockFile > 0 ? nLastBlockFile - 1 : nLastBlockFile;\r\n```\r\nGiven the comment on line 1738, is _previous_ more appropriate than last?",
      "commit_id" : "5200be20f97ae25e898654671b6af79c637caf98",
      "created_at" : "2020-01-20T20:20:01Z",
      "diff_hunk" : "@@ -1735,8 +1735,14 @@ void static FlushBlockFile(bool fFinalize = false)\n {\n     LOCK(cs_LastBlockFile);\n \n+    // we want to finalize flush the previous undo file, as it will have been written to\n+    // for awhile even after we've moved onto the next blk file; if we don't do this, we\n+    // end up with a re-opened but unflushed rev file, resulting in pre-allocated but not\n+    // returned disk space allocation\n+    int last_undo_file = fFinalize && nLastBlockFile > 0 ? nLastBlockFile - 1 : nLastBlockFile;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17892#discussion_r368713120",
      "id" : 368713120,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODcxMzEyMA==",
      "original_commit_id" : "0508072e1a45c339a181d24c2edfc88e3cd5201f",
      "original_position" : 8,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 345517243,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17892",
      "updated_at" : "2020-01-21T00:23:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/368713120",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/20860124?v=4",
         "events_url" : "https://api.github.com/users/eriknylund/events{/privacy}",
         "followers_url" : "https://api.github.com/users/eriknylund/followers",
         "following_url" : "https://api.github.com/users/eriknylund/following{/other_user}",
         "gists_url" : "https://api.github.com/users/eriknylund/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/eriknylund",
         "id" : 20860124,
         "login" : "eriknylund",
         "node_id" : "MDQ6VXNlcjIwODYwMTI0",
         "organizations_url" : "https://api.github.com/users/eriknylund/orgs",
         "received_events_url" : "https://api.github.com/users/eriknylund/received_events",
         "repos_url" : "https://api.github.com/users/eriknylund/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/eriknylund/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/eriknylund/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/eriknylund"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17892#discussion_r368765758"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17892"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/368765758"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Makes sense.",
      "commit_id" : "5200be20f97ae25e898654671b6af79c637caf98",
      "created_at" : "2020-01-21T00:23:46Z",
      "diff_hunk" : "@@ -1735,8 +1735,14 @@ void static FlushBlockFile(bool fFinalize = false)\n {\n     LOCK(cs_LastBlockFile);\n \n+    // we want to finalize flush the previous undo file, as it will have been written to\n+    // for awhile even after we've moved onto the next blk file; if we don't do this, we\n+    // end up with a re-opened but unflushed rev file, resulting in pre-allocated but not\n+    // returned disk space allocation\n+    int last_undo_file = fFinalize && nLastBlockFile > 0 ? nLastBlockFile - 1 : nLastBlockFile;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17892#discussion_r368765758",
      "id" : 368765758,
      "in_reply_to_id" : 368713120,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODc2NTc1OA==",
      "original_commit_id" : "0508072e1a45c339a181d24c2edfc88e3cd5201f",
      "original_position" : 8,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 345581038,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17892",
      "updated_at" : "2020-01-21T00:23:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/368765758",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/250224?v=4",
         "events_url" : "https://api.github.com/users/kallewoof/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kallewoof/followers",
         "following_url" : "https://api.github.com/users/kallewoof/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kallewoof/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kallewoof",
         "id" : 250224,
         "login" : "kallewoof",
         "node_id" : "MDQ6VXNlcjI1MDIyNA==",
         "organizations_url" : "https://api.github.com/users/kallewoof/orgs",
         "received_events_url" : "https://api.github.com/users/kallewoof/received_events",
         "repos_url" : "https://api.github.com/users/kallewoof/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kallewoof/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kallewoof"
      }
   }
]
