[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17852#discussion_r362776455"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17852"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/362776455"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why is this needed? The pointer should be reset when the TxIndex is destructed",
      "commit_id" : "ed9180fc288e1785aee9aabf18d83b0ce8f15590",
      "created_at" : "2020-01-03T11:18:02Z",
      "diff_hunk" : "@@ -228,7 +228,10 @@ TxIndex::TxIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n     : m_db(MakeUnique<TxIndex::DB>(n_cache_size, f_memory, f_wipe))\n {}\n \n-TxIndex::~TxIndex() {}\n+TxIndex::~TxIndex()\n+{\n+    m_db.reset();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17852#discussion_r362776455",
      "id" : 362776455,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc3NjQ1NQ==",
      "original_commit_id" : "ed9180fc288e1785aee9aabf18d83b0ce8f15590",
      "original_position" : 7,
      "path" : "src/index/txindex.cpp",
      "position" : 7,
      "pull_request_review_id" : 338038589,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17852",
      "updated_at" : "2020-01-03T11:18:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/362776455",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17852#discussion_r362829332"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17852"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/362829332"
         }
      },
      "author_association" : "NONE",
      "body" : "Good point, it should, (shouldn't it???) (clearly both C++ and myself are too old for me to be writing it), so it would seem that, at least in some corner case, ~TxIndex isn't getting called at all. So I will close this for now and reopen it if I figure out what's going on further investigation. Thanks",
      "commit_id" : "ed9180fc288e1785aee9aabf18d83b0ce8f15590",
      "created_at" : "2020-01-03T14:34:54Z",
      "diff_hunk" : "@@ -228,7 +228,10 @@ TxIndex::TxIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n     : m_db(MakeUnique<TxIndex::DB>(n_cache_size, f_memory, f_wipe))\n {}\n \n-TxIndex::~TxIndex() {}\n+TxIndex::~TxIndex()\n+{\n+    m_db.reset();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17852#discussion_r362829332",
      "id" : 362829332,
      "in_reply_to_id" : 362776455,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjgyOTMzMg==",
      "original_commit_id" : "ed9180fc288e1785aee9aabf18d83b0ce8f15590",
      "original_position" : 7,
      "path" : "src/index/txindex.cpp",
      "position" : 7,
      "pull_request_review_id" : 338106349,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17852",
      "updated_at" : "2020-01-03T14:34:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/362829332",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/107466?v=4",
         "events_url" : "https://api.github.com/users/paulyc/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paulyc/followers",
         "following_url" : "https://api.github.com/users/paulyc/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paulyc/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paulyc",
         "id" : 107466,
         "login" : "paulyc",
         "node_id" : "MDQ6VXNlcjEwNzQ2Ng==",
         "organizations_url" : "https://api.github.com/users/paulyc/orgs",
         "received_events_url" : "https://api.github.com/users/paulyc/received_events",
         "repos_url" : "https://api.github.com/users/paulyc/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paulyc/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paulyc/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paulyc"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17852#discussion_r362846350"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17852"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/362846350"
         }
      },
      "author_association" : "NONE",
      "body" : "I wonder, but wouldn't really know, if the default destructor call isn't somehow ordered, or being reordered, such that it doesn't finish before the process exits, and the explicit call here maybe allows it to finish, but I'd still have to test it more and maybe figure out a way to write an integration test that verifies all the leveldbs are properly closed (or not). Will investigate further",
      "commit_id" : "ed9180fc288e1785aee9aabf18d83b0ce8f15590",
      "created_at" : "2020-01-03T15:20:31Z",
      "diff_hunk" : "@@ -228,7 +228,10 @@ TxIndex::TxIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n     : m_db(MakeUnique<TxIndex::DB>(n_cache_size, f_memory, f_wipe))\n {}\n \n-TxIndex::~TxIndex() {}\n+TxIndex::~TxIndex()\n+{\n+    m_db.reset();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17852#discussion_r362846350",
      "id" : 362846350,
      "in_reply_to_id" : 362776455,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjg0NjM1MA==",
      "original_commit_id" : "ed9180fc288e1785aee9aabf18d83b0ce8f15590",
      "original_position" : 7,
      "path" : "src/index/txindex.cpp",
      "position" : 7,
      "pull_request_review_id" : 338127836,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17852",
      "updated_at" : "2020-01-03T15:47:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/362846350",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/107466?v=4",
         "events_url" : "https://api.github.com/users/paulyc/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paulyc/followers",
         "following_url" : "https://api.github.com/users/paulyc/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paulyc/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paulyc",
         "id" : 107466,
         "login" : "paulyc",
         "node_id" : "MDQ6VXNlcjEwNzQ2Ng==",
         "organizations_url" : "https://api.github.com/users/paulyc/orgs",
         "received_events_url" : "https://api.github.com/users/paulyc/received_events",
         "repos_url" : "https://api.github.com/users/paulyc/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paulyc/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paulyc/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paulyc"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17852#discussion_r362847203"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17852"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/362847203"
         }
      },
      "author_association" : "NONE",
      "body" : "Particularly since leveldb is rather poorly designed imo to put some very important closing the database code in the destructor, since, after all, the compiler (and programmer, and OS), don't necessarily know or care that any of those objects still in memory that are about to be wiped out by the OS when the process exits, actually do important things that need to happen before the process does exit! And thus, quite often, do not bother actually destructing any of those objects, since nobody cares, (but this is exactly why they should care), about memory that leaks when the process is about to exit.",
      "commit_id" : "ed9180fc288e1785aee9aabf18d83b0ce8f15590",
      "created_at" : "2020-01-03T15:22:52Z",
      "diff_hunk" : "@@ -228,7 +228,10 @@ TxIndex::TxIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n     : m_db(MakeUnique<TxIndex::DB>(n_cache_size, f_memory, f_wipe))\n {}\n \n-TxIndex::~TxIndex() {}\n+TxIndex::~TxIndex()\n+{\n+    m_db.reset();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17852#discussion_r362847203",
      "id" : 362847203,
      "in_reply_to_id" : 362776455,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjg0NzIwMw==",
      "original_commit_id" : "ed9180fc288e1785aee9aabf18d83b0ce8f15590",
      "original_position" : 7,
      "path" : "src/index/txindex.cpp",
      "position" : 7,
      "pull_request_review_id" : 338128927,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17852",
      "updated_at" : "2020-01-03T15:25:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/362847203",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/107466?v=4",
         "events_url" : "https://api.github.com/users/paulyc/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paulyc/followers",
         "following_url" : "https://api.github.com/users/paulyc/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paulyc/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paulyc",
         "id" : 107466,
         "login" : "paulyc",
         "node_id" : "MDQ6VXNlcjEwNzQ2Ng==",
         "organizations_url" : "https://api.github.com/users/paulyc/orgs",
         "received_events_url" : "https://api.github.com/users/paulyc/received_events",
         "repos_url" : "https://api.github.com/users/paulyc/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paulyc/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paulyc/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paulyc"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17852#discussion_r362853352"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17852"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/362853352"
         }
      },
      "author_association" : "NONE",
      "body" : "It certainly seems like the patch works, but, I can neither explain why nor prove that it does definitively, so, not sure if that quite reaches the merge bar, in light of it being such a minor change to such a minor subsystem that isn't functionally broken, rather just a little bit inconvenient having to wait a while, while it reindexes the same blocks ;) but it's been bugging me (no pun intended) for years..",
      "commit_id" : "ed9180fc288e1785aee9aabf18d83b0ce8f15590",
      "created_at" : "2020-01-03T15:37:51Z",
      "diff_hunk" : "@@ -228,7 +228,10 @@ TxIndex::TxIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n     : m_db(MakeUnique<TxIndex::DB>(n_cache_size, f_memory, f_wipe))\n {}\n \n-TxIndex::~TxIndex() {}\n+TxIndex::~TxIndex()\n+{\n+    m_db.reset();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17852#discussion_r362853352",
      "id" : 362853352,
      "in_reply_to_id" : 362776455,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjg1MzM1Mg==",
      "original_commit_id" : "ed9180fc288e1785aee9aabf18d83b0ce8f15590",
      "original_position" : 7,
      "path" : "src/index/txindex.cpp",
      "position" : 7,
      "pull_request_review_id" : 338136670,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17852",
      "updated_at" : "2020-01-03T15:37:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/362853352",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/107466?v=4",
         "events_url" : "https://api.github.com/users/paulyc/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paulyc/followers",
         "following_url" : "https://api.github.com/users/paulyc/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paulyc/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paulyc",
         "id" : 107466,
         "login" : "paulyc",
         "node_id" : "MDQ6VXNlcjEwNzQ2Ng==",
         "organizations_url" : "https://api.github.com/users/paulyc/orgs",
         "received_events_url" : "https://api.github.com/users/paulyc/received_events",
         "repos_url" : "https://api.github.com/users/paulyc/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paulyc/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paulyc/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paulyc"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17852#discussion_r362868171"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17852"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/362868171"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What is the issue you are seeing? Any stacktraces or anything?\r\n\r\nReminds me of #13894, #14071, #15410 ",
      "commit_id" : "ed9180fc288e1785aee9aabf18d83b0ce8f15590",
      "created_at" : "2020-01-03T16:18:15Z",
      "diff_hunk" : "@@ -228,7 +228,10 @@ TxIndex::TxIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n     : m_db(MakeUnique<TxIndex::DB>(n_cache_size, f_memory, f_wipe))\n {}\n \n-TxIndex::~TxIndex() {}\n+TxIndex::~TxIndex()\n+{\n+    m_db.reset();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17852#discussion_r362868171",
      "id" : 362868171,
      "in_reply_to_id" : 362776455,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjg2ODE3MQ==",
      "original_commit_id" : "ed9180fc288e1785aee9aabf18d83b0ce8f15590",
      "original_position" : 7,
      "path" : "src/index/txindex.cpp",
      "position" : 7,
      "pull_request_review_id" : 338155951,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17852",
      "updated_at" : "2020-01-03T16:18:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/362868171",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
