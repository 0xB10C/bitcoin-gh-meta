[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "In order to test the new check and error add:\r\n```diff\r\n--- a/src/rpc/blockchain.cpp\r\n+++ b/src/rpc/blockchain.cpp\r\n@@ -1619,6 +1619,8 @@ UniValue savemempool(const JSONRPCRequest& request)\r\n         throw JSONRPCError(RPC_MISC_ERROR, \"Currently dumping the mempool\");\r\n     }\r\n\r\n+    MilliSleep(10000);\r\n+\r\n     if (!g_is_mempool_loaded) {\r\n         throw JSONRPCError(RPC_MISC_ERROR, \"The mempool was not loaded yet\");\r\n     }\r\n```\r\nThen run\r\n```sh\r\nbitcoin-cli -regtest savemempool & bitcoin-cli -regtest savemempool\r\n```\r\nShould print `Currently dumping the mempool` immediately.",
      "created_at" : "2018-03-30T17:03:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12842#issuecomment-377571335",
      "id" : 377571335,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12842",
      "updated_at" : "2018-03-30T17:03:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/377571335",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12842#discussion_r178492263"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12842"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178492263"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Nit: maybe instead, \r\n\r\n\"`savemempool` already in progress\"",
      "commit_id" : "7f722a1f0c82e1cc8dd9f6af9159bf7d7b8f2626",
      "created_at" : "2018-04-02T06:08:28Z",
      "diff_hunk" : "@@ -1614,6 +1614,11 @@ UniValue savemempool(const JSONRPCRequest& request)\n         );\n     }\n \n+    TxMempoolDumpReserver reserver(mempool);\n+    if (!reserver.reserve()) {\n+        throw JSONRPCError(RPC_MISC_ERROR, \"Currently dumping the mempool\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12842#discussion_r178492263",
      "id" : 178492263,
      "original_commit_id" : "7f722a1f0c82e1cc8dd9f6af9159bf7d7b8f2626",
      "original_position" : 6,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 6,
      "pull_request_review_id" : 108554601,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12842",
      "updated_at" : "2018-04-02T06:08:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178492263",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/14220652?v=4",
         "events_url" : "https://api.github.com/users/conscott/events{/privacy}",
         "followers_url" : "https://api.github.com/users/conscott/followers",
         "following_url" : "https://api.github.com/users/conscott/following{/other_user}",
         "gists_url" : "https://api.github.com/users/conscott/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/conscott",
         "id" : 14220652,
         "login" : "conscott",
         "organizations_url" : "https://api.github.com/users/conscott/orgs",
         "received_events_url" : "https://api.github.com/users/conscott/received_events",
         "repos_url" : "https://api.github.com/users/conscott/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/conscott/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/conscott/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/conscott"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12842#discussion_r178509357"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12842"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178509357"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Sounds better.",
      "commit_id" : "7f722a1f0c82e1cc8dd9f6af9159bf7d7b8f2626",
      "created_at" : "2018-04-02T08:43:49Z",
      "diff_hunk" : "@@ -1614,6 +1614,11 @@ UniValue savemempool(const JSONRPCRequest& request)\n         );\n     }\n \n+    TxMempoolDumpReserver reserver(mempool);\n+    if (!reserver.reserve()) {\n+        throw JSONRPCError(RPC_MISC_ERROR, \"Currently dumping the mempool\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12842#discussion_r178509357",
      "id" : 178509357,
      "in_reply_to_id" : 178492263,
      "original_commit_id" : "7f722a1f0c82e1cc8dd9f6af9159bf7d7b8f2626",
      "original_position" : 6,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 6,
      "pull_request_review_id" : 108574004,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12842",
      "updated_at" : "2018-04-02T08:43:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/178509357",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "After #12863 I'm even more convinced that this might be the wrong approach. Protecting access using a mutex instead of returning these kind of 'busy errors' would avoid having to implement retry-poll-loops client-side (including in the tests).\r\n\r\nIf you want to stick with this you'd at least need to define a new error code that means 'transient error', similar to `RPC_IN_WARMUP`. But I think pushing this responsibility to the client is unnecessary.",
      "created_at" : "2018-04-03T08:12:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12842#issuecomment-378166282",
      "id" : 378166282,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12842",
      "updated_at" : "2018-04-03T08:18:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/378166282",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@laanwj indeed it's very arguable. I think it's preferable to have the client retrying than reserving resources on the server side. IMO having the client waiting is also not desirable because the client can wait indefinitely and also timeout (but then he can raise the timeout) and we would process the request anyway (?). Getting an error instead of waiting is also more informative and allows the client to explicitly log and retry when he feels like.",
      "created_at" : "2018-04-03T10:14:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12842#issuecomment-378200407",
      "id" : 378200407,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12842",
      "updated_at" : "2018-04-03T10:14:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/378200407",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "OTOH\r\n- Then the API wouldn't be changed. Users of `savemempool` can rely on the call working, or fatally failing.\r\n- Hanging indefinitely is a bug no matter what. If it takes too long, something is wrong.\r\n- Interrupt semantics usually require *less* resources than polling. In this case: sleeping on a mutex requires virtually no resources. Whereas repetitive RPC requests take up CPU cycles and I/O.",
      "created_at" : "2018-04-03T11:17:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12842#issuecomment-378214925",
      "id" : 378214925,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12842",
      "updated_at" : "2018-04-03T11:17:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/378214925",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I think we had reports that loading the mempool took 1.5 hours or so, just noting without further comment.",
      "created_at" : "2018-04-03T16:03:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12842#issuecomment-378303303",
      "id" : 378303303,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12842",
      "updated_at" : "2018-04-03T16:03:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/378303303",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Then the API wouldn't be changed. Users of savemempool can rely on the call working, or fatally failing.\r\n\r\nThe caller should always have error handling, and this new error would fall in his \"unkown error\".\r\n\r\n> Hanging indefinitely is a bug no matter what. If it takes too long, something is wrong.\r\n\r\nWe have calls that can hang a lot of time, for instance when the wallet is really big (as in lots of keys, lots of transactions).\r\n\r\n> Interrupt semantics usually require less resources than polling.\r\n\r\nRight, but at least a thread and a socket is on hold. And when the mutex is acquired, it might do something that is no longer relevant - in this case dumping the mempool again..\r\n\r\nWe have this semantic in `rescanblockchain`, do you think we should change that too?\r\n\r\nAnd regarding #12863, having the client blindingly wait for 1.5 hours should not be an option (?)",
      "created_at" : "2018-04-03T22:25:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12842#issuecomment-378418995",
      "id" : 378418995,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12842",
      "updated_at" : "2018-04-03T22:25:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/378418995",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "I'm also more a fan of blocking until the existing save has finished. Given that no modifications in the mempool can happen in the mean time anyway (I think?), we could even just wait until the existing save operation finishes and then return from both RPC calls (without an additional save).",
      "created_at" : "2018-04-03T23:28:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12842#issuecomment-378431421",
      "id" : 378431421,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12842",
      "updated_at" : "2018-04-03T23:28:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/378431421",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Given that no modifications in the mempool can happen in the mean time anyway\r\n\r\nActually it can, `DumpMempool` takes a copy of the mempool contents and then releases the lock to then write to file. So, while writing to disk, the mempool can change.",
      "created_at" : "2018-04-03T23:50:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12842#issuecomment-378435110",
      "id" : 378435110,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12842",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDM3ODQzNTExMA==",
      "updated_at" : "2018-06-07T14:01:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/378435110",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "What should be done here? I've to address @conscott comment above, but I guess I should wait for more concept ACKs.",
      "created_at" : "2018-06-07T14:04:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12842#issuecomment-395432218",
      "id" : 395432218,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12842",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDM5NTQzMjIxOA==",
      "updated_at" : "2018-06-07T14:04:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/395432218",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I agree with @laanwj - it should just hold a lock on the file to avoid problems, but otherwise succeed.",
      "created_at" : "2018-06-12T18:19:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12842#issuecomment-396686016",
      "id" : 396686016,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12842",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDM5NjY4NjAxNg==",
      "updated_at" : "2018-06-12T18:19:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/396686016",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   }
]
