[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#23813](https://github.com/bitcoin/bitcoin/pull/23813) (Add test and docs for getblockfrompeer by fjahr)\n* [#23706](https://github.com/bitcoin/bitcoin/pull/23706) (rpc: getblockfrompeer followups by Sjors)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-01-01T03:06:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23927#issuecomment-1003492901",
      "id" : 1003492901,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23927",
      "node_id" : "IC_kwDOABII58470BYl",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1003492901/reactions"
      },
      "updated_at" : "2022-01-01T03:06:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1003492901",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK.\r\n\r\nI started testing it by creating a functional test. Not sure if the approach is right, I started two nodes, the second one with `-prune=550` and then, node0 mines 20 blocks, I get the bestblockhash from node0 and use it on getblockfrompeer (node1 --> node0), it should return an error (apparently it worked):\r\n```python\r\ndef run_test(self):\r\n        self.log.info(\"Mine 20 blocks on Node 0\")\r\n        self.generate(self.nodes[0], 200, sync_fun=self.no_op)\r\n        assert_equal(self.nodes[0].getblockcount(), 400)\r\n\r\n        self.log.info(\"Connect nodes\")\r\n        self.connect_nodes(0, 1)\r\n\r\n        peers = self.nodes[1].getpeerinfo()\r\n        assert_equal(len(peers), 1)\r\n        peer_1_peer_0_id = peers[0][\"id\"]\r\n        best_block_hash_0 = self.nodes[0].getbestblockhash()\r\n        assert_raises_rpc_error(-1, 'In prune mode, only blocks that the node has already synced previously can be fetched from a peer', self.nodes[1].getblockfrompeer, best_block_hash_0, peer_1_peer_0_id)\r\n```\r\n\r\nIn master branch, this test would fail, because an exeception won't be raised.",
      "created_at" : "2022-01-01T15:09:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23927#issuecomment-1003571743",
      "id" : 1003571743,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23927",
      "node_id" : "IC_kwDOABII58470Uof",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1003571743/reactions"
      },
      "updated_at" : "2022-01-01T15:09:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1003571743",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> I started testing it by creating a functional test. Not sure if the approach is right, I started two nodes, the second one with `-prune=550` and then, node0 mines 20 blocks, I get the bestblockhash from node0 and use it on getblockfrompeer (node1 --> node0), it should return an error (apparently it worked):\r\n\r\nHey @brunoerg , thanks for giving it a try but unfortunately I don't think this approach works reliably. The problem is that the outcome of this test is a race because node 1 is downloading the blocks from node 0 in the background. It may have the current tip in flight by the time the assert is called, or not. We try to avoid tests where the outcome is not 100% reliable because we are seeing intermittent test failures quite often already.\r\n\r\nWhat would be needed is a reliable way to let node 1 sync the headers but then prevent it from syncing the blocks. It seems we don't have something like this and I am now thinking about how this could be done and where else it could be useful.",
      "created_at" : "2022-01-01T18:24:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23927#issuecomment-1003597178",
      "id" : 1003597178,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23927",
      "node_id" : "IC_kwDOABII58470a16",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1003597178/reactions"
      },
      "updated_at" : "2022-01-01T18:24:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1003597178",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> The problem is that the outcome of this test is a race because node 1 is downloading the blocks from node 0 in the background.\r\n\r\nInteresting, this is new for me.\r\n```python\r\ndef setup_network(self):\r\n  self.setup_nodes()\r\n```\r\n\r\neven with this config (setup_network) node1 will download the blocks from node0 in the background after node0 mines more 20 blocks?\r\n\r\n```python\r\ndef run_test(self):\r\n        self.log.info(\"Mine 20 blocks on Node 0\")\r\n        self.generate(self.nodes[0], 200, sync_fun=self.no_op)\r\n        assert_equal(self.nodes[0].getblockcount(), 400)\r\n\r\n        self.log.info(\"Connect nodes\")\r\n        self.connect_nodes(0, 1)\r\n\r\n        peers = self.nodes[1].getpeerinfo()\r\n        assert_equal(len(peers), 1)\r\n        peer_1_peer_0_id = peers[0][\"id\"]\r\n        best_block_hash_0 = self.nodes[0].getbestblockhash()\r\n        assert_raises_rpc_error(-1, 'In prune mode, only blocks that the node has already synced previously can be fetched from a peer', self.nodes[1].getblockfrompeer, best_block_hash_0, peer_1_peer_0_id)\r\n\r\n        self.sync_blocks()\r\n        self.nodes[1].getblockfrompeer(best_block_hash_0, peer_1_peer_0_id)\r\n```\r\nI thought the first `getblockfrompeer` into the assert would fail because I didn't setup it to sync blocks and the second one would work because of `self.sync_blocks()`. \r\n\r\n",
      "created_at" : "2022-01-02T13:40:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23927#issuecomment-1003718005",
      "id" : 1003718005,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23927",
      "node_id" : "IC_kwDOABII584704V1",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1003718005/reactions"
      },
      "updated_at" : "2022-01-02T13:40:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1003718005",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> even with this config (setup_network) node1 will download the blocks from node0 in the background after node0 mines more 20 blocks?\r\n\r\nNo, the nodes indeed can not sync if they are not connected. But you are connecting the nodes in your test here: `self.connect_nodes(0, 1)`. In the moment the nodes are connected they also start syncing. You can see this for example by inserting `print(self.nodes[1].getblockcount())` in the line before your first assert and then running the test a couple of times. You will see that the node is not at 200 blocks anymore and each time you run the test it will be a different number because of this race between the different processes.\r\n\r\n> I thought the first `getblockfrompeer` into the assert would fail because I didn't setup it to sync blocks and the second one would work because of `self.sync_blocks()`.\r\n\r\nWhat `sync_blocks()` does is it waits for all the nodes to be caught up with each other. This ensures the reverse of our problem doesn't happen: a test where all the nodes need to be caught up to continue does not fail intermittently and so with that the second assert is safe. But for the first assert we would basically need the inverse of the functionality, i.e. something that ensures that the nodes are definitely not caught up with each other until we have finished what we want to test.\r\n\r\n",
      "created_at" : "2022-01-02T14:25:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23927#issuecomment-1003723912",
      "id" : 1003723912,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23927",
      "node_id" : "IC_kwDOABII584705yI",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1003723912/reactions"
      },
      "updated_at" : "2022-01-02T14:25:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1003723912",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I think we have a working test now. I remembered that we can submit the header via a `P2PInterface` to the pruning node and that seems to work. :)",
      "created_at" : "2022-01-02T16:09:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23927#issuecomment-1003738704",
      "id" : 1003738704,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23927",
      "node_id" : "IC_kwDOABII584709ZQ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1003738704/reactions"
      },
      "updated_at" : "2022-01-02T16:09:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1003738704",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   }
]
