[
   {
      "body" : "``DumpAddresses()`` is run 15 minutes after starting the node AFAIK. So it shouldn't directly overwrite peers.dat. All seems unrelated to the ``.lock`` file. That file can be there, if it's locked by another bitcoin process we don't startup another instance. If we crash-reboot that lock is gone and another instance can be started.\r\n\r\nMind explaining it again, perhaps I don't understand. List the exact steps and what happend to get you an empty peers.dat.",
      "created_at" : "2014-08-10T12:18:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/4669#issuecomment-51713236",
      "id" : 51713236,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4669",
      "updated_at" : "2014-08-10T12:18:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/51713236",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "body" : "@Diapolo DumpAddresses() also runs at shutdown.\r\n\r\nWe can see the following code logic:\r\n* bitcoind.cpp calls AppInit2()\r\n* AppInit2() returns false upon hitting .lock (step 4), and does not read addrman db (step 10).\r\n* bitcoind.cpp calls Shutdown() -> StopNode() -> DumpAddresses()\r\n\r\nIn fact, we flush several databases we have not read, if .lock is encountered!\r\n\r\nDefinitely a bug.\r\n",
      "created_at" : "2014-08-10T12:43:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/4669#issuecomment-51713879",
      "id" : 51713879,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4669",
      "updated_at" : "2014-08-10T12:43:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/51713879",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "body" : "I can confirm that I experienced this with an un-clean shutdown. Same result with 0 addresses read. ",
      "created_at" : "2014-08-10T16:07:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/4669#issuecomment-51719035",
      "id" : 51719035,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4669",
      "updated_at" : "2014-08-10T16:07:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/51719035",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8371076?v=3",
         "events_url" : "https://api.github.com/users/thereisnofromaddress/events{/privacy}",
         "followers_url" : "https://api.github.com/users/thereisnofromaddress/followers",
         "following_url" : "https://api.github.com/users/thereisnofromaddress/following{/other_user}",
         "gists_url" : "https://api.github.com/users/thereisnofromaddress/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/thereisnofromaddress",
         "id" : 8371076,
         "login" : "thereisnofromaddress",
         "organizations_url" : "https://api.github.com/users/thereisnofromaddress/orgs",
         "received_events_url" : "https://api.github.com/users/thereisnofromaddress/received_events",
         "repos_url" : "https://api.github.com/users/thereisnofromaddress/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/thereisnofromaddress/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/thereisnofromaddress/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/thereisnofromaddress"
      }
   },
   {
      "body" : "> In fact, we flush several databases we have not read, if .lock is encountered!\r\n\r\nI've looked at this in more detail, and it is not as bad as it seems:\r\n\r\n- GenerateBitcoins(false) does nothing if GenerateBitcoins(true) was never called\r\n- StopRPCThreads() does nothing if StartRPCThreads() wasn't called (rpc_io_service == NULL)\r\n- pwalletMain: is still 0, so nothing happens with it, and also not bitdb.Flush()\r\n- pblocktree: is still 0, so no Flush() happens with it\r\n\r\nHowever:\r\n\r\n- StopNode() should check whether the node was initialized, and do nothing if it wasn't- anologous to StopRPCThreads. Because this doesn't happen, an empty addresses file is written.\r\n- Same for `mempool` fee estimation logic. Because this doesn't happen, an empty fee estimates file is written.\r\n- `boost::filesystem::remove(GetPidFile())` should only be called if we created the PID file in the first place. But more is wrong here, the PID file is *created* in bitcoind.cpp far before the datadir lock is checked.\r\n\r\nWe should add a comment to Shutdown() that it must handle cases in which AppInit2() failed partway.\r\n",
      "created_at" : "2014-09-18T11:47:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/4669#issuecomment-56027524",
      "id" : 56027524,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4669",
      "updated_at" : "2014-09-18T12:16:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/56027524",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Another option would be to change the initialization logic so that Shutdown() is not run when AppInit2() fails (ie, everything takes care of its own cleanup on failure). This has more code impact, and harder to test, but may be saner in the long term.\r\n",
      "created_at" : "2014-09-18T12:14:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/4669#issuecomment-56029781",
      "id" : 56029781,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4669",
      "updated_at" : "2014-09-18T12:14:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/56029781",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "How about simplifying and doing a quick, unclean, exit(1) if anything in startup initialization fails?\r\n",
      "created_at" : "2014-09-18T13:29:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/4669#issuecomment-56037766",
      "id" : 56037766,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4669",
      "updated_at" : "2014-09-18T13:29:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/56037766",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "body" : "Was thinking similar to @gavinandresen -- throw an exception.\r\n",
      "created_at" : "2014-09-18T13:30:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/4669#issuecomment-56037895",
      "id" : 56037895,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4669",
      "updated_at" : "2014-09-18T13:30:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/56037895",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "body" : "That sounds very ugly to me. It also breaks any assumption held by the GUI (makes it impossible to report anything back to the user, for example).\r\n\r\nAlso - things that *are* initialized must be shut down properly. IE if initializing the wallet fails but the block database has already been fiddled with, the block database must be closed on failure.\r\n",
      "created_at" : "2014-09-18T14:10:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/4669#issuecomment-56043328",
      "id" : 56043328,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4669",
      "updated_at" : "2014-09-18T14:12:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/56043328",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   }
]
