[
   {
      "author_association" : "MEMBER",
      "body" : "`TestInterface::Call();` should be blocking on the destructor, which sets `destroyed`, so I have no idea how this could happen.",
      "created_at" : "2023-07-25T10:16:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/28146#issuecomment-1649540097",
      "id" : 1649540097,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28146",
      "node_id" : "IC_kwDOABII585iUfwB",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1649540097/reactions"
      },
      "updated_at" : "2023-07-25T10:16:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1649540097",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I was able to reproduce this by adding some sleeps:\r\n\r\n<details>\r\n<summary>diff on bc4f6b13feb29146b7e10e86f93dc7f6fb6937f2 </summary>\r\n<br>\r\n\r\n```diff\r\ndiff --git a/src/validationinterface.cpp b/src/validationinterface.cpp\r\nindex d344c8bfb..bb645ae94 100644\r\n--- a/src/validationinterface.cpp\r\n+++ b/src/validationinterface.cpp\r\n@@ -17,6 +17,9 @@\r\n #include <unordered_map>\r\n #include <utility>\r\n \r\n+#include <chrono>\r\n+#include <thread>\r\n+\r\n std::string RemovalReasonToString(const MemPoolRemovalReason& r) noexcept;\r\n \r\n /**\r\n@@ -86,7 +89,9 @@ public:\r\n             {\r\n                 REVERSE_LOCK(lock);\r\n                 f(*it->callbacks);\r\n+                std::this_thread::sleep_for(1ms);\r\n             }\r\n+            LogPrintf(\"it->count %v\\n\", it->count);\r\n             it = --it->count ? std::next(it) : m_list.erase(it);\r\n         }\r\n     }\r\n@@ -182,6 +187,7 @@ void SyncWithValidationInterfaceQueue()\r\n         auto local_name = (name);                              \\\r\n         LOG_EVENT(\"Enqueuing \" fmt, local_name, __VA_ARGS__);  \\\r\n         m_internals->m_schedulerClient.AddToProcessQueue([=] { \\\r\n+            std::this_thread::sleep_for(800us);                  \\\r\n             LOG_EVENT(fmt, local_name, __VA_ARGS__);           \\\r\n             event();                                           \\\r\n         });                                                    \\\r\n@@ -194,7 +200,6 @@ void CMainSignals::UpdatedBlockTip(const CBlockIndex *pindexNew, const CBlockInd\r\n     // Dependencies exist that require UpdatedBlockTip events to be delivered in the order in which\r\n     // the chain actually updates. One way to ensure this is for the caller to invoke this signal\r\n     // in the same critical section where the chain is updated\r\n-\r\n     auto event = [pindexNew, pindexFork, fInitialDownload, this] {\r\n         m_internals->Iterate([&](CValidationInterface& callbacks) { callbacks.UpdatedBlockTip(pindexNew, pindexFork, fInitialDownload); });\r\n     };\r\n```\r\n</details>\r\n\r\nIn the CI logs, `UpdatedBlockTip` and `BlockChecked` run at ~ the same time. I think what happens is:\r\n- `BlockChecked` calls `Iterate` which increments `it->count` (count = 2) with `m_mutex`\r\n- `m_on_call` gets called without `m_mutex`\r\n- In the scheduler thread, `Iterate` is called and increments `it->count` (count = 3) with `m_mutex`. (`UpdatedBlockTip` runs in the scheduler thread). Then `m_mutex` is released to call `UpdatedBlockTip`\r\n- `m_on_call` calls `UnregisterAllValidationInterfaces` which will decrement `it->count` (count = 2) with `m_mutex`.\r\n- `m_on_call` calls `UnregisterAllValidationInterfaces` which is a no-op.\r\n- The `BlockChecked` callback finishes and since the count = 2, the element isn't erased so the destructor isn't called. This fails the test",
      "created_at" : "2023-07-25T14:16:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/28146#issuecomment-1649931679",
      "id" : 1649931679,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28146",
      "node_id" : "IC_kwDOABII585iV_Wf",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 1,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 2,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1649931679/reactions"
      },
      "updated_at" : "2023-07-25T14:22:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1649931679",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> UpdatedBlockTip runs in the scheduler thread\r\n\r\nThanks. That sounds like a bug. The unit test should be single threaded, or alternatively drop all async notifications before starting.",
      "created_at" : "2023-07-25T15:30:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/28146#issuecomment-1650064645",
      "id" : 1650064645,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28146",
      "node_id" : "IC_kwDOABII585iWf0F",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1650064645/reactions"
      },
      "updated_at" : "2023-07-25T15:30:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1650064645",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Let's continue discussion in https://github.com/bitcoin/bitcoin/pull/28150",
      "created_at" : "2023-07-25T15:36:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/28146#issuecomment-1650073657",
      "id" : 1650073657,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28146",
      "node_id" : "IC_kwDOABII585iWiA5",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1650073657/reactions"
      },
      "updated_at" : "2023-07-25T15:36:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1650073657",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
