[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24584#discussion_r828016527"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24584"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/828016527"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This assumes that `OUTPUT_TYPES` is sorted by age? Maybe add a comment there to ensure this doesn't break?\r\n\r\nAlso, this is the wrong indentation? Maybe run clang-format?",
      "commit_id" : "fdf1fa5e6c35564f33d874b86a45b7b0731f434d",
      "created_at" : "2022-03-16T13:35:04Z",
      "diff_hunk" : "@@ -767,10 +783,32 @@ static bool CreateTransactionInternal(\n \n     // Get available coins\n     std::vector<COutput> vAvailableCoins;\n-    AvailableCoins(wallet, vAvailableCoins, &coin_control, 1, MAX_MONEY, MAX_MONEY, 0);\n \n-    // Choose coins to use\n-    std::optional<SelectionResult> result = SelectCoins(wallet, vAvailableCoins, /* nTargetValue */ selection_target, coin_control, coin_selection_params);\n+    // First, do coin selection on a filtered subset of coins, filtered by OutputType\n+    // Attempt with older output types first (LEGACY > P2SH > BECH32 > BECH32M)\n+    std::optional<SelectionResult> result = [&] {\n+\tfor (const OutputType& type : OUTPUT_TYPES) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24584#discussion_r828016527",
      "id" : 828016527,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584xWoeP",
      "original_commit_id" : "312d9347b3e5e611ab28c1307d73345576dc4d7d",
      "original_line" : 790,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : null,
      "pull_request_review_id" : 911639998,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24584",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/828016527/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-16T13:41:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/828016527",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> I think an argument against this change is that any privacy leaking tx could very well be a coin-join between two wallets that use different output types. Though, I don't think any such coin-join software exists today, so until then it probably makes sense to use inputs of a single type. \r\n\r\nI agree, until mixed inputs in transactions are more common, this change should improve user privacy.\r\n\r\n> https://github.com/bitcoin/bitcoin/pull/24362#pullrequestreview-909069657 mentions that legacy inputs could preferably be used during low-fee periods to reduce the fees paid by the user. Though, if https://github.com/bitcoin/bitcoin/pull/24362 is merged, then it would probably not be worth it to optimize for fees.\r\n\r\nI prefer this approach over #24362 in order to keep the privacy benefits of matching change output addresses for all address types. I also see this as a small first step, where we can optimize for fees in a later PR if it is deemed useful/worth it. ",
      "created_at" : "2022-03-16T13:59:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24584#issuecomment-1069161907",
      "id" : 1069161907,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24584",
      "node_id" : "IC_kwDOABII584_uh2z",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1069161907/reactions"
      },
      "updated_at" : "2022-03-16T13:59:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1069161907",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7444140?v=4",
         "events_url" : "https://api.github.com/users/josibake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/josibake/followers",
         "following_url" : "https://api.github.com/users/josibake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/josibake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/josibake",
         "id" : 7444140,
         "login" : "josibake",
         "node_id" : "MDQ6VXNlcjc0NDQxNDA=",
         "organizations_url" : "https://api.github.com/users/josibake/orgs",
         "received_events_url" : "https://api.github.com/users/josibake/received_events",
         "repos_url" : "https://api.github.com/users/josibake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/josibake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/josibake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/josibake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24584#discussion_r828065439"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24584"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/828065439"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "good catch, fixed the formatting! also added a comment re: output_types",
      "commit_id" : "fdf1fa5e6c35564f33d874b86a45b7b0731f434d",
      "created_at" : "2022-03-16T14:19:48Z",
      "diff_hunk" : "@@ -767,10 +783,32 @@ static bool CreateTransactionInternal(\n \n     // Get available coins\n     std::vector<COutput> vAvailableCoins;\n-    AvailableCoins(wallet, vAvailableCoins, &coin_control, 1, MAX_MONEY, MAX_MONEY, 0);\n \n-    // Choose coins to use\n-    std::optional<SelectionResult> result = SelectCoins(wallet, vAvailableCoins, /* nTargetValue */ selection_target, coin_control, coin_selection_params);\n+    // First, do coin selection on a filtered subset of coins, filtered by OutputType\n+    // Attempt with older output types first (LEGACY > P2SH > BECH32 > BECH32M)\n+    std::optional<SelectionResult> result = [&] {\n+\tfor (const OutputType& type : OUTPUT_TYPES) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24584#discussion_r828065439",
      "id" : 828065439,
      "in_reply_to_id" : 828016527,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584xW0af",
      "original_commit_id" : "312d9347b3e5e611ab28c1307d73345576dc4d7d",
      "original_line" : 790,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : null,
      "pull_request_review_id" : 911711048,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24584",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/828065439/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-16T14:19:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/828065439",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7444140?v=4",
         "events_url" : "https://api.github.com/users/josibake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/josibake/followers",
         "following_url" : "https://api.github.com/users/josibake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/josibake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/josibake",
         "id" : 7444140,
         "login" : "josibake",
         "node_id" : "MDQ6VXNlcjc0NDQxNDA=",
         "organizations_url" : "https://api.github.com/users/josibake/orgs",
         "received_events_url" : "https://api.github.com/users/josibake/received_events",
         "repos_url" : "https://api.github.com/users/josibake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/josibake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/josibake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/josibake"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Very exciting, I'm glad you're working on this. I was just discussing this idea with people yesterday.\r\n\r\nA couple comments on the approach described in the OP:\r\n- I noticed that you suggest preferring the spending of older types and compare it to spending newer types preferentially. While I do agree that the old types are the ones we'd want to get rid off rather, I am not sure this would lead to the optimal outcome. I would suggest running coin selection for each of the OutputGroup sets in parallel and then choosing the input set per the waste metric. Due to how the waste metric works, I'd expect this to lead to the older larger output types getting preferentially spent at lower feerates (and in the current feerate environment, usually first). What are your thoughts on that?\r\n- Regarding splitting the OutputGroups: since each OutputGroup will only have one type, you could just get the available set once and subdivide it from there to run the coin selection in parallel. Would that perhaps be easier?\r\n- CoinSelection is pretty fast, with the exception of Knapsack, so running it on subsets of the UTXO pool shouldn't be a huge issue, running it on all subsets in parallel may be even faster than running it on the whole UTXO pool once since the complexity of each subset would be much smaller.\r\n\r\nCeterum censeo Knapsackinem esse delendam.",
      "created_at" : "2022-03-16T14:20:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24584#issuecomment-1069182464",
      "id" : 1069182464,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24584",
      "node_id" : "IC_kwDOABII584_um4A",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1069182464/reactions"
      },
      "updated_at" : "2022-03-16T14:20:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1069182464",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "force pushed to fix clang-formatting and add comments per @MarcoFalke 's suggestion. can be verified with `git range-diff master f900010 fdf1fa5`",
      "created_at" : "2022-03-16T14:20:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24584#issuecomment-1069183242",
      "id" : 1069183242,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24584",
      "node_id" : "IC_kwDOABII584_unEK",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1069183242/reactions"
      },
      "updated_at" : "2022-03-16T14:30:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1069183242",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7444140?v=4",
         "events_url" : "https://api.github.com/users/josibake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/josibake/followers",
         "following_url" : "https://api.github.com/users/josibake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/josibake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/josibake",
         "id" : 7444140,
         "login" : "josibake",
         "node_id" : "MDQ6VXNlcjc0NDQxNDA=",
         "organizations_url" : "https://api.github.com/users/josibake/orgs",
         "received_events_url" : "https://api.github.com/users/josibake/received_events",
         "repos_url" : "https://api.github.com/users/josibake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/josibake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/josibake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/josibake"
      }
   }
]
