{
   "_links" : {
      "comments" : {
         "href" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24584/comments"
      },
      "commits" : {
         "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24584/commits"
      },
      "html" : {
         "href" : "https://github.com/bitcoin/bitcoin/pull/24584"
      },
      "issue" : {
         "href" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24584"
      },
      "review_comment" : {
         "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments{/number}"
      },
      "review_comments" : {
         "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24584/comments"
      },
      "self" : {
         "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24584"
      },
      "statuses" : {
         "href" : "https://api.github.com/repos/bitcoin/bitcoin/statuses/fdf1fa5e6c35564f33d874b86a45b7b0731f434d"
      }
   },
   "active_lock_reason" : null,
   "additions" : 278,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "CONTRIBUTOR",
   "auto_merge" : null,
   "base" : {
      "label" : "bitcoin:master",
      "ref" : "master",
      "repo" : {
         "allow_forking" : true,
         "archive_url" : "https://api.github.com/repos/bitcoin/bitcoin/{archive_format}{/ref}",
         "archived" : false,
         "assignees_url" : "https://api.github.com/repos/bitcoin/bitcoin/assignees{/user}",
         "blobs_url" : "https://api.github.com/repos/bitcoin/bitcoin/git/blobs{/sha}",
         "branches_url" : "https://api.github.com/repos/bitcoin/bitcoin/branches{/branch}",
         "clone_url" : "https://github.com/bitcoin/bitcoin.git",
         "collaborators_url" : "https://api.github.com/repos/bitcoin/bitcoin/collaborators{/collaborator}",
         "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/comments{/number}",
         "commits_url" : "https://api.github.com/repos/bitcoin/bitcoin/commits{/sha}",
         "compare_url" : "https://api.github.com/repos/bitcoin/bitcoin/compare/{base}...{head}",
         "contents_url" : "https://api.github.com/repos/bitcoin/bitcoin/contents/{+path}",
         "contributors_url" : "https://api.github.com/repos/bitcoin/bitcoin/contributors",
         "created_at" : "2010-12-19T15:16:43Z",
         "default_branch" : "master",
         "deployments_url" : "https://api.github.com/repos/bitcoin/bitcoin/deployments",
         "description" : "Bitcoin Core integration/staging tree",
         "disabled" : false,
         "downloads_url" : "https://api.github.com/repos/bitcoin/bitcoin/downloads",
         "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/events",
         "fork" : false,
         "forks" : 31819,
         "forks_count" : 31819,
         "forks_url" : "https://api.github.com/repos/bitcoin/bitcoin/forks",
         "full_name" : "bitcoin/bitcoin",
         "git_commits_url" : "https://api.github.com/repos/bitcoin/bitcoin/git/commits{/sha}",
         "git_refs_url" : "https://api.github.com/repos/bitcoin/bitcoin/git/refs{/sha}",
         "git_tags_url" : "https://api.github.com/repos/bitcoin/bitcoin/git/tags{/sha}",
         "git_url" : "git://github.com/bitcoin/bitcoin.git",
         "has_downloads" : false,
         "has_issues" : true,
         "has_pages" : false,
         "has_projects" : true,
         "has_wiki" : false,
         "homepage" : "https://bitcoincore.org/en/download",
         "hooks_url" : "https://api.github.com/repos/bitcoin/bitcoin/hooks",
         "html_url" : "https://github.com/bitcoin/bitcoin",
         "id" : 1181927,
         "is_template" : false,
         "issue_comment_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments{/number}",
         "issue_events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/events{/number}",
         "issues_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues{/number}",
         "keys_url" : "https://api.github.com/repos/bitcoin/bitcoin/keys{/key_id}",
         "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/labels{/name}",
         "language" : "C++",
         "languages_url" : "https://api.github.com/repos/bitcoin/bitcoin/languages",
         "license" : {
            "key" : "mit",
            "name" : "MIT License",
            "node_id" : "MDc6TGljZW5zZTEz",
            "spdx_id" : "MIT",
            "url" : "https://api.github.com/licenses/mit"
         },
         "merges_url" : "https://api.github.com/repos/bitcoin/bitcoin/merges",
         "milestones_url" : "https://api.github.com/repos/bitcoin/bitcoin/milestones{/number}",
         "mirror_url" : null,
         "name" : "bitcoin",
         "node_id" : "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
         "notifications_url" : "https://api.github.com/repos/bitcoin/bitcoin/notifications{?since,all,participating}",
         "open_issues" : 1046,
         "open_issues_count" : 1046,
         "owner" : {
            "avatar_url" : "https://avatars.githubusercontent.com/u/528860?v=4",
            "events_url" : "https://api.github.com/users/bitcoin/events{/privacy}",
            "followers_url" : "https://api.github.com/users/bitcoin/followers",
            "following_url" : "https://api.github.com/users/bitcoin/following{/other_user}",
            "gists_url" : "https://api.github.com/users/bitcoin/gists{/gist_id}",
            "gravatar_id" : "",
            "html_url" : "https://github.com/bitcoin",
            "id" : 528860,
            "login" : "bitcoin",
            "node_id" : "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
            "organizations_url" : "https://api.github.com/users/bitcoin/orgs",
            "received_events_url" : "https://api.github.com/users/bitcoin/received_events",
            "repos_url" : "https://api.github.com/users/bitcoin/repos",
            "site_admin" : false,
            "starred_url" : "https://api.github.com/users/bitcoin/starred{/owner}{/repo}",
            "subscriptions_url" : "https://api.github.com/users/bitcoin/subscriptions",
            "type" : "Organization",
            "url" : "https://api.github.com/users/bitcoin"
         },
         "private" : false,
         "pulls_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls{/number}",
         "pushed_at" : "2022-03-16T14:19:12Z",
         "releases_url" : "https://api.github.com/repos/bitcoin/bitcoin/releases{/id}",
         "size" : 198936,
         "ssh_url" : "git@github.com:bitcoin/bitcoin.git",
         "stargazers_count" : 62474,
         "stargazers_url" : "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
         "statuses_url" : "https://api.github.com/repos/bitcoin/bitcoin/statuses/{sha}",
         "subscribers_url" : "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
         "subscription_url" : "https://api.github.com/repos/bitcoin/bitcoin/subscription",
         "svn_url" : "https://github.com/bitcoin/bitcoin",
         "tags_url" : "https://api.github.com/repos/bitcoin/bitcoin/tags",
         "teams_url" : "https://api.github.com/repos/bitcoin/bitcoin/teams",
         "topics" : [
            "bitcoin",
            "c-plus-plus",
            "cryptocurrency",
            "cryptography",
            "p2p"
         ],
         "trees_url" : "https://api.github.com/repos/bitcoin/bitcoin/git/trees{/sha}",
         "updated_at" : "2022-03-16T14:35:48Z",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin",
         "visibility" : "public",
         "watchers" : 62474,
         "watchers_count" : 62474
      },
      "sha" : "310ba924949b0052105a7937ac69d65a3864692b",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/528860?v=4",
         "events_url" : "https://api.github.com/users/bitcoin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bitcoin/followers",
         "following_url" : "https://api.github.com/users/bitcoin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bitcoin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bitcoin",
         "id" : 528860,
         "login" : "bitcoin",
         "node_id" : "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
         "organizations_url" : "https://api.github.com/users/bitcoin/orgs",
         "received_events_url" : "https://api.github.com/users/bitcoin/received_events",
         "repos_url" : "https://api.github.com/users/bitcoin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bitcoin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bitcoin/subscriptions",
         "type" : "Organization",
         "url" : "https://api.github.com/users/bitcoin"
      }
   },
   "body" : "_**NOTE:**_ the first commit (`test: make feature_coinstatindex deterministic`) is handled in https://github.com/bitcoin/bitcoin/pull/24570\r\n\r\n# Concept\r\n\r\nFollowing https://github.com/bitcoin/bitcoin/pull/23789, Bitcoin Core wallet will now generate a change address that matches the payment address type. This improves privacy by not revealing which of the outputs is the change at the time of the transaction in scenarios where the input address types differ from the payment address type.\r\n\r\nThis raises two concerns:\r\n\r\n1) Information about the change can be leaked in a later transaction\r\n2) Wallets can start accumulating older `OutputType` UTXOs\r\n\r\nThis proposal attempts to address these concerns.\r\n\r\n## Leaking information in a later transaction\r\n\r\nConsider the following scenario:\r\n\r\n![mix input types(1)](https://user-images.githubusercontent.com/7444140/158597086-788339b0-c698-4b60-bd45-9ede4cd3a483.png)\r\n\r\n1. Alice has a wallet with bech32 type UTXOs and pays Bob, who gives her a P2SH address\r\n2. Alice's wallet generates a P2SH change output, preserving her privacy in `txid: a`\r\n3. Alice then pays Carol, who gives her a bech32 address\r\n4. Alice's wallet combines the P2SH UTXO with a bech32 UTXO and `txid: b` has two bech32 outputs\r\n\r\nFrom a chain analysis perspective, it is reasonable to infer that the P2SH Output in `txid: b` was the change from `txid: a`. To avoid leaking information in this scenario, Alice's wallet should avoid picking the P2SH output and instead fund the transaction with only bech32 Outputs. If the payment to Carol can be funded with just the P2SH output, it should be preferred over the bech32 outputs as this will convert the P2SH UTXO to bech32 UTXOs via the payment and change outputs of the new transaction.\r\n\r\n**TLDR;** Avoid mixing output types, always prefer spending older output types first.\r\n\r\n## Accumulating older `OutputType` UTXOs\r\n\r\nIf a user defaults to using bech32/bech32m addresses in their wallet, it is undesirable to accumulate older type UTXOs. However, this can happen if many payments to older type address are made. Consider the following scenario:\r\n\r\n![utxo rotation(1)](https://user-images.githubusercontent.com/7444140/158597154-30789d40-82ff-499c-b2d3-4783a5db4842.png)\r\n\r\nAlice has only bech32 UTXOs in her wallet. Over time, she makes many payments to Bob, who always provides P2SH addresses. If her wallet consistently spends the bech32 UTXOs first, she will eventually rotate all of her bech32 UTXOs into P2SH UTXOs.\r\n\r\nThis can be mitigated by always preferring to spend older type outputs first. After Alice's first payment to Bob, Alice's wallet should attempt to spend the P2SH outputs first, effectively clearing them out of the wallet. If Alice has a mix of Legacy and P2SH outputs and neither group is able to fund the transaction by itself, her wallet should first mix these two output types before mixing with bech32/bech32m\r\n\r\n**TLDR;** Always try to spend older type outputs first. If a transaction can't be funded from any single group of older outputs, mix older output types first before spending default outputs.\r\n\r\n# Aproach\r\n\r\nI have written a rudimentary first pass at this by adding a filter to `AvailableCoins` and then running multiple rounds of coin selection, leaving the coin selection algorithm unchanged. The mapping from `TxoutType` -> `OutputType` feels hacky and I'm sure I'm not covering every edge case, so I'm hoping this can be improved. Additionally, in the worst case, this can lead to running coin selection 6 times. This can be improved if there is a way to grab all UTXOs owned by the wallet by `OutputType`, rather than iterating over the full set each time with a different filter.\r\n\r\nI've added a functional test (`test/functional/wallet_avoid_mixing_output_types.py`) so that the approach can be easily iterated on to make it less hacky and improve performance\r\n\r\n## Requests for reviewers\r\n\r\n* If the concept is good, I am looking for feedback on how to improve the approach\r\n* Suggestions on additional cases to test for in the functional test",
   "changed_files" : 6,
   "closed_at" : null,
   "comments" : 3,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24584/comments",
   "commits" : 3,
   "commits_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24584/commits",
   "created_at" : "2022-03-16T13:13:49Z",
   "deletions" : 8,
   "diff_url" : "https://github.com/bitcoin/bitcoin/pull/24584.diff",
   "draft" : false,
   "head" : {
      "label" : "josibake:josibake-coin-selection-v2",
      "ref" : "josibake-coin-selection-v2",
      "repo" : {
         "allow_forking" : true,
         "archive_url" : "https://api.github.com/repos/josibake/bitcoin/{archive_format}{/ref}",
         "archived" : false,
         "assignees_url" : "https://api.github.com/repos/josibake/bitcoin/assignees{/user}",
         "blobs_url" : "https://api.github.com/repos/josibake/bitcoin/git/blobs{/sha}",
         "branches_url" : "https://api.github.com/repos/josibake/bitcoin/branches{/branch}",
         "clone_url" : "https://github.com/josibake/bitcoin.git",
         "collaborators_url" : "https://api.github.com/repos/josibake/bitcoin/collaborators{/collaborator}",
         "comments_url" : "https://api.github.com/repos/josibake/bitcoin/comments{/number}",
         "commits_url" : "https://api.github.com/repos/josibake/bitcoin/commits{/sha}",
         "compare_url" : "https://api.github.com/repos/josibake/bitcoin/compare/{base}...{head}",
         "contents_url" : "https://api.github.com/repos/josibake/bitcoin/contents/{+path}",
         "contributors_url" : "https://api.github.com/repos/josibake/bitcoin/contributors",
         "created_at" : "2021-03-04T14:24:20Z",
         "default_branch" : "master",
         "deployments_url" : "https://api.github.com/repos/josibake/bitcoin/deployments",
         "description" : "Bitcoin Core integration/staging tree",
         "disabled" : false,
         "downloads_url" : "https://api.github.com/repos/josibake/bitcoin/downloads",
         "events_url" : "https://api.github.com/repos/josibake/bitcoin/events",
         "fork" : true,
         "forks" : 0,
         "forks_count" : 0,
         "forks_url" : "https://api.github.com/repos/josibake/bitcoin/forks",
         "full_name" : "josibake/bitcoin",
         "git_commits_url" : "https://api.github.com/repos/josibake/bitcoin/git/commits{/sha}",
         "git_refs_url" : "https://api.github.com/repos/josibake/bitcoin/git/refs{/sha}",
         "git_tags_url" : "https://api.github.com/repos/josibake/bitcoin/git/tags{/sha}",
         "git_url" : "git://github.com/josibake/bitcoin.git",
         "has_downloads" : false,
         "has_issues" : false,
         "has_pages" : false,
         "has_projects" : true,
         "has_wiki" : false,
         "homepage" : "https://bitcoincore.org/en/download",
         "hooks_url" : "https://api.github.com/repos/josibake/bitcoin/hooks",
         "html_url" : "https://github.com/josibake/bitcoin",
         "id" : 344501009,
         "is_template" : false,
         "issue_comment_url" : "https://api.github.com/repos/josibake/bitcoin/issues/comments{/number}",
         "issue_events_url" : "https://api.github.com/repos/josibake/bitcoin/issues/events{/number}",
         "issues_url" : "https://api.github.com/repos/josibake/bitcoin/issues{/number}",
         "keys_url" : "https://api.github.com/repos/josibake/bitcoin/keys{/key_id}",
         "labels_url" : "https://api.github.com/repos/josibake/bitcoin/labels{/name}",
         "language" : "C++",
         "languages_url" : "https://api.github.com/repos/josibake/bitcoin/languages",
         "license" : {
            "key" : "mit",
            "name" : "MIT License",
            "node_id" : "MDc6TGljZW5zZTEz",
            "spdx_id" : "MIT",
            "url" : "https://api.github.com/licenses/mit"
         },
         "merges_url" : "https://api.github.com/repos/josibake/bitcoin/merges",
         "milestones_url" : "https://api.github.com/repos/josibake/bitcoin/milestones{/number}",
         "mirror_url" : null,
         "name" : "bitcoin",
         "node_id" : "MDEwOlJlcG9zaXRvcnkzNDQ1MDEwMDk=",
         "notifications_url" : "https://api.github.com/repos/josibake/bitcoin/notifications{?since,all,participating}",
         "open_issues" : 0,
         "open_issues_count" : 0,
         "owner" : {
            "avatar_url" : "https://avatars.githubusercontent.com/u/7444140?v=4",
            "events_url" : "https://api.github.com/users/josibake/events{/privacy}",
            "followers_url" : "https://api.github.com/users/josibake/followers",
            "following_url" : "https://api.github.com/users/josibake/following{/other_user}",
            "gists_url" : "https://api.github.com/users/josibake/gists{/gist_id}",
            "gravatar_id" : "",
            "html_url" : "https://github.com/josibake",
            "id" : 7444140,
            "login" : "josibake",
            "node_id" : "MDQ6VXNlcjc0NDQxNDA=",
            "organizations_url" : "https://api.github.com/users/josibake/orgs",
            "received_events_url" : "https://api.github.com/users/josibake/received_events",
            "repos_url" : "https://api.github.com/users/josibake/repos",
            "site_admin" : false,
            "starred_url" : "https://api.github.com/users/josibake/starred{/owner}{/repo}",
            "subscriptions_url" : "https://api.github.com/users/josibake/subscriptions",
            "type" : "User",
            "url" : "https://api.github.com/users/josibake"
         },
         "private" : false,
         "pulls_url" : "https://api.github.com/repos/josibake/bitcoin/pulls{/number}",
         "pushed_at" : "2022-03-16T14:19:07Z",
         "releases_url" : "https://api.github.com/repos/josibake/bitcoin/releases{/id}",
         "size" : 194905,
         "ssh_url" : "git@github.com:josibake/bitcoin.git",
         "stargazers_count" : 0,
         "stargazers_url" : "https://api.github.com/repos/josibake/bitcoin/stargazers",
         "statuses_url" : "https://api.github.com/repos/josibake/bitcoin/statuses/{sha}",
         "subscribers_url" : "https://api.github.com/repos/josibake/bitcoin/subscribers",
         "subscription_url" : "https://api.github.com/repos/josibake/bitcoin/subscription",
         "svn_url" : "https://github.com/josibake/bitcoin",
         "tags_url" : "https://api.github.com/repos/josibake/bitcoin/tags",
         "teams_url" : "https://api.github.com/repos/josibake/bitcoin/teams",
         "topics" : [],
         "trees_url" : "https://api.github.com/repos/josibake/bitcoin/git/trees{/sha}",
         "updated_at" : "2022-01-04T15:38:49Z",
         "url" : "https://api.github.com/repos/josibake/bitcoin",
         "visibility" : "public",
         "watchers" : 0,
         "watchers_count" : 0
      },
      "sha" : "fdf1fa5e6c35564f33d874b86a45b7b0731f434d",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7444140?v=4",
         "events_url" : "https://api.github.com/users/josibake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/josibake/followers",
         "following_url" : "https://api.github.com/users/josibake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/josibake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/josibake",
         "id" : 7444140,
         "login" : "josibake",
         "node_id" : "MDQ6VXNlcjc0NDQxNDA=",
         "organizations_url" : "https://api.github.com/users/josibake/orgs",
         "received_events_url" : "https://api.github.com/users/josibake/received_events",
         "repos_url" : "https://api.github.com/users/josibake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/josibake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/josibake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/josibake"
      }
   },
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/24584",
   "id" : 881343029,
   "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24584",
   "labels" : [
      {
         "color" : "08a781",
         "default" : false,
         "description" : null,
         "id" : 149424,
         "name" : "Wallet",
         "node_id" : "MDU6TGFiZWwxNDk0MjQ=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Wallet"
      }
   ],
   "locked" : false,
   "maintainer_can_modify" : true,
   "merge_commit_sha" : "07b0683cd8a00c190e3d19a22c5c195eb9e952eb",
   "mergeable" : true,
   "mergeable_state" : "blocked",
   "merged" : false,
   "merged_at" : null,
   "merged_by" : null,
   "milestone" : null,
   "node_id" : "PR_kwDOABII5840iDo1",
   "number" : 24584,
   "patch_url" : "https://github.com/bitcoin/bitcoin/pull/24584.patch",
   "rebaseable" : true,
   "requested_reviewers" : [],
   "requested_teams" : [],
   "review_comment_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments{/number}",
   "review_comments" : 3,
   "review_comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24584/comments",
   "state" : "open",
   "statuses_url" : "https://api.github.com/repos/bitcoin/bitcoin/statuses/fdf1fa5e6c35564f33d874b86a45b7b0731f434d",
   "title" : "[RFC] wallet: avoid mixing different `OutputTypes` during coin selection",
   "updated_at" : "2022-03-16T14:35:28Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24584",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/7444140?v=4",
      "events_url" : "https://api.github.com/users/josibake/events{/privacy}",
      "followers_url" : "https://api.github.com/users/josibake/followers",
      "following_url" : "https://api.github.com/users/josibake/following{/other_user}",
      "gists_url" : "https://api.github.com/users/josibake/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/josibake",
      "id" : 7444140,
      "login" : "josibake",
      "node_id" : "MDQ6VXNlcjc0NDQxNDA=",
      "organizations_url" : "https://api.github.com/users/josibake/orgs",
      "received_events_url" : "https://api.github.com/users/josibake/received_events",
      "repos_url" : "https://api.github.com/users/josibake/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/josibake/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/josibake/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/josibake"
   }
}
