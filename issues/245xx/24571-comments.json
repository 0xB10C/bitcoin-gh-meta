[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#25144](https://github.com/bitcoin/bitcoin/pull/25144) (refactor: Pass Peer& to Misbehaving() by MarcoFalke)\n* [#25096](https://github.com/bitcoin/bitcoin/pull/25096) ([net] Minor improvements to addr caching by dergoegge)\n* [#24970](https://github.com/bitcoin/bitcoin/pull/24970) (net processing: Move cleanSubVer, fPreferredDownload and nLocalHostNonce to Peer by jnewbery)\n* [#24232](https://github.com/bitcoin/bitcoin/pull/24232) (assumeutxo: add init and completion logic by jamesob)\n* [#24008](https://github.com/bitcoin/bitcoin/pull/24008) (assumeutxo: net_processing changes by jamesob)\n* [#19888](https://github.com/bitcoin/bitcoin/pull/19888) (rpc, test: Improve getblockstats for unspendables by fjahr)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-03-15T18:50:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#issuecomment-1068342401",
      "id" : 1068342401,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24571",
      "node_id" : "IC_kwDOABII584_rZyB",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1068342401/reactions"
      },
      "updated_at" : "2022-05-18T15:50:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1068342401",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK\r\nNeat and creative finding.\r\n\r\nAs I understood it,\r\nAn attacker is currently able to see whether a node received a stale block previously, by sending headers *on top of that stale block* (does it require proof-of-work for this attack?).\r\nThis PR prevents it by sending `getheaders` even if a block was received already (but was marked stale).",
      "created_at" : "2022-03-19T13:29:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#issuecomment-1073010413",
      "id" : 1073010413,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24571",
      "node_id" : "IC_kwDOABII584_9Nbt",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1073010413/reactions"
      },
      "updated_at" : "2022-03-19T13:29:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1073010413",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r830484846"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/830484846"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm not sure this is a good var name. This specific PR has nothing to do with valid scripts for example.",
      "commit_id" : "b4d108e7a71e69c0c5a82ebc3ce7f7abfd7dd83f",
      "created_at" : "2022-03-19T13:35:37Z",
      "diff_hunk" : "@@ -614,7 +614,7 @@ class PeerManagerImpl final : public PeerManager\n      * and in best equivalent proof of work) than the best header chain we know\n      * about and we fully-validated them at some point.\n      */\n-    bool BlockRequestAllowed(const CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+    bool BlockRequestAllowed(const CBlockIndex* pindex, bool check_valid_scripts = true) EXCLUSIVE_LOCKS_REQUIRED(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r830484846",
      "id" : 830484846,
      "line" : 617,
      "node_id" : "PRRC_kwDOABII584xgDFu",
      "original_commit_id" : "3a112657530f09e62b96c2575cbb5284461606b3",
      "original_line" : 617,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 5,
      "pull_request_review_id" : 915003480,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/830484846/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-19T13:35:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/830484846",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r830489678"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/830489678"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Seems like a good refactor candidate, as these conditions are hard to follow and review.",
      "commit_id" : "b4d108e7a71e69c0c5a82ebc3ce7f7abfd7dd83f",
      "created_at" : "2022-03-19T14:23:48Z",
      "diff_hunk" : "@@ -1451,12 +1451,12 @@ bool PeerManagerImpl::MaybePunishNodeForTx(NodeId nodeid, const TxValidationStat\n     return false;\n }\n \n-bool PeerManagerImpl::BlockRequestAllowed(const CBlockIndex* pindex)\n+bool PeerManagerImpl::BlockRequestAllowed(const CBlockIndex* pindex, bool check_valid_scripts)\n {\n     AssertLockHeld(cs_main);\n     if (m_chainman.ActiveChain().Contains(pindex)) return true;\n-    return pindex->IsValid(BLOCK_VALID_SCRIPTS) && (pindexBestHeader != nullptr) &&\n-           (pindexBestHeader->GetBlockTime() - pindex->GetBlockTime() < STALE_RELAY_AGE_LIMIT) &&\n+    return (!check_valid_scripts || pindex->IsValid(BLOCK_VALID_SCRIPTS)) &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r830489678",
      "id" : 830489678,
      "line" : 1458,
      "node_id" : "PRRC_kwDOABII584xgERO",
      "original_commit_id" : "3a112657530f09e62b96c2575cbb5284461606b3",
      "original_line" : 1458,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 20,
      "pull_request_review_id" : 915007116,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/830489678/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-19T14:23:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/830489678",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r830489913"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/830489913"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Here and below, we would benefit from explaining why it's fine to `getheaders` if we have a parent, but it is a stale block",
      "commit_id" : "b4d108e7a71e69c0c5a82ebc3ce7f7abfd7dd83f",
      "created_at" : "2022-03-19T14:25:33Z",
      "diff_hunk" : "@@ -2129,7 +2129,8 @@ void PeerManagerImpl::ProcessHeadersMessage(CNode& pfrom, const Peer& peer,\n         //   don't connect before giving DoS points\n         // - Once a headers message is received that is valid and does connect,\n         //   nUnconnectingHeaders gets reset back to 0.\n-        if (!m_chainman.m_blockman.LookupBlockIndex(headers[0].hashPrevBlock) && nCount < MAX_BLOCKS_TO_ANNOUNCE) {\n+        const CBlockIndex* prev_header_index = m_chainman.m_blockman.LookupBlockIndex(headers[0].hashPrevBlock);\n+        if ((!prev_header_index || !BlockRequestAllowed(prev_header_index, false)) && nCount < MAX_BLOCKS_TO_ANNOUNCE) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r830489913",
      "id" : 830489913,
      "line" : 2133,
      "node_id" : "PRRC_kwDOABII584xgEU5",
      "original_commit_id" : "3a112657530f09e62b96c2575cbb5284461606b3",
      "original_line" : 2133,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 31,
      "pull_request_review_id" : 915007247,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/830489913/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-19T14:25:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/830489913",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r831128364"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/831128364"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good point, i added a refactor commit that also adds some comments.",
      "commit_id" : "4e4150671da770f7d2756ec7c1d199ff8d3ef4ca",
      "created_at" : "2022-03-21T13:49:40Z",
      "diff_hunk" : "@@ -1451,12 +1451,12 @@ bool PeerManagerImpl::MaybePunishNodeForTx(NodeId nodeid, const TxValidationStat\n     return false;\n }\n \n-bool PeerManagerImpl::BlockRequestAllowed(const CBlockIndex* pindex)\n+bool PeerManagerImpl::BlockRequestAllowed(const CBlockIndex* pindex, bool check_valid_scripts)\n {\n     AssertLockHeld(cs_main);\n     if (m_chainman.ActiveChain().Contains(pindex)) return true;\n-    return pindex->IsValid(BLOCK_VALID_SCRIPTS) && (pindexBestHeader != nullptr) &&\n-           (pindexBestHeader->GetBlockTime() - pindex->GetBlockTime() < STALE_RELAY_AGE_LIMIT) &&\n+    return (!check_valid_scripts || pindex->IsValid(BLOCK_VALID_SCRIPTS)) &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r831128364",
      "id" : 831128364,
      "in_reply_to_id" : 830489678,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584xigMs",
      "original_commit_id" : "3a112657530f09e62b96c2575cbb5284461606b3",
      "original_line" : 1458,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 915772756,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/831128364/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-21T13:49:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/831128364",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r831130729"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/831130729"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I will actually think about this some more because i am not sure if there are no side effects to requesting headers that we already have in our index.",
      "commit_id" : "4e4150671da770f7d2756ec7c1d199ff8d3ef4ca",
      "created_at" : "2022-03-21T13:51:57Z",
      "diff_hunk" : "@@ -2129,7 +2129,8 @@ void PeerManagerImpl::ProcessHeadersMessage(CNode& pfrom, const Peer& peer,\n         //   don't connect before giving DoS points\n         // - Once a headers message is received that is valid and does connect,\n         //   nUnconnectingHeaders gets reset back to 0.\n-        if (!m_chainman.m_blockman.LookupBlockIndex(headers[0].hashPrevBlock) && nCount < MAX_BLOCKS_TO_ANNOUNCE) {\n+        const CBlockIndex* prev_header_index = m_chainman.m_blockman.LookupBlockIndex(headers[0].hashPrevBlock);\n+        if ((!prev_header_index || !BlockRequestAllowed(prev_header_index, false)) && nCount < MAX_BLOCKS_TO_ANNOUNCE) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r831130729",
      "id" : 831130729,
      "in_reply_to_id" : 830489913,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584xigxp",
      "original_commit_id" : "3a112657530f09e62b96c2575cbb5284461606b3",
      "original_line" : 2133,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 915776369,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/831130729/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-21T13:51:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/831130729",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thank you @naumenkogs for the review!\r\n\r\n> does it require proof-of-work for this attack?\r\n\r\nIt does not, the header that the attacker uses can be completely invalid. The proof-of-work check happens later on in `ChainstateManager::ProcessNewBlockHeaders`. The test i included also uses headers that do not have any proof-of-work on them.",
      "created_at" : "2022-03-21T13:59:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#issuecomment-1073932160",
      "id" : 1073932160,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24571",
      "node_id" : "IC_kwDOABII585AAueA",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1073932160/reactions"
      },
      "updated_at" : "2022-03-21T13:59:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1073932160",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r844818488"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/844818488"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n    bool BlockRequestAllowed(const CBlockIndex* pindex, const bool allow_potentially_invalid_headers = false) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\r\n```",
      "commit_id" : "4e4150671da770f7d2756ec7c1d199ff8d3ef4ca",
      "created_at" : "2022-04-07T07:41:07Z",
      "diff_hunk" : "@@ -614,7 +614,7 @@ class PeerManagerImpl final : public PeerManager\n      * and in best equivalent proof of work) than the best header chain we know\n      * about and we fully-validated them at some point.\n      */\n-    bool BlockRequestAllowed(const CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+    bool BlockRequestAllowed(const CBlockIndex* pindex, bool allow_potentially_invalid_headers = false) EXCLUSIVE_LOCKS_REQUIRED(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r844818488",
      "id" : 844818488,
      "line" : 617,
      "node_id" : "PRRC_kwDOABII584yWug4",
      "original_commit_id" : "4e4150671da770f7d2756ec7c1d199ff8d3ef4ca",
      "original_line" : 617,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 5,
      "pull_request_review_id" : 933756078,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/844818488/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-07T07:55:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/844818488",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19157360?v=4",
         "events_url" : "https://api.github.com/users/0xB10C/events{/privacy}",
         "followers_url" : "https://api.github.com/users/0xB10C/followers",
         "following_url" : "https://api.github.com/users/0xB10C/following{/other_user}",
         "gists_url" : "https://api.github.com/users/0xB10C/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/0xB10C",
         "id" : 19157360,
         "login" : "0xB10C",
         "node_id" : "MDQ6VXNlcjE5MTU3MzYw",
         "organizations_url" : "https://api.github.com/users/0xB10C/orgs",
         "received_events_url" : "https://api.github.com/users/0xB10C/received_events",
         "repos_url" : "https://api.github.com/users/0xB10C/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/0xB10C/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/0xB10C/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/0xB10C"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r844818766"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/844818766"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\nbool PeerManagerImpl::BlockRequestAllowed(const CBlockIndex* pindex, const bool allow_potentially_invalid_headers)\r\n```",
      "commit_id" : "4e4150671da770f7d2756ec7c1d199ff8d3ef4ca",
      "created_at" : "2022-04-07T07:41:26Z",
      "diff_hunk" : "@@ -1451,13 +1451,38 @@ bool PeerManagerImpl::MaybePunishNodeForTx(NodeId nodeid, const TxValidationStat\n     return false;\n }\n \n-bool PeerManagerImpl::BlockRequestAllowed(const CBlockIndex* pindex)\n+bool PeerManagerImpl::BlockRequestAllowed(const CBlockIndex* pindex, bool allow_potentially_invalid_headers)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r844818766",
      "id" : 844818766,
      "line" : 1454,
      "node_id" : "PRRC_kwDOABII584yWulO",
      "original_commit_id" : "4e4150671da770f7d2756ec7c1d199ff8d3ef4ca",
      "original_line" : 1454,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 14,
      "pull_request_review_id" : 933756078,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/844818766/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-07T07:55:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/844818766",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19157360?v=4",
         "events_url" : "https://api.github.com/users/0xB10C/events{/privacy}",
         "followers_url" : "https://api.github.com/users/0xB10C/followers",
         "following_url" : "https://api.github.com/users/0xB10C/following{/other_user}",
         "gists_url" : "https://api.github.com/users/0xB10C/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/0xB10C",
         "id" : 19157360,
         "login" : "0xB10C",
         "node_id" : "MDQ6VXNlcjE5MTU3MzYw",
         "organizations_url" : "https://api.github.com/users/0xB10C/orgs",
         "received_events_url" : "https://api.github.com/users/0xB10C/received_events",
         "repos_url" : "https://api.github.com/users/0xB10C/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/0xB10C/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/0xB10C/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/0xB10C"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r844821753"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/844821753"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "As mentioned in the PR review club, the motivation for introducing `allow_potentially_invalid_headers` isn't clear from the PR or commit.",
      "commit_id" : "4e4150671da770f7d2756ec7c1d199ff8d3ef4ca",
      "created_at" : "2022-04-07T07:44:48Z",
      "diff_hunk" : "@@ -1451,13 +1451,38 @@ bool PeerManagerImpl::MaybePunishNodeForTx(NodeId nodeid, const TxValidationStat\n     return false;\n }\n \n-bool PeerManagerImpl::BlockRequestAllowed(const CBlockIndex* pindex)\n+bool PeerManagerImpl::BlockRequestAllowed(const CBlockIndex* pindex, bool allow_potentially_invalid_headers)\n {\n     AssertLockHeld(cs_main);\n-    if (m_chainman.ActiveChain().Contains(pindex)) return true;\n-    return pindex->IsValid(BLOCK_VALID_SCRIPTS) && (pindexBestHeader != nullptr) &&\n-           (pindexBestHeader->GetBlockTime() - pindex->GetBlockTime() < STALE_RELAY_AGE_LIMIT) &&\n-           (GetBlockProofEquivalentTime(*pindexBestHeader, *pindex, *pindexBestHeader, m_chainparams.GetConsensus()) < STALE_RELAY_AGE_LIMIT);\n+\n+    if (!m_chainman.ActiveChain().Contains(pindex)) {\n+        // This is a stale block and we restrict access to them under certain\n+        // conditions to avoid leaking a fingerprint.\n+\n+        if (!allow_potentially_invalid_headers) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r844821753",
      "id" : 844821753,
      "line" : 1462,
      "node_id" : "PRRC_kwDOABII584yWvT5",
      "original_commit_id" : "4e4150671da770f7d2756ec7c1d199ff8d3ef4ca",
      "original_line" : 1462,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 26,
      "pull_request_review_id" : 933756078,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/844821753/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-07T10:28:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/844821753",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19157360?v=4",
         "events_url" : "https://api.github.com/users/0xB10C/events{/privacy}",
         "followers_url" : "https://api.github.com/users/0xB10C/followers",
         "following_url" : "https://api.github.com/users/0xB10C/following{/other_user}",
         "gists_url" : "https://api.github.com/users/0xB10C/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/0xB10C",
         "id" : 19157360,
         "login" : "0xB10C",
         "node_id" : "MDQ6VXNlcjE5MTU3MzYw",
         "organizations_url" : "https://api.github.com/users/0xB10C/orgs",
         "received_events_url" : "https://api.github.com/users/0xB10C/received_events",
         "repos_url" : "https://api.github.com/users/0xB10C/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/0xB10C/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/0xB10C/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/0xB10C"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r844974612"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/844974612"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n        if ((!prev_header_index || !BlockRequestAllowed(prev_header_index, /*allow_potentially_invalid_headers=*/true)) && nCount < MAX_BLOCKS_TO_ANNOUNCE) {\r\n```\r\nAnywhere you are adding / touching named args, please use the [style from the developer docs](https://github.com/bitcoin/bitcoin/blob/master/doc/developer-notes.md#coding-style-c-named-arguments).",
      "commit_id" : "4e4150671da770f7d2756ec7c1d199ff8d3ef4ca",
      "created_at" : "2022-04-07T10:27:10Z",
      "diff_hunk" : "@@ -2129,7 +2154,8 @@ void PeerManagerImpl::ProcessHeadersMessage(CNode& pfrom, const Peer& peer,\n         //   don't connect before giving DoS points\n         // - Once a headers message is received that is valid and does connect,\n         //   nUnconnectingHeaders gets reset back to 0.\n-        if (!m_chainman.m_blockman.LookupBlockIndex(headers[0].hashPrevBlock) && nCount < MAX_BLOCKS_TO_ANNOUNCE) {\n+        const CBlockIndex* prev_header_index = m_chainman.m_blockman.LookupBlockIndex(headers[0].hashPrevBlock);\n+        if ((!prev_header_index || !BlockRequestAllowed(prev_header_index, /* allow_potentially_invalid_headers= */ true)) && nCount < MAX_BLOCKS_TO_ANNOUNCE) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r844974612",
      "id" : 844974612,
      "line" : 2158,
      "node_id" : "PRRC_kwDOABII584yXUoU",
      "original_commit_id" : "4e4150671da770f7d2756ec7c1d199ff8d3ef4ca",
      "original_line" : 2158,
      "original_position" : 59,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 59,
      "pull_request_review_id" : 934838825,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/844974612/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-07T10:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/844974612",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r849710370"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849710370"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Here and above you might add a `LogPrint` notifying a non-allowed header has been denied of request, like the others callsites of `BlockRequestAllowed` (\"ignoring request from peer=%i for old blocks that isn't in the main chain\"). Nice to monitor eventual fingerprinting attacks attempts or other anomalies.",
      "commit_id" : "4e4150671da770f7d2756ec7c1d199ff8d3ef4ca",
      "created_at" : "2022-04-13T17:06:00Z",
      "diff_hunk" : "@@ -3505,7 +3531,8 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         {\n         LOCK(cs_main);\n \n-        if (!m_chainman.m_blockman.LookupBlockIndex(cmpctblock.header.hashPrevBlock)) {\n+        const CBlockIndex* prev_header_index = m_chainman.m_blockman.LookupBlockIndex(cmpctblock.header.hashPrevBlock);\n+        if (!prev_header_index || !BlockRequestAllowed(prev_header_index, /* allow_potentially_invalid_headers= */ true)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r849710370",
      "id" : 849710370,
      "line" : 3535,
      "node_id" : "PRRC_kwDOABII584ypY0i",
      "original_commit_id" : "4e4150671da770f7d2756ec7c1d199ff8d3ef4ca",
      "original_line" : 3535,
      "original_position" : 69,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 69,
      "pull_request_review_id" : 941295811,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849710370/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-13T17:07:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849710370",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks everyone for the review so far! I am working on addressing all your feedback.\r\nI will mark this as a draft for now and rework my approach because currently this messes with large reorgs in some instances. I am working on a functional test for these scenarios which i might PR separately as none of the current tests caught this.\r\n\r\n@ariard Good point bringing up BIP157 requests but luckily we already handle them safely, see: https://github.com/bitcoin/bitcoin/blob/b69fd5eaa99f84b62a49d7c7f48d8cee1227592a/src/net_processing.cpp#L2437",
      "created_at" : "2022-04-14T16:13:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#issuecomment-1099354920",
      "id" : 1099354920,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24571",
      "node_id" : "IC_kwDOABII585BhtMo",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1099354920/reactions"
      },
      "updated_at" : "2022-04-14T16:33:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1099354920",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-04-20T11:23:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#issuecomment-1103820508",
      "id" : 1103820508,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24571",
      "node_id" : "IC_kwDOABII585Byvbc",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1103820508/reactions"
      },
      "updated_at" : "2022-04-20T11:23:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1103820508",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2022-04-24T13:36:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#issuecomment-1107843661",
      "id" : 1107843661,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24571",
      "node_id" : "IC_kwDOABII585CCFpN",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1107843661/reactions"
      },
      "updated_at" : "2022-04-24T13:36:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1107843661",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r859689379"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/859689379"
         }
      },
      "author_association" : "MEMBER",
      "body" : "With the new approach the log message reflects whether the previous block existed or if the peer was not allowed to know about it (potential fingerprint).",
      "commit_id" : "2021f7c706fbd34f6dcc53398ed7de5b2a15ffc1",
      "created_at" : "2022-04-27T11:37:33Z",
      "diff_hunk" : "@@ -3505,7 +3531,8 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         {\n         LOCK(cs_main);\n \n-        if (!m_chainman.m_blockman.LookupBlockIndex(cmpctblock.header.hashPrevBlock)) {\n+        const CBlockIndex* prev_header_index = m_chainman.m_blockman.LookupBlockIndex(cmpctblock.header.hashPrevBlock);\n+        if (!prev_header_index || !BlockRequestAllowed(prev_header_index, /* allow_potentially_invalid_headers= */ true)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r859689379",
      "id" : 859689379,
      "in_reply_to_id" : 849710370,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584zPdGj",
      "original_commit_id" : "4e4150671da770f7d2756ec7c1d199ff8d3ef4ca",
      "original_line" : 3535,
      "original_position" : 69,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 954749411,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/859689379/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-27T11:37:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/859689379",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I updated this PR with the new approach (see commits and new PR description) and itâs now ready for review again. Most of the review comments did not apply anymore so i marked them as resolved.\r\n\r\nThe previous approach can be found on [this](https://github.com/dergoegge/bitcoin/tree/2022-03-header-fingerprinting-v1) branch.\r\nThe test for the reorg issue i [mentioned](https://github.com/bitcoin/bitcoin/pull/24571#issuecomment-1099354920) before can be found [here](https://github.com/dergoegge/bitcoin/commits/2022-04-large-reorg-test).",
      "created_at" : "2022-04-27T11:41:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#issuecomment-1110900017",
      "id" : 1110900017,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24571",
      "node_id" : "IC_kwDOABII585CNv0x",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1110900017/reactions"
      },
      "updated_at" : "2022-04-27T11:41:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1110900017",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r863637321"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/863637321"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This function could be introduced in commit 0fdd0eb66a85189f2c32c33defb4322fd2a914dd (*[net processing] Prevent fingerprinting when receiving header*), rather than the previous commit.\r\n",
      "commit_id" : "2021f7c706fbd34f6dcc53398ed7de5b2a15ffc1",
      "created_at" : "2022-05-03T10:09:32Z",
      "diff_hunk" : "@@ -640,6 +652,9 @@ class PeerManagerImpl final : public PeerManager\n     void UpdateBlockAvailability(NodeId nodeid, const uint256& hash) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n     bool CanDirectFetch() EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    void UpdateKnownChainTips(NodeId node_id, const CBlockIndex& new_index);\n+    bool IsIndexOnKnownChain(NodeId node_id, const CBlockIndex& index);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r863637321",
      "id" : 863637321,
      "line" : 656,
      "node_id" : "PRRC_kwDOABII584zeg9J",
      "original_commit_id" : "2021f7c706fbd34f6dcc53398ed7de5b2a15ffc1",
      "original_line" : 656,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 24,
      "pull_request_review_id" : 960165091,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/863637321/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-03T10:18:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/863637321",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r863638047"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/863638047"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It seems wrong to set a validation state in net_processing - these should be set in validation and acted on by the client. I think here you could just call `Misbehaving()` directly.",
      "commit_id" : "2021f7c706fbd34f6dcc53398ed7de5b2a15ffc1",
      "created_at" : "2022-05-03T10:10:45Z",
      "diff_hunk" : "@@ -2158,34 +2221,36 @@ void PeerManagerImpl::ProcessHeadersMessage(CNode& pfrom, const Peer& peer,\n     }\n \n     bool received_new_header = false;\n-    const CBlockIndex *pindexLast = nullptr;\n+    const CBlockIndex* pindexLast = nullptr;\n     {\n         LOCK(cs_main);\n         CNodeState *nodestate = State(pfrom.GetId());\n \n-        // If this looks like it could be a block announcement (nCount <\n-        // MAX_BLOCKS_TO_ANNOUNCE), use special logic for handling headers that\n-        // don't connect:\n-        // - Send a getheaders message in response to try to connect the chain.\n-        // - The peer can send up to MAX_UNCONNECTING_HEADERS in a row that\n-        //   don't connect before giving DoS points\n-        // - Once a headers message is received that is valid and does connect,\n-        //   nUnconnectingHeaders gets reset back to 0.\n-        if (!m_chainman.m_blockman.LookupBlockIndex(headers[0].hashPrevBlock) && nCount < MAX_BLOCKS_TO_ANNOUNCE) {\n-            nodestate->nUnconnectingHeaders++;\n+        const CBlockIndex* prev_header_index = m_chainman.m_blockman.LookupBlockIndex(headers.front().hashPrevBlock);\n+        if (!prev_header_index || !IsIndexOnKnownChain(pfrom.GetId(), *prev_header_index)) {\n             m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::GETHEADERS, m_chainman.ActiveChain().GetLocator(m_chainman.m_best_header), uint256()));\n-            LogPrint(BCLog::NET, \"received header %s: missing prev block %s, sending getheaders (%d) to end (peer=%d, nUnconnectingHeaders=%d)\\n\",\n+            LogPrint(BCLog::NET, \"received header %s: %s: %s, sending getheaders (%d) to end (peer=%d, nUnconnectingHeaders=%d)\\n\",\n                      headers[0].GetHash().ToString(),\n+                     prev_header_index ? \"we should not leak the existence of the previous block\" : \"missing prev block\",\n                      headers[0].hashPrevBlock.ToString(),\n                      m_chainman.m_best_header->nHeight,\n                      pfrom.GetId(), nodestate->nUnconnectingHeaders);\n-            // Set hashLastUnknownBlock for this peer, so that if we\n-            // eventually get the headers - even from a different peer -\n-            // we can use this peer to download.\n-            UpdateBlockAvailability(pfrom.GetId(), headers.back().GetHash());\n \n-            if (nodestate->nUnconnectingHeaders % MAX_UNCONNECTING_HEADERS == 0) {\n-                Misbehaving(pfrom.GetId(), 20, strprintf(\"%d non-connecting headers\", nodestate->nUnconnectingHeaders));\n+            if (nCount < MAX_BLOCKS_TO_ANNOUNCE) {\n+                nodestate->nUnconnectingHeaders++;\n+\n+                // Set hashLastUnknownBlock for this peer, so that if we\n+                // eventually get the headers - even from a different peer -\n+                // we can use this peer to download.\n+                UpdateBlockAvailability(pfrom.GetId(), headers.back().GetHash());\n+\n+                if (nodestate->nUnconnectingHeaders % MAX_UNCONNECTING_HEADERS == 0) {\n+                    Misbehaving(pfrom.GetId(), 20, strprintf(\"%d non-connecting headers\", nodestate->nUnconnectingHeaders));\n+                }\n+            } else {\n+                BlockValidationState state;\n+                state.Invalid(BlockValidationResult::BLOCK_MISSING_PREV, \"prev-blk-not-found\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r863638047",
      "id" : 863638047,
      "line" : 2252,
      "node_id" : "PRRC_kwDOABII584zehIf",
      "original_commit_id" : "2021f7c706fbd34f6dcc53398ed7de5b2a15ffc1",
      "original_line" : 2252,
      "original_position" : 134,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 134,
      "pull_request_review_id" : 960165091,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/863638047/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-03T10:18:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/863638047",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r863638631"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/863638631"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Did you look at implementing this logic in validation? Carrying out logic on chain tips and ancestors seems like a job for validation rather than net_processing.",
      "commit_id" : "2021f7c706fbd34f6dcc53398ed7de5b2a15ffc1",
      "created_at" : "2022-05-03T10:11:43Z",
      "diff_hunk" : "@@ -1068,6 +1083,54 @@ void PeerManagerImpl::UpdateBlockAvailability(NodeId nodeid, const uint256 &hash\n     }\n }\n \n+void PeerManagerImpl::UpdateKnownChainTips(NodeId node_id, const CBlockIndex& new_index)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r863638631",
      "id" : 863638631,
      "line" : 1086,
      "node_id" : "PRRC_kwDOABII584zehRn",
      "original_commit_id" : "2021f7c706fbd34f6dcc53398ed7de5b2a15ffc1",
      "original_line" : 1086,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 33,
      "pull_request_review_id" : 960165091,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/863638631/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-03T10:18:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/863638631",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r863639865"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/863639865"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Would it be better to track chain tips per-network rather than per-peer? Is it a privacy leak if one peer on a network can determine that the node received a stale block header from a different peer on the same network?",
      "commit_id" : "2021f7c706fbd34f6dcc53398ed7de5b2a15ffc1",
      "created_at" : "2022-05-03T10:13:46Z",
      "diff_hunk" : "@@ -324,6 +324,18 @@ struct Peer {\n     /** Work queue of items requested by this peer **/\n     std::deque<CInv> m_getdata_requests GUARDED_BY(m_getdata_requests_mutex);\n \n+    struct CompareCBlockIndexRef {\n+        bool operator()(const CBlockIndex& a, const CBlockIndex& b) const { return &a < &b; }\n+    };\n+    /** Protects m_known_chain_tips */\n+    Mutex m_known_chain_tips_mutex;\n+    /**\n+     * Chain tips that this peer knows we have because they send them to us.\n+     * Limited to the number of chain tips in our global block index.\n+     */\n+    std::set<std::reference_wrapper<const CBlockIndex>, CompareCBlockIndexRef>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r863639865",
      "id" : 863639865,
      "line" : 336,
      "node_id" : "PRRC_kwDOABII584zehk5",
      "original_commit_id" : "2021f7c706fbd34f6dcc53398ed7de5b2a15ffc1",
      "original_line" : 336,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 13,
      "pull_request_review_id" : 960165091,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/863639865/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-03T10:18:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/863639865",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review @jnewbery !\r\n\r\n> As an alternative approach, did you consider pruning stale tips from the block index once they're more than a certain age (eg a month)?\r\n\r\nI did and that would squash this class of fingerprinting once and for all but I decided not pursue this idea because we pass around `CBlockIndex` pointers in a lot of places and I was worried that we invalidate pointers by erasing them from the block index while some other component still holds a reference to them. It seems to me that the assumption \"nothing ever gets deleted from the block index\" is one of the reasons why we pass around `CBlockIndex` pointers so much and I did not want to mess with that assumption.\r\n\r\n> Or perhaps just making them unavailable from outside validation if no peer has informed you about them for some period of time.\r\n\r\nWill take a look into going more in this direction.",
      "created_at" : "2022-05-09T16:16:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#issuecomment-1121305345",
      "id" : 1121305345,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24571",
      "node_id" : "IC_kwDOABII585C1cMB",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1121305345/reactions"
      },
      "updated_at" : "2022-05-09T16:16:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1121305345",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r868191984"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/868191984"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You are right, per-network would be enough, no need to keep this around for every peer. That would probably also require less changes to the tests.",
      "commit_id" : "2021f7c706fbd34f6dcc53398ed7de5b2a15ffc1",
      "created_at" : "2022-05-09T16:20:06Z",
      "diff_hunk" : "@@ -324,6 +324,18 @@ struct Peer {\n     /** Work queue of items requested by this peer **/\n     std::deque<CInv> m_getdata_requests GUARDED_BY(m_getdata_requests_mutex);\n \n+    struct CompareCBlockIndexRef {\n+        bool operator()(const CBlockIndex& a, const CBlockIndex& b) const { return &a < &b; }\n+    };\n+    /** Protects m_known_chain_tips */\n+    Mutex m_known_chain_tips_mutex;\n+    /**\n+     * Chain tips that this peer knows we have because they send them to us.\n+     * Limited to the number of chain tips in our global block index.\n+     */\n+    std::set<std::reference_wrapper<const CBlockIndex>, CompareCBlockIndexRef>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r868191984",
      "id" : 868191984,
      "in_reply_to_id" : 863639865,
      "line" : 336,
      "node_id" : "PRRC_kwDOABII584zv47w",
      "original_commit_id" : "2021f7c706fbd34f6dcc53398ed7de5b2a15ffc1",
      "original_line" : 336,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 13,
      "pull_request_review_id" : 966448200,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/868191984/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-09T16:20:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/868191984",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-05-13T07:39:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#issuecomment-1125749966",
      "id" : 1125749966,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24571",
      "node_id" : "IC_kwDOABII585DGZTO",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1125749966/reactions"
      },
      "updated_at" : "2022-05-13T07:39:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1125749966",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r874888665"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/874888665"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks for the suggestion, I moved this into validation",
      "commit_id" : "7b847b85c292977e53f166da7eef8e5e84fa5061",
      "created_at" : "2022-05-17T14:26:35Z",
      "diff_hunk" : "@@ -1068,6 +1083,54 @@ void PeerManagerImpl::UpdateBlockAvailability(NodeId nodeid, const uint256 &hash\n     }\n }\n \n+void PeerManagerImpl::UpdateKnownChainTips(NodeId node_id, const CBlockIndex& new_index)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r874888665",
      "id" : 874888665,
      "in_reply_to_id" : 863638631,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5840Jb3Z",
      "original_commit_id" : "2021f7c706fbd34f6dcc53398ed7de5b2a15ffc1",
      "original_line" : 1086,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 975578891,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/874888665/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-17T14:26:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/874888665",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased and addressed @jnewbery's review.\r\n\r\n* We now keep track of one chain tip set per network instead of one per peer\r\n* The chain tip set logic has moved to `validation.h/cpp`",
      "created_at" : "2022-05-17T14:47:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#issuecomment-1128965795",
      "id" : 1128965795,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24571",
      "node_id" : "IC_kwDOABII585DSqaj",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1128965795/reactions"
      },
      "updated_at" : "2022-05-17T14:47:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1128965795",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r874930208"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/874930208"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    if (m_best_header->GetAncestor(index->nHeight) == index) return true;\r\n```\r\n\r\nnit: Is this needed?",
      "commit_id" : "7b847b85c292977e53f166da7eef8e5e84fa5061",
      "created_at" : "2022-05-17T14:57:53Z",
      "diff_hunk" : "@@ -5224,3 +5224,60 @@ ChainstateManager::~ChainstateManager()\n         i.clear();\n     }\n }\n+\n+bool ChainstateManager::IsBlockInMainOrBestChain(const uint256& blockhash) const\n+{\n+    AssertLockHeld(cs_main);\n+    const CBlockIndex* index{m_blockman.LookupBlockIndex(blockhash)};\n+    if (!index) return false;\n+\n+    if (m_best_header->GetAncestor(index->nHeight) == index || m_best_header == index) return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r874930208",
      "id" : 874930208,
      "line" : 5234,
      "node_id" : "PRRC_kwDOABII5840JmAg",
      "original_commit_id" : "7b847b85c292977e53f166da7eef8e5e84fa5061",
      "original_line" : 5234,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 11,
      "pull_request_review_id" : 975638189,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/874930208/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-17T15:01:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/874930208",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r874932201"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/874932201"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n        const CBlockIndex& tip_index{*Assert(m_blockman.LookupBlockIndex(tip_hash))};\r\n```\r\n\r\nOtherwise you might be running into UB in production.",
      "commit_id" : "7b847b85c292977e53f166da7eef8e5e84fa5061",
      "created_at" : "2022-05-17T14:59:26Z",
      "diff_hunk" : "@@ -5224,3 +5224,60 @@ ChainstateManager::~ChainstateManager()\n         i.clear();\n     }\n }\n+\n+bool ChainstateManager::IsBlockInMainOrBestChain(const uint256& blockhash) const\n+{\n+    AssertLockHeld(cs_main);\n+    const CBlockIndex* index{m_blockman.LookupBlockIndex(blockhash)};\n+    if (!index) return false;\n+\n+    if (m_best_header->GetAncestor(index->nHeight) == index || m_best_header == index) return true;\n+    if (ActiveChain().Contains(index)) return true;\n+\n+    return false;\n+}\n+\n+bool ChainstateManager::IsBlockInChainTipSet(const uint256& blockhash, const std::set<uint256>& chain_tips) const\n+{\n+    AssertLockHeld(cs_main);\n+\n+    const CBlockIndex* index{m_blockman.LookupBlockIndex(blockhash)};\n+    if (!index) return false;\n+\n+    // `index` is in the chain tip set if one the tips has `index` as an ancestor.\n+    return std::any_of(chain_tips.cbegin(), chain_tips.cend(), [&index, &m_blockman = m_blockman](const uint256& tip_hash) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n+        const CBlockIndex& tip_index{*Assume(m_blockman.LookupBlockIndex(tip_hash))};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r874932201",
      "id" : 874932201,
      "line" : 5249,
      "node_id" : "PRRC_kwDOABII5840Jmfp",
      "original_commit_id" : "7b847b85c292977e53f166da7eef8e5e84fa5061",
      "original_line" : 5249,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 26,
      "pull_request_review_id" : 975638189,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/874932201/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-17T15:01:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/874932201",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r874932847"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/874932847"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Same",
      "commit_id" : "7b847b85c292977e53f166da7eef8e5e84fa5061",
      "created_at" : "2022-05-17T14:59:54Z",
      "diff_hunk" : "@@ -5224,3 +5224,60 @@ ChainstateManager::~ChainstateManager()\n         i.clear();\n     }\n }\n+\n+bool ChainstateManager::IsBlockInMainOrBestChain(const uint256& blockhash) const\n+{\n+    AssertLockHeld(cs_main);\n+    const CBlockIndex* index{m_blockman.LookupBlockIndex(blockhash)};\n+    if (!index) return false;\n+\n+    if (m_best_header->GetAncestor(index->nHeight) == index || m_best_header == index) return true;\n+    if (ActiveChain().Contains(index)) return true;\n+\n+    return false;\n+}\n+\n+bool ChainstateManager::IsBlockInChainTipSet(const uint256& blockhash, const std::set<uint256>& chain_tips) const\n+{\n+    AssertLockHeld(cs_main);\n+\n+    const CBlockIndex* index{m_blockman.LookupBlockIndex(blockhash)};\n+    if (!index) return false;\n+\n+    // `index` is in the chain tip set if one the tips has `index` as an ancestor.\n+    return std::any_of(chain_tips.cbegin(), chain_tips.cend(), [&index, &m_blockman = m_blockman](const uint256& tip_hash) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n+        const CBlockIndex& tip_index{*Assume(m_blockman.LookupBlockIndex(tip_hash))};\n+        return index == &tip_index || tip_index.GetAncestor(index->nHeight) == index;\n+    });\n+}\n+\n+void ChainstateManager::UpdateChainTipSet(const uint256& new_blockhash, std::set<uint256>& chain_tips) const\n+{\n+    AssertLockHeld(cs_main);\n+\n+    const CBlockIndex* new_index{m_blockman.LookupBlockIndex(new_blockhash)};\n+    if (!new_index) return;\n+\n+    const auto& last_tip_it = std::find_if(chain_tips.cbegin(), chain_tips.cend(), [&new_index, &m_blockman = m_blockman](const uint256& tip_hash) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n+        const CBlockIndex& tip_index{*Assume(m_blockman.LookupBlockIndex(tip_hash))};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r874932847",
      "id" : 874932847,
      "line" : 5262,
      "node_id" : "PRRC_kwDOABII5840Jmpv",
      "original_commit_id" : "7b847b85c292977e53f166da7eef8e5e84fa5061",
      "original_line" : 5262,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 39,
      "pull_request_review_id" : 975638189,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/874932847/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-17T15:01:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/874932847",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r874935034"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/874935034"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is peer unused?",
      "commit_id" : "7b847b85c292977e53f166da7eef8e5e84fa5061",
      "created_at" : "2022-05-17T15:01:43Z",
      "diff_hunk" : "@@ -2585,7 +2608,12 @@ void PeerManagerImpl::ProcessGetCFCheckPt(CNode& peer, CDataStream& vRecv)\n void PeerManagerImpl::ProcessBlock(CNode& node, const std::shared_ptr<const CBlock>& block, bool force_processing)\n {\n     bool new_block{false};\n-    m_chainman.ProcessNewBlock(block, force_processing, &new_block);\n+    if (m_chainman.ProcessNewBlock(block, force_processing, &new_block)) {\n+        const PeerRef peer{Assume(GetPeerRef(node.GetId()))};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r874935034",
      "id" : 874935034,
      "line" : 2612,
      "node_id" : "PRRC_kwDOABII5840JnL6",
      "original_commit_id" : "7b847b85c292977e53f166da7eef8e5e84fa5061",
      "original_line" : 2612,
      "original_position" : 112,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 112,
      "pull_request_review_id" : 975638189,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/874935034/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-17T15:01:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/874935034",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review @MarcoFalke! I took all your suggestions.",
      "created_at" : "2022-05-17T16:32:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#issuecomment-1129080369",
      "id" : 1129080369,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24571",
      "node_id" : "IC_kwDOABII585DTGYx",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1129080369/reactions"
      },
      "updated_at" : "2022-05-17T16:32:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1129080369",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r875660418"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/875660418"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Does it mean that the attack will be still possible for a tor-only node with one bind=onion?",
      "commit_id" : "59a8a59bc4e5c6f8cd413cce5285a8661f5f092e",
      "created_at" : "2022-05-18T09:11:33Z",
      "diff_hunk" : "@@ -324,6 +324,18 @@ struct Peer {\n     /** Work queue of items requested by this peer **/\n     std::deque<CInv> m_getdata_requests GUARDED_BY(m_getdata_requests_mutex);\n \n+    struct CompareCBlockIndexRef {\n+        bool operator()(const CBlockIndex& a, const CBlockIndex& b) const { return &a < &b; }\n+    };\n+    /** Protects m_known_chain_tips */\n+    Mutex m_known_chain_tips_mutex;\n+    /**\n+     * Chain tips that this peer knows we have because they send them to us.\n+     * Limited to the number of chain tips in our global block index.\n+     */\n+    std::set<std::reference_wrapper<const CBlockIndex>, CompareCBlockIndexRef>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r875660418",
      "id" : 875660418,
      "in_reply_to_id" : 863639865,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5840MYSC",
      "original_commit_id" : "2021f7c706fbd34f6dcc53398ed7de5b2a15ffc1",
      "original_line" : 336,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 976620068,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/875660418/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-18T09:11:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/875660418",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r875857841"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/875857841"
         }
      },
      "author_association" : "MEMBER",
      "body" : "(Doesn't necessarily need to be done in this PR)\r\n\r\n`GetDeterministicRandomizer()` doesn't need to be a member of `CConnman` since it's a stateless util function. It could be moved to src/random.cpp. Then, `GetUniqueNetworkID()` wouldn't need to take a `CConnman&` argument.",
      "commit_id" : "59a8a59bc4e5c6f8cd413cce5285a8661f5f092e",
      "created_at" : "2022-05-18T12:54:39Z",
      "diff_hunk" : "@@ -267,6 +267,15 @@ std::optional<CAddress> GetLocalAddrForPeer(CNode *pnode)\n     return std::nullopt;\n }\n \n+uint64_t GetUniqueNetworkID(const CConnman& connman, const CNode& node)\n+{\n+    auto local_socket_bytes = node.addrBind.GetAddrBytes();\n+    return connman.GetDeterministicRandomizer(RANDOMIZER_ID_UNIQUE_NETWORK_ID)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r875857841",
      "id" : 875857841,
      "line" : 273,
      "node_id" : "PRRC_kwDOABII5840NIex",
      "original_commit_id" : "59a8a59bc4e5c6f8cd413cce5285a8661f5f092e",
      "original_line" : 273,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 16,
      "pull_request_review_id" : 976906677,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/875857841/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-18T14:18:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/875857841",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r875872793"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/875872793"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think performance is critical here, but it seems more efficient to pass over chain_tips once and do both the ancestor and descendant check on the same pass. Is there a reason you chose not to do that?",
      "commit_id" : "59a8a59bc4e5c6f8cd413cce5285a8661f5f092e",
      "created_at" : "2022-05-18T13:06:31Z",
      "diff_hunk" : "@@ -5224,3 +5224,60 @@ ChainstateManager::~ChainstateManager()\n         i.clear();\n     }\n }\n+\n+bool ChainstateManager::IsBlockInMainOrBestChain(const uint256& blockhash) const\n+{\n+    AssertLockHeld(cs_main);\n+    const CBlockIndex* index{m_blockman.LookupBlockIndex(blockhash)};\n+    if (!index) return false;\n+\n+    if (m_best_header->GetAncestor(index->nHeight) == index) return true;\n+    if (ActiveChain().Contains(index)) return true;\n+\n+    return false;\n+}\n+\n+bool ChainstateManager::IsBlockInChainTipSet(const uint256& blockhash, const std::set<uint256>& chain_tips) const\n+{\n+    AssertLockHeld(cs_main);\n+\n+    const CBlockIndex* index{m_blockman.LookupBlockIndex(blockhash)};\n+    if (!index) return false;\n+\n+    // `index` is in the chain tip set if one the tips has `index` as an ancestor.\n+    return std::any_of(chain_tips.cbegin(), chain_tips.cend(), [&index, &m_blockman = m_blockman](const uint256& tip_hash) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n+        const CBlockIndex& tip_index{*Assert(m_blockman.LookupBlockIndex(tip_hash))};\n+        return tip_index.GetAncestor(index->nHeight) == index;\n+    });\n+}\n+\n+void ChainstateManager::UpdateChainTipSet(const uint256& new_blockhash, std::set<uint256>& chain_tips) const\n+{\n+    AssertLockHeld(cs_main);\n+\n+    const CBlockIndex* new_index{m_blockman.LookupBlockIndex(new_blockhash)};\n+    if (!new_index) return;\n+\n+    const auto& last_tip_it = std::find_if(chain_tips.cbegin(), chain_tips.cend(), [&new_index, &m_blockman = m_blockman](const uint256& tip_hash) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r875872793",
      "id" : 875872793,
      "line" : 5261,
      "node_id" : "PRRC_kwDOABII5840NMIZ",
      "original_commit_id" : "59a8a59bc4e5c6f8cd413cce5285a8661f5f092e",
      "original_line" : 5261,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 38,
      "pull_request_review_id" : 976906677,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/875872793/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-18T14:18:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/875872793",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r875874050"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/875874050"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe name this `GetChainTipSetForPeerNetwork()`?",
      "commit_id" : "59a8a59bc4e5c6f8cd413cce5285a8661f5f092e",
      "created_at" : "2022-05-18T13:07:42Z",
      "diff_hunk" : "@@ -621,6 +621,17 @@ class PeerManagerImpl final : public PeerManager\n     bool AlreadyHaveTx(const GenTxid& gtxid)\n         EXCLUSIVE_LOCKS_REQUIRED(cs_main, !m_recent_confirmed_transactions_mutex);\n \n+    /**\n+     * Map of seen chain tip sets keyed by unique network ID.\n+     *\n+     * The size of each chain tip set is limited to the number of chain tips in\n+     * our global block index.\n+     */\n+    std::map<uint64_t, std::set<uint256>> m_chain_tip_sets GUARDED_BY(cs_main);\n+\n+    /** Get the chain tip set for pfrom's network. */\n+    std::set<uint256>& GetChainTipSetForPeer(CNode& pfrom) EXCLUSIVE_LOCKS_REQUIRED(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r875874050",
      "id" : 875874050,
      "line" : 633,
      "node_id" : "PRRC_kwDOABII5840NMcC",
      "original_commit_id" : "59a8a59bc4e5c6f8cd413cce5285a8661f5f092e",
      "original_line" : 633,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 13,
      "pull_request_review_id" : 976906677,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/875874050/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-18T14:18:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/875874050",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r875878840"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/875878840"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Perhaps:\r\n\r\n```suggestion\r\n    return std::any_of(chain_tips.cbegin(), chain_tips.cend(), [&index, &blockman = m_blockman](const uint256& tip_hash) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\r\n```\r\n\r\nsince `blockman` in the lambda is a local variable, not a member variable.",
      "commit_id" : "59a8a59bc4e5c6f8cd413cce5285a8661f5f092e",
      "created_at" : "2022-05-18T13:11:55Z",
      "diff_hunk" : "@@ -5224,3 +5224,60 @@ ChainstateManager::~ChainstateManager()\n         i.clear();\n     }\n }\n+\n+bool ChainstateManager::IsBlockInMainOrBestChain(const uint256& blockhash) const\n+{\n+    AssertLockHeld(cs_main);\n+    const CBlockIndex* index{m_blockman.LookupBlockIndex(blockhash)};\n+    if (!index) return false;\n+\n+    if (m_best_header->GetAncestor(index->nHeight) == index) return true;\n+    if (ActiveChain().Contains(index)) return true;\n+\n+    return false;\n+}\n+\n+bool ChainstateManager::IsBlockInChainTipSet(const uint256& blockhash, const std::set<uint256>& chain_tips) const\n+{\n+    AssertLockHeld(cs_main);\n+\n+    const CBlockIndex* index{m_blockman.LookupBlockIndex(blockhash)};\n+    if (!index) return false;\n+\n+    // `index` is in the chain tip set if one the tips has `index` as an ancestor.\n+    return std::any_of(chain_tips.cbegin(), chain_tips.cend(), [&index, &m_blockman = m_blockman](const uint256& tip_hash) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r875878840",
      "id" : 875878840,
      "line" : 5248,
      "node_id" : "PRRC_kwDOABII5840NNm4",
      "original_commit_id" : "59a8a59bc4e5c6f8cd413cce5285a8661f5f092e",
      "original_line" : 5248,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 25,
      "pull_request_review_id" : 976906677,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/875878840/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-18T14:18:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/875878840",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r875944415"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/875944415"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I understand that this is here to maintain existing behaviour. I think in a future PR we could remove this special casing and always handle this with the nUnconnectingHeaders method, even if nCount == MAX_BLOCKS_TO_ANNOUNCE",
      "commit_id" : "59a8a59bc4e5c6f8cd413cce5285a8661f5f092e",
      "created_at" : "2022-05-18T14:07:02Z",
      "diff_hunk" : "@@ -2159,34 +2175,38 @@ void PeerManagerImpl::ProcessHeadersMessage(CNode& pfrom, const Peer& peer,\n     }\n \n     bool received_new_header = false;\n-    const CBlockIndex *pindexLast = nullptr;\n+    const CBlockIndex* pindexLast = nullptr;\n     {\n         LOCK(cs_main);\n         CNodeState *nodestate = State(pfrom.GetId());\n \n-        // If this looks like it could be a block announcement (nCount <\n-        // MAX_BLOCKS_TO_ANNOUNCE), use special logic for handling headers that\n-        // don't connect:\n-        // - Send a getheaders message in response to try to connect the chain.\n-        // - The peer can send up to MAX_UNCONNECTING_HEADERS in a row that\n-        //   don't connect before giving DoS points\n-        // - Once a headers message is received that is valid and does connect,\n-        //   nUnconnectingHeaders gets reset back to 0.\n-        if (!m_chainman.m_blockman.LookupBlockIndex(headers[0].hashPrevBlock) && nCount < MAX_BLOCKS_TO_ANNOUNCE) {\n-            nodestate->nUnconnectingHeaders++;\n+        const CBlockIndex* prev_header_index = m_chainman.m_blockman.LookupBlockIndex(headers.front().hashPrevBlock);\n+        bool prev_block_on_known_chain = prev_header_index &&\n+                                         (m_chainman.IsBlockInMainOrBestChain(prev_header_index->GetBlockHash()) ||\n+                                          m_chainman.IsBlockInChainTipSet(prev_header_index->GetBlockHash(), GetChainTipSetForPeer(pfrom)));\n+        if (!prev_block_on_known_chain) {\n             m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::GETHEADERS, m_chainman.ActiveChain().GetLocator(m_chainman.m_best_header), uint256()));\n-            LogPrint(BCLog::NET, \"received header %s: missing prev block %s, sending getheaders (%d) to end (peer=%d, nUnconnectingHeaders=%d)\\n\",\n+            LogPrint(BCLog::NET, \"received header %s: %s: %s, sending getheaders (%d) to end (peer=%d, nUnconnectingHeaders=%d)\\n\",\n                      headers[0].GetHash().ToString(),\n+                     prev_header_index ? \"we should not leak the existence of the previous block\" : \"missing prev block\",\n                      headers[0].hashPrevBlock.ToString(),\n                      m_chainman.m_best_header->nHeight,\n                      pfrom.GetId(), nodestate->nUnconnectingHeaders);\n-            // Set hashLastUnknownBlock for this peer, so that if we\n-            // eventually get the headers - even from a different peer -\n-            // we can use this peer to download.\n-            UpdateBlockAvailability(pfrom.GetId(), headers.back().GetHash());\n \n-            if (nodestate->nUnconnectingHeaders % MAX_UNCONNECTING_HEADERS == 0) {\n-                Misbehaving(pfrom.GetId(), 20, strprintf(\"%d non-connecting headers\", nodestate->nUnconnectingHeaders));\n+            if (nCount < MAX_BLOCKS_TO_ANNOUNCE) {\n+                nodestate->nUnconnectingHeaders++;\n+\n+                // Set hashLastUnknownBlock for this peer, so that if we\n+                // eventually get the headers - even from a different peer -\n+                // we can use this peer to download.\n+                UpdateBlockAvailability(pfrom.GetId(), headers.back().GetHash());\n+\n+                if (nodestate->nUnconnectingHeaders % MAX_UNCONNECTING_HEADERS == 0) {\n+                    Misbehaving(pfrom.GetId(), 20, strprintf(\"%d non-connecting headers\", nodestate->nUnconnectingHeaders));\n+                }\n+            } else {\n+                // Same as MaybePunishNodeForBlock for BlockValidationResult::BLOCK_MISSING_PREV\n+                Misbehaving(pfrom.GetId(), 10, \"invalid header received\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r875944415",
      "id" : 875944415,
      "line" : 2209,
      "node_id" : "PRRC_kwDOABII5840Ndnf",
      "original_commit_id" : "59a8a59bc4e5c6f8cd413cce5285a8661f5f092e",
      "original_line" : 2209,
      "original_position" : 83,
      "original_start_line" : 2207,
      "path" : "src/net_processing.cpp",
      "position" : 83,
      "pull_request_review_id" : 976906677,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/875944415/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 2207,
      "start_side" : "RIGHT",
      "updated_at" : "2022-05-18T14:18:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/875944415",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r875955684"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/875955684"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe this should be factored into its own function, instead of repeated twice.\r\n\r\nIn general, I think we should look at all calls to `LookupBlockIndex()` and check whether they result in externally observable behaviour changes, and consider changing those `LookupBlockIndex()` calls to use this function.",
      "commit_id" : "59a8a59bc4e5c6f8cd413cce5285a8661f5f092e",
      "created_at" : "2022-05-18T14:16:29Z",
      "diff_hunk" : "@@ -2159,34 +2175,38 @@ void PeerManagerImpl::ProcessHeadersMessage(CNode& pfrom, const Peer& peer,\n     }\n \n     bool received_new_header = false;\n-    const CBlockIndex *pindexLast = nullptr;\n+    const CBlockIndex* pindexLast = nullptr;\n     {\n         LOCK(cs_main);\n         CNodeState *nodestate = State(pfrom.GetId());\n \n-        // If this looks like it could be a block announcement (nCount <\n-        // MAX_BLOCKS_TO_ANNOUNCE), use special logic for handling headers that\n-        // don't connect:\n-        // - Send a getheaders message in response to try to connect the chain.\n-        // - The peer can send up to MAX_UNCONNECTING_HEADERS in a row that\n-        //   don't connect before giving DoS points\n-        // - Once a headers message is received that is valid and does connect,\n-        //   nUnconnectingHeaders gets reset back to 0.\n-        if (!m_chainman.m_blockman.LookupBlockIndex(headers[0].hashPrevBlock) && nCount < MAX_BLOCKS_TO_ANNOUNCE) {\n-            nodestate->nUnconnectingHeaders++;\n+        const CBlockIndex* prev_header_index = m_chainman.m_blockman.LookupBlockIndex(headers.front().hashPrevBlock);\n+        bool prev_block_on_known_chain = prev_header_index &&\n+                                         (m_chainman.IsBlockInMainOrBestChain(prev_header_index->GetBlockHash()) ||\n+                                          m_chainman.IsBlockInChainTipSet(prev_header_index->GetBlockHash(), GetChainTipSetForPeer(pfrom)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r875955684",
      "id" : 875955684,
      "line" : 2186,
      "node_id" : "PRRC_kwDOABII5840NgXk",
      "original_commit_id" : "59a8a59bc4e5c6f8cd413cce5285a8661f5f092e",
      "original_line" : 2186,
      "original_position" : 53,
      "original_start_line" : 2183,
      "path" : "src/net_processing.cpp",
      "position" : 53,
      "pull_request_review_id" : 976906677,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/875955684/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 2183,
      "start_side" : "RIGHT",
      "updated_at" : "2022-05-18T14:18:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/875955684",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r876867479"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/876867479"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`GetDeterministicRandomizer()` does make use of `nSeed0` and `nSeed1` to construct the hasher but I think we could also just be using a `CSipHasher(0, 0)` here, since these IDs don't need to be unique per node. I left it as is to maintain current behavior.",
      "commit_id" : "d8f3f3785c432e41d0d9b7c98255aba5ad46b999",
      "created_at" : "2022-05-19T10:03:50Z",
      "diff_hunk" : "@@ -267,6 +267,15 @@ std::optional<CAddress> GetLocalAddrForPeer(CNode *pnode)\n     return std::nullopt;\n }\n \n+uint64_t GetUniqueNetworkID(const CConnman& connman, const CNode& node)\n+{\n+    auto local_socket_bytes = node.addrBind.GetAddrBytes();\n+    return connman.GetDeterministicRandomizer(RANDOMIZER_ID_UNIQUE_NETWORK_ID)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r876867479",
      "id" : 876867479,
      "in_reply_to_id" : 875857841,
      "line" : 273,
      "node_id" : "PRRC_kwDOABII5840Q--X",
      "original_commit_id" : "59a8a59bc4e5c6f8cd413cce5285a8661f5f092e",
      "original_line" : 273,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 16,
      "pull_request_review_id" : 978308207,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/876867479/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-19T10:03:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/876867479",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r876867902"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/876867902"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No reason, changed this to be done in one pass.",
      "commit_id" : "d8f3f3785c432e41d0d9b7c98255aba5ad46b999",
      "created_at" : "2022-05-19T10:04:18Z",
      "diff_hunk" : "@@ -5224,3 +5224,60 @@ ChainstateManager::~ChainstateManager()\n         i.clear();\n     }\n }\n+\n+bool ChainstateManager::IsBlockInMainOrBestChain(const uint256& blockhash) const\n+{\n+    AssertLockHeld(cs_main);\n+    const CBlockIndex* index{m_blockman.LookupBlockIndex(blockhash)};\n+    if (!index) return false;\n+\n+    if (m_best_header->GetAncestor(index->nHeight) == index) return true;\n+    if (ActiveChain().Contains(index)) return true;\n+\n+    return false;\n+}\n+\n+bool ChainstateManager::IsBlockInChainTipSet(const uint256& blockhash, const std::set<uint256>& chain_tips) const\n+{\n+    AssertLockHeld(cs_main);\n+\n+    const CBlockIndex* index{m_blockman.LookupBlockIndex(blockhash)};\n+    if (!index) return false;\n+\n+    // `index` is in the chain tip set if one the tips has `index` as an ancestor.\n+    return std::any_of(chain_tips.cbegin(), chain_tips.cend(), [&index, &m_blockman = m_blockman](const uint256& tip_hash) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n+        const CBlockIndex& tip_index{*Assert(m_blockman.LookupBlockIndex(tip_hash))};\n+        return tip_index.GetAncestor(index->nHeight) == index;\n+    });\n+}\n+\n+void ChainstateManager::UpdateChainTipSet(const uint256& new_blockhash, std::set<uint256>& chain_tips) const\n+{\n+    AssertLockHeld(cs_main);\n+\n+    const CBlockIndex* new_index{m_blockman.LookupBlockIndex(new_blockhash)};\n+    if (!new_index) return;\n+\n+    const auto& last_tip_it = std::find_if(chain_tips.cbegin(), chain_tips.cend(), [&new_index, &m_blockman = m_blockman](const uint256& tip_hash) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r876867902",
      "id" : 876867902,
      "in_reply_to_id" : 875872793,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5840Q_E-",
      "original_commit_id" : "59a8a59bc4e5c6f8cd413cce5285a8661f5f092e",
      "original_line" : 5261,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 978308815,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/876867902/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-19T10:04:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/876867902",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r876874036"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/876874036"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Agreed, but wanted to leave this for a future PR.",
      "commit_id" : "d8f3f3785c432e41d0d9b7c98255aba5ad46b999",
      "created_at" : "2022-05-19T10:10:41Z",
      "diff_hunk" : "@@ -2159,34 +2175,38 @@ void PeerManagerImpl::ProcessHeadersMessage(CNode& pfrom, const Peer& peer,\n     }\n \n     bool received_new_header = false;\n-    const CBlockIndex *pindexLast = nullptr;\n+    const CBlockIndex* pindexLast = nullptr;\n     {\n         LOCK(cs_main);\n         CNodeState *nodestate = State(pfrom.GetId());\n \n-        // If this looks like it could be a block announcement (nCount <\n-        // MAX_BLOCKS_TO_ANNOUNCE), use special logic for handling headers that\n-        // don't connect:\n-        // - Send a getheaders message in response to try to connect the chain.\n-        // - The peer can send up to MAX_UNCONNECTING_HEADERS in a row that\n-        //   don't connect before giving DoS points\n-        // - Once a headers message is received that is valid and does connect,\n-        //   nUnconnectingHeaders gets reset back to 0.\n-        if (!m_chainman.m_blockman.LookupBlockIndex(headers[0].hashPrevBlock) && nCount < MAX_BLOCKS_TO_ANNOUNCE) {\n-            nodestate->nUnconnectingHeaders++;\n+        const CBlockIndex* prev_header_index = m_chainman.m_blockman.LookupBlockIndex(headers.front().hashPrevBlock);\n+        bool prev_block_on_known_chain = prev_header_index &&\n+                                         (m_chainman.IsBlockInMainOrBestChain(prev_header_index->GetBlockHash()) ||\n+                                          m_chainman.IsBlockInChainTipSet(prev_header_index->GetBlockHash(), GetChainTipSetForPeer(pfrom)));\n+        if (!prev_block_on_known_chain) {\n             m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::GETHEADERS, m_chainman.ActiveChain().GetLocator(m_chainman.m_best_header), uint256()));\n-            LogPrint(BCLog::NET, \"received header %s: missing prev block %s, sending getheaders (%d) to end (peer=%d, nUnconnectingHeaders=%d)\\n\",\n+            LogPrint(BCLog::NET, \"received header %s: %s: %s, sending getheaders (%d) to end (peer=%d, nUnconnectingHeaders=%d)\\n\",\n                      headers[0].GetHash().ToString(),\n+                     prev_header_index ? \"we should not leak the existence of the previous block\" : \"missing prev block\",\n                      headers[0].hashPrevBlock.ToString(),\n                      m_chainman.m_best_header->nHeight,\n                      pfrom.GetId(), nodestate->nUnconnectingHeaders);\n-            // Set hashLastUnknownBlock for this peer, so that if we\n-            // eventually get the headers - even from a different peer -\n-            // we can use this peer to download.\n-            UpdateBlockAvailability(pfrom.GetId(), headers.back().GetHash());\n \n-            if (nodestate->nUnconnectingHeaders % MAX_UNCONNECTING_HEADERS == 0) {\n-                Misbehaving(pfrom.GetId(), 20, strprintf(\"%d non-connecting headers\", nodestate->nUnconnectingHeaders));\n+            if (nCount < MAX_BLOCKS_TO_ANNOUNCE) {\n+                nodestate->nUnconnectingHeaders++;\n+\n+                // Set hashLastUnknownBlock for this peer, so that if we\n+                // eventually get the headers - even from a different peer -\n+                // we can use this peer to download.\n+                UpdateBlockAvailability(pfrom.GetId(), headers.back().GetHash());\n+\n+                if (nodestate->nUnconnectingHeaders % MAX_UNCONNECTING_HEADERS == 0) {\n+                    Misbehaving(pfrom.GetId(), 20, strprintf(\"%d non-connecting headers\", nodestate->nUnconnectingHeaders));\n+                }\n+            } else {\n+                // Same as MaybePunishNodeForBlock for BlockValidationResult::BLOCK_MISSING_PREV\n+                Misbehaving(pfrom.GetId(), 10, \"invalid header received\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r876874036",
      "id" : 876874036,
      "in_reply_to_id" : 875944415,
      "line" : 2229,
      "node_id" : "PRRC_kwDOABII5840RAk0",
      "original_commit_id" : "59a8a59bc4e5c6f8cd413cce5285a8661f5f092e",
      "original_line" : 2229,
      "original_position" : 83,
      "original_start_line" : 2207,
      "path" : "src/net_processing.cpp",
      "position" : 124,
      "pull_request_review_id" : 978316976,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/876874036/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 2227,
      "start_side" : "RIGHT",
      "updated_at" : "2022-05-19T10:10:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/876874036",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r876875509"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/876875509"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Put this into its own function `LookupBlockIndexForPeer` and replaced two more uses of `LookupBlockIndex()` that allowed for the same type of fingerprinting.",
      "commit_id" : "d8f3f3785c432e41d0d9b7c98255aba5ad46b999",
      "created_at" : "2022-05-19T10:12:20Z",
      "diff_hunk" : "@@ -2159,34 +2175,38 @@ void PeerManagerImpl::ProcessHeadersMessage(CNode& pfrom, const Peer& peer,\n     }\n \n     bool received_new_header = false;\n-    const CBlockIndex *pindexLast = nullptr;\n+    const CBlockIndex* pindexLast = nullptr;\n     {\n         LOCK(cs_main);\n         CNodeState *nodestate = State(pfrom.GetId());\n \n-        // If this looks like it could be a block announcement (nCount <\n-        // MAX_BLOCKS_TO_ANNOUNCE), use special logic for handling headers that\n-        // don't connect:\n-        // - Send a getheaders message in response to try to connect the chain.\n-        // - The peer can send up to MAX_UNCONNECTING_HEADERS in a row that\n-        //   don't connect before giving DoS points\n-        // - Once a headers message is received that is valid and does connect,\n-        //   nUnconnectingHeaders gets reset back to 0.\n-        if (!m_chainman.m_blockman.LookupBlockIndex(headers[0].hashPrevBlock) && nCount < MAX_BLOCKS_TO_ANNOUNCE) {\n-            nodestate->nUnconnectingHeaders++;\n+        const CBlockIndex* prev_header_index = m_chainman.m_blockman.LookupBlockIndex(headers.front().hashPrevBlock);\n+        bool prev_block_on_known_chain = prev_header_index &&\n+                                         (m_chainman.IsBlockInMainOrBestChain(prev_header_index->GetBlockHash()) ||\n+                                          m_chainman.IsBlockInChainTipSet(prev_header_index->GetBlockHash(), GetChainTipSetForPeer(pfrom)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r876875509",
      "id" : 876875509,
      "in_reply_to_id" : 875955684,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5840RA71",
      "original_commit_id" : "59a8a59bc4e5c6f8cd413cce5285a8661f5f092e",
      "original_line" : 2186,
      "original_position" : 53,
      "original_start_line" : 2183,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 978319008,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/876875509/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-05-19T10:12:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/876875509",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks @jnewbery for the review and for pointing out to me that the same fingerprinting issue exists for blocktxn requests. I added an additional commit for that as well as one more location (receiving invs for blocks). \r\n\r\nI would encourage reviewers to have a look at all uses of  `LookupBlockIndex()` to see if there are more places that allow for this type of fingerprinting. Any use of `LookupBlockIndex()` that results in externally observable behavior changes should be amended.",
      "created_at" : "2022-05-19T10:17:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#issuecomment-1131509058",
      "id" : 1131509058,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24571",
      "node_id" : "IC_kwDOABII585DcXVC",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1131509058/reactions"
      },
      "updated_at" : "2022-05-19T10:17:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1131509058",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r876882602"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/876882602"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Could you elaborate how you think the attack would be possible in that case?",
      "commit_id" : "d8f3f3785c432e41d0d9b7c98255aba5ad46b999",
      "created_at" : "2022-05-19T10:20:27Z",
      "diff_hunk" : "@@ -324,6 +324,18 @@ struct Peer {\n     /** Work queue of items requested by this peer **/\n     std::deque<CInv> m_getdata_requests GUARDED_BY(m_getdata_requests_mutex);\n \n+    struct CompareCBlockIndexRef {\n+        bool operator()(const CBlockIndex& a, const CBlockIndex& b) const { return &a < &b; }\n+    };\n+    /** Protects m_known_chain_tips */\n+    Mutex m_known_chain_tips_mutex;\n+    /**\n+     * Chain tips that this peer knows we have because they send them to us.\n+     * Limited to the number of chain tips in our global block index.\n+     */\n+    std::set<std::reference_wrapper<const CBlockIndex>, CompareCBlockIndexRef>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24571#discussion_r876882602",
      "id" : 876882602,
      "in_reply_to_id" : 863639865,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5840RCqq",
      "original_commit_id" : "2021f7c706fbd34f6dcc53398ed7de5b2a15ffc1",
      "original_line" : 336,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 978329030,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24571",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/876882602/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-19T10:20:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/876882602",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   }
]
