[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12495#discussion_r169968749"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12495"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/169968749"
         }
      },
      "author_association" : "OWNER",
      "body" : "Add `static`?",
      "commit_id" : "f4659ab250d51e2015d2da68dd0a27036901c2c7",
      "created_at" : "2018-02-22T14:22:39Z",
      "diff_hunk" : "@@ -71,14 +71,41 @@ class CBitcoinLevelDBLogger : public leveldb::Logger {\n     }\n };\n \n+constexpr int PermissibleMaxOpenFiles() {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12495#discussion_r169968749",
      "id" : 169968749,
      "original_commit_id" : "c1b39470cdba75f3359b12e5a47eb5af0de07615",
      "original_position" : 4,
      "path" : "src/dbwrapper.cpp",
      "position" : 4,
      "pull_request_review_id" : 98580714,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12495",
      "updated_at" : "2018-02-22T20:24:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/169968749",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12495#discussion_r169970767"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12495"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/169970767"
         }
      },
      "author_association" : "OWNER",
      "body" : "I don't think this does what you expect it to. As I understand it, confirmed by the [gcc page](https://www.gnu.org/software/libc/manual/html_node/Feature-Test-Macros.html) about it, `_POSIX_C_SOURCE` is supposed to be defined explicitly at the top of the compilation unit to request certain POSIX C library features. It is not defined by the compiler. So it can't be used to detect whether the platform compiled to is POSIX.\r\n\r\nIn other place, we've just used `#if[n]def WIN32` as WIN32 is the only non-POSIX platform supported in this project.",
      "commit_id" : "f4659ab250d51e2015d2da68dd0a27036901c2c7",
      "created_at" : "2018-02-22T14:27:17Z",
      "diff_hunk" : "@@ -71,14 +71,41 @@ class CBitcoinLevelDBLogger : public leveldb::Logger {\n     }\n };\n \n+constexpr int PermissibleMaxOpenFiles() {\n+#ifdef _POSIX_C_SOURCE",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12495#discussion_r169970767",
      "id" : 169970767,
      "original_commit_id" : "c1b39470cdba75f3359b12e5a47eb5af0de07615",
      "original_position" : 5,
      "path" : "src/dbwrapper.cpp",
      "position" : null,
      "pull_request_review_id" : 98580714,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12495",
      "updated_at" : "2018-02-22T20:24:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/169970767",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I measured the impact of this change, you can see a graph here: https://monad.io/max_open_files.png\r\n\r\nMethod for creating this graph:\r\n * Ran `bitcoind -reindex-chainstate` on a full node that had already been synced on mainnet\r\n * Instance is a GCP n1-standard-1 host which has one vCPU pinned to host CPU, 4 GB of RAM, and very slow virtualized disks",
      "created_at" : "2018-02-22T14:41:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12495#issuecomment-367701278",
      "id" : 367701278,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12495",
      "updated_at" : "2018-02-22T14:41:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/367701278",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/2734?v=4",
         "events_url" : "https://api.github.com/users/eklitzke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/eklitzke/followers",
         "following_url" : "https://api.github.com/users/eklitzke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/eklitzke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/eklitzke",
         "id" : 2734,
         "login" : "eklitzke",
         "organizations_url" : "https://api.github.com/users/eklitzke/orgs",
         "received_events_url" : "https://api.github.com/users/eklitzke/received_events",
         "repos_url" : "https://api.github.com/users/eklitzke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/eklitzke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/eklitzke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/eklitzke"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "> I measured the impact of this change, you can see a graph here: https://monad.io/max_open_files.png\r\n\r\nNice!",
      "created_at" : "2018-02-22T14:51:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12495#issuecomment-367704702",
      "id" : 367704702,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12495",
      "updated_at" : "2018-02-22T14:51:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/367704702",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12495#discussion_r170069914"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12495"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/170069914"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "You're absolutely right, I will fix this.",
      "commit_id" : "f4659ab250d51e2015d2da68dd0a27036901c2c7",
      "created_at" : "2018-02-22T19:37:16Z",
      "diff_hunk" : "@@ -71,14 +71,41 @@ class CBitcoinLevelDBLogger : public leveldb::Logger {\n     }\n };\n \n+constexpr int PermissibleMaxOpenFiles() {\n+#ifdef _POSIX_C_SOURCE",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12495#discussion_r170069914",
      "id" : 170069914,
      "in_reply_to_id" : 169970767,
      "original_commit_id" : "c1b39470cdba75f3359b12e5a47eb5af0de07615",
      "original_position" : 5,
      "path" : "src/dbwrapper.cpp",
      "position" : null,
      "pull_request_review_id" : 98699976,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12495",
      "updated_at" : "2018-02-22T20:24:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/170069914",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/2734?v=4",
         "events_url" : "https://api.github.com/users/eklitzke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/eklitzke/followers",
         "following_url" : "https://api.github.com/users/eklitzke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/eklitzke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/eklitzke",
         "id" : 2734,
         "login" : "eklitzke",
         "organizations_url" : "https://api.github.com/users/eklitzke/orgs",
         "received_events_url" : "https://api.github.com/users/eklitzke/received_events",
         "repos_url" : "https://api.github.com/users/eklitzke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/eklitzke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/eklitzke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/eklitzke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12495#discussion_r170083156"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12495"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/170083156"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The `static` specifier isn't necessary because `constexpr` functions are evaluated at compile time. I double checked that `nm ./src/bitcoind | c++filt | grep Permissible` produces no output.",
      "commit_id" : "f4659ab250d51e2015d2da68dd0a27036901c2c7",
      "created_at" : "2018-02-22T20:26:59Z",
      "diff_hunk" : "@@ -71,14 +71,41 @@ class CBitcoinLevelDBLogger : public leveldb::Logger {\n     }\n };\n \n+constexpr int PermissibleMaxOpenFiles() {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12495#discussion_r170083156",
      "id" : 170083156,
      "in_reply_to_id" : 169968749,
      "original_commit_id" : "c1b39470cdba75f3359b12e5a47eb5af0de07615",
      "original_position" : 4,
      "path" : "src/dbwrapper.cpp",
      "position" : 4,
      "pull_request_review_id" : 98715776,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12495",
      "updated_at" : "2018-02-22T20:26:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/170083156",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/2734?v=4",
         "events_url" : "https://api.github.com/users/eklitzke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/eklitzke/followers",
         "following_url" : "https://api.github.com/users/eklitzke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/eklitzke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/eklitzke",
         "id" : 2734,
         "login" : "eklitzke",
         "organizations_url" : "https://api.github.com/users/eklitzke/orgs",
         "received_events_url" : "https://api.github.com/users/eklitzke/received_events",
         "repos_url" : "https://api.github.com/users/eklitzke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/eklitzke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/eklitzke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/eklitzke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "The reason for this speedup isn't super obvious, and I think merits some explanation. I've spent a lot of time the last three days reading the LevelDB source code and think I understand now. It actually has nothing to do with reducing the number of open/close/mmap/munmap syscalls, as I had originally thought.\r\n\r\nThe LevelDB terminology for a `.ldb` file is a \"table\", and the tables are composed of 4 KB blocks. Each table contains a block index, which is an index that can be used to determine which block a given key will be in. The block index for a given table file is loaded into memory when that table is opened.\r\n\r\nIncreasing the `max_open_files` here forces Bitcoin to keep much more of the block index data actually loaded into memory. I think it might be worth actually increasing the internal limits of LevelDB on the number of mmap files beyond 1000 on 64-bit Unix platforms, as that would result in the entire block index being loaded into memory. However I think we should start with this, and then consider increasing the limits once I've done more investigation into what the overhead is.",
      "created_at" : "2018-02-22T20:40:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12495#issuecomment-367815005",
      "id" : 367815005,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12495",
      "updated_at" : "2018-02-22T20:40:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/367815005",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/2734?v=4",
         "events_url" : "https://api.github.com/users/eklitzke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/eklitzke/followers",
         "following_url" : "https://api.github.com/users/eklitzke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/eklitzke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/eklitzke",
         "id" : 2734,
         "login" : "eklitzke",
         "organizations_url" : "https://api.github.com/users/eklitzke/orgs",
         "received_events_url" : "https://api.github.com/users/eklitzke/received_events",
         "repos_url" : "https://api.github.com/users/eklitzke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/eklitzke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/eklitzke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/eklitzke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@eklitzke Cheers for referencing #12123 . Replying here to get subscribed.\r\n\r\nI am going to do more tests on a Windows machine at the weekend with your changes here and report back my results.\r\n\r\nI am pretty familiar with Windows internals so I'll do further investigations to see if we can have similar changes on Windows.",
      "created_at" : "2018-02-22T22:00:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12495#issuecomment-367837075",
      "id" : 367837075,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12495",
      "updated_at" : "2018-02-22T22:00:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/367837075",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6394033?v=4",
         "events_url" : "https://api.github.com/users/donaloconnor/events{/privacy}",
         "followers_url" : "https://api.github.com/users/donaloconnor/followers",
         "following_url" : "https://api.github.com/users/donaloconnor/following{/other_user}",
         "gists_url" : "https://api.github.com/users/donaloconnor/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/donaloconnor",
         "id" : 6394033,
         "login" : "donaloconnor",
         "organizations_url" : "https://api.github.com/users/donaloconnor/orgs",
         "received_events_url" : "https://api.github.com/users/donaloconnor/received_events",
         "repos_url" : "https://api.github.com/users/donaloconnor/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/donaloconnor/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/donaloconnor/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/donaloconnor"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I had a closer look at Windows and the way we use the win32 apis in LevelDB.\r\n\r\nObservations:\r\n\r\n1. Win32RandomAccessFile does not use memory mapped files.\r\n2. The file opening and reading is done on the Win32 API level: CreateFile, ReadFile. There is no limit to the number of files that can be opened at this level (Use Window's HANDLES rather than FDs). Limits are at the C runtime library level but this is irrelevant.\r\n\r\nI am confident that this increase to 1000 files will not affect Windows. I have already tested this but will do more tests tomorrow.\r\n\r\nThe Win32RandomAccessFile is as basic as it gets. Further optimizations can be made in this by using Memory Mapped files (Similar to the POSIX versions). The random access nature of accesses should be a win for Memory Mapped files over regular file read operations due to the kernel level caching.\r\nI will modify this and see if any significant performance improvements are achieved. I reckon it will.\r\n\r\nAs I've mentioned in #12123, we achieve optimization at CPU level also by avoiding the CRC checksum check that's performed on each file open.\r\n\r\n@eklitzke I hope you don't mind me replying on here. I'll continue to do more tests on the Windows sides of things. Any improvement to the IBD is a big win!\r\n\r\nCheers,\r\nDonal",
      "created_at" : "2018-02-24T19:23:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12495#issuecomment-368252740",
      "id" : 368252740,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12495",
      "updated_at" : "2018-02-24T19:23:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/368252740",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6394033?v=4",
         "events_url" : "https://api.github.com/users/donaloconnor/events{/privacy}",
         "followers_url" : "https://api.github.com/users/donaloconnor/followers",
         "following_url" : "https://api.github.com/users/donaloconnor/following{/other_user}",
         "gists_url" : "https://api.github.com/users/donaloconnor/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/donaloconnor",
         "id" : 6394033,
         "login" : "donaloconnor",
         "organizations_url" : "https://api.github.com/users/donaloconnor/orgs",
         "received_events_url" : "https://api.github.com/users/donaloconnor/received_events",
         "repos_url" : "https://api.github.com/users/donaloconnor/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/donaloconnor/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/donaloconnor/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/donaloconnor"
      }
   }
]
