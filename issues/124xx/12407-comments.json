[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Hm: this changeset is failing tests that initially transmit a block with unexpected witness data (which gets rejected) and then retransmit without witness data for expected acceptance, but we get hung up on an existing `mapBlockIndex` entry that's been marked invalid.\r\n\r\nIs it worth special-casing out `\"unexpected-witness\"` rejections from the `InvalidateBlock` call? Seems a little ugly.\r\n\r\nIs the bookkeeping this PR wants to do even worth it? I guess we could just lump long invalid forks in with long headers-only forks, but that doesn't seem great either...",
      "created_at" : "2018-02-10T21:38:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12407#issuecomment-364695748",
      "id" : 364695748,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12407",
      "updated_at" : "2018-02-10T21:38:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/364695748",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "You can only mark a block as invalid when fPossibleCorruption is not set in the validation status.",
      "created_at" : "2018-02-10T21:40:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12407#issuecomment-364695970",
      "id" : 364695970,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12407",
      "updated_at" : "2018-02-10T21:40:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/364695970",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Ah good point, thanks @sipa. That seems to have fixed it.",
      "created_at" : "2018-02-10T21:49:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12407#issuecomment-364697057",
      "id" : 364697057,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12407",
      "updated_at" : "2018-02-10T21:49:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/364697057",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I've rebased this changeset, removing the code that's now in #12431 as well as the semi-related log statement. I've also DRY'd up parts of validation which set `BLOCK_FAILED_VALID` on `nStatus` to use `InvalidBlockFound` instead.\r\n\r\nThis change should only be merged *after* #12431 since this will exercise the bug that PR fixes.",
      "created_at" : "2018-02-14T22:29:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12407#issuecomment-365766464",
      "id" : 365766464,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12407",
      "updated_at" : "2018-02-14T22:31:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/365766464",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12407#discussion_r172657726"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12407"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/172657726"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[tests] Add utility for generating bad coinbase transactions\"\r\n\r\nI think:\r\n\r\n```python\r\n(r.index, tip for r, tip in zip(rpc_connections, tips))\r\n```\r\nwould be clearer than:\r\n\r\n```python\r\n(rpc_connections[i].index, tip for i, tip in enumerate(tips))\r\n```\r\n\r\nbut you should ignore this suggestion if you prefer enumerate.",
      "commit_id" : "6af17e40890651e5e5f5968a1a131c6a48ce998c",
      "created_at" : "2018-03-06T20:59:36Z",
      "diff_hunk" : "@@ -373,10 +373,13 @@ def sync_blocks(rpc_connections, *, wait=1, timeout=60):\n             if all(t[\"hash\"] == tips[0][\"hash\"] for t in tips):\n                 return\n             raise AssertionError(\"Block sync failed, mismatched block hashes:{}\".format(\n-                                 \"\".join(\"\\n  {!r}\".format(tip) for tip in tips)))\n+                \"\".join(\"\\n  Node {}: {!r}\".format(\n+                    rpc_connections[i].index, tip)\n+                        for i, tip in enumerate(tips))))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12407#discussion_r172657726",
      "id" : 172657726,
      "original_commit_id" : "e2be3284d6a042e029c830d35e58c7c117d39602",
      "original_position" : 7,
      "path" : "test/functional/test_framework/util.py",
      "position" : 7,
      "pull_request_review_id" : 101713470,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12407",
      "updated_at" : "2018-03-06T21:44:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/172657726",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12407#discussion_r172658464"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12407"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/172658464"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[tests] Add utility for generating bad coinbase transactions\"\r\n\r\nCould drop kwargs assignment with\r\n\r\n```python\r\nreturn create_coinbase(*args, **kwargs. txin=CTxIn(...))\r\n```",
      "commit_id" : "6af17e40890651e5e5f5968a1a131c6a48ce998c",
      "created_at" : "2018-03-06T21:02:17Z",
      "diff_hunk" : "@@ -110,6 +112,16 @@ def create_transaction(prevtx, n, sig, value, scriptPubKey=CScript()):\n     tx.calc_sha256()\n     return tx\n \n+\n+def create_coinbase_with_bad_txin(*args, **kwargs):\n+    \"\"\"Return a coinbase CTransaction with an invalid txin.\"\"\"\n+    kwargs['txin'] = CTxIn(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12407#discussion_r172658464",
      "id" : 172658464,
      "original_commit_id" : "e2be3284d6a042e029c830d35e58c7c117d39602",
      "original_position" : 23,
      "path" : "test/functional/test_framework/blocktools.py",
      "position" : 23,
      "pull_request_review_id" : 101713470,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12407",
      "updated_at" : "2018-03-06T21:44:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/172658464",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12407#discussion_r172664641"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12407"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/172664641"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Do the proper InvalidateBlock bookkeeping for DoSy blocks\"\r\n\r\nDuplicating the CorruptionPossible check here seems unnecessarily confusing and fragile to me, though perhaps there's an advantage I'm not seeing.\r\n\r\n",
      "commit_id" : "6af17e40890651e5e5f5968a1a131c6a48ce998c",
      "created_at" : "2018-03-06T21:24:21Z",
      "diff_hunk" : "@@ -3410,10 +3419,21 @@ bool ProcessNewBlock(const CChainParams& chainparams, const std::shared_ptr<cons\n \n         LOCK(cs_main);\n \n-        if (ret) {\n+        if (!ret) {\n+            // Mark the block as invalid if we recognize it in mapBlockIndex.\n+            // This doesn't happen within CheckBlock so we have to include a call\n+            // here. It *does* happen within AcceptBlock below.\n+            BlockMap::iterator it = mapBlockIndex.find(pblock->GetHash());\n+\n+            // Duplicate call to CorruptionPossible() here just to be careful.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12407#discussion_r172664641",
      "id" : 172664641,
      "original_commit_id" : "6af17e40890651e5e5f5968a1a131c6a48ce998c",
      "original_position" : 88,
      "path" : "src/validation.cpp",
      "position" : 88,
      "pull_request_review_id" : 101713470,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12407",
      "updated_at" : "2018-03-06T21:44:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/172664641",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   }
]
