[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12493#discussion_r169511450"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12493"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/169511450"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is a great start! I don't think think it is thread safe yet, though, because in parallel with this thread, a block connected notification could be coming in, or another another RPC could be being made that is using one of the `Db*` or `DbEnv*` pointers that this closes.\r\n\r\nI think all you need to do to make this thread safe is wait for the `mapFileUseCount` entries to go to zero. You could do this with a condition variable. For example, if you added a `std::condition_variable m_cv_in_use;` member to `CDBEnv` you could trigger it in `CDB::Close`:\r\n\r\n```c++\r\nm_cv_in_use.notify_all()\r\n```\r\n\r\nand wait for it at the top of `CDBEnv::ReloadDbEnv`:\r\n\r\n```c++\r\nWAIT_LOCK(cs_db, lock);\r\nm_cv_in_use.wait(lock, [this](){\r\n    for (count : mapFileUseCount) {\r\n        if (count.second > 0) return false;\r\n    }\r\n    return true;\r\n});\r\n```\r\n\r\nThis is one possible approach. Other approaches may be simpler or better. One drawback of this approach is that if there are a lot of background writes happening in different wallets, ReloadDbEnv could get starved out waiting for all wallets to be simultaneously not in use.",
      "commit_id" : "437d2dd56f81a6258243aca6ed137cbca9255b32",
      "created_at" : "2018-02-21T01:16:48Z",
      "diff_hunk" : "@@ -509,6 +509,22 @@ void CDBEnv::CloseDb(const std::string& strFile)\n     }\n }\n \n+void CDBEnv::ReloadDbEnv()\n+{\n+    std::vector<std::string> filenames;\n+    for (auto it : mapDb) {\n+        filenames.push_back(it.first);\n+    }\n+    // Close the individual Db's\n+    for (std::string filename : filenames) {\n+        CloseDb(filename);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12493#discussion_r169511450",
      "id" : 169511450,
      "original_commit_id" : "6b2b3a76980ab0c3418d46a5df8040eaa160f449",
      "original_position" : 12,
      "path" : "src/wallet/db.cpp",
      "position" : 30,
      "pull_request_review_id" : 98049174,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12493",
      "updated_at" : "2018-02-21T21:04:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/169511450",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ryanofsky I've implemented something which is basically what you described. It seems to work, although I'm not sure how to test the thread safe-ness of it. Let me know what you think.",
      "created_at" : "2018-02-21T03:54:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12493#issuecomment-367205750",
      "id" : 367205750,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12493",
      "updated_at" : "2018-02-21T03:54:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/367205750",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12493#discussion_r169655317"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12493"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/169655317"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Replace cs_db with a recursive mutex use with a conditional_variable_any\"\r\n\r\ncs_db is actually already a recursive mutex (it inherits from std::recursive_mutex). I think you could just leave it unchanged, and continue using the LOCK macro instead of std::lock_guard everywhere. This would make the commit smaller & simpler.\r\n\r\n",
      "commit_id" : "437d2dd56f81a6258243aca6ed137cbca9255b32",
      "created_at" : "2018-02-21T14:35:40Z",
      "diff_hunk" : "@@ -35,10 +35,11 @@ class CDBEnv\n     void EnvShutdown();\n \n public:\n-    mutable CCriticalSection cs_db;\n+    std::recursive_mutex cs_db;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12493#discussion_r169655317",
      "id" : 169655317,
      "original_commit_id" : "de939869f2513d403568fdc8b828300fe54f0639",
      "original_position" : 5,
      "path" : "src/wallet/db.h",
      "position" : null,
      "pull_request_review_id" : 98215449,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12493",
      "updated_at" : "2018-02-21T21:04:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/169655317",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12493#discussion_r169656355"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12493"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/169656355"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Replace cs_db with a recursive mutex use with a conditional_variable_any\"\r\n\r\nWould be good to add an AssertLockNotHeld(cs_db); above this, since it would be a bug if the mutex were held recursively when this was called (wait could hang if the lock wasn't released). ",
      "commit_id" : "437d2dd56f81a6258243aca6ed137cbca9255b32",
      "created_at" : "2018-02-21T14:39:03Z",
      "diff_hunk" : "@@ -511,6 +512,15 @@ void CDBEnv::CloseDb(const std::string& strFile)\n \n void CDBEnv::ReloadDbEnv()\n {\n+    // Make sure that no Db's are in use\n+    std::unique_lock<std::recursive_mutex> lock(cs_db);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12493#discussion_r169656355",
      "id" : 169656355,
      "original_commit_id" : "de939869f2513d403568fdc8b828300fe54f0639",
      "original_position" : 51,
      "path" : "src/wallet/db.cpp",
      "position" : null,
      "pull_request_review_id" : 98215449,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12493",
      "updated_at" : "2018-02-21T21:04:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/169656355",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12493#discussion_r169675054"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12493"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/169675054"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I tried that, but it kept giving me a compiler error.",
      "commit_id" : "437d2dd56f81a6258243aca6ed137cbca9255b32",
      "created_at" : "2018-02-21T15:32:14Z",
      "diff_hunk" : "@@ -35,10 +35,11 @@ class CDBEnv\n     void EnvShutdown();\n \n public:\n-    mutable CCriticalSection cs_db;\n+    std::recursive_mutex cs_db;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12493#discussion_r169675054",
      "id" : 169675054,
      "in_reply_to_id" : 169655317,
      "original_commit_id" : "de939869f2513d403568fdc8b828300fe54f0639",
      "original_position" : 5,
      "path" : "src/wallet/db.h",
      "position" : null,
      "pull_request_review_id" : 98239484,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12493",
      "updated_at" : "2018-02-21T21:04:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/169675054",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12493#discussion_r169682192"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12493"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/169682192"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "437d2dd56f81a6258243aca6ed137cbca9255b32",
      "created_at" : "2018-02-21T15:51:17Z",
      "diff_hunk" : "@@ -511,6 +512,15 @@ void CDBEnv::CloseDb(const std::string& strFile)\n \n void CDBEnv::ReloadDbEnv()\n {\n+    // Make sure that no Db's are in use\n+    std::unique_lock<std::recursive_mutex> lock(cs_db);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12493#discussion_r169682192",
      "id" : 169682192,
      "in_reply_to_id" : 169656355,
      "original_commit_id" : "de939869f2513d403568fdc8b828300fe54f0639",
      "original_position" : 51,
      "path" : "src/wallet/db.cpp",
      "position" : null,
      "pull_request_review_id" : 98247803,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12493",
      "updated_at" : "2018-02-21T21:04:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/169682192",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12493#discussion_r169721029"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12493"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/169721029"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "https://github.com/bitcoin/bitcoin/pull/12493#discussion_r169655317\r\n\r\n> I tried that, but it kept giving me a compiler error.\r\n\r\nWhat is the compiler error? The following compiles for me: c271de2d62881c0880bf64b830d72f686967bbfb (fetchable with `git fetch https://github.com/ryanofsky/bitcoin pr/lreload`).\r\n\r\nI didn't do any real testing with it but it passes python & unit tests.",
      "commit_id" : "437d2dd56f81a6258243aca6ed137cbca9255b32",
      "created_at" : "2018-02-21T17:45:49Z",
      "diff_hunk" : "@@ -35,10 +35,11 @@ class CDBEnv\n     void EnvShutdown();\n \n public:\n-    mutable CCriticalSection cs_db;\n+    std::recursive_mutex cs_db;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12493#discussion_r169721029",
      "id" : 169721029,
      "in_reply_to_id" : 169655317,
      "original_commit_id" : "de939869f2513d403568fdc8b828300fe54f0639",
      "original_position" : 5,
      "path" : "src/wallet/db.h",
      "position" : null,
      "pull_request_review_id" : 98293675,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12493",
      "updated_at" : "2018-02-21T21:04:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/169721029",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12493#discussion_r169730801"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12493"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/169730801"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah, I was doing something with the macros and CCriticalSection. It was an error about not having an `unlock` method.\r\n\r\nI'll test this out, but from testing I just did with the current code, it looks like it does work, so this should work too.",
      "commit_id" : "437d2dd56f81a6258243aca6ed137cbca9255b32",
      "created_at" : "2018-02-21T18:19:54Z",
      "diff_hunk" : "@@ -35,10 +35,11 @@ class CDBEnv\n     void EnvShutdown();\n \n public:\n-    mutable CCriticalSection cs_db;\n+    std::recursive_mutex cs_db;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12493#discussion_r169730801",
      "id" : 169730801,
      "in_reply_to_id" : 169655317,
      "original_commit_id" : "de939869f2513d403568fdc8b828300fe54f0639",
      "original_position" : 5,
      "path" : "src/wallet/db.h",
      "position" : null,
      "pull_request_review_id" : 98305130,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12493",
      "updated_at" : "2018-02-21T21:04:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/169730801",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12493#discussion_r169777432"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12493"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/169777432"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@ryanofsky I've used your commit.",
      "commit_id" : "437d2dd56f81a6258243aca6ed137cbca9255b32",
      "created_at" : "2018-02-21T21:06:22Z",
      "diff_hunk" : "@@ -35,10 +35,11 @@ class CDBEnv\n     void EnvShutdown();\n \n public:\n-    mutable CCriticalSection cs_db;\n+    std::recursive_mutex cs_db;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12493#discussion_r169777432",
      "id" : 169777432,
      "in_reply_to_id" : 169655317,
      "original_commit_id" : "de939869f2513d403568fdc8b828300fe54f0639",
      "original_position" : 5,
      "path" : "src/wallet/db.h",
      "position" : null,
      "pull_request_review_id" : 98359993,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12493",
      "updated_at" : "2018-02-21T21:06:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/169777432",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12493#discussion_r169836879"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12493"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/169836879"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"After encrypting the wallet, reload the database environment\"\r\n\r\nDelayed flushing seems more like a legitimate design tradeoff than a bad habit. Maybe just say something like \"flush and reload the database environment here to clear out any data in memory that might be left behind after the rewrite above.\"",
      "commit_id" : "437d2dd56f81a6258243aca6ed137cbca9255b32",
      "created_at" : "2018-02-22T02:05:04Z",
      "diff_hunk" : "@@ -690,6 +690,11 @@ bool CWallet::EncryptWallet(const SecureString& strWalletPassphrase)\n         // bits of the unencrypted private key in slack space in the database file.\n         dbw->Rewrite();\n \n+        // BDB seems to have a bad habit of writing old data into",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12493#discussion_r169836879",
      "id" : 169836879,
      "original_commit_id" : "b2a0bb97bb3773adce797724fb937e5bd4294f55",
      "original_position" : 4,
      "path" : "src/wallet/wallet.cpp",
      "position" : 4,
      "pull_request_review_id" : 98428192,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12493",
      "updated_at" : "2018-02-22T02:17:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/169836879",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12493#discussion_r169838060"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12493"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/169838060"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"After encrypting the wallet, reload the database environment\"\r\n\r\nLooking at the CDB::Rewrite implementation I noticed that it already has a while loop that sleeps until mapFileUseCount (for just one wallet) is 0. You could take advantage of this if you wanted by tweaking the while loop there to wait for all use counts in the environment to be 0 and then calling ReloadDbEnv inside CDB::Rewrite. This would be a simplification since it would let you get rid of the new condition variable, and it would also make the new waiting code more consistent with previous code.\r\n\r\nThis is just a suggestion, though. Your current implementation seems fine, too.",
      "commit_id" : "437d2dd56f81a6258243aca6ed137cbca9255b32",
      "created_at" : "2018-02-22T02:14:04Z",
      "diff_hunk" : "@@ -690,6 +690,11 @@ bool CWallet::EncryptWallet(const SecureString& strWalletPassphrase)\n         // bits of the unencrypted private key in slack space in the database file.\n         dbw->Rewrite();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12493#discussion_r169838060",
      "id" : 169838060,
      "original_commit_id" : "b2a0bb97bb3773adce797724fb937e5bd4294f55",
      "original_position" : 2,
      "path" : "src/wallet/wallet.cpp",
      "position" : 2,
      "pull_request_review_id" : 98428192,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12493",
      "updated_at" : "2018-02-22T02:17:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/169838060",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12493#discussion_r169842341"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12493"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/169842341"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The comment was just copied over from `rpcwallet.cpp`. ",
      "commit_id" : "437d2dd56f81a6258243aca6ed137cbca9255b32",
      "created_at" : "2018-02-22T02:48:38Z",
      "diff_hunk" : "@@ -690,6 +690,11 @@ bool CWallet::EncryptWallet(const SecureString& strWalletPassphrase)\n         // bits of the unencrypted private key in slack space in the database file.\n         dbw->Rewrite();\n \n+        // BDB seems to have a bad habit of writing old data into",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12493#discussion_r169842341",
      "id" : 169842341,
      "in_reply_to_id" : 169836879,
      "original_commit_id" : "b2a0bb97bb3773adce797724fb937e5bd4294f55",
      "original_position" : 4,
      "path" : "src/wallet/wallet.cpp",
      "position" : 4,
      "pull_request_review_id" : 98434190,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12493",
      "updated_at" : "2018-02-22T02:48:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/169842341",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12493#discussion_r169842400"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12493"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/169842400"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't want to do anything to `CDB::Rewrite` since it is used in places other than `encryptwallet`.",
      "commit_id" : "437d2dd56f81a6258243aca6ed137cbca9255b32",
      "created_at" : "2018-02-22T02:49:05Z",
      "diff_hunk" : "@@ -690,6 +690,11 @@ bool CWallet::EncryptWallet(const SecureString& strWalletPassphrase)\n         // bits of the unencrypted private key in slack space in the database file.\n         dbw->Rewrite();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12493#discussion_r169842400",
      "id" : 169842400,
      "in_reply_to_id" : 169838060,
      "original_commit_id" : "b2a0bb97bb3773adce797724fb937e5bd4294f55",
      "original_position" : 2,
      "path" : "src/wallet/wallet.cpp",
      "position" : 2,
      "pull_request_review_id" : 98434259,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12493",
      "updated_at" : "2018-02-22T02:49:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/169842400",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12493#discussion_r169964768"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12493"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/169964768"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "https://github.com/bitcoin/bitcoin/pull/12493#discussion_r169838060\r\n\r\n> I don't want to do anything to CDB::Rewrite since it is used in places other than encryptwallet\r\n\r\nI didn't realize Rewrite was called other places, and the current approach does seem fine. But if you did want to unify the UseCount waiting logic, I think you could do it in a pretty clean way by adding a `bool reload_env` or similar option to CDB::Rewrite. I think in terms code clarity, having the option would actually be an improvement over always reloading.\r\n",
      "commit_id" : "437d2dd56f81a6258243aca6ed137cbca9255b32",
      "created_at" : "2018-02-22T14:09:28Z",
      "diff_hunk" : "@@ -690,6 +690,11 @@ bool CWallet::EncryptWallet(const SecureString& strWalletPassphrase)\n         // bits of the unencrypted private key in slack space in the database file.\n         dbw->Rewrite();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12493#discussion_r169964768",
      "id" : 169964768,
      "in_reply_to_id" : 169838060,
      "original_commit_id" : "b2a0bb97bb3773adce797724fb937e5bd4294f55",
      "original_position" : 2,
      "path" : "src/wallet/wallet.cpp",
      "position" : 2,
      "pull_request_review_id" : 98575966,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12493",
      "updated_at" : "2018-02-22T14:09:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/169964768",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   }
]
