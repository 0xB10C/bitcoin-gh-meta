[
   {
      "author_association" : "MEMBER",
      "body" : "Apparently I wrote a MSVC-only code. I am going to investigate it. ",
      "created_at" : "2018-10-16T00:28:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14489#issuecomment-430059469",
      "id" : 430059469,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14489",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQzMDA1OTQ2OQ==",
      "updated_at" : "2018-10-16T00:28:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/430059469",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/11154118?v=4",
         "events_url" : "https://api.github.com/users/ken2812221/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ken2812221/followers",
         "following_url" : "https://api.github.com/users/ken2812221/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ken2812221/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ken2812221",
         "id" : 11154118,
         "login" : "ken2812221",
         "node_id" : "MDQ6VXNlcjExMTU0MTE4",
         "organizations_url" : "https://api.github.com/users/ken2812221/orgs",
         "received_events_url" : "https://api.github.com/users/ken2812221/received_events",
         "repos_url" : "https://api.github.com/users/ken2812221/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ken2812221/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ken2812221/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ken2812221"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Related #8631",
      "created_at" : "2018-10-16T02:17:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14489#issuecomment-430077056",
      "id" : 430077056,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14489",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQzMDA3NzA1Ng==",
      "updated_at" : "2018-10-16T02:17:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/430077056",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/3211283?v=4",
         "events_url" : "https://api.github.com/users/MeshCollider/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MeshCollider/followers",
         "following_url" : "https://api.github.com/users/MeshCollider/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MeshCollider/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MeshCollider",
         "id" : 3211283,
         "login" : "MeshCollider",
         "node_id" : "MDQ6VXNlcjMyMTEyODM=",
         "organizations_url" : "https://api.github.com/users/MeshCollider/orgs",
         "received_events_url" : "https://api.github.com/users/MeshCollider/received_events",
         "repos_url" : "https://api.github.com/users/MeshCollider/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MeshCollider/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MeshCollider/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MeshCollider"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This is ready for review",
      "created_at" : "2018-10-16T16:37:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14489#issuecomment-430308193",
      "id" : 430308193,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14489",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQzMDMwODE5Mw==",
      "updated_at" : "2018-10-16T16:37:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/430308193",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/11154118?v=4",
         "events_url" : "https://api.github.com/users/ken2812221/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ken2812221/followers",
         "following_url" : "https://api.github.com/users/ken2812221/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ken2812221/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ken2812221",
         "id" : 11154118,
         "login" : "ken2812221",
         "node_id" : "MDQ6VXNlcjExMTU0MTE4",
         "organizations_url" : "https://api.github.com/users/ken2812221/orgs",
         "received_events_url" : "https://api.github.com/users/ken2812221/received_events",
         "repos_url" : "https://api.github.com/users/ken2812221/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ken2812221/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ken2812221/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ken2812221"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14489#discussion_r225859931"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14489"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/225859931"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Missing newline at end of file :-)",
      "commit_id" : "6e0ba815df1815105409db503767815d96aa4a1c",
      "created_at" : "2018-10-17T10:01:58Z",
      "diff_hunk" : "@@ -43,3 +43,30 @@ bool CThreadInterrupt::sleep_for(std::chrono::minutes rel_time)\n {\n     return sleep_for(std::chrono::duration_cast<std::chrono::milliseconds>(rel_time));\n }\n+\n+thread_local InterruptFlag* g_interrupt_flag;\n+\n+void InterruptibleThread::interrupt()\n+{\n+    {\n+        std::lock_guard<std::mutex> lock(m_interrupt_flag->m_mutex);\n+        m_interrupt_flag->m_interrupted = true;\n+    }\n+    m_interrupt_flag->m_cond.notify_one();\n+}\n+\n+void InterruptibleThread::join()\n+{\n+    m_internal.join();\n+}\n+\n+void InterruptionPoint()\n+{\n+    if (!g_interrupt_flag) { // Not interruptible thread\n+        return;\n+    }\n+    std::lock_guard<std::mutex> lock(g_interrupt_flag->m_mutex);\n+    if (g_interrupt_flag->m_interrupted) {\n+        throw ThreadInterrupted();\n+    }\n+}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14489#discussion_r225859931",
      "id" : 225859931,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIyNTg1OTkzMQ==",
      "original_commit_id" : "95fd49ae4c6b0cd45ae8a827e074af20ed75fbdf",
      "original_position" : 30,
      "path" : "src/threadinterrupt.cpp",
      "position" : null,
      "pull_request_review_id" : 165548645,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14489",
      "updated_at" : "2018-10-18T16:10:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/225859931",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14489#discussion_r225867106"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14489"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/225867106"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is the nonpublic inheritance here intentional? If so, make the inheritance explicitly `private` and add a comment to clarify that this is intentional. If not, make it `public` :-)\r\n\r\nBackground:\r\n\r\n`ThreadInterrupted` won't be catched by say `catch (const std::exception& e)` since `ThreadInterrupted` has nonpublic inheritance from `std::exception`.\r\n\r\nExample:\r\n\r\n```\r\n[cling]$ #include <iostream>\r\n[cling]$ class PublicInheritanceException : public std::exception {};\r\n[cling]$ try {\r\n             throw PublicInheritanceException();\r\n         } catch (const std::exception& e) {\r\n             std::cout << \"exception catched\\n\";\r\n         }\r\nexception catched\r\n[cling]$ class PrivateByDefaultInheritanceException : std::exception {};\r\n[cling]$ try {\r\n             throw PrivateByDefaultInheritanceException();\r\n         } catch (const std::exception& e) {\r\n             std::cout << \"exception catched\\n\";\r\n         }\r\n*program terminates*\r\n```\r\n\r\n",
      "commit_id" : "6e0ba815df1815105409db503767815d96aa4a1c",
      "created_at" : "2018-10-17T10:26:05Z",
      "diff_hunk" : "@@ -34,4 +36,59 @@ class CThreadInterrupt\n     std::atomic<bool> flag;\n };\n \n+struct InterruptFlag {\n+    std::mutex m_mutex;\n+    std::condition_variable m_cond;\n+    bool m_interrupted = false; // GUARDED_BY(m_mutex)\n+};\n+\n+extern thread_local InterruptFlag* g_interrupt_flag;\n+\n+class InterruptibleThread\n+{\n+public:\n+    template<typename Function, typename ... Args>\n+    InterruptibleThread(Function&& func, Args&& ...args) {\n+        InterruptFlag* flag_ptr = new InterruptFlag();\n+        m_interrupt_flag = std::unique_ptr<InterruptFlag>(flag_ptr);\n+        std::promise<void> pro;\n+        m_internal = std::thread([flag_ptr, &pro](typename std::decay<Function>::type&& func, typename std::decay<Args>::type&&...args){\n+            g_interrupt_flag = flag_ptr;\n+            pro.set_value();\n+            func(std::forward<Args>(args)...);\n+        }, std::forward<Function>(func), std::forward<Args>(args)...);\n+        pro.get_future().get();\n+    }\n+\n+    void join();\n+    void interrupt();\n+\n+private:\n+    std::thread m_internal;\n+    std::unique_ptr<InterruptFlag> m_interrupt_flag;\n+};\n+\n+class ThreadInterrupted : std::exception",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14489#discussion_r225867106",
      "id" : 225867106,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIyNTg2NzEwNg==",
      "original_commit_id" : "95fd49ae4c6b0cd45ae8a827e074af20ed75fbdf",
      "original_position" : 45,
      "path" : "src/threadinterrupt.h",
      "position" : null,
      "pull_request_review_id" : 165557549,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14489",
      "updated_at" : "2018-10-18T16:10:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/225867106",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@donaloconnor It should use mutex because it's used by the condition_variable.\r\n\r\nFor reference, you can find boost implementation for [pthread](https://github.com/boostorg/thread/blob/develop/src/pthread/thread.cpp), it acquires lock before it reads `interrupt_requested`.\r\n\r\nIf it can drop InterruptibleSleep in the future, then it's fine to switch to atomic.",
      "created_at" : "2018-10-17T15:03:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14489#issuecomment-430665327",
      "id" : 430665327,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14489",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQzMDY2NTMyNw==",
      "updated_at" : "2018-10-18T00:19:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/430665327",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/11154118?v=4",
         "events_url" : "https://api.github.com/users/ken2812221/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ken2812221/followers",
         "following_url" : "https://api.github.com/users/ken2812221/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ken2812221/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ken2812221",
         "id" : 11154118,
         "login" : "ken2812221",
         "node_id" : "MDQ6VXNlcjExMTU0MTE4",
         "organizations_url" : "https://api.github.com/users/ken2812221/orgs",
         "received_events_url" : "https://api.github.com/users/ken2812221/received_events",
         "repos_url" : "https://api.github.com/users/ken2812221/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ken2812221/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ken2812221/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ken2812221"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@ken2812221 ah yes for the sleep. Thanks for the link to boosts impl.",
      "created_at" : "2018-10-18T07:50:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14489#issuecomment-430910162",
      "id" : 430910162,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14489",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQzMDkxMDE2Mg==",
      "updated_at" : "2018-10-18T07:50:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/430910162",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6394033?v=4",
         "events_url" : "https://api.github.com/users/donaloconnor/events{/privacy}",
         "followers_url" : "https://api.github.com/users/donaloconnor/followers",
         "following_url" : "https://api.github.com/users/donaloconnor/following{/other_user}",
         "gists_url" : "https://api.github.com/users/donaloconnor/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/donaloconnor",
         "id" : 6394033,
         "login" : "donaloconnor",
         "node_id" : "MDQ6VXNlcjYzOTQwMzM=",
         "organizations_url" : "https://api.github.com/users/donaloconnor/orgs",
         "received_events_url" : "https://api.github.com/users/donaloconnor/received_events",
         "repos_url" : "https://api.github.com/users/donaloconnor/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/donaloconnor/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/donaloconnor/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/donaloconnor"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Actually, I think it's fine to make it use both atomic and mutex at the same time. Then we don't have to lock mutex in InterruptionPoint.",
      "created_at" : "2018-10-18T11:36:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14489#issuecomment-430975441",
      "id" : 430975441,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14489",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQzMDk3NTQ0MQ==",
      "updated_at" : "2018-10-18T11:36:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/430975441",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/11154118?v=4",
         "events_url" : "https://api.github.com/users/ken2812221/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ken2812221/followers",
         "following_url" : "https://api.github.com/users/ken2812221/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ken2812221/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ken2812221",
         "id" : 11154118,
         "login" : "ken2812221",
         "node_id" : "MDQ6VXNlcjExMTU0MTE4",
         "organizations_url" : "https://api.github.com/users/ken2812221/orgs",
         "received_events_url" : "https://api.github.com/users/ken2812221/received_events",
         "repos_url" : "https://api.github.com/users/ken2812221/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ken2812221/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ken2812221/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ken2812221"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "In this case it might work but in practice it can cause race conditions. The value of the atomic can change from the moment the cond var is signalled and the predicate is checked (to work with spurious wakeups). Eg: false->true->notify+wakeup->false->predcheck.\r\n\r\nThe last false flag can never happen here (at least my understanding of the code) I guess so maybe it's okay.",
      "created_at" : "2018-10-18T11:52:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14489#issuecomment-430979343",
      "id" : 430979343,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14489",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQzMDk3OTM0Mw==",
      "updated_at" : "2018-10-18T11:52:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/430979343",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6394033?v=4",
         "events_url" : "https://api.github.com/users/donaloconnor/events{/privacy}",
         "followers_url" : "https://api.github.com/users/donaloconnor/followers",
         "following_url" : "https://api.github.com/users/donaloconnor/following{/other_user}",
         "gists_url" : "https://api.github.com/users/donaloconnor/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/donaloconnor",
         "id" : 6394033,
         "login" : "donaloconnor",
         "node_id" : "MDQ6VXNlcjYzOTQwMzM=",
         "organizations_url" : "https://api.github.com/users/donaloconnor/orgs",
         "received_events_url" : "https://api.github.com/users/donaloconnor/received_events",
         "repos_url" : "https://api.github.com/users/donaloconnor/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/donaloconnor/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/donaloconnor/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/donaloconnor"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@donaloconnor I am not sure people would allow this solution. Now the flag contains two variable:\r\n- atomic bool read in `InterruptionPoint`\r\n- non-atomic bool read in `InterruptionSleep`",
      "created_at" : "2018-10-18T17:05:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14489#issuecomment-431087509",
      "id" : 431087509,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14489",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQzMTA4NzUwOQ==",
      "updated_at" : "2018-10-18T17:05:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/431087509",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/11154118?v=4",
         "events_url" : "https://api.github.com/users/ken2812221/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ken2812221/followers",
         "following_url" : "https://api.github.com/users/ken2812221/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ken2812221/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ken2812221",
         "id" : 11154118,
         "login" : "ken2812221",
         "node_id" : "MDQ6VXNlcjExMTU0MTE4",
         "organizations_url" : "https://api.github.com/users/ken2812221/orgs",
         "received_events_url" : "https://api.github.com/users/ken2812221/received_events",
         "repos_url" : "https://api.github.com/users/ken2812221/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ken2812221/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ken2812221/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ken2812221"
      }
   }
]
