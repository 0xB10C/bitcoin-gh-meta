{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "NONE",
   "body" : "Hi,\r\n\r\n**Problem**\r\n\r\nThe refactoring done in #17579 introduced some performance degradation for the rpc commands `getreceivedbyaddress` and `getreceivedbylabel`, which prevented an upgrade to versions >=0.21.0 for us without custom patches that revert this PR. The requests take notably longer to complete. This is especially painful when using big wallet files or issuing a large number of requests in a short period of time.\r\nI know that the foremost goal of Bitcoin Core may not be performance, but given that these rpc commands are some of the most prominent ones needed when interacting with wallets via rpc, I propose to do some changes here.\r\n\r\n**Analysis**\r\n\r\nCurrently, a set of search address is generated from the scriptpubkeys and then these addresses are compared against all addresses in the wallet, which means for each transaction in the wallet, the time consuming conversion from scriptpubkey to address needs to happen (in `ExtractDestination(...)`).\r\n\r\n**Solution Proposal**\r\n\r\nGiven that the majority of use cases comprises searching for a small set of addresses in a large set of addresses (the wallet), it makes more sense to rather create a set of scriptpubkeys from the search addresses and then compare each scriptpubkey in the wallet against this set. This is similar to how it was done before #17579, except that we now use a set, which means a search for multiple addresses (corresponding to a single label) stays possible and the refactoring can be more or less kept as is.\r\n\r\nI may not have time soon to implement this properly, but what do you think (conceptually)?",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 0,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23645/comments",
   "created_at" : "2021-12-01T19:33:32Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23645/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/23645",
   "id" : 1068795565,
   "labels" : [
      {
         "color" : "FBBAAB",
         "default" : false,
         "description" : null,
         "id" : 64585,
         "name" : "Bug",
         "node_id" : "MDU6TGFiZWw2NDU4NQ==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Bug"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23645/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "I_kwDOABII584_tIat",
   "number" : 23645,
   "performed_via_github_app" : null,
   "reactions" : {
      "+1" : 0,
      "-1" : 0,
      "confused" : 0,
      "eyes" : 0,
      "heart" : 0,
      "hooray" : 0,
      "laugh" : 0,
      "rocket" : 0,
      "total_count" : 0,
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23645/reactions"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "timeline_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23645/timeline",
   "title" : "getreceivedby[address, label] rpc performance proposal",
   "updated_at" : "2021-12-01T19:33:32Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23645",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/95378531?v=4",
      "events_url" : "https://api.github.com/users/beegater/events{/privacy}",
      "followers_url" : "https://api.github.com/users/beegater/followers",
      "following_url" : "https://api.github.com/users/beegater/following{/other_user}",
      "gists_url" : "https://api.github.com/users/beegater/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/beegater",
      "id" : 95378531,
      "login" : "beegater",
      "node_id" : "U_kgDOBa9cYw",
      "organizations_url" : "https://api.github.com/users/beegater/orgs",
      "received_events_url" : "https://api.github.com/users/beegater/received_events",
      "repos_url" : "https://api.github.com/users/beegater/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/beegater/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/beegater/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/beegater"
   }
}
