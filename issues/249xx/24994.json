{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "MEMBER",
   "body" : "This PR has twofold benefits.\r\n\r\n---\r\n\r\nFirst, the resulted binaries are smaller, because a linker only extracts from a convenience library those object files that are actually referenced in the code being linked.\r\n\r\nIt's easy to verify by comparing `nm` outputs.\r\n\r\n---\r\n\r\nSecond, this PR fix `libbitcoinconsensus` Windows builds with `DEBUG=1`.\r\n\r\nOn master (833add0f48b0fad84d7b8cf9373a349e7aef20b4):\r\n```\r\n$ ./autogen.sh\r\n$ ./configure --host=x86_64-w64-mingw32 CPPFLAGS='-D_GLIBCXX_DEBUG' --disable-bench --disable-fuzz-binary --disable-tests --disable-wallet --without-daemon --without-gui --without-utils\r\n$ make clean\r\n$ make\r\n...\r\n  CXXLD    libbitcoinconsensus.la\r\n/usr/bin/x86_64-w64-mingw32-ld: consensus/.libs/libbitcoinconsensus_la-merkle.o:/usr/lib/gcc/x86_64-w64-mingw32/10-posix/include/c++/x86_64-w64-mingw32/bits/gthr-default.h:749: undefined reference to `__imp_pthread_mutex_lock'\r\n/usr/bin/x86_64-w64-mingw32-ld: consensus/.libs/libbitcoinconsensus_la-merkle.o:/usr/lib/gcc/x86_64-w64-mingw32/10-posix/include/c++/x86_64-w64-mingw32/bits/gthr-default.h:779: undefined reference to `__imp_pthread_mutex_unlock'\r\n...\r\n```\r\n\r\nWith this PR:\r\n```\r\n$ ./autogen.sh\r\n$ ./configure --host=x86_64-w64-mingw32 CPPFLAGS='-D_GLIBCXX_DEBUG' --disable-bench --disable-fuzz-binary --disable-tests --disable-wallet --without-daemon --without-gui --without-utils\r\n$ make clean\r\n$ make\r\n# no errors\r\n```\r\n\r\nFrom `libstdc++` [docs](https://gcc.gnu.org/onlinedocs/libstdc++/manual/debug_mode_using.html):\r\n> Note that this flag [`-D_GLIBCXX_DEBUG`] changes the sizes and behavior of standard class templates such as `std::vector`, and therefore you can only link code compiled with debug mode and code compiled without debug mode if no instantiation of a container is passed between the two translation units.\r\n\r\nOn the master branch, a linker adds to binaries every specified object file. And it fails, for example, for https://github.com/bitcoin/bitcoin/blob/f58c1f1a446716a245ca204e2ac1a219455f1340/src/util/strencodings.h#L58-L59\r\nwhen building `libbitcoinconsensus-0.dll` which [in turn](https://www.sourceware.org/autobook/autobook/autobook_137.html)\r\n> effectively consists of two parts; the DLL itself which contains the shared object code, and an import library which consists of the stub functions which are actually linked into the executable, at a rate of one stub per entry point.\r\n\r\n---\r\n\r\n#### Guix builds on `x86_64`:\r\n```\r\n$ find guix-build-$(git rev-parse --short=12 HEAD)/output/ -type f -print0 | env LC_ALL=C sort -z | xargs -r0 sha256sum\r\nc2fbb0c034eaa53f3bc9a6f11fd490178c44d6034025a736d19ace9f87f0edaf  guix-build-9dffff799611/output/aarch64-linux-gnu/SHA256SUMS.part\r\n97c507e9d9637e910a8789206ca28b5cd59e24bc32e7e1a6e9c720e5f042f537  guix-build-9dffff799611/output/aarch64-linux-gnu/bitcoin-9dffff799611-aarch64-linux-gnu-debug.tar.gz\r\n21af490050a63a826aa5792b1c31562efcbada0659fa7b216914fb4490a71406  guix-build-9dffff799611/output/aarch64-linux-gnu/bitcoin-9dffff799611-aarch64-linux-gnu.tar.gz\r\na8e485f5a716511334971404d11b76794661bda6878deb4821e9924fb6fadc65  guix-build-9dffff799611/output/arm-linux-gnueabihf/SHA256SUMS.part\r\n3a6871cece656a133808d0e80c3314e2083954772bb86d71754e0f48abb29209  guix-build-9dffff799611/output/arm-linux-gnueabihf/bitcoin-9dffff799611-arm-linux-gnueabihf-debug.tar.gz\r\n72c65e9c82454c75859c1d692f43fb86b0af278751381fbf1ecc23770d19456c  guix-build-9dffff799611/output/arm-linux-gnueabihf/bitcoin-9dffff799611-arm-linux-gnueabihf.tar.gz\r\nf6265c638fa2658b8a7d3dbeaf436463c469d6610bf74123aa8711e82fbc342d  guix-build-9dffff799611/output/arm64-apple-darwin/SHA256SUMS.part\r\n09bd70e2356f9349e592acc91bb6342fc07ed89122f494da46c0522359bfbe70  guix-build-9dffff799611/output/arm64-apple-darwin/bitcoin-9dffff799611-arm64-apple-darwin-unsigned.dmg\r\n2959b0ae61a777b327b5314853feefce2650a8eb23d92e2f63c463efc454edc0  guix-build-9dffff799611/output/arm64-apple-darwin/bitcoin-9dffff799611-arm64-apple-darwin-unsigned.tar.gz\r\nf30bad82a02428012aba4cdb4c8d569baea407c844c99a192448ab96b2ee5a5e  guix-build-9dffff799611/output/arm64-apple-darwin/bitcoin-9dffff799611-arm64-apple-darwin.tar.gz\r\n9b5c4c26b8392894534f5435054ec038977f4ce9ba82feec30717a98fb5f8e7a  guix-build-9dffff799611/output/dist-archive/bitcoin-9dffff799611.tar.gz\r\nfed4a8b9f76feed80e4d5b0cf2457d158272f87c659128c6652a9bd8f44d89d9  guix-build-9dffff799611/output/powerpc64-linux-gnu/SHA256SUMS.part\r\nae41d4758d86a29df782a40aea1f48c3aa2889687be528c8d37e551cf454a456  guix-build-9dffff799611/output/powerpc64-linux-gnu/bitcoin-9dffff799611-powerpc64-linux-gnu-debug.tar.gz\r\n2976df7fb7283137d2f315b9a63ddde5f458c3ea39cff6f5908558d7a1afc574  guix-build-9dffff799611/output/powerpc64-linux-gnu/bitcoin-9dffff799611-powerpc64-linux-gnu.tar.gz\r\nf7312cccc96599cbd74dab9fdc32f65fbab22240c9e416a5a86a2bea180e80a4  guix-build-9dffff799611/output/powerpc64le-linux-gnu/SHA256SUMS.part\r\n4de424e6d726862b54055231734ecda71fd9ece3142c569ce41d9531346b9dfb  guix-build-9dffff799611/output/powerpc64le-linux-gnu/bitcoin-9dffff799611-powerpc64le-linux-gnu-debug.tar.gz\r\nbcc7300f20968ddf3e4af01c411d7a3f1e47cbd03fe8798039b88405373baf9c  guix-build-9dffff799611/output/powerpc64le-linux-gnu/bitcoin-9dffff799611-powerpc64le-linux-gnu.tar.gz\r\n2fcb053a33396081a1ed997db18fb0aca446434a2967ec2c4f071e597d6453b0  guix-build-9dffff799611/output/riscv64-linux-gnu/SHA256SUMS.part\r\n46fa42b3c76548d8cac1949761de0fd61633f329e5483064bf8b2346397a3744  guix-build-9dffff799611/output/riscv64-linux-gnu/bitcoin-9dffff799611-riscv64-linux-gnu-debug.tar.gz\r\n998d97fb6621d7e9ed3ece7f83e9273899d55f57ea8ac17757fdee490ed4b55f  guix-build-9dffff799611/output/riscv64-linux-gnu/bitcoin-9dffff799611-riscv64-linux-gnu.tar.gz\r\n98140a7d8eaac707d278553504ae027b2ced24bc13a2d03341264cdc961b8fce  guix-build-9dffff799611/output/x86_64-apple-darwin/SHA256SUMS.part\r\na120ac124f845d76bcfda9f5e5d4b490feed0a70dbc49837b508a570aa0f797d  guix-build-9dffff799611/output/x86_64-apple-darwin/bitcoin-9dffff799611-x86_64-apple-darwin-unsigned.dmg\r\ndd643d5977e5fe8ec065d3b4dbddb1778f2f4df212eb6093b7f6234ea7a10705  guix-build-9dffff799611/output/x86_64-apple-darwin/bitcoin-9dffff799611-x86_64-apple-darwin-unsigned.tar.gz\r\nb9c2312a8d98c0aa1993eddbd20eed97f0f7a5efda002ef9ef65a4a496937f60  guix-build-9dffff799611/output/x86_64-apple-darwin/bitcoin-9dffff799611-x86_64-apple-darwin.tar.gz\r\nfa90aeb1dfc48ff54d78813441d1b62f17b2465b00b17404688aedf4cadad550  guix-build-9dffff799611/output/x86_64-linux-gnu/SHA256SUMS.part\r\n74d86d61cb115b5159c38ae4f6de0b1d703341d2113421a75d85634259609dc1  guix-build-9dffff799611/output/x86_64-linux-gnu/bitcoin-9dffff799611-x86_64-linux-gnu-debug.tar.gz\r\ne31351de63a8d8e70e63ecceed9a3540863dcbfef482b214ce92773bc62dfe3c  guix-build-9dffff799611/output/x86_64-linux-gnu/bitcoin-9dffff799611-x86_64-linux-gnu.tar.gz\r\n2800ce88828c1d01fb86b10ed0852b2924c6b843d4b3f7f1bb372f73ee85ee50  guix-build-9dffff799611/output/x86_64-w64-mingw32/SHA256SUMS.part\r\nc292ecec55e3b4d6458796b231d5a8beb1dab3195f37bbd0c0ddedf5ff8ef82f  guix-build-9dffff799611/output/x86_64-w64-mingw32/bitcoin-9dffff799611-win64-debug.zip\r\nbea681a65f7117be8e1e3edac1cadc3dc2d8b3660b3d96a5cc815e81cb82d9ec  guix-build-9dffff799611/output/x86_64-w64-mingw32/bitcoin-9dffff799611-win64-setup-unsigned.exe\r\n8240ff903d660e5a9aa8e0d48e029d327f4be2d96a8de0ba358b37d6b90cfa66  guix-build-9dffff799611/output/x86_64-w64-mingw32/bitcoin-9dffff799611-win64-unsigned.tar.gz\r\na7c69d26842bbef354ebd5a248d341d0c796aae1d216a34ac09603122d4cd1f6  guix-build-9dffff799611/output/x86_64-w64-mingw32/bitcoin-9dffff799611-win64.zip\r\n```\r\n\r\n---\r\n\r\nThis PR is compatible with bitcoin/bitcoin#24322.\r\n\r\nTODO:\r\n- [ ] Fix MSVC build\r\n\r\nFixes bitcoin/bitcoin#19772.",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 3,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24994/comments",
   "created_at" : "2022-04-26T17:54:34Z",
   "draft" : true,
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24994/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/24994",
   "id" : 1216293178,
   "labels" : [
      {
         "color" : "5319e7",
         "default" : false,
         "description" : null,
         "id" : 61889416,
         "name" : "Build system",
         "node_id" : "MDU6TGFiZWw2MTg4OTQxNg==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Build%20system"
      },
      {
         "color" : "009800",
         "default" : false,
         "description" : null,
         "id" : 192202000,
         "name" : "Consensus",
         "node_id" : "MDU6TGFiZWwxOTIyMDIwMDA=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Consensus"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24994/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "PR_kwDOABII58420cG9",
   "number" : 24994,
   "performed_via_github_app" : null,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/24994.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24994",
      "merged_at" : null,
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/24994.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24994"
   },
   "reactions" : {
      "+1" : 0,
      "-1" : 0,
      "confused" : 0,
      "eyes" : 0,
      "heart" : 0,
      "hooray" : 0,
      "laugh" : 0,
      "rocket" : 0,
      "total_count" : 0,
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24994/reactions"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "timeline_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24994/timeline",
   "title" : "build: Build `libbitcoinconsensus` from its own convenience library",
   "updated_at" : "2022-04-27T11:39:54Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24994",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
      "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
      "followers_url" : "https://api.github.com/users/hebasto/followers",
      "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/hebasto",
      "id" : 32963518,
      "login" : "hebasto",
      "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
      "organizations_url" : "https://api.github.com/users/hebasto/orgs",
      "received_events_url" : "https://api.github.com/users/hebasto/received_events",
      "repos_url" : "https://api.github.com/users/hebasto/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/hebasto"
   }
}
