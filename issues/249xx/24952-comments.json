[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Some basic timings for mainnet on my (admittedly not so amazing iMac), comparing to the existing compact format.\r\n\r\n## Time\r\n<img width=\"628\" alt=\"Screenshot 2022-04-23 at 09 09 57\" src=\"https://user-images.githubusercontent.com/3072149/164888919-ee4e8e8a-de15-41cb-8a71-9722c19208ed.png\">\r\n\r\n## Size\r\n<img width=\"324\" alt=\"Screenshot 2022-04-23 at 09 10 31\" src=\"https://user-images.githubusercontent.com/3072149/164888920-33c25d2b-e1a6-45b2-9f21-965f2aeab691.png\">\r\n\r\n---\r\n\r\nRoughly around twice as long and twice as big.\r\n",
      "created_at" : "2022-04-23T09:33:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24952#issuecomment-1107441666",
      "id" : 1107441666,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24952",
      "node_id" : "IC_kwDOABII585CAjgC",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1107441666/reactions"
      },
      "updated_at" : "2022-04-23T09:33:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1107441666",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3072149?v=4",
         "events_url" : "https://api.github.com/users/dunxen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dunxen/followers",
         "following_url" : "https://api.github.com/users/dunxen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dunxen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dunxen",
         "id" : 3072149,
         "login" : "dunxen",
         "node_id" : "MDQ6VXNlcjMwNzIxNDk=",
         "organizations_url" : "https://api.github.com/users/dunxen/orgs",
         "received_events_url" : "https://api.github.com/users/dunxen/received_events",
         "repos_url" : "https://api.github.com/users/dunxen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dunxen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dunxen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dunxen"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24952#discussion_r856872979"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24952"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/856872979"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "clang-format-diff.py formatted this and there are some changes. Not ideal for review, but let me know if I should remove the formatting.",
      "commit_id" : "eaa4e63dac2bfd32a6457f6bea1dd3d81b0e77ec",
      "created_at" : "2022-04-23T09:36:01Z",
      "diff_hunk" : "@@ -2260,50 +2261,66 @@ static RPCHelpMan dumptxoutset()\n         \"Write the serialized UTXO set to disk.\",\n         {\n             {\"path\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Path to the output file. If relative, will be prefixed by datadir.\"},\n+            {\"format\", RPCArg::Type::STR, RPCArg::Default{\"compact\"}, \"'compact' to output a compact binary serialized format, 'sqlite' to output a SQLite database with table 'txoutset' (requires sqlite3)\", \"format\"},\n         },\n         RPCResult{\n-            RPCResult::Type::OBJ, \"\", \"\",\n-                {\n-                    {RPCResult::Type::NUM, \"coins_written\", \"the number of coins written in the snapshot\"},\n-                    {RPCResult::Type::STR_HEX, \"base_hash\", \"the hash of the base of the snapshot\"},\n-                    {RPCResult::Type::NUM, \"base_height\", \"the height of the base of the snapshot\"},\n-                    {RPCResult::Type::STR, \"path\", \"the absolute path that the snapshot was written to\"},\n-                    {RPCResult::Type::STR_HEX, \"txoutset_hash\", \"the hash of the UTXO set contents\"},\n-                    {RPCResult::Type::NUM, \"nchaintx\", \"the number of transactions in the chain up to and including the base block\"},\n-                }\n-        },\n-        RPCExamples{\n-            HelpExampleCli(\"dumptxoutset\", \"utxo.dat\")\n-        },\n-        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n-{\n-    const ArgsManager& args{EnsureAnyArgsman(request.context)};\n-    const fs::path path = fsbridge::AbsPathJoin(args.GetDataDirNet(), fs::u8path(request.params[0].get_str()));\n-    // Write to a temporary path and then move into `path` on completion\n-    // to avoid confusion due to an interruption.\n-    const fs::path temppath = fsbridge::AbsPathJoin(args.GetDataDirNet(), fs::u8path(request.params[0].get_str() + \".incomplete\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24952#discussion_r856872979",
      "id" : 856872979,
      "line" : 2284,
      "node_id" : "PRRC_kwDOABII584zEtgT",
      "original_commit_id" : "eaa4e63dac2bfd32a6457f6bea1dd3d81b0e77ec",
      "original_line" : 2284,
      "original_position" : 34,
      "original_start_line" : 2265,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 34,
      "pull_request_review_id" : 950948827,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24952",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/856872979/reactions"
      },
      "side" : "LEFT",
      "start_line" : 2265,
      "start_side" : "LEFT",
      "updated_at" : "2022-04-23T09:36:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/856872979",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3072149?v=4",
         "events_url" : "https://api.github.com/users/dunxen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dunxen/followers",
         "following_url" : "https://api.github.com/users/dunxen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dunxen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dunxen",
         "id" : 3072149,
         "login" : "dunxen",
         "node_id" : "MDQ6VXNlcjMwNzIxNDk=",
         "organizations_url" : "https://api.github.com/users/dunxen/orgs",
         "received_events_url" : "https://api.github.com/users/dunxen/received_events",
         "repos_url" : "https://api.github.com/users/dunxen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dunxen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dunxen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dunxen"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#24923](https://github.com/bitcoin/bitcoin/pull/24923) (Rework logging timer by MarcoFalke)\n* [#24912](https://github.com/bitcoin/bitcoin/pull/24912) (refactor: update CBlockIndex::nChainTx to be uint64_t by mruddy)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-04-24T04:21:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24952#issuecomment-1107706464",
      "id" : 1107706464,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24952",
      "node_id" : "IC_kwDOABII585CBkJg",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1107706464/reactions"
      },
      "updated_at" : "2022-04-24T04:21:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1107706464",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24952#discussion_r857084136"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24952"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857084136"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think this makes sqlite3 a required dependency for building Bitcoin Core, right?\r\n\r\nSome CI tasks are failing because they don't have `sqlite3.h`.\r\n\r\nhttps://github.com/bitcoin/bitcoin/pull/24952/checks?check_run_id=6139350735\r\n\r\n```\r\nrpc/blockchain.cpp:34:10: fatal error: 'sqlite3.h' file not found\r\n#include <sqlite3.h>\r\n         ^~~~~~~~~~~\r\n```",
      "commit_id" : "eaa4e63dac2bfd32a6457f6bea1dd3d81b0e77ec",
      "created_at" : "2022-04-24T07:55:11Z",
      "diff_hunk" : "@@ -31,6 +31,7 @@\n #include <rpc/server_util.h>\n #include <rpc/util.h>\n #include <script/descriptor.h>\n+#include <sqlite3.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24952#discussion_r857084136",
      "id" : 857084136,
      "line" : 34,
      "node_id" : "PRRC_kwDOABII584zFhDo",
      "original_commit_id" : "eaa4e63dac2bfd32a6457f6bea1dd3d81b0e77ec",
      "original_line" : 34,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 4,
      "pull_request_review_id" : 951166654,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24952",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857084136/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-24T07:55:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857084136",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19157360?v=4",
         "events_url" : "https://api.github.com/users/0xB10C/events{/privacy}",
         "followers_url" : "https://api.github.com/users/0xB10C/followers",
         "following_url" : "https://api.github.com/users/0xB10C/following{/other_user}",
         "gists_url" : "https://api.github.com/users/0xB10C/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/0xB10C",
         "id" : 19157360,
         "login" : "0xB10C",
         "node_id" : "MDQ6VXNlcjE5MTU3MzYw",
         "organizations_url" : "https://api.github.com/users/0xB10C/orgs",
         "received_events_url" : "https://api.github.com/users/0xB10C/received_events",
         "repos_url" : "https://api.github.com/users/0xB10C/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/0xB10C/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/0xB10C/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/0xB10C"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24952#discussion_r857084596"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24952"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857084596"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ah, right! Will fix up",
      "commit_id" : "eaa4e63dac2bfd32a6457f6bea1dd3d81b0e77ec",
      "created_at" : "2022-04-24T07:58:14Z",
      "diff_hunk" : "@@ -31,6 +31,7 @@\n #include <rpc/server_util.h>\n #include <rpc/util.h>\n #include <script/descriptor.h>\n+#include <sqlite3.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24952#discussion_r857084596",
      "id" : 857084596,
      "in_reply_to_id" : 857084136,
      "line" : 34,
      "node_id" : "PRRC_kwDOABII584zFhK0",
      "original_commit_id" : "eaa4e63dac2bfd32a6457f6bea1dd3d81b0e77ec",
      "original_line" : 34,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 4,
      "pull_request_review_id" : 951167049,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24952",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857084596/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-24T07:58:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857084596",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3072149?v=4",
         "events_url" : "https://api.github.com/users/dunxen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dunxen/followers",
         "following_url" : "https://api.github.com/users/dunxen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dunxen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dunxen",
         "id" : 3072149,
         "login" : "dunxen",
         "node_id" : "MDQ6VXNlcjMwNzIxNDk=",
         "organizations_url" : "https://api.github.com/users/dunxen/orgs",
         "received_events_url" : "https://api.github.com/users/dunxen/received_events",
         "repos_url" : "https://api.github.com/users/dunxen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dunxen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dunxen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dunxen"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24952#discussion_r857092327"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24952"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857092327"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Please add comment explaining why we want `journal_mode` set to `wal2` and ideally add a link to SQLite documentation: https://www.sqlite.org/cgi/src/doc/wal2/doc/wal2.md",
      "commit_id" : "21ee90dda3daed0bc3d7063dfc2118537df08273",
      "created_at" : "2022-04-24T08:55:46Z",
      "diff_hunk" : "@@ -2340,30 +2357,107 @@ UniValue CreateUTXOSnapshot(\n         CHECK_NONFATAL(tip);\n     }\n \n-    LOG_TIME_SECONDS(strprintf(\"writing UTXO snapshot at height %s (%s) to file %s (via %s)\",\n-        tip->nHeight, tip->GetBlockHash().ToString(),\n-        fs::PathToString(path), fs::PathToString(temppath)));\n+    if (is_compact) {\n+        LOG_TIME_SECONDS(strprintf(\"writing UTXO snapshot at height %s (%s) to file %s (via %s)\",\n+                                   tip->nHeight, tip->GetBlockHash().ToString(),\n+                                   fs::PathToString(path), fs::PathToString(temppath)));\n+        SnapshotMetadata metadata{tip->GetBlockHash(), stats.coins_count, tip->nChainTx};\n \n-    SnapshotMetadata metadata{tip->GetBlockHash(), stats.coins_count, tip->nChainTx};\n+        afile << metadata;\n \n-    afile << metadata;\n+        COutPoint key;\n+        Coin coin;\n+        unsigned int iter{0};\n+\n+        while (pcursor->Valid()) {\n+            if (iter % 5000 == 0) node.rpc_interruption_point();\n+            ++iter;\n+            if (pcursor->GetKey(key) && pcursor->GetValue(coin)) {\n+                afile << key;\n+                afile << coin;\n+            }\n \n-    COutPoint key;\n-    Coin coin;\n-    unsigned int iter{0};\n-\n-    while (pcursor->Valid()) {\n-        if (iter % 5000 == 0) node.rpc_interruption_point();\n-        ++iter;\n-        if (pcursor->GetKey(key) && pcursor->GetValue(coin)) {\n-            afile << key;\n-            afile << coin;\n+            pcursor->Next();\n         }\n \n-        pcursor->Next();\n-    }\n+        afile.fclose();\n+    } else {\n+        LOG_TIME_SECONDS(strprintf(\"writing UTXO snapshot at height %s (%s) to sqlite DB file %s\",\n+                                   tip->nHeight, tip->GetBlockHash().ToString(), fs::PathToString(path)));\n+\n+        sqlite3* db;\n+        int ret;\n+\n+        if (!ValidAsCString(path)) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Invalid path\");\n+        }\n+\n+        ret = sqlite3_open(path.c_str(), &db);\n+        if (ret != SQLITE_OK) {\n+            sqlite3_close(db);\n+            throw JSONRPCError(RPC_INTERNAL_ERROR, strprintf(\"Unable to open database file %s\", path.u8string()));\n+        }\n+\n+        ret = sqlite3_exec(db, \"PRAGMA journal_mode=wal2;\", nullptr, nullptr, nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24952#discussion_r857092327",
      "id" : 857092327,
      "line" : 2397,
      "node_id" : "PRRC_kwDOABII584zFjDn",
      "original_commit_id" : "eaa4e63dac2bfd32a6457f6bea1dd3d81b0e77ec",
      "original_line" : 2397,
      "original_position" : 172,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 174,
      "pull_request_review_id" : 951174036,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24952",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857092327/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-24T11:30:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857092327",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/42201?v=4",
         "events_url" : "https://api.github.com/users/prusnak/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prusnak/followers",
         "following_url" : "https://api.github.com/users/prusnak/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prusnak/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prusnak",
         "id" : 42201,
         "login" : "prusnak",
         "node_id" : "MDQ6VXNlcjQyMjAx",
         "organizations_url" : "https://api.github.com/users/prusnak/orgs",
         "received_events_url" : "https://api.github.com/users/prusnak/received_events",
         "repos_url" : "https://api.github.com/users/prusnak/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prusnak/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prusnak/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prusnak"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24952#discussion_r857111827"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24952"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857111827"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The review would be so much easier if you reverted the formatting changes.",
      "commit_id" : "21ee90dda3daed0bc3d7063dfc2118537df08273",
      "created_at" : "2022-04-24T11:32:03Z",
      "diff_hunk" : "@@ -2260,50 +2261,66 @@ static RPCHelpMan dumptxoutset()\n         \"Write the serialized UTXO set to disk.\",\n         {\n             {\"path\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Path to the output file. If relative, will be prefixed by datadir.\"},\n+            {\"format\", RPCArg::Type::STR, RPCArg::Default{\"compact\"}, \"'compact' to output a compact binary serialized format, 'sqlite' to output a SQLite database with table 'txoutset' (requires sqlite3)\", \"format\"},\n         },\n         RPCResult{\n-            RPCResult::Type::OBJ, \"\", \"\",\n-                {\n-                    {RPCResult::Type::NUM, \"coins_written\", \"the number of coins written in the snapshot\"},\n-                    {RPCResult::Type::STR_HEX, \"base_hash\", \"the hash of the base of the snapshot\"},\n-                    {RPCResult::Type::NUM, \"base_height\", \"the height of the base of the snapshot\"},\n-                    {RPCResult::Type::STR, \"path\", \"the absolute path that the snapshot was written to\"},\n-                    {RPCResult::Type::STR_HEX, \"txoutset_hash\", \"the hash of the UTXO set contents\"},\n-                    {RPCResult::Type::NUM, \"nchaintx\", \"the number of transactions in the chain up to and including the base block\"},\n-                }\n-        },\n-        RPCExamples{\n-            HelpExampleCli(\"dumptxoutset\", \"utxo.dat\")\n-        },\n-        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n-{\n-    const ArgsManager& args{EnsureAnyArgsman(request.context)};\n-    const fs::path path = fsbridge::AbsPathJoin(args.GetDataDirNet(), fs::u8path(request.params[0].get_str()));\n-    // Write to a temporary path and then move into `path` on completion\n-    // to avoid confusion due to an interruption.\n-    const fs::path temppath = fsbridge::AbsPathJoin(args.GetDataDirNet(), fs::u8path(request.params[0].get_str() + \".incomplete\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24952#discussion_r857111827",
      "id" : 857111827,
      "in_reply_to_id" : 856872979,
      "line" : 2279,
      "node_id" : "PRRC_kwDOABII584zFn0T",
      "original_commit_id" : "eaa4e63dac2bfd32a6457f6bea1dd3d81b0e77ec",
      "original_line" : 2279,
      "original_position" : 34,
      "original_start_line" : 2265,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 36,
      "pull_request_review_id" : 951192093,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24952",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857111827/reactions"
      },
      "side" : "LEFT",
      "start_line" : 2260,
      "start_side" : "LEFT",
      "updated_at" : "2022-04-24T11:32:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857111827",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/42201?v=4",
         "events_url" : "https://api.github.com/users/prusnak/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prusnak/followers",
         "following_url" : "https://api.github.com/users/prusnak/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prusnak/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prusnak",
         "id" : 42201,
         "login" : "prusnak",
         "node_id" : "MDQ6VXNlcjQyMjAx",
         "organizations_url" : "https://api.github.com/users/prusnak/orgs",
         "received_events_url" : "https://api.github.com/users/prusnak/received_events",
         "repos_url" : "https://api.github.com/users/prusnak/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prusnak/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prusnak/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prusnak"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24952#discussion_r857112165"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24952"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857112165"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Is this used anywhere?",
      "commit_id" : "21ee90dda3daed0bc3d7063dfc2118537df08273",
      "created_at" : "2022-04-24T11:34:06Z",
      "diff_hunk" : "@@ -27,6 +27,7 @@ struct NodeContext;\n } // namespace node\n \n static constexpr int NUM_GETBLOCKSTATS_PERCENTILES = 5;\n+using coinsqlite_cb_t = std::function<std::string(const COutPoint&, const Coin&)>;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24952#discussion_r857112165",
      "id" : 857112165,
      "line" : 30,
      "node_id" : "PRRC_kwDOABII584zFn5l",
      "original_commit_id" : "21ee90dda3daed0bc3d7063dfc2118537df08273",
      "original_line" : 30,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.h",
      "position" : 4,
      "pull_request_review_id" : 951192349,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24952",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857112165/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-24T11:34:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857112165",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/42201?v=4",
         "events_url" : "https://api.github.com/users/prusnak/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prusnak/followers",
         "following_url" : "https://api.github.com/users/prusnak/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prusnak/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prusnak",
         "id" : 42201,
         "login" : "prusnak",
         "node_id" : "MDQ6VXNlcjQyMjAx",
         "organizations_url" : "https://api.github.com/users/prusnak/orgs",
         "received_events_url" : "https://api.github.com/users/prusnak/received_events",
         "repos_url" : "https://api.github.com/users/prusnak/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prusnak/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prusnak/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prusnak"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24952#discussion_r857112469"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24952"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857112469"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ah, not anymore. Was going to have configurable fields like in the CSV PR, but decided against it otherwise things would get a little too complex here.\n\nWill remove ð",
      "commit_id" : "21ee90dda3daed0bc3d7063dfc2118537df08273",
      "created_at" : "2022-04-24T11:36:19Z",
      "diff_hunk" : "@@ -27,6 +27,7 @@ struct NodeContext;\n } // namespace node\n \n static constexpr int NUM_GETBLOCKSTATS_PERCENTILES = 5;\n+using coinsqlite_cb_t = std::function<std::string(const COutPoint&, const Coin&)>;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24952#discussion_r857112469",
      "id" : 857112469,
      "in_reply_to_id" : 857112165,
      "line" : 30,
      "node_id" : "PRRC_kwDOABII584zFn-V",
      "original_commit_id" : "21ee90dda3daed0bc3d7063dfc2118537df08273",
      "original_line" : 30,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.h",
      "position" : 4,
      "pull_request_review_id" : 951192617,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24952",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857112469/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-24T11:36:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857112469",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3072149?v=4",
         "events_url" : "https://api.github.com/users/dunxen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dunxen/followers",
         "following_url" : "https://api.github.com/users/dunxen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dunxen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dunxen",
         "id" : 3072149,
         "login" : "dunxen",
         "node_id" : "MDQ6VXNlcjMwNzIxNDk=",
         "organizations_url" : "https://api.github.com/users/dunxen/orgs",
         "received_events_url" : "https://api.github.com/users/dunxen/received_events",
         "repos_url" : "https://api.github.com/users/dunxen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dunxen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dunxen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dunxen"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24952#discussion_r857112482"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24952"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857112482"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "maybe `enum UTXOSnapshotFormat { FORMAT_COMPACT = 0, FORMAT_SQLITE = 1 };` instead of `bool` would be nicer and more explicit?",
      "commit_id" : "21ee90dda3daed0bc3d7063dfc2118537df08273",
      "created_at" : "2022-04-24T11:36:29Z",
      "diff_hunk" : "@@ -53,6 +54,7 @@ void CalculatePercentilesByWeight(CAmount result[NUM_GETBLOCKSTATS_PERCENTILES],\n  * @return a UniValue map containing metadata about the snapshot.\n  */\n UniValue CreateUTXOSnapshot(\n+    const bool is_compact,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24952#discussion_r857112482",
      "id" : 857112482,
      "line" : 57,
      "node_id" : "PRRC_kwDOABII584zFn-i",
      "original_commit_id" : "21ee90dda3daed0bc3d7063dfc2118537df08273",
      "original_line" : 57,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.h",
      "position" : 12,
      "pull_request_review_id" : 951192636,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24952",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857112482/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-24T11:38:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857112482",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/42201?v=4",
         "events_url" : "https://api.github.com/users/prusnak/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prusnak/followers",
         "following_url" : "https://api.github.com/users/prusnak/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prusnak/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prusnak",
         "id" : 42201,
         "login" : "prusnak",
         "node_id" : "MDQ6VXNlcjQyMjAx",
         "organizations_url" : "https://api.github.com/users/prusnak/orgs",
         "received_events_url" : "https://api.github.com/users/prusnak/received_events",
         "repos_url" : "https://api.github.com/users/prusnak/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prusnak/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prusnak/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prusnak"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24952#discussion_r857112721"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24952"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857112721"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes, I agree. I was going back and forth between them but I think explicit is better here. Would be easier to introduce another format in the future too. Will change ð",
      "commit_id" : "21ee90dda3daed0bc3d7063dfc2118537df08273",
      "created_at" : "2022-04-24T11:38:26Z",
      "diff_hunk" : "@@ -53,6 +54,7 @@ void CalculatePercentilesByWeight(CAmount result[NUM_GETBLOCKSTATS_PERCENTILES],\n  * @return a UniValue map containing metadata about the snapshot.\n  */\n UniValue CreateUTXOSnapshot(\n+    const bool is_compact,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24952#discussion_r857112721",
      "id" : 857112721,
      "in_reply_to_id" : 857112482,
      "line" : 57,
      "node_id" : "PRRC_kwDOABII584zFoCR",
      "original_commit_id" : "21ee90dda3daed0bc3d7063dfc2118537df08273",
      "original_line" : 57,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.h",
      "position" : 12,
      "pull_request_review_id" : 951192878,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24952",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857112721/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-24T11:38:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857112721",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3072149?v=4",
         "events_url" : "https://api.github.com/users/dunxen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dunxen/followers",
         "following_url" : "https://api.github.com/users/dunxen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dunxen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dunxen",
         "id" : 3072149,
         "login" : "dunxen",
         "node_id" : "MDQ6VXNlcjMwNzIxNDk=",
         "organizations_url" : "https://api.github.com/users/dunxen/orgs",
         "received_events_url" : "https://api.github.com/users/dunxen/received_events",
         "repos_url" : "https://api.github.com/users/dunxen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dunxen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dunxen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dunxen"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Some other failures related to string type conversions in Windows I'm not so familiar with here. Will have a closer look when I'm back home.",
      "created_at" : "2022-04-24T11:40:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24952#issuecomment-1107823511",
      "id" : 1107823511,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24952",
      "node_id" : "IC_kwDOABII585CCAuX",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1107823511/reactions"
      },
      "updated_at" : "2022-04-24T11:40:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1107823511",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3072149?v=4",
         "events_url" : "https://api.github.com/users/dunxen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dunxen/followers",
         "following_url" : "https://api.github.com/users/dunxen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dunxen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dunxen",
         "id" : 3072149,
         "login" : "dunxen",
         "node_id" : "MDQ6VXNlcjMwNzIxNDk=",
         "organizations_url" : "https://api.github.com/users/dunxen/orgs",
         "received_events_url" : "https://api.github.com/users/dunxen/received_events",
         "repos_url" : "https://api.github.com/users/dunxen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dunxen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dunxen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dunxen"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24952#discussion_r857113355"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24952"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857113355"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Btw, isn't `journal_mode = off` even better match for what we want? I think that not using journal might significantly improve write performance.",
      "commit_id" : "21ee90dda3daed0bc3d7063dfc2118537df08273",
      "created_at" : "2022-04-24T11:43:17Z",
      "diff_hunk" : "@@ -2340,30 +2357,107 @@ UniValue CreateUTXOSnapshot(\n         CHECK_NONFATAL(tip);\n     }\n \n-    LOG_TIME_SECONDS(strprintf(\"writing UTXO snapshot at height %s (%s) to file %s (via %s)\",\n-        tip->nHeight, tip->GetBlockHash().ToString(),\n-        fs::PathToString(path), fs::PathToString(temppath)));\n+    if (is_compact) {\n+        LOG_TIME_SECONDS(strprintf(\"writing UTXO snapshot at height %s (%s) to file %s (via %s)\",\n+                                   tip->nHeight, tip->GetBlockHash().ToString(),\n+                                   fs::PathToString(path), fs::PathToString(temppath)));\n+        SnapshotMetadata metadata{tip->GetBlockHash(), stats.coins_count, tip->nChainTx};\n \n-    SnapshotMetadata metadata{tip->GetBlockHash(), stats.coins_count, tip->nChainTx};\n+        afile << metadata;\n \n-    afile << metadata;\n+        COutPoint key;\n+        Coin coin;\n+        unsigned int iter{0};\n+\n+        while (pcursor->Valid()) {\n+            if (iter % 5000 == 0) node.rpc_interruption_point();\n+            ++iter;\n+            if (pcursor->GetKey(key) && pcursor->GetValue(coin)) {\n+                afile << key;\n+                afile << coin;\n+            }\n \n-    COutPoint key;\n-    Coin coin;\n-    unsigned int iter{0};\n-\n-    while (pcursor->Valid()) {\n-        if (iter % 5000 == 0) node.rpc_interruption_point();\n-        ++iter;\n-        if (pcursor->GetKey(key) && pcursor->GetValue(coin)) {\n-            afile << key;\n-            afile << coin;\n+            pcursor->Next();\n         }\n \n-        pcursor->Next();\n-    }\n+        afile.fclose();\n+    } else {\n+        LOG_TIME_SECONDS(strprintf(\"writing UTXO snapshot at height %s (%s) to sqlite DB file %s\",\n+                                   tip->nHeight, tip->GetBlockHash().ToString(), fs::PathToString(path)));\n+\n+        sqlite3* db;\n+        int ret;\n+\n+        if (!ValidAsCString(path)) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Invalid path\");\n+        }\n+\n+        ret = sqlite3_open(path.c_str(), &db);\n+        if (ret != SQLITE_OK) {\n+            sqlite3_close(db);\n+            throw JSONRPCError(RPC_INTERNAL_ERROR, strprintf(\"Unable to open database file %s\", path.u8string()));\n+        }\n+\n+        ret = sqlite3_exec(db, \"PRAGMA journal_mode=wal2;\", nullptr, nullptr, nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24952#discussion_r857113355",
      "id" : 857113355,
      "in_reply_to_id" : 857092327,
      "line" : 2397,
      "node_id" : "PRRC_kwDOABII584zFoML",
      "original_commit_id" : "eaa4e63dac2bfd32a6457f6bea1dd3d81b0e77ec",
      "original_line" : 2397,
      "original_position" : 172,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 174,
      "pull_request_review_id" : 951193390,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24952",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857113355/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-24T11:48:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857113355",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/42201?v=4",
         "events_url" : "https://api.github.com/users/prusnak/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prusnak/followers",
         "following_url" : "https://api.github.com/users/prusnak/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prusnak/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prusnak",
         "id" : 42201,
         "login" : "prusnak",
         "node_id" : "MDQ6VXNlcjQyMjAx",
         "organizations_url" : "https://api.github.com/users/prusnak/orgs",
         "received_events_url" : "https://api.github.com/users/prusnak/received_events",
         "repos_url" : "https://api.github.com/users/prusnak/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prusnak/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prusnak/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prusnak"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24952#discussion_r857113983"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24952"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857113983"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah, we don't need/use rollbacks. It's just an export so that makes sense.",
      "commit_id" : "21ee90dda3daed0bc3d7063dfc2118537df08273",
      "created_at" : "2022-04-24T11:48:03Z",
      "diff_hunk" : "@@ -2340,30 +2357,107 @@ UniValue CreateUTXOSnapshot(\n         CHECK_NONFATAL(tip);\n     }\n \n-    LOG_TIME_SECONDS(strprintf(\"writing UTXO snapshot at height %s (%s) to file %s (via %s)\",\n-        tip->nHeight, tip->GetBlockHash().ToString(),\n-        fs::PathToString(path), fs::PathToString(temppath)));\n+    if (is_compact) {\n+        LOG_TIME_SECONDS(strprintf(\"writing UTXO snapshot at height %s (%s) to file %s (via %s)\",\n+                                   tip->nHeight, tip->GetBlockHash().ToString(),\n+                                   fs::PathToString(path), fs::PathToString(temppath)));\n+        SnapshotMetadata metadata{tip->GetBlockHash(), stats.coins_count, tip->nChainTx};\n \n-    SnapshotMetadata metadata{tip->GetBlockHash(), stats.coins_count, tip->nChainTx};\n+        afile << metadata;\n \n-    afile << metadata;\n+        COutPoint key;\n+        Coin coin;\n+        unsigned int iter{0};\n+\n+        while (pcursor->Valid()) {\n+            if (iter % 5000 == 0) node.rpc_interruption_point();\n+            ++iter;\n+            if (pcursor->GetKey(key) && pcursor->GetValue(coin)) {\n+                afile << key;\n+                afile << coin;\n+            }\n \n-    COutPoint key;\n-    Coin coin;\n-    unsigned int iter{0};\n-\n-    while (pcursor->Valid()) {\n-        if (iter % 5000 == 0) node.rpc_interruption_point();\n-        ++iter;\n-        if (pcursor->GetKey(key) && pcursor->GetValue(coin)) {\n-            afile << key;\n-            afile << coin;\n+            pcursor->Next();\n         }\n \n-        pcursor->Next();\n-    }\n+        afile.fclose();\n+    } else {\n+        LOG_TIME_SECONDS(strprintf(\"writing UTXO snapshot at height %s (%s) to sqlite DB file %s\",\n+                                   tip->nHeight, tip->GetBlockHash().ToString(), fs::PathToString(path)));\n+\n+        sqlite3* db;\n+        int ret;\n+\n+        if (!ValidAsCString(path)) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Invalid path\");\n+        }\n+\n+        ret = sqlite3_open(path.c_str(), &db);\n+        if (ret != SQLITE_OK) {\n+            sqlite3_close(db);\n+            throw JSONRPCError(RPC_INTERNAL_ERROR, strprintf(\"Unable to open database file %s\", path.u8string()));\n+        }\n+\n+        ret = sqlite3_exec(db, \"PRAGMA journal_mode=wal2;\", nullptr, nullptr, nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24952#discussion_r857113983",
      "id" : 857113983,
      "in_reply_to_id" : 857092327,
      "line" : 2397,
      "node_id" : "PRRC_kwDOABII584zFoV_",
      "original_commit_id" : "eaa4e63dac2bfd32a6457f6bea1dd3d81b0e77ec",
      "original_line" : 2397,
      "original_position" : 172,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 174,
      "pull_request_review_id" : 951193961,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24952",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857113983/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-24T11:48:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857113983",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3072149?v=4",
         "events_url" : "https://api.github.com/users/dunxen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dunxen/followers",
         "following_url" : "https://api.github.com/users/dunxen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dunxen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dunxen",
         "id" : 3072149,
         "login" : "dunxen",
         "node_id" : "MDQ6VXNlcjMwNzIxNDk=",
         "organizations_url" : "https://api.github.com/users/dunxen/orgs",
         "received_events_url" : "https://api.github.com/users/dunxen/received_events",
         "repos_url" : "https://api.github.com/users/dunxen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dunxen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dunxen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dunxen"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24952#discussion_r857116269"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24952"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857116269"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Forgot to handle the SQLITE_* constants too. Will fix up.",
      "commit_id" : "21ee90dda3daed0bc3d7063dfc2118537df08273",
      "created_at" : "2022-04-24T12:06:27Z",
      "diff_hunk" : "@@ -31,6 +31,7 @@\n #include <rpc/server_util.h>\n #include <rpc/util.h>\n #include <script/descriptor.h>\n+#include <sqlite3.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24952#discussion_r857116269",
      "id" : 857116269,
      "in_reply_to_id" : 857084136,
      "line" : 35,
      "node_id" : "PRRC_kwDOABII584zFo5t",
      "original_commit_id" : "eaa4e63dac2bfd32a6457f6bea1dd3d81b0e77ec",
      "original_line" : 35,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 5,
      "pull_request_review_id" : 951196090,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24952",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857116269/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-24T12:06:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857116269",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3072149?v=4",
         "events_url" : "https://api.github.com/users/dunxen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dunxen/followers",
         "following_url" : "https://api.github.com/users/dunxen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dunxen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dunxen",
         "id" : 3072149,
         "login" : "dunxen",
         "node_id" : "MDQ6VXNlcjMwNzIxNDk=",
         "organizations_url" : "https://api.github.com/users/dunxen/orgs",
         "received_events_url" : "https://api.github.com/users/dunxen/received_events",
         "repos_url" : "https://api.github.com/users/dunxen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dunxen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dunxen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dunxen"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24952#discussion_r857165124"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24952"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857165124"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I see this is now addressed in 84a6e28a8536fdc79796856e36be86a3bffe1848, thanks!",
      "commit_id" : "889f6c719dbd2bca5f38a6a5a89f39fb4639558f",
      "created_at" : "2022-04-24T18:52:45Z",
      "diff_hunk" : "@@ -2340,30 +2357,107 @@ UniValue CreateUTXOSnapshot(\n         CHECK_NONFATAL(tip);\n     }\n \n-    LOG_TIME_SECONDS(strprintf(\"writing UTXO snapshot at height %s (%s) to file %s (via %s)\",\n-        tip->nHeight, tip->GetBlockHash().ToString(),\n-        fs::PathToString(path), fs::PathToString(temppath)));\n+    if (is_compact) {\n+        LOG_TIME_SECONDS(strprintf(\"writing UTXO snapshot at height %s (%s) to file %s (via %s)\",\n+                                   tip->nHeight, tip->GetBlockHash().ToString(),\n+                                   fs::PathToString(path), fs::PathToString(temppath)));\n+        SnapshotMetadata metadata{tip->GetBlockHash(), stats.coins_count, tip->nChainTx};\n \n-    SnapshotMetadata metadata{tip->GetBlockHash(), stats.coins_count, tip->nChainTx};\n+        afile << metadata;\n \n-    afile << metadata;\n+        COutPoint key;\n+        Coin coin;\n+        unsigned int iter{0};\n+\n+        while (pcursor->Valid()) {\n+            if (iter % 5000 == 0) node.rpc_interruption_point();\n+            ++iter;\n+            if (pcursor->GetKey(key) && pcursor->GetValue(coin)) {\n+                afile << key;\n+                afile << coin;\n+            }\n \n-    COutPoint key;\n-    Coin coin;\n-    unsigned int iter{0};\n-\n-    while (pcursor->Valid()) {\n-        if (iter % 5000 == 0) node.rpc_interruption_point();\n-        ++iter;\n-        if (pcursor->GetKey(key) && pcursor->GetValue(coin)) {\n-            afile << key;\n-            afile << coin;\n+            pcursor->Next();\n         }\n \n-        pcursor->Next();\n-    }\n+        afile.fclose();\n+    } else {\n+        LOG_TIME_SECONDS(strprintf(\"writing UTXO snapshot at height %s (%s) to sqlite DB file %s\",\n+                                   tip->nHeight, tip->GetBlockHash().ToString(), fs::PathToString(path)));\n+\n+        sqlite3* db;\n+        int ret;\n+\n+        if (!ValidAsCString(path)) {\n+            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Invalid path\");\n+        }\n+\n+        ret = sqlite3_open(path.c_str(), &db);\n+        if (ret != SQLITE_OK) {\n+            sqlite3_close(db);\n+            throw JSONRPCError(RPC_INTERNAL_ERROR, strprintf(\"Unable to open database file %s\", path.u8string()));\n+        }\n+\n+        ret = sqlite3_exec(db, \"PRAGMA journal_mode=wal2;\", nullptr, nullptr, nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24952#discussion_r857165124",
      "id" : 857165124,
      "in_reply_to_id" : 857092327,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584zF01E",
      "original_commit_id" : "eaa4e63dac2bfd32a6457f6bea1dd3d81b0e77ec",
      "original_line" : 2397,
      "original_position" : 172,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 951238457,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24952",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857165124/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-24T18:52:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857165124",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/42201?v=4",
         "events_url" : "https://api.github.com/users/prusnak/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prusnak/followers",
         "following_url" : "https://api.github.com/users/prusnak/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prusnak/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prusnak",
         "id" : 42201,
         "login" : "prusnak",
         "node_id" : "MDQ6VXNlcjQyMjAx",
         "organizations_url" : "https://api.github.com/users/prusnak/orgs",
         "received_events_url" : "https://api.github.com/users/prusnak/received_events",
         "repos_url" : "https://api.github.com/users/prusnak/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prusnak/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prusnak/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prusnak"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24952#discussion_r857165246"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24952"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857165246"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I see this is now addressed in 84a6e28a8536fdc79796856e36be86a3bffe1848, thanks!",
      "commit_id" : "889f6c719dbd2bca5f38a6a5a89f39fb4639558f",
      "created_at" : "2022-04-24T18:53:42Z",
      "diff_hunk" : "@@ -27,6 +27,7 @@ struct NodeContext;\n } // namespace node\n \n static constexpr int NUM_GETBLOCKSTATS_PERCENTILES = 5;\n+using coinsqlite_cb_t = std::function<std::string(const COutPoint&, const Coin&)>;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24952#discussion_r857165246",
      "id" : 857165246,
      "in_reply_to_id" : 857112165,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584zF02-",
      "original_commit_id" : "21ee90dda3daed0bc3d7063dfc2118537df08273",
      "original_line" : 30,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.h",
      "position" : null,
      "pull_request_review_id" : 951238544,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24952",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 1,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857165246/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-24T18:53:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857165246",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/42201?v=4",
         "events_url" : "https://api.github.com/users/prusnak/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prusnak/followers",
         "following_url" : "https://api.github.com/users/prusnak/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prusnak/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prusnak",
         "id" : 42201,
         "login" : "prusnak",
         "node_id" : "MDQ6VXNlcjQyMjAx",
         "organizations_url" : "https://api.github.com/users/prusnak/orgs",
         "received_events_url" : "https://api.github.com/users/prusnak/received_events",
         "repos_url" : "https://api.github.com/users/prusnak/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prusnak/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prusnak/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prusnak"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24952#discussion_r857165249"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24952"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857165249"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I see this is now addressed in 84a6e28a8536fdc79796856e36be86a3bffe1848, thanks!",
      "commit_id" : "889f6c719dbd2bca5f38a6a5a89f39fb4639558f",
      "created_at" : "2022-04-24T18:53:48Z",
      "diff_hunk" : "@@ -53,6 +54,7 @@ void CalculatePercentilesByWeight(CAmount result[NUM_GETBLOCKSTATS_PERCENTILES],\n  * @return a UniValue map containing metadata about the snapshot.\n  */\n UniValue CreateUTXOSnapshot(\n+    const bool is_compact,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24952#discussion_r857165249",
      "id" : 857165249,
      "in_reply_to_id" : 857112482,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584zF03B",
      "original_commit_id" : "21ee90dda3daed0bc3d7063dfc2118537df08273",
      "original_line" : 57,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.h",
      "position" : null,
      "pull_request_review_id" : 951238549,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24952",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 1,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857165249/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-24T18:53:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857165249",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/42201?v=4",
         "events_url" : "https://api.github.com/users/prusnak/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prusnak/followers",
         "following_url" : "https://api.github.com/users/prusnak/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prusnak/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prusnak",
         "id" : 42201,
         "login" : "prusnak",
         "node_id" : "MDQ6VXNlcjQyMjAx",
         "organizations_url" : "https://api.github.com/users/prusnak/orgs",
         "received_events_url" : "https://api.github.com/users/prusnak/received_events",
         "repos_url" : "https://api.github.com/users/prusnak/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prusnak/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prusnak/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prusnak"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24952#discussion_r857165927"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24952"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857165927"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hmm, sorry. This comment missed my eye. I can revert this. Will push with the Win64 errors I figured out.",
      "commit_id" : "889f6c719dbd2bca5f38a6a5a89f39fb4639558f",
      "created_at" : "2022-04-24T18:59:51Z",
      "diff_hunk" : "@@ -2260,50 +2261,66 @@ static RPCHelpMan dumptxoutset()\n         \"Write the serialized UTXO set to disk.\",\n         {\n             {\"path\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Path to the output file. If relative, will be prefixed by datadir.\"},\n+            {\"format\", RPCArg::Type::STR, RPCArg::Default{\"compact\"}, \"'compact' to output a compact binary serialized format, 'sqlite' to output a SQLite database with table 'txoutset' (requires sqlite3)\", \"format\"},\n         },\n         RPCResult{\n-            RPCResult::Type::OBJ, \"\", \"\",\n-                {\n-                    {RPCResult::Type::NUM, \"coins_written\", \"the number of coins written in the snapshot\"},\n-                    {RPCResult::Type::STR_HEX, \"base_hash\", \"the hash of the base of the snapshot\"},\n-                    {RPCResult::Type::NUM, \"base_height\", \"the height of the base of the snapshot\"},\n-                    {RPCResult::Type::STR, \"path\", \"the absolute path that the snapshot was written to\"},\n-                    {RPCResult::Type::STR_HEX, \"txoutset_hash\", \"the hash of the UTXO set contents\"},\n-                    {RPCResult::Type::NUM, \"nchaintx\", \"the number of transactions in the chain up to and including the base block\"},\n-                }\n-        },\n-        RPCExamples{\n-            HelpExampleCli(\"dumptxoutset\", \"utxo.dat\")\n-        },\n-        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n-{\n-    const ArgsManager& args{EnsureAnyArgsman(request.context)};\n-    const fs::path path = fsbridge::AbsPathJoin(args.GetDataDirNet(), fs::u8path(request.params[0].get_str()));\n-    // Write to a temporary path and then move into `path` on completion\n-    // to avoid confusion due to an interruption.\n-    const fs::path temppath = fsbridge::AbsPathJoin(args.GetDataDirNet(), fs::u8path(request.params[0].get_str() + \".incomplete\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24952#discussion_r857165927",
      "id" : 857165927,
      "in_reply_to_id" : 856872979,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584zF1Bn",
      "original_commit_id" : "eaa4e63dac2bfd32a6457f6bea1dd3d81b0e77ec",
      "original_line" : 2279,
      "original_position" : 34,
      "original_start_line" : 2265,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 951239009,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24952",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857165927/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : "LEFT",
      "updated_at" : "2022-04-24T19:00:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857165927",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3072149?v=4",
         "events_url" : "https://api.github.com/users/dunxen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dunxen/followers",
         "following_url" : "https://api.github.com/users/dunxen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dunxen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dunxen",
         "id" : 3072149,
         "login" : "dunxen",
         "node_id" : "MDQ6VXNlcjMwNzIxNDk=",
         "organizations_url" : "https://api.github.com/users/dunxen/orgs",
         "received_events_url" : "https://api.github.com/users/dunxen/received_events",
         "repos_url" : "https://api.github.com/users/dunxen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dunxen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dunxen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dunxen"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24952#discussion_r857169783"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24952"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857169783"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Reverted formatting. Should be much clearer now :)",
      "commit_id" : "889f6c719dbd2bca5f38a6a5a89f39fb4639558f",
      "created_at" : "2022-04-24T19:35:17Z",
      "diff_hunk" : "@@ -2260,50 +2261,66 @@ static RPCHelpMan dumptxoutset()\n         \"Write the serialized UTXO set to disk.\",\n         {\n             {\"path\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Path to the output file. If relative, will be prefixed by datadir.\"},\n+            {\"format\", RPCArg::Type::STR, RPCArg::Default{\"compact\"}, \"'compact' to output a compact binary serialized format, 'sqlite' to output a SQLite database with table 'txoutset' (requires sqlite3)\", \"format\"},\n         },\n         RPCResult{\n-            RPCResult::Type::OBJ, \"\", \"\",\n-                {\n-                    {RPCResult::Type::NUM, \"coins_written\", \"the number of coins written in the snapshot\"},\n-                    {RPCResult::Type::STR_HEX, \"base_hash\", \"the hash of the base of the snapshot\"},\n-                    {RPCResult::Type::NUM, \"base_height\", \"the height of the base of the snapshot\"},\n-                    {RPCResult::Type::STR, \"path\", \"the absolute path that the snapshot was written to\"},\n-                    {RPCResult::Type::STR_HEX, \"txoutset_hash\", \"the hash of the UTXO set contents\"},\n-                    {RPCResult::Type::NUM, \"nchaintx\", \"the number of transactions in the chain up to and including the base block\"},\n-                }\n-        },\n-        RPCExamples{\n-            HelpExampleCli(\"dumptxoutset\", \"utxo.dat\")\n-        },\n-        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n-{\n-    const ArgsManager& args{EnsureAnyArgsman(request.context)};\n-    const fs::path path = fsbridge::AbsPathJoin(args.GetDataDirNet(), fs::u8path(request.params[0].get_str()));\n-    // Write to a temporary path and then move into `path` on completion\n-    // to avoid confusion due to an interruption.\n-    const fs::path temppath = fsbridge::AbsPathJoin(args.GetDataDirNet(), fs::u8path(request.params[0].get_str() + \".incomplete\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24952#discussion_r857169783",
      "id" : 857169783,
      "in_reply_to_id" : 856872979,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584zF193",
      "original_commit_id" : "eaa4e63dac2bfd32a6457f6bea1dd3d81b0e77ec",
      "original_line" : 2279,
      "original_position" : 34,
      "original_start_line" : 2265,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 951242023,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24952",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857169783/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : "LEFT",
      "updated_at" : "2022-04-24T19:35:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857169783",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3072149?v=4",
         "events_url" : "https://api.github.com/users/dunxen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dunxen/followers",
         "following_url" : "https://api.github.com/users/dunxen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dunxen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dunxen",
         "id" : 3072149,
         "login" : "dunxen",
         "node_id" : "MDQ6VXNlcjMwNzIxNDk=",
         "organizations_url" : "https://api.github.com/users/dunxen/orgs",
         "received_events_url" : "https://api.github.com/users/dunxen/received_events",
         "repos_url" : "https://api.github.com/users/dunxen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dunxen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dunxen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dunxen"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24952#discussion_r857179874"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24952"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857179874"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think wal2 is a hangover from a previous version here",
      "commit_id" : "889f6c719dbd2bca5f38a6a5a89f39fb4639558f",
      "created_at" : "2022-04-24T21:12:38Z",
      "diff_hunk" : "@@ -2334,30 +2362,117 @@ UniValue CreateUTXOSnapshot(\n         tip = CHECK_NONFATAL(chainstate.m_blockman.LookupBlockIndex(stats.hashBlock));\n     }\n \n-    LOG_TIME_SECONDS(strprintf(\"writing UTXO snapshot at height %s (%s) to file %s (via %s)\",\n-        tip->nHeight, tip->GetBlockHash().ToString(),\n-        fs::PathToString(path), fs::PathToString(temppath)));\n-\n-    SnapshotMetadata metadata{tip->GetBlockHash(), stats.coins_count, tip->nChainTx};\n+    switch (format) {\n+    case UTXOSnapshotFormat::COMPACT:\n+        {\n+            LOG_TIME_SECONDS(strprintf(\"writing UTXO snapshot at height %s (%s) to file %s (via %s)\",\n+                                    tip->nHeight, tip->GetBlockHash().ToString(),\n+                                    fs::PathToString(path), fs::PathToString(temppath)));\n+            SnapshotMetadata metadata{tip->GetBlockHash(), stats.coins_count, tip->nChainTx};\n+\n+            afile << metadata;\n+\n+            COutPoint key;\n+            Coin coin;\n+            unsigned int iter{0};\n+\n+            while (pcursor->Valid()) {\n+                if (iter % 5000 == 0) node.rpc_interruption_point();\n+                ++iter;\n+                if (pcursor->GetKey(key) && pcursor->GetValue(coin)) {\n+                    afile << key;\n+                    afile << coin;\n+                }\n \n-    afile << metadata;\n+                pcursor->Next();\n+            }\n \n-    COutPoint key;\n-    Coin coin;\n-    unsigned int iter{0};\n-\n-    while (pcursor->Valid()) {\n-        if (iter % 5000 == 0) node.rpc_interruption_point();\n-        ++iter;\n-        if (pcursor->GetKey(key) && pcursor->GetValue(coin)) {\n-            afile << key;\n-            afile << coin;\n+            afile.fclose();\n+            break;\n         }\n+    case UTXOSnapshotFormat::SQLITE:\n+        {\n+#ifdef USE_SQLITE\n+            LOG_TIME_SECONDS(strprintf(\"writing UTXO snapshot at height %s (%s) to sqlite DB file %s\",\n+                                    tip->nHeight, tip->GetBlockHash().ToString(), fs::PathToString(path)));\n \n-        pcursor->Next();\n-    }\n+            sqlite3* db;\n+            int ret;\n+\n+            if (!ValidAsCString(fs::PathToString(path))) {\n+                throw JSONRPCError(RPC_INVALID_PARAMETER, \"Invalid path\");\n+            }\n+\n+            ret = sqlite3_open(fs::PathToString(path).c_str(), &db);\n+            if (ret != SQLITE_OK) {\n+                sqlite3_close(db);\n+                throw JSONRPCError(RPC_INTERNAL_ERROR, strprintf(\"Unable to open database file %s\", path.u8string()));\n+            }\n \n-    afile.fclose();\n+            // We have no need for rollbacks here, so we can set the `journal_mode` to 'off'. See: https://www.sqlite.org/pragma.html#pragma_journal_mode\n+            ret = sqlite3_exec(db, \"PRAGMA journal_mode=off;\", nullptr, nullptr, nullptr);\n+            if (ret != SQLITE_OK) {\n+                throw std::runtime_error(strprintf(\"SQLiteDatabase: Failed to set wal2: %s\\n\", sqlite3_errstr(ret)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24952#discussion_r857179874",
      "id" : 857179874,
      "line" : 2415,
      "node_id" : "PRRC_kwDOABII584zF4bi",
      "original_commit_id" : "889f6c719dbd2bca5f38a6a5a89f39fb4639558f",
      "original_line" : 2415,
      "original_position" : 147,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 147,
      "pull_request_review_id" : 951249602,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24952",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857179874/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-24T21:38:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857179874",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24952#discussion_r857180920"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24952"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857180920"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "curious why we don't use the temppath for sqlite like we do on compact?",
      "commit_id" : "889f6c719dbd2bca5f38a6a5a89f39fb4639558f",
      "created_at" : "2022-04-24T21:24:41Z",
      "diff_hunk" : "@@ -2289,8 +2308,16 @@ static RPCHelpMan dumptxoutset()\n     CAutoFile afile{file, SER_DISK, CLIENT_VERSION};\n     NodeContext& node = EnsureAnyNodeContext(request.context);\n     UniValue result = CreateUTXOSnapshot(\n-        node, node.chainman->ActiveChainstate(), afile, path, temppath);\n-    fs::rename(temppath, path);\n+        format, node, node.chainman->ActiveChainstate(), afile, path, temppath);\n+\n+    switch (format) {\n+    case UTXOSnapshotFormat::COMPACT:\n+        fs::rename(temppath, path);\n+        break;\n+    case UTXOSnapshotFormat::SQLITE:\n+        fs::remove(temppath);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24952#discussion_r857180920",
      "id" : 857180920,
      "line" : 2318,
      "node_id" : "PRRC_kwDOABII584zF4r4",
      "original_commit_id" : "889f6c719dbd2bca5f38a6a5a89f39fb4639558f",
      "original_line" : 2318,
      "original_position" : 60,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 60,
      "pull_request_review_id" : 951249602,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24952",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857180920/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-24T21:38:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/857180920",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   }
]
