[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24946#discussion_r856437477"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/856437477"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Maybe add a comment that loop unrolling was done for performance reasons?",
      "commit_id" : "4f3a18906880b065b6119ccf32b2875748b297b2",
      "created_at" : "2022-04-22T17:28:58Z",
      "diff_hunk" : "@@ -119,16 +119,97 @@ void ChaCha20::Keystream(unsigned char* c, size_t bytes)\n         x13 = j13;\n         x14 = j14;\n         x15 = j15;\n-        for (i = 20;i > 0;i -= 2) {\n-            QUARTERROUND( x0, x4, x8,x12)\n-            QUARTERROUND( x1, x5, x9,x13)\n-            QUARTERROUND( x2, x6,x10,x14)\n-            QUARTERROUND( x3, x7,x11,x15)\n-            QUARTERROUND( x0, x5,x10,x15)\n-            QUARTERROUND( x1, x6,x11,x12)\n-            QUARTERROUND( x2, x7, x8,x13)\n-            QUARTERROUND( x3, x4, x9,x14)\n-        }\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24946#discussion_r856437477",
      "id" : 856437477,
      "line" : 122,
      "node_id" : "PRRC_kwDOABII584zDDLl",
      "original_commit_id" : "7f3f84c8336fc0232322a550264a9bddb6b362fe",
      "original_line" : 122,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/crypto/chacha20.cpp",
      "position" : 14,
      "pull_request_review_id" : 950388839,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24946",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/856437477/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-22T17:28:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/856437477",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4500994?v=4",
         "events_url" : "https://api.github.com/users/kristapsk/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kristapsk/followers",
         "following_url" : "https://api.github.com/users/kristapsk/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kristapsk/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kristapsk",
         "id" : 4500994,
         "login" : "kristapsk",
         "node_id" : "MDQ6VXNlcjQ1MDA5OTQ=",
         "organizations_url" : "https://api.github.com/users/kristapsk/orgs",
         "received_events_url" : "https://api.github.com/users/kristapsk/received_events",
         "repos_url" : "https://api.github.com/users/kristapsk/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kristapsk/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kristapsk/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kristapsk"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK, I see `./src/bench/bench_bitcoin` improvements with this change.",
      "created_at" : "2022-04-22T17:30:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24946#issuecomment-1106719112",
      "id" : 1106719112,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24946",
      "node_id" : "IC_kwDOABII585B9zGI",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1106719112/reactions"
      },
      "updated_at" : "2022-04-22T17:30:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1106719112",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4500994?v=4",
         "events_url" : "https://api.github.com/users/kristapsk/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kristapsk/followers",
         "following_url" : "https://api.github.com/users/kristapsk/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kristapsk/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kristapsk",
         "id" : 4500994,
         "login" : "kristapsk",
         "node_id" : "MDQ6VXNlcjQ1MDA5OTQ=",
         "organizations_url" : "https://api.github.com/users/kristapsk/orgs",
         "received_events_url" : "https://api.github.com/users/kristapsk/received_events",
         "repos_url" : "https://api.github.com/users/kristapsk/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kristapsk/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kristapsk/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kristapsk"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Can you give commands to run just those benches for those willing to replicate?",
      "created_at" : "2022-04-22T17:58:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24946#issuecomment-1106738510",
      "id" : 1106738510,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24946",
      "node_id" : "IC_kwDOABII585B931O",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1106738510/reactions"
      },
      "updated_at" : "2022-04-22T17:58:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1106738510",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@instagibbs \r\n\r\n`./src/bench/bench_bitcoin -filter=.*CHACHA20_[1-9].*`",
      "created_at" : "2022-04-22T17:59:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24946#issuecomment-1106739162",
      "id" : 1106739162,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24946",
      "node_id" : "IC_kwDOABII585B93_a",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 1,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1106739162/reactions"
      },
      "updated_at" : "2022-04-22T18:00:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1106739162",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24946#discussion_r856460691"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24946"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/856460691"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "4f3a18906880b065b6119ccf32b2875748b297b2",
      "created_at" : "2022-04-22T18:01:08Z",
      "diff_hunk" : "@@ -119,16 +119,97 @@ void ChaCha20::Keystream(unsigned char* c, size_t bytes)\n         x13 = j13;\n         x14 = j14;\n         x15 = j15;\n-        for (i = 20;i > 0;i -= 2) {\n-            QUARTERROUND( x0, x4, x8,x12)\n-            QUARTERROUND( x1, x5, x9,x13)\n-            QUARTERROUND( x2, x6,x10,x14)\n-            QUARTERROUND( x3, x7,x11,x15)\n-            QUARTERROUND( x0, x5,x10,x15)\n-            QUARTERROUND( x1, x6,x11,x12)\n-            QUARTERROUND( x2, x7, x8,x13)\n-            QUARTERROUND( x3, x4, x9,x14)\n-        }\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24946#discussion_r856460691",
      "id" : 856460691,
      "in_reply_to_id" : 856437477,
      "line" : 122,
      "node_id" : "PRRC_kwDOABII584zDI2T",
      "original_commit_id" : "7f3f84c8336fc0232322a550264a9bddb6b362fe",
      "original_line" : 122,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/crypto/chacha20.cpp",
      "position" : 14,
      "pull_request_review_id" : 950421154,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24946",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/856460691/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-22T18:01:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/856460691",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I'm somewhat surprised unrolling a loop that is ~~20~~ 10 times the same thing gives that much performance win on modern CPUs. But it's just a few ROL instructions I guess so the loop overhead easily dominates? Anyhow, concept ACK.",
      "created_at" : "2022-04-22T18:40:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24946#issuecomment-1106766492",
      "id" : 1106766492,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24946",
      "node_id" : "IC_kwDOABII585B9-qc",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1106766492/reactions"
      },
      "updated_at" : "2022-04-23T09:31:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1106766492",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Getting a rough average of 15% speedup as well",
      "created_at" : "2022-04-22T18:42:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24946#issuecomment-1106768251",
      "id" : 1106768251,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24946",
      "node_id" : "IC_kwDOABII585B9_F7",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1106768251/reactions"
      },
      "updated_at" : "2022-04-22T18:42:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1106768251",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@laanwj It may also have to do with better register scheduling when unrolling (the same variable doesn't need to stay in the same register every iteration), though I haven't investigated what the difference in emitted asm is.\n\nThis change may be very compiler and platform dependent, so it may be good to know what its impact is with modern clang versions and/or on arm64 systems.",
      "created_at" : "2022-04-22T18:53:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24946#issuecomment-1106774838",
      "id" : 1106774838,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24946",
      "node_id" : "IC_kwDOABII585B-As2",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1106774838/reactions"
      },
      "updated_at" : "2022-04-22T18:53:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1106774838",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Debian testing clang 15, normal (non-debug) build, fixed CPU speed, I'm not sure I'm seeing a difference. Trying again after optimizing and tuning further. ",
      "created_at" : "2022-04-22T19:29:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24946#issuecomment-1106798206",
      "id" : 1106798206,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24946",
      "node_id" : "IC_kwDOABII585B-GZ-",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1106798206/reactions"
      },
      "updated_at" : "2022-04-22T19:29:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1106798206",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Gcc 11.2.0, x86_64:\r\n- The function `ChaCha20::Keystream` grows in size from 992 bytes to 3840 (doesn't seem too bad, still fits in a page).\r\n- One iteration of the loop looks like:\r\n```\r\n 370:\t41 01 ed             \tadd    %ebp,%r13d\r\n 373:\t41 01 db             \tadd    %ebx,%r11d\r\n 376:\t41 01 f2             \tadd    %esi,%r10d\r\n 379:\t44 31 e9             \txor    %r13d,%ecx\r\n 37c:\t44 31 da             \txor    %r11d,%edx\r\n 37f:\t44 31 d0             \txor    %r10d,%eax\r\n 382:\tc1 c1 10             \trol    $0x10,%ecx\r\n 385:\tc1 c2 10             \trol    $0x10,%edx\r\n 388:\t41 01 c9             \tadd    %ecx,%r9d\r\n 38b:\t01 d7                \tadd    %edx,%edi\r\n 38d:\tc1 c0 10             \trol    $0x10,%eax\r\n 390:\t44 31 cd             \txor    %r9d,%ebp\r\n 393:\t31 fb                \txor    %edi,%ebx\r\n 395:\t41 01 c4             \tadd    %eax,%r12d\r\n 398:\tc1 c5 0c             \trol    $0xc,%ebp\r\n 39b:\tc1 c3 0c             \trol    $0xc,%ebx\r\n 39e:\t44 31 e6             \txor    %r12d,%esi\r\n 3a1:\t41 01 ed             \tadd    %ebp,%r13d\r\n 3a4:\t41 01 db             \tadd    %ebx,%r11d\r\n 3a7:\tc1 c6 0c             \trol    $0xc,%esi\r\n 3aa:\t44 31 e9             \txor    %r13d,%ecx\r\n 3ad:\t44 31 da             \txor    %r11d,%edx\r\n 3b0:\t41 01 f2             \tadd    %esi,%r10d\r\n 3b3:\tc1 c1 08             \trol    $0x8,%ecx\r\n 3b6:\tc1 c2 08             \trol    $0x8,%edx\r\n 3b9:\t44 31 d0             \txor    %r10d,%eax\r\n 3bc:\t41 01 c9             \tadd    %ecx,%r9d\r\n 3bf:\t01 d7                \tadd    %edx,%edi\r\n 3c1:\t44 31 cd             \txor    %r9d,%ebp\r\n 3c4:\t31 fb                \txor    %edi,%ebx\r\n 3c6:\t89 7c 24 08          \tmov    %edi,0x8(%rsp)\r\n 3ca:\tc1 c5 07             \trol    $0x7,%ebp\r\n 3cd:\tc1 c3 07             \trol    $0x7,%ebx\r\n 3d0:\t44 89 4c 24 04       \tmov    %r9d,0x4(%rsp)\r\n 3d5:\tc1 c0 08             \trol    $0x8,%eax\r\n 3d8:\t45 01 f8             \tadd    %r15d,%r8d\r\n 3db:\t41 01 dd             \tadd    %ebx,%r13d\r\n 3de:\t45 31 c6             \txor    %r8d,%r14d\r\n 3e1:\t41 01 c4             \tadd    %eax,%r12d\r\n 3e4:\t44 89 f7             \tmov    %r14d,%edi\r\n 3e7:\t44 8b 74 24 0c       \tmov    0xc(%rsp),%r14d\r\n 3ec:\t44 31 e6             \txor    %r12d,%esi\r\n 3ef:\tc1 c7 10             \trol    $0x10,%edi\r\n 3f2:\tc1 c6 07             \trol    $0x7,%esi\r\n 3f5:\t41 01 fe             \tadd    %edi,%r14d\r\n 3f8:\t41 01 f3             \tadd    %esi,%r11d\r\n 3fb:\t45 31 f7             \txor    %r14d,%r15d\r\n 3fe:\t45 89 f1             \tmov    %r14d,%r9d\r\n 401:\t44 31 d9             \txor    %r11d,%ecx\r\n 404:\t41 c1 c7 0c          \trol    $0xc,%r15d\r\n 408:\tc1 c1 10             \trol    $0x10,%ecx\r\n 40b:\t45 01 f8             \tadd    %r15d,%r8d\r\n 40e:\t44 31 c7             \txor    %r8d,%edi\r\n 411:\tc1 c7 08             \trol    $0x8,%edi\r\n 414:\t41 01 f9             \tadd    %edi,%r9d\r\n 417:\t44 31 ef             \txor    %r13d,%edi\r\n 41a:\tc1 c7 10             \trol    $0x10,%edi\r\n 41d:\t45 31 cf             \txor    %r9d,%r15d\r\n 420:\t41 01 c9             \tadd    %ecx,%r9d\r\n 423:\t41 01 fc             \tadd    %edi,%r12d\r\n 426:\t41 c1 c7 07          \trol    $0x7,%r15d\r\n 42a:\t44 31 e3             \txor    %r12d,%ebx\r\n 42d:\tc1 c3 0c             \trol    $0xc,%ebx\r\n 430:\t41 01 dd             \tadd    %ebx,%r13d\r\n 433:\t44 31 ef             \txor    %r13d,%edi\r\n 436:\t41 89 fe             \tmov    %edi,%r14d\r\n 439:\t41 c1 c6 08          \trol    $0x8,%r14d\r\n 43d:\t45 01 f4             \tadd    %r14d,%r12d\r\n 440:\t44 31 e3             \txor    %r12d,%ebx\r\n 443:\tc1 c3 07             \trol    $0x7,%ebx\r\n 446:\t44 31 ce             \txor    %r9d,%esi\r\n 449:\t45 01 fa             \tadd    %r15d,%r10d\r\n 44c:\t41 01 e8             \tadd    %ebp,%r8d\r\n 44f:\tc1 c6 0c             \trol    $0xc,%esi\r\n 452:\t44 31 d2             \txor    %r10d,%edx\r\n 455:\t44 31 c0             \txor    %r8d,%eax\r\n 458:\tc1 c2 10             \trol    $0x10,%edx\r\n 45b:\t41 01 f3             \tadd    %esi,%r11d\r\n 45e:\tc1 c0 10             \trol    $0x10,%eax\r\n 461:\t44 31 d9             \txor    %r11d,%ecx\r\n 464:\tc1 c1 08             \trol    $0x8,%ecx\r\n 467:\t41 8d 3c 09          \tlea    (%r9,%rcx,1),%edi\r\n 46b:\t44 8b 4c 24 04       \tmov    0x4(%rsp),%r9d\r\n 470:\t31 fe                \txor    %edi,%esi\r\n 472:\t89 7c 24 0c          \tmov    %edi,0xc(%rsp)\r\n 476:\t8b 7c 24 08          \tmov    0x8(%rsp),%edi\r\n 47a:\t41 01 d1             \tadd    %edx,%r9d\r\n 47d:\tc1 c6 07             \trol    $0x7,%esi\r\n 480:\t01 c7                \tadd    %eax,%edi\r\n 482:\t45 31 cf             \txor    %r9d,%r15d\r\n 485:\t31 fd                \txor    %edi,%ebp\r\n 487:\t41 c1 c7 0c          \trol    $0xc,%r15d\r\n 48b:\tc1 c5 0c             \trol    $0xc,%ebp\r\n 48e:\t45 01 fa             \tadd    %r15d,%r10d\r\n 491:\t41 01 e8             \tadd    %ebp,%r8d\r\n 494:\t44 31 d2             \txor    %r10d,%edx\r\n 497:\t44 31 c0             \txor    %r8d,%eax\r\n 49a:\tc1 c2 08             \trol    $0x8,%edx\r\n 49d:\tc1 c0 08             \trol    $0x8,%eax\r\n 4a0:\t41 01 d1             \tadd    %edx,%r9d\r\n 4a3:\t01 c7                \tadd    %eax,%edi\r\n 4a5:\t45 31 cf             \txor    %r9d,%r15d\r\n 4a8:\t31 fd                \txor    %edi,%ebp\r\n 4aa:\t41 c1 c7 07          \trol    $0x7,%r15d\r\n 4ae:\tc1 c5 07             \trol    $0x7,%ebp\r\n 4b1:\t83 6c 24 10 01       \tsubl   $0x1,0x10(%rsp)\r\n 4b6:\t0f 85 b4 fe ff ff    \tjne    370 <ChaCha20::Keystream(unsigned char*, unsigned long)+0x140>\r\n```\r\n- The unrolling indeed causes different register allocation, as well as instructions from multiple iterations to be interspersed (maybe better for scheduling, maybe it's possible to combine?).\r\n- Benchmarks before on old AMD Phenom(tm) II X6 1075T:\r\n```\r\n|             ns/byte |              byte/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|                2.18 |      459,187,395.75 |    0.3% |      0.03 | `CHACHA20_1MB`\r\n|                2.21 |      452,155,530.63 |    0.2% |      0.01 | `CHACHA20_256BYTES`\r\n|                2.34 |      427,257,435.31 |    0.0% |      0.01 | `CHACHA20_64BYTES`\r\n```\r\n- Benchmarks after on same (~12% speedup):\r\n```\r\n|             ns/byte |              byte/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|                1.91 |      523,324,820.67 |    0.4% |      0.02 | `CHACHA20_1MB`\r\n|                1.94 |      516,638,576.63 |    0.0% |      0.01 | `CHACHA20_256BYTES`\r\n|                2.22 |      451,258,216.13 |    4.6% |      0.01 | `CHACHA20_64BYTES`\r\n```",
      "created_at" : "2022-04-22T20:24:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24946#issuecomment-1106832390",
      "id" : 1106832390,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24946",
      "node_id" : "IC_kwDOABII585B-OwG",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1106832390/reactions"
      },
      "updated_at" : "2022-04-22T20:24:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1106832390",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Restarted and tuned (i7 6500U CPU @ 2.5 GHz) with `pyperf system tune`, non-debug build, seeing roughly a 3 to 4% improvement.\r\n```\r\nLinux 5.16.0-6-amd64 #1 SMP PREEMPT Debian 5.16.18-1 (2022-03-29) x86_64 GNU/Linux.\r\n\r\nDebian clang version 15.0.0-++20220422111431+ba46ae7bd853-1~exp1~20220422111525.449\r\nTarget: x86_64-pc-linux-gnu                                    \r\nThread model: posix                                            \r\nInstalledDir: /usr/bin      \r\n```\r\n\r\n```\r\nmaster\r\n\r\n|             ns/byte |              byte/s |    err% |        ins/byte |        cyc/byte |    IPC |       bra/byte |   miss% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------------:|----------------:|-------:|---------------:|--------:|----------:|:----------\r\n|                2.43 |      410,814,309.33 |    0.3% |           18.61 |            6.29 |  2.957 |           0.20 |    0.0% |      0.03 | `CHACHA20_1MB`\r\n|                2.46 |      406,907,108.96 |    0.0% |           18.89 |            6.37 |  2.965 |           0.22 |    0.0% |      0.01 | `CHACHA20_256BYTES`\r\n|                2.59 |      385,499,110.76 |    1.0% |           19.72 |            6.68 |  2.952 |           0.28 |    0.0% |      0.01 | `CHACHA20_64BYTES`\r\n```\r\n```\r\nbranch\r\n\r\n|             ns/byte |              byte/s |    err% |        ins/byte |        cyc/byte |    IPC |       bra/byte |   miss% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------------:|----------------:|-------:|---------------:|--------:|----------:|:----------\r\n|                2.35 |      425,969,024.53 |    0.7% |           16.70 |            6.07 |  2.752 |           0.05 |    0.0% |      0.03 | `CHACHA20_1MB`\r\n|                2.37 |      422,279,272.14 |    0.0% |           17.14 |            6.14 |  2.792 |           0.07 |    0.0% |      0.01 | `CHACHA20_256BYTES`\r\n|                2.52 |      396,803,365.77 |    0.1% |           18.45 |            6.53 |  2.825 |           0.13 |    0.0% |      0.01 | `CHACHA20_64BYTES`\r\n```\r\n\r\nEdit: re-ran the bench a dozen times each to verify that these results are representative.",
      "created_at" : "2022-04-22T21:30:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24946#issuecomment-1106883876",
      "id" : 1106883876,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24946",
      "node_id" : "IC_kwDOABII585B-bUk",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1106883876/reactions"
      },
      "updated_at" : "2022-04-23T08:53:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1106883876",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm seeing much smaller improvements (0%-2.5% with gcc 11; 1.3%-7% with clang 13) on an old i7. (And very slightly worse performance compared to master with debug enabled)\r\n\r\nDid you consider just changing the `for() { ... }` loop to `REPEAT10( ... )` with `#define REPEAT10(a) a a   a a   a a   a a   a a` ?",
      "created_at" : "2022-04-23T08:50:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24946#issuecomment-1107435965",
      "id" : 1107435965,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24946",
      "node_id" : "IC_kwDOABII585CAiG9",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1107435965/reactions"
      },
      "updated_at" : "2022-04-23T08:50:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1107435965",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "- gcc 11.2.0, RISC-V 64-bit (SiFive Unmatched, 1.2Ghz): speedup is there, but much less pronounced (~5%):\r\n```\r\n|             ns/byte |              byte/s |    err% |        ins/byte |        cyc/byte |       bra/byte |   miss% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------------:|----------------:|---------------:|--------:|----------:|:----------\r\nBefore:\r\n|               22.29 |       44,862,631.89 |    0.8% |            0.00 |            0.00 |           0.00 |    0.0% |      0.26 | `CHACHA20_1MB`\r\nAfter:\r\n|               21.23 |       47,101,646.21 |    0.9% |            0.00 |            0.00 |           0.00 |    0.0% |      0.25 | `CHACHA20_1MB`\r\n```\r\n\r\n- gcc 10.2.1, aarch64 (custom i.MX8MQ board, 1Ghz), ~8% speedup:\r\n```\r\n|             ns/byte |              byte/s |    err% |        ins/byte |       bra/byte |   miss% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------------:|---------------:|--------:|----------:|:----------\r\nBefore:\r\n|                6.04 |      165,526,246.91 |    0.1% |           16.84 |           0.16 |   11.8% |      0.07 | `CHACHA20_1MB`\r\nAfter:\r\n|                5.58 |      179,185,196.22 |    0.1% |           15.86 |           0.02 |    0.0% |      0.06 | `CHACHA20_1MB`\r\n```\r\n\r\nIt's a nice speedup, and a simple change, tested ACK 4f3a18906880b065b6119ccf32b2875748b297b2\r\n\r\n> Did you consider just changing the for() { ... } loop to REPEAT10( ... ) with #define REPEAT10(a) a a a a a a a a a a ?\r\n\r\nI like this idea, more elegantly than copy/pasting it makes it immediately clear it's the same. I would guess the generated code is exactly the same.",
      "created_at" : "2022-04-23T09:50:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24946#issuecomment-1107443761",
      "id" : 1107443761,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24946",
      "node_id" : "IC_kwDOABII585CAkAx",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1107443761/reactions"
      },
      "updated_at" : "2022-04-23T11:34:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1107443761",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Not seeing a large difference on an i7. (Maybe a 1%-3% speedup?)\r\n\r\ngcc-12 Before:\r\n\r\n```\r\n|             ns/byte |              byte/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|                2.23 |      447,617,214.06 |    0.2% |      0.03 | `CHACHA20_1MB`\r\n|                2.26 |      441,653,947.12 |    0.1% |      0.01 | `CHACHA20_256BYTES`\r\n|                2.50 |      399,993,391.82 |    6.1% |      0.01 | :wavy_dash: `CHACHA20_64BYTES` (Unstable with ~6,241.4 iters. Increase `minEpochIterations` to e.g. 62414)\r\n|                7.03 |      142,173,319.29 |   10.1% |      0.09 | :wavy_dash: `CHACHA20_POLY1305_AEAD_1MB_ENCRYPT_DECRYPT` (Unstable with ~1.0 iters. Increase `minEpochIterations` to e.g. 10)\r\n|                3.26 |      307,218,931.17 |    1.7% |      0.04 | `CHACHA20_POLY1305_AEAD_1MB_ONLY_ENCRYPT`\r\n|                8.83 |      113,259,198.67 |    1.3% |      0.01 | `CHACHA20_POLY1305_AEAD_256BYTES_ENCRYPT_DECRYPT`\r\n|                4.28 |      233,685,573.34 |    0.4% |      0.01 | `CHACHA20_POLY1305_AEAD_256BYTES_ONLY_ENCRYPT`\r\n|               15.78 |       63,391,055.77 |    0.6% |      0.01 | `CHACHA20_POLY1305_AEAD_64BYTES_ENCRYPT_DECRYPT`\r\n|                7.71 |      129,684,901.52 |    0.4% |      0.01 | `CHACHA20_POLY1305_AEAD_64BYTES_ONLY_ENCRYPT`\r\n```\r\n\r\ngcc-12 After:\r\n\r\n```\r\n|             ns/byte |              byte/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|                2.20 |      454,707,913.08 |    0.8% |      0.03 | `CHACHA20_1MB`\r\n|                2.36 |      424,359,263.25 |    4.9% |      0.01 | `CHACHA20_256BYTES`\r\n|                2.41 |      414,622,602.59 |    0.4% |      0.01 | `CHACHA20_64BYTES`\r\n|                6.99 |      143,089,808.99 |    7.2% |      0.09 | :wavy_dash: `CHACHA20_POLY1305_AEAD_1MB_ENCRYPT_DECRYPT` (Unstable with ~1.0 iters. Increase `minEpochIterations` to e.g. 10)\r\n|                3.26 |      306,926,493.73 |    4.2% |      0.04 | `CHACHA20_POLY1305_AEAD_1MB_ONLY_ENCRYPT`\r\n|                9.59 |      104,251,645.58 |    8.6% |      0.01 | :wavy_dash: `CHACHA20_POLY1305_AEAD_256BYTES_ENCRYPT_DECRYPT` (Unstable with ~402.1 iters. Increase `minEpochIterations` to e.g. 4021)\r\n|                4.33 |      230,986,007.33 |    0.6% |      0.01 | `CHACHA20_POLY1305_AEAD_256BYTES_ONLY_ENCRYPT`\r\n|               16.23 |       61,602,235.65 |    1.7% |      0.01 | `CHACHA20_POLY1305_AEAD_64BYTES_ENCRYPT_DECRYPT`\r\n|                9.63 |      103,830,365.13 |    9.9% |      0.01 | :wavy_dash: `CHACHA20_POLY1305_AEAD_64BYTES_ONLY_ENCRYPT` (Unstable with ~1,639.9 iters. Increase `minEpochIterations` to e.g. 16399)\r\n\r\n```\r\n\r\ngcc-10 Before:\r\n\r\n```\r\n|             ns/byte |              byte/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|                2.26 |      442,527,877.02 |    0.5% |      0.03 | `CHACHA20_1MB`\r\n|                2.30 |      435,535,172.72 |    1.9% |      0.01 | `CHACHA20_256BYTES`\r\n|                2.39 |      418,262,709.74 |    0.4% |      0.01 | `CHACHA20_64BYTES`\r\n|                6.93 |      144,210,951.65 |    5.9% |      0.09 | :wavy_dash: `CHACHA20_POLY1305_AEAD_1MB_ENCRYPT_DECRYPT` (Unstable with ~1.0 iters. Increase `minEpochIterations` to e.g. 10)\r\n|                3.16 |      316,109,217.24 |    4.8% |      0.04 | `CHACHA20_POLY1305_AEAD_1MB_ONLY_ENCRYPT`\r\n|                8.43 |      118,625,079.49 |    0.3% |      0.01 | `CHACHA20_POLY1305_AEAD_256BYTES_ENCRYPT_DECRYPT`\r\n|                4.18 |      239,143,934.28 |    0.2% |      0.01 | `CHACHA20_POLY1305_AEAD_256BYTES_ONLY_ENCRYPT`\r\n|               16.05 |       62,308,156.96 |    5.2% |      0.01 | :wavy_dash: `CHACHA20_POLY1305_AEAD_64BYTES_ENCRYPT_DECRYPT` (Unstable with ~961.0 iters. Increase `minEpochIterations` to e.g. 9610)\r\n|                7.63 |      131,070,821.81 |    0.1% |      0.01 | `CHACHA20_POLY1305_AEAD_64BYTES_ONLY_ENCRYPT`\r\n```\r\n\r\ngcc-10 after:\r\n\r\n```\r\n|             ns/byte |              byte/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|                2.20 |      454,351,689.08 |    0.2% |      0.03 | `CHACHA20_1MB`\r\n|                2.40 |      416,825,911.73 |    4.4% |      0.01 | `CHACHA20_256BYTES`\r\n|                2.40 |      416,369,054.39 |    0.2% |      0.01 | `CHACHA20_64BYTES`\r\n|                6.58 |      151,882,394.04 |   10.5% |      0.08 | :wavy_dash: `CHACHA20_POLY1305_AEAD_1MB_ENCRYPT_DECRYPT` (Unstable with ~1.0 iters. Increase `minEpochIterations` to e.g. 10)\r\n|                3.03 |      329,600,644.76 |    0.9% |      0.04 | `CHACHA20_POLY1305_AEAD_1MB_ONLY_ENCRYPT`\r\n|                9.40 |      106,431,172.41 |   10.1% |      0.01 | :wavy_dash: `CHACHA20_POLY1305_AEAD_256BYTES_ENCRYPT_DECRYPT` (Unstable with ~434.9 iters. Increase `minEpochIterations` to e.g. 4349)\r\n|                4.30 |      232,776,146.25 |    0.2% |      0.01 | `CHACHA20_POLY1305_AEAD_256BYTES_ONLY_ENCRYPT`\r\n|               16.17 |       61,831,918.45 |    1.3% |      0.01 | `CHACHA20_POLY1305_AEAD_64BYTES_ENCRYPT_DECRYPT`\r\n|                8.83 |      113,301,205.50 |    5.8% |      0.01 | :wavy_dash: `CHACHA20_POLY1305_AEAD_64BYTES_ONLY_ENCRYPT` (Unstable with ~1,771.5 iters. Increase `minEpochIterations` to e.g. 17715)\r\n```",
      "created_at" : "2022-04-23T17:10:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24946#issuecomment-1107536111",
      "id" : 1107536111,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24946",
      "node_id" : "IC_kwDOABII585CA6jv",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1107536111/reactions"
      },
      "updated_at" : "2022-04-23T17:10:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1107536111",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I get the same 1-3% speedup on my i7. In my test adding `#pragma GCC unroll 10` in front of the loop seems to produce exactly the same unrolled loop as the hand coded, this works for GCC and clang\r\n\r\nSide note 1: use e.g. `./src/bench/bench_bitcoin -filter=\"CHACHA20.*\" -min_time=2000` to run each test for 2 seconds to get more stable results\r\n\r\nSide note 2: No need to quote the result, it's markdown :slightly_smiling_face: \r\n\r\nMy results on i7-8700, with clang 13.0.1:\r\n\r\nmaster\r\n|             ns/byte |              byte/s |    err% |        ins/byte |        cyc/byte |    IPC |       bra/byte |   miss% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------------:|----------------:|-------:|---------------:|--------:|----------:|:----------\r\n|                1.91 |      523,770,793.06 |    0.1% |           18.52 |            6.08 |  3.043 |           0.20 |    0.0% |      1.09 | `CHACHA20_1MB`\r\n|                1.94 |      515,227,758.97 |    0.3% |           18.79 |            6.16 |  3.048 |           0.22 |    0.0% |      1.10 | `CHACHA20_256BYTES`\r\n|                2.02 |      494,527,885.82 |    0.2% |           19.61 |            6.44 |  3.046 |           0.28 |    0.0% |      1.10 | `CHACHA20_64BYTES`\r\n\r\nbranch\r\n|             ns/byte |              byte/s |    err% |        ins/byte |        cyc/byte |    IPC |       bra/byte |   miss% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------------:|----------------:|-------:|---------------:|--------:|----------:|:----------\r\n|                1.83 |      547,223,233.51 |    0.0% |           17.08 |            5.83 |  2.931 |           0.05 |    0.0% |      1.07 | `CHACHA20_1MB`\r\n|                1.87 |      535,851,391.81 |    0.1% |           17.51 |            5.95 |  2.942 |           0.07 |    0.0% |      1.10 | `CHACHA20_256BYTES`\r\n|                1.98 |      504,774,917.46 |    0.0% |           18.81 |            6.32 |  2.977 |           0.13 |    0.0% |      1.10 | `CHACHA20_64BYTES`",
      "created_at" : "2022-04-23T17:45:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24946#issuecomment-1107541611",
      "id" : 1107541611,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24946",
      "node_id" : "IC_kwDOABII585CA75r",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1107541611/reactions"
      },
      "updated_at" : "2022-04-23T17:50:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1107541611",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/14386?v=4",
         "events_url" : "https://api.github.com/users/martinus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/martinus/followers",
         "following_url" : "https://api.github.com/users/martinus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/martinus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/martinus",
         "id" : 14386,
         "login" : "martinus",
         "node_id" : "MDQ6VXNlcjE0Mzg2",
         "organizations_url" : "https://api.github.com/users/martinus/orgs",
         "received_events_url" : "https://api.github.com/users/martinus/received_events",
         "repos_url" : "https://api.github.com/users/martinus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/martinus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/martinus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/martinus"
      }
   }
]
