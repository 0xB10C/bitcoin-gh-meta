[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#25620](https://github.com/bitcoin/bitcoin/pull/25620) (wallet: Introduce AddressBookManager by furszy)\n* [#25297](https://github.com/bitcoin/bitcoin/pull/25297) (WIP, wallet: speedup transactions sync, rescan and load not flushing to db constantly by furszy)\n* [#25296](https://github.com/bitcoin/bitcoin/pull/25296) (Add DataStream without ser-type and ser-version and use it where possible by MarcoFalke)\n* [#23417](https://github.com/bitcoin/bitcoin/pull/23417) (wallet, spkm: Move key management from DescriptorScriptPubKeyMan to wallet level KeyManager by achow101)\n* [#20205](https://github.com/bitcoin/bitcoin/pull/20205) (wallet: Properly support a wallet id by achow101)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-04-19T01:59:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#issuecomment-1101917684",
      "id" : 1101917684,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24914",
      "node_id" : "IC_kwDOABII585Bre30",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1101917684/reactions"
      },
      "updated_at" : "2022-07-16T05:46:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1101917684",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-04-26T16:33:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#issuecomment-1110007668",
      "id" : 1110007668,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24914",
      "node_id" : "IC_kwDOABII585CKV90",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1110007668/reactions"
      },
      "updated_at" : "2022-04-26T16:33:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1110007668",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2022-05-02T08:13:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#issuecomment-1114604312",
      "id" : 1114604312,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24914",
      "node_id" : "IC_kwDOABII585Cb4MY",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1114604312/reactions"
      },
      "updated_at" : "2022-05-02T08:13:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1114604312",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Concept ACK",
      "created_at" : "2022-05-06T20:52:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#issuecomment-1119999984",
      "id" : 1119999984,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24914",
      "node_id" : "IC_kwDOABII585Cwdfw",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1119999984/reactions"
      },
      "updated_at" : "2022-05-06T20:52:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1119999984",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91447896?v=4",
         "events_url" : "https://api.github.com/users/pk-b2/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pk-b2/followers",
         "following_url" : "https://api.github.com/users/pk-b2/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pk-b2/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pk-b2",
         "id" : 91447896,
         "login" : "pk-b2",
         "node_id" : "MDQ6VXNlcjkxNDQ3ODk2",
         "organizations_url" : "https://api.github.com/users/pk-b2/orgs",
         "received_events_url" : "https://api.github.com/users/pk-b2/received_events",
         "repos_url" : "https://api.github.com/users/pk-b2/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pk-b2/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pk-b2/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pk-b2"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r867213509"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/867213509"
         }
      },
      "author_association" : "NONE",
      "body" : "```\r\n> explain query plan SELECT key, value FROM main WHERE key >= ? AND key < ?\r\n```\r\n\r\nVerified that this uses an index avoiding a table scan\r\n\r\n```\r\nSEARCH TABLE main USING INDEX sqlite_autoindex_main_1 (key>? AND key<?)`\r\n```",
      "commit_id" : "3a27791244e75dd9836f18d58ffd2355e5ea4f88",
      "created_at" : "2022-05-06T21:00:55Z",
      "diff_hunk" : "@@ -506,10 +494,70 @@ bool SQLiteBatch::ReadAtCursor(CDataStream& key, CDataStream& value, bool& compl\n     return true;\n }\n \n-void SQLiteBatch::CloseCursor()\n+SQLiteCursor::~SQLiteCursor()\n {\n+    sqlite3_clear_bindings(m_cursor_stmt);\n     sqlite3_reset(m_cursor_stmt);\n-    m_cursor_init = false;\n+    int res = sqlite3_finalize(m_cursor_stmt);\n+    if (res != SQLITE_OK) {\n+        LogPrintf(\"SQLiteBatch: cursor closed but could not finalize cursor statement: %s\\n\",\n+                  sqlite3_errstr(res));\n+    }\n+}\n+\n+std::unique_ptr<DatabaseCursor> SQLiteBatch::GetCursor()\n+{\n+    if (!m_database.m_db) return nullptr;\n+    std::unique_ptr<SQLiteCursor> cursor = std::make_unique<SQLiteCursor>();\n+    if (!cursor) return nullptr;\n+\n+    const char* stmt_text = \"SELECT key, value FROM main\";\n+    int res = sqlite3_prepare_v2(m_database.m_db, stmt_text, -1, &cursor->m_cursor_stmt, nullptr);\n+    if (res != SQLITE_OK) {\n+        throw std::runtime_error(strprintf(\n+            \"SQLiteDatabase: Failed to setup cursor SQL statement: %s\\n\", sqlite3_errstr(res)));\n+    }\n+\n+    return cursor;\n+}\n+\n+std::unique_ptr<DatabaseCursor> SQLiteBatch::GetPrefixCursor(CDataStream& prefix)\n+{\n+    if (prefix.empty()) return nullptr;\n+    if (!m_database.m_db) return nullptr;\n+\n+    // To get just the records we want, the SQL statement does a comparison of the binary data\n+    // where the data must be greater than or equal to the prefix, and less than\n+    // the prefix incremented by one (when interpreted as an integer)\n+    std::vector<std::byte> start_range(prefix.begin(), prefix.end());\n+    std::vector<std::byte> end_range(prefix.begin(), prefix.end());\n+    auto it = end_range.rbegin();\n+    for (; it != end_range.rend(); ++it) {\n+        if (*it == std::byte(0xff)) {\n+            *it = std::byte(0x00);\n+            continue;\n+        }\n+        *it = std::byte(std::to_integer<unsigned char>(*it) + 1);\n+        break;\n+    }\n+    if (it == end_range.rend()) {\n+        end_range.insert(end_range.begin(), std::byte(0x01));\n+    }\n+\n+    std::unique_ptr<SQLiteCursor> cursor = std::make_unique<SQLiteCursor>(start_range, end_range);\n+    if (!cursor) return nullptr;\n+\n+    const char* stmt_text = \"SELECT key, value FROM main WHERE key >= ? AND key < ?\";",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r867213509",
      "id" : 867213509,
      "line" : 550,
      "node_id" : "PRRC_kwDOABII584zsKDF",
      "original_commit_id" : "3a27791244e75dd9836f18d58ffd2355e5ea4f88",
      "original_line" : 550,
      "original_position" : 105,
      "original_start_line" : null,
      "path" : "src/wallet/sqlite.cpp",
      "position" : 105,
      "pull_request_review_id" : 965184731,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/867213509/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-06T21:00:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/867213509",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91447896?v=4",
         "events_url" : "https://api.github.com/users/pk-b2/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pk-b2/followers",
         "following_url" : "https://api.github.com/users/pk-b2/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pk-b2/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pk-b2",
         "id" : 91447896,
         "login" : "pk-b2",
         "node_id" : "MDQ6VXNlcjkxNDQ3ODk2",
         "organizations_url" : "https://api.github.com/users/pk-b2/orgs",
         "received_events_url" : "https://api.github.com/users/pk-b2/received_events",
         "repos_url" : "https://api.github.com/users/pk-b2/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pk-b2/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pk-b2/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pk-b2"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r867214239"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/867214239"
         }
      },
      "author_association" : "NONE",
      "body" : "ð Like that approach",
      "commit_id" : "3a27791244e75dd9836f18d58ffd2355e5ea4f88",
      "created_at" : "2022-05-06T21:02:23Z",
      "diff_hunk" : "@@ -506,10 +494,70 @@ bool SQLiteBatch::ReadAtCursor(CDataStream& key, CDataStream& value, bool& compl\n     return true;\n }\n \n-void SQLiteBatch::CloseCursor()\n+SQLiteCursor::~SQLiteCursor()\n {\n+    sqlite3_clear_bindings(m_cursor_stmt);\n     sqlite3_reset(m_cursor_stmt);\n-    m_cursor_init = false;\n+    int res = sqlite3_finalize(m_cursor_stmt);\n+    if (res != SQLITE_OK) {\n+        LogPrintf(\"SQLiteBatch: cursor closed but could not finalize cursor statement: %s\\n\",\n+                  sqlite3_errstr(res));\n+    }\n+}\n+\n+std::unique_ptr<DatabaseCursor> SQLiteBatch::GetCursor()\n+{\n+    if (!m_database.m_db) return nullptr;\n+    std::unique_ptr<SQLiteCursor> cursor = std::make_unique<SQLiteCursor>();\n+    if (!cursor) return nullptr;\n+\n+    const char* stmt_text = \"SELECT key, value FROM main\";\n+    int res = sqlite3_prepare_v2(m_database.m_db, stmt_text, -1, &cursor->m_cursor_stmt, nullptr);\n+    if (res != SQLITE_OK) {\n+        throw std::runtime_error(strprintf(\n+            \"SQLiteDatabase: Failed to setup cursor SQL statement: %s\\n\", sqlite3_errstr(res)));\n+    }\n+\n+    return cursor;\n+}\n+\n+std::unique_ptr<DatabaseCursor> SQLiteBatch::GetPrefixCursor(CDataStream& prefix)\n+{\n+    if (prefix.empty()) return nullptr;\n+    if (!m_database.m_db) return nullptr;\n+\n+    // To get just the records we want, the SQL statement does a comparison of the binary data\n+    // where the data must be greater than or equal to the prefix, and less than\n+    // the prefix incremented by one (when interpreted as an integer)\n+    std::vector<std::byte> start_range(prefix.begin(), prefix.end());\n+    std::vector<std::byte> end_range(prefix.begin(), prefix.end());\n+    auto it = end_range.rbegin();\n+    for (; it != end_range.rend(); ++it) {\n+        if (*it == std::byte(0xff)) {\n+            *it = std::byte(0x00);\n+            continue;\n+        }\n+        *it = std::byte(std::to_integer<unsigned char>(*it) + 1);\n+        break;\n+    }\n+    if (it == end_range.rend()) {\n+        end_range.insert(end_range.begin(), std::byte(0x01));\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r867214239",
      "id" : 867214239,
      "line" : 545,
      "node_id" : "PRRC_kwDOABII584zsKOf",
      "original_commit_id" : "3a27791244e75dd9836f18d58ffd2355e5ea4f88",
      "original_line" : 545,
      "original_position" : 100,
      "original_start_line" : 529,
      "path" : "src/wallet/sqlite.cpp",
      "position" : 100,
      "pull_request_review_id" : 965185719,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/867214239/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 529,
      "start_side" : "RIGHT",
      "updated_at" : "2022-05-06T21:02:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/867214239",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91447896?v=4",
         "events_url" : "https://api.github.com/users/pk-b2/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pk-b2/followers",
         "following_url" : "https://api.github.com/users/pk-b2/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pk-b2/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pk-b2",
         "id" : 91447896,
         "login" : "pk-b2",
         "node_id" : "MDQ6VXNlcjkxNDQ3ODk2",
         "organizations_url" : "https://api.github.com/users/pk-b2/orgs",
         "received_events_url" : "https://api.github.com/users/pk-b2/received_events",
         "repos_url" : "https://api.github.com/users/pk-b2/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pk-b2/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pk-b2/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pk-b2"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-05-12T21:16:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#issuecomment-1125430536",
      "id" : 1125430536,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24914",
      "node_id" : "IC_kwDOABII585DFLUI",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1125430536/reactions"
      },
      "updated_at" : "2022-05-12T21:16:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1125430536",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-05-18T17:38:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#issuecomment-1130301902",
      "id" : 1130301902,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24914",
      "node_id" : "IC_kwDOABII585DXwnO",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1130301902/reactions"
      },
      "updated_at" : "2022-05-18T17:38:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1130301902",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK on querying specifically what is needed from the database when loading. Maybe some day we don't even have to read all records into memory.",
      "created_at" : "2022-05-31T16:51:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#issuecomment-1142381108",
      "id" : 1142381108,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24914",
      "node_id" : "IC_kwDOABII585EF1o0",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1142381108/reactions"
      },
      "updated_at" : "2022-05-31T16:51:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1142381108",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r893727842"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/893727842"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "tiny nit: maybe `GetNewCursor()`?",
      "commit_id" : "c23dfc2dbe030c941b8c60fc7e3c91ee3565c247",
      "created_at" : "2022-06-09T16:34:00Z",
      "diff_hunk" : "@@ -696,13 +694,19 @@ bool BerkeleyBatch::ReadAtCursor(CDataStream& ssKey, CDataStream& ssValue, bool&\n     return true;\n }\n \n-void BerkeleyBatch::CloseCursor()\n+BerkeleyCursor::~BerkeleyCursor()\n {\n     if (!m_cursor) return;\n     m_cursor->close();\n     m_cursor = nullptr;\n }\n \n+std::unique_ptr<DatabaseCursor> BerkeleyBatch::GetCursor()\n+{\n+    if (!pdb) return nullptr;\n+    return std::make_unique<BerkeleyCursor>(m_database);\n+}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r893727842",
      "id" : 893727842,
      "line" : 720,
      "node_id" : "PRRC_kwDOABII5841RTRi",
      "original_commit_id" : "950c94f5ccc024c633410d624e11f874f857543d",
      "original_line" : 708,
      "original_position" : 47,
      "original_start_line" : 704,
      "path" : "src/wallet/bdb.cpp",
      "position" : 47,
      "pull_request_review_id" : 1001663726,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/893727842/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 716,
      "start_side" : "RIGHT",
      "updated_at" : "2022-06-09T17:52:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/893727842",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r893736353"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/893736353"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "in 950c94f5:\r\n\r\nProbably better an exception instead of an assertion (similar to what is being done in the SQLite method).",
      "commit_id" : "c23dfc2dbe030c941b8c60fc7e3c91ee3565c247",
      "created_at" : "2022-06-09T16:43:31Z",
      "diff_hunk" : "@@ -661,16 +661,14 @@ void BerkeleyDatabase::ReloadDbEnv()\n     env->ReloadDbEnv();\n }\n \n-bool BerkeleyBatch::StartCursor()\n+BerkeleyCursor::BerkeleyCursor(BerkeleyDatabase& database)\n {\n-    assert(!m_cursor);\n-    if (!pdb)\n-        return false;\n-    int ret = pdb->cursor(nullptr, &m_cursor, 0);\n-    return ret == 0;\n+    assert(database.m_db.get());\n+    int ret = database.m_db->cursor(nullptr, &m_cursor, 0);\n+    assert(ret == 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r893736353",
      "id" : 893736353,
      "line" : 669,
      "node_id" : "PRRC_kwDOABII5841RVWh",
      "original_commit_id" : "950c94f5ccc024c633410d624e11f874f857543d",
      "original_line" : 668,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/wallet/bdb.cpp",
      "position" : 23,
      "pull_request_review_id" : 1001663726,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/893736353/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-09T17:54:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/893736353",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r893783634"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/893783634"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In 040fa33f:\r\n\r\nBad copy here, error is `DBErrors::CORRUPT`.",
      "commit_id" : "c23dfc2dbe030c941b8c60fc7e3c91ee3565c247",
      "created_at" : "2022-06-09T17:33:52Z",
      "diff_hunk" : "@@ -770,6 +770,19 @@ static DBErrors LoadMinVersion(CWallet* pwallet, DatabaseBatch& batch) EXCLUSIVE\n     return DBErrors::LOAD_OK;\n }\n \n+static DBErrors LoadWalletFlags(CWallet* pwallet, DatabaseBatch& batch) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    AssertLockHeld(pwallet->cs_wallet);\n+    uint64_t flags;\n+    if (batch.Read(DBKeys::FLAGS, flags)) {\n+        if (!pwallet->LoadWalletFlags(flags)) {\n+            pwallet->WalletLogPrintf(\"Error reading wallet database: Unknown non-tolerable wallet flags found\\n\");\n+            return DBErrors::TOO_NEW;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r893783634",
      "id" : 893783634,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5841Rg5S",
      "original_commit_id" : "040fa33fcce7cb0ec00405ca750de01880c19b8a",
      "original_line" : 780,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 11,
      "pull_request_review_id" : 1001663726,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/893783634/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-09T17:52:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/893783634",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r900448270"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/900448270"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The original error is incorrect, it's supposed to be `TOO_NEW`.",
      "commit_id" : "c23dfc2dbe030c941b8c60fc7e3c91ee3565c247",
      "created_at" : "2022-06-17T19:22:41Z",
      "diff_hunk" : "@@ -770,6 +770,19 @@ static DBErrors LoadMinVersion(CWallet* pwallet, DatabaseBatch& batch) EXCLUSIVE\n     return DBErrors::LOAD_OK;\n }\n \n+static DBErrors LoadWalletFlags(CWallet* pwallet, DatabaseBatch& batch) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    AssertLockHeld(pwallet->cs_wallet);\n+    uint64_t flags;\n+    if (batch.Read(DBKeys::FLAGS, flags)) {\n+        if (!pwallet->LoadWalletFlags(flags)) {\n+            pwallet->WalletLogPrintf(\"Error reading wallet database: Unknown non-tolerable wallet flags found\\n\");\n+            return DBErrors::TOO_NEW;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r900448270",
      "id" : 900448270,
      "in_reply_to_id" : 893783634,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5841q8AO",
      "original_commit_id" : "040fa33fcce7cb0ec00405ca750de01880c19b8a",
      "original_line" : 780,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 11,
      "pull_request_review_id" : 1010939699,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/900448270/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-17T19:22:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/900448270",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r902769522"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/902769522"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In a1d8d563:\r\n\r\nShouldn't this be a direct `return DBErrors::CORRUPT` as it was before?\r\n(same for the other one at line 807)",
      "commit_id" : "431904b5c317917fad4c5171bebb14620fd1edec",
      "created_at" : "2022-06-21T15:31:01Z",
      "diff_hunk" : "@@ -828,12 +741,330 @@ static DBErrors LoadWalletFlags(CWallet* pwallet, DatabaseBatch& batch) EXCLUSIV\n     return DBErrors::LOAD_OK;\n }\n \n+static DBErrors LoadLegacyWalletRecords(CWallet* pwallet, DatabaseBatch& batch, int last_client) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    AssertLockHeld(pwallet->cs_wallet);\n+    DBErrors result = DBErrors::LOAD_OK;\n+    std::string err;\n+\n+    // Load HD Chain\n+    CHDChain chain;\n+    if (batch.Read(DBKeys::HDCHAIN, chain)) {\n+        pwallet->GetOrCreateLegacyScriptPubKeyMan()->LoadHDChain(chain);\n+    }\n+\n+    CDataStream ssKey(SER_DISK, CLIENT_VERSION);\n+    CDataStream ssValue(SER_DISK, CLIENT_VERSION);\n+\n+    // Load unencrypted keys\n+    std::unique_ptr<DatabaseCursor> cursor = GetTypeCursor(batch, DBKeys::KEY);\n+    if (!cursor) {\n+        pwallet->WalletLogPrintf(\"Error getting database cursor for unencrypted keys\\n\");\n+        return DBErrors::CORRUPT;\n+    }\n+\n+    int num_keys = 0;\n+    while (true) {\n+        bool complete;\n+        bool ret = cursor->Next(ssKey, ssValue, complete);\n+        if (complete) {\n+            break;\n+        } else if (!ret) {\n+            pwallet->WalletLogPrintf(\"Error reading next unencrypted key record for wallet database\\n\");\n+            return DBErrors::CORRUPT;\n+        }\n+        std::string type;\n+        ssKey >> type;\n+        assert(type == DBKeys::KEY);\n+        if (!LoadKey(pwallet, ssKey, ssValue, err)) {\n+            result = DBErrors::CORRUPT;\n+            pwallet->WalletLogPrintf(\"%s\\n\", err);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r902769522",
      "id" : 902769522,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5841zyty",
      "original_commit_id" : "a1d8d563d0f2ae12889bcc9002f1a532fadc9acc",
      "original_line" : 516,
      "original_position" : 184,
      "original_start_line" : 780,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 1013820695,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/902769522/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-06-21T16:01:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/902769522",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r902777349"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/902777349"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`num_keys` isn't being increased.",
      "commit_id" : "431904b5c317917fad4c5171bebb14620fd1edec",
      "created_at" : "2022-06-21T15:38:06Z",
      "diff_hunk" : "@@ -828,12 +741,330 @@ static DBErrors LoadWalletFlags(CWallet* pwallet, DatabaseBatch& batch) EXCLUSIV\n     return DBErrors::LOAD_OK;\n }\n \n+static DBErrors LoadLegacyWalletRecords(CWallet* pwallet, DatabaseBatch& batch, int last_client) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    AssertLockHeld(pwallet->cs_wallet);\n+    DBErrors result = DBErrors::LOAD_OK;\n+    std::string err;\n+\n+    // Load HD Chain\n+    CHDChain chain;\n+    if (batch.Read(DBKeys::HDCHAIN, chain)) {\n+        pwallet->GetOrCreateLegacyScriptPubKeyMan()->LoadHDChain(chain);\n+    }\n+\n+    CDataStream ssKey(SER_DISK, CLIENT_VERSION);\n+    CDataStream ssValue(SER_DISK, CLIENT_VERSION);\n+\n+    // Load unencrypted keys\n+    std::unique_ptr<DatabaseCursor> cursor = GetTypeCursor(batch, DBKeys::KEY);\n+    if (!cursor) {\n+        pwallet->WalletLogPrintf(\"Error getting database cursor for unencrypted keys\\n\");\n+        return DBErrors::CORRUPT;\n+    }\n+\n+    int num_keys = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r902777349",
      "id" : 902777349,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5841z0oF",
      "original_commit_id" : "a1d8d563d0f2ae12889bcc9002f1a532fadc9acc",
      "original_line" : 501,
      "original_position" : 169,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 1013820695,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/902777349/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-21T16:01:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/902777349",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r902777939"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/902777939"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`num_ckeys` isn't being increased.",
      "commit_id" : "431904b5c317917fad4c5171bebb14620fd1edec",
      "created_at" : "2022-06-21T15:38:39Z",
      "diff_hunk" : "@@ -828,12 +741,330 @@ static DBErrors LoadWalletFlags(CWallet* pwallet, DatabaseBatch& batch) EXCLUSIV\n     return DBErrors::LOAD_OK;\n }\n \n+static DBErrors LoadLegacyWalletRecords(CWallet* pwallet, DatabaseBatch& batch, int last_client) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    AssertLockHeld(pwallet->cs_wallet);\n+    DBErrors result = DBErrors::LOAD_OK;\n+    std::string err;\n+\n+    // Load HD Chain\n+    CHDChain chain;\n+    if (batch.Read(DBKeys::HDCHAIN, chain)) {\n+        pwallet->GetOrCreateLegacyScriptPubKeyMan()->LoadHDChain(chain);\n+    }\n+\n+    CDataStream ssKey(SER_DISK, CLIENT_VERSION);\n+    CDataStream ssValue(SER_DISK, CLIENT_VERSION);\n+\n+    // Load unencrypted keys\n+    std::unique_ptr<DatabaseCursor> cursor = GetTypeCursor(batch, DBKeys::KEY);\n+    if (!cursor) {\n+        pwallet->WalletLogPrintf(\"Error getting database cursor for unencrypted keys\\n\");\n+        return DBErrors::CORRUPT;\n+    }\n+\n+    int num_keys = 0;\n+    while (true) {\n+        bool complete;\n+        bool ret = cursor->Next(ssKey, ssValue, complete);\n+        if (complete) {\n+            break;\n+        } else if (!ret) {\n+            pwallet->WalletLogPrintf(\"Error reading next unencrypted key record for wallet database\\n\");\n+            return DBErrors::CORRUPT;\n+        }\n+        std::string type;\n+        ssKey >> type;\n+        assert(type == DBKeys::KEY);\n+        if (!LoadKey(pwallet, ssKey, ssValue, err)) {\n+            result = DBErrors::CORRUPT;\n+            pwallet->WalletLogPrintf(\"%s\\n\", err);\n+        }\n+    }\n+    cursor.reset();\n+\n+    // Load encrypted keys\n+    cursor = GetTypeCursor(batch, DBKeys::CRYPTED_KEY);\n+    if (!cursor) {\n+        pwallet->WalletLogPrintf(\"Error getting database cursor for crypted keys\\n\");\n+        return DBErrors::CORRUPT;\n+    }\n+\n+    int num_ckeys = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r902777939",
      "id" : 902777939,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5841z0xT",
      "original_commit_id" : "a1d8d563d0f2ae12889bcc9002f1a532fadc9acc",
      "original_line" : 529,
      "original_position" : 196,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 1013820695,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/902777939/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-21T16:01:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/902777939",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r902999240"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/902999240"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No, If you trace the code, it doesn't actually immediately return `DBErrors::CORRPUT`. Instead it does `result = DBErrors::CORRUPT`, continues with reading the rest of the records, and returns `result` towards the end.",
      "commit_id" : "431904b5c317917fad4c5171bebb14620fd1edec",
      "created_at" : "2022-06-21T19:38:56Z",
      "diff_hunk" : "@@ -828,12 +741,330 @@ static DBErrors LoadWalletFlags(CWallet* pwallet, DatabaseBatch& batch) EXCLUSIV\n     return DBErrors::LOAD_OK;\n }\n \n+static DBErrors LoadLegacyWalletRecords(CWallet* pwallet, DatabaseBatch& batch, int last_client) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    AssertLockHeld(pwallet->cs_wallet);\n+    DBErrors result = DBErrors::LOAD_OK;\n+    std::string err;\n+\n+    // Load HD Chain\n+    CHDChain chain;\n+    if (batch.Read(DBKeys::HDCHAIN, chain)) {\n+        pwallet->GetOrCreateLegacyScriptPubKeyMan()->LoadHDChain(chain);\n+    }\n+\n+    CDataStream ssKey(SER_DISK, CLIENT_VERSION);\n+    CDataStream ssValue(SER_DISK, CLIENT_VERSION);\n+\n+    // Load unencrypted keys\n+    std::unique_ptr<DatabaseCursor> cursor = GetTypeCursor(batch, DBKeys::KEY);\n+    if (!cursor) {\n+        pwallet->WalletLogPrintf(\"Error getting database cursor for unencrypted keys\\n\");\n+        return DBErrors::CORRUPT;\n+    }\n+\n+    int num_keys = 0;\n+    while (true) {\n+        bool complete;\n+        bool ret = cursor->Next(ssKey, ssValue, complete);\n+        if (complete) {\n+            break;\n+        } else if (!ret) {\n+            pwallet->WalletLogPrintf(\"Error reading next unencrypted key record for wallet database\\n\");\n+            return DBErrors::CORRUPT;\n+        }\n+        std::string type;\n+        ssKey >> type;\n+        assert(type == DBKeys::KEY);\n+        if (!LoadKey(pwallet, ssKey, ssValue, err)) {\n+            result = DBErrors::CORRUPT;\n+            pwallet->WalletLogPrintf(\"%s\\n\", err);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r902999240",
      "id" : 902999240,
      "in_reply_to_id" : 902769522,
      "line" : null,
      "node_id" : "PRRC_kwDOABII58410qzI",
      "original_commit_id" : "a1d8d563d0f2ae12889bcc9002f1a532fadc9acc",
      "original_line" : 516,
      "original_position" : 184,
      "original_start_line" : 780,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 1014147885,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/902999240/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-06-21T19:38:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/902999240",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r903005613"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/903005613"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done. Also renamed `GetPrefixCursor` to `GetNewPrefixCursor`.",
      "commit_id" : "431904b5c317917fad4c5171bebb14620fd1edec",
      "created_at" : "2022-06-21T19:47:13Z",
      "diff_hunk" : "@@ -696,13 +694,19 @@ bool BerkeleyBatch::ReadAtCursor(CDataStream& ssKey, CDataStream& ssValue, bool&\n     return true;\n }\n \n-void BerkeleyBatch::CloseCursor()\n+BerkeleyCursor::~BerkeleyCursor()\n {\n     if (!m_cursor) return;\n     m_cursor->close();\n     m_cursor = nullptr;\n }\n \n+std::unique_ptr<DatabaseCursor> BerkeleyBatch::GetCursor()\n+{\n+    if (!pdb) return nullptr;\n+    return std::make_unique<BerkeleyCursor>(m_database);\n+}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r903005613",
      "id" : 903005613,
      "in_reply_to_id" : 893727842,
      "line" : null,
      "node_id" : "PRRC_kwDOABII58410sWt",
      "original_commit_id" : "950c94f5ccc024c633410d624e11f874f857543d",
      "original_line" : 716,
      "original_position" : 47,
      "original_start_line" : 704,
      "path" : "src/wallet/bdb.cpp",
      "position" : null,
      "pull_request_review_id" : 1014157057,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/903005613/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-06-21T19:47:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/903005613",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r903005674"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/903005674"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "431904b5c317917fad4c5171bebb14620fd1edec",
      "created_at" : "2022-06-21T19:47:18Z",
      "diff_hunk" : "@@ -661,16 +661,14 @@ void BerkeleyDatabase::ReloadDbEnv()\n     env->ReloadDbEnv();\n }\n \n-bool BerkeleyBatch::StartCursor()\n+BerkeleyCursor::BerkeleyCursor(BerkeleyDatabase& database)\n {\n-    assert(!m_cursor);\n-    if (!pdb)\n-        return false;\n-    int ret = pdb->cursor(nullptr, &m_cursor, 0);\n-    return ret == 0;\n+    assert(database.m_db.get());\n+    int ret = database.m_db->cursor(nullptr, &m_cursor, 0);\n+    assert(ret == 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r903005674",
      "id" : 903005674,
      "in_reply_to_id" : 893736353,
      "line" : 663,
      "node_id" : "PRRC_kwDOABII58410sXq",
      "original_commit_id" : "950c94f5ccc024c633410d624e11f874f857543d",
      "original_line" : 663,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/wallet/bdb.cpp",
      "position" : 99,
      "pull_request_review_id" : 1014157131,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/903005674/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-21T19:47:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/903005674",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r903005771"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/903005771"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "431904b5c317917fad4c5171bebb14620fd1edec",
      "created_at" : "2022-06-21T19:47:25Z",
      "diff_hunk" : "@@ -828,12 +741,330 @@ static DBErrors LoadWalletFlags(CWallet* pwallet, DatabaseBatch& batch) EXCLUSIV\n     return DBErrors::LOAD_OK;\n }\n \n+static DBErrors LoadLegacyWalletRecords(CWallet* pwallet, DatabaseBatch& batch, int last_client) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    AssertLockHeld(pwallet->cs_wallet);\n+    DBErrors result = DBErrors::LOAD_OK;\n+    std::string err;\n+\n+    // Load HD Chain\n+    CHDChain chain;\n+    if (batch.Read(DBKeys::HDCHAIN, chain)) {\n+        pwallet->GetOrCreateLegacyScriptPubKeyMan()->LoadHDChain(chain);\n+    }\n+\n+    CDataStream ssKey(SER_DISK, CLIENT_VERSION);\n+    CDataStream ssValue(SER_DISK, CLIENT_VERSION);\n+\n+    // Load unencrypted keys\n+    std::unique_ptr<DatabaseCursor> cursor = GetTypeCursor(batch, DBKeys::KEY);\n+    if (!cursor) {\n+        pwallet->WalletLogPrintf(\"Error getting database cursor for unencrypted keys\\n\");\n+        return DBErrors::CORRUPT;\n+    }\n+\n+    int num_keys = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r903005771",
      "id" : 903005771,
      "in_reply_to_id" : 902777349,
      "line" : null,
      "node_id" : "PRRC_kwDOABII58410sZL",
      "original_commit_id" : "a1d8d563d0f2ae12889bcc9002f1a532fadc9acc",
      "original_line" : 501,
      "original_position" : 169,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 1014157266,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/903005771/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-21T19:47:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/903005771",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r903005815"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/903005815"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "431904b5c317917fad4c5171bebb14620fd1edec",
      "created_at" : "2022-06-21T19:47:28Z",
      "diff_hunk" : "@@ -828,12 +741,330 @@ static DBErrors LoadWalletFlags(CWallet* pwallet, DatabaseBatch& batch) EXCLUSIV\n     return DBErrors::LOAD_OK;\n }\n \n+static DBErrors LoadLegacyWalletRecords(CWallet* pwallet, DatabaseBatch& batch, int last_client) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    AssertLockHeld(pwallet->cs_wallet);\n+    DBErrors result = DBErrors::LOAD_OK;\n+    std::string err;\n+\n+    // Load HD Chain\n+    CHDChain chain;\n+    if (batch.Read(DBKeys::HDCHAIN, chain)) {\n+        pwallet->GetOrCreateLegacyScriptPubKeyMan()->LoadHDChain(chain);\n+    }\n+\n+    CDataStream ssKey(SER_DISK, CLIENT_VERSION);\n+    CDataStream ssValue(SER_DISK, CLIENT_VERSION);\n+\n+    // Load unencrypted keys\n+    std::unique_ptr<DatabaseCursor> cursor = GetTypeCursor(batch, DBKeys::KEY);\n+    if (!cursor) {\n+        pwallet->WalletLogPrintf(\"Error getting database cursor for unencrypted keys\\n\");\n+        return DBErrors::CORRUPT;\n+    }\n+\n+    int num_keys = 0;\n+    while (true) {\n+        bool complete;\n+        bool ret = cursor->Next(ssKey, ssValue, complete);\n+        if (complete) {\n+            break;\n+        } else if (!ret) {\n+            pwallet->WalletLogPrintf(\"Error reading next unencrypted key record for wallet database\\n\");\n+            return DBErrors::CORRUPT;\n+        }\n+        std::string type;\n+        ssKey >> type;\n+        assert(type == DBKeys::KEY);\n+        if (!LoadKey(pwallet, ssKey, ssValue, err)) {\n+            result = DBErrors::CORRUPT;\n+            pwallet->WalletLogPrintf(\"%s\\n\", err);\n+        }\n+    }\n+    cursor.reset();\n+\n+    // Load encrypted keys\n+    cursor = GetTypeCursor(batch, DBKeys::CRYPTED_KEY);\n+    if (!cursor) {\n+        pwallet->WalletLogPrintf(\"Error getting database cursor for crypted keys\\n\");\n+        return DBErrors::CORRUPT;\n+    }\n+\n+    int num_ckeys = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r903005815",
      "id" : 903005815,
      "in_reply_to_id" : 902777939,
      "line" : null,
      "node_id" : "PRRC_kwDOABII58410sZ3",
      "original_commit_id" : "a1d8d563d0f2ae12889bcc9002f1a532fadc9acc",
      "original_line" : 529,
      "original_position" : 196,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 1014157337,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/903005815/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-21T19:47:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/903005815",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> What about abstracting the cursor creation, looped read and error handling into a generic function so we can get rid-off most of the boilerplate code?\r\n> \r\n> Quick example that could be extended to most of the flows: [furszy@8526a87](https://github.com/furszy/bitcoin-core/commit/8526a87cae04a3704d86a5157894d42ecaca2ab9)\r\n\r\nLooking into it.",
      "created_at" : "2022-06-21T19:47:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#issuecomment-1162259558",
      "id" : 1162259558,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24914",
      "node_id" : "IC_kwDOABII585FRqxm",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1162259558/reactions"
      },
      "updated_at" : "2022-06-21T19:47:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1162259558",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've refactored the loading loop boilerplate into its own function.",
      "created_at" : "2022-06-22T00:49:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#issuecomment-1162502096",
      "id" : 1162502096,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24914",
      "node_id" : "IC_kwDOABII585FSl_Q",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1162502096/reactions"
      },
      "updated_at" : "2022-06-22T00:49:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1162502096",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "```\r\nwallet/walletdb.cpp:912:18: error: reading variable 'm_address_book' requires holding mutex 'pwallet->cs_wallet' [-Werror,-Wthread-safety-analysis]\r\n        pwallet->m_address_book[DecodeDestination(strAddress)].SetLabel(label);",
      "created_at" : "2022-06-22T05:30:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#issuecomment-1162659653",
      "id" : 1162659653,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24914",
      "node_id" : "IC_kwDOABII585FTMdF",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1162659653/reactions"
      },
      "updated_at" : "2022-06-22T05:30:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1162659653",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-06-30T16:47:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#issuecomment-1171454651",
      "id" : 1171454651,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24914",
      "node_id" : "IC_kwDOABII585F0vq7",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1171454651/reactions"
      },
      "updated_at" : "2022-06-30T16:47:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1171454651",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Patch for the [ci error](https://github.com/bitcoin/bitcoin/pull/24914/checks?check_run_id=7140018071) \"requires holding mutex 'pwallet->cs_wallet'\": https://github.com/furszy/bitcoin/commit/b3c51af13a04eaf3a374f778dd0858ad128aa512",
      "created_at" : "2022-07-06T03:06:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#issuecomment-1175727634",
      "id" : 1175727634,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24914",
      "node_id" : "IC_kwDOABII585GFC4S",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1175727634/reactions"
      },
      "updated_at" : "2022-07-06T03:06:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1175727634",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r915201717"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/915201717"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "tiny nit:\r\n```suggestion\r\n        LogPrintf(\"%s: Unable to execute cursor step: %s\\n\", __func__, sqlite3_errstr(res));\r\n```",
      "commit_id" : "431904b5c317917fad4c5171bebb14620fd1edec",
      "created_at" : "2022-07-06T19:51:19Z",
      "diff_hunk" : "@@ -472,27 +470,17 @@ bool SQLiteBatch::HasKey(CDataStream&& key)\n     return res == SQLITE_ROW;\n }\n \n-bool SQLiteBatch::StartCursor()\n-{\n-    assert(!m_cursor_init);\n-    if (!m_database.m_db) return false;\n-    m_cursor_init = true;\n-    return true;\n-}\n-\n-bool SQLiteBatch::ReadAtCursor(CDataStream& key, CDataStream& value, bool& complete)\n+bool SQLiteCursor::Next(CDataStream& key, CDataStream& value, bool& complete)\n {\n     complete = false;\n \n-    if (!m_cursor_init) return false;\n-\n     int res = sqlite3_step(m_cursor_stmt);\n     if (res == SQLITE_DONE) {\n         complete = true;\n         return true;\n     }\n     if (res != SQLITE_ROW) {\n-        LogPrintf(\"SQLiteBatch::ReadAtCursor: Unable to execute cursor step: %s\\n\", sqlite3_errstr(res));\n+        LogPrintf(\"SQLiteCursor::Next: Unable to execute cursor step: %s\\n\", sqlite3_errstr(res));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r915201717",
      "id" : 915201717,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5842jN61",
      "original_commit_id" : "d1316204a783a1eed1ef6b7d7fe0680c5b6368d3",
      "original_line" : 483,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/wallet/sqlite.cpp",
      "position" : null,
      "pull_request_review_id" : 1030621221,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/915201717/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-07T16:47:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/915201717",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r915202937"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/915202937"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Should log `SQLiteCursor` now, not `SQLiteBatch`.\r\n```suggestion\r\n        LogPrintf(\"%s: cursor closed but could not finalize cursor statement: %s\\n\", __func__, sqlite3_errstr(res));\r\n```",
      "commit_id" : "431904b5c317917fad4c5171bebb14620fd1edec",
      "created_at" : "2022-07-06T19:52:57Z",
      "diff_hunk" : "@@ -506,10 +494,30 @@ bool SQLiteBatch::ReadAtCursor(CDataStream& key, CDataStream& value, bool& compl\n     return true;\n }\n \n-void SQLiteBatch::CloseCursor()\n+SQLiteCursor::~SQLiteCursor()\n {\n     sqlite3_reset(m_cursor_stmt);\n-    m_cursor_init = false;\n+    int res = sqlite3_finalize(m_cursor_stmt);\n+    if (res != SQLITE_OK) {\n+        LogPrintf(\"SQLiteBatch: cursor closed but could not finalize cursor statement: %s\\n\",\n+                  sqlite3_errstr(res));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r915202937",
      "id" : 915202937,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5842jON5",
      "original_commit_id" : "d1316204a783a1eed1ef6b7d7fe0680c5b6368d3",
      "original_line" : 503,
      "original_position" : 58,
      "original_start_line" : 502,
      "path" : "src/wallet/sqlite.cpp",
      "position" : null,
      "pull_request_review_id" : 1030621221,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/915202937/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-07-07T16:47:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/915202937",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r915204516"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/915204516"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "could delete this line, `m_cursor` will never be null.",
      "commit_id" : "431904b5c317917fad4c5171bebb14620fd1edec",
      "created_at" : "2022-07-06T19:55:07Z",
      "diff_hunk" : "@@ -690,13 +688,19 @@ bool BerkeleyBatch::ReadAtCursor(CDataStream& ssKey, CDataStream& ssValue, bool&\n     return true;\n }\n \n-void BerkeleyBatch::CloseCursor()\n+BerkeleyCursor::~BerkeleyCursor()\n {\n     if (!m_cursor) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r915204516",
      "id" : 915204516,
      "line" : 707,
      "node_id" : "PRRC_kwDOABII5842jOmk",
      "original_commit_id" : "d1316204a783a1eed1ef6b7d7fe0680c5b6368d3",
      "original_line" : 707,
      "original_position" : 38,
      "original_start_line" : 691,
      "path" : "src/wallet/bdb.cpp",
      "position" : 146,
      "pull_request_review_id" : 1030621221,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/915204516/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 705,
      "start_side" : "RIGHT",
      "updated_at" : "2022-07-07T16:47:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/915204516",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r915208527"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/915208527"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: what about making the cursor private and passing a `sqlite3_stmt` pointer to the constructor?",
      "commit_id" : "431904b5c317917fad4c5171bebb14620fd1edec",
      "created_at" : "2022-07-06T20:00:37Z",
      "diff_hunk" : "@@ -14,19 +14,27 @@ struct bilingual_str;\n namespace wallet {\n class SQLiteDatabase;\n \n+class SQLiteCursor : public DatabaseCursor\n+{\n+public:\n+    sqlite3_stmt* m_cursor_stmt{nullptr};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r915208527",
      "id" : 915208527,
      "line" : 21,
      "node_id" : "PRRC_kwDOABII5842jPlP",
      "original_commit_id" : "d1316204a783a1eed1ef6b7d7fe0680c5b6368d3",
      "original_line" : 21,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/wallet/sqlite.h",
      "position" : 8,
      "pull_request_review_id" : 1030621221,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/915208527/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-07T16:47:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/915208527",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r915211634"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/915211634"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: this line can be removed.",
      "commit_id" : "431904b5c317917fad4c5171bebb14620fd1edec",
      "created_at" : "2022-07-06T20:04:53Z",
      "diff_hunk" : "@@ -506,10 +494,30 @@ bool SQLiteBatch::ReadAtCursor(CDataStream& key, CDataStream& value, bool& compl\n     return true;\n }\n \n-void SQLiteBatch::CloseCursor()\n+SQLiteCursor::~SQLiteCursor()\n {\n     sqlite3_reset(m_cursor_stmt);\n-    m_cursor_init = false;\n+    int res = sqlite3_finalize(m_cursor_stmt);\n+    if (res != SQLITE_OK) {\n+        LogPrintf(\"SQLiteBatch: cursor closed but could not finalize cursor statement: %s\\n\",\n+                  sqlite3_errstr(res));\n+    }\n+}\n+\n+std::unique_ptr<DatabaseCursor> SQLiteBatch::GetNewCursor()\n+{\n+    if (!m_database.m_db) return nullptr;\n+    std::unique_ptr<SQLiteCursor> cursor = std::make_unique<SQLiteCursor>();\n+    if (!cursor) return nullptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r915211634",
      "id" : 915211634,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5842jQVy",
      "original_commit_id" : "d1316204a783a1eed1ef6b7d7fe0680c5b6368d3",
      "original_line" : 511,
      "original_position" : 66,
      "original_start_line" : null,
      "path" : "src/wallet/sqlite.cpp",
      "position" : null,
      "pull_request_review_id" : 1030621221,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/915211634/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-07T16:47:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/915211634",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r915214759"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/915214759"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit:\r\n```suggestion\r\n             \"%s: Failed to setup cursor SQL statement: %s\\n\", __func__ sqlite3_errstr(res)));\r\n```\r\n",
      "commit_id" : "431904b5c317917fad4c5171bebb14620fd1edec",
      "created_at" : "2022-07-06T20:09:24Z",
      "diff_hunk" : "@@ -506,10 +494,30 @@ bool SQLiteBatch::ReadAtCursor(CDataStream& key, CDataStream& value, bool& compl\n     return true;\n }\n \n-void SQLiteBatch::CloseCursor()\n+SQLiteCursor::~SQLiteCursor()\n {\n     sqlite3_reset(m_cursor_stmt);\n-    m_cursor_init = false;\n+    int res = sqlite3_finalize(m_cursor_stmt);\n+    if (res != SQLITE_OK) {\n+        LogPrintf(\"SQLiteBatch: cursor closed but could not finalize cursor statement: %s\\n\",\n+                  sqlite3_errstr(res));\n+    }\n+}\n+\n+std::unique_ptr<DatabaseCursor> SQLiteBatch::GetNewCursor()\n+{\n+    if (!m_database.m_db) return nullptr;\n+    std::unique_ptr<SQLiteCursor> cursor = std::make_unique<SQLiteCursor>();\n+    if (!cursor) return nullptr;\n+\n+    const char* stmt_text = \"SELECT key, value FROM main\";\n+    int res = sqlite3_prepare_v2(m_database.m_db, stmt_text, -1, &cursor->m_cursor_stmt, nullptr);\n+    if (res != SQLITE_OK) {\n+        throw std::runtime_error(strprintf(\n+            \"SQLiteDatabase: Failed to setup cursor SQL statement: %s\\n\", sqlite3_errstr(res)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r915214759",
      "id" : 915214759,
      "line" : 556,
      "node_id" : "PRRC_kwDOABII5842jRGn",
      "original_commit_id" : "d1316204a783a1eed1ef6b7d7fe0680c5b6368d3",
      "original_line" : 556,
      "original_position" : 72,
      "original_start_line" : null,
      "path" : "src/wallet/sqlite.cpp",
      "position" : 115,
      "pull_request_review_id" : 1030621221,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/915214759/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-07T16:47:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/915214759",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r915838986"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/915838986"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit:\r\ncould default initialize `m_first` in the field declaration.",
      "commit_id" : "431904b5c317917fad4c5171bebb14620fd1edec",
      "created_at" : "2022-07-07T12:54:35Z",
      "diff_hunk" : "@@ -655,7 +655,8 @@ void BerkeleyDatabase::ReloadDbEnv()\n     env->ReloadDbEnv();\n }\n \n-BerkeleyCursor::BerkeleyCursor(BerkeleyDatabase& database)\n+BerkeleyCursor::BerkeleyCursor(BerkeleyDatabase& database, Span<std::byte> prefix)\n+    : m_key_prefix(prefix.begin(), prefix.end()), m_first(true)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r915838986",
      "id" : 915838986,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5842lpgK",
      "original_commit_id" : "72089765046bff6ade39f2c4f7763da9467b1494",
      "original_line" : 659,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/bdb.cpp",
      "position" : null,
      "pull_request_review_id" : 1030621221,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/915838986/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-07T16:47:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/915838986",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r915997364"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/915997364"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In 72089765:\r\n\r\nWith this code, at the end of the range, `Next` returns one extra element pair that is not part of the range set. So, if the `complete` flag is not checked by the caller first and the `ssValue` tries to be unserialized, a runtime error will be thrown (different value type).\r\n\r\nWould suggest to move this block above the `ssKey` and `ssValue` return values sets; so the function doesn't return elements that aren't in the filtered range, and directly return false:\r\n\r\n```c++\r\nSpan<const std::byte> raw_key = {AsBytePtr(datKey.get_data()), datKey.get_size()};\r\nif (!m_key_prefix.empty() && std::mismatch(raw_key.begin(), raw_key.end(), m_key_prefix.begin(), m_key_prefix.end()).second != m_key_prefix.end()) {\r\n    complete = true;\r\n    return false;\r\n}\r\n\r\nssKey.SetType(SER_DISK);\r\nssKey.clear();\r\nssKey.write(raw_key);\r\n// bla bla, all good..\r\nreturn true;\r\n```\r\n\r\nCommit here: https://github.com/furszy/bitcoin/commit/e4b37e82ed19ff103f295ac5897e33e80e2f0679",
      "commit_id" : "431904b5c317917fad4c5171bebb14620fd1edec",
      "created_at" : "2022-07-07T15:17:36Z",
      "diff_hunk" : "@@ -685,6 +692,11 @@ bool BerkeleyCursor::Next(CDataStream& ssKey, CDataStream& ssValue, bool& comple\n     ssValue.SetType(SER_DISK);\n     ssValue.clear();\n     ssValue.write({AsBytePtr(datValue.get_data()), datValue.get_size()});\n+\n+    if (!m_key_prefix.empty() && std::mismatch(ssKey.begin(), ssKey.end(), m_key_prefix.begin(), m_key_prefix.end()).second != m_key_prefix.end()) {\n+        complete = true;\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r915997364",
      "id" : 915997364,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5842mQK0",
      "original_commit_id" : "72089765046bff6ade39f2c4f7763da9467b1494",
      "original_line" : 698,
      "original_position" : 35,
      "original_start_line" : 696,
      "path" : "src/wallet/bdb.cpp",
      "position" : null,
      "pull_request_review_id" : 1030621221,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/915997364/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-07-07T16:47:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/915997364",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r916120588"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/916120588"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I tried doing that but kept running into issues with allocating the memory for it as the underlying object would have to survive the scope in which it was originally created. It was just easier to do it in the struct directly.",
      "commit_id" : "431904b5c317917fad4c5171bebb14620fd1edec",
      "created_at" : "2022-07-07T17:30:28Z",
      "diff_hunk" : "@@ -14,19 +14,27 @@ struct bilingual_str;\n namespace wallet {\n class SQLiteDatabase;\n \n+class SQLiteCursor : public DatabaseCursor\n+{\n+public:\n+    sqlite3_stmt* m_cursor_stmt{nullptr};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r916120588",
      "id" : 916120588,
      "in_reply_to_id" : 915208527,
      "line" : 21,
      "node_id" : "PRRC_kwDOABII5842muQM",
      "original_commit_id" : "d1316204a783a1eed1ef6b7d7fe0680c5b6368d3",
      "original_line" : 21,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/wallet/sqlite.h",
      "position" : 8,
      "pull_request_review_id" : 1031933364,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/916120588/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-07T17:32:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/916120588",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r916123506"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/916123506"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Leaving it as belt-and-suspenders in case something happens to it in the future.",
      "commit_id" : "431904b5c317917fad4c5171bebb14620fd1edec",
      "created_at" : "2022-07-07T17:34:13Z",
      "diff_hunk" : "@@ -690,13 +688,19 @@ bool BerkeleyBatch::ReadAtCursor(CDataStream& ssKey, CDataStream& ssValue, bool&\n     return true;\n }\n \n-void BerkeleyBatch::CloseCursor()\n+BerkeleyCursor::~BerkeleyCursor()\n {\n     if (!m_cursor) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r916123506",
      "id" : 916123506,
      "in_reply_to_id" : 915204516,
      "line" : 707,
      "node_id" : "PRRC_kwDOABII5842mu9y",
      "original_commit_id" : "d1316204a783a1eed1ef6b7d7fe0680c5b6368d3",
      "original_line" : 707,
      "original_position" : 38,
      "original_start_line" : 691,
      "path" : "src/wallet/bdb.cpp",
      "position" : 146,
      "pull_request_review_id" : 1031937519,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/916123506/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 705,
      "start_side" : "RIGHT",
      "updated_at" : "2022-07-07T17:34:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/916123506",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r916138045"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/916138045"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "431904b5c317917fad4c5171bebb14620fd1edec",
      "created_at" : "2022-07-07T17:52:12Z",
      "diff_hunk" : "@@ -472,27 +470,17 @@ bool SQLiteBatch::HasKey(CDataStream&& key)\n     return res == SQLITE_ROW;\n }\n \n-bool SQLiteBatch::StartCursor()\n-{\n-    assert(!m_cursor_init);\n-    if (!m_database.m_db) return false;\n-    m_cursor_init = true;\n-    return true;\n-}\n-\n-bool SQLiteBatch::ReadAtCursor(CDataStream& key, CDataStream& value, bool& complete)\n+bool SQLiteCursor::Next(CDataStream& key, CDataStream& value, bool& complete)\n {\n     complete = false;\n \n-    if (!m_cursor_init) return false;\n-\n     int res = sqlite3_step(m_cursor_stmt);\n     if (res == SQLITE_DONE) {\n         complete = true;\n         return true;\n     }\n     if (res != SQLITE_ROW) {\n-        LogPrintf(\"SQLiteBatch::ReadAtCursor: Unable to execute cursor step: %s\\n\", sqlite3_errstr(res));\n+        LogPrintf(\"SQLiteCursor::Next: Unable to execute cursor step: %s\\n\", sqlite3_errstr(res));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r916138045",
      "id" : 916138045,
      "in_reply_to_id" : 915201717,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5842myg9",
      "original_commit_id" : "d1316204a783a1eed1ef6b7d7fe0680c5b6368d3",
      "original_line" : 483,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/wallet/sqlite.cpp",
      "position" : null,
      "pull_request_review_id" : 1031959758,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/916138045/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-07T17:52:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/916138045",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r916138094"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/916138094"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "431904b5c317917fad4c5171bebb14620fd1edec",
      "created_at" : "2022-07-07T17:52:16Z",
      "diff_hunk" : "@@ -506,10 +494,30 @@ bool SQLiteBatch::ReadAtCursor(CDataStream& key, CDataStream& value, bool& compl\n     return true;\n }\n \n-void SQLiteBatch::CloseCursor()\n+SQLiteCursor::~SQLiteCursor()\n {\n     sqlite3_reset(m_cursor_stmt);\n-    m_cursor_init = false;\n+    int res = sqlite3_finalize(m_cursor_stmt);\n+    if (res != SQLITE_OK) {\n+        LogPrintf(\"SQLiteBatch: cursor closed but could not finalize cursor statement: %s\\n\",\n+                  sqlite3_errstr(res));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r916138094",
      "id" : 916138094,
      "in_reply_to_id" : 915202937,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5842myhu",
      "original_commit_id" : "d1316204a783a1eed1ef6b7d7fe0680c5b6368d3",
      "original_line" : 503,
      "original_position" : 58,
      "original_start_line" : 502,
      "path" : "src/wallet/sqlite.cpp",
      "position" : null,
      "pull_request_review_id" : 1031959911,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/916138094/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-07-07T17:52:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/916138094",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r916138191"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/916138191"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "431904b5c317917fad4c5171bebb14620fd1edec",
      "created_at" : "2022-07-07T17:52:23Z",
      "diff_hunk" : "@@ -506,10 +494,30 @@ bool SQLiteBatch::ReadAtCursor(CDataStream& key, CDataStream& value, bool& compl\n     return true;\n }\n \n-void SQLiteBatch::CloseCursor()\n+SQLiteCursor::~SQLiteCursor()\n {\n     sqlite3_reset(m_cursor_stmt);\n-    m_cursor_init = false;\n+    int res = sqlite3_finalize(m_cursor_stmt);\n+    if (res != SQLITE_OK) {\n+        LogPrintf(\"SQLiteBatch: cursor closed but could not finalize cursor statement: %s\\n\",\n+                  sqlite3_errstr(res));\n+    }\n+}\n+\n+std::unique_ptr<DatabaseCursor> SQLiteBatch::GetNewCursor()\n+{\n+    if (!m_database.m_db) return nullptr;\n+    std::unique_ptr<SQLiteCursor> cursor = std::make_unique<SQLiteCursor>();\n+    if (!cursor) return nullptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r916138191",
      "id" : 916138191,
      "in_reply_to_id" : 915211634,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5842myjP",
      "original_commit_id" : "d1316204a783a1eed1ef6b7d7fe0680c5b6368d3",
      "original_line" : 511,
      "original_position" : 66,
      "original_start_line" : null,
      "path" : "src/wallet/sqlite.cpp",
      "position" : null,
      "pull_request_review_id" : 1031960169,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/916138191/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-07T17:52:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/916138191",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r916138244"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/916138244"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "431904b5c317917fad4c5171bebb14620fd1edec",
      "created_at" : "2022-07-07T17:52:27Z",
      "diff_hunk" : "@@ -506,10 +494,30 @@ bool SQLiteBatch::ReadAtCursor(CDataStream& key, CDataStream& value, bool& compl\n     return true;\n }\n \n-void SQLiteBatch::CloseCursor()\n+SQLiteCursor::~SQLiteCursor()\n {\n     sqlite3_reset(m_cursor_stmt);\n-    m_cursor_init = false;\n+    int res = sqlite3_finalize(m_cursor_stmt);\n+    if (res != SQLITE_OK) {\n+        LogPrintf(\"SQLiteBatch: cursor closed but could not finalize cursor statement: %s\\n\",\n+                  sqlite3_errstr(res));\n+    }\n+}\n+\n+std::unique_ptr<DatabaseCursor> SQLiteBatch::GetNewCursor()\n+{\n+    if (!m_database.m_db) return nullptr;\n+    std::unique_ptr<SQLiteCursor> cursor = std::make_unique<SQLiteCursor>();\n+    if (!cursor) return nullptr;\n+\n+    const char* stmt_text = \"SELECT key, value FROM main\";\n+    int res = sqlite3_prepare_v2(m_database.m_db, stmt_text, -1, &cursor->m_cursor_stmt, nullptr);\n+    if (res != SQLITE_OK) {\n+        throw std::runtime_error(strprintf(\n+            \"SQLiteDatabase: Failed to setup cursor SQL statement: %s\\n\", sqlite3_errstr(res)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r916138244",
      "id" : 916138244,
      "in_reply_to_id" : 915214759,
      "line" : 556,
      "node_id" : "PRRC_kwDOABII5842mykE",
      "original_commit_id" : "d1316204a783a1eed1ef6b7d7fe0680c5b6368d3",
      "original_line" : 556,
      "original_position" : 72,
      "original_start_line" : null,
      "path" : "src/wallet/sqlite.cpp",
      "position" : 115,
      "pull_request_review_id" : 1031960327,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/916138244/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-07T17:52:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/916138244",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r916138289"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/916138289"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "431904b5c317917fad4c5171bebb14620fd1edec",
      "created_at" : "2022-07-07T17:52:31Z",
      "diff_hunk" : "@@ -655,7 +655,8 @@ void BerkeleyDatabase::ReloadDbEnv()\n     env->ReloadDbEnv();\n }\n \n-BerkeleyCursor::BerkeleyCursor(BerkeleyDatabase& database)\n+BerkeleyCursor::BerkeleyCursor(BerkeleyDatabase& database, Span<std::byte> prefix)\n+    : m_key_prefix(prefix.begin(), prefix.end()), m_first(true)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r916138289",
      "id" : 916138289,
      "in_reply_to_id" : 915838986,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5842mykx",
      "original_commit_id" : "72089765046bff6ade39f2c4f7763da9467b1494",
      "original_line" : 659,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/bdb.cpp",
      "position" : null,
      "pull_request_review_id" : 1031960489,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/916138289/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-07T17:52:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/916138289",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r916138519"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/916138519"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "431904b5c317917fad4c5171bebb14620fd1edec",
      "created_at" : "2022-07-07T17:52:48Z",
      "diff_hunk" : "@@ -685,6 +692,11 @@ bool BerkeleyCursor::Next(CDataStream& ssKey, CDataStream& ssValue, bool& comple\n     ssValue.SetType(SER_DISK);\n     ssValue.clear();\n     ssValue.write({AsBytePtr(datValue.get_data()), datValue.get_size()});\n+\n+    if (!m_key_prefix.empty() && std::mismatch(ssKey.begin(), ssKey.end(), m_key_prefix.begin(), m_key_prefix.end()).second != m_key_prefix.end()) {\n+        complete = true;\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r916138519",
      "id" : 916138519,
      "in_reply_to_id" : 915997364,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5842myoX",
      "original_commit_id" : "72089765046bff6ade39f2c4f7763da9467b1494",
      "original_line" : 698,
      "original_position" : 35,
      "original_start_line" : 696,
      "path" : "src/wallet/bdb.cpp",
      "position" : null,
      "pull_request_review_id" : 1031961177,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/916138519/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-07-07T17:52:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/916138519",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@furszy Thanks for the review. I've pulled in your test commit.\r\n\r\nOn the topic of the return values for `Next`, I'm not a fan of the current interface and I think it could be improved/rewritten with optionals. Mainly the problem is distinguishing between an error and being done.",
      "created_at" : "2022-07-07T17:54:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#issuecomment-1178002305",
      "id" : 1178002305,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24914",
      "node_id" : "IC_kwDOABII585GNuOB",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1178002305/reactions"
      },
      "updated_at" : "2022-07-07T17:54:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1178002305",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> On the topic of the return values for Next, I'm not a fan of the current interface and I think it could be improved/rewritten with optionals. Mainly the problem is distinguishing between an error and being done.\r\n\r\nProbably we could return a three states enum instead. So we can get rid of that ugly `complete` ref arg.\r\n(but yeah, no need to add it here)",
      "created_at" : "2022-07-08T12:38:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#issuecomment-1178941634",
      "id" : 1178941634,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24914",
      "node_id" : "IC_kwDOABII585GRTjC",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1178941634/reactions"
      },
      "updated_at" : "2022-07-08T12:39:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1178941634",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r922170911"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922170911"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit:\r\n```suggestion\r\n    ssKey.write(raw_key);\r\n```",
      "commit_id" : "431904b5c317917fad4c5171bebb14620fd1edec",
      "created_at" : "2022-07-15T13:33:48Z",
      "diff_hunk" : "@@ -678,13 +685,20 @@ bool BerkeleyCursor::Next(CDataStream& ssKey, CDataStream& ssValue, bool& comple\n     else if (datKey.get_data() == nullptr || datValue.get_data() == nullptr)\n         return false;\n \n+    Span<const std::byte> raw_key = {AsBytePtr(datKey.get_data()), datKey.get_size()};\n+    if (!m_key_prefix.empty() && std::mismatch(raw_key.begin(), raw_key.end(), m_key_prefix.begin(), m_key_prefix.end()).second != m_key_prefix.end()) {\n+        complete = true;\n+        return false;\n+    }\n+\n     // Convert to streams\n     ssKey.SetType(SER_DISK);\n     ssKey.clear();\n     ssKey.write({AsBytePtr(datKey.get_data()), datKey.get_size()});",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r922170911",
      "id" : 922170911,
      "line" : 697,
      "node_id" : "PRRC_kwDOABII58429zYf",
      "original_commit_id" : "c704f8348820eeabf8e1230d81e026a14fd8b3fc",
      "original_line" : 697,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "src/wallet/bdb.cpp",
      "position" : 41,
      "pull_request_review_id" : 1040304045,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922170911/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-15T19:19:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922170911",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r922172352"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922172352"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "this change shouldn't be needed.",
      "commit_id" : "431904b5c317917fad4c5171bebb14620fd1edec",
      "created_at" : "2022-07-15T13:35:30Z",
      "diff_hunk" : "@@ -187,11 +187,16 @@ class SafeDbt final\n \n class BerkeleyCursor : public DatabaseCursor\n {\n-private:\n+protected:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r922172352",
      "id" : 922172352,
      "line" : 190,
      "node_id" : "PRRC_kwDOABII58429zvA",
      "original_commit_id" : "c704f8348820eeabf8e1230d81e026a14fd8b3fc",
      "original_line" : 190,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/bdb.h",
      "position" : 5,
      "pull_request_review_id" : 1040304045,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922172352/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-15T19:19:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922172352",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r922394666"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922394666"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: unnecessary set. `m_result` member is default initialized to `LOAD_OK`.",
      "commit_id" : "431904b5c317917fad4c5171bebb14620fd1edec",
      "created_at" : "2022-07-15T17:49:17Z",
      "diff_hunk" : "@@ -828,12 +733,255 @@ static DBErrors LoadWalletFlags(CWallet* pwallet, DatabaseBatch& batch) EXCLUSIV\n     return DBErrors::LOAD_OK;\n }\n \n+struct LoadResult\n+{\n+    DBErrors m_result{DBErrors::LOAD_OK};\n+    std::string m_error{};\n+    int m_records{0};\n+};\n+\n+using LoadFunc = std::function<DBErrors(CWallet* pwallet, CDataStream& key, CDataStream& value, std::string& err)>;\n+static LoadResult LoadRecords(CWallet* pwallet, DatabaseBatch& batch, const std::string& key, LoadFunc load_func)\n+{\n+    LoadResult result;\n+    CDataStream ssKey(SER_DISK, CLIENT_VERSION);\n+    CDataStream ssValue(SER_DISK, CLIENT_VERSION);\n+\n+    CDataStream prefix(0, 0);\n+    prefix << key;\n+    std::unique_ptr<DatabaseCursor> cursor = batch.GetNewPrefixCursor(prefix);\n+    if (!cursor) {\n+        pwallet->WalletLogPrintf(\"Error getting database cursor for '%s' records\\n\", key);\n+        result.m_result = DBErrors::CORRUPT;\n+        return result;\n+    }\n+\n+    result.m_result = DBErrors::LOAD_OK;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r922394666",
      "id" : 922394666,
      "line" : 492,
      "node_id" : "PRRC_kwDOABII5842-qAq",
      "original_commit_id" : "ba1d48a2939570ea369554ff790c12300e9fd7b1",
      "original_line" : 759,
      "original_position" : 155,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 155,
      "pull_request_review_id" : 1040304045,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922394666/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-15T19:19:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922394666",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r922401748"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922401748"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`LoadRecords` now is logging this:\r\n```suggestion\r\n            err = \"Error reading wallet database: LegacyScriptPubKeyMan::LoadCScript failed\\n\";\r\n```",
      "commit_id" : "431904b5c317917fad4c5171bebb14620fd1edec",
      "created_at" : "2022-07-15T17:59:05Z",
      "diff_hunk" : "@@ -828,12 +733,255 @@ static DBErrors LoadWalletFlags(CWallet* pwallet, DatabaseBatch& batch) EXCLUSIV\n     return DBErrors::LOAD_OK;\n }\n \n+struct LoadResult\n+{\n+    DBErrors m_result{DBErrors::LOAD_OK};\n+    std::string m_error{};\n+    int m_records{0};\n+};\n+\n+using LoadFunc = std::function<DBErrors(CWallet* pwallet, CDataStream& key, CDataStream& value, std::string& err)>;\n+static LoadResult LoadRecords(CWallet* pwallet, DatabaseBatch& batch, const std::string& key, LoadFunc load_func)\n+{\n+    LoadResult result;\n+    CDataStream ssKey(SER_DISK, CLIENT_VERSION);\n+    CDataStream ssValue(SER_DISK, CLIENT_VERSION);\n+\n+    CDataStream prefix(0, 0);\n+    prefix << key;\n+    std::unique_ptr<DatabaseCursor> cursor = batch.GetNewPrefixCursor(prefix);\n+    if (!cursor) {\n+        pwallet->WalletLogPrintf(\"Error getting database cursor for '%s' records\\n\", key);\n+        result.m_result = DBErrors::CORRUPT;\n+        return result;\n+    }\n+\n+    result.m_result = DBErrors::LOAD_OK;\n+    while (true) {\n+        bool complete;\n+        bool ret = cursor->Next(ssKey, ssValue, complete);\n+        if (complete) {\n+            break;\n+        } else if (!ret) {\n+            pwallet->WalletLogPrintf(\"Error reading next '%s' record for wallet database\\n\", key);\n+            result.m_result = DBErrors::CORRUPT;\n+            return result;\n+        }\n+        std::string type;\n+        ssKey >> type;\n+        assert(type == key);\n+        if ((result.m_result = std::max(result.m_result, load_func(pwallet, ssKey, ssValue, result.m_error))) == DBErrors::CORRUPT) {\n+            pwallet->WalletLogPrintf(\"%s\\n\", result.m_error);\n+        }\n+        ++result.m_records;\n+    }\n+    return result;\n+}\n+\n+static DBErrors LoadLegacyWalletRecords(CWallet* pwallet, DatabaseBatch& batch, int last_client) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    AssertLockHeld(pwallet->cs_wallet);\n+    DBErrors result = DBErrors::LOAD_OK;\n+\n+    // Load HD Chain\n+    CHDChain chain;\n+    if (batch.Read(DBKeys::HDCHAIN, chain)) {\n+        pwallet->GetOrCreateLegacyScriptPubKeyMan()->LoadHDChain(chain);\n+    }\n+\n+    // Load unencrypted keys\n+    LoadResult key_res = LoadRecords(pwallet, batch, DBKeys::KEY,\n+        [] (CWallet* pwallet, CDataStream& key, CDataStream& value, std::string& err) {\n+        if (!LoadKey(pwallet, key, value, err)) {\n+            return DBErrors::CORRUPT;\n+        }\n+        return DBErrors::LOAD_OK;\n+    });\n+    result = std::max(result, key_res.m_result);\n+\n+    // Load encrypted keys\n+    LoadResult ckey_res = LoadRecords(pwallet, batch, DBKeys::CRYPTED_KEY,\n+        [] (CWallet* pwallet, CDataStream& key, CDataStream& value, std::string& err) {\n+        if (!LoadCryptedKey(pwallet, key, value, err)) {\n+            return DBErrors::CORRUPT;\n+        }\n+        return DBErrors::LOAD_OK;\n+    });\n+    result = std::max(result, ckey_res.m_result);\n+\n+    // Load scripts\n+    LoadResult script_res = LoadRecords(pwallet, batch, DBKeys::CSCRIPT,\n+        [] (CWallet* pwallet, CDataStream& key, CDataStream& value, std::string& err) {\n+        uint160 hash;\n+        key >> hash;\n+        CScript script;\n+        value >> script;\n+        if (!pwallet->GetOrCreateLegacyScriptPubKeyMan()->LoadCScript(script))\n+        {\n+            pwallet->WalletLogPrintf(\"Error reading wallet database: LegacyScriptPubKeyMan::LoadCScript failed\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r922401748",
      "id" : 922401748,
      "line" : 561,
      "node_id" : "PRRC_kwDOABII5842-rvU",
      "original_commit_id" : "ba1d48a2939570ea369554ff790c12300e9fd7b1",
      "original_line" : 821,
      "original_position" : 217,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 217,
      "pull_request_review_id" : 1040304045,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922401748/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-15T19:19:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922401748",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r922403557"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922403557"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Why not return early here?:\r\n```c++\r\nif (key_res.m_result != DBErrors::LOAD_OK) {\r\n    return key_res.m_result;\r\n}\r\n```\r\n\r\n(Same for the crypted keys)",
      "commit_id" : "431904b5c317917fad4c5171bebb14620fd1edec",
      "created_at" : "2022-07-15T18:01:54Z",
      "diff_hunk" : "@@ -828,12 +733,255 @@ static DBErrors LoadWalletFlags(CWallet* pwallet, DatabaseBatch& batch) EXCLUSIV\n     return DBErrors::LOAD_OK;\n }\n \n+struct LoadResult\n+{\n+    DBErrors m_result{DBErrors::LOAD_OK};\n+    std::string m_error{};\n+    int m_records{0};\n+};\n+\n+using LoadFunc = std::function<DBErrors(CWallet* pwallet, CDataStream& key, CDataStream& value, std::string& err)>;\n+static LoadResult LoadRecords(CWallet* pwallet, DatabaseBatch& batch, const std::string& key, LoadFunc load_func)\n+{\n+    LoadResult result;\n+    CDataStream ssKey(SER_DISK, CLIENT_VERSION);\n+    CDataStream ssValue(SER_DISK, CLIENT_VERSION);\n+\n+    CDataStream prefix(0, 0);\n+    prefix << key;\n+    std::unique_ptr<DatabaseCursor> cursor = batch.GetNewPrefixCursor(prefix);\n+    if (!cursor) {\n+        pwallet->WalletLogPrintf(\"Error getting database cursor for '%s' records\\n\", key);\n+        result.m_result = DBErrors::CORRUPT;\n+        return result;\n+    }\n+\n+    result.m_result = DBErrors::LOAD_OK;\n+    while (true) {\n+        bool complete;\n+        bool ret = cursor->Next(ssKey, ssValue, complete);\n+        if (complete) {\n+            break;\n+        } else if (!ret) {\n+            pwallet->WalletLogPrintf(\"Error reading next '%s' record for wallet database\\n\", key);\n+            result.m_result = DBErrors::CORRUPT;\n+            return result;\n+        }\n+        std::string type;\n+        ssKey >> type;\n+        assert(type == key);\n+        if ((result.m_result = std::max(result.m_result, load_func(pwallet, ssKey, ssValue, result.m_error))) == DBErrors::CORRUPT) {\n+            pwallet->WalletLogPrintf(\"%s\\n\", result.m_error);\n+        }\n+        ++result.m_records;\n+    }\n+    return result;\n+}\n+\n+static DBErrors LoadLegacyWalletRecords(CWallet* pwallet, DatabaseBatch& batch, int last_client) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    AssertLockHeld(pwallet->cs_wallet);\n+    DBErrors result = DBErrors::LOAD_OK;\n+\n+    // Load HD Chain\n+    CHDChain chain;\n+    if (batch.Read(DBKeys::HDCHAIN, chain)) {\n+        pwallet->GetOrCreateLegacyScriptPubKeyMan()->LoadHDChain(chain);\n+    }\n+\n+    // Load unencrypted keys\n+    LoadResult key_res = LoadRecords(pwallet, batch, DBKeys::KEY,\n+        [] (CWallet* pwallet, CDataStream& key, CDataStream& value, std::string& err) {\n+        if (!LoadKey(pwallet, key, value, err)) {\n+            return DBErrors::CORRUPT;\n+        }\n+        return DBErrors::LOAD_OK;\n+    });\n+    result = std::max(result, key_res.m_result);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r922403557",
      "id" : 922403557,
      "line" : 540,
      "node_id" : "PRRC_kwDOABII5842-sLl",
      "original_commit_id" : "ba1d48a2939570ea369554ff790c12300e9fd7b1",
      "original_line" : 800,
      "original_position" : 196,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 196,
      "pull_request_review_id" : 1040304045,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922403557/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-15T19:19:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922403557",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r922436250"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922436250"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`LoadRecords` logs the corrupt errors.\r\n```suggestion\r\n                err = \"Error reading wallet database: descriptor unencrypted key CPubKey corrupt\\n\";\r\n```\r\n\r\n(Same for the other ones below)",
      "commit_id" : "431904b5c317917fad4c5171bebb14620fd1edec",
      "created_at" : "2022-07-15T18:46:46Z",
      "diff_hunk" : "@@ -974,6 +887,171 @@ static DBErrors LoadLegacyWalletRecords(CWallet* pwallet, DatabaseBatch& batch,\n     return result;\n }\n \n+template<typename... Args>\n+static CDataStream PrefixStream(const Args&... args)\n+{\n+    CDataStream prefix(0, 0);\n+    SerializeMany(prefix, args...);\n+    return prefix;\n+}\n+\n+static DBErrors LoadDescriptorWalletRecords(CWallet* pwallet, DatabaseBatch& batch) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    AssertLockHeld(pwallet->cs_wallet);\n+\n+    // Load descriptor record\n+    int num_keys = 0;\n+    int num_ckeys= 0;\n+    LoadResult desc_res = LoadRecords(pwallet, batch, DBKeys::WALLETDESCRIPTOR,\n+        [&batch, &num_keys, &num_ckeys] (CWallet* pwallet, CDataStream& key, CDataStream& value, std::string& err) {\n+        uint256 id;\n+        key >> id;\n+        WalletDescriptor desc;\n+        value >> desc;\n+        pwallet->LoadDescriptorScriptPubKeyMan(id, desc);\n+\n+        DescriptorCache cache;\n+\n+        // Get key cache for this descriptor\n+        CDataStream prefix = PrefixStream(DBKeys::WALLETDESCRIPTORCACHE, id);\n+        LoadResult key_cache_res = LoadRecords(pwallet, batch, DBKeys::WALLETDESCRIPTORCACHE, prefix,\n+            [&id, &cache] (CWallet* pwallet, CDataStream& key, CDataStream& value, std::string& err) {\n+            bool parent = true;\n+            uint256 desc_id;\n+            uint32_t key_exp_index;\n+            uint32_t der_index;\n+            key >> desc_id;\n+            assert(desc_id == id);\n+            key >> key_exp_index;\n+\n+            // if the der_index exists, it's a derived xpub\n+            try\n+            {\n+                key >> der_index;\n+                parent = false;\n+            }\n+            catch (...) {}\n+\n+            std::vector<unsigned char> ser_xpub(BIP32_EXTKEY_SIZE);\n+            value >> ser_xpub;\n+            CExtPubKey xpub;\n+            xpub.Decode(ser_xpub.data());\n+            if (parent) {\n+                cache.CacheParentExtPubKey(key_exp_index, xpub);\n+            } else {\n+                cache.CacheDerivedExtPubKey(key_exp_index, der_index, xpub);\n+            }\n+            return DBErrors::LOAD_OK;\n+        });\n+\n+        // Get last hardened cache for this descriptor\n+        prefix = PrefixStream(DBKeys::WALLETDESCRIPTORLHCACHE, id);\n+        LoadResult lh_cache_res = LoadRecords(pwallet, batch, DBKeys::WALLETDESCRIPTORLHCACHE, prefix,\n+            [&id, &cache] (CWallet* pwallet, CDataStream& key, CDataStream& value, std::string& err) {\n+            uint256 desc_id;\n+            uint32_t key_exp_index;\n+            key >> desc_id;\n+            assert(desc_id == id);\n+            key >> key_exp_index;\n+\n+            std::vector<unsigned char> ser_xpub(BIP32_EXTKEY_SIZE);\n+            value >> ser_xpub;\n+            CExtPubKey xpub;\n+            xpub.Decode(ser_xpub.data());\n+            cache.CacheLastHardenedExtPubKey(key_exp_index, xpub);\n+            return DBErrors::LOAD_OK;\n+        });\n+\n+        // Set the cache for this descriptor\n+        auto spk_man = (DescriptorScriptPubKeyMan*)pwallet->GetScriptPubKeyMan(id);\n+        assert(spk_man);\n+        spk_man->SetCache(cache);\n+\n+        // Get unencrypted keys\n+        std::map<CKeyID, CKey> descriptor_keys;\n+        prefix = PrefixStream(DBKeys::WALLETDESCRIPTORKEY, id);\n+        LoadResult key_res = LoadRecords(pwallet, batch, DBKeys::WALLETDESCRIPTORKEY, prefix,\n+            [&id, &num_keys, &descriptor_keys] (CWallet* pwallet, CDataStream& key, CDataStream& value, std::string& err) {\n+            uint256 desc_id;\n+            CPubKey pubkey;\n+            key >> desc_id;\n+            assert(desc_id == id);\n+            key >> pubkey;\n+            if (!pubkey.IsValid())\n+            {\n+                pwallet->WalletLogPrintf(\"Error reading wallet database: descriptor unencrypted key CPubKey corrupt\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r922436250",
      "id" : 922436250,
      "line" : 828,
      "node_id" : "PRRC_kwDOABII5842-0Ka",
      "original_commit_id" : "369a042c738f71c88038584ff392f4ac8121b087",
      "original_line" : 982,
      "original_position" : 229,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 229,
      "pull_request_review_id" : 1040304045,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922436250/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-15T19:19:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922436250",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r922440904"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922440904"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Same as above here:\r\n```c++\r\nspk_man->AddCryptedKey(pubkey.GetID(), pubkey, privkey);\r\n```",
      "commit_id" : "431904b5c317917fad4c5171bebb14620fd1edec",
      "created_at" : "2022-07-15T18:54:01Z",
      "diff_hunk" : "@@ -974,6 +887,171 @@ static DBErrors LoadLegacyWalletRecords(CWallet* pwallet, DatabaseBatch& batch,\n     return result;\n }\n \n+template<typename... Args>\n+static CDataStream PrefixStream(const Args&... args)\n+{\n+    CDataStream prefix(0, 0);\n+    SerializeMany(prefix, args...);\n+    return prefix;\n+}\n+\n+static DBErrors LoadDescriptorWalletRecords(CWallet* pwallet, DatabaseBatch& batch) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    AssertLockHeld(pwallet->cs_wallet);\n+\n+    // Load descriptor record\n+    int num_keys = 0;\n+    int num_ckeys= 0;\n+    LoadResult desc_res = LoadRecords(pwallet, batch, DBKeys::WALLETDESCRIPTOR,\n+        [&batch, &num_keys, &num_ckeys] (CWallet* pwallet, CDataStream& key, CDataStream& value, std::string& err) {\n+        uint256 id;\n+        key >> id;\n+        WalletDescriptor desc;\n+        value >> desc;\n+        pwallet->LoadDescriptorScriptPubKeyMan(id, desc);\n+\n+        DescriptorCache cache;\n+\n+        // Get key cache for this descriptor\n+        CDataStream prefix = PrefixStream(DBKeys::WALLETDESCRIPTORCACHE, id);\n+        LoadResult key_cache_res = LoadRecords(pwallet, batch, DBKeys::WALLETDESCRIPTORCACHE, prefix,\n+            [&id, &cache] (CWallet* pwallet, CDataStream& key, CDataStream& value, std::string& err) {\n+            bool parent = true;\n+            uint256 desc_id;\n+            uint32_t key_exp_index;\n+            uint32_t der_index;\n+            key >> desc_id;\n+            assert(desc_id == id);\n+            key >> key_exp_index;\n+\n+            // if the der_index exists, it's a derived xpub\n+            try\n+            {\n+                key >> der_index;\n+                parent = false;\n+            }\n+            catch (...) {}\n+\n+            std::vector<unsigned char> ser_xpub(BIP32_EXTKEY_SIZE);\n+            value >> ser_xpub;\n+            CExtPubKey xpub;\n+            xpub.Decode(ser_xpub.data());\n+            if (parent) {\n+                cache.CacheParentExtPubKey(key_exp_index, xpub);\n+            } else {\n+                cache.CacheDerivedExtPubKey(key_exp_index, der_index, xpub);\n+            }\n+            return DBErrors::LOAD_OK;\n+        });\n+\n+        // Get last hardened cache for this descriptor\n+        prefix = PrefixStream(DBKeys::WALLETDESCRIPTORLHCACHE, id);\n+        LoadResult lh_cache_res = LoadRecords(pwallet, batch, DBKeys::WALLETDESCRIPTORLHCACHE, prefix,\n+            [&id, &cache] (CWallet* pwallet, CDataStream& key, CDataStream& value, std::string& err) {\n+            uint256 desc_id;\n+            uint32_t key_exp_index;\n+            key >> desc_id;\n+            assert(desc_id == id);\n+            key >> key_exp_index;\n+\n+            std::vector<unsigned char> ser_xpub(BIP32_EXTKEY_SIZE);\n+            value >> ser_xpub;\n+            CExtPubKey xpub;\n+            xpub.Decode(ser_xpub.data());\n+            cache.CacheLastHardenedExtPubKey(key_exp_index, xpub);\n+            return DBErrors::LOAD_OK;\n+        });\n+\n+        // Set the cache for this descriptor\n+        auto spk_man = (DescriptorScriptPubKeyMan*)pwallet->GetScriptPubKeyMan(id);\n+        assert(spk_man);\n+        spk_man->SetCache(cache);\n+\n+        // Get unencrypted keys\n+        std::map<CKeyID, CKey> descriptor_keys;\n+        prefix = PrefixStream(DBKeys::WALLETDESCRIPTORKEY, id);\n+        LoadResult key_res = LoadRecords(pwallet, batch, DBKeys::WALLETDESCRIPTORKEY, prefix,\n+            [&id, &num_keys, &descriptor_keys] (CWallet* pwallet, CDataStream& key, CDataStream& value, std::string& err) {\n+            uint256 desc_id;\n+            CPubKey pubkey;\n+            key >> desc_id;\n+            assert(desc_id == id);\n+            key >> pubkey;\n+            if (!pubkey.IsValid())\n+            {\n+                pwallet->WalletLogPrintf(\"Error reading wallet database: descriptor unencrypted key CPubKey corrupt\\n\");\n+                return DBErrors::CORRUPT;\n+            }\n+            CKey privkey;\n+            CPrivKey pkey;\n+            uint256 hash;\n+\n+            num_keys++;\n+            value >> pkey;\n+            value >> hash;\n+\n+            // hash pubkey/privkey to accelerate wallet load\n+            std::vector<unsigned char> to_hash;\n+            to_hash.reserve(pubkey.size() + pkey.size());\n+            to_hash.insert(to_hash.end(), pubkey.begin(), pubkey.end());\n+            to_hash.insert(to_hash.end(), pkey.begin(), pkey.end());\n+\n+            if (Hash(to_hash) != hash)\n+            {\n+                pwallet->WalletLogPrintf(\"Error reading wallet database: descriptor unencrypted key CPubKey/CPrivKey corrupt\\n\");\n+                return DBErrors::CORRUPT;\n+            }\n+\n+            if (!privkey.Load(pkey, pubkey, true))\n+            {\n+                pwallet->WalletLogPrintf(\"Error reading wallet database: descriptor unencrypted key CPrivKey corrupt\\n\");\n+                return DBErrors::CORRUPT;\n+            }\n+            descriptor_keys.insert(std::make_pair(pubkey.GetID(), privkey));\n+            return DBErrors::LOAD_OK;\n+        });\n+        num_keys = key_res.m_records;\n+\n+        // Get encrypted keys\n+        std::map<CKeyID, std::pair<CPubKey, std::vector<unsigned char>>> descriptor_crypt_keys;\n+        prefix = PrefixStream(DBKeys::WALLETDESCRIPTORCKEY, id);\n+        LoadResult ckey_res = LoadRecords(pwallet, batch, DBKeys::WALLETDESCRIPTORCKEY, prefix,\n+            [&id, &num_ckeys, &descriptor_crypt_keys] (CWallet* pwallet, CDataStream& key, CDataStream& value, std::string& err) {\n+            uint256 desc_id;\n+            CPubKey pubkey;\n+            key >> desc_id;\n+            assert(desc_id == id);\n+            key >> pubkey;\n+            if (!pubkey.IsValid())\n+            {\n+                pwallet->WalletLogPrintf(\"Error reading wallet database: descriptor encrypted key CPubKey corrupt\\n\");\n+                return DBErrors::CORRUPT;\n+            }\n+            std::vector<unsigned char> privkey;\n+            value >> privkey;\n+            num_ckeys++;\n+\n+            descriptor_crypt_keys.insert(std::make_pair(pubkey.GetID(), std::make_pair(pubkey, privkey)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r922440904",
      "id" : 922440904,
      "line" : 880,
      "node_id" : "PRRC_kwDOABII5842-1TI",
      "original_commit_id" : "369a042c738f71c88038584ff392f4ac8121b087",
      "original_line" : 1034,
      "original_position" : 281,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 281,
      "pull_request_review_id" : 1040304045,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922440904/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-15T19:19:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922440904",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r922442482"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922442482"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "could remove this two loops, the map and vector need If the keys are added to the spkm inside each `LoadRecords` (check above, left a comment there).",
      "commit_id" : "431904b5c317917fad4c5171bebb14620fd1edec",
      "created_at" : "2022-07-15T18:56:25Z",
      "diff_hunk" : "@@ -974,6 +887,171 @@ static DBErrors LoadLegacyWalletRecords(CWallet* pwallet, DatabaseBatch& batch,\n     return result;\n }\n \n+template<typename... Args>\n+static CDataStream PrefixStream(const Args&... args)\n+{\n+    CDataStream prefix(0, 0);\n+    SerializeMany(prefix, args...);\n+    return prefix;\n+}\n+\n+static DBErrors LoadDescriptorWalletRecords(CWallet* pwallet, DatabaseBatch& batch) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    AssertLockHeld(pwallet->cs_wallet);\n+\n+    // Load descriptor record\n+    int num_keys = 0;\n+    int num_ckeys= 0;\n+    LoadResult desc_res = LoadRecords(pwallet, batch, DBKeys::WALLETDESCRIPTOR,\n+        [&batch, &num_keys, &num_ckeys] (CWallet* pwallet, CDataStream& key, CDataStream& value, std::string& err) {\n+        uint256 id;\n+        key >> id;\n+        WalletDescriptor desc;\n+        value >> desc;\n+        pwallet->LoadDescriptorScriptPubKeyMan(id, desc);\n+\n+        DescriptorCache cache;\n+\n+        // Get key cache for this descriptor\n+        CDataStream prefix = PrefixStream(DBKeys::WALLETDESCRIPTORCACHE, id);\n+        LoadResult key_cache_res = LoadRecords(pwallet, batch, DBKeys::WALLETDESCRIPTORCACHE, prefix,\n+            [&id, &cache] (CWallet* pwallet, CDataStream& key, CDataStream& value, std::string& err) {\n+            bool parent = true;\n+            uint256 desc_id;\n+            uint32_t key_exp_index;\n+            uint32_t der_index;\n+            key >> desc_id;\n+            assert(desc_id == id);\n+            key >> key_exp_index;\n+\n+            // if the der_index exists, it's a derived xpub\n+            try\n+            {\n+                key >> der_index;\n+                parent = false;\n+            }\n+            catch (...) {}\n+\n+            std::vector<unsigned char> ser_xpub(BIP32_EXTKEY_SIZE);\n+            value >> ser_xpub;\n+            CExtPubKey xpub;\n+            xpub.Decode(ser_xpub.data());\n+            if (parent) {\n+                cache.CacheParentExtPubKey(key_exp_index, xpub);\n+            } else {\n+                cache.CacheDerivedExtPubKey(key_exp_index, der_index, xpub);\n+            }\n+            return DBErrors::LOAD_OK;\n+        });\n+\n+        // Get last hardened cache for this descriptor\n+        prefix = PrefixStream(DBKeys::WALLETDESCRIPTORLHCACHE, id);\n+        LoadResult lh_cache_res = LoadRecords(pwallet, batch, DBKeys::WALLETDESCRIPTORLHCACHE, prefix,\n+            [&id, &cache] (CWallet* pwallet, CDataStream& key, CDataStream& value, std::string& err) {\n+            uint256 desc_id;\n+            uint32_t key_exp_index;\n+            key >> desc_id;\n+            assert(desc_id == id);\n+            key >> key_exp_index;\n+\n+            std::vector<unsigned char> ser_xpub(BIP32_EXTKEY_SIZE);\n+            value >> ser_xpub;\n+            CExtPubKey xpub;\n+            xpub.Decode(ser_xpub.data());\n+            cache.CacheLastHardenedExtPubKey(key_exp_index, xpub);\n+            return DBErrors::LOAD_OK;\n+        });\n+\n+        // Set the cache for this descriptor\n+        auto spk_man = (DescriptorScriptPubKeyMan*)pwallet->GetScriptPubKeyMan(id);\n+        assert(spk_man);\n+        spk_man->SetCache(cache);\n+\n+        // Get unencrypted keys\n+        std::map<CKeyID, CKey> descriptor_keys;\n+        prefix = PrefixStream(DBKeys::WALLETDESCRIPTORKEY, id);\n+        LoadResult key_res = LoadRecords(pwallet, batch, DBKeys::WALLETDESCRIPTORKEY, prefix,\n+            [&id, &num_keys, &descriptor_keys] (CWallet* pwallet, CDataStream& key, CDataStream& value, std::string& err) {\n+            uint256 desc_id;\n+            CPubKey pubkey;\n+            key >> desc_id;\n+            assert(desc_id == id);\n+            key >> pubkey;\n+            if (!pubkey.IsValid())\n+            {\n+                pwallet->WalletLogPrintf(\"Error reading wallet database: descriptor unencrypted key CPubKey corrupt\\n\");\n+                return DBErrors::CORRUPT;\n+            }\n+            CKey privkey;\n+            CPrivKey pkey;\n+            uint256 hash;\n+\n+            num_keys++;\n+            value >> pkey;\n+            value >> hash;\n+\n+            // hash pubkey/privkey to accelerate wallet load\n+            std::vector<unsigned char> to_hash;\n+            to_hash.reserve(pubkey.size() + pkey.size());\n+            to_hash.insert(to_hash.end(), pubkey.begin(), pubkey.end());\n+            to_hash.insert(to_hash.end(), pkey.begin(), pkey.end());\n+\n+            if (Hash(to_hash) != hash)\n+            {\n+                pwallet->WalletLogPrintf(\"Error reading wallet database: descriptor unencrypted key CPubKey/CPrivKey corrupt\\n\");\n+                return DBErrors::CORRUPT;\n+            }\n+\n+            if (!privkey.Load(pkey, pubkey, true))\n+            {\n+                pwallet->WalletLogPrintf(\"Error reading wallet database: descriptor unencrypted key CPrivKey corrupt\\n\");\n+                return DBErrors::CORRUPT;\n+            }\n+            descriptor_keys.insert(std::make_pair(pubkey.GetID(), privkey));\n+            return DBErrors::LOAD_OK;\n+        });\n+        num_keys = key_res.m_records;\n+\n+        // Get encrypted keys\n+        std::map<CKeyID, std::pair<CPubKey, std::vector<unsigned char>>> descriptor_crypt_keys;\n+        prefix = PrefixStream(DBKeys::WALLETDESCRIPTORCKEY, id);\n+        LoadResult ckey_res = LoadRecords(pwallet, batch, DBKeys::WALLETDESCRIPTORCKEY, prefix,\n+            [&id, &num_ckeys, &descriptor_crypt_keys] (CWallet* pwallet, CDataStream& key, CDataStream& value, std::string& err) {\n+            uint256 desc_id;\n+            CPubKey pubkey;\n+            key >> desc_id;\n+            assert(desc_id == id);\n+            key >> pubkey;\n+            if (!pubkey.IsValid())\n+            {\n+                pwallet->WalletLogPrintf(\"Error reading wallet database: descriptor encrypted key CPubKey corrupt\\n\");\n+                return DBErrors::CORRUPT;\n+            }\n+            std::vector<unsigned char> privkey;\n+            value >> privkey;\n+            num_ckeys++;\n+\n+            descriptor_crypt_keys.insert(std::make_pair(pubkey.GetID(), std::make_pair(pubkey, privkey)));\n+            return DBErrors::LOAD_OK;\n+        });\n+        num_ckeys = ckey_res.m_records;\n+\n+        // Set the descriptor keys\n+        for (auto desc_key_pair : descriptor_keys) {\n+            spk_man->AddKey(desc_key_pair.first, desc_key_pair.second);\n+        }\n+        for (auto desc_key_pair : descriptor_crypt_keys) {\n+            spk_man->AddCryptedKey(desc_key_pair.first, desc_key_pair.second.first, desc_key_pair.second.second);\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r922442482",
      "id" : 922442482,
      "line" : 891,
      "node_id" : "PRRC_kwDOABII5842-1ry",
      "original_commit_id" : "369a042c738f71c88038584ff392f4ac8121b087",
      "original_line" : 1045,
      "original_position" : 292,
      "original_start_line" : 1039,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 292,
      "pull_request_review_id" : 1040304045,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922442482/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-07-15T19:19:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922442482",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r922475618"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922475618"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Missing `corrupted_tx = true` set here.",
      "commit_id" : "431904b5c317917fad4c5171bebb14620fd1edec",
      "created_at" : "2022-07-15T19:51:45Z",
      "diff_hunk" : "@@ -1080,6 +1029,90 @@ static DBErrors LoadAddressBookRecords(CWallet* pwallet, DatabaseBatch& batch) E\n     return DBErrors::LOAD_OK;\n }\n \n+static DBErrors LoadTxRecords(CWallet* pwallet, DatabaseBatch& batch, std::vector<uint256> upgraded_txs, bool& any_unordered) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    AssertLockHeld(pwallet->cs_wallet);\n+    DBErrors result = DBErrors::LOAD_OK;\n+\n+    // Load tx record\n+    bool corrupted_tx = false;\n+    any_unordered = false;\n+    LoadResult tx_res = LoadRecords(pwallet, batch, DBKeys::TX,\n+        [&corrupted_tx, &any_unordered, &upgraded_txs] (CWallet* pwallet, CDataStream& key, CDataStream& value, std::string& err) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet) {\n+        DBErrors result = DBErrors::LOAD_OK;\n+        uint256 hash;\n+        key >> hash;\n+        // LoadToWallet call below creates a new CWalletTx that fill_wtx\n+        // callback fills with transaction metadata.\n+        auto fill_wtx = [&](CWalletTx& wtx, bool new_tx) {\n+            if(!new_tx) {\n+                // There's some corruption here since the tx we just tried to load was already in the wallet.\n+                // We don't consider this type of corruption critical, and can fix it by removing tx data and\n+                // rescanning.\n+                pwallet->WalletLogPrintf(\"Error: Corrupt transaction found. This can be fixed by removing transactions from wallet and rescanning.\\n\");\n+                result = DBErrors::CORRUPT;\n+                return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r922475618",
      "id" : 922475618,
      "line" : 964,
      "node_id" : "PRRC_kwDOABII5842-9xi",
      "original_commit_id" : "7ed39f6d344516cef2023fbfaeb99444b8c5c6d0",
      "original_line" : 1054,
      "original_position" : 98,
      "original_start_line" : 1052,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 98,
      "pull_request_review_id" : 1040744754,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922475618/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 962,
      "start_side" : "RIGHT",
      "updated_at" : "2022-07-15T19:52:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922475618",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r922492905"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922492905"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It is the retain the current behavior where we generally go through all the records in the wallet regardless of whether they are corrupt, and just report the worst result at the end. This allows us to check all of the records for corruption.",
      "commit_id" : "431904b5c317917fad4c5171bebb14620fd1edec",
      "created_at" : "2022-07-15T20:22:52Z",
      "diff_hunk" : "@@ -828,12 +733,255 @@ static DBErrors LoadWalletFlags(CWallet* pwallet, DatabaseBatch& batch) EXCLUSIV\n     return DBErrors::LOAD_OK;\n }\n \n+struct LoadResult\n+{\n+    DBErrors m_result{DBErrors::LOAD_OK};\n+    std::string m_error{};\n+    int m_records{0};\n+};\n+\n+using LoadFunc = std::function<DBErrors(CWallet* pwallet, CDataStream& key, CDataStream& value, std::string& err)>;\n+static LoadResult LoadRecords(CWallet* pwallet, DatabaseBatch& batch, const std::string& key, LoadFunc load_func)\n+{\n+    LoadResult result;\n+    CDataStream ssKey(SER_DISK, CLIENT_VERSION);\n+    CDataStream ssValue(SER_DISK, CLIENT_VERSION);\n+\n+    CDataStream prefix(0, 0);\n+    prefix << key;\n+    std::unique_ptr<DatabaseCursor> cursor = batch.GetNewPrefixCursor(prefix);\n+    if (!cursor) {\n+        pwallet->WalletLogPrintf(\"Error getting database cursor for '%s' records\\n\", key);\n+        result.m_result = DBErrors::CORRUPT;\n+        return result;\n+    }\n+\n+    result.m_result = DBErrors::LOAD_OK;\n+    while (true) {\n+        bool complete;\n+        bool ret = cursor->Next(ssKey, ssValue, complete);\n+        if (complete) {\n+            break;\n+        } else if (!ret) {\n+            pwallet->WalletLogPrintf(\"Error reading next '%s' record for wallet database\\n\", key);\n+            result.m_result = DBErrors::CORRUPT;\n+            return result;\n+        }\n+        std::string type;\n+        ssKey >> type;\n+        assert(type == key);\n+        if ((result.m_result = std::max(result.m_result, load_func(pwallet, ssKey, ssValue, result.m_error))) == DBErrors::CORRUPT) {\n+            pwallet->WalletLogPrintf(\"%s\\n\", result.m_error);\n+        }\n+        ++result.m_records;\n+    }\n+    return result;\n+}\n+\n+static DBErrors LoadLegacyWalletRecords(CWallet* pwallet, DatabaseBatch& batch, int last_client) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    AssertLockHeld(pwallet->cs_wallet);\n+    DBErrors result = DBErrors::LOAD_OK;\n+\n+    // Load HD Chain\n+    CHDChain chain;\n+    if (batch.Read(DBKeys::HDCHAIN, chain)) {\n+        pwallet->GetOrCreateLegacyScriptPubKeyMan()->LoadHDChain(chain);\n+    }\n+\n+    // Load unencrypted keys\n+    LoadResult key_res = LoadRecords(pwallet, batch, DBKeys::KEY,\n+        [] (CWallet* pwallet, CDataStream& key, CDataStream& value, std::string& err) {\n+        if (!LoadKey(pwallet, key, value, err)) {\n+            return DBErrors::CORRUPT;\n+        }\n+        return DBErrors::LOAD_OK;\n+    });\n+    result = std::max(result, key_res.m_result);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r922492905",
      "id" : 922492905,
      "in_reply_to_id" : 922403557,
      "line" : 540,
      "node_id" : "PRRC_kwDOABII5842_B_p",
      "original_commit_id" : "ba1d48a2939570ea369554ff790c12300e9fd7b1",
      "original_line" : 800,
      "original_position" : 196,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 196,
      "pull_request_review_id" : 1040769618,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922492905/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-15T20:22:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922492905",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r922570997"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922570997"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "0ca1efcd748b5e6dd2c1fc286440e5a8ff5757d5",
      "created_at" : "2022-07-15T23:12:01Z",
      "diff_hunk" : "@@ -678,13 +685,20 @@ bool BerkeleyCursor::Next(CDataStream& ssKey, CDataStream& ssValue, bool& comple\n     else if (datKey.get_data() == nullptr || datValue.get_data() == nullptr)\n         return false;\n \n+    Span<const std::byte> raw_key = {AsBytePtr(datKey.get_data()), datKey.get_size()};\n+    if (!m_key_prefix.empty() && std::mismatch(raw_key.begin(), raw_key.end(), m_key_prefix.begin(), m_key_prefix.end()).second != m_key_prefix.end()) {\n+        complete = true;\n+        return false;\n+    }\n+\n     // Convert to streams\n     ssKey.SetType(SER_DISK);\n     ssKey.clear();\n     ssKey.write({AsBytePtr(datKey.get_data()), datKey.get_size()});",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r922570997",
      "id" : 922570997,
      "in_reply_to_id" : 922170911,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5842_VD1",
      "original_commit_id" : "c704f8348820eeabf8e1230d81e026a14fd8b3fc",
      "original_line" : 697,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "src/wallet/bdb.cpp",
      "position" : null,
      "pull_request_review_id" : 1040880432,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922570997/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-15T23:12:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922570997",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r922571016"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922571016"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "0ca1efcd748b5e6dd2c1fc286440e5a8ff5757d5",
      "created_at" : "2022-07-15T23:12:06Z",
      "diff_hunk" : "@@ -187,11 +187,16 @@ class SafeDbt final\n \n class BerkeleyCursor : public DatabaseCursor\n {\n-private:\n+protected:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r922571016",
      "id" : 922571016,
      "in_reply_to_id" : 922172352,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5842_VEI",
      "original_commit_id" : "c704f8348820eeabf8e1230d81e026a14fd8b3fc",
      "original_line" : 190,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/bdb.h",
      "position" : null,
      "pull_request_review_id" : 1040880459,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922571016/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-15T23:12:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922571016",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r922571042"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922571042"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "0ca1efcd748b5e6dd2c1fc286440e5a8ff5757d5",
      "created_at" : "2022-07-15T23:12:12Z",
      "diff_hunk" : "@@ -828,12 +733,255 @@ static DBErrors LoadWalletFlags(CWallet* pwallet, DatabaseBatch& batch) EXCLUSIV\n     return DBErrors::LOAD_OK;\n }\n \n+struct LoadResult\n+{\n+    DBErrors m_result{DBErrors::LOAD_OK};\n+    std::string m_error{};\n+    int m_records{0};\n+};\n+\n+using LoadFunc = std::function<DBErrors(CWallet* pwallet, CDataStream& key, CDataStream& value, std::string& err)>;\n+static LoadResult LoadRecords(CWallet* pwallet, DatabaseBatch& batch, const std::string& key, LoadFunc load_func)\n+{\n+    LoadResult result;\n+    CDataStream ssKey(SER_DISK, CLIENT_VERSION);\n+    CDataStream ssValue(SER_DISK, CLIENT_VERSION);\n+\n+    CDataStream prefix(0, 0);\n+    prefix << key;\n+    std::unique_ptr<DatabaseCursor> cursor = batch.GetNewPrefixCursor(prefix);\n+    if (!cursor) {\n+        pwallet->WalletLogPrintf(\"Error getting database cursor for '%s' records\\n\", key);\n+        result.m_result = DBErrors::CORRUPT;\n+        return result;\n+    }\n+\n+    result.m_result = DBErrors::LOAD_OK;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r922571042",
      "id" : 922571042,
      "in_reply_to_id" : 922394666,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5842_VEi",
      "original_commit_id" : "ba1d48a2939570ea369554ff790c12300e9fd7b1",
      "original_line" : 759,
      "original_position" : 155,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 1040880495,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922571042/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-15T23:12:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922571042",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r922571322"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922571322"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done here and elsewhere.",
      "commit_id" : "0ca1efcd748b5e6dd2c1fc286440e5a8ff5757d5",
      "created_at" : "2022-07-15T23:13:04Z",
      "diff_hunk" : "@@ -828,12 +733,255 @@ static DBErrors LoadWalletFlags(CWallet* pwallet, DatabaseBatch& batch) EXCLUSIV\n     return DBErrors::LOAD_OK;\n }\n \n+struct LoadResult\n+{\n+    DBErrors m_result{DBErrors::LOAD_OK};\n+    std::string m_error{};\n+    int m_records{0};\n+};\n+\n+using LoadFunc = std::function<DBErrors(CWallet* pwallet, CDataStream& key, CDataStream& value, std::string& err)>;\n+static LoadResult LoadRecords(CWallet* pwallet, DatabaseBatch& batch, const std::string& key, LoadFunc load_func)\n+{\n+    LoadResult result;\n+    CDataStream ssKey(SER_DISK, CLIENT_VERSION);\n+    CDataStream ssValue(SER_DISK, CLIENT_VERSION);\n+\n+    CDataStream prefix(0, 0);\n+    prefix << key;\n+    std::unique_ptr<DatabaseCursor> cursor = batch.GetNewPrefixCursor(prefix);\n+    if (!cursor) {\n+        pwallet->WalletLogPrintf(\"Error getting database cursor for '%s' records\\n\", key);\n+        result.m_result = DBErrors::CORRUPT;\n+        return result;\n+    }\n+\n+    result.m_result = DBErrors::LOAD_OK;\n+    while (true) {\n+        bool complete;\n+        bool ret = cursor->Next(ssKey, ssValue, complete);\n+        if (complete) {\n+            break;\n+        } else if (!ret) {\n+            pwallet->WalletLogPrintf(\"Error reading next '%s' record for wallet database\\n\", key);\n+            result.m_result = DBErrors::CORRUPT;\n+            return result;\n+        }\n+        std::string type;\n+        ssKey >> type;\n+        assert(type == key);\n+        if ((result.m_result = std::max(result.m_result, load_func(pwallet, ssKey, ssValue, result.m_error))) == DBErrors::CORRUPT) {\n+            pwallet->WalletLogPrintf(\"%s\\n\", result.m_error);\n+        }\n+        ++result.m_records;\n+    }\n+    return result;\n+}\n+\n+static DBErrors LoadLegacyWalletRecords(CWallet* pwallet, DatabaseBatch& batch, int last_client) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    AssertLockHeld(pwallet->cs_wallet);\n+    DBErrors result = DBErrors::LOAD_OK;\n+\n+    // Load HD Chain\n+    CHDChain chain;\n+    if (batch.Read(DBKeys::HDCHAIN, chain)) {\n+        pwallet->GetOrCreateLegacyScriptPubKeyMan()->LoadHDChain(chain);\n+    }\n+\n+    // Load unencrypted keys\n+    LoadResult key_res = LoadRecords(pwallet, batch, DBKeys::KEY,\n+        [] (CWallet* pwallet, CDataStream& key, CDataStream& value, std::string& err) {\n+        if (!LoadKey(pwallet, key, value, err)) {\n+            return DBErrors::CORRUPT;\n+        }\n+        return DBErrors::LOAD_OK;\n+    });\n+    result = std::max(result, key_res.m_result);\n+\n+    // Load encrypted keys\n+    LoadResult ckey_res = LoadRecords(pwallet, batch, DBKeys::CRYPTED_KEY,\n+        [] (CWallet* pwallet, CDataStream& key, CDataStream& value, std::string& err) {\n+        if (!LoadCryptedKey(pwallet, key, value, err)) {\n+            return DBErrors::CORRUPT;\n+        }\n+        return DBErrors::LOAD_OK;\n+    });\n+    result = std::max(result, ckey_res.m_result);\n+\n+    // Load scripts\n+    LoadResult script_res = LoadRecords(pwallet, batch, DBKeys::CSCRIPT,\n+        [] (CWallet* pwallet, CDataStream& key, CDataStream& value, std::string& err) {\n+        uint160 hash;\n+        key >> hash;\n+        CScript script;\n+        value >> script;\n+        if (!pwallet->GetOrCreateLegacyScriptPubKeyMan()->LoadCScript(script))\n+        {\n+            pwallet->WalletLogPrintf(\"Error reading wallet database: LegacyScriptPubKeyMan::LoadCScript failed\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r922571322",
      "id" : 922571322,
      "in_reply_to_id" : 922401748,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5842_VI6",
      "original_commit_id" : "ba1d48a2939570ea369554ff790c12300e9fd7b1",
      "original_line" : 821,
      "original_position" : 217,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 1040880827,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922571322/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-15T23:13:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922571322",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r922571426"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922571426"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "0ca1efcd748b5e6dd2c1fc286440e5a8ff5757d5",
      "created_at" : "2022-07-15T23:13:22Z",
      "diff_hunk" : "@@ -974,6 +887,171 @@ static DBErrors LoadLegacyWalletRecords(CWallet* pwallet, DatabaseBatch& batch,\n     return result;\n }\n \n+template<typename... Args>\n+static CDataStream PrefixStream(const Args&... args)\n+{\n+    CDataStream prefix(0, 0);\n+    SerializeMany(prefix, args...);\n+    return prefix;\n+}\n+\n+static DBErrors LoadDescriptorWalletRecords(CWallet* pwallet, DatabaseBatch& batch) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    AssertLockHeld(pwallet->cs_wallet);\n+\n+    // Load descriptor record\n+    int num_keys = 0;\n+    int num_ckeys= 0;\n+    LoadResult desc_res = LoadRecords(pwallet, batch, DBKeys::WALLETDESCRIPTOR,\n+        [&batch, &num_keys, &num_ckeys] (CWallet* pwallet, CDataStream& key, CDataStream& value, std::string& err) {\n+        uint256 id;\n+        key >> id;\n+        WalletDescriptor desc;\n+        value >> desc;\n+        pwallet->LoadDescriptorScriptPubKeyMan(id, desc);\n+\n+        DescriptorCache cache;\n+\n+        // Get key cache for this descriptor\n+        CDataStream prefix = PrefixStream(DBKeys::WALLETDESCRIPTORCACHE, id);\n+        LoadResult key_cache_res = LoadRecords(pwallet, batch, DBKeys::WALLETDESCRIPTORCACHE, prefix,\n+            [&id, &cache] (CWallet* pwallet, CDataStream& key, CDataStream& value, std::string& err) {\n+            bool parent = true;\n+            uint256 desc_id;\n+            uint32_t key_exp_index;\n+            uint32_t der_index;\n+            key >> desc_id;\n+            assert(desc_id == id);\n+            key >> key_exp_index;\n+\n+            // if the der_index exists, it's a derived xpub\n+            try\n+            {\n+                key >> der_index;\n+                parent = false;\n+            }\n+            catch (...) {}\n+\n+            std::vector<unsigned char> ser_xpub(BIP32_EXTKEY_SIZE);\n+            value >> ser_xpub;\n+            CExtPubKey xpub;\n+            xpub.Decode(ser_xpub.data());\n+            if (parent) {\n+                cache.CacheParentExtPubKey(key_exp_index, xpub);\n+            } else {\n+                cache.CacheDerivedExtPubKey(key_exp_index, der_index, xpub);\n+            }\n+            return DBErrors::LOAD_OK;\n+        });\n+\n+        // Get last hardened cache for this descriptor\n+        prefix = PrefixStream(DBKeys::WALLETDESCRIPTORLHCACHE, id);\n+        LoadResult lh_cache_res = LoadRecords(pwallet, batch, DBKeys::WALLETDESCRIPTORLHCACHE, prefix,\n+            [&id, &cache] (CWallet* pwallet, CDataStream& key, CDataStream& value, std::string& err) {\n+            uint256 desc_id;\n+            uint32_t key_exp_index;\n+            key >> desc_id;\n+            assert(desc_id == id);\n+            key >> key_exp_index;\n+\n+            std::vector<unsigned char> ser_xpub(BIP32_EXTKEY_SIZE);\n+            value >> ser_xpub;\n+            CExtPubKey xpub;\n+            xpub.Decode(ser_xpub.data());\n+            cache.CacheLastHardenedExtPubKey(key_exp_index, xpub);\n+            return DBErrors::LOAD_OK;\n+        });\n+\n+        // Set the cache for this descriptor\n+        auto spk_man = (DescriptorScriptPubKeyMan*)pwallet->GetScriptPubKeyMan(id);\n+        assert(spk_man);\n+        spk_man->SetCache(cache);\n+\n+        // Get unencrypted keys\n+        std::map<CKeyID, CKey> descriptor_keys;\n+        prefix = PrefixStream(DBKeys::WALLETDESCRIPTORKEY, id);\n+        LoadResult key_res = LoadRecords(pwallet, batch, DBKeys::WALLETDESCRIPTORKEY, prefix,\n+            [&id, &num_keys, &descriptor_keys] (CWallet* pwallet, CDataStream& key, CDataStream& value, std::string& err) {\n+            uint256 desc_id;\n+            CPubKey pubkey;\n+            key >> desc_id;\n+            assert(desc_id == id);\n+            key >> pubkey;\n+            if (!pubkey.IsValid())\n+            {\n+                pwallet->WalletLogPrintf(\"Error reading wallet database: descriptor unencrypted key CPubKey corrupt\\n\");\n+                return DBErrors::CORRUPT;\n+            }\n+            CKey privkey;\n+            CPrivKey pkey;\n+            uint256 hash;\n+\n+            num_keys++;\n+            value >> pkey;\n+            value >> hash;\n+\n+            // hash pubkey/privkey to accelerate wallet load\n+            std::vector<unsigned char> to_hash;\n+            to_hash.reserve(pubkey.size() + pkey.size());\n+            to_hash.insert(to_hash.end(), pubkey.begin(), pubkey.end());\n+            to_hash.insert(to_hash.end(), pkey.begin(), pkey.end());\n+\n+            if (Hash(to_hash) != hash)\n+            {\n+                pwallet->WalletLogPrintf(\"Error reading wallet database: descriptor unencrypted key CPubKey/CPrivKey corrupt\\n\");\n+                return DBErrors::CORRUPT;\n+            }\n+\n+            if (!privkey.Load(pkey, pubkey, true))\n+            {\n+                pwallet->WalletLogPrintf(\"Error reading wallet database: descriptor unencrypted key CPrivKey corrupt\\n\");\n+                return DBErrors::CORRUPT;\n+            }\n+            descriptor_keys.insert(std::make_pair(pubkey.GetID(), privkey));\n+            return DBErrors::LOAD_OK;\n+        });\n+        num_keys = key_res.m_records;\n+\n+        // Get encrypted keys\n+        std::map<CKeyID, std::pair<CPubKey, std::vector<unsigned char>>> descriptor_crypt_keys;\n+        prefix = PrefixStream(DBKeys::WALLETDESCRIPTORCKEY, id);\n+        LoadResult ckey_res = LoadRecords(pwallet, batch, DBKeys::WALLETDESCRIPTORCKEY, prefix,\n+            [&id, &num_ckeys, &descriptor_crypt_keys] (CWallet* pwallet, CDataStream& key, CDataStream& value, std::string& err) {\n+            uint256 desc_id;\n+            CPubKey pubkey;\n+            key >> desc_id;\n+            assert(desc_id == id);\n+            key >> pubkey;\n+            if (!pubkey.IsValid())\n+            {\n+                pwallet->WalletLogPrintf(\"Error reading wallet database: descriptor encrypted key CPubKey corrupt\\n\");\n+                return DBErrors::CORRUPT;\n+            }\n+            std::vector<unsigned char> privkey;\n+            value >> privkey;\n+            num_ckeys++;\n+\n+            descriptor_crypt_keys.insert(std::make_pair(pubkey.GetID(), std::make_pair(pubkey, privkey)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r922571426",
      "id" : 922571426,
      "in_reply_to_id" : 922440904,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5842_VKi",
      "original_commit_id" : "369a042c738f71c88038584ff392f4ac8121b087",
      "original_line" : 1034,
      "original_position" : 281,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 1040880957,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922571426/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-15T23:13:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922571426",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r922571458"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922571458"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "0ca1efcd748b5e6dd2c1fc286440e5a8ff5757d5",
      "created_at" : "2022-07-15T23:13:28Z",
      "diff_hunk" : "@@ -974,6 +887,171 @@ static DBErrors LoadLegacyWalletRecords(CWallet* pwallet, DatabaseBatch& batch,\n     return result;\n }\n \n+template<typename... Args>\n+static CDataStream PrefixStream(const Args&... args)\n+{\n+    CDataStream prefix(0, 0);\n+    SerializeMany(prefix, args...);\n+    return prefix;\n+}\n+\n+static DBErrors LoadDescriptorWalletRecords(CWallet* pwallet, DatabaseBatch& batch) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    AssertLockHeld(pwallet->cs_wallet);\n+\n+    // Load descriptor record\n+    int num_keys = 0;\n+    int num_ckeys= 0;\n+    LoadResult desc_res = LoadRecords(pwallet, batch, DBKeys::WALLETDESCRIPTOR,\n+        [&batch, &num_keys, &num_ckeys] (CWallet* pwallet, CDataStream& key, CDataStream& value, std::string& err) {\n+        uint256 id;\n+        key >> id;\n+        WalletDescriptor desc;\n+        value >> desc;\n+        pwallet->LoadDescriptorScriptPubKeyMan(id, desc);\n+\n+        DescriptorCache cache;\n+\n+        // Get key cache for this descriptor\n+        CDataStream prefix = PrefixStream(DBKeys::WALLETDESCRIPTORCACHE, id);\n+        LoadResult key_cache_res = LoadRecords(pwallet, batch, DBKeys::WALLETDESCRIPTORCACHE, prefix,\n+            [&id, &cache] (CWallet* pwallet, CDataStream& key, CDataStream& value, std::string& err) {\n+            bool parent = true;\n+            uint256 desc_id;\n+            uint32_t key_exp_index;\n+            uint32_t der_index;\n+            key >> desc_id;\n+            assert(desc_id == id);\n+            key >> key_exp_index;\n+\n+            // if the der_index exists, it's a derived xpub\n+            try\n+            {\n+                key >> der_index;\n+                parent = false;\n+            }\n+            catch (...) {}\n+\n+            std::vector<unsigned char> ser_xpub(BIP32_EXTKEY_SIZE);\n+            value >> ser_xpub;\n+            CExtPubKey xpub;\n+            xpub.Decode(ser_xpub.data());\n+            if (parent) {\n+                cache.CacheParentExtPubKey(key_exp_index, xpub);\n+            } else {\n+                cache.CacheDerivedExtPubKey(key_exp_index, der_index, xpub);\n+            }\n+            return DBErrors::LOAD_OK;\n+        });\n+\n+        // Get last hardened cache for this descriptor\n+        prefix = PrefixStream(DBKeys::WALLETDESCRIPTORLHCACHE, id);\n+        LoadResult lh_cache_res = LoadRecords(pwallet, batch, DBKeys::WALLETDESCRIPTORLHCACHE, prefix,\n+            [&id, &cache] (CWallet* pwallet, CDataStream& key, CDataStream& value, std::string& err) {\n+            uint256 desc_id;\n+            uint32_t key_exp_index;\n+            key >> desc_id;\n+            assert(desc_id == id);\n+            key >> key_exp_index;\n+\n+            std::vector<unsigned char> ser_xpub(BIP32_EXTKEY_SIZE);\n+            value >> ser_xpub;\n+            CExtPubKey xpub;\n+            xpub.Decode(ser_xpub.data());\n+            cache.CacheLastHardenedExtPubKey(key_exp_index, xpub);\n+            return DBErrors::LOAD_OK;\n+        });\n+\n+        // Set the cache for this descriptor\n+        auto spk_man = (DescriptorScriptPubKeyMan*)pwallet->GetScriptPubKeyMan(id);\n+        assert(spk_man);\n+        spk_man->SetCache(cache);\n+\n+        // Get unencrypted keys\n+        std::map<CKeyID, CKey> descriptor_keys;\n+        prefix = PrefixStream(DBKeys::WALLETDESCRIPTORKEY, id);\n+        LoadResult key_res = LoadRecords(pwallet, batch, DBKeys::WALLETDESCRIPTORKEY, prefix,\n+            [&id, &num_keys, &descriptor_keys] (CWallet* pwallet, CDataStream& key, CDataStream& value, std::string& err) {\n+            uint256 desc_id;\n+            CPubKey pubkey;\n+            key >> desc_id;\n+            assert(desc_id == id);\n+            key >> pubkey;\n+            if (!pubkey.IsValid())\n+            {\n+                pwallet->WalletLogPrintf(\"Error reading wallet database: descriptor unencrypted key CPubKey corrupt\\n\");\n+                return DBErrors::CORRUPT;\n+            }\n+            CKey privkey;\n+            CPrivKey pkey;\n+            uint256 hash;\n+\n+            num_keys++;\n+            value >> pkey;\n+            value >> hash;\n+\n+            // hash pubkey/privkey to accelerate wallet load\n+            std::vector<unsigned char> to_hash;\n+            to_hash.reserve(pubkey.size() + pkey.size());\n+            to_hash.insert(to_hash.end(), pubkey.begin(), pubkey.end());\n+            to_hash.insert(to_hash.end(), pkey.begin(), pkey.end());\n+\n+            if (Hash(to_hash) != hash)\n+            {\n+                pwallet->WalletLogPrintf(\"Error reading wallet database: descriptor unencrypted key CPubKey/CPrivKey corrupt\\n\");\n+                return DBErrors::CORRUPT;\n+            }\n+\n+            if (!privkey.Load(pkey, pubkey, true))\n+            {\n+                pwallet->WalletLogPrintf(\"Error reading wallet database: descriptor unencrypted key CPrivKey corrupt\\n\");\n+                return DBErrors::CORRUPT;\n+            }\n+            descriptor_keys.insert(std::make_pair(pubkey.GetID(), privkey));\n+            return DBErrors::LOAD_OK;\n+        });\n+        num_keys = key_res.m_records;\n+\n+        // Get encrypted keys\n+        std::map<CKeyID, std::pair<CPubKey, std::vector<unsigned char>>> descriptor_crypt_keys;\n+        prefix = PrefixStream(DBKeys::WALLETDESCRIPTORCKEY, id);\n+        LoadResult ckey_res = LoadRecords(pwallet, batch, DBKeys::WALLETDESCRIPTORCKEY, prefix,\n+            [&id, &num_ckeys, &descriptor_crypt_keys] (CWallet* pwallet, CDataStream& key, CDataStream& value, std::string& err) {\n+            uint256 desc_id;\n+            CPubKey pubkey;\n+            key >> desc_id;\n+            assert(desc_id == id);\n+            key >> pubkey;\n+            if (!pubkey.IsValid())\n+            {\n+                pwallet->WalletLogPrintf(\"Error reading wallet database: descriptor encrypted key CPubKey corrupt\\n\");\n+                return DBErrors::CORRUPT;\n+            }\n+            std::vector<unsigned char> privkey;\n+            value >> privkey;\n+            num_ckeys++;\n+\n+            descriptor_crypt_keys.insert(std::make_pair(pubkey.GetID(), std::make_pair(pubkey, privkey)));\n+            return DBErrors::LOAD_OK;\n+        });\n+        num_ckeys = ckey_res.m_records;\n+\n+        // Set the descriptor keys\n+        for (auto desc_key_pair : descriptor_keys) {\n+            spk_man->AddKey(desc_key_pair.first, desc_key_pair.second);\n+        }\n+        for (auto desc_key_pair : descriptor_crypt_keys) {\n+            spk_man->AddCryptedKey(desc_key_pair.first, desc_key_pair.second.first, desc_key_pair.second.second);\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r922571458",
      "id" : 922571458,
      "in_reply_to_id" : 922442482,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5842_VLC",
      "original_commit_id" : "369a042c738f71c88038584ff392f4ac8121b087",
      "original_line" : 1045,
      "original_position" : 292,
      "original_start_line" : 1039,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 1040880997,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922571458/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-07-15T23:13:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922571458",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r922571481"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922571481"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "0ca1efcd748b5e6dd2c1fc286440e5a8ff5757d5",
      "created_at" : "2022-07-15T23:13:32Z",
      "diff_hunk" : "@@ -1080,6 +1029,90 @@ static DBErrors LoadAddressBookRecords(CWallet* pwallet, DatabaseBatch& batch) E\n     return DBErrors::LOAD_OK;\n }\n \n+static DBErrors LoadTxRecords(CWallet* pwallet, DatabaseBatch& batch, std::vector<uint256> upgraded_txs, bool& any_unordered) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\n+{\n+    AssertLockHeld(pwallet->cs_wallet);\n+    DBErrors result = DBErrors::LOAD_OK;\n+\n+    // Load tx record\n+    bool corrupted_tx = false;\n+    any_unordered = false;\n+    LoadResult tx_res = LoadRecords(pwallet, batch, DBKeys::TX,\n+        [&corrupted_tx, &any_unordered, &upgraded_txs] (CWallet* pwallet, CDataStream& key, CDataStream& value, std::string& err) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet) {\n+        DBErrors result = DBErrors::LOAD_OK;\n+        uint256 hash;\n+        key >> hash;\n+        // LoadToWallet call below creates a new CWalletTx that fill_wtx\n+        // callback fills with transaction metadata.\n+        auto fill_wtx = [&](CWalletTx& wtx, bool new_tx) {\n+            if(!new_tx) {\n+                // There's some corruption here since the tx we just tried to load was already in the wallet.\n+                // We don't consider this type of corruption critical, and can fix it by removing tx data and\n+                // rescanning.\n+                pwallet->WalletLogPrintf(\"Error: Corrupt transaction found. This can be fixed by removing transactions from wallet and rescanning.\\n\");\n+                result = DBErrors::CORRUPT;\n+                return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#discussion_r922571481",
      "id" : 922571481,
      "in_reply_to_id" : 922475618,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5842_VLZ",
      "original_commit_id" : "7ed39f6d344516cef2023fbfaeb99444b8c5c6d0",
      "original_line" : 961,
      "original_position" : 98,
      "original_start_line" : 1052,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 1040881028,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24914",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922571481/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-07-15T23:13:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/922571481",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> The `LoadRecords` of the `WALLETDESCRIPTOR` prefix is always returning `LOAD_OK` result even if the load internally failed (corrupted db).\r\n\r\nGood catch. I've added `result = std::max(result, res.m_result);` for each of these.",
      "created_at" : "2022-07-15T23:14:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24914#issuecomment-1186015747",
      "id" : 1186015747,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24914",
      "node_id" : "IC_kwDOABII585GsSoD",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1186015747/reactions"
      },
      "updated_at" : "2022-07-15T23:14:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1186015747",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   }
]
