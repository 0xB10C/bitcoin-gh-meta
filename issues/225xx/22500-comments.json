[
   {
      "author_association" : "MEMBER",
      "body" : "Approach ACK",
      "created_at" : "2021-07-19T15:10:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22500#issuecomment-882628295",
      "id" : 882628295,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22500",
      "node_id" : "IC_kwDOABII5840m9bH",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-19T15:10:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/882628295",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22500#discussion_r672440473"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22500"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/672440473"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit, spacing is off by one\r\n```diff\r\n@@ -493,10 +494,10 @@ void CAddrMan::Check()\r\n     for (int n = 0; n < ADDRMAN_TRIED_BUCKET_COUNT; n++) {\r\n         for (int i = 0; i < ADDRMAN_BUCKET_SIZE; i++) {\r\n              if (vvTried[n][i] != -1) {\r\n-                assert(setTried.count(vvTried[n][i]));\r\n-                assert(mapInfo[vvTried[n][i]].GetTriedBucket(nKey, m_asmap) == n);\r\n-                assert(mapInfo[vvTried[n][i]].GetBucketPosition(nKey, false, n) == i);\r\n-                setTried.erase(vvTried[n][i]);\r\n+                 assert(setTried.count(vvTried[n][i]));\r\n+                 assert(mapInfo[vvTried[n][i]].GetTriedBucket(nKey, m_asmap) == n);\r\n+                 assert(mapInfo[vvTried[n][i]].GetBucketPosition(nKey, false, n) == i);\r\n+                 setTried.erase(vvTried[n][i]);\r\n              }\r\n         }\r\n     }\r\n```\r\n",
      "commit_id" : "fa4bfef4798466e986569baf0d8e3213f17cafc8",
      "created_at" : "2021-07-19T16:13:20Z",
      "diff_hunk" : "@@ -459,85 +459,64 @@ CAddrInfo CAddrMan::Select_(bool newOnly)\n     }\n }\n \n-#ifdef DEBUG_ADDRMAN\n-int CAddrMan::Check_()\n+void CAddrMan::Check()\n {\n+#ifdef DEBUG_ADDRMAN\n     AssertLockHeld(cs);\n \n     std::unordered_set<int> setTried;\n     std::unordered_map<int, int> mapNew;\n \n-    if (vRandom.size() != (size_t)(nTried + nNew))\n-        return -7;\n+    assert(vRandom.size() == (size_t)(nTried + nNew));\n \n     for (const auto& entry : mapInfo) {\n         int n = entry.first;\n         const CAddrInfo& info = entry.second;\n         if (info.fInTried) {\n-            if (!info.nLastSuccess)\n-                return -1;\n-            if (info.nRefCount)\n-                return -2;\n+            assert(info.nLastSuccess);\n+            assert(!info.nRefCount);\n             setTried.insert(n);\n         } else {\n-            if (info.nRefCount < 0 || info.nRefCount > ADDRMAN_NEW_BUCKETS_PER_ADDRESS)\n-                return -3;\n-            if (!info.nRefCount)\n-                return -4;\n+            assert(info.nRefCount >= 0 && info.nRefCount <= ADDRMAN_NEW_BUCKETS_PER_ADDRESS);\n+            assert(info.nRefCount);\n             mapNew[n] = info.nRefCount;\n         }\n-        if (mapAddr[info] != n)\n-            return -5;\n-        if (info.nRandomPos < 0 || (size_t)info.nRandomPos >= vRandom.size() || vRandom[info.nRandomPos] != n)\n-            return -14;\n-        if (info.nLastTry < 0)\n-            return -6;\n-        if (info.nLastSuccess < 0)\n-            return -8;\n+        assert(mapAddr[info] == n);\n+        assert(info.nRandomPos >= 0 && (size_t)info.nRandomPos < vRandom.size() && vRandom[info.nRandomPos] == n);\n+        assert(info.nLastTry >= 0);\n+        assert(info.nLastSuccess >= 0);\n     }\n \n-    if (setTried.size() != (size_t)nTried)\n-        return -9;\n-    if (mapNew.size() != (size_t)nNew)\n-        return -10;\n+    assert(setTried.size() == (size_t)nTried);\n+    assert(mapNew.size() == (size_t)nNew);\n \n     for (int n = 0; n < ADDRMAN_TRIED_BUCKET_COUNT; n++) {\n         for (int i = 0; i < ADDRMAN_BUCKET_SIZE; i++) {\n              if (vvTried[n][i] != -1) {\n-                 if (!setTried.count(vvTried[n][i]))\n-                     return -11;\n-                 if (mapInfo[vvTried[n][i]].GetTriedBucket(nKey, m_asmap) != n)\n-                     return -17;\n-                 if (mapInfo[vvTried[n][i]].GetBucketPosition(nKey, false, n) != i)\n-                     return -18;\n-                 setTried.erase(vvTried[n][i]);\n+                assert(setTried.count(vvTried[n][i]));\n+                assert(mapInfo[vvTried[n][i]].GetTriedBucket(nKey, m_asmap) == n);\n+                assert(mapInfo[vvTried[n][i]].GetBucketPosition(nKey, false, n) == i);\n+                setTried.erase(vvTried[n][i]);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22500#discussion_r672440473",
      "id" : 672440473,
      "line" : 499,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3MjQ0MDQ3Mw==",
      "original_commit_id" : "cccc47b0ef5af66c8e6349d7cef60b902b80bc09",
      "original_line" : 499,
      "original_position" : 72,
      "original_start_line" : null,
      "path" : "src/addrman.cpp",
      "position" : 74,
      "pull_request_review_id" : 709737268,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22500",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-19T16:14:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/672440473",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22500#discussion_r672440785"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22500"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/672440785"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```diff\r\n     //! Consistency check\r\n-    void Check()\r\n-        EXCLUSIVE_LOCKS_REQUIRED(cs);\r\n+    void Check() EXCLUSIVE_LOCKS_REQUIRED(cs);\r\n```\r\n",
      "commit_id" : "fa4bfef4798466e986569baf0d8e3213f17cafc8",
      "created_at" : "2021-07-19T16:13:45Z",
      "diff_hunk" : "@@ -722,21 +722,7 @@ class CAddrMan\n \n     //! Consistency check\n     void Check()\n-        EXCLUSIVE_LOCKS_REQUIRED(cs)\n-    {\n-#ifdef DEBUG_ADDRMAN\n-        AssertLockHeld(cs);\n-        const int err = Check_();\n-        if (err) {\n-            LogPrintf(\"ADDRMAN CONSISTENCY CHECK FAILED!!! err=%i\\n\", err);\n-        }\n-#endif\n-    }\n-\n-#ifdef DEBUG_ADDRMAN\n-    //! Perform consistency check. Returns an error code or zero.\n-    int Check_() EXCLUSIVE_LOCKS_REQUIRED(cs);\n-#endif\n+        EXCLUSIVE_LOCKS_REQUIRED(cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22500#discussion_r672440785",
      "id" : 672440785,
      "line" : 725,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3MjQ0MDc4NQ==",
      "original_commit_id" : "cccc47b0ef5af66c8e6349d7cef60b902b80bc09",
      "original_line" : 725,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 19,
      "pull_request_review_id" : 709737268,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22500",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-19T16:14:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/672440785",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   }
]
