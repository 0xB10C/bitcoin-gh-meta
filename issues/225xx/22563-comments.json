[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "This is somewhat hackish, but a very small change, in case it is desired for 22.0.\r\n\r\nThe underlying problem is that `CNetAddr::GetGroup()` and the places where it is called are build around the assumption that it is easier to obtain addresses with common prefix (e.g. belonging to one IP subnet). However this assumption is not true for Tor, I2P and CJDNS addresses.\r\n\r\nFor example, we would avoid connecting to `aabcd.onion` if we already have connection to `aaxyz.onion`, assuming that the common prefix makes it more likely they belong to the same actor.\r\n\r\n`CNetAddr::GetGroup()` only makes sense for the IPv4 and IPv6 networks. To resolve this properly a bigger refactor would be required - where we call `CNetAddr::GetGroup()` only for IPv4 and IPv6 addresses and treat Tor/I2P/CJDNS separately.\r\n",
      "created_at" : "2021-07-27T14:51:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22563#issuecomment-887579571",
      "id" : 887579571,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22563",
      "node_id" : "IC_kwDOABII584052Oz",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-27T14:51:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/887579571",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> The underlying problem is that CNetAddr::GetGroup() and the places where it is called are build around the assumption that it is easier to obtain addresses with common prefix (e.g. belonging to one IP subnet). \r\n\r\nDoesn't `CNetAddr::GetGroup()` in `netaddress.cpp` already have special casing for Tor/I2P/CJDNS  (`nBits = 4` , resulting in `num_bytes == 0` ) that would make this unnecessary (because it already treats `aabcd.onion` the same as `aaxyz.onion` and every other Tor address)?",
      "created_at" : "2021-07-27T15:31:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22563#issuecomment-887612757",
      "id" : 887612757,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22563",
      "node_id" : "IC_kwDOABII58405-VV",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-27T15:32:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/887612757",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't think so - currently `CNetAddr::GetGroup()` treats `aabcd.onion` and `aaxyz.onion` the same, but not the same as every other Tor address. The way I read it, `CNetAddr::GetGroup()` will return a vector of 2 bytes for a Tor address: the first byte will be `0x03` (`NET_ONION`), set here:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/979f410e69a0350da8bf67f329f760d4dd3a4f44/src/netaddress.cpp#L781\r\n\r\nthe second byte is set here:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/979f410e69a0350da8bf67f329f760d4dd3a4f44/src/netaddress.cpp#L814\r\n\r\nand will consist of the first 4 bits of the Tor address, followed by 4 1-bits.",
      "created_at" : "2021-07-27T15:41:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22563#issuecomment-887621152",
      "id" : 887621152,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22563",
      "node_id" : "IC_kwDOABII58406AYg",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-27T15:42:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/887621152",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "You are right, I missed the spot where the second byte is set.",
      "created_at" : "2021-07-27T16:02:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22563#issuecomment-887637141",
      "id" : 887637141,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22563",
      "node_id" : "IC_kwDOABII58406ESV",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-27T16:02:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/887637141",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Your eyes, on their own, decided to skip the line that contains `] | ((1 << (8 - nBits)) - 1));` (mine did) :exploding_head: :rofl: ",
      "created_at" : "2021-07-27T16:15:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22563#issuecomment-887647228",
      "id" : 887647228,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22563",
      "node_id" : "IC_kwDOABII58406Gv8",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-27T16:15:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/887647228",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes, I wonder why :grinning:\r\n\r\nAnother question (still not sure I have completely understood the bucketing...): \r\nWouldn't this mean that addresses advertised to us by peers with a Tor address would always map to the same bucket/position, regardless of the source? And, as a result:\r\n1) if we only have Tor peers, we would only ever reach a multiplicity of one in the New tables, so that the `nRefCount` mechanism to give addrs advertised to us by many diverse peers more weight in New would no longer work in this situation?\r\n2) We'd only ever use 64 of the 1024 buckets for addrs received from Tor addresses",
      "created_at" : "2021-07-27T20:23:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22563#issuecomment-887809469",
      "id" : 887809469,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22563",
      "node_id" : "IC_kwDOABII58406uW9",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-27T21:02:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/887809469",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   }
]
