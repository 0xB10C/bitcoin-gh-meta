[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Ping @jnewbery, since https://github.com/bitcoin/bitcoin/pull/21866#issuecomment-858536566 :relaxed: ",
      "created_at" : "2021-07-27T20:02:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22564#issuecomment-887796309",
      "id" : 887796309,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22564",
      "node_id" : "IC_kwDOABII58406rJV",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-27T20:02:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/887796309",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK. Globals must fall!",
      "created_at" : "2021-07-27T21:48:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22564#issuecomment-887856830",
      "id" : 887856830,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22564",
      "node_id" : "IC_kwDOABII5840656-",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-27T21:48:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/887856830",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #22597 by ajtowns\n* #22290 by glozow\n* #22242 by MarcoFalke\n* #21526 by jamesob\n* #19888 by fjahr\n* #19790 by luke-jr\n* #10443 by ryanofsky\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-07-28T10:06:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22564#issuecomment-888183043",
      "id" : 888183043,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22564",
      "node_id" : "IC_kwDOABII58408JkD",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-03T11:02:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/888183043",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r680503657"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/680503657"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hard NACK -- the signatures for the two versions of `DeploymentActiveAfter` (and `..At`) should only differ by whether they accept a `DeploymentPos` or a `BuriedDeployment`, otherwise we're back to having to edit bunches of call sites when burying deployments.\r\n\r\nBUT... I think you can get the result you're trying for by making `DeploymentActiveAfter` (and `..At`) inline member functions of `BlockManager`. Proof of concept at https://github.com/ajtowns/bitcoin/commits/202108-deplotmentstatus-blockmanager\r\n\r\nWould it be feasible to move `BlockManager` to its own module to reduce the amount of stuff validation.cpp does? Giving BlockManager a `CChainParams` member reference and having `CChainState` and `ChainstateManager` reference it via their BlockManager references, and also removing the `Consensus::Params` and `CChainParams` params from bunches of functions (including the `DeploymentActive..` ones) seems like it would be a win.",
      "commit_id" : "f741623c25455c20bff9eb1ddd10a4ac84dc5655",
      "created_at" : "2021-08-01T12:23:58Z",
      "diff_hunk" : "@@ -10,20 +10,17 @@\n \n #include <limits>\n \n-/** Global cache for versionbits deployment status */\n-extern VersionBitsCache g_versionbitscache;\n-\n /** Determine if a deployment is active for the next block */\n inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::BuriedDeployment dep)\n {\n     assert(Consensus::ValidDeployment(dep));\n     return (pindexPrev == nullptr ? 0 : pindexPrev->nHeight + 1) >= params.DeploymentHeight(dep);\n }\n \n-inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos dep)\n+inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos dep, VersionBitsCache& versionbitscache)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r680503657",
      "id" : 680503657,
      "line" : 20,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MDUwMzY1Nw==",
      "original_commit_id" : "4d00171fc52d9304084e589cf067ff5ed11754b3",
      "original_line" : 20,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/deploymentstatus.h",
      "position" : 15,
      "pull_request_review_id" : 719657071,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-01T13:59:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/680503657",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r680508909"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/680508909"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Note that there shouldn't be any logical need for this to be cleared here -- the cached information doesn't become invalid when we load up different blocks, only if the consensus parameters are changed.",
      "commit_id" : "f741623c25455c20bff9eb1ddd10a4ac84dc5655",
      "created_at" : "2021-08-01T13:06:26Z",
      "diff_hunk" : "@@ -4106,7 +4107,6 @@ void UnloadBlockIndex(CTxMemPool* mempool, ChainstateManager& chainman)\n     LOCK(cs_main);\n     chainman.Unload();\n     if (mempool) mempool->clear();\n-    g_versionbitscache.Clear();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r680508909",
      "id" : 680508909,
      "line" : 4111,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MDUwODkwOQ==",
      "original_commit_id" : "4d00171fc52d9304084e589cf067ff5ed11754b3",
      "original_line" : 4109,
      "original_position" : 86,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 577,
      "pull_request_review_id" : 719657071,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-01T13:58:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/680508909",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r680513805"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/680513805"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Should be `auto& i : warningcache` ??",
      "commit_id" : "f741623c25455c20bff9eb1ddd10a4ac84dc5655",
      "created_at" : "2021-08-01T13:44:15Z",
      "diff_hunk" : "@@ -4107,8 +4107,8 @@ void UnloadBlockIndex(CTxMemPool* mempool, ChainstateManager& chainman)\n     LOCK(cs_main);\n     chainman.Unload();\n     if (mempool) mempool->clear();\n-    for (int b = 0; b < VERSIONBITS_NUM_BITS; b++) {\n-        warningcache[b].clear();\n+    for (auto i : warningcache) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r680513805",
      "id" : 680513805,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MDUxMzgwNQ==",
      "original_commit_id" : "6b0a3bc7bd80a8e0dc1f59dbc89bd211ac6a7c1e",
      "original_line" : 4110,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 719657071,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-01T13:58:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/680513805",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r680518852"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/680518852"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Wouldn't another class in validation be better suited to host the deployment status? My goal was to move BlockManger to node/storage and have it deal with storage only, not validation. ",
      "commit_id" : "f741623c25455c20bff9eb1ddd10a4ac84dc5655",
      "created_at" : "2021-08-01T14:24:19Z",
      "diff_hunk" : "@@ -10,20 +10,17 @@\n \n #include <limits>\n \n-/** Global cache for versionbits deployment status */\n-extern VersionBitsCache g_versionbitscache;\n-\n /** Determine if a deployment is active for the next block */\n inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::BuriedDeployment dep)\n {\n     assert(Consensus::ValidDeployment(dep));\n     return (pindexPrev == nullptr ? 0 : pindexPrev->nHeight + 1) >= params.DeploymentHeight(dep);\n }\n \n-inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos dep)\n+inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos dep, VersionBitsCache& versionbitscache)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r680518852",
      "id" : 680518852,
      "in_reply_to_id" : 680503657,
      "line" : 20,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MDUxODg1Mg==",
      "original_commit_id" : "4d00171fc52d9304084e589cf067ff5ed11754b3",
      "original_line" : 20,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/deploymentstatus.h",
      "position" : 15,
      "pull_request_review_id" : 719668013,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-01T14:24:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/680518852",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r680522667"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/680522667"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@MarcoFalke Maybe? I look at deployment status as an expansion of Consensus::Params -- so more as input to validation than a result of it. If we switch to using the coinbase witness nonce for deployment signalling we'd need to change the way we store blocks so that it's easy to access that info without having to load every signalling block from disk, so it's kind-of storage related in that sense?",
      "commit_id" : "f741623c25455c20bff9eb1ddd10a4ac84dc5655",
      "created_at" : "2021-08-01T14:52:31Z",
      "diff_hunk" : "@@ -10,20 +10,17 @@\n \n #include <limits>\n \n-/** Global cache for versionbits deployment status */\n-extern VersionBitsCache g_versionbitscache;\n-\n /** Determine if a deployment is active for the next block */\n inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::BuriedDeployment dep)\n {\n     assert(Consensus::ValidDeployment(dep));\n     return (pindexPrev == nullptr ? 0 : pindexPrev->nHeight + 1) >= params.DeploymentHeight(dep);\n }\n \n-inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos dep)\n+inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos dep, VersionBitsCache& versionbitscache)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r680522667",
      "id" : 680522667,
      "in_reply_to_id" : 680503657,
      "line" : 20,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MDUyMjY2Nw==",
      "original_commit_id" : "4d00171fc52d9304084e589cf067ff5ed11754b3",
      "original_line" : 20,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/deploymentstatus.h",
      "position" : 15,
      "pull_request_review_id" : 719670647,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-01T14:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/680522667",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r682041105"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/682041105"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> the signatures for the two versions of `DeploymentActiveAfter` (and `..At`) should only differ by whether they accept a `DeploymentPos` or a `BuriedDeployment`, otherwise we're back to having to edit bunches of call sites when burying deployments.\r\n\r\nOh I did not realize that this was the case! Note to self: add a code comment documenting this.\r\n\r\n> BUT... I think you can get the result you're trying for by making `DeploymentActiveAfter` (and `..At`) inline member functions of `BlockManager`. Proof of concept at https://github.com/ajtowns/bitcoin/commits/202108-deplotmentstatus-blockmanager\r\n\r\nThis looks good to me, and it seems like they would eventually end up having to interact with `BlockManager` anyway according to the following?\r\n\r\n> If we switch to using the coinbase witness nonce for deployment signalling we'd need to change the way we store blocks so that it's easy to access that info without having to load every signalling block from disk, so it's kind-of storage related in that sense?\r\n\r\n-----\r\n\r\n> Would it be feasible to move `BlockManager` to its own module to reduce the amount of stuff validation.cpp does? Giving BlockManager a `CChainParams` member reference and having `CChainState` and `ChainstateManager` reference it via their BlockManager references, and also removing the `Consensus::Params` and `CChainParams` params from bunches of functions (including the `DeploymentActive..` ones) seems like it would be a win.\r\n\r\nYes I think as part of some other work I'll have to pull validation apart anyway, I will look into this!",
      "commit_id" : "f741623c25455c20bff9eb1ddd10a4ac84dc5655",
      "created_at" : "2021-08-03T19:27:49Z",
      "diff_hunk" : "@@ -10,20 +10,17 @@\n \n #include <limits>\n \n-/** Global cache for versionbits deployment status */\n-extern VersionBitsCache g_versionbitscache;\n-\n /** Determine if a deployment is active for the next block */\n inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::BuriedDeployment dep)\n {\n     assert(Consensus::ValidDeployment(dep));\n     return (pindexPrev == nullptr ? 0 : pindexPrev->nHeight + 1) >= params.DeploymentHeight(dep);\n }\n \n-inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos dep)\n+inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos dep, VersionBitsCache& versionbitscache)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r682041105",
      "id" : 682041105,
      "in_reply_to_id" : 680503657,
      "line" : 20,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MjA0MTEwNQ==",
      "original_commit_id" : "4d00171fc52d9304084e589cf067ff5ed11754b3",
      "original_line" : 20,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/deploymentstatus.h",
      "position" : 15,
      "pull_request_review_id" : 721567946,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-03T19:27:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/682041105",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r694260466"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694260466"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"No more heap BlockIndices\" (6a897c0601dff4f116b1ab223595c5c2fac0e7a3)\r\n\r\nComment seems to lack a little context, maybe prefix with \"Because validation code takes pointers to the map's CBlockIndex objects, if we ever switch...\"",
      "commit_id" : "f741623c25455c20bff9eb1ddd10a4ac84dc5655",
      "created_at" : "2021-08-23T19:46:31Z",
      "diff_hunk" : "@@ -107,7 +107,12 @@ enum class SynchronizationState {\n };\n \n extern RecursiveMutex cs_main;\n-typedef std::unordered_map<uint256, CBlockIndex*, BlockHasher> BlockMap;\n+\n+// If we ever switch to another associative container, we need to either use a",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r694260466",
      "id" : 694260466,
      "line" : 111,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NDI2MDQ2Ng==",
      "original_commit_id" : "6a897c0601dff4f116b1ab223595c5c2fac0e7a3",
      "original_line" : 111,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 14,
      "pull_request_review_id" : 736503538,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-23T19:51:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694260466",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Pushed f741623c25 -> 6e6472e6dc\r\n- Address https://github.com/bitcoin/bitcoin/pull/22564#discussion_r694260466\r\n- Address https://github.com/bitcoin/bitcoin/pull/22564#discussion_r680513805",
      "created_at" : "2021-08-24T17:57:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22564#issuecomment-904855311",
      "id" : 904855311,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22564",
      "node_id" : "IC_kwDOABII58417v8P",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-24T17:57:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/904855311",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r695141648"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/695141648"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Is this the same case for `warningcache` as well? If so, perhaps we'll just move the clearing logic to `SelectParams` and not move these two structures into `BlockManager`?",
      "commit_id" : "6bb9ed3f62b99f14730cc469e9fb651d0739448d",
      "created_at" : "2021-08-24T19:29:37Z",
      "diff_hunk" : "@@ -4106,7 +4107,6 @@ void UnloadBlockIndex(CTxMemPool* mempool, ChainstateManager& chainman)\n     LOCK(cs_main);\n     chainman.Unload();\n     if (mempool) mempool->clear();\n-    g_versionbitscache.Clear();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r695141648",
      "id" : 695141648,
      "in_reply_to_id" : 680508909,
      "line" : 4091,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NTE0MTY0OA==",
      "original_commit_id" : "4d00171fc52d9304084e589cf067ff5ed11754b3",
      "original_line" : 4091,
      "original_position" : 86,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 577,
      "pull_request_review_id" : 737608619,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-24T19:29:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/695141648",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r695824018"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/695824018"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Move pindexBest{Header,Invalid} to BlockManager\" (9fdf6825bc6a3a27b23b7a1015afc33b3a62effd)\r\n\r\nIs there a reason these are moved to BlockManager class instead of ChainstateManager class? I don't see anywhere where the blockmanager class itself is accessing these members, and I don't see any references to this through any blockmanager reference except the ChainStateManager::m_blockman one. These are also set from chain state not block state, so it seems like these are more related to chain state functionality than  in block manager. Maybe ideally it would be a would be a private ChainStateManager member?\r\n\r\nI'm not sure about this and maybe it doesn't matter, but it would be good to at least hint at what the thinking is behind the move destination is in the commit description.",
      "commit_id" : "6bb9ed3f62b99f14730cc469e9fb651d0739448d",
      "created_at" : "2021-08-25T14:42:37Z",
      "diff_hunk" : "@@ -430,6 +427,11 @@ class BlockManager\n       */\n     std::set<CBlockIndex*> m_failed_blocks;\n \n+    CBlockIndex* pindexBestInvalid = nullptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r695824018",
      "id" : 695824018,
      "line" : 435,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NTgyNDAxOA==",
      "original_commit_id" : "9fdf6825bc6a3a27b23b7a1015afc33b3a62effd",
      "original_line" : 430,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 42,
      "pull_request_review_id" : 738449978,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-25T15:51:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/695824018",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r695841110"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/695841110"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Move setDirty{BlockIndex,FileInfo} to BlockManager\" (feb62ff2a0af6fedfaa3078b1a512416cdf71264)\r\n\r\nShould just delete these old function declarations (now that they are member functions)",
      "commit_id" : "6bb9ed3f62b99f14730cc469e9fb651d0739448d",
      "created_at" : "2021-08-25T14:59:53Z",
      "diff_hunk" : "@@ -73,9 +73,9 @@ bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const FlatFilePos& pos, c\n bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const CBlockIndex* pindex, const CMessageHeader::MessageStartChars& message_start);\n \n bool UndoReadFromDisk(CBlockUndo& blockundo, const CBlockIndex* pindex);\n-bool WriteUndoDataForBlock(const CBlockUndo& blockundo, BlockValidationState& state, CBlockIndex* pindex, const CChainParams& chainparams);\n+// bool WriteUndoDataForBlock(const CBlockUndo& blockundo, BlockValidationState& state, CBlockIndex* pindex, const CChainParams& chainparams);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r695841110",
      "id" : 695841110,
      "line" : 74,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NTg0MTExMA==",
      "original_commit_id" : "feb62ff2a0af6fedfaa3078b1a512416cdf71264",
      "original_line" : 76,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.h",
      "position" : 39,
      "pull_request_review_id" : 738449978,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-25T15:51:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/695841110",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r695846531"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/695846531"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Move setDirty{BlockIndex,FileInfo} to BlockManager\" (feb62ff2a0af6fedfaa3078b1a512416cdf71264)\r\n\r\nCan these clears which are moved from `UnloadBlockIndex` to `BlockManager::Unload` be done in a different commit before all the other changes in this commit? It's confusing because `UnloadBlockIndex` isn't even calling `BlockManager::Unload` directly, but indirectly through the `ChainstateManager::Unload` method. Another reason it would be nice to have the change in a standalone commit would be to describe what is motivating the move.\r\n\r\nAdditionally, maybe separately it would be good to flatten the existing call chain here, because it doesn't seem to make much sense outwardly and seems unnecessarily complex. It seems like `ChainstateManager::Unload` is only called one place and could be removed and inlined. Also `CChainState::UnloadBlockIndex` looks like it's only called one place and could be removed and inlined. Another reason it would be great to drop that one is the confusing name clash between the member function and the global function.",
      "commit_id" : "6bb9ed3f62b99f14730cc469e9fb651d0739448d",
      "created_at" : "2021-08-25T15:05:44Z",
      "diff_hunk" : "@@ -3746,6 +3744,9 @@ void BlockManager::Unload() {\n \n     pindexBestInvalid = nullptr;\n     pindexBestHeader = nullptr;\n+\n+    setDirtyBlockIndex.clear();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r695846531",
      "id" : 695846531,
      "line" : 3744,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NTg0NjUzMQ==",
      "original_commit_id" : "feb62ff2a0af6fedfaa3078b1a512416cdf71264",
      "original_line" : 3748,
      "original_position" : 133,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 508,
      "pull_request_review_id" : 738449978,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-25T15:51:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/695846531",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r695871478"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/695871478"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Move setDirty{BlockIndex,FileInfo} to BlockManager\" (feb62ff2a0af6fedfaa3078b1a512416cdf71264)\r\n\r\nMoving these variables to BlockManager makes more sense to me than moving pIndexBest variables in the prior commit, but it would helpful to say why this move destination makes sense in the commit description. Maybe \"Move these variables to block manager because they are used to update the block index on disk. In the future it might make sense move more logic responsible for updating and writing the block index to the block manager class and make these variables private instead of public.\"",
      "commit_id" : "6bb9ed3f62b99f14730cc469e9fb651d0739448d",
      "created_at" : "2021-08-25T15:32:40Z",
      "diff_hunk" : "@@ -432,6 +432,12 @@ class BlockManager\n     /** Best header we've seen so far (used for getheaders queries' starting points). */\n     CBlockIndex *pindexBestHeader = nullptr;\n \n+    /** Dirty block index entries. */\n+    std::set<CBlockIndex*> setDirtyBlockIndex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r695871478",
      "id" : 695871478,
      "line" : 441,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NTg3MTQ3OA==",
      "original_commit_id" : "feb62ff2a0af6fedfaa3078b1a512416cdf71264",
      "original_line" : 436,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 48,
      "pull_request_review_id" : 738449978,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-25T15:51:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/695871478",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r695941754"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/695941754"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I believe they are accessed by `BlockManager` here: https://github.com/bitcoin/bitcoin/blob/21438d55d553ae5bf3be7c0d4431aaf136db6c6b/src/validation.cpp#L3732-L3737\r\n\r\nAdditionally (and I'd like feedback on if this makes sense), it seems to me that variables whose type involve `CBlockIndex*` should likely live an die with the `BlockManager` since it owns the `BlockMap` entries to which these pointers are pointing.",
      "commit_id" : "6bb9ed3f62b99f14730cc469e9fb651d0739448d",
      "created_at" : "2021-08-25T16:59:12Z",
      "diff_hunk" : "@@ -430,6 +427,11 @@ class BlockManager\n       */\n     std::set<CBlockIndex*> m_failed_blocks;\n \n+    CBlockIndex* pindexBestInvalid = nullptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r695941754",
      "id" : 695941754,
      "in_reply_to_id" : 695824018,
      "line" : 435,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NTk0MTc1NA==",
      "original_commit_id" : "9fdf6825bc6a3a27b23b7a1015afc33b3a62effd",
      "original_line" : 430,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 42,
      "pull_request_review_id" : 738604066,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-25T16:59:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/695941754",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r695978717"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/695978717"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> I believe they are accessed by `BlockManager` here:\r\n> \r\n> https://github.com/bitcoin/bitcoin/blob/21438d55d553ae5bf3be7c0d4431aaf136db6c6b/src/validation.cpp#L3732-L3737\r\n> \r\n> Additionally (and I'd like feedback on if this makes sense), it seems to me that variables whose type involve `CBlockIndex*` should likely live an die with the `BlockManager` since it owns the `BlockMap` entries to which these pointers are pointing.\r\n\r\nRegardless of what should happen with these two variables I would definitely push back against this logic. CBlockIndex pointers are used in all kinds of code that has nothing to do with the actual block index, just as convenient and easy way to refer to blocks. If you tried to move all CBlockIndex type variables into BlockManager, you would be moving validation logic and indexing logic (and even wallet logic prior to #10973) into the BlockManager class where it pretty clearly does not belong.\r\n\r\nI think class state should generally be located in the class accessing and updating that state. It doesn't usually make sense for one class to store state on behalf on another class that it never accesses or uses itself. And probably ideally, all of these classes would have private state that would not be directly manipulated by other classes at all.",
      "commit_id" : "6bb9ed3f62b99f14730cc469e9fb651d0739448d",
      "created_at" : "2021-08-25T17:41:34Z",
      "diff_hunk" : "@@ -430,6 +427,11 @@ class BlockManager\n       */\n     std::set<CBlockIndex*> m_failed_blocks;\n \n+    CBlockIndex* pindexBestInvalid = nullptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r695978717",
      "id" : 695978717,
      "in_reply_to_id" : 695824018,
      "line" : 435,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NTk3ODcxNw==",
      "original_commit_id" : "9fdf6825bc6a3a27b23b7a1015afc33b3a62effd",
      "original_line" : 430,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 42,
      "pull_request_review_id" : 738655462,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-25T17:41:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/695978717",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r695990703"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/695990703"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Looking at your link more it does make some sense to me to keep these variables here if they can be derived directly from block index data like that.\r\n\r\nThe boundaries are definitely a little blurry here and in longer run I'd be inclined to want to move this logic out of the Block Manager class so it is just responsible storing the index data and not interpreting it so much. In short run I would add additional `CBlockIndex*&best_header` and `CBlockIndex*&best_invalid_header` output parameters so the LoadBlockIndex can keep the same logic and just return the information.\r\n\r\nBut now that I see what motivated moving these variables here, I don't think it's crazy to keep the variables here either. So you should do what seems best to you, and thanks for clarifying!",
      "commit_id" : "6bb9ed3f62b99f14730cc469e9fb651d0739448d",
      "created_at" : "2021-08-25T17:58:17Z",
      "diff_hunk" : "@@ -430,6 +427,11 @@ class BlockManager\n       */\n     std::set<CBlockIndex*> m_failed_blocks;\n \n+    CBlockIndex* pindexBestInvalid = nullptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r695990703",
      "id" : 695990703,
      "in_reply_to_id" : 695824018,
      "line" : 435,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NTk5MDcwMw==",
      "original_commit_id" : "9fdf6825bc6a3a27b23b7a1015afc33b3a62effd",
      "original_line" : 430,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 42,
      "pull_request_review_id" : 738670688,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-25T17:58:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/695990703",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r696827015"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/696827015"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: Add missing cs_LastBlockFile locks in PruneAndFlush() and UnloadBlockIndex(). Add missing locking annotation for nLastBlockFile and fCheckForPruning.\" (ccd6ec5e620dbb3ae251b3511d00aaf3614e97da)\r\n\r\nI think `GUARDED_BY(cs_LastBlockFile)` should be added here to the `vinfoBlockFile` variable as well. The \"last block\" mutex name is confusing, but I believe the naming only ended up that way  because the vinfo variable was added in a later commit ed6d1a2c7be9d046d5e78330d5e163023a6b302a than the last block variables 5382bcf8cd23c36a435c29080770a79b5e28af42. From the code it looks pretty clearly like the mutex is meant to cover all the variables, and it seems to be always locked when accessing them (except during unloading/loading where other locks have been elided as well).",
      "commit_id" : "6bb9ed3f62b99f14730cc469e9fb651d0739448d",
      "created_at" : "2021-08-26T17:13:50Z",
      "diff_hunk" : "@@ -28,12 +28,12 @@ uint64_t nPruneTarget = 0;\n // TODO make namespace {\n RecursiveMutex cs_LastBlockFile;\n std::vector<CBlockFileInfo> vinfoBlockFile;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r696827015",
      "id" : 696827015,
      "line" : 29,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NjgyNzAxNQ==",
      "original_commit_id" : "ccd6ec5e620dbb3ae251b3511d00aaf3614e97da",
      "original_line" : 30,
      "original_position" : 3,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 10,
      "pull_request_review_id" : 739739848,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-26T17:14:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/696827015",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r697576048"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/697576048"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: Add missing cs_nBlockSequenceId lock in UnloadBlockIndex(). Add missing locking annotation for nBlockSequenceId.\" (7c3f21a5c16e83ef6baacbcd600d15a470ff1e5b)\r\n\r\nTwo notes for future improvements:\r\n\r\n- Looking at actual `nBlockSequenceId` uses, it is really just used as an atomic, and could be replaced with an atomic and the mutex could be eliminated with no change in behavior.\r\n- nBlockReverseSequenceId below should have GUARDED_BY(cs_main)",
      "commit_id" : "6bb9ed3f62b99f14730cc469e9fb651d0739448d",
      "created_at" : "2021-08-27T16:35:46Z",
      "diff_hunk" : "@@ -573,7 +573,7 @@ class CChainState\n      */\n     RecursiveMutex cs_nBlockSequenceId;\n     /** Blocks loaded from disk are assigned id 0, so start the counter at 1. */\n-    int32_t nBlockSequenceId = 1;\n+    int32_t nBlockSequenceId GUARDED_BY(cs_nBlockSequenceId) = 1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r697576048",
      "id" : 697576048,
      "line" : 611,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NzU3NjA0OA==",
      "original_commit_id" : "7c3f21a5c16e83ef6baacbcd600d15a470ff1e5b",
      "original_line" : 576,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 119,
      "pull_request_review_id" : 740704160,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-27T17:08:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/697576048",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r697585112"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/697585112"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Move cs_LastBlockFile guarded objects to BlockManager\" (ca77cd53abb455847094cecdc11b217c64166de8)\r\n\r\nShould fully remove this declaration and the one below",
      "commit_id" : "6bb9ed3f62b99f14730cc469e9fb651d0739448d",
      "created_at" : "2021-08-27T16:50:58Z",
      "diff_hunk" : "@@ -55,11 +55,11 @@ FILE* OpenBlockFile(const FlatFilePos& pos, bool fReadOnly = false);\n /** Translation to a filesystem path */\n fs::path GetBlockPosFilename(const FlatFilePos& pos);\n \n-/** Get block file info entry for one block file */\n-CBlockFileInfo* GetBlockFileInfo(size_t n);\n+// /** Get block file info entry for one block file */\n+// CBlockFileInfo* GetBlockFileInfo(size_t n);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r697585112",
      "id" : 697585112,
      "line" : 57,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NzU4NTExMg==",
      "original_commit_id" : "ca77cd53abb455847094cecdc11b217c64166de8",
      "original_line" : 59,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.h",
      "position" : 25,
      "pull_request_review_id" : 740704160,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-27T17:08:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/697585112",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r697587487"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/697587487"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Move cs_LastBlockFile guarded objects to BlockManager\" (ca77cd53abb455847094cecdc11b217c64166de8)\r\n\r\nIt would seem better to keep this comment which is still summarizing behavior of this block of code.",
      "commit_id" : "6bb9ed3f62b99f14730cc469e9fb651d0739448d",
      "created_at" : "2021-08-27T16:55:05Z",
      "diff_hunk" : "@@ -39,11 +38,14 @@ BOOST_AUTO_TEST_CASE(validation_chainstate_resize_caches)\n     CChainState& c1 = WITH_LOCK(cs_main, return manager.InitializeChainstate(&mempool));\n     c1.InitCoinsDB(\n         /* cache_size_bytes */ 1 << 23, /* in_memory */ true, /* should_wipe */ false);\n-    WITH_LOCK(::cs_main, c1.InitCoinsCache(1 << 23));\n \n-    // Add a coin to the in-memory cache, upsize once, then downsize.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r697587487",
      "id" : 697587487,
      "line" : 44,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NzU4NzQ4Nw==",
      "original_commit_id" : "ca77cd53abb455847094cecdc11b217c64166de8",
      "original_line" : 44,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstate_tests.cpp",
      "position" : 25,
      "pull_request_review_id" : 740704160,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-27T17:08:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/697587487",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r697594297"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/697594297"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Move cs_LastBlockFile guarded objects to BlockManager\" (ca77cd53abb455847094cecdc11b217c64166de8)\r\n\r\nI guess this is a preexisting thing better to address in a different PR, but it seems wrong if cs_main is required to get a *pointer* to blockman from the chainman. I didn't look but ideally the blockman pointer would be set once in the chainman constructor and could just be const. Or even if it could not be const for some reason, it could be atomic and not require a validation lock.",
      "commit_id" : "6bb9ed3f62b99f14730cc469e9fb651d0739448d",
      "created_at" : "2021-08-27T17:07:00Z",
      "diff_hunk" : "@@ -84,7 +84,7 @@ BOOST_FIXTURE_TEST_CASE(scan_for_wallet_transactions, TestChain100Setup)\n {\n     // Cap last block file size, and mine new block in a new block file.\n     CBlockIndex* oldTip = m_node.chainman->ActiveChain().Tip();\n-    GetBlockFileInfo(oldTip->GetBlockPos().nFile)->nSize = MAX_BLOCKFILE_SIZE;\n+    (*WITH_LOCK(::cs_main, return &m_node.chainman->m_blockman)).GetBlockFileInfo(oldTip->GetBlockPos().nFile)->nSize = MAX_BLOCKFILE_SIZE;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r697594297",
      "id" : 697594297,
      "line" : 87,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NzU5NDI5Nw==",
      "original_commit_id" : "ca77cd53abb455847094cecdc11b217c64166de8",
      "original_line" : 87,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/test/wallet_tests.cpp",
      "position" : 5,
      "pull_request_review_id" : 740704160,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-27T17:08:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/697594297",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   }
]
