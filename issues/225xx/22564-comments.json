[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Ping @jnewbery, since https://github.com/bitcoin/bitcoin/pull/21866#issuecomment-858536566 :relaxed: ",
      "created_at" : "2021-07-27T20:02:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22564#issuecomment-887796309",
      "id" : 887796309,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22564",
      "node_id" : "IC_kwDOABII58406rJV",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-27T20:02:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/887796309",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK. Globals must fall!",
      "created_at" : "2021-07-27T21:48:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22564#issuecomment-887856830",
      "id" : 887856830,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22564",
      "node_id" : "IC_kwDOABII5840656-",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-27T21:48:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/887856830",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #22597 by ajtowns\n* #22290 by glozow\n* #22242 by MarcoFalke\n* #21526 by jamesob\n* #19888 by fjahr\n* #19790 by luke-jr\n* #10443 by ryanofsky\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-07-28T10:06:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22564#issuecomment-888183043",
      "id" : 888183043,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22564",
      "node_id" : "IC_kwDOABII58408JkD",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-03T11:02:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/888183043",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r680503657"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/680503657"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hard NACK -- the signatures for the two versions of `DeploymentActiveAfter` (and `..At`) should only differ by whether they accept a `DeploymentPos` or a `BuriedDeployment`, otherwise we're back to having to edit bunches of call sites when burying deployments.\r\n\r\nBUT... I think you can get the result you're trying for by making `DeploymentActiveAfter` (and `..At`) inline member functions of `BlockManager`. Proof of concept at https://github.com/ajtowns/bitcoin/commits/202108-deplotmentstatus-blockmanager\r\n\r\nWould it be feasible to move `BlockManager` to its own module to reduce the amount of stuff validation.cpp does? Giving BlockManager a `CChainParams` member reference and having `CChainState` and `ChainstateManager` reference it via their BlockManager references, and also removing the `Consensus::Params` and `CChainParams` params from bunches of functions (including the `DeploymentActive..` ones) seems like it would be a win.",
      "commit_id" : "f741623c25455c20bff9eb1ddd10a4ac84dc5655",
      "created_at" : "2021-08-01T12:23:58Z",
      "diff_hunk" : "@@ -10,20 +10,17 @@\n \n #include <limits>\n \n-/** Global cache for versionbits deployment status */\n-extern VersionBitsCache g_versionbitscache;\n-\n /** Determine if a deployment is active for the next block */\n inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::BuriedDeployment dep)\n {\n     assert(Consensus::ValidDeployment(dep));\n     return (pindexPrev == nullptr ? 0 : pindexPrev->nHeight + 1) >= params.DeploymentHeight(dep);\n }\n \n-inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos dep)\n+inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos dep, VersionBitsCache& versionbitscache)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r680503657",
      "id" : 680503657,
      "line" : 20,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MDUwMzY1Nw==",
      "original_commit_id" : "4d00171fc52d9304084e589cf067ff5ed11754b3",
      "original_line" : 20,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/deploymentstatus.h",
      "position" : 15,
      "pull_request_review_id" : 719657071,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-01T13:59:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/680503657",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r680508909"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/680508909"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Note that there shouldn't be any logical need for this to be cleared here -- the cached information doesn't become invalid when we load up different blocks, only if the consensus parameters are changed.",
      "commit_id" : "f741623c25455c20bff9eb1ddd10a4ac84dc5655",
      "created_at" : "2021-08-01T13:06:26Z",
      "diff_hunk" : "@@ -4106,7 +4107,6 @@ void UnloadBlockIndex(CTxMemPool* mempool, ChainstateManager& chainman)\n     LOCK(cs_main);\n     chainman.Unload();\n     if (mempool) mempool->clear();\n-    g_versionbitscache.Clear();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r680508909",
      "id" : 680508909,
      "line" : 4111,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MDUwODkwOQ==",
      "original_commit_id" : "4d00171fc52d9304084e589cf067ff5ed11754b3",
      "original_line" : 4109,
      "original_position" : 86,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 577,
      "pull_request_review_id" : 719657071,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-01T13:58:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/680508909",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r680513805"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/680513805"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Should be `auto& i : warningcache` ??",
      "commit_id" : "f741623c25455c20bff9eb1ddd10a4ac84dc5655",
      "created_at" : "2021-08-01T13:44:15Z",
      "diff_hunk" : "@@ -4107,8 +4107,8 @@ void UnloadBlockIndex(CTxMemPool* mempool, ChainstateManager& chainman)\n     LOCK(cs_main);\n     chainman.Unload();\n     if (mempool) mempool->clear();\n-    for (int b = 0; b < VERSIONBITS_NUM_BITS; b++) {\n-        warningcache[b].clear();\n+    for (auto i : warningcache) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r680513805",
      "id" : 680513805,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MDUxMzgwNQ==",
      "original_commit_id" : "6b0a3bc7bd80a8e0dc1f59dbc89bd211ac6a7c1e",
      "original_line" : 4110,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 719657071,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-01T13:58:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/680513805",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r680518852"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/680518852"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Wouldn't another class in validation be better suited to host the deployment status? My goal was to move BlockManger to node/storage and have it deal with storage only, not validation. ",
      "commit_id" : "f741623c25455c20bff9eb1ddd10a4ac84dc5655",
      "created_at" : "2021-08-01T14:24:19Z",
      "diff_hunk" : "@@ -10,20 +10,17 @@\n \n #include <limits>\n \n-/** Global cache for versionbits deployment status */\n-extern VersionBitsCache g_versionbitscache;\n-\n /** Determine if a deployment is active for the next block */\n inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::BuriedDeployment dep)\n {\n     assert(Consensus::ValidDeployment(dep));\n     return (pindexPrev == nullptr ? 0 : pindexPrev->nHeight + 1) >= params.DeploymentHeight(dep);\n }\n \n-inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos dep)\n+inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos dep, VersionBitsCache& versionbitscache)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r680518852",
      "id" : 680518852,
      "in_reply_to_id" : 680503657,
      "line" : 20,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MDUxODg1Mg==",
      "original_commit_id" : "4d00171fc52d9304084e589cf067ff5ed11754b3",
      "original_line" : 20,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/deploymentstatus.h",
      "position" : 15,
      "pull_request_review_id" : 719668013,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-01T14:24:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/680518852",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r680522667"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/680522667"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@MarcoFalke Maybe? I look at deployment status as an expansion of Consensus::Params -- so more as input to validation than a result of it. If we switch to using the coinbase witness nonce for deployment signalling we'd need to change the way we store blocks so that it's easy to access that info without having to load every signalling block from disk, so it's kind-of storage related in that sense?",
      "commit_id" : "f741623c25455c20bff9eb1ddd10a4ac84dc5655",
      "created_at" : "2021-08-01T14:52:31Z",
      "diff_hunk" : "@@ -10,20 +10,17 @@\n \n #include <limits>\n \n-/** Global cache for versionbits deployment status */\n-extern VersionBitsCache g_versionbitscache;\n-\n /** Determine if a deployment is active for the next block */\n inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::BuriedDeployment dep)\n {\n     assert(Consensus::ValidDeployment(dep));\n     return (pindexPrev == nullptr ? 0 : pindexPrev->nHeight + 1) >= params.DeploymentHeight(dep);\n }\n \n-inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos dep)\n+inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos dep, VersionBitsCache& versionbitscache)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r680522667",
      "id" : 680522667,
      "in_reply_to_id" : 680503657,
      "line" : 20,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MDUyMjY2Nw==",
      "original_commit_id" : "4d00171fc52d9304084e589cf067ff5ed11754b3",
      "original_line" : 20,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/deploymentstatus.h",
      "position" : 15,
      "pull_request_review_id" : 719670647,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-01T14:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/680522667",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r682041105"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/682041105"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> the signatures for the two versions of `DeploymentActiveAfter` (and `..At`) should only differ by whether they accept a `DeploymentPos` or a `BuriedDeployment`, otherwise we're back to having to edit bunches of call sites when burying deployments.\r\n\r\nOh I did not realize that this was the case! Note to self: add a code comment documenting this.\r\n\r\n> BUT... I think you can get the result you're trying for by making `DeploymentActiveAfter` (and `..At`) inline member functions of `BlockManager`. Proof of concept at https://github.com/ajtowns/bitcoin/commits/202108-deplotmentstatus-blockmanager\r\n\r\nThis looks good to me, and it seems like they would eventually end up having to interact with `BlockManager` anyway according to the following?\r\n\r\n> If we switch to using the coinbase witness nonce for deployment signalling we'd need to change the way we store blocks so that it's easy to access that info without having to load every signalling block from disk, so it's kind-of storage related in that sense?\r\n\r\n-----\r\n\r\n> Would it be feasible to move `BlockManager` to its own module to reduce the amount of stuff validation.cpp does? Giving BlockManager a `CChainParams` member reference and having `CChainState` and `ChainstateManager` reference it via their BlockManager references, and also removing the `Consensus::Params` and `CChainParams` params from bunches of functions (including the `DeploymentActive..` ones) seems like it would be a win.\r\n\r\nYes I think as part of some other work I'll have to pull validation apart anyway, I will look into this!",
      "commit_id" : "f741623c25455c20bff9eb1ddd10a4ac84dc5655",
      "created_at" : "2021-08-03T19:27:49Z",
      "diff_hunk" : "@@ -10,20 +10,17 @@\n \n #include <limits>\n \n-/** Global cache for versionbits deployment status */\n-extern VersionBitsCache g_versionbitscache;\n-\n /** Determine if a deployment is active for the next block */\n inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::BuriedDeployment dep)\n {\n     assert(Consensus::ValidDeployment(dep));\n     return (pindexPrev == nullptr ? 0 : pindexPrev->nHeight + 1) >= params.DeploymentHeight(dep);\n }\n \n-inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos dep)\n+inline bool DeploymentActiveAfter(const CBlockIndex* pindexPrev, const Consensus::Params& params, Consensus::DeploymentPos dep, VersionBitsCache& versionbitscache)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r682041105",
      "id" : 682041105,
      "in_reply_to_id" : 680503657,
      "line" : 20,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MjA0MTEwNQ==",
      "original_commit_id" : "4d00171fc52d9304084e589cf067ff5ed11754b3",
      "original_line" : 20,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/deploymentstatus.h",
      "position" : 15,
      "pull_request_review_id" : 721567946,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-03T19:27:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/682041105",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r694260466"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694260466"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"No more heap BlockIndices\" (6a897c0601dff4f116b1ab223595c5c2fac0e7a3)\r\n\r\nComment seems to lack a little context, maybe prefix with \"Because validation code takes pointers to the map's CBlockIndex objects, if we ever switch...\"",
      "commit_id" : "f741623c25455c20bff9eb1ddd10a4ac84dc5655",
      "created_at" : "2021-08-23T19:46:31Z",
      "diff_hunk" : "@@ -107,7 +107,12 @@ enum class SynchronizationState {\n };\n \n extern RecursiveMutex cs_main;\n-typedef std::unordered_map<uint256, CBlockIndex*, BlockHasher> BlockMap;\n+\n+// If we ever switch to another associative container, we need to either use a",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22564#discussion_r694260466",
      "id" : 694260466,
      "line" : 111,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NDI2MDQ2Ng==",
      "original_commit_id" : "6a897c0601dff4f116b1ab223595c5c2fac0e7a3",
      "original_line" : 111,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 14,
      "pull_request_review_id" : 736503538,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22564",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-23T19:51:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694260466",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Pushed f741623c25 -> 6e6472e6dc\r\n- Address https://github.com/bitcoin/bitcoin/pull/22564#discussion_r694260466\r\n- Address https://github.com/bitcoin/bitcoin/pull/22564#discussion_r680513805",
      "created_at" : "2021-08-24T17:57:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22564#issuecomment-904855311",
      "id" : 904855311,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22564",
      "node_id" : "IC_kwDOABII58417v8P",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-24T17:57:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/904855311",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   }
]
