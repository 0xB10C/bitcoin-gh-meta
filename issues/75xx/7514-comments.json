[
   {
      "body" : "Are we sure this condition cannot happen on mainnet?\r\n\r\nIntroducing testnet-specific behavior is bad, as it makes testnet less useful as a proxy for testing mainnet. Also comparing strings here isn't acceptable - if you really need to do this it should be a flag on CChainParams. But I hope we can come up with a general solution.\r\n",
      "created_at" : "2016-02-11T09:11:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7514#issuecomment-182775643",
      "id" : 182775643,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7514",
      "updated_at" : "2016-02-11T09:11:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/182775643",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Thanks for the feedback. I agree, testnet-specific behavior should be avoided if at all possible, but the testnet-specific difficulty rules seem to be what is causing the problem. Maybe another solution would be to have the code that resets testnet difficulty after 20 minutes also reset the work value for pindexBestHeader so a new block with less work is able to replace it. I'm not sure where that happens, though, so I haven't been able to test it out.\r\n\r\nIt's also possible my theory isn't exactly correct. Currently, my pindexBestHash is set to a block with a height 2000 below the current tip, but the nChainWork is greater than the current tip. It doesn't show on any block explorers, so maybe it was set to a very high difficulty then orphaned.\r\n\r\nIn theory the same thing could happen on mainnet, but with the amount of mining power out there I can't imagine someone mining an orphaned block that still has more POW than the main chain 2000 blocks later.\r\n\r\nThoughts?",
      "created_at" : "2016-02-11T21:58:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7514#issuecomment-183076265",
      "id" : 183076265,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7514",
      "updated_at" : "2016-02-11T21:58:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/183076265",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5316685?v=3",
         "events_url" : "https://api.github.com/users/jmacwhyte/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jmacwhyte/followers",
         "following_url" : "https://api.github.com/users/jmacwhyte/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jmacwhyte/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jmacwhyte",
         "id" : 5316685,
         "login" : "jmacwhyte",
         "organizations_url" : "https://api.github.com/users/jmacwhyte/orgs",
         "received_events_url" : "https://api.github.com/users/jmacwhyte/received_events",
         "repos_url" : "https://api.github.com/users/jmacwhyte/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jmacwhyte/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jmacwhyte/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jmacwhyte"
      }
   },
   {
      "body" : "It's certainly possible for mainnet to have a chain with more blocks but lower total work. ",
      "created_at" : "2016-02-11T22:01:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7514#issuecomment-183077476",
      "id" : 183077476,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7514",
      "updated_at" : "2016-02-11T22:01:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/183077476",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "If that were the case, wouldn't the chain with more work be chosen as the active chain?",
      "created_at" : "2016-02-11T22:12:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7514#issuecomment-183081042",
      "id" : 183081042,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7514",
      "updated_at" : "2016-02-11T22:12:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/183081042",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5316685?v=3",
         "events_url" : "https://api.github.com/users/jmacwhyte/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jmacwhyte/followers",
         "following_url" : "https://api.github.com/users/jmacwhyte/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jmacwhyte/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jmacwhyte",
         "id" : 5316685,
         "login" : "jmacwhyte",
         "organizations_url" : "https://api.github.com/users/jmacwhyte/orgs",
         "received_events_url" : "https://api.github.com/users/jmacwhyte/received_events",
         "repos_url" : "https://api.github.com/users/jmacwhyte/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jmacwhyte/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jmacwhyte/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jmacwhyte"
      }
   },
   {
      "body" : "Yes, and that should be true for testnet too.",
      "created_at" : "2016-02-11T22:14:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7514#issuecomment-183081339",
      "id" : 183081339,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7514",
      "updated_at" : "2016-02-11T22:14:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/183081339",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "Can we therefore assume chainActive is what we always believe to the be the \"correct\" chain? If so, can we just check to see if chainActive is within 24 hours of us when doing the IsInitialBlockDownload check (instead of pindexBestHeader)? That's another solution I had thought of, but didn't know if it would have other implications on mainnet.",
      "created_at" : "2016-02-11T22:34:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7514#issuecomment-183087033",
      "id" : 183087033,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7514",
      "updated_at" : "2016-02-11T22:38:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/183087033",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5316685?v=3",
         "events_url" : "https://api.github.com/users/jmacwhyte/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jmacwhyte/followers",
         "following_url" : "https://api.github.com/users/jmacwhyte/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jmacwhyte/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jmacwhyte",
         "id" : 5316685,
         "login" : "jmacwhyte",
         "organizations_url" : "https://api.github.com/users/jmacwhyte/orgs",
         "received_events_url" : "https://api.github.com/users/jmacwhyte/received_events",
         "repos_url" : "https://api.github.com/users/jmacwhyte/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jmacwhyte/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jmacwhyte/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jmacwhyte"
      }
   },
   {
      "body" : "chainActive is the currently best fully validated chain, always.\r\n\r\nI think this issue can be fixed by using `std::max(chainActive.Tip()->GetBlockTime(), pindexBestHeader->GetBlockTime())` instead of just `pindexBestHeader->GetBlockTime()`.",
      "created_at" : "2016-02-11T22:39:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7514#issuecomment-183088282",
      "id" : 183088282,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7514",
      "updated_at" : "2016-02-11T22:39:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/183088282",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "I think that's a great idea. As long as it only triggers until the node thinks it's close to finishing the initial block download, this method will accomplish its purpose. Either using the active chain or the best header should work.\r\n\r\nI have updated the pull request.",
      "created_at" : "2016-02-12T02:06:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7514#issuecomment-183149443",
      "id" : 183149443,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7514",
      "updated_at" : "2016-02-12T02:06:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/183149443",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5316685?v=3",
         "events_url" : "https://api.github.com/users/jmacwhyte/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jmacwhyte/followers",
         "following_url" : "https://api.github.com/users/jmacwhyte/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jmacwhyte/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jmacwhyte",
         "id" : 5316685,
         "login" : "jmacwhyte",
         "organizations_url" : "https://api.github.com/users/jmacwhyte/orgs",
         "received_events_url" : "https://api.github.com/users/jmacwhyte/received_events",
         "repos_url" : "https://api.github.com/users/jmacwhyte/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jmacwhyte/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jmacwhyte/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jmacwhyte"
      }
   },
   {
      "body" : "> The nChainWork calculation can cause pindexBestHeader to be set with an old block that has more work than chainActive.Tip().\r\n\r\nIf it's an old block (ie, presumably one we have), shouldn't it be the active tip???",
      "created_at" : "2016-02-13T02:49:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/7514#issuecomment-183570013",
      "id" : 183570013,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/7514",
      "updated_at" : "2016-02-13T02:49:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/183570013",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   }
]
