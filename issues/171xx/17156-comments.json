[
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK\r\n\r\nThanks for addressing these issues quickly! :) Will test.",
      "created_at" : "2019-10-15T22:50:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17156#issuecomment-542437438",
      "id" : 542437438,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17156",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0MjQzNzQzOA==",
      "updated_at" : "2019-10-15T22:51:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/542437438",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "With this patch applied the PSBT fuzzer appears to be unable to trigger the problematic conditions listed in the issue #17149.\r\n\r\nHowever, I noticed that using the following 202 byte input:\r\n\r\n```\r\n70736274ff01009a020000000258e87a21b56daf0c23be8e7070456c336f\r\n7cbaa5c8757924f545887bb282dd750000000000ffffffff838d0427d0ec\r\n650a68aa46bb0b098aea4422c071b2ca78352a077959d07cea1d01000000\r\n00ffffffff0270aaf00800000000160014d85c2b71d0060b09c9886aeb81\r\n5e50991dda124d00e1f5050000000016001400aea9a2e5f0f876a588df55\r\n46e8742d202020ffff603016000001012000c2eb0b000000001714a9b7f5\r\nfaff09090010610000db2a077959d07cea1d01000000\r\n```\r\n\r\nThe following UBSan condition is triggered:\r\n\r\n```\r\nprevector.h:452:19: runtime error: reference binding to misaligned address 0x7fff2c5dc562 for type 'prevector<28, unsigned char, unsigned int, int>::size_type' (aka 'unsigned int'), which requires 4 byte alignment\r\n0x7fff2c5dc562: note: pointer points here\r\n ff ff  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00\r\n              ^\r\n    #0 0x56183e4f724f in prevector<28u, unsigned char, unsigned int, int>::swap(prevector<28u, unsigned char, unsigned int, int>&) src/./prevector.h:452:9\r\n    #1 0x56183e4ec6fa in prevector<28u, unsigned char, unsigned int, int>::operator=(prevector<28u, unsigned char, unsigned int, int>&&) src/./prevector.h:272:9\r\n    #2 0x56183e4ec6fa in CScript::operator=(CScript&&) src/./script/script.h:390\r\n    #3 0x56183f407fa9 in ProduceSignature(SigningProvider const&, BaseSignatureCreator const&, CScript const&, SignatureData&) src/script/sign.cpp:240:23\r\n    #4 0x56183f30c8a3 in SignPSBTInput(SigningProvider const&, PartiallySignedTransaction&, int, int, SignatureData*, bool) src/psbt.cpp:285:24\r\n    #5 0x56183e7eb0e8 in AnalyzePSBT(PartiallySignedTransaction) src/node/psbt.cpp:54:29\r\n    #6 0x56183e393014 in test_one_input(std::vector<unsigned char, std::allocator<unsigned char> > const&) src/test/fuzz/psbt.cpp:28:35\r\nâ¦\r\nSUMMARY: UndefinedBehaviorSanitizer: undefined-behavior prevector.h:452:19 in\r\n```\r\n\r\nMight be worth tackling that one as well?",
      "created_at" : "2019-10-17T11:06:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17156#issuecomment-543123631",
      "id" : 543123631,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17156",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0MzEyMzYzMQ==",
      "updated_at" : "2019-10-17T11:06:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/543123631",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "What do I need to run in order to get the same error?",
      "created_at" : "2019-10-17T17:55:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17156#issuecomment-543290034",
      "id" : 543290034,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17156",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0MzI5MDAzNA==",
      "updated_at" : "2019-10-17T17:55:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/543290034",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Something like this:\r\n\r\n```\r\n#check out this branch\r\n./configure --disable-ccache --enable-fuzz --with-sanitizers=fuzzer,address,undefined CC=clang CXX=clang++\r\nmake -j 9\r\nexport LSAN_OPTIONS=\"suppressions=$(pwd)/test/sanitizer_suppressions/lsan\"\r\nexport TSAN_OPTIONS=\"suppressions=$(pwd)/test/sanitizer_suppressions/tsan\"\r\nexport UBSAN_OPTIONS=\"suppressions=$(pwd)/test/sanitizer_suppressions/ubsan:print_stacktrace=1:halt_on_error=1\"\r\n#run this fuzzer with the seed\r\n./src/test/fuzz/this_fuzzer -runs=1 ./the_input\r\n",
      "created_at" : "2019-10-17T18:06:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17156#issuecomment-543294418",
      "id" : 543294418,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17156",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0MzI5NDQxOA==",
      "updated_at" : "2019-10-17T18:06:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/543294418",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Not sure how to translate the base16 seed into a binary seed with the command line, though",
      "created_at" : "2019-10-17T18:07:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17156#issuecomment-543294629",
      "id" : 543294629,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17156",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0MzI5NDYyOQ==",
      "updated_at" : "2019-10-17T18:07:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/543294629",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@MarcoFalke \r\n\r\n```\r\n$ xxd -r -p > seed <<< \"70736274ff01009a020000000258e87a21b56daf0c23be8e7070456c336f\r\n7cbaa5c8757924f545887bb282dd750000000000ffffffff838d0427d0ec\r\n650a68aa46bb0b098aea4422c071b2ca78352a077959d07cea1d01000000\r\n00ffffffff0270aaf00800000000160014d85c2b71d0060b09c9886aeb81\r\n5e50991dda124d00e1f5050000000016001400aea9a2e5f0f876a588df55\r\n46e8742d202020ffff603016000001012000c2eb0b000000001714a9b7f5\r\nfaff09090010610000db2a077959d07cea1d01000000\"\r\n$ head -c4 seed\r\npsbt\r\n```\r\n\r\n:)",
      "created_at" : "2019-10-17T18:27:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17156#issuecomment-543302776",
      "id" : 543302776,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17156",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0MzMwMjc3Ng==",
      "updated_at" : "2019-10-17T18:27:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/543302776",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@achow101 \r\n\r\n```\r\n$ CC=clang CXX=clang++ ./configure --enable-fuzz \\\r\n      --with-sanitizers=address,fuzzer,undefined\r\n$ make\r\n$ mkdir psbt-seeds/\r\n$ xxd -r -p > psbt-seeds/seed <<< \"70736274ff01009a020000000258e87a21b56daf0c23be8e7070456c336f\r\n7cbaa5c8757924f545887bb282dd750000000000ffffffff838d0427d0ec\r\n650a68aa46bb0b098aea4422c071b2ca78352a077959d07cea1d01000000\r\n00ffffffff0270aaf00800000000160014d85c2b71d0060b09c9886aeb81\r\n5e50991dda124d00e1f5050000000016001400aea9a2e5f0f876a588df55\r\n46e8742d202020ffff603016000001012000c2eb0b000000001714a9b7f5\r\nfaff09090010610000db2a077959d07cea1d01000000\"\r\n$ UBSAN_OPTIONS=\"print_stacktrace=1:halt_on_error=1\" src/test/fuzz/psbt psbt-seeds/\r\nâ¦\r\nprevector.h:452:19: runtime error: reference binding to misaligned address 0x7fff2c5dc562 for type 'prevector<28, unsigned char, unsigned int, int>::size_type' (aka 'unsigned int'), which requires 4 byte alignment\r\n0x7fff2c5dc562: note: pointer points here\r\n ff ff  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  00 00 00 00 00 00\r\n              ^\r\n    #0 0x56183e4f724f in prevector<28u, unsigned char, unsigned int, int>::swap(prevector<28u, unsigned char, unsigned int, int>&) src/./prevector.h:452:9\r\n    #1 0x56183e4ec6fa in prevector<28u, unsigned char, unsigned int, int>::operator=(prevector<28u, unsigned char, unsigned int, int>&&) src/./prevector.h:272:9\r\n    #2 0x56183e4ec6fa in CScript::operator=(CScript&&) src/./script/script.h:390\r\n    #3 0x56183f407fa9 in ProduceSignature(SigningProvider const&, BaseSignatureCreator const&, CScript const&, SignatureData&) src/script/sign.cpp:240:23\r\n    #4 0x56183f30c8a3 in SignPSBTInput(SigningProvider const&, PartiallySignedTransaction&, int, int, SignatureData*, bool) src/psbt.cpp:285:24\r\n    #5 0x56183e7eb0e8 in AnalyzePSBT(PartiallySignedTransaction) src/node/psbt.cpp:54:29\r\n    #6 0x56183e393014 in test_one_input(std::vector<unsigned char, std::allocator<unsigned char> > const&) src/test/fuzz/psbt.cpp:28:35\r\nâ¦\r\nSUMMARY: UndefinedBehaviorSanitizer: undefined-behavior prevector.h:452:19 in\r\n```\r\n\r\n:)",
      "created_at" : "2019-10-17T18:39:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17156#issuecomment-543308076",
      "id" : 543308076,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17156",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0MzMwODA3Ng==",
      "updated_at" : "2019-10-17T18:39:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/543308076",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I'm not really sure why that happens.\r\n\r\n```\r\ndiff --git a/src/script/sign.cpp b/src/script/sign.cpp\r\nindex 0ed92e8d5b..be24d002ad 100644\r\n--- a/src/script/sign.cpp\r\n+++ b/src/script/sign.cpp\r\n@@ -237,7 +237,11 @@ bool ProduceSignature(const SigningProvider& provider, const BaseSignatureCreato\r\n     if (P2SH) {\r\n         result.push_back(std::vector<unsigned char>(subscript.begin(), subscript.end()));\r\n     }\r\n-    sigdata.scriptSig = PushAll(result);\r\n+    if (result.size() == 0) {\r\n+        sigdata.scriptSig.clear();\r\n+    } else {\r\n+        sigdata.scriptSig = PushAll(result);\r\n+    }\r\n \r\n     // Test solution\r\n     sigdata.complete = solved && VerifyScript(sigdata.scriptSig, fromPubKey, &sigdata.scriptWitness, STANDARD_SCRIPT_VERIFY_FLAGS, creator.Checker());\r\n```\r\n\r\nfixes the problem, but it's more signing code than not. ISTM we should see this elsewhere too but it doesn't seem like it.",
      "created_at" : "2019-10-18T00:00:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17156#issuecomment-543416770",
      "id" : 543416770,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17156",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0MzQxNjc3MA==",
      "updated_at" : "2019-10-18T00:00:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/543416770",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   }
]
