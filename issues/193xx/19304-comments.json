[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441621704"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441621704"
         }
      },
      "author_association" : "MEMBER",
      "body" : "use `assert_equal`",
      "commit_id" : "3cd538a1a6c64c8ab4b6f02be72f45d2c865b9f1",
      "created_at" : "2020-06-17T15:10:27Z",
      "diff_hunk" : "@@ -42,13 +43,30 @@ def set_test_params(self):\n         self.setup_clean_chain = True\n \n     def run_test(self):\n+        self.test_buffer()\n         self.test_magic_bytes()\n         self.test_checksum()\n         self.test_size()\n         self.test_msgtype()\n         self.test_large_inv()\n         self.test_resource_exhaustion()\n \n+    def test_buffer(self):\n+        self.log.info(\"Test message with header split across two buffers\")\n+        conn = self.nodes[0].add_p2p_connection(P2PDataStore())\n+        # Create valid message\n+        msg = conn.build_message(msg_ping(nonce=12345))\n+        cut_pos = 12    # Chosen at an arbitrary position within the header\n+        # Send message in two pieces\n+        before = self.nodes[0].getnettotals()['totalbytesrecv']\n+        conn.send_raw_message(msg[:cut_pos])\n+        middle = self.nodes[0].getnettotals()['totalbytesrecv']\n+        # If this assert fails, we've hit an unlikely race\n+        # where the test framework sent a message in between the two halves\n+        assert middle == before + cut_pos",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441621704",
      "id" : 441621704,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYyMTcwNA==",
      "original_commit_id" : "c5904c82e05cb4f5856cc55877f9fa268a9cd031",
      "original_line" : 66,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : null,
      "pull_request_review_id" : 432503750,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T16:07:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441621704",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441623383"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441623383"
         }
      },
      "author_association" : "MEMBER",
      "body" : "suggestion: perhaps describe the expected result",
      "commit_id" : "3cd538a1a6c64c8ab4b6f02be72f45d2c865b9f1",
      "created_at" : "2020-06-17T15:12:29Z",
      "diff_hunk" : "@@ -42,13 +43,30 @@ def set_test_params(self):\n         self.setup_clean_chain = True\n \n     def run_test(self):\n+        self.test_buffer()\n         self.test_magic_bytes()\n         self.test_checksum()\n         self.test_size()\n         self.test_msgtype()\n         self.test_large_inv()\n         self.test_resource_exhaustion()\n \n+    def test_buffer(self):\n+        self.log.info(\"Test message with header split across two buffers\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441623383",
      "id" : 441623383,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYyMzM4Mw==",
      "original_commit_id" : "c5904c82e05cb4f5856cc55877f9fa268a9cd031",
      "original_line" : 59,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : null,
      "pull_request_review_id" : 432503750,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T16:07:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441623383",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441624037"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441624037"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why not test the debug log output as well, e.g. `Incomplete headerReceived`. I think this works; maybe it can be improved on:\r\n\r\n```diff\r\n-        msg = conn.build_message(msg_ping(nonce=12345))\r\n-        cut_pos = 12    # Chosen at an arbitrary position within the header\r\n-        # Send message in two pieces\r\n-        before = self.nodes[0].getnettotals()['totalbytesrecv']\r\n-        conn.send_raw_message(msg[:cut_pos])\r\n-        middle = self.nodes[0].getnettotals()['totalbytesrecv']\r\n-        # If this assert fails, we've hit an unlikely race\r\n-        # where the test framework sent a message in between the two halves\r\n-        assert middle == before + cut_pos\r\n-        conn.send_raw_message(msg[cut_pos:])\r\n-        conn.sync_with_ping(timeout=1)\r\n+        with self.nodes[0].assert_debug_log(['Incomplete headerReceived']):\r\n+            msg = conn.build_message(msg_ping(nonce=12345))\r\n+            cut_pos = 12    # Chosen at an arbitrary position within the header\r\n+            # Send message in two pieces\r\n+            before = self.nodes[0].getnettotals()['totalbytesrecv']\r\n+            conn.send_raw_message(msg[:cut_pos])\r\n+            middle = self.nodes[0].getnettotals()['totalbytesrecv']\r\n+            # If this assert fails, we've hit an unlikely race\r\n+            # where the test framework sent a message in between the two halves\r\n+            assert middle == before + cut_pos\r\n+            conn.send_raw_message(msg[cut_pos:])\r\n+            conn.sync_with_ping(timeout=1)\r\n\r\nwith self.nodes[0].assert_debug_log(['[net] Incomplete headerReceived']):\r\n```",
      "commit_id" : "3cd538a1a6c64c8ab4b6f02be72f45d2c865b9f1",
      "created_at" : "2020-06-17T15:13:12Z",
      "diff_hunk" : "@@ -42,13 +43,30 @@ def set_test_params(self):\n         self.setup_clean_chain = True\n \n     def run_test(self):\n+        self.test_buffer()\n         self.test_magic_bytes()\n         self.test_checksum()\n         self.test_size()\n         self.test_msgtype()\n         self.test_large_inv()\n         self.test_resource_exhaustion()\n \n+    def test_buffer(self):\n+        self.log.info(\"Test message with header split across two buffers\")\n+        conn = self.nodes[0].add_p2p_connection(P2PDataStore())\n+        # Create valid message\n+        msg = conn.build_message(msg_ping(nonce=12345))\n+        cut_pos = 12    # Chosen at an arbitrary position within the header\n+        # Send message in two pieces\n+        before = self.nodes[0].getnettotals()['totalbytesrecv']\n+        conn.send_raw_message(msg[:cut_pos])\n+        middle = self.nodes[0].getnettotals()['totalbytesrecv']\n+        # If this assert fails, we've hit an unlikely race\n+        # where the test framework sent a message in between the two halves\n+        assert middle == before + cut_pos",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441624037",
      "id" : 441624037,
      "in_reply_to_id" : 441621704,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYyNDAzNw==",
      "original_commit_id" : "c5904c82e05cb4f5856cc55877f9fa268a9cd031",
      "original_line" : 66,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : null,
      "pull_request_review_id" : 432503750,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T16:07:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441624037",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441639243"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441639243"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Why not test the debug log output as well\r\n\r\nI'd prefer not to do this. My view is that functional tests should be as black box as possible, and test the functionality rather than the implementation. Using the debug log to test that an event has happened should be used only when there's no other way to test, since doing so binds the test to the exact implementation, and any changes to control flow or logging in the product mean that the tests need to be updated.\r\n\r\n> use assert_equal\r\n\r\n:+1: ",
      "commit_id" : "3cd538a1a6c64c8ab4b6f02be72f45d2c865b9f1",
      "created_at" : "2020-06-17T15:34:41Z",
      "diff_hunk" : "@@ -42,13 +43,30 @@ def set_test_params(self):\n         self.setup_clean_chain = True\n \n     def run_test(self):\n+        self.test_buffer()\n         self.test_magic_bytes()\n         self.test_checksum()\n         self.test_size()\n         self.test_msgtype()\n         self.test_large_inv()\n         self.test_resource_exhaustion()\n \n+    def test_buffer(self):\n+        self.log.info(\"Test message with header split across two buffers\")\n+        conn = self.nodes[0].add_p2p_connection(P2PDataStore())\n+        # Create valid message\n+        msg = conn.build_message(msg_ping(nonce=12345))\n+        cut_pos = 12    # Chosen at an arbitrary position within the header\n+        # Send message in two pieces\n+        before = self.nodes[0].getnettotals()['totalbytesrecv']\n+        conn.send_raw_message(msg[:cut_pos])\n+        middle = self.nodes[0].getnettotals()['totalbytesrecv']\n+        # If this assert fails, we've hit an unlikely race\n+        # where the test framework sent a message in between the two halves\n+        assert middle == before + cut_pos",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441639243",
      "id" : 441639243,
      "in_reply_to_id" : 441621704,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYzOTI0Mw==",
      "original_commit_id" : "c5904c82e05cb4f5856cc55877f9fa268a9cd031",
      "original_line" : 66,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : null,
      "pull_request_review_id" : 432526952,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T16:07:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441639243",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441640185"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441640185"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If #19272 if merged first, these changes in `test_large_inv()` won't be needed.",
      "commit_id" : "3cd538a1a6c64c8ab4b6f02be72f45d2c865b9f1",
      "created_at" : "2020-06-17T15:36:04Z",
      "diff_hunk" : "@@ -95,13 +113,13 @@ def test_msgtype(self):\n \n     def test_large_inv(self):\n         conn = self.nodes[0].add_p2p_connection(P2PInterface())\n-        with self.nodes[0].assert_debug_log(['Misbehaving', 'peer=4 (0 -> 20): message inv size() = 50001']):\n+        with self.nodes[0].assert_debug_log(['Misbehaving', '(0 -> 20): message inv size() = 50001']):\n             msg = msg_inv([CInv(MSG_TX, 1)] * 50001)\n             conn.send_and_ping(msg)\n-        with self.nodes[0].assert_debug_log(['Misbehaving', 'peer=4 (20 -> 40): message getdata size() = 50001']):\n+        with self.nodes[0].assert_debug_log(['Misbehaving', '(20 -> 40): message getdata size() = 50001']):\n             msg = msg_getdata([CInv(MSG_TX, 1)] * 50001)\n             conn.send_and_ping(msg)\n-        with self.nodes[0].assert_debug_log(['Misbehaving', 'peer=4 (40 -> 60): headers message size = 2001']):\n+        with self.nodes[0].assert_debug_log(['Misbehaving', '(40 -> 60): headers message size = 2001']):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441640185",
      "id" : 441640185,
      "line" : 128,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY0MDE4NQ==",
      "original_commit_id" : "c5904c82e05cb4f5856cc55877f9fa268a9cd031",
      "original_line" : 128,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : 71,
      "pull_request_review_id" : 432528258,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T16:07:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441640185",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441640309"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441640309"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "We don't currently log that an incomplete header was received.  IMO we shouldn't, it's just an implementation detail of sockets, it doesn't really mean anything on any Bitcoin level.  At the very least maybe changing bitcoind logging is out of scope for this PR?",
      "commit_id" : "3cd538a1a6c64c8ab4b6f02be72f45d2c865b9f1",
      "created_at" : "2020-06-17T15:36:15Z",
      "diff_hunk" : "@@ -42,13 +43,30 @@ def set_test_params(self):\n         self.setup_clean_chain = True\n \n     def run_test(self):\n+        self.test_buffer()\n         self.test_magic_bytes()\n         self.test_checksum()\n         self.test_size()\n         self.test_msgtype()\n         self.test_large_inv()\n         self.test_resource_exhaustion()\n \n+    def test_buffer(self):\n+        self.log.info(\"Test message with header split across two buffers\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441640309",
      "id" : 441640309,
      "in_reply_to_id" : 441623383,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY0MDMwOQ==",
      "original_commit_id" : "c5904c82e05cb4f5856cc55877f9fa268a9cd031",
      "original_line" : 59,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : null,
      "pull_request_review_id" : 432528431,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T16:07:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441640309",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441640372"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441640372"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "See below",
      "commit_id" : "3cd538a1a6c64c8ab4b6f02be72f45d2c865b9f1",
      "created_at" : "2020-06-17T15:36:21Z",
      "diff_hunk" : "@@ -42,13 +43,30 @@ def set_test_params(self):\n         self.setup_clean_chain = True\n \n     def run_test(self):\n+        self.test_buffer()\n         self.test_magic_bytes()\n         self.test_checksum()\n         self.test_size()\n         self.test_msgtype()\n         self.test_large_inv()\n         self.test_resource_exhaustion()\n \n+    def test_buffer(self):\n+        self.log.info(\"Test message with header split across two buffers\")\n+        conn = self.nodes[0].add_p2p_connection(P2PDataStore())\n+        # Create valid message\n+        msg = conn.build_message(msg_ping(nonce=12345))\n+        cut_pos = 12    # Chosen at an arbitrary position within the header\n+        # Send message in two pieces\n+        before = self.nodes[0].getnettotals()['totalbytesrecv']\n+        conn.send_raw_message(msg[:cut_pos])\n+        middle = self.nodes[0].getnettotals()['totalbytesrecv']\n+        # If this assert fails, we've hit an unlikely race\n+        # where the test framework sent a message in between the two halves\n+        assert middle == before + cut_pos",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441640372",
      "id" : 441640372,
      "in_reply_to_id" : 441621704,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY0MDM3Mg==",
      "original_commit_id" : "c5904c82e05cb4f5856cc55877f9fa268a9cd031",
      "original_line" : 66,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : null,
      "pull_request_review_id" : 432528518,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T16:07:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441640372",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441641495"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441641495"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Please join this with the import from `test_framework.messages` above.",
      "commit_id" : "3cd538a1a6c64c8ab4b6f02be72f45d2c865b9f1",
      "created_at" : "2020-06-17T15:38:03Z",
      "diff_hunk" : "@@ -17,6 +17,7 @@\n     P2PInterface,\n )\n from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import msg_ping",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441641495",
      "id" : 441641495,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY0MTQ5NQ==",
      "original_commit_id" : "c5904c82e05cb4f5856cc55877f9fa268a9cd031",
      "original_line" : 20,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : null,
      "pull_request_review_id" : 432530048,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T16:07:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441641495",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441641575"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441641575"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "+1, I'm more than happy to rebase this one if #19272 goes in first",
      "commit_id" : "3cd538a1a6c64c8ab4b6f02be72f45d2c865b9f1",
      "created_at" : "2020-06-17T15:38:10Z",
      "diff_hunk" : "@@ -95,13 +113,13 @@ def test_msgtype(self):\n \n     def test_large_inv(self):\n         conn = self.nodes[0].add_p2p_connection(P2PInterface())\n-        with self.nodes[0].assert_debug_log(['Misbehaving', 'peer=4 (0 -> 20): message inv size() = 50001']):\n+        with self.nodes[0].assert_debug_log(['Misbehaving', '(0 -> 20): message inv size() = 50001']):\n             msg = msg_inv([CInv(MSG_TX, 1)] * 50001)\n             conn.send_and_ping(msg)\n-        with self.nodes[0].assert_debug_log(['Misbehaving', 'peer=4 (20 -> 40): message getdata size() = 50001']):\n+        with self.nodes[0].assert_debug_log(['Misbehaving', '(20 -> 40): message getdata size() = 50001']):\n             msg = msg_getdata([CInv(MSG_TX, 1)] * 50001)\n             conn.send_and_ping(msg)\n-        with self.nodes[0].assert_debug_log(['Misbehaving', 'peer=4 (40 -> 60): headers message size = 2001']):\n+        with self.nodes[0].assert_debug_log(['Misbehaving', '(40 -> 60): headers message size = 2001']):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441641575",
      "id" : 441641575,
      "in_reply_to_id" : 441640185,
      "line" : 128,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY0MTU3NQ==",
      "original_commit_id" : "c5904c82e05cb4f5856cc55877f9fa268a9cd031",
      "original_line" : 128,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : 71,
      "pull_request_review_id" : 432530153,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T16:07:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441641575",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441643412"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441643412"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I suggest you disconnect the connection at the end of this subtest, so that the node and test fixture are the same state at the end of each subtest as at the start.\r\n\r\nIdeally, it should be possible to permute subtests in any order and have the test pass. That prevents brittleness like the asserts on peer numbers that you've had to change in an unrelated subtest here.",
      "commit_id" : "3cd538a1a6c64c8ab4b6f02be72f45d2c865b9f1",
      "created_at" : "2020-06-17T15:40:58Z",
      "diff_hunk" : "@@ -42,13 +43,30 @@ def set_test_params(self):\n         self.setup_clean_chain = True\n \n     def run_test(self):\n+        self.test_buffer()\n         self.test_magic_bytes()\n         self.test_checksum()\n         self.test_size()\n         self.test_msgtype()\n         self.test_large_inv()\n         self.test_resource_exhaustion()\n \n+    def test_buffer(self):\n+        self.log.info(\"Test message with header split across two buffers\")\n+        conn = self.nodes[0].add_p2p_connection(P2PDataStore())\n+        # Create valid message\n+        msg = conn.build_message(msg_ping(nonce=12345))\n+        cut_pos = 12    # Chosen at an arbitrary position within the header\n+        # Send message in two pieces\n+        before = self.nodes[0].getnettotals()['totalbytesrecv']\n+        conn.send_raw_message(msg[:cut_pos])\n+        middle = self.nodes[0].getnettotals()['totalbytesrecv']\n+        # If this assert fails, we've hit an unlikely race\n+        # where the test framework sent a message in between the two halves\n+        assert middle == before + cut_pos\n+        conn.send_raw_message(msg[cut_pos:])\n+        conn.sync_with_ping(timeout=1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441643412",
      "id" : 441643412,
      "line" : 73,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY0MzQxMg==",
      "original_commit_id" : "c5904c82e05cb4f5856cc55877f9fa268a9cd031",
      "original_line" : 73,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : 52,
      "pull_request_review_id" : 432530048,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T16:07:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441643412",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK. Thanks for adding the test, will test after assert_equal nit is addressed",
      "created_at" : "2020-06-17T15:41:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#issuecomment-645453492",
      "id" : 645453492,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19304",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0NTQ1MzQ5Mg==",
      "updated_at" : "2020-06-17T15:41:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/645453492",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441645507"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441645507"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In https://github.com/bitcoin/bitcoin/pull/19302#discussion_r441521857 you added `LogPrintf(\"Incomplete header\");`\r\n\r\n",
      "commit_id" : "3cd538a1a6c64c8ab4b6f02be72f45d2c865b9f1",
      "created_at" : "2020-06-17T15:43:59Z",
      "diff_hunk" : "@@ -42,13 +43,30 @@ def set_test_params(self):\n         self.setup_clean_chain = True\n \n     def run_test(self):\n+        self.test_buffer()\n         self.test_magic_bytes()\n         self.test_checksum()\n         self.test_size()\n         self.test_msgtype()\n         self.test_large_inv()\n         self.test_resource_exhaustion()\n \n+    def test_buffer(self):\n+        self.log.info(\"Test message with header split across two buffers\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441645507",
      "id" : 441645507,
      "in_reply_to_id" : 441623383,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY0NTUwNw==",
      "original_commit_id" : "c5904c82e05cb4f5856cc55877f9fa268a9cd031",
      "original_line" : 59,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : null,
      "pull_request_review_id" : 432535295,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T16:07:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441645507",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441645591"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441645591"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@jonatack are you sure? I don't see anywhere in the product code that logs \"Incomplete headerReceived\" (and would be surprised to, since this is purely an implementation detail)",
      "commit_id" : "3cd538a1a6c64c8ab4b6f02be72f45d2c865b9f1",
      "created_at" : "2020-06-17T15:44:06Z",
      "diff_hunk" : "@@ -42,13 +43,30 @@ def set_test_params(self):\n         self.setup_clean_chain = True\n \n     def run_test(self):\n+        self.test_buffer()\n         self.test_magic_bytes()\n         self.test_checksum()\n         self.test_size()\n         self.test_msgtype()\n         self.test_large_inv()\n         self.test_resource_exhaustion()\n \n+    def test_buffer(self):\n+        self.log.info(\"Test message with header split across two buffers\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441645591",
      "id" : 441645591,
      "in_reply_to_id" : 441623383,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY0NTU5MQ==",
      "original_commit_id" : "c5904c82e05cb4f5856cc55877f9fa268a9cd031",
      "original_line" : 59,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : null,
      "pull_request_review_id" : 432535406,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T16:07:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441645591",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441645947"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441645947"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> \r\n> \r\n> The idea is to mention the expected result. The rest was an example, success, failure, disconnects peer, etc.\r\n\r\nAh I agree, I'll make this a bit more descriptive",
      "commit_id" : "3cd538a1a6c64c8ab4b6f02be72f45d2c865b9f1",
      "created_at" : "2020-06-17T15:44:40Z",
      "diff_hunk" : "@@ -42,13 +43,30 @@ def set_test_params(self):\n         self.setup_clean_chain = True\n \n     def run_test(self):\n+        self.test_buffer()\n         self.test_magic_bytes()\n         self.test_checksum()\n         self.test_size()\n         self.test_msgtype()\n         self.test_large_inv()\n         self.test_resource_exhaustion()\n \n+    def test_buffer(self):\n+        self.log.info(\"Test message with header split across two buffers\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441645947",
      "id" : 441645947,
      "in_reply_to_id" : 441623383,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY0NTk0Nw==",
      "original_commit_id" : "c5904c82e05cb4f5856cc55877f9fa268a9cd031",
      "original_line" : 59,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : null,
      "pull_request_review_id" : 432535884,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T16:07:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441645947",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441657274"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441657274"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oh right, if it's just sockets then agreed.",
      "commit_id" : "3cd538a1a6c64c8ab4b6f02be72f45d2c865b9f1",
      "created_at" : "2020-06-17T16:01:37Z",
      "diff_hunk" : "@@ -42,13 +43,30 @@ def set_test_params(self):\n         self.setup_clean_chain = True\n \n     def run_test(self):\n+        self.test_buffer()\n         self.test_magic_bytes()\n         self.test_checksum()\n         self.test_size()\n         self.test_msgtype()\n         self.test_large_inv()\n         self.test_resource_exhaustion()\n \n+    def test_buffer(self):\n+        self.log.info(\"Test message with header split across two buffers\")\n+        conn = self.nodes[0].add_p2p_connection(P2PDataStore())\n+        # Create valid message\n+        msg = conn.build_message(msg_ping(nonce=12345))\n+        cut_pos = 12    # Chosen at an arbitrary position within the header\n+        # Send message in two pieces\n+        before = self.nodes[0].getnettotals()['totalbytesrecv']\n+        conn.send_raw_message(msg[:cut_pos])\n+        middle = self.nodes[0].getnettotals()['totalbytesrecv']\n+        # If this assert fails, we've hit an unlikely race\n+        # where the test framework sent a message in between the two halves\n+        assert middle == before + cut_pos",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441657274",
      "id" : 441657274,
      "in_reply_to_id" : 441621704,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY1NzI3NA==",
      "original_commit_id" : "c5904c82e05cb4f5856cc55877f9fa268a9cd031",
      "original_line" : 66,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : null,
      "pull_request_review_id" : 432550163,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T16:07:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441657274",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441661988"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441661988"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> @jonatack are you sure? I don't see anywhere in the product code that logs \"Incomplete headerReceived\" (and would be surprised to, since this is purely an implementation detail)\r\n\r\nWeird. I think it was a non-consistent result. Sorry about that.",
      "commit_id" : "3cd538a1a6c64c8ab4b6f02be72f45d2c865b9f1",
      "created_at" : "2020-06-17T16:09:17Z",
      "diff_hunk" : "@@ -42,13 +43,30 @@ def set_test_params(self):\n         self.setup_clean_chain = True\n \n     def run_test(self):\n+        self.test_buffer()\n         self.test_magic_bytes()\n         self.test_checksum()\n         self.test_size()\n         self.test_msgtype()\n         self.test_large_inv()\n         self.test_resource_exhaustion()\n \n+    def test_buffer(self):\n+        self.log.info(\"Test message with header split across two buffers\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441661988",
      "id" : 441661988,
      "in_reply_to_id" : 441623383,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY2MTk4OA==",
      "original_commit_id" : "c5904c82e05cb4f5856cc55877f9fa268a9cd031",
      "original_line" : 59,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : null,
      "pull_request_review_id" : 432556200,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T16:09:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441661988",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Compare c5904c82e05cb4f5856cc55877f9fa268a9cd031 to 3cd538a1a6c64c8ab4b6f02be72f45d2c865b9f1.  Changed to assert_equal and made log more descriptive.  Disconnects peer at the end of the test, I'll keep that discussion in #19272 and I'll follow the status quo here.\r\n\r\nHad to add a short sleep, as I was finding my RPC call occationally went before the first half of the message was received by the node.",
      "created_at" : "2020-06-17T16:13:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#issuecomment-645470937",
      "id" : 645470937,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19304",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0NTQ3MDkzNw==",
      "updated_at" : "2020-06-17T16:13:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/645470937",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441670483"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441670483"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> In [#19302 (comment)](https://github.com/bitcoin/bitcoin/pull/19302#discussion_r441521857) you added `LogPrintf(\"Incomplete header\");`\r\n\r\nHm, it's possible I didn't rebuild properly. It's late here :) will finish review of your net headers refactoring tomorrow fresh and early",
      "commit_id" : "3cd538a1a6c64c8ab4b6f02be72f45d2c865b9f1",
      "created_at" : "2020-06-17T16:23:21Z",
      "diff_hunk" : "@@ -42,13 +43,30 @@ def set_test_params(self):\n         self.setup_clean_chain = True\n \n     def run_test(self):\n+        self.test_buffer()\n         self.test_magic_bytes()\n         self.test_checksum()\n         self.test_size()\n         self.test_msgtype()\n         self.test_large_inv()\n         self.test_resource_exhaustion()\n \n+    def test_buffer(self):\n+        self.log.info(\"Test message with header split across two buffers\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441670483",
      "id" : 441670483,
      "in_reply_to_id" : 441623383,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY3MDQ4Mw==",
      "original_commit_id" : "c5904c82e05cb4f5856cc55877f9fa268a9cd031",
      "original_line" : 59,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : null,
      "pull_request_review_id" : 432567237,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T16:23:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441670483",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   }
]
