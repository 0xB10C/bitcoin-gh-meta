[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #19337 (sync: detect double lock from the same thread by vasild)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-06-20T22:03:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19340#issuecomment-647050288",
      "id" : 647050288,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19340",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0NzA1MDI4OA==",
      "updated_at" : "2020-06-21T13:04:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/647050288",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19340#discussion_r443376119"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443376119"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`operator[]` has a side effect that it would insert a new element in `m_lock_stacks` if the thread that called it does not own any locks.\r\n\r\n```suggestion\r\n    const auto it = lockdata.m_lock_stacks.find(std::this_thread::get_id());\r\n    if (it == lockdata.m_lock_stacks.end()) {\r\n        return true;\r\n    }\r\n    return it->second.empty().\r\n```",
      "commit_id" : "c810cd4d17f1f3854045c7e6f9093c856ba28406",
      "created_at" : "2020-06-22T07:50:25Z",
      "diff_hunk" : "@@ -255,6 +264,14 @@ void DeleteLock(void* cs)\n     }\n }\n \n+bool LockStackEmpty()\n+{\n+    LockData& lockdata = GetLockData();\n+    std::lock_guard<std::mutex> lock(lockdata.dd_mutex);\n+    LockStack& lock_stack = lockdata.m_lock_stacks[std::this_thread::get_id()];\n+    return lock_stack.empty();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19340#discussion_r443376119",
      "id" : 443376119,
      "line" : 272,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzM3NjExOQ==",
      "original_commit_id" : "c810cd4d17f1f3854045c7e6f9093c856ba28406",
      "original_line" : 272,
      "original_position" : 44,
      "original_start_line" : 271,
      "path" : "src/sync.cpp",
      "position" : 44,
      "pull_request_review_id" : 434680587,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19340",
      "side" : "RIGHT",
      "start_line" : 271,
      "start_side" : "RIGHT",
      "updated_at" : "2020-06-22T09:42:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443376119",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19340#discussion_r443430868"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443430868"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I would suggest to unconditionally remove the entry from the stack here, after printing the stack and before `abort()`/`throw`. This cleanup is warranted from all code paths that call `EnterCritical()`.\r\n\r\n```suggestion\r\n    // Undo the insertion from push_lock(). We will not lock the mutex.\r\n    s2.pop_back();\r\n    throw std::logic_error(\"potential deadlock detected\");\r\n```\r\n\r\n(this should be before the `if`, 4 lines above, but github does not allow me to put the suggestion there)",
      "commit_id" : "c810cd4d17f1f3854045c7e6f9093c856ba28406",
      "created_at" : "2020-06-22T09:27:48Z",
      "diff_hunk" : "@@ -131,7 +131,7 @@ static void potential_deadlock_detected(const LockPair& mismatch, const LockStac\n     throw std::logic_error(\"potential deadlock detected\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19340#discussion_r443430868",
      "id" : 443430868,
      "line" : 131,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQzMDg2OA==",
      "original_commit_id" : "c810cd4d17f1f3854045c7e6f9093c856ba28406",
      "original_line" : 131,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/sync.cpp",
      "position" : 1,
      "pull_request_review_id" : 434680587,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-22T09:42:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443430868",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@vasild \r\n> It would be good if the offending entry is still in the lock stack by the time `potential_deadlock_detected()` is called because it prints the stack and we want to see the offender in the debug log.\r\n\r\nIt prints from `LockOrders` instances, not from the lock stack of the current thread, no?",
      "created_at" : "2020-06-22T09:56:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19340#issuecomment-647414277",
      "id" : 647414277,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19340",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0NzQxNDI3Nw==",
      "updated_at" : "2020-06-22T09:56:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/647414277",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "You are right! I did not realize that the `LockStack` objects are copied.\r\n\r\nAnyway - I think, for `EnterCritical()` to be a good citizen, if it throws, it should leave its internal structures in the state they were before it was called.",
      "created_at" : "2020-06-22T10:59:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19340#issuecomment-647444809",
      "id" : 647444809,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19340",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0NzQ0NDgwOQ==",
      "updated_at" : "2020-06-22T10:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/647444809",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   }
]
