[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #19364 (net processing: Move orphan reprocessing to a global by jnewbery)\n* #19316 ([net] Cleanup logic around connection types by amitiuttarwar)\n* #19219 (Replace automatic bans with discouragement filter by sipa)\n* #19191 (net: Extract download permission from noban by MarcoFalke)\n* #18991 (Cache responses to GETADDR to prevent topology leaks by naumenkogs)\n* #18531 (rpc: Assert that RPCArg names are equal to CRPCCommand ones by MarcoFalke)\n* #18044 (Use wtxid for transaction relay by sdaftuar)\n* #17785 (p2p: Unify Send and Receive protocol versions by hebasto)\n* #17428 (p2p: Try to preserve outbound block-relay-only connections during restart by hebasto)\n* #14033 (p2p: Drop CADDR_TIME_VERSION checks now that MIN_PEER_PROTO_VERSION is greater by Empact)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-06-17T23:09:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-645672477",
      "id" : 645672477,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0NTY3MjQ3Nw==",
      "updated_at" : "2020-07-01T18:31:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/645672477",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK. Being able to explicitly test different connection types including outbounds will be really useful.",
      "created_at" : "2020-06-18T19:49:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-646271653",
      "id" : 646271653,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0NjI3MTY1Mw==",
      "updated_at" : "2020-06-18T19:49:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/646271653",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK, that's a substantial move to increase coverage of p2p!\r\n\r\n@t-bast, see https://github.com/ariard/bitcoin/commits/2020-07-tda-mitigation-block-relay, based on this PR, it should allow you to open manual block-relay-only connection to a side-node _without_ leaking its presence due to addr-relay. That's one of the mitigation we talked offline against time-dilation and it should prevent you against unknown in-protocol eclipses. This is experimental software ofc, beware of not killing any kittens :)",
      "created_at" : "2020-07-03T04:05:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-653332533",
      "id" : 653332533,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1MzMzMjUzMw==",
      "updated_at" : "2020-07-03T04:05:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/653332533",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r449410050"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449410050"
         }
      },
      "author_association" : "NONE",
      "body" : "very nit: `conn_type` or `connType`?",
      "commit_id" : "e00848600f27c1495ff1bbc5e6aaa3d4f0cf5c95",
      "created_at" : "2020-07-03T06:59:16Z",
      "diff_hunk" : "@@ -367,8 +367,10 @@ static CAddress GetBindAddress(SOCKET sock)\n     return addr_bind;\n }\n \n-CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCountFailure, bool manual_connection, bool block_relay_only)\n+CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCountFailure, ConnectionType conn_type)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r449410050",
      "id" : 449410050,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQxMDA1MA==",
      "original_commit_id" : "b43b7dba9feadcdad6bd966eac924b01bca59e1c",
      "original_line" : 371,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 442187488,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-18T18:53:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449410050",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/31281497?v=4",
         "events_url" : "https://api.github.com/users/t-bast/events{/privacy}",
         "followers_url" : "https://api.github.com/users/t-bast/followers",
         "following_url" : "https://api.github.com/users/t-bast/following{/other_user}",
         "gists_url" : "https://api.github.com/users/t-bast/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/t-bast",
         "id" : 31281497,
         "login" : "t-bast",
         "node_id" : "MDQ6VXNlcjMxMjgxNDk3",
         "organizations_url" : "https://api.github.com/users/t-bast/orgs",
         "received_events_url" : "https://api.github.com/users/t-bast/received_events",
         "repos_url" : "https://api.github.com/users/t-bast/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/t-bast/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/t-bast/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/t-bast"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r449412035"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449412035"
         }
      },
      "author_association" : "NONE",
      "body" : "My 2 cents (feel free to ignore as I'm clearly very new to the bitcoin codebase): it feels to me that the distinction manual vs non-manual (automatic?) is orthogonal to the connection type and could be a separate enum.\r\n\r\nIIUC `MANUAL` can be composed with either `OUTBOUND`, `FEELER`, `BLOCK_RELAY` or `ADDR_FETCH`.",
      "commit_id" : "e00848600f27c1495ff1bbc5e6aaa3d4f0cf5c95",
      "created_at" : "2020-07-03T07:04:32Z",
      "diff_hunk" : "@@ -113,6 +113,14 @@ struct CSerializedNetMsg\n     std::string command;\n };\n \n+enum class ConnectionType {\n+    INBOUND, // peer initiated connections\n+    OUTBOUND, // full relay connections (blocks, addrs, txns)\n+    MANUAL, // connections to addresses added via addnode or the connect command line argument",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r449412035",
      "id" : 449412035,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQxMjAzNQ==",
      "original_commit_id" : "b43b7dba9feadcdad6bd966eac924b01bca59e1c",
      "original_line" : 119,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 442187488,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-18T18:53:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449412035",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/31281497?v=4",
         "events_url" : "https://api.github.com/users/t-bast/events{/privacy}",
         "followers_url" : "https://api.github.com/users/t-bast/followers",
         "following_url" : "https://api.github.com/users/t-bast/following{/other_user}",
         "gists_url" : "https://api.github.com/users/t-bast/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/t-bast",
         "id" : 31281497,
         "login" : "t-bast",
         "node_id" : "MDQ6VXNlcjMxMjgxNDk3",
         "organizations_url" : "https://api.github.com/users/t-bast/orgs",
         "received_events_url" : "https://api.github.com/users/t-bast/received_events",
         "repos_url" : "https://api.github.com/users/t-bast/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/t-bast/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/t-bast/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/t-bast"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r449634741"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449634741"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`conn_type` is correct. See the developer guide: https://github.com/bitcoin/bitcoin/blob/master/doc/developer-notes.md#coding-style-c",
      "commit_id" : "e00848600f27c1495ff1bbc5e6aaa3d4f0cf5c95",
      "created_at" : "2020-07-03T15:28:35Z",
      "diff_hunk" : "@@ -367,8 +367,10 @@ static CAddress GetBindAddress(SOCKET sock)\n     return addr_bind;\n }\n \n-CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCountFailure, bool manual_connection, bool block_relay_only)\n+CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCountFailure, ConnectionType conn_type)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r449634741",
      "id" : 449634741,
      "in_reply_to_id" : 449410050,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTYzNDc0MQ==",
      "original_commit_id" : "b43b7dba9feadcdad6bd966eac924b01bca59e1c",
      "original_line" : 371,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 442478780,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-18T18:53:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449634741",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r449634943"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449634943"
         }
      },
      "author_association" : "MEMBER",
      "body" : "See rationale here: https://github.com/bitcoin/bitcoin/pull/19316#issuecomment-646304479 and here: https://github.com/bitcoin/bitcoin/pull/19316#issuecomment-649776062",
      "commit_id" : "e00848600f27c1495ff1bbc5e6aaa3d4f0cf5c95",
      "created_at" : "2020-07-03T15:29:15Z",
      "diff_hunk" : "@@ -113,6 +113,14 @@ struct CSerializedNetMsg\n     std::string command;\n };\n \n+enum class ConnectionType {\n+    INBOUND, // peer initiated connections\n+    OUTBOUND, // full relay connections (blocks, addrs, txns)\n+    MANUAL, // connections to addresses added via addnode or the connect command line argument",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r449634943",
      "id" : 449634943,
      "in_reply_to_id" : 449412035,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTYzNDk0Mw==",
      "original_commit_id" : "b43b7dba9feadcdad6bd966eac924b01bca59e1c",
      "original_line" : 119,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 442479057,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-18T18:53:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449634943",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@t-bast I'd strongly encourage you to _not_ use this branch or anything based on it for anything other than testing:\r\n\r\n- it's not merged yet, so still unreviewed\r\n- it's intended for testing only, and there are no guarantees about how it would work long-term in production (for example, the way that CConnman tracks the number of open connections is not updated to take account of these test connections. The commit here: https://github.com/ariard/bitcoin/commit/ea9943251b051a59d1b4cc7ae0ff34aeaea441f4 doesn't fix that)\r\n- since it's for testing only and not a public method, it may be removed or changed at any time.",
      "created_at" : "2020-07-03T15:35:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-653599673",
      "id" : 653599673,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1MzU5OTY3Mw==",
      "updated_at" : "2020-07-03T15:35:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/653599673",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r449646549"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449646549"
         }
      },
      "author_association" : "NONE",
      "body" : "Thanks for the pointer, I was wondering about the inconsistency between variables (`addrConnect` instead of `addr_connect`), but this probably falls under `These are preferred in new code, but are not required when doing so would need changes to significant pieces of existing code.`",
      "commit_id" : "e00848600f27c1495ff1bbc5e6aaa3d4f0cf5c95",
      "created_at" : "2020-07-03T16:04:44Z",
      "diff_hunk" : "@@ -367,8 +367,10 @@ static CAddress GetBindAddress(SOCKET sock)\n     return addr_bind;\n }\n \n-CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCountFailure, bool manual_connection, bool block_relay_only)\n+CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCountFailure, ConnectionType conn_type)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r449646549",
      "id" : 449646549,
      "in_reply_to_id" : 449410050,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY0NjU0OQ==",
      "original_commit_id" : "b43b7dba9feadcdad6bd966eac924b01bca59e1c",
      "original_line" : 371,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 442493370,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-18T18:53:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449646549",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/31281497?v=4",
         "events_url" : "https://api.github.com/users/t-bast/events{/privacy}",
         "followers_url" : "https://api.github.com/users/t-bast/followers",
         "following_url" : "https://api.github.com/users/t-bast/following{/other_user}",
         "gists_url" : "https://api.github.com/users/t-bast/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/t-bast",
         "id" : 31281497,
         "login" : "t-bast",
         "node_id" : "MDQ6VXNlcjMxMjgxNDk3",
         "organizations_url" : "https://api.github.com/users/t-bast/orgs",
         "received_events_url" : "https://api.github.com/users/t-bast/received_events",
         "repos_url" : "https://api.github.com/users/t-bast/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/t-bast/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/t-bast/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/t-bast"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r449647582"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449647582"
         }
      },
      "author_association" : "NONE",
      "body" : "Thanks, I should have done my homework and read that PR first (as was clearly said in the PR description!).",
      "commit_id" : "e00848600f27c1495ff1bbc5e6aaa3d4f0cf5c95",
      "created_at" : "2020-07-03T16:08:07Z",
      "diff_hunk" : "@@ -113,6 +113,14 @@ struct CSerializedNetMsg\n     std::string command;\n };\n \n+enum class ConnectionType {\n+    INBOUND, // peer initiated connections\n+    OUTBOUND, // full relay connections (blocks, addrs, txns)\n+    MANUAL, // connections to addresses added via addnode or the connect command line argument",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r449647582",
      "id" : 449647582,
      "in_reply_to_id" : 449412035,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY0NzU4Mg==",
      "original_commit_id" : "b43b7dba9feadcdad6bd966eac924b01bca59e1c",
      "original_line" : 119,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 442494612,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-18T18:53:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449647582",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/31281497?v=4",
         "events_url" : "https://api.github.com/users/t-bast/events{/privacy}",
         "followers_url" : "https://api.github.com/users/t-bast/followers",
         "following_url" : "https://api.github.com/users/t-bast/following{/other_user}",
         "gists_url" : "https://api.github.com/users/t-bast/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/t-bast",
         "id" : 31281497,
         "login" : "t-bast",
         "node_id" : "MDQ6VXNlcjMxMjgxNDk3",
         "organizations_url" : "https://api.github.com/users/t-bast/orgs",
         "received_events_url" : "https://api.github.com/users/t-bast/received_events",
         "repos_url" : "https://api.github.com/users/t-bast/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/t-bast/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/t-bast/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/t-bast"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Thanks for the concerns @jnewbery, no worries I'm not planning on using anything else than official `bitcoind` releases for `eclair`, I'm simply adding my concept ACK on the overall direction that will be quite helpful for hardening lightning!",
      "created_at" : "2020-07-03T16:10:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-653610473",
      "id" : 653610473,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1MzYxMDQ3Mw==",
      "updated_at" : "2020-07-03T16:10:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/653610473",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/31281497?v=4",
         "events_url" : "https://api.github.com/users/t-bast/events{/privacy}",
         "followers_url" : "https://api.github.com/users/t-bast/followers",
         "following_url" : "https://api.github.com/users/t-bast/following{/other_user}",
         "gists_url" : "https://api.github.com/users/t-bast/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/t-bast",
         "id" : 31281497,
         "login" : "t-bast",
         "node_id" : "MDQ6VXNlcjMxMjgxNDk3",
         "organizations_url" : "https://api.github.com/users/t-bast/orgs",
         "received_events_url" : "https://api.github.com/users/t-bast/received_events",
         "repos_url" : "https://api.github.com/users/t-bast/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/t-bast/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/t-bast/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/t-bast"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@jnewbery thanks to press on the warning. The provided commit is for experimentation-only and MUST NOT be used in production for reasons aforementioned.\r\n\r\nFor anyone reading this and providing more context, Lightning nodes interested to prevent against time-dilation attacks (a no-hashrate eclipse variant against offchain protocols) should have multiple access to the chain view. As of today, the classic infra setup is to run the LN stack on top of _one_ full-node, if this one gets sybilled and partitioned from the rest of the network, the channel funds are at risk. Running a self-hosted or controlled secondary node connected to your main node would mitigate at least eclipses due to weaknesses in addr management or peer selection. As of today, we do have automatic block-relay-only peers, for which in theory their topology should stay masked to an external observer. But a bug in peer selection may be leveraged to lure block-only-relay connections to attacker controlled-peers. Adding redundant _manual_ block-relay-only connections will prevent this. Manual block-only secondary nodes won't fit there as they do leak addr-relay, which can be used to learn about their presence.\r\n\r\nProvided commit (https://github.com/ariard/bitcoin/commit/ea9943251b051a59d1b4cc7ae0ff34aeaea441f4) let you experiment such primary/secondary block-relay-only topology setup. There is no guarantee that anything will stay stable. If by playing with it, you do see value in this configuration, please concept ack and help to review downstream branches. If you don't understand what you're doing don't use it or ask questions.\r\n\r\n ",
      "created_at" : "2020-07-03T17:02:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-653624340",
      "id" : 653624340,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1MzYyNDM0MA==",
      "updated_at" : "2020-07-03T17:17:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/653624340",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-07-07T18:28:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-655044251",
      "id" : 655044251,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1NTA0NDI1MQ==",
      "updated_at" : "2020-07-07T18:28:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/655044251",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r473836629"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/473836629"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Either remove this comment or place it above `addpeeraddress`, since they're both not shown in help.",
      "commit_id" : "e00848600f27c1495ff1bbc5e6aaa3d4f0cf5c95",
      "created_at" : "2020-08-20T09:59:17Z",
      "diff_hunk" : "@@ -841,6 +897,9 @@ static const CRPCCommand commands[] =\n     { \"network\",            \"setnetworkactive\",       &setnetworkactive,       {\"state\"} },\n     { \"network\",            \"getnodeaddresses\",       &getnodeaddresses,       {\"count\"} },\n     { \"hidden\",             \"addpeeraddress\",         &addpeeraddress,         {\"address\", \"port\"} },\n+\n+    /* Not shown in help */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r473836629",
      "id" : 473836629,
      "line" : 901,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzgzNjYyOQ==",
      "original_commit_id" : "e00848600f27c1495ff1bbc5e6aaa3d4f0cf5c95",
      "original_line" : 901,
      "original_position" : 75,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 75,
      "pull_request_review_id" : 471442648,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-20T10:36:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/473836629",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r473841451"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/473841451"
         }
      },
      "author_association" : "MEMBER",
      "body" : "style: sort and place on separate lines",
      "commit_id" : "e00848600f27c1495ff1bbc5e6aaa3d4f0cf5c95",
      "created_at" : "2020-08-20T10:04:43Z",
      "diff_hunk" : "@@ -65,7 +65,7 @@\n     NODE_WITNESS,\n     sha256,\n )\n-from test_framework.util import wait_until\n+from test_framework.util import wait_until, MAX_NODES, p2p_port",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r473841451",
      "id" : 473841451,
      "line" : 68,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzg0MTQ1MQ==",
      "original_commit_id" : "e00848600f27c1495ff1bbc5e6aaa3d4f0cf5c95",
      "original_line" : 68,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/mininode.py",
      "position" : 5,
      "pull_request_review_id" : 471442648,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-20T10:36:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/473841451",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r473856088"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/473856088"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Consider renaming this function (and the equivalents in `P2PInterface` and `TestNode`) to `peer_accept_connection()` or similar. From the perspective of the `P2PConnection`, this is an inbound connection since it's initiated by the bitcoind node.",
      "commit_id" : "e00848600f27c1495ff1bbc5e6aaa3d4f0cf5c95",
      "created_at" : "2020-08-20T10:22:34Z",
      "diff_hunk" : "@@ -139,12 +139,20 @@ def peer_connect(self, dstaddr, dstport, *, net, timeout_factor):\n         self.on_connection_send_msg = None\n         self.recvbuf = b\"\"\n         self.magic_bytes = MAGIC_BYTES[net]\n-        logger.debug('Connecting to Bitcoin Node: %s:%d' % (self.dstaddr, self.dstport))\n+\n+    def peer_connect(self, dstaddr, dstport, *, net, timeout_factor):\n+        self.peer_connect_helper(dstaddr, dstport, net, timeout_factor)\n \n         loop = NetworkThread.network_event_loop\n-        conn_gen_unsafe = loop.create_connection(lambda: self, host=self.dstaddr, port=self.dstport)\n-        conn_gen = lambda: loop.call_soon_threadsafe(loop.create_task, conn_gen_unsafe)\n-        return conn_gen\n+        logger.debug('Connecting to Bitcoin Node: %s:%d' % (self.dstaddr, self.dstport))\n+        coroutine = loop.create_connection(lambda: self, host=self.dstaddr, port=self.dstport)\n+        return lambda: loop.call_soon_threadsafe(loop.create_task, coroutine)\n+\n+    def peer_outbound_connect(self, dstaddr, dstport, connect_cb, connect_id=0, *, net, timeout_factor):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r473856088",
      "id" : 473856088,
      "line" : 151,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzg1NjA4OA==",
      "original_commit_id" : "e00848600f27c1495ff1bbc5e6aaa3d4f0cf5c95",
      "original_line" : 151,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/mininode.py",
      "position" : 35,
      "pull_request_review_id" : 471442648,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-20T10:36:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/473856088",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r473860655"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/473860655"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This doesn't actually test that the transaction won't get announced by the node, since transaction announcements are batched and only sent when the `nNextInvSend` timer pops. The `sync_with_ping()` above doesn't guarantee that there's nothing in the `setInventoryTxToSend` waiting to be sent (ie I think this test would still pass if this were an outbound-full-relay peer). I don't have any good suggestions except maybe adding a comment. Testing for the absence of something is hard!",
      "commit_id" : "e00848600f27c1495ff1bbc5e6aaa3d4f0cf5c95",
      "created_at" : "2020-08-20T10:28:16Z",
      "diff_hunk" : "@@ -69,18 +49,55 @@ def run_test(self):\n         peer_2_info = self.nodes[0].getpeerinfo()[1]\n         assert_equal(peer_2_info['whitelisted'], True)\n         assert_equal(peer_2_info['permissions'], ['noban', 'forcerelay', 'relay', 'mempool', 'download'])\n-        assert_equal(self.nodes[0].testmempoolaccept([sigtx])[0]['allowed'], True)\n-        txid = self.nodes[0].testmempoolaccept([sigtx])[0]['txid']\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n \n         self.log.info('Check that the tx from forcerelay first_peer is relayed to others (ie.second_peer)')\n         with self.nodes[0].assert_debug_log([\"received getdata\"]):\n-            first_peer.send_message(msg_tx(FromHex(CTransaction(), sigtx)))\n+            first_peer.send_message(msg_tx(tx))\n             self.log.info('Check that the forcerelay peer is still connected after sending the transaction')\n             assert_equal(first_peer.is_connected, True)\n             second_peer.wait_for_tx(txid)\n             assert_equal(self.nodes[0].getmempoolinfo()['size'], 1)\n         self.log.info(\"Forcerelay peer's transaction is accepted and relayed\")\n \n+        self.nodes[0].disconnect_p2ps()\n+        self.nodes[0].generate(1)\n+\n+    def blocks_relay_conn_tests(self):\n+        self.log.info('Tests with node in normal mode with block-relay-only connections')\n+        self.restart_node(0, [\"-noblocksonly\"])  # disables blocks only mode\n+        assert_equal(self.nodes[0].getnetworkinfo()['localrelay'], True)\n+\n+        # Ensure we disconnect if a block-relay-only connection sends us a transaction\n+        self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        assert_equal(self.nodes[0].getpeerinfo()[0]['relaytxes'], False)\n+        _, txid, tx_hex = self.check_p2p_tx_violation(index=2)\n+\n+        self.log.info(\"Check that txs from RPC are not sent to blockrelay connection\")\n+        conn = self.nodes[0].add_outbound_p2p_connection(P2PTxInvStore(), connection_type=\"blockrelay\")\n+\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n+        self.nodes[0].sendrawtransaction(tx_hex)\n+        conn.sync_with_ping()\n+        assert(txid not in conn.get_invs())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r473860655",
      "id" : 473860655,
      "line" : 82,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzg2MDY1NQ==",
      "original_commit_id" : "e00848600f27c1495ff1bbc5e6aaa3d4f0cf5c95",
      "original_line" : 82,
      "original_position" : 109,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : 109,
      "pull_request_review_id" : 471442648,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-20T10:36:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/473860655",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r473866387"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/473866387"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`getnewaddress` requires a wallet, so this test fails without the wallet compiled. Can you replace it with a hard-coded address?",
      "commit_id" : "e00848600f27c1495ff1bbc5e6aaa3d4f0cf5c95",
      "created_at" : "2020-08-20T10:35:25Z",
      "diff_hunk" : "@@ -69,18 +49,55 @@ def run_test(self):\n         peer_2_info = self.nodes[0].getpeerinfo()[1]\n         assert_equal(peer_2_info['whitelisted'], True)\n         assert_equal(peer_2_info['permissions'], ['noban', 'forcerelay', 'relay', 'mempool', 'download'])\n-        assert_equal(self.nodes[0].testmempoolaccept([sigtx])[0]['allowed'], True)\n-        txid = self.nodes[0].testmempoolaccept([sigtx])[0]['txid']\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n \n         self.log.info('Check that the tx from forcerelay first_peer is relayed to others (ie.second_peer)')\n         with self.nodes[0].assert_debug_log([\"received getdata\"]):\n-            first_peer.send_message(msg_tx(FromHex(CTransaction(), sigtx)))\n+            first_peer.send_message(msg_tx(tx))\n             self.log.info('Check that the forcerelay peer is still connected after sending the transaction')\n             assert_equal(first_peer.is_connected, True)\n             second_peer.wait_for_tx(txid)\n             assert_equal(self.nodes[0].getmempoolinfo()['size'], 1)\n         self.log.info(\"Forcerelay peer's transaction is accepted and relayed\")\n \n+        self.nodes[0].disconnect_p2ps()\n+        self.nodes[0].generate(1)\n+\n+    def blocks_relay_conn_tests(self):\n+        self.log.info('Tests with node in normal mode with block-relay-only connections')\n+        self.restart_node(0, [\"-noblocksonly\"])  # disables blocks only mode\n+        assert_equal(self.nodes[0].getnetworkinfo()['localrelay'], True)\n+\n+        # Ensure we disconnect if a block-relay-only connection sends us a transaction\n+        self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        assert_equal(self.nodes[0].getpeerinfo()[0]['relaytxes'], False)\n+        _, txid, tx_hex = self.check_p2p_tx_violation(index=2)\n+\n+        self.log.info(\"Check that txs from RPC are not sent to blockrelay connection\")\n+        conn = self.nodes[0].add_outbound_p2p_connection(P2PTxInvStore(), connection_type=\"blockrelay\")\n+\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n+        self.nodes[0].sendrawtransaction(tx_hex)\n+        conn.sync_with_ping()\n+        assert(txid not in conn.get_invs())\n+\n+    def check_p2p_tx_violation(self, index=1):\n+        self.log.info('Check that txs from P2P are rejected and result in disconnect')\n+        input_txid = self.nodes[0].getblock(self.nodes[0].getblockhash(index), 2)['tx'][0]['txid']\n+        tx = create_transaction(self.nodes[0], input_txid, self.nodes[0].getnewaddress(), amount=50 - 0.001)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r473866387",
      "id" : 473866387,
      "line" : 87,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzg2NjM4Nw==",
      "original_commit_id" : "e00848600f27c1495ff1bbc5e6aaa3d4f0cf5c95",
      "original_line" : 87,
      "original_position" : 114,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : 114,
      "pull_request_review_id" : 471442648,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-20T10:36:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/473866387",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r474970241"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/474970241"
         }
      },
      "author_association" : "MEMBER",
      "body" : "great point. renaming this & the equivalent on `P2PInterface` to `peer_accept_connection()` is much clearer. \r\n\r\nbut for `TestNode`, I think `add_outbound_p2p_connection()` makes sense? its a connection from node -> p2p conn, so outbound for node. inbound / accept for the P2P connections.",
      "commit_id" : "e00848600f27c1495ff1bbc5e6aaa3d4f0cf5c95",
      "created_at" : "2020-08-21T21:06:12Z",
      "diff_hunk" : "@@ -139,12 +139,20 @@ def peer_connect(self, dstaddr, dstport, *, net, timeout_factor):\n         self.on_connection_send_msg = None\n         self.recvbuf = b\"\"\n         self.magic_bytes = MAGIC_BYTES[net]\n-        logger.debug('Connecting to Bitcoin Node: %s:%d' % (self.dstaddr, self.dstport))\n+\n+    def peer_connect(self, dstaddr, dstport, *, net, timeout_factor):\n+        self.peer_connect_helper(dstaddr, dstport, net, timeout_factor)\n \n         loop = NetworkThread.network_event_loop\n-        conn_gen_unsafe = loop.create_connection(lambda: self, host=self.dstaddr, port=self.dstport)\n-        conn_gen = lambda: loop.call_soon_threadsafe(loop.create_task, conn_gen_unsafe)\n-        return conn_gen\n+        logger.debug('Connecting to Bitcoin Node: %s:%d' % (self.dstaddr, self.dstport))\n+        coroutine = loop.create_connection(lambda: self, host=self.dstaddr, port=self.dstport)\n+        return lambda: loop.call_soon_threadsafe(loop.create_task, coroutine)\n+\n+    def peer_outbound_connect(self, dstaddr, dstport, connect_cb, connect_id=0, *, net, timeout_factor):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r474970241",
      "id" : 474970241,
      "in_reply_to_id" : 473856088,
      "line" : 151,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk3MDI0MQ==",
      "original_commit_id" : "e00848600f27c1495ff1bbc5e6aaa3d4f0cf5c95",
      "original_line" : 151,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/mininode.py",
      "position" : 35,
      "pull_request_review_id" : 472819489,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-21T21:06:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/474970241",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   }
]
