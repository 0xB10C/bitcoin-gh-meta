[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19324#discussion_r442521966"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19324"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442521966"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"walletdb: Combine VerifyDatabaseFile and VerifyEnvironment\" (ae1a9d9ebbe1b53fd245fddd1907ca90fe3a7abe)\r\n\r\nThink need to replace `file_path` with `(walletDir / strFile)` here not just `walletDir`",
      "commit_id" : "893ec59bc28cd09cfbbb2dce9e92b6b87dd81a14",
      "created_at" : "2020-06-18T21:50:34Z",
      "diff_hunk" : "@@ -292,33 +292,22 @@ BerkeleyBatch::SafeDbt::operator Dbt*()\n     return &m_dbt;\n }\n \n-bool BerkeleyBatch::VerifyEnvironment(const fs::path& file_path, bilingual_str& errorStr)\n+bool BerkeleyDatabase::Verify(bilingual_str& errorStr)\n {\n-    std::string walletFile;\n-    std::shared_ptr<BerkeleyEnvironment> env = GetWalletEnv(file_path, walletFile);\n     fs::path walletDir = env->Directory();\n \n     LogPrintf(\"Using BerkeleyDB version %s\\n\", BerkeleyDatabaseVersion());\n-    LogPrintf(\"Using wallet %s\\n\", file_path.string());\n+    LogPrintf(\"Using wallet %s\\n\", walletDir.string());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19324#discussion_r442521966",
      "id" : 442521966,
      "line" : 300,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUyMTk2Ng==",
      "original_commit_id" : "ae1a9d9ebbe1b53fd245fddd1907ca90fe3a7abe",
      "original_line" : 300,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/wallet/bdb.cpp",
      "position" : 13,
      "pull_request_review_id" : 433672001,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19324",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-18T22:23:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442521966",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19324#discussion_r442522858"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19324"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442522858"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"walletdb: Combine VerifyDatabaseFile and VerifyEnvironment\" (ae1a9d9ebbe1b53fd245fddd1907ca90fe3a7abe)\r\n\r\nAssigning null should be redundant after calling reset",
      "commit_id" : "893ec59bc28cd09cfbbb2dce9e92b6b87dd81a14",
      "created_at" : "2020-06-18T21:52:49Z",
      "diff_hunk" : "@@ -141,10 +141,13 @@ bool ExecuteWalletToolFunc(const std::string& command, const std::string& name)\n             return false;\n         }\n         bilingual_str error;\n-        if (!WalletBatch::VerifyEnvironment(path, error)) {\n+        std::unique_ptr<WalletDatabase> database = CreateWalletDatabase(path);\n+        if (!database->Verify(error)) {\n             tfm::format(std::cerr, \"%s\\nError loading %s. Is wallet being used by other process?\\n\", error.original, name);\n             return false;\n         }\n+        database.reset();\n+        database = nullptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19324#discussion_r442522858",
      "id" : 442522858,
      "line" : 150,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUyMjg1OA==",
      "original_commit_id" : "ae1a9d9ebbe1b53fd245fddd1907ca90fe3a7abe",
      "original_line" : 150,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/wallet/wallettool.cpp",
      "position" : 20,
      "pull_request_review_id" : 433672001,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19324",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-18T22:23:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442522858",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19324#discussion_r442523873"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19324"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442523873"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"walletdb: Combine VerifyDatabaseFile and VerifyEnvironment\" (ae1a9d9ebbe1b53fd245fddd1907ca90fe3a7abe)\r\n\r\nWould be a change in behavior, but probably more useful to print `walletDir / strFile` than `strFile` here",
      "commit_id" : "893ec59bc28cd09cfbbb2dce9e92b6b87dd81a14",
      "created_at" : "2020-06-18T21:55:30Z",
      "diff_hunk" : "@@ -292,33 +292,22 @@ BerkeleyBatch::SafeDbt::operator Dbt*()\n     return &m_dbt;\n }\n \n-bool BerkeleyBatch::VerifyEnvironment(const fs::path& file_path, bilingual_str& errorStr)\n+bool BerkeleyDatabase::Verify(bilingual_str& errorStr)\n {\n-    std::string walletFile;\n-    std::shared_ptr<BerkeleyEnvironment> env = GetWalletEnv(file_path, walletFile);\n     fs::path walletDir = env->Directory();\n \n     LogPrintf(\"Using BerkeleyDB version %s\\n\", BerkeleyDatabaseVersion());\n-    LogPrintf(\"Using wallet %s\\n\", file_path.string());\n+    LogPrintf(\"Using wallet %s\\n\", walletDir.string());\n \n     if (!env->Open(true /* retry */)) {\n         errorStr = strprintf(_(\"Error initializing wallet database environment %s!\"), walletDir);\n         return false;\n     }\n \n-    return true;\n-}\n-\n-bool BerkeleyBatch::VerifyDatabaseFile(const fs::path& file_path, bilingual_str& errorStr)\n-{\n-    std::string walletFile;\n-    std::shared_ptr<BerkeleyEnvironment> env = GetWalletEnv(file_path, walletFile);\n-    fs::path walletDir = env->Directory();\n-\n-    if (fs::exists(walletDir / walletFile))\n+    if (fs::exists(walletDir / strFile))\n     {\n-        if (!env->Verify(walletFile)) {\n-            errorStr = strprintf(_(\"%s corrupt. Try using the wallet tool bitcoin-wallet to salvage or restoring a backup.\"), walletFile);\n+        if (!env->Verify(strFile)) {\n+            errorStr = strprintf(_(\"%s corrupt. Try using the wallet tool bitcoin-wallet to salvage or restoring a backup.\"), strFile);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19324#discussion_r442523873",
      "id" : 442523873,
      "line" : 310,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUyMzg3Mw==",
      "original_commit_id" : "ae1a9d9ebbe1b53fd245fddd1907ca90fe3a7abe",
      "original_line" : 310,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/wallet/bdb.cpp",
      "position" : 35,
      "pull_request_review_id" : 433672001,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19324",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-18T22:23:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442523873",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19324#discussion_r442527386"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19324"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442527386"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"walletdb: Combine VerifyDatabaseFile and VerifyEnvironment\" (ae1a9d9ebbe1b53fd245fddd1907ca90fe3a7abe)\r\n\r\nIt doesn't seem like there is a point to calling Verify here in `SalvageWallet` when `ExecuteWalletToolFunc` already called it immediately before calling this. It seems like this `SalvageWallet` function could just be dropped and `ExecuteWalletToolFunc` just call `RecoverDatabaseFile` directly.",
      "commit_id" : "893ec59bc28cd09cfbbb2dce9e92b6b87dd81a14",
      "created_at" : "2020-06-18T22:04:24Z",
      "diff_hunk" : "@@ -112,7 +112,7 @@ static bool SalvageWallet(const fs::path& path)\n     // Initialize the environment before recovery\n     bilingual_str error_string;\n     try {\n-        WalletBatch::VerifyEnvironment(path, error_string);\n+        database->Verify(error_string);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19324#discussion_r442527386",
      "id" : 442527386,
      "line" : 115,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUyNzM4Ng==",
      "original_commit_id" : "ae1a9d9ebbe1b53fd245fddd1907ca90fe3a7abe",
      "original_line" : 115,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/wallettool.cpp",
      "position" : 5,
      "pull_request_review_id" : 433672001,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19324",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-18T22:23:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442527386",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19324#discussion_r442532065"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19324"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442532065"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"walletdb: Combine VerifyDatabaseFile and VerifyEnvironment\" (ae1a9d9ebbe1b53fd245fddd1907ca90fe3a7abe)\r\n\r\nThere is a change in behavior here for the wallettool \"info\" and \"salvage\" commands. Previously these commands were just seeing if the environment could be opened here and not actually verifying anything (VerifyEnvironment method name was kind of a misnomer). Now \"info\" and \"salvage\" will be actually verifying the database before working, so they will be little slower, and maybe more useful or maybe less useful than before depending on if your database is corrupt and what you are trying to do.\r\n\r\nCould preserve previous behavior by adding a `Database::VerifyWalletNotInUse()` method that would just call env::Open and do what the previous code used to do here. Another option for preserving previous behavior would be to call the `Database::ReloadDbEnv` method here, which should be effectively be equivalent to the previous VerifyEnvironment.",
      "commit_id" : "893ec59bc28cd09cfbbb2dce9e92b6b87dd81a14",
      "created_at" : "2020-06-18T22:17:33Z",
      "diff_hunk" : "@@ -141,10 +141,13 @@ bool ExecuteWalletToolFunc(const std::string& command, const std::string& name)\n             return false;\n         }\n         bilingual_str error;\n-        if (!WalletBatch::VerifyEnvironment(path, error)) {\n+        std::unique_ptr<WalletDatabase> database = CreateWalletDatabase(path);\n+        if (!database->Verify(error)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19324#discussion_r442532065",
      "id" : 442532065,
      "line" : 145,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUzMjA2NQ==",
      "original_commit_id" : "ae1a9d9ebbe1b53fd245fddd1907ca90fe3a7abe",
      "original_line" : 145,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/wallet/wallettool.cpp",
      "position" : 15,
      "pull_request_review_id" : 433672001,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19324",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-18T22:23:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442532065",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   }
]
