[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19324#discussion_r442521966"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19324"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442521966"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"walletdb: Combine VerifyDatabaseFile and VerifyEnvironment\" (ae1a9d9ebbe1b53fd245fddd1907ca90fe3a7abe)\r\n\r\nThink need to replace `file_path` with `(walletDir / strFile)` here not just `walletDir`",
      "commit_id" : "4693b11a896cd6b18e61bb3cdbfec72f7e0a2d93",
      "created_at" : "2020-06-18T21:50:34Z",
      "diff_hunk" : "@@ -292,33 +292,22 @@ BerkeleyBatch::SafeDbt::operator Dbt*()\n     return &m_dbt;\n }\n \n-bool BerkeleyBatch::VerifyEnvironment(const fs::path& file_path, bilingual_str& errorStr)\n+bool BerkeleyDatabase::Verify(bilingual_str& errorStr)\n {\n-    std::string walletFile;\n-    std::shared_ptr<BerkeleyEnvironment> env = GetWalletEnv(file_path, walletFile);\n     fs::path walletDir = env->Directory();\n \n     LogPrintf(\"Using BerkeleyDB version %s\\n\", BerkeleyDatabaseVersion());\n-    LogPrintf(\"Using wallet %s\\n\", file_path.string());\n+    LogPrintf(\"Using wallet %s\\n\", walletDir.string());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19324#discussion_r442521966",
      "id" : 442521966,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUyMTk2Ng==",
      "original_commit_id" : "ae1a9d9ebbe1b53fd245fddd1907ca90fe3a7abe",
      "original_line" : 300,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/wallet/bdb.cpp",
      "position" : null,
      "pull_request_review_id" : 433672001,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19324",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-18T23:51:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442521966",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19324#discussion_r442522858"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19324"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442522858"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"walletdb: Combine VerifyDatabaseFile and VerifyEnvironment\" (ae1a9d9ebbe1b53fd245fddd1907ca90fe3a7abe)\r\n\r\nAssigning null should be redundant after calling reset",
      "commit_id" : "4693b11a896cd6b18e61bb3cdbfec72f7e0a2d93",
      "created_at" : "2020-06-18T21:52:49Z",
      "diff_hunk" : "@@ -141,10 +141,13 @@ bool ExecuteWalletToolFunc(const std::string& command, const std::string& name)\n             return false;\n         }\n         bilingual_str error;\n-        if (!WalletBatch::VerifyEnvironment(path, error)) {\n+        std::unique_ptr<WalletDatabase> database = CreateWalletDatabase(path);\n+        if (!database->Verify(error)) {\n             tfm::format(std::cerr, \"%s\\nError loading %s. Is wallet being used by other process?\\n\", error.original, name);\n             return false;\n         }\n+        database.reset();\n+        database = nullptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19324#discussion_r442522858",
      "id" : 442522858,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUyMjg1OA==",
      "original_commit_id" : "ae1a9d9ebbe1b53fd245fddd1907ca90fe3a7abe",
      "original_line" : 150,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/wallet/wallettool.cpp",
      "position" : null,
      "pull_request_review_id" : 433672001,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19324",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-18T23:51:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442522858",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19324#discussion_r442523873"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19324"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442523873"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"walletdb: Combine VerifyDatabaseFile and VerifyEnvironment\" (ae1a9d9ebbe1b53fd245fddd1907ca90fe3a7abe)\r\n\r\nWould be a change in behavior, but probably more useful to print `walletDir / strFile` than `strFile` here",
      "commit_id" : "4693b11a896cd6b18e61bb3cdbfec72f7e0a2d93",
      "created_at" : "2020-06-18T21:55:30Z",
      "diff_hunk" : "@@ -292,33 +292,22 @@ BerkeleyBatch::SafeDbt::operator Dbt*()\n     return &m_dbt;\n }\n \n-bool BerkeleyBatch::VerifyEnvironment(const fs::path& file_path, bilingual_str& errorStr)\n+bool BerkeleyDatabase::Verify(bilingual_str& errorStr)\n {\n-    std::string walletFile;\n-    std::shared_ptr<BerkeleyEnvironment> env = GetWalletEnv(file_path, walletFile);\n     fs::path walletDir = env->Directory();\n \n     LogPrintf(\"Using BerkeleyDB version %s\\n\", BerkeleyDatabaseVersion());\n-    LogPrintf(\"Using wallet %s\\n\", file_path.string());\n+    LogPrintf(\"Using wallet %s\\n\", walletDir.string());\n \n     if (!env->Open(true /* retry */)) {\n         errorStr = strprintf(_(\"Error initializing wallet database environment %s!\"), walletDir);\n         return false;\n     }\n \n-    return true;\n-}\n-\n-bool BerkeleyBatch::VerifyDatabaseFile(const fs::path& file_path, bilingual_str& errorStr)\n-{\n-    std::string walletFile;\n-    std::shared_ptr<BerkeleyEnvironment> env = GetWalletEnv(file_path, walletFile);\n-    fs::path walletDir = env->Directory();\n-\n-    if (fs::exists(walletDir / walletFile))\n+    if (fs::exists(walletDir / strFile))\n     {\n-        if (!env->Verify(walletFile)) {\n-            errorStr = strprintf(_(\"%s corrupt. Try using the wallet tool bitcoin-wallet to salvage or restoring a backup.\"), walletFile);\n+        if (!env->Verify(strFile)) {\n+            errorStr = strprintf(_(\"%s corrupt. Try using the wallet tool bitcoin-wallet to salvage or restoring a backup.\"), strFile);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19324#discussion_r442523873",
      "id" : 442523873,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUyMzg3Mw==",
      "original_commit_id" : "ae1a9d9ebbe1b53fd245fddd1907ca90fe3a7abe",
      "original_line" : 310,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/wallet/bdb.cpp",
      "position" : null,
      "pull_request_review_id" : 433672001,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19324",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-18T23:51:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442523873",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19324#discussion_r442527386"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19324"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442527386"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"walletdb: Combine VerifyDatabaseFile and VerifyEnvironment\" (ae1a9d9ebbe1b53fd245fddd1907ca90fe3a7abe)\r\n\r\nIt doesn't seem like there is a point to calling Verify here in `SalvageWallet` when `ExecuteWalletToolFunc` already called it immediately before calling this. It seems like this `SalvageWallet` function could just be dropped and `ExecuteWalletToolFunc` just call `RecoverDatabaseFile` directly.",
      "commit_id" : "4693b11a896cd6b18e61bb3cdbfec72f7e0a2d93",
      "created_at" : "2020-06-18T22:04:24Z",
      "diff_hunk" : "@@ -112,7 +112,7 @@ static bool SalvageWallet(const fs::path& path)\n     // Initialize the environment before recovery\n     bilingual_str error_string;\n     try {\n-        WalletBatch::VerifyEnvironment(path, error_string);\n+        database->Verify(error_string);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19324#discussion_r442527386",
      "id" : 442527386,
      "line" : 115,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUyNzM4Ng==",
      "original_commit_id" : "ae1a9d9ebbe1b53fd245fddd1907ca90fe3a7abe",
      "original_line" : 115,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/wallettool.cpp",
      "position" : 5,
      "pull_request_review_id" : 433672001,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19324",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-18T23:51:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442527386",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19324#discussion_r442532065"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19324"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442532065"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"walletdb: Combine VerifyDatabaseFile and VerifyEnvironment\" (ae1a9d9ebbe1b53fd245fddd1907ca90fe3a7abe)\r\n\r\nThere is a change in behavior here for the wallettool \"info\" and \"salvage\" commands. Previously these commands were just seeing if the environment could be opened here and not actually verifying anything (VerifyEnvironment method name was kind of a misnomer). Now \"info\" and \"salvage\" will be actually verifying the database before working, so they will be little slower, and maybe more useful or maybe less useful than before depending on if your database is corrupt and what you are trying to do.\r\n\r\nCould preserve previous behavior by adding a `Database::VerifyWalletNotInUse()` method that would just call env::Open and do what the previous code used to do here. Another option for preserving previous behavior would be to call the `Database::ReloadDbEnv` method here, which should be effectively be equivalent to the previous VerifyEnvironment.",
      "commit_id" : "4693b11a896cd6b18e61bb3cdbfec72f7e0a2d93",
      "created_at" : "2020-06-18T22:17:33Z",
      "diff_hunk" : "@@ -141,10 +141,13 @@ bool ExecuteWalletToolFunc(const std::string& command, const std::string& name)\n             return false;\n         }\n         bilingual_str error;\n-        if (!WalletBatch::VerifyEnvironment(path, error)) {\n+        std::unique_ptr<WalletDatabase> database = CreateWalletDatabase(path);\n+        if (!database->Verify(error)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19324#discussion_r442532065",
      "id" : 442532065,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjUzMjA2NQ==",
      "original_commit_id" : "ae1a9d9ebbe1b53fd245fddd1907ca90fe3a7abe",
      "original_line" : 145,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/wallet/wallettool.cpp",
      "position" : null,
      "pull_request_review_id" : 433672001,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19324",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-18T23:51:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442532065",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19324#discussion_r442560835"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19324"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442560835"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "4693b11a896cd6b18e61bb3cdbfec72f7e0a2d93",
      "created_at" : "2020-06-18T23:54:02Z",
      "diff_hunk" : "@@ -292,33 +292,22 @@ BerkeleyBatch::SafeDbt::operator Dbt*()\n     return &m_dbt;\n }\n \n-bool BerkeleyBatch::VerifyEnvironment(const fs::path& file_path, bilingual_str& errorStr)\n+bool BerkeleyDatabase::Verify(bilingual_str& errorStr)\n {\n-    std::string walletFile;\n-    std::shared_ptr<BerkeleyEnvironment> env = GetWalletEnv(file_path, walletFile);\n     fs::path walletDir = env->Directory();\n \n     LogPrintf(\"Using BerkeleyDB version %s\\n\", BerkeleyDatabaseVersion());\n-    LogPrintf(\"Using wallet %s\\n\", file_path.string());\n+    LogPrintf(\"Using wallet %s\\n\", walletDir.string());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19324#discussion_r442560835",
      "id" : 442560835,
      "in_reply_to_id" : 442521966,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU2MDgzNQ==",
      "original_commit_id" : "ae1a9d9ebbe1b53fd245fddd1907ca90fe3a7abe",
      "original_line" : 300,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/wallet/bdb.cpp",
      "position" : null,
      "pull_request_review_id" : 433719367,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19324",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-18T23:54:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442560835",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19324#discussion_r442560856"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19324"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442560856"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "4693b11a896cd6b18e61bb3cdbfec72f7e0a2d93",
      "created_at" : "2020-06-18T23:54:08Z",
      "diff_hunk" : "@@ -141,10 +141,13 @@ bool ExecuteWalletToolFunc(const std::string& command, const std::string& name)\n             return false;\n         }\n         bilingual_str error;\n-        if (!WalletBatch::VerifyEnvironment(path, error)) {\n+        std::unique_ptr<WalletDatabase> database = CreateWalletDatabase(path);\n+        if (!database->Verify(error)) {\n             tfm::format(std::cerr, \"%s\\nError loading %s. Is wallet being used by other process?\\n\", error.original, name);\n             return false;\n         }\n+        database.reset();\n+        database = nullptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19324#discussion_r442560856",
      "id" : 442560856,
      "in_reply_to_id" : 442522858,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU2MDg1Ng==",
      "original_commit_id" : "ae1a9d9ebbe1b53fd245fddd1907ca90fe3a7abe",
      "original_line" : 150,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/wallet/wallettool.cpp",
      "position" : null,
      "pull_request_review_id" : 433719400,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19324",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-18T23:54:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442560856",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19324#discussion_r442560888"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19324"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442560888"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "4693b11a896cd6b18e61bb3cdbfec72f7e0a2d93",
      "created_at" : "2020-06-18T23:54:15Z",
      "diff_hunk" : "@@ -292,33 +292,22 @@ BerkeleyBatch::SafeDbt::operator Dbt*()\n     return &m_dbt;\n }\n \n-bool BerkeleyBatch::VerifyEnvironment(const fs::path& file_path, bilingual_str& errorStr)\n+bool BerkeleyDatabase::Verify(bilingual_str& errorStr)\n {\n-    std::string walletFile;\n-    std::shared_ptr<BerkeleyEnvironment> env = GetWalletEnv(file_path, walletFile);\n     fs::path walletDir = env->Directory();\n \n     LogPrintf(\"Using BerkeleyDB version %s\\n\", BerkeleyDatabaseVersion());\n-    LogPrintf(\"Using wallet %s\\n\", file_path.string());\n+    LogPrintf(\"Using wallet %s\\n\", walletDir.string());\n \n     if (!env->Open(true /* retry */)) {\n         errorStr = strprintf(_(\"Error initializing wallet database environment %s!\"), walletDir);\n         return false;\n     }\n \n-    return true;\n-}\n-\n-bool BerkeleyBatch::VerifyDatabaseFile(const fs::path& file_path, bilingual_str& errorStr)\n-{\n-    std::string walletFile;\n-    std::shared_ptr<BerkeleyEnvironment> env = GetWalletEnv(file_path, walletFile);\n-    fs::path walletDir = env->Directory();\n-\n-    if (fs::exists(walletDir / walletFile))\n+    if (fs::exists(walletDir / strFile))\n     {\n-        if (!env->Verify(walletFile)) {\n-            errorStr = strprintf(_(\"%s corrupt. Try using the wallet tool bitcoin-wallet to salvage or restoring a backup.\"), walletFile);\n+        if (!env->Verify(strFile)) {\n+            errorStr = strprintf(_(\"%s corrupt. Try using the wallet tool bitcoin-wallet to salvage or restoring a backup.\"), strFile);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19324#discussion_r442560888",
      "id" : 442560888,
      "in_reply_to_id" : 442523873,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU2MDg4OA==",
      "original_commit_id" : "ae1a9d9ebbe1b53fd245fddd1907ca90fe3a7abe",
      "original_line" : 310,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/wallet/bdb.cpp",
      "position" : null,
      "pull_request_review_id" : 433719439,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19324",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-18T23:54:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442560888",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19324#discussion_r442561512"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19324"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442561512"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Since the database is closed before we reach this function, we need to reopen it before doing the recovery function. We could remove this and only close the database for `info` but that seems a bit like a hack.\r\n\r\nMaybe something to think about for a followup.",
      "commit_id" : "4693b11a896cd6b18e61bb3cdbfec72f7e0a2d93",
      "created_at" : "2020-06-18T23:56:24Z",
      "diff_hunk" : "@@ -112,7 +112,7 @@ static bool SalvageWallet(const fs::path& path)\n     // Initialize the environment before recovery\n     bilingual_str error_string;\n     try {\n-        WalletBatch::VerifyEnvironment(path, error_string);\n+        database->Verify(error_string);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19324#discussion_r442561512",
      "id" : 442561512,
      "in_reply_to_id" : 442527386,
      "line" : 115,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU2MTUxMg==",
      "original_commit_id" : "ae1a9d9ebbe1b53fd245fddd1907ca90fe3a7abe",
      "original_line" : 115,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/wallettool.cpp",
      "position" : 5,
      "pull_request_review_id" : 433720110,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19324",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-18T23:56:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442561512",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19324#discussion_r442561702"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19324"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442561702"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've added `VerifyNotInUse`. This function is still called by `Verify` so that the behavior of other `Verify` calls here won't change.",
      "commit_id" : "4693b11a896cd6b18e61bb3cdbfec72f7e0a2d93",
      "created_at" : "2020-06-18T23:57:10Z",
      "diff_hunk" : "@@ -141,10 +141,13 @@ bool ExecuteWalletToolFunc(const std::string& command, const std::string& name)\n             return false;\n         }\n         bilingual_str error;\n-        if (!WalletBatch::VerifyEnvironment(path, error)) {\n+        std::unique_ptr<WalletDatabase> database = CreateWalletDatabase(path);\n+        if (!database->Verify(error)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19324#discussion_r442561702",
      "id" : 442561702,
      "in_reply_to_id" : 442532065,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU2MTcwMg==",
      "original_commit_id" : "ae1a9d9ebbe1b53fd245fddd1907ca90fe3a7abe",
      "original_line" : 145,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/wallet/wallettool.cpp",
      "position" : null,
      "pull_request_review_id" : 433720329,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19324",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-18T23:57:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442561702",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #19335 (wallet: Cleanup and separate BerkeleyDatabase and BerkeleyBatch by achow101)\n* #19334 (wallet: Introduce WalletDatabase abstract class by achow101)\n* #19325 (wallet: Refactor BerkeleyDatabase to introduce DatabaseBatch abstract class by achow101)\n* #19137 (wallettool: Add dump and createfromdump commands by achow101)\n* #19102 (wallet: Introduce and use DummyDatabase instead of dummy BerkeleyDatabase by achow101)\n* #18608 (refactor: Remove CAddressBookData::destdata by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-06-19T02:31:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19324#issuecomment-646400701",
      "id" : 646400701,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19324",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0NjQwMDcwMQ==",
      "updated_at" : "2020-06-20T03:41:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/646400701",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Code review ACK 4693b11a896cd6b18e61bb3cdbfec72f7e0a2d93.\r\n\r\nNo strong opinion whether wallet tool info and salvage should verify.",
      "created_at" : "2020-06-20T10:33:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19324#issuecomment-646974593",
      "id" : 646974593,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19324",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0Njk3NDU5Mw==",
      "updated_at" : "2020-06-20T10:33:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/646974593",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19324#discussion_r444268873"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19324"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/444268873"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"walletdb: Combine VerifyDatabaseFile and VerifyEnvironment\" (cba81c3272405332cbb2f3b9c6b2c828c1869d16)\r\n\r\nWould call this OpenEnvironment and make it private. Earlier suggestion to add a VerifyNotInUse method https://github.com/bitcoin/bitcoin/pull/19324#discussion_r442532065 was to add a new method wallettool could call, not rename this method in a way which I think is misleading about what it does and how it's used outside of wallettool.",
      "commit_id" : "4693b11a896cd6b18e61bb3cdbfec72f7e0a2d93",
      "created_at" : "2020-06-23T14:29:33Z",
      "diff_hunk" : "@@ -292,11 +292,10 @@ BerkeleyBatch::SafeDbt::operator Dbt*()\n     return &m_dbt;\n }\n \n-bool BerkeleyBatch::VerifyEnvironment(const fs::path& file_path, bilingual_str& errorStr)\n+bool BerkeleyDatabase::VerifyNotInUse(bilingual_str& errorStr)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19324#discussion_r444268873",
      "id" : 444268873,
      "line" : 295,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI2ODg3Mw==",
      "original_commit_id" : "cba81c3272405332cbb2f3b9c6b2c828c1869d16",
      "original_line" : 295,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/bdb.cpp",
      "position" : 5,
      "pull_request_review_id" : 435842026,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19324",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-23T14:48:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/444268873",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19324#discussion_r444277894"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19324"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/444277894"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"walletdb: Combine VerifyDatabaseFile and VerifyEnvironment\" (cba81c3272405332cbb2f3b9c6b2c828c1869d16)\r\n\r\n> I've added `VerifyNotInUse`. This function is still called by `Verify` so that the behavior of other `Verify` calls here won't change.\r\n\r\nI think this open before open code in wallet tool can be dropped entirely. It seems like the only purpose of this is to show an \"Error loading %s. Is wallet being used by other process?\" string instead of an \"Error loading wallet. %s\" string",
      "commit_id" : "4693b11a896cd6b18e61bb3cdbfec72f7e0a2d93",
      "created_at" : "2020-06-23T14:40:55Z",
      "diff_hunk" : "@@ -141,10 +141,12 @@ bool ExecuteWalletToolFunc(const std::string& command, const std::string& name)\n             return false;\n         }\n         bilingual_str error;\n-        if (!WalletBatch::VerifyEnvironment(path, error)) {\n+        std::unique_ptr<WalletDatabase> database = CreateWalletDatabase(path);\n+        if (!database->VerifyNotInUse(error)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19324#discussion_r444277894",
      "id" : 444277894,
      "line" : 145,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI3Nzg5NA==",
      "original_commit_id" : "cba81c3272405332cbb2f3b9c6b2c828c1869d16",
      "original_line" : 145,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/wallet/wallettool.cpp",
      "position" : 15,
      "pull_request_review_id" : 435842026,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19324",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-23T14:48:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/444277894",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   }
]
