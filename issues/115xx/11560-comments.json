[
   {
      "author_association" : "MEMBER",
      "body" : "I'm still working on a unit test for this, but wanted to get some eyes on it for consideration in 0.15.0.2.",
      "created_at" : "2017-10-25T19:44:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11560#issuecomment-339448546",
      "id" : 339448546,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11560",
      "updated_at" : "2017-10-25T19:44:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/339448546",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11560#discussion_r146967629"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146967629"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'd prefer to see this be a int_64 max, so I don't need to reason about how monotone our clocks aren't.",
      "commit_id" : "c44d6bd98216b07044e467787a5c2e91c635ad82",
      "created_at" : "2017-10-25T19:50:08Z",
      "diff_hunk" : "@@ -2928,10 +2940,61 @@ void PeerLogicValidation::ConsiderEviction(CNode *pto, int64_t time_in_seconds)\n     }\n }\n \n+void PeerLogicValidation::CheckForStaleTip(const Consensus::Params &consensusParams)\n+{\n+    if (connman == nullptr) return;\n+\n+    int64_t time_in_seconds = GetTime();\n+    LOCK(cs_main);\n+\n+    // Check whether we have too many outbound peers\n+    int extra_peers = connman->GetExtraOutboundCount();\n+    if (extra_peers > 0) {\n+        // If we have more outbound peers than we target, disconnect one.\n+        // Pick the outbound peer that least recently announced\n+        // us a new block, with ties broken by choosing the more recent\n+        // connection (higher node id)\n+        NodeId worst_peer = -1;\n+        int64_t oldest_block_announcement = time_in_seconds;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11560#discussion_r146967629",
      "id" : 146967629,
      "original_commit_id" : "a64bbc03ddaae5bd55c82f60223a6c29a08b0a20",
      "original_position" : 65,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 71990058,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11560",
      "updated_at" : "2017-10-26T20:10:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146967629",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11560#discussion_r146969139"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146969139"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "c44d6bd98216b07044e467787a5c2e91c635ad82",
      "created_at" : "2017-10-25T19:56:28Z",
      "diff_hunk" : "@@ -2928,10 +2940,61 @@ void PeerLogicValidation::ConsiderEviction(CNode *pto, int64_t time_in_seconds)\n     }\n }\n \n+void PeerLogicValidation::CheckForStaleTip(const Consensus::Params &consensusParams)\n+{\n+    if (connman == nullptr) return;\n+\n+    int64_t time_in_seconds = GetTime();\n+    LOCK(cs_main);\n+\n+    // Check whether we have too many outbound peers\n+    int extra_peers = connman->GetExtraOutboundCount();\n+    if (extra_peers > 0) {\n+        // If we have more outbound peers than we target, disconnect one.\n+        // Pick the outbound peer that least recently announced\n+        // us a new block, with ties broken by choosing the more recent\n+        // connection (higher node id)\n+        NodeId worst_peer = -1;\n+        int64_t oldest_block_announcement = time_in_seconds;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11560#discussion_r146969139",
      "id" : 146969139,
      "in_reply_to_id" : 146967629,
      "original_commit_id" : "a64bbc03ddaae5bd55c82f60223a6c29a08b0a20",
      "original_position" : 65,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 71991866,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11560",
      "updated_at" : "2017-10-26T20:10:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/146969139",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Remind me how the scheduler works... when blocks are slow is this going to result in all hosts on the network triggering their extra peer at basically the same time?  Or do we not need to insert a bit of randomness in order to spread them out over the checking interval?",
      "created_at" : "2017-10-26T01:17:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11560#issuecomment-339520793",
      "id" : 339520793,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11560",
      "updated_at" : "2017-10-26T01:17:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/339520793",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Regarding the scheduler, I mentioned this on IRC to @gmaxwell:\r\n> gmaxwell: my understanding of the scheduler is that it'll start scheduling callbacks at some point after startup, so i wouldn't expect the network to be completely synced\r\n> gmaxwell: also there's random drift, since the scheduler schedules the next callback N milliseconds after the prior one finishes \r\n> but worth discussing whether the interval is short enough that there still might be too much concentration of everyone trying to find a new peer\r\n\r\nI updated this PR with a unit test.",
      "created_at" : "2017-10-26T15:58:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11560#issuecomment-339714002",
      "id" : 339714002,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11560",
      "updated_at" : "2017-10-26T15:58:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/339714002",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Needed rebase after #11490.",
      "created_at" : "2017-10-26T20:11:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11560#issuecomment-339786560",
      "id" : 339786560,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11560",
      "updated_at" : "2017-10-26T20:11:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/339786560",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11560#discussion_r147284900"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/147284900"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "You may want to note the (IMO) critical part of the cpp comment:\r\n\"Also exclude peers that haven't finished initial connection handshake yet\" ie \"this may return a value less than the number of outbound connections - the number of normal outbound connection slots in cases where some outbound connections are not yet fully connected\".",
      "commit_id" : "c44d6bd98216b07044e467787a5c2e91c635ad82",
      "created_at" : "2017-10-26T22:30:12Z",
      "diff_hunk" : "@@ -251,6 +253,16 @@ class CConnman\n     void GetBanned(banmap_t &banmap);\n     void SetBanned(const banmap_t &banmap);\n \n+    // This allows temporarily exceeding nMaxOutbound, with the goal of finding\n+    // a peer that is better than all our current peers.\n+    void SetTryNewOutboundPeer(bool flag);\n+    bool GetTryNewOutboundPeer();\n+\n+    // Return the number of outbound peers we have in excess of our target (eg,\n+    // if we previously called SetTryNewOutboundPeer(true), and have since set\n+    // to false, we may have extra peers that we wish to disconnect).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11560#discussion_r147284900",
      "id" : 147284900,
      "original_commit_id" : "89412654c65a95b3da286ffce2c0b535f5b54b96",
      "original_position" : 27,
      "path" : "src/net.h",
      "position" : 27,
      "pull_request_review_id" : 72360655,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11560",
      "updated_at" : "2017-10-26T22:56:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/147284900",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11560#discussion_r147288662"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11560"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/147288662"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm confused - it looks like we wont ever have both a feeler and an extra outbound open at one time, why change this?",
      "commit_id" : "c44d6bd98216b07044e467787a5c2e91c635ad82",
      "created_at" : "2017-10-26T22:55:36Z",
      "diff_hunk" : "@@ -1068,7 +1068,7 @@ void CConnman::AcceptConnection(const ListenSocket& hListenSocket) {\n     SOCKET hSocket = accept(hListenSocket.socket, (struct sockaddr*)&sockaddr, &len);\n     CAddress addr;\n     int nInbound = 0;\n-    int nMaxInbound = nMaxConnections - (nMaxOutbound + nMaxFeeler);\n+    int nMaxInbound = nMaxConnections - (nMaxOutbound + nMaxFeeler + nMaxExtraOutbound);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11560#discussion_r147288662",
      "id" : 147288662,
      "original_commit_id" : "89412654c65a95b3da286ffce2c0b535f5b54b96",
      "original_position" : 5,
      "path" : "src/net.cpp",
      "position" : 5,
      "pull_request_review_id" : 72360655,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11560",
      "updated_at" : "2017-10-26T22:56:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/147288662",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   }
]
