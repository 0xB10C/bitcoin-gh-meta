[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "~Looks like I need to still need to~:\r\n\r\n- [x] update the outbound_message tracepoint\r\n- [x] update docs",
      "created_at" : "2021-12-18T01:35:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23809#issuecomment-997119755",
      "id" : 997119755,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23809",
      "node_id" : "IC_kwDOABII5847btcL",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/997119755/reactions"
      },
      "updated_at" : "2021-12-18T02:02:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/997119755",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/45598?v=4",
         "events_url" : "https://api.github.com/users/jb55/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jb55/followers",
         "following_url" : "https://api.github.com/users/jb55/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jb55/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jb55",
         "id" : 45598,
         "login" : "jb55",
         "node_id" : "MDQ6VXNlcjQ1NTk4",
         "organizations_url" : "https://api.github.com/users/jb55/orgs",
         "received_events_url" : "https://api.github.com/users/jb55/received_events",
         "repos_url" : "https://api.github.com/users/jb55/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jb55/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jb55/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jb55"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "cc @laanwj @0xB10C ",
      "created_at" : "2021-12-18T02:53:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23809#issuecomment-997130789",
      "id" : 997130789,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23809",
      "node_id" : "IC_kwDOABII5847bwIl",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/997130789/reactions"
      },
      "updated_at" : "2021-12-18T02:53:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/997130789",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept and tested ACK (modulo :x:). This is a important step for #23724.\r\n\r\nOne possible problem I see with this is that some tracing script will get confused when we remove and then add a new connection type: e.g. the enum with the value 5 has a new meaning. Tracepoint documentation would be outdated too.\r\n\r\n- checked (with gdb) that the net:{in,out}bound_message tracepoints now execute only a few instructions: :heavy_check_mark: \r\n- checked that the order of connection_types in `contrib/tracing/net_common.py` matches [0]: :heavy_check_mark: \r\n- checked that the order of connection_types in the tracepoint documentation `doc/tracing.md` matches [0]: :heavy_check_mark: \r\n- tested `contrib/tracing/log_raw_p2p_msgs.py`: :heavy_check_mark:\r\n- tested `contrib/tracing/p2p_monitor.py`: :heavy_check_mark: \r\n- tested `contrib/tracing/log_p2p_traffic.bt`: :x:\r\n  - tries to read argument 2 as string `$peer_type = str(arg2);` (two occurrences)\r\n  - see [1] for a inelegant patch that solves this\r\n\r\n[0] https://github.com/bitcoin/bitcoin/blob/98a2ddcd6ed01a38cd0dad7c1abc7023a60d3fd0/src/net.h#L120\r\n[1] I didn't find any other way of doing this in bpftrace. Would be nice if the if-else could at least be extracted into a function..\r\n``` patch\r\ndiff --git a/contrib/tracing/log_p2p_traffic.bt b/contrib/tracing/log_p2p_traffic.bt\r\nindex f62956aa5..f038ae1b2 100755\r\n--- a/contrib/tracing/log_p2p_traffic.bt\r\n+++ b/contrib/tracing/log_p2p_traffic.bt\r\n@@ -9,20 +9,51 @@ usdt:./src/bitcoind:net:inbound_message\r\n {\r\n   $peer_id = (int64) arg0;\r\n   $peer_addr = str(arg1);\r\n-  $peer_type = str(arg2);\r\n+  $peer_type = (int32) arg2;\r\n   $msg_type = str(arg3);\r\n   $msg_len = arg4;\r\n-  printf(\"inbound '%s' msg from peer %d (%s, %s) with %d bytes\\n\", $msg_type, $peer_id, $peer_type, $peer_addr, $msg_len);\r\n+\r\n+  $peer_type_str = \"unknown\";\r\n+  if ($peer_type == 0) {\r\n+    $peer_type_str = \"inbound\";\r\n+  } else if ($peer_type == 1) {\r\n+    $peer_type_str = \"outbound-full-relay\";\r\n+  } else if ($peer_type == 2) {\r\n+    $peer_type_str = \"manual\";\r\n+  } else if ($peer_type == 3) {\r\n+    $peer_type_str = \"feeler\";\r\n+  } else if ($peer_type == 4) {\r\n+    $peer_type_str = \"block-relay\";\r\n+  } else if ($peer_type == 5) {\r\n+    $peer_type_str = \"addr-fetch\";\r\n+  }\r\n+\r\n+  printf(\"inbound '%s' msg from peer %d (%s, %s) with %d bytes\\n\", $msg_type, $peer_id, $peer_type_str, $peer_addr, $msg_len);\r\n }\r\n\r\n usdt:./src/bitcoind:net:outbound_message\r\n {\r\n   $peer_id = (int64) arg0;\r\n   $peer_addr = str(arg1);\r\n-  $peer_type = str(arg2);\r\n+  $peer_type = (int32) arg2;\r\n   $msg_type = str(arg3);\r\n   $msg_len = arg4;\r\n\r\n-  printf(\"outbound '%s' msg to peer %d (%s, %s) with %d bytes\\n\", $msg_type, $peer_id, $peer_type, $peer_addr, $msg_len);\r\n+  $peer_type_str = \"unknown\";\r\n+  if ($peer_type == 0) {\r\n+    $peer_type_str = \"inbound\";\r\n+  } else if ($peer_type == 1) {\r\n+    $peer_type_str = \"outbound-full-relay\";\r\n+  } else if ($peer_type == 2) {\r\n+    $peer_type_str = \"manual\";\r\n+  } else if ($peer_type == 3) {\r\n+    $peer_type_str = \"feeler\";\r\n+  } else if ($peer_type == 4) {\r\n+    $peer_type_str = \"block-relay\";\r\n+  } else if ($peer_type == 5) {\r\n+    $peer_type_str = \"addr-fetch\";\r\n+  }\r\n+\r\n+  printf(\"outbound '%s' msg to peer %d (%s, %s) with %d bytes\\n\", $msg_type, $peer_id, $peer_type_str, $peer_addr, $msg_len);\r\n }\r\n```",
      "created_at" : "2021-12-18T13:24:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23809#issuecomment-997202354",
      "id" : 997202354,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23809",
      "node_id" : "IC_kwDOABII5847cBmy",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/997202354/reactions"
      },
      "updated_at" : "2021-12-18T13:24:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/997202354",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19157360?v=4",
         "events_url" : "https://api.github.com/users/0xB10C/events{/privacy}",
         "followers_url" : "https://api.github.com/users/0xB10C/followers",
         "following_url" : "https://api.github.com/users/0xB10C/following{/other_user}",
         "gists_url" : "https://api.github.com/users/0xB10C/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/0xB10C",
         "id" : 19157360,
         "login" : "0xB10C",
         "node_id" : "MDQ6VXNlcjE5MTU3MzYw",
         "organizations_url" : "https://api.github.com/users/0xB10C/orgs",
         "received_events_url" : "https://api.github.com/users/0xB10C/received_events",
         "repos_url" : "https://api.github.com/users/0xB10C/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/0xB10C/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/0xB10C/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/0xB10C"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Should probably also change the example tracepoint in `doc/tracing.md`\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/ca7a12479a9aae6ff20de355cc28dcd2f71a74cb/doc/tracing.md?plain=1#L193",
      "created_at" : "2021-12-18T14:32:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23809#issuecomment-997210656",
      "id" : 997210656,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23809",
      "node_id" : "IC_kwDOABII5847cDog",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/997210656/reactions"
      },
      "updated_at" : "2021-12-18T14:32:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/997210656",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19157360?v=4",
         "events_url" : "https://api.github.com/users/0xB10C/events{/privacy}",
         "followers_url" : "https://api.github.com/users/0xB10C/followers",
         "following_url" : "https://api.github.com/users/0xB10C/following{/other_user}",
         "gists_url" : "https://api.github.com/users/0xB10C/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/0xB10C",
         "id" : 19157360,
         "login" : "0xB10C",
         "node_id" : "MDQ6VXNlcjE5MTU3MzYw",
         "organizations_url" : "https://api.github.com/users/0xB10C/orgs",
         "received_events_url" : "https://api.github.com/users/0xB10C/received_events",
         "repos_url" : "https://api.github.com/users/0xB10C/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/0xB10C/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/0xB10C/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/0xB10C"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "On Sat, Dec 18, 2021 at 06:32:22AM -0800, 0xB10C wrote:\n>Should probably also change the example tracepoint in `doc/tracing.md`\n>\n>https://github.com/bitcoin/bitcoin/blob/ca7a12479a9aae6ff20de355cc28dcd2f71a74cb/doc/tracing.md?plain=1#L193\n\ngood catch\n",
      "created_at" : "2021-12-18T18:58:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23809#issuecomment-997269489",
      "id" : 997269489,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23809",
      "node_id" : "IC_kwDOABII5847cR_x",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/997269489/reactions"
      },
      "updated_at" : "2021-12-18T18:58:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/997269489",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/45598?v=4",
         "events_url" : "https://api.github.com/users/jb55/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jb55/followers",
         "following_url" : "https://api.github.com/users/jb55/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jb55/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jb55",
         "id" : 45598,
         "login" : "jb55",
         "node_id" : "MDQ6VXNlcjQ1NTk4",
         "organizations_url" : "https://api.github.com/users/jb55/orgs",
         "received_events_url" : "https://api.github.com/users/jb55/received_events",
         "repos_url" : "https://api.github.com/users/jb55/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jb55/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jb55/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jb55"
      }
   }
]
