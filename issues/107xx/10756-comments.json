[
   {
      "body" : "Super mega concept ACK.  FWIW, I tested something functionally like this before (eliminating the signals with a direct function call) and saw a measurable performance improvement, I assume because there is synchronization inside the signals stuff (plus a super deep call stack).",
      "created_at" : "2017-07-09T11:35:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10756#issuecomment-313914683",
      "id" : 313914683,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10756",
      "updated_at" : "2017-07-09T11:36:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/313914683",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "This is awesome. Lots of future work to do, but good first step. Will circle back around post-15.",
      "created_at" : "2017-07-10T00:22:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10756#issuecomment-313975394",
      "id" : 313975394,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10756",
      "updated_at" : "2017-07-10T00:22:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/313975394",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "@gmaxwell \r\n\r\n> tested something functionally like this before (eliminating the signals with a direct function call) and saw a measurable performance improvement\r\n\r\nHow did you test that? It'd be good to benchmark whether this gives us a performance improvement.",
      "created_at" : "2017-07-10T13:59:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10756#issuecomment-314113978",
      "id" : 314113978,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10756",
      "updated_at" : "2017-07-10T13:59:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/314113978",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10756#discussion_r126431076"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10756"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/126431076"
         }
      },
      "body" : "Nit: move `Receive messages` comment into the if block (the block covers both receiving and sending messages. Having the comment outside the block suggests it's just for receiving messages)",
      "commit_id" : "f785e8479a8ffca6c89d71f9dd6f1c1b455c2671",
      "created_at" : "2017-07-10T14:07:10Z",
      "diff_hunk" : "@@ -1996,15 +1996,16 @@ void CConnman::ThreadMessageHandler()\n                 continue;\n \n             // Receive messages",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10756#discussion_r126431076",
      "id" : 126431076,
      "original_commit_id" : "f785e8479a8ffca6c89d71f9dd6f1c1b455c2671",
      "original_position" : 36,
      "path" : "src/net.cpp",
      "position" : 36,
      "pull_request_review_id" : 48913621,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10756",
      "updated_at" : "2017-07-10T14:26:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/126431076",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10756#discussion_r126432093"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10756"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/126432093"
         }
      },
      "body" : "Change comment to `Interface for message handling`",
      "commit_id" : "f785e8479a8ffca6c89d71f9dd6f1c1b455c2671",
      "created_at" : "2017-07-10T14:11:03Z",
      "diff_hunk" : "@@ -422,18 +423,18 @@ struct CombinerAll\n };\n \n // Signals for message handling",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10756#discussion_r126432093",
      "id" : 126432093,
      "original_commit_id" : "f785e8479a8ffca6c89d71f9dd6f1c1b455c2671",
      "original_position" : 36,
      "path" : "src/net.h",
      "position" : 36,
      "pull_request_review_id" : 48913621,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10756",
      "updated_at" : "2017-07-10T14:26:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/126432093",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10756#discussion_r126434185"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10756"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/126434185"
         }
      },
      "body" : "remove this line. connman is no longer a param for this function.",
      "commit_id" : "f785e8479a8ffca6c89d71f9dd6f1c1b455c2671",
      "created_at" : "2017-07-10T14:18:43Z",
      "diff_hunk" : "@@ -22,22 +22,32 @@ static const unsigned int DEFAULT_BLOCK_RECONSTRUCTION_EXTRA_TXN = 100;\n static constexpr int64_t HEADERS_DOWNLOAD_TIMEOUT_BASE = 15 * 60 * 1000000; // 15 minutes\n static constexpr int64_t HEADERS_DOWNLOAD_TIMEOUT_PER_HEADER = 1000; // 1ms/header\n \n-/** Register with a network node to receive its signals */\n-void RegisterNodeSignals(CNodeSignals& nodeSignals);\n-/** Unregister a network node */\n-void UnregisterNodeSignals(CNodeSignals& nodeSignals);\n-\n-class PeerLogicValidation : public CValidationInterface {\n+class PeerLogicValidation : public CValidationInterface, public NetEventsInterface {\n private:\n     CConnman* connman;\n \n public:\n-    PeerLogicValidation(CConnman* connmanIn);\n+    PeerLogicValidation(CConnman* connman);\n \n     void BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex* pindexConnected, const std::vector<CTransactionRef>& vtxConflicted) override;\n     void UpdatedBlockTip(const CBlockIndex *pindexNew, const CBlockIndex *pindexFork, bool fInitialDownload) override;\n     void BlockChecked(const CBlock& block, const CValidationState& state) override;\n     void NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock) override;\n+\n+\n+    void InitializeNode(CNode* pnode) override;\n+    void FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTime) override;\n+    /** Process protocol messages received from a given node */\n+    bool ProcessMessages(CNode* pfrom, std::atomic<bool>& interrupt) override;\n+    /**\n+    * Send queued protocol messages to be sent to a give node.\n+    *\n+    * @param[in]   pto             The node which we are sending messages to.\n+    * @param[in]   connman         The connection manager for that node.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10756#discussion_r126434185",
      "id" : 126434185,
      "original_commit_id" : "f785e8479a8ffca6c89d71f9dd6f1c1b455c2671",
      "original_position" : 32,
      "path" : "src/net_processing.h",
      "position" : 32,
      "pull_request_review_id" : 48913621,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10756",
      "updated_at" : "2017-07-10T14:26:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/126434185",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1063656?v=3",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "body" : "Remembering @gmaxwell's mention of it before, I was hoping to see a slight speedup here, but I haven't been able to observe anything substantial either. No test varies more than 1% from any other.\r\n\r\n@jnewbery my test was to do a sync to block 150000 between two localhost nodes running from ramdisk datadirs. I believe that focuses on the hot-spot well enough.",
      "created_at" : "2017-07-11T00:19:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10756#issuecomment-314286460",
      "id" : 314286460,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10756",
      "updated_at" : "2017-07-11T00:19:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/314286460",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "Needed rebase after #10179, so I went ahead and squashed it down too.",
      "created_at" : "2017-07-11T16:37:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10756#issuecomment-314501830",
      "id" : 314501830,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10756",
      "updated_at" : "2017-07-11T16:37:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/314501830",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   }
]
