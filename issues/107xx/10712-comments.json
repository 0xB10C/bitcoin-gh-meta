[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10712#discussion_r125092666"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10712"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/125092666"
         }
      },
      "body" : "please move first explanation a few lines before for the \"increase change\" to appropriate spot",
      "commit_id" : "93197a7cab1a2ee38f8ce41df573ba53d09d82ea",
      "created_at" : "2017-06-30T17:42:38Z",
      "diff_hunk" : "@@ -2744,8 +2751,18 @@ bool CWallet::CreateTransaction(const std::vector<CRecipient>& vecSend, CWalletT\n                     // TODO: The case where nSubtractFeeFromAmount > 0 remains\n                     // to be addressed because it requires returning the fee to\n                     // the payees and not the change output.\n-                    // TODO: The case where there is no change output remains\n-                    // to be addressed so we avoid creating too small an output.\n+                    CAmount max_excess_fee = GetMinimumFee(change_prototype_size, currentConfirmationTarget, ::mempool, ::feeEstimator, nullptr) +\n+                        GetDustThreshold(change_prototype_txout, ::dustRelayFee);\n+                    // If we have no change and a big enough excess fee, then",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10712#discussion_r125092666",
      "id" : 125092666,
      "original_commit_id" : "93197a7cab1a2ee38f8ce41df573ba53d09d82ea",
      "original_position" : 46,
      "path" : "src/wallet/wallet.cpp",
      "position" : 127,
      "pull_request_review_id" : 47453075,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10712",
      "updated_at" : "2017-06-30T18:19:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/125092666",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10712#discussion_r125094011"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10712"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/125094011"
         }
      },
      "body" : "nit: slightly longer explanation for reader?\r\n\r\n\"This shouldn't happen, we should have had enough excess fee to pay for the newly created change output.\"\r\n\r\nWith fix on the nFeeRet, a very slight increase in fee between estimation calls(can that happen?) will result in this triggering.",
      "commit_id" : "93197a7cab1a2ee38f8ce41df573ba53d09d82ea",
      "created_at" : "2017-06-30T17:48:51Z",
      "diff_hunk" : "@@ -2754,6 +2771,11 @@ bool CWallet::CreateTransaction(const std::vector<CRecipient>& vecSend, CWalletT\n                     }\n                     break; // Done, enough fee included.\n                 }\n+                else if (!pick_new_inputs) {\n+                    // This shouldn't happen",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10712#discussion_r125094011",
      "id" : 125094011,
      "original_commit_id" : "93197a7cab1a2ee38f8ce41df573ba53d09d82ea",
      "original_position" : 64,
      "path" : "src/wallet/wallet.cpp",
      "position" : 145,
      "pull_request_review_id" : 47453075,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10712",
      "updated_at" : "2017-06-30T18:19:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/125094011",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10712#discussion_r125094446"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10712"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/125094446"
         }
      },
      "body" : "looks like a capital \"K\" snuck in here.",
      "commit_id" : "93197a7cab1a2ee38f8ce41df573ba53d09d82ea",
      "created_at" : "2017-06-30T17:51:02Z",
      "diff_hunk" : "@@ -2774,6 +2773,8 @@ bool CWallet::CreateTransaction(const std::vector<CRecipient>& vecSend, CWalletT\n             }\n         }\n \n+        if (nChangePosInOut == -1) reserveKey.ReturnKey(); // Return any reserved key if we don't have change",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10712#discussion_r125094446",
      "id" : 125094446,
      "original_commit_id" : "252837b04a9dd14e66c6fcc1268aae6505d7c17a",
      "original_position" : 97,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 47453075,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10712",
      "updated_at" : "2017-06-30T18:19:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/125094446",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10712#discussion_r125097059"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10712"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/125097059"
         }
      },
      "body" : "this needs to be `nFeeRet = nFeeNeeded + GetMinimumFee(change_prototype_size, currentConfirmationTarget, ::mempool, ::feeEstimator, nullptr) ;` at a minimum, right?\r\n\r\nnFeeNeeded at this point will not pay for the new change output.",
      "commit_id" : "93197a7cab1a2ee38f8ce41df573ba53d09d82ea",
      "created_at" : "2017-06-30T18:02:09Z",
      "diff_hunk" : "@@ -2744,8 +2751,18 @@ bool CWallet::CreateTransaction(const std::vector<CRecipient>& vecSend, CWalletT\n                     // TODO: The case where nSubtractFeeFromAmount > 0 remains\n                     // to be addressed because it requires returning the fee to\n                     // the payees and not the change output.\n-                    // TODO: The case where there is no change output remains\n-                    // to be addressed so we avoid creating too small an output.\n+                    CAmount max_excess_fee = GetMinimumFee(change_prototype_size, currentConfirmationTarget, ::mempool, ::feeEstimator, nullptr) +\n+                        GetDustThreshold(change_prototype_txout, ::dustRelayFee);\n+                    // If we have no change and a big enough excess fee, then\n+                    // try to construct transaction again only without picking\n+                    // new inputs. We now know we only need the smaller fee\n+                    // (because of reduced tx size) and so we should add a\n+                    // change input. Only try this once.\n+                    if (nFeeRet > nFeeNeeded + max_excess_fee && nChangePosInOut == -1 && nSubtractFeeFromAmount == 0 && pick_new_inputs) {\n+                        pick_new_inputs = false;\n+                        nFeeRet = nFeeNeeded;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10712#discussion_r125097059",
      "id" : 125097059,
      "original_commit_id" : "93197a7cab1a2ee38f8ce41df573ba53d09d82ea",
      "original_position" : 53,
      "path" : "src/wallet/wallet.cpp",
      "position" : 134,
      "pull_request_review_id" : 47453075,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10712",
      "updated_at" : "2017-06-30T18:19:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/125097059",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   }
]
