[
   {
      "body" : "This isn't really needed is it? If a node is already sending \"getheaders\" then presumably a node can assume it prefers headers rather than invs, perhaps?",
      "created_at" : "2015-07-30T20:55:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6494#issuecomment-126483990",
      "id" : 126483990,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6494",
      "updated_at" : "2015-07-30T20:55:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/126483990",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "body" : "@rebroad  Sorry, I just realized I should have emphasized more clearly that this PR also includes code to enable direct-fetching of blocks based on headers messages.  Without that change, nodes that received a headers message would otherwise wait to download blocks through the existing parallel fetch mechanism, which would generally make headers-announcement inferior to inv-announcements (because we have direct-fetch code in the inv-processing logic, which means we'd be quicker to request a new block).\r\n\r\nConsequently I think it makes sense for nodes to somehow opt-in to the new behavior.  0.10 and 0.11 nodes should continue to receive inv's even after this code is merged.\r\n\r\nOne thing that wasn't clear to me was whether it's really necessary to do the protocol version bump in order to deploy the new p2p message, given that the new message is backwards compatible -- nodes are free to ignore it.  However I'm not sure I have a good grasp of how the protocol versions should be thought about.\r\n",
      "created_at" : "2015-07-31T00:28:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6494#issuecomment-126529816",
      "id" : 126529816,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6494",
      "updated_at" : "2015-07-31T00:28:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/126529816",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "@sdaftuar Why not use the existing parallel fetch mechanism? I don't see any advantage in fetching the block outside of that.",
      "created_at" : "2015-07-31T11:35:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6494#issuecomment-126661302",
      "id" : 126661302,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6494",
      "updated_at" : "2015-07-31T11:35:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/126661302",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "body" : "The existing parallel fetch mechanism has a delay and an extra roundtrip,\nbecause it first needs to ask for headers before it can start fetching any\nblock.\n\nSending all headers immediately when announcing the block avoids that\nround-trip, potentially improving propagation speed significantly over\nhigh-latency links.\n",
      "created_at" : "2015-07-31T12:37:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6494#issuecomment-126677054",
      "id" : 126677054,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6494",
      "updated_at" : "2015-07-31T12:37:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/126677054",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Fixed @casey's nits",
      "created_at" : "2015-08-03T17:44:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6494#issuecomment-127344879",
      "id" : 127344879,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6494",
      "updated_at" : "2015-08-03T17:44:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/127344879",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "Rebased.",
      "created_at" : "2015-09-09T17:09:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6494#issuecomment-138978021",
      "id" : 138978021,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6494",
      "updated_at" : "2015-09-09T17:09:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/138978021",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "I'm planning to send the draft BIP out to the mailing list for comments, but before I do so, does anyone here have any guidance about whether it is necessary to bump the protocol version to introduce the new ```sendheaders``` p2p message?  It is safe to ignore the message, but I'm not sure if its generally considered helpful to change the protocol version when adding even an optional message...",
      "created_at" : "2015-09-24T15:38:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6494#issuecomment-142966413",
      "id" : 142966413,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6494",
      "updated_at" : "2015-09-24T15:38:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/142966413",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "I think it's helpful to bump the protocol version in this case. Although it's only an optional hint, it may provide more clarity (eg when documenting) and help troubleshooting.",
      "created_at" : "2015-09-24T15:58:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6494#issuecomment-142972322",
      "id" : 142972322,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6494",
      "updated_at" : "2015-09-24T15:58:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/142972322",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "How is the BIP for this coming along? Need any help?",
      "created_at" : "2015-10-06T09:52:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6494#issuecomment-145803573",
      "id" : 145803573,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6494",
      "updated_at" : "2015-10-06T09:52:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/145803573",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "@theuni suggested some alternate ideas to the \"sendheaders\" p2p message: either extend the version message to include a bool that indicates the preference to receive headers announcements, or even just allocate a service bit that indicates that preference.\r\n\r\nBetween those 3 options I don't feel strongly about the best way to deploy -- and in particular I can understand why it might not be great to go with adding a new p2p message that causes node state/behavior to change.  @theuni mentioned he might respond on-list with his alternate suggestions; any thoughts here on those ideas?",
      "created_at" : "2015-10-06T14:34:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6494#issuecomment-145875499",
      "id" : 145875499,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6494",
      "updated_at" : "2015-10-06T14:34:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/145875499",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "@sdaftuar @theuni Extending \"version\" continuously isn't a very scalable approach, and requires pretty strong consensus to do, as the order of entries matters. I don't really understand why we kept doing that for so long.\r\n\r\nA service bit has the same \"synchronization\" problem, but does have the extra advantage of making the property searchable.",
      "created_at" : "2015-10-06T14:42:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6494#issuecomment-145878356",
      "id" : 145878356,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6494",
      "updated_at" : "2015-10-06T14:42:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/145878356",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "I don't think it's important that the property is searchable.  For me I'd ask should this be its own message, or should we define a \"flags\" message, for sending more, non-searchable capabilities.",
      "created_at" : "2015-10-06T16:25:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6494#issuecomment-145918734",
      "id" : 145918734,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6494",
      "updated_at" : "2015-10-06T16:25:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/145918734",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "@sipa @gmaxwell My preference for not sending a new messages comes from an event-driven implementor's POV. If a remote nodes are allowed to switch preferences mid-stream, it can greatly (and needlessly) complicate the local node's sending logic.\r\n\r\nThe easy way to avoid that is to disallow changing the preference _back_ once set (this seems to be the case in @sdaftuar's BIP). Taking that a step further, it also makes sense to only accept the message early in the connection process, say directly after version/verack, and before any inv. And if that's the case, it may as well just be considered as part of the handshake.\r\n\r\nEssentially, I would much prefer to avoid making life-of-the-connection properties stateful unless necessary. Extending the version message makes sense to me, but I understand @sipa's objection there. \r\n\r\n@gmaxwell's suggestion seems reasonable, assuming that the \"flags\" message had the requirement of being sent directly after version/verack. Absence of the message would actively (though perhaps unknowingly) communicate the desire for default flags (historic behavior). Again, this just seems like an extension of the version message to me, but if changes there are deemed problematic, this would be my preference.",
      "created_at" : "2015-10-08T02:16:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6494#issuecomment-146395507",
      "id" : 146395507,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6494",
      "updated_at" : "2015-10-08T02:16:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/146395507",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "Rebased.",
      "created_at" : "2015-10-16T18:27:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6494#issuecomment-148794761",
      "id" : 148794761,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6494",
      "updated_at" : "2015-10-16T18:27:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/148794761",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "This significantly speeds up new block propagation in the normal, build-on-the-best-chain case.\r\n\r\nBenchmark numbers from a 5-node, 4-network-hop test network I created that relays empty blocks from massachusetts to los angeles and back, twice (round-trip latency of 100 msec):\r\n\r\nBefore:  1,300 msec latency from first block-creating node sending an 'inv' to last node in the chain receiving the 'block' message\r\n\r\nWith this pull:  670 msec\r\n\r\nSo concept ACK: I haven't reviewed the code yet, and have no opinion on bumping protocol version versus new message.\r\n",
      "created_at" : "2015-10-21T19:34:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6494#issuecomment-150002489",
      "id" : 150002489,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6494",
      "updated_at" : "2015-10-21T19:35:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/150002489",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "body" : "@gavinandresen Any chance you could repeat your test with the code in #6867?  (This change is great, and we should do it, but I expect that almost all of the improvement in that benchmark will be from setting TCP_NODELAY.)",
      "created_at" : "2015-10-21T23:56:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6494#issuecomment-150057108",
      "id" : 150057108,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6494",
      "updated_at" : "2015-10-21T23:56:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/150057108",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "Yes, I'll re-run tomorrow when I'm back in my office.\n\n--\nGavin Andresen\n\n\n> On Oct 21, 2015, at 7:56 PM, Gregory Maxwell <notifications@github.com> wrote:\n> \n> @gavinandresen Any chance you could repeat your test with the code in #6867? (This change is great, and we should do it, but I expect that almost all of the improvement in that benchmark will be from setting TCP_NODELAY.)\n> \n> Ã¢ÂÂ\n> Reply to this email directly or view it on GitHub.\n> \n",
      "created_at" : "2015-10-22T00:18:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6494#issuecomment-150061027",
      "id" : 150061027,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6494",
      "updated_at" : "2015-10-22T00:18:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/150061027",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "body" : "I believe this is ready for review; so far it doesn't seem like the BIP (which relates to activation/deployment only) is likely to change substantively from what was originally proposed (see bitcoin/bips#221).  It would be great to get this merged for 0.12 if possible.",
      "created_at" : "2015-10-23T20:46:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6494#issuecomment-150686158",
      "id" : 150686158,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6494",
      "updated_at" : "2015-10-23T20:46:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/150686158",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "> I don't think it's important that the property is searchable. For me I'd ask should this be its own message, or should we define a \"flags\" message, for sending more, non-searchable capabilities.\r\n\r\nLate to the party, but I prefer the way how it is implemented now - to have a separate message for requesting this feature - to a generic 'flags' message, as well as to adding a version bit.\r\n\r\nRationale: If centralization bottlenecks can be avoided (\"another set of flags to allocate\"), that's strongly preferable.\r\n\r\nutACK, intend to test.\r\n\r\n",
      "created_at" : "2015-11-13T12:22:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6494#issuecomment-156417477",
      "id" : 156417477,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6494",
      "updated_at" : "2015-11-13T13:20:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/156417477",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6494#discussion_r44799570"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6494"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/44799570"
         }
      },
      "body" : "Can't this result in duplicate in-flights? The fact that it's not yet our tip does not imply we're not downloading it yet.\r\n\r\nEDIT: nevermind, those aren't added to vToFetch.",
      "commit_id" : "6af4c915a484b69ebd86e51328a54006f3e7812d",
      "created_at" : "2015-11-13T16:10:59Z",
      "diff_hunk" : "@@ -4439,6 +4527,28 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n             pfrom->PushMessage(\"getheaders\", chainActive.GetLocator(pindexLast), uint256());\n         }\n \n+        CNodeState *nodestate = State(pfrom->GetId());\n+        // If this set of headers is valid and ends in a block with more work",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6494#discussion_r44799570",
      "id" : 44799570,
      "original_commit_id" : "83602363a391633f0fdb9a836c5d40e94ec8db98",
      "original_position" : 243,
      "path" : "src/main.cpp",
      "position" : 244,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6494",
      "updated_at" : "2015-11-13T18:24:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/44799570",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6494#discussion_r44800419"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6494"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/44800419"
         }
      },
      "body" : "Do we still want to inv in this case?",
      "commit_id" : "6af4c915a484b69ebd86e51328a54006f3e7812d",
      "created_at" : "2015-11-13T16:17:20Z",
      "diff_hunk" : "@@ -4970,6 +5080,92 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n         }\n \n         //\n+        // Try sending block announcements via headers\n+        //\n+        {\n+            // If we have less than MAX_BLOCKS_TO_ANNOUNCE in our\n+            // list of block hashes we're relaying, and our peer wants\n+            // headers announcements, then find the first header\n+            // not yet known to our peer but would connect, and send.\n+            // If no header would connect, or if we have too many\n+            // blocks, or if the peer doesn't want headers, just\n+            // add all to the inv queue.\n+            LOCK(pto->cs_inventory);\n+            vector<CBlock> vHeaders;\n+            bool fRevertToInv = (!state.fPreferHeaders || pto->vBlockHashesToAnnounce.size() > MAX_BLOCKS_TO_ANNOUNCE);\n+            CBlockIndex *pBestIndex = NULL; // last header queued for delivery\n+            ProcessBlockAvailability(pto->id); // ensure pindexBestKnownBlock is up-to-date\n+\n+            if (!fRevertToInv) {\n+                bool fFoundStartingHeader = false;\n+                // Try to find first header that our peer doesn't have, and\n+                // then send all headers past that one.  If we come across any\n+                // headers that aren't on chainActive, give up.\n+                BOOST_FOREACH(const uint256 &hash, pto->vBlockHashesToAnnounce) {\n+                    BlockMap::iterator mi = mapBlockIndex.find(hash);\n+                    assert(mi != mapBlockIndex.end());\n+                    CBlockIndex *pindex = mi->second;\n+                    if (chainActive[pindex->nHeight] != pindex) {\n+                        // Bail out if we reorged away from this block",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6494#discussion_r44800419",
      "id" : 44800419,
      "original_commit_id" : "83602363a391633f0fdb9a836c5d40e94ec8db98",
      "original_position" : 297,
      "path" : "src/main.cpp",
      "position" : 298,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6494",
      "updated_at" : "2015-11-13T18:24:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/44800419",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Concept ACK. Thorough code review ACK with one small nit. Lightly tested (two peers with this pull succesfully relay blocks across the internet, verified with -debug=net).",
      "created_at" : "2015-11-13T16:22:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6494#issuecomment-156478436",
      "id" : 156478436,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6494",
      "updated_at" : "2015-11-13T16:22:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/156478436",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Needs rebase.",
      "created_at" : "2015-11-13T16:25:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6494#issuecomment-156479219",
      "id" : 156479219,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6494",
      "updated_at" : "2015-11-13T16:25:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/156479219",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6494#discussion_r44812615"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6494"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/44812615"
         }
      },
      "body" : "It's possible (probable?) that the last entry in vBlockHashesToAnnounce is our current tip (so we do want to inv it), but it is also possible that it hasn't made it there yet, and that last entry is some old tip that has now been reorged out.\r\n\r\nI think it would be safe to add a check below to only inv the last item if it's an ancestor of our current tip; does that sound right?  ",
      "commit_id" : "6af4c915a484b69ebd86e51328a54006f3e7812d",
      "created_at" : "2015-11-13T17:58:21Z",
      "diff_hunk" : "@@ -4970,6 +5080,92 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n         }\n \n         //\n+        // Try sending block announcements via headers\n+        //\n+        {\n+            // If we have less than MAX_BLOCKS_TO_ANNOUNCE in our\n+            // list of block hashes we're relaying, and our peer wants\n+            // headers announcements, then find the first header\n+            // not yet known to our peer but would connect, and send.\n+            // If no header would connect, or if we have too many\n+            // blocks, or if the peer doesn't want headers, just\n+            // add all to the inv queue.\n+            LOCK(pto->cs_inventory);\n+            vector<CBlock> vHeaders;\n+            bool fRevertToInv = (!state.fPreferHeaders || pto->vBlockHashesToAnnounce.size() > MAX_BLOCKS_TO_ANNOUNCE);\n+            CBlockIndex *pBestIndex = NULL; // last header queued for delivery\n+            ProcessBlockAvailability(pto->id); // ensure pindexBestKnownBlock is up-to-date\n+\n+            if (!fRevertToInv) {\n+                bool fFoundStartingHeader = false;\n+                // Try to find first header that our peer doesn't have, and\n+                // then send all headers past that one.  If we come across any\n+                // headers that aren't on chainActive, give up.\n+                BOOST_FOREACH(const uint256 &hash, pto->vBlockHashesToAnnounce) {\n+                    BlockMap::iterator mi = mapBlockIndex.find(hash);\n+                    assert(mi != mapBlockIndex.end());\n+                    CBlockIndex *pindex = mi->second;\n+                    if (chainActive[pindex->nHeight] != pindex) {\n+                        // Bail out if we reorged away from this block",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6494#discussion_r44812615",
      "id" : 44812615,
      "original_commit_id" : "83602363a391633f0fdb9a836c5d40e94ec8db98",
      "original_position" : 297,
      "path" : "src/main.cpp",
      "position" : 298,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6494",
      "updated_at" : "2015-11-13T18:24:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/44812615",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6494#discussion_r44813816"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6494"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/44813816"
         }
      },
      "body" : "I think it's harmless, as the current code in this PR mimicks the old behaviour. But if we're doing the check anyway, I think we can skip the entry.",
      "commit_id" : "6af4c915a484b69ebd86e51328a54006f3e7812d",
      "created_at" : "2015-11-13T18:09:19Z",
      "diff_hunk" : "@@ -4970,6 +5080,92 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n         }\n \n         //\n+        // Try sending block announcements via headers\n+        //\n+        {\n+            // If we have less than MAX_BLOCKS_TO_ANNOUNCE in our\n+            // list of block hashes we're relaying, and our peer wants\n+            // headers announcements, then find the first header\n+            // not yet known to our peer but would connect, and send.\n+            // If no header would connect, or if we have too many\n+            // blocks, or if the peer doesn't want headers, just\n+            // add all to the inv queue.\n+            LOCK(pto->cs_inventory);\n+            vector<CBlock> vHeaders;\n+            bool fRevertToInv = (!state.fPreferHeaders || pto->vBlockHashesToAnnounce.size() > MAX_BLOCKS_TO_ANNOUNCE);\n+            CBlockIndex *pBestIndex = NULL; // last header queued for delivery\n+            ProcessBlockAvailability(pto->id); // ensure pindexBestKnownBlock is up-to-date\n+\n+            if (!fRevertToInv) {\n+                bool fFoundStartingHeader = false;\n+                // Try to find first header that our peer doesn't have, and\n+                // then send all headers past that one.  If we come across any\n+                // headers that aren't on chainActive, give up.\n+                BOOST_FOREACH(const uint256 &hash, pto->vBlockHashesToAnnounce) {\n+                    BlockMap::iterator mi = mapBlockIndex.find(hash);\n+                    assert(mi != mapBlockIndex.end());\n+                    CBlockIndex *pindex = mi->second;\n+                    if (chainActive[pindex->nHeight] != pindex) {\n+                        // Bail out if we reorged away from this block",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6494#discussion_r44813816",
      "id" : 44813816,
      "original_commit_id" : "83602363a391633f0fdb9a836c5d40e94ec8db98",
      "original_position" : 297,
      "path" : "src/main.cpp",
      "position" : 298,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6494",
      "updated_at" : "2015-11-13T18:24:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/44813816",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6494#discussion_r44814050"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6494"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/44814050"
         }
      },
      "body" : "I think the code to address this edge case is easy to write, but I believe this situation is so rare that it might be better to not add this code that we can't really test?  (At least I can't figure out how I'd test it...)\r\n\r\nI think it might be better to just add a `LogPrint(\"net\", ...)` debug message in the event that we're sending an inv for a block that is not on the main chain, rather than change network behavior.  The downside to sending an extra inv in what we think is a rare situation is quite small, whereas if there's a bug in this code somehow and it overly suppresses inv's that could be both problematic and difficult to track down.",
      "commit_id" : "6af4c915a484b69ebd86e51328a54006f3e7812d",
      "created_at" : "2015-11-13T18:11:46Z",
      "diff_hunk" : "@@ -4970,6 +5080,92 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n         }\n \n         //\n+        // Try sending block announcements via headers\n+        //\n+        {\n+            // If we have less than MAX_BLOCKS_TO_ANNOUNCE in our\n+            // list of block hashes we're relaying, and our peer wants\n+            // headers announcements, then find the first header\n+            // not yet known to our peer but would connect, and send.\n+            // If no header would connect, or if we have too many\n+            // blocks, or if the peer doesn't want headers, just\n+            // add all to the inv queue.\n+            LOCK(pto->cs_inventory);\n+            vector<CBlock> vHeaders;\n+            bool fRevertToInv = (!state.fPreferHeaders || pto->vBlockHashesToAnnounce.size() > MAX_BLOCKS_TO_ANNOUNCE);\n+            CBlockIndex *pBestIndex = NULL; // last header queued for delivery\n+            ProcessBlockAvailability(pto->id); // ensure pindexBestKnownBlock is up-to-date\n+\n+            if (!fRevertToInv) {\n+                bool fFoundStartingHeader = false;\n+                // Try to find first header that our peer doesn't have, and\n+                // then send all headers past that one.  If we come across any\n+                // headers that aren't on chainActive, give up.\n+                BOOST_FOREACH(const uint256 &hash, pto->vBlockHashesToAnnounce) {\n+                    BlockMap::iterator mi = mapBlockIndex.find(hash);\n+                    assert(mi != mapBlockIndex.end());\n+                    CBlockIndex *pindex = mi->second;\n+                    if (chainActive[pindex->nHeight] != pindex) {\n+                        // Bail out if we reorged away from this block",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6494#discussion_r44814050",
      "id" : 44814050,
      "original_commit_id" : "83602363a391633f0fdb9a836c5d40e94ec8db98",
      "original_position" : 297,
      "path" : "src/main.cpp",
      "position" : 298,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6494",
      "updated_at" : "2015-11-13T18:24:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/44814050",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6494#discussion_r44814190"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6494"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/44814190"
         }
      },
      "body" : "Fair enough. It won't hurt.",
      "commit_id" : "6af4c915a484b69ebd86e51328a54006f3e7812d",
      "created_at" : "2015-11-13T18:13:10Z",
      "diff_hunk" : "@@ -4970,6 +5080,92 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n         }\n \n         //\n+        // Try sending block announcements via headers\n+        //\n+        {\n+            // If we have less than MAX_BLOCKS_TO_ANNOUNCE in our\n+            // list of block hashes we're relaying, and our peer wants\n+            // headers announcements, then find the first header\n+            // not yet known to our peer but would connect, and send.\n+            // If no header would connect, or if we have too many\n+            // blocks, or if the peer doesn't want headers, just\n+            // add all to the inv queue.\n+            LOCK(pto->cs_inventory);\n+            vector<CBlock> vHeaders;\n+            bool fRevertToInv = (!state.fPreferHeaders || pto->vBlockHashesToAnnounce.size() > MAX_BLOCKS_TO_ANNOUNCE);\n+            CBlockIndex *pBestIndex = NULL; // last header queued for delivery\n+            ProcessBlockAvailability(pto->id); // ensure pindexBestKnownBlock is up-to-date\n+\n+            if (!fRevertToInv) {\n+                bool fFoundStartingHeader = false;\n+                // Try to find first header that our peer doesn't have, and\n+                // then send all headers past that one.  If we come across any\n+                // headers that aren't on chainActive, give up.\n+                BOOST_FOREACH(const uint256 &hash, pto->vBlockHashesToAnnounce) {\n+                    BlockMap::iterator mi = mapBlockIndex.find(hash);\n+                    assert(mi != mapBlockIndex.end());\n+                    CBlockIndex *pindex = mi->second;\n+                    if (chainActive[pindex->nHeight] != pindex) {\n+                        // Bail out if we reorged away from this block",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6494#discussion_r44814190",
      "id" : 44814190,
      "original_commit_id" : "83602363a391633f0fdb9a836c5d40e94ec8db98",
      "original_position" : 297,
      "path" : "src/main.cpp",
      "position" : 298,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6494",
      "updated_at" : "2015-11-13T18:24:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/44814190",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Rebased and added log message when trying to announce a stale block.",
      "created_at" : "2015-11-13T18:25:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6494#issuecomment-156509115",
      "id" : 156509115,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6494",
      "updated_at" : "2015-11-13T18:25:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/156509115",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "I'm looking into an issue @morcos noticed this afternoon; it seems problematic to update pindexBestKnownBlock from a locator received with a getheaders message, because that would imply we can download such blocks from our peer. Yet our peer can generate locators from headers they have rather than from blocks they have.\n\nI am testing just removing that block of code; will update this PR once I confirm that is safe.",
      "created_at" : "2015-11-16T22:03:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6494#issuecomment-157185700",
      "id" : 157185700,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6494",
      "updated_at" : "2015-11-16T22:03:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/157185700",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   }
]
