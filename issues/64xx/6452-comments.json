[
   {
      "body" : "Untested ACK. I was thinking about implementing something like this myself while working on the mempool limitation.\r\n\r\nGiven the false positive rate and the amount of memory usage, I think this approach is better than #6450.",
      "created_at" : "2015-07-17T18:30:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6452#issuecomment-122366525",
      "id" : 122366525,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6452",
      "updated_at" : "2015-07-17T18:30:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/122366525",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "\r\nIf I've done the math right, I think it would only take about a million rejects to push the false positive rate on this near 98%.  At 1000 txn/sec, this is somewhere on the order of 20 minutes.  It only takes a few hundred thousand to push it into low, yet still problematic double digit false positive territory.\r\n\r\nI also don't fully understand the comment in the code that claims this uses 1.7MB.  I calculated the filter size myself using the parameters from the code and I get about 430k each, for around 960k total.\r\n\r\nIt's worth noting that the attack surface here involves filling up the bloom filter and causing a high false positive rate which can blind nodes to incoming transactions.  If a bloom filter is used here, I think it needs to be larger.  (Maybe that was the intention?)\r\n\r\nThoughts?\r\n\r\n",
      "created_at" : "2015-07-17T20:48:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6452#issuecomment-122410352",
      "id" : 122410352,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6452",
      "updated_at" : "2015-07-17T20:48:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/122410352",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/430315?v=3",
         "events_url" : "https://api.github.com/users/ajweiss/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajweiss/followers",
         "following_url" : "https://api.github.com/users/ajweiss/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajweiss/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajweiss",
         "id" : 430315,
         "login" : "ajweiss",
         "organizations_url" : "https://api.github.com/users/ajweiss/orgs",
         "received_events_url" : "https://api.github.com/users/ajweiss/received_events",
         "repos_url" : "https://api.github.com/users/ajweiss/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajweiss/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajweiss/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajweiss"
      }
   },
   {
      "body" : "Ahh, I see nevermind.  I didn't catch that the rolling stuff allocates filters at 2x size, and rotates them when they're half full making the fprate never go above the specified value (1e-6).  \r\n\r\nThe sizes add up now too...\r\n\r\nLooks good.",
      "created_at" : "2015-07-17T21:03:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6452#issuecomment-122415126",
      "id" : 122415126,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6452",
      "updated_at" : "2015-07-17T21:03:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/122415126",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/430315?v=3",
         "events_url" : "https://api.github.com/users/ajweiss/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajweiss/followers",
         "following_url" : "https://api.github.com/users/ajweiss/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajweiss/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajweiss",
         "id" : 430315,
         "login" : "ajweiss",
         "organizations_url" : "https://api.github.com/users/ajweiss/orgs",
         "received_events_url" : "https://api.github.com/users/ajweiss/received_events",
         "repos_url" : "https://api.github.com/users/ajweiss/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajweiss/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajweiss/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajweiss"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6452#discussion_r34945357"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6452"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/34945357"
         }
      },
      "body" : "Not sure if this should be insecure_rand. insecure_rand is meant for high-performance low-security use. \r\n- No performance constraints: this is done once, at initialization time\r\n- If this value could be guessed by an adversary, there is additional DoS risk. \r\n- Also, the spread between nodes should be as uniform as possible to make sure that if false positives happen, they are at least as non-consistent as possible.\r\nSo IMO let's use the normal GetRand.\r\n\r\nWhat I am also slightly worried about here is the static global initialization. Random generators will not have been initialized at that time.",
      "commit_id" : "f6eaca7c65e8e21c8a06d4c82aaea2a3d3443ef8",
      "created_at" : "2015-07-18T07:18:12Z",
      "diff_hunk" : "@@ -154,6 +154,29 @@ namespace {\n      */\n     map<uint256, NodeId> mapBlockSource;\n \n+    /**\n+     * Filter for transactions that were recently rejected by\n+     * AcceptToMemoryPool. These are not rerequested until the chain tip\n+     * changes, at which point the entire filter is cleared. Protected by\n+     * cs_main.\n+     *\n+     * Without this filter we'd be re-requesting txs from each of our peers,\n+     * increasing bandwidth consumption considerably. For instance, with 100\n+     * peers, half of which relay a tx we don't accept, that might be a 50x\n+     * bandwidth increase. A flooding attacker attempting to roll-over the\n+     * filter using minimum-sized, 60byte, transactions might manage to send\n+     * 1000/sec if we have fast peers, so we pick 120,000 to give our peers a\n+     * two minute window to send invs to us.\n+     *\n+     * Decreasing the false positive rate is fairly cheap, so we pick one in a\n+     * million to make it highly unlikely for users to have issues with this\n+     * filter.\n+     *\n+     * Memory used: 1.7MB\n+     */\n+    CRollingBloomFilter recentRejects(120000, 0.000001, insecure_rand());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6452#discussion_r34945357",
      "id" : 34945357,
      "original_commit_id" : "5250f5fbcbf9b79ee1816624d9439b3b86b70f4e",
      "original_position" : 24,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6452",
      "updated_at" : "2015-07-18T07:44:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/34945357",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "utACK apart from randomness nit.",
      "created_at" : "2015-07-18T07:19:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6452#issuecomment-122507976",
      "id" : 122507976,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6452",
      "updated_at" : "2015-07-18T07:19:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/122507976",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6452#discussion_r34945564"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6452"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/34945564"
         }
      },
      "body" : "Changed to GetRand()\r\n\r\nThe other CRollingBloom filter use is in net.cpp, which also uses insecure_rand() - might be worth it to fix that too.\r\n\r\nRe: static global initialization, it'd be possible to change the seed here every time the bloom filter is cleared; dunno what's the best way to actually do that in C++ though.",
      "commit_id" : "f6eaca7c65e8e21c8a06d4c82aaea2a3d3443ef8",
      "created_at" : "2015-07-18T07:46:58Z",
      "diff_hunk" : "@@ -154,6 +154,29 @@ namespace {\n      */\n     map<uint256, NodeId> mapBlockSource;\n \n+    /**\n+     * Filter for transactions that were recently rejected by\n+     * AcceptToMemoryPool. These are not rerequested until the chain tip\n+     * changes, at which point the entire filter is cleared. Protected by\n+     * cs_main.\n+     *\n+     * Without this filter we'd be re-requesting txs from each of our peers,\n+     * increasing bandwidth consumption considerably. For instance, with 100\n+     * peers, half of which relay a tx we don't accept, that might be a 50x\n+     * bandwidth increase. A flooding attacker attempting to roll-over the\n+     * filter using minimum-sized, 60byte, transactions might manage to send\n+     * 1000/sec if we have fast peers, so we pick 120,000 to give our peers a\n+     * two minute window to send invs to us.\n+     *\n+     * Decreasing the false positive rate is fairly cheap, so we pick one in a\n+     * million to make it highly unlikely for users to have issues with this\n+     * filter.\n+     *\n+     * Memory used: 1.7MB\n+     */\n+    CRollingBloomFilter recentRejects(120000, 0.000001, insecure_rand());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6452#discussion_r34945564",
      "id" : 34945564,
      "original_commit_id" : "5250f5fbcbf9b79ee1816624d9439b3b86b70f4e",
      "original_position" : 24,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6452",
      "updated_at" : "2015-07-18T07:46:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/34945564",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6452#discussion_r34945638"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6452"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/34945638"
         }
      },
      "body" : "GetRand() relies on openssl being initialized, so something very bad could happen if things are executed in the wrong order.\r\nThus I'd prefer an explicit initialization. Possibly make recentRejects a pointer and explicitly allocate/deallocate it.\r\nSetting a new tweak every time the filter is cleared may be overkill, I don't know.\r\nAgree re: net.cpp, although that structure is per-peer so there's not as much scope for monkey tricks.",
      "commit_id" : "f6eaca7c65e8e21c8a06d4c82aaea2a3d3443ef8",
      "created_at" : "2015-07-18T07:59:17Z",
      "diff_hunk" : "@@ -154,6 +154,29 @@ namespace {\n      */\n     map<uint256, NodeId> mapBlockSource;\n \n+    /**\n+     * Filter for transactions that were recently rejected by\n+     * AcceptToMemoryPool. These are not rerequested until the chain tip\n+     * changes, at which point the entire filter is cleared. Protected by\n+     * cs_main.\n+     *\n+     * Without this filter we'd be re-requesting txs from each of our peers,\n+     * increasing bandwidth consumption considerably. For instance, with 100\n+     * peers, half of which relay a tx we don't accept, that might be a 50x\n+     * bandwidth increase. A flooding attacker attempting to roll-over the\n+     * filter using minimum-sized, 60byte, transactions might manage to send\n+     * 1000/sec if we have fast peers, so we pick 120,000 to give our peers a\n+     * two minute window to send invs to us.\n+     *\n+     * Decreasing the false positive rate is fairly cheap, so we pick one in a\n+     * million to make it highly unlikely for users to have issues with this\n+     * filter.\n+     *\n+     * Memory used: 1.7MB\n+     */\n+    CRollingBloomFilter recentRejects(120000, 0.000001, insecure_rand());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6452#discussion_r34945638",
      "id" : 34945638,
      "original_commit_id" : "5250f5fbcbf9b79ee1816624d9439b3b86b70f4e",
      "original_position" : 24,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6452",
      "updated_at" : "2015-07-18T07:59:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/34945638",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6452#discussion_r34945720"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6452"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/34945720"
         }
      },
      "body" : "At what point can we actually guarantee OpenSSL is initialized? Remember that the capcity of the filter has to be pretty large - 120,000 transactions - so it could take a long time before it gets rolled over if a bad initialization is an issue.\r\n\r\nRegardless of how it gets initialized, only 1/1,000,000 txs will be affected. Sure an attacker might be able to pick-and-choose that subset, but I can't think of any example other than zeroconf crap where that actually matters.",
      "commit_id" : "f6eaca7c65e8e21c8a06d4c82aaea2a3d3443ef8",
      "created_at" : "2015-07-18T08:12:33Z",
      "diff_hunk" : "@@ -154,6 +154,29 @@ namespace {\n      */\n     map<uint256, NodeId> mapBlockSource;\n \n+    /**\n+     * Filter for transactions that were recently rejected by\n+     * AcceptToMemoryPool. These are not rerequested until the chain tip\n+     * changes, at which point the entire filter is cleared. Protected by\n+     * cs_main.\n+     *\n+     * Without this filter we'd be re-requesting txs from each of our peers,\n+     * increasing bandwidth consumption considerably. For instance, with 100\n+     * peers, half of which relay a tx we don't accept, that might be a 50x\n+     * bandwidth increase. A flooding attacker attempting to roll-over the\n+     * filter using minimum-sized, 60byte, transactions might manage to send\n+     * 1000/sec if we have fast peers, so we pick 120,000 to give our peers a\n+     * two minute window to send invs to us.\n+     *\n+     * Decreasing the false positive rate is fairly cheap, so we pick one in a\n+     * million to make it highly unlikely for users to have issues with this\n+     * filter.\n+     *\n+     * Memory used: 1.7MB\n+     */\n+    CRollingBloomFilter recentRejects(120000, 0.000001, insecure_rand());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6452#discussion_r34945720",
      "id" : 34945720,
      "original_commit_id" : "5250f5fbcbf9b79ee1816624d9439b3b86b70f4e",
      "original_position" : 24,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6452",
      "updated_at" : "2015-07-18T08:12:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/34945720",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   }
]
