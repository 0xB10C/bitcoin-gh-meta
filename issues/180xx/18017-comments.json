[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK. Will need to play around with it a little bit to test that clang actually prevents compiling incorrect uses.",
      "created_at" : "2020-01-29T05:04:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18017#issuecomment-579594113",
      "id" : 579594113,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18017",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3OTU5NDExMw==",
      "updated_at" : "2020-01-29T05:04:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/579594113",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #17786 (refactor: Nuke policy/fees->mempool circular dependencies by hebasto)\n* #10443 (Add fee_est tool for debugging fee estimation code by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-01-29T09:20:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18017#issuecomment-579666481",
      "id" : 579666481,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18017",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3OTY2NjQ4MQ==",
      "updated_at" : "2020-04-23T11:38:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/579666481",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK, nice",
      "created_at" : "2020-02-10T16:21:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18017#issuecomment-584205068",
      "id" : 584205068,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18017",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NDIwNTA2OA==",
      "updated_at" : "2020-02-10T16:21:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/584205068",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2020-03-04T06:09:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18017#issuecomment-594345306",
      "id" : 594345306,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18017",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5NDM0NTMwNg==",
      "updated_at" : "2020-03-04T06:09:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/594345306",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.",
      "created_at" : "2020-05-24T08:12:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18017#issuecomment-633196020",
      "id" : 633196020,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18017",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMzE5NjAyMA==",
      "updated_at" : "2020-05-24T08:12:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/633196020",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r429613083"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429613083"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Mind switching from the member initialization list to the default member initializers?",
      "commit_id" : "837d4e4f5aeb2f110143c59b7dd05eac6ae52b63",
      "created_at" : "2020-05-24T08:37:48Z",
      "diff_hunk" : "@@ -50,6 +50,68 @@ struct LockPoints\n     LockPoints() : height(0), time(0), maxInputBlock(nullptr) { }\n };\n \n+/** Epoch: RAII-style guard for using epoch-based graph traversal algorithms.\n+ *     When walking ancestors or descendants, we generally want to avoid\n+ * visiting the same transactions twice. Some traversal algorithms use\n+ * std::set (or setEntries) to deduplicate the transaction we visit.\n+ * However, use of std::set is algorithmically undesirable because it both\n+ * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+ * more dynamic memory allocations.\n+ *     In many algorithms we can replace std::set with an internal mempool\n+ * counter to track the time (or, \"epoch\") that we began a traversal, and\n+ * check + update a per-transaction epoch for each transaction we look at to\n+ * determine if that transaction has not yet been visited during the current\n+ * traversal's epoch.\n+ *     Algorithms using std::set can be replaced on a one by one basis.\n+ * Both techniques are not fundamentally incompatible across the codebase.\n+ * Generally speaking, however, the remaining use of std::set for mempool\n+ * traversal should be viewed as a TODO for replacement with an epoch based\n+ * traversal, rather than a preference for std::set over epochs in that\n+ * algorithm.\n+ */\n+\n+class Epoch\n+{\n+private:\n+    uint64_t m_raw_epoch;\n+    bool m_guarded;\n+\n+public:\n+    Epoch() : m_raw_epoch{0}, m_guarded{false} { }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r429613083",
      "id" : 429613083,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTYxMzA4Mw==",
      "original_commit_id" : "7485e0f9db4455212e930ba68c26daa972956faf",
      "original_line" : 80,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : null,
      "pull_request_review_id" : 417338366,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-26T12:05:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429613083",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r429613209"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429613209"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Mind switching from the member initialization list to the default member initializer?",
      "commit_id" : "837d4e4f5aeb2f110143c59b7dd05eac6ae52b63",
      "created_at" : "2020-05-24T08:39:33Z",
      "diff_hunk" : "@@ -50,6 +50,68 @@ struct LockPoints\n     LockPoints() : height(0), time(0), maxInputBlock(nullptr) { }\n };\n \n+/** Epoch: RAII-style guard for using epoch-based graph traversal algorithms.\n+ *     When walking ancestors or descendants, we generally want to avoid\n+ * visiting the same transactions twice. Some traversal algorithms use\n+ * std::set (or setEntries) to deduplicate the transaction we visit.\n+ * However, use of std::set is algorithmically undesirable because it both\n+ * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+ * more dynamic memory allocations.\n+ *     In many algorithms we can replace std::set with an internal mempool\n+ * counter to track the time (or, \"epoch\") that we began a traversal, and\n+ * check + update a per-transaction epoch for each transaction we look at to\n+ * determine if that transaction has not yet been visited during the current\n+ * traversal's epoch.\n+ *     Algorithms using std::set can be replaced on a one by one basis.\n+ * Both techniques are not fundamentally incompatible across the codebase.\n+ * Generally speaking, however, the remaining use of std::set for mempool\n+ * traversal should be viewed as a TODO for replacement with an epoch based\n+ * traversal, rather than a preference for std::set over epochs in that\n+ * algorithm.\n+ */\n+\n+class Epoch\n+{\n+private:\n+    uint64_t m_raw_epoch;\n+    bool m_guarded;\n+\n+public:\n+    Epoch() : m_raw_epoch{0}, m_guarded{false} { }\n+\n+    Epoch(const Epoch&) = delete; // no copy constructor\n+    Epoch& operator=(const Epoch&) = delete; // not assignable\n+\n+    bool guarded() const { return m_guarded; }\n+\n+    class Marker {\n+    private:\n+        uint64_t m_marker;\n+\n+    public:\n+        Marker() : m_marker{0} { }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r429613209",
      "id" : 429613209,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTYxMzIwOQ==",
      "original_commit_id" : "7485e0f9db4455212e930ba68c26daa972956faf",
      "original_line" : 92,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : null,
      "pull_request_review_id" : 417338366,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-26T12:05:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429613209",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r429621402"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429621402"
         }
      },
      "author_association" : "MEMBER",
      "body" : "micro-nit: These comments are so obvious that seem redundant :)",
      "commit_id" : "837d4e4f5aeb2f110143c59b7dd05eac6ae52b63",
      "created_at" : "2020-05-24T10:23:22Z",
      "diff_hunk" : "@@ -50,6 +50,68 @@ struct LockPoints\n     LockPoints() : height(0), time(0), maxInputBlock(nullptr) { }\n };\n \n+/** Epoch: RAII-style guard for using epoch-based graph traversal algorithms.\n+ *     When walking ancestors or descendants, we generally want to avoid\n+ * visiting the same transactions twice. Some traversal algorithms use\n+ * std::set (or setEntries) to deduplicate the transaction we visit.\n+ * However, use of std::set is algorithmically undesirable because it both\n+ * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+ * more dynamic memory allocations.\n+ *     In many algorithms we can replace std::set with an internal mempool\n+ * counter to track the time (or, \"epoch\") that we began a traversal, and\n+ * check + update a per-transaction epoch for each transaction we look at to\n+ * determine if that transaction has not yet been visited during the current\n+ * traversal's epoch.\n+ *     Algorithms using std::set can be replaced on a one by one basis.\n+ * Both techniques are not fundamentally incompatible across the codebase.\n+ * Generally speaking, however, the remaining use of std::set for mempool\n+ * traversal should be viewed as a TODO for replacement with an epoch based\n+ * traversal, rather than a preference for std::set over epochs in that\n+ * algorithm.\n+ */\n+\n+class Epoch\n+{\n+private:\n+    uint64_t m_raw_epoch;\n+    bool m_guarded;\n+\n+public:\n+    Epoch() : m_raw_epoch{0}, m_guarded{false} { }\n+\n+    Epoch(const Epoch&) = delete; // no copy constructor\n+    Epoch& operator=(const Epoch&) = delete; // not assignable",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r429621402",
      "id" : 429621402,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTYyMTQwMg==",
      "original_commit_id" : "7485e0f9db4455212e930ba68c26daa972956faf",
      "original_line" : 83,
      "original_position" : 34,
      "original_start_line" : 82,
      "path" : "src/txmempool.h",
      "position" : null,
      "pull_request_review_id" : 417338366,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-05-26T12:05:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429621402",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r429627015"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429627015"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Tested on top of the #18635, and had loads of warnings:\r\n```\r\n./txmempool.h:102:38: warning: 'exclusive_lock_function' attribute requires arguments whose type is annotated with 'capability' attribute; type here is 'Epoch' [-Wthread-safety-attributes]\r\n        explicit Guard(Epoch& epoch) EXCLUSIVE_LOCK_FUNCTION(epoch) LOCKS_EXCLUDED(epoch);\r\n                                     ^\r\n...\r\n./txmempool.h:106:40: warning: 'exclusive_locks_required' attribute requires arguments whose type is annotated with 'capability' attribute; type here is 'const Epoch' [-Wthread-safety-attributes]\r\n    bool visited(Marker& marker) const EXCLUSIVE_LOCKS_REQUIRED(*this) {\r\n                                       ^\r\n...\r\n./txmempool.h:691:121: warning: 'locks_excluded' attribute requires arguments whose type is annotated with 'capability' attribute; type here is 'Epoch' [-Wthread-safety-attributes]\r\n    void UpdateTransactionsFromBlock(const std::vector<uint256>& vHashesToUpdate) EXCLUSIVE_LOCKS_REQUIRED(cs, cs_main) LOCKS_EXCLUDED(m_epoch);\r\n                                                                                                                        ^\r\n...\r\n./txmempool.h:812:41: warning: 'exclusive_locks_required' attribute requires arguments whose type is annotated with 'capability' attribute; type here is 'Epoch' [-Wthread-safety-attributes]\r\n    bool visited(const txiter it) const EXCLUSIVE_LOCKS_REQUIRED(cs, m_epoch) {\r\n                                        ^\r\n...\r\n./txmempool.h:816:45: warning: 'exclusive_locks_required' attribute requires arguments whose type is annotated with 'capability' attribute; type here is 'Epoch' [-Wthread-safety-attributes]\r\n    bool visited(Optional<txiter> it) const EXCLUSIVE_LOCKS_REQUIRED(cs, m_epoch) {\r\n                                            ^\r\n```\r\n\r\nTo make the Clang Thread Safety Analysis work as expected I suggest: \r\n```suggestion\r\nclass LOCKABLE Epoch\r\n```\r\n\r\n_and_ change the type of the `Epoch::Guard::m_epoch` from `Epoch&` to `Epoch*`.",
      "commit_id" : "837d4e4f5aeb2f110143c59b7dd05eac6ae52b63",
      "created_at" : "2020-05-24T11:33:51Z",
      "diff_hunk" : "@@ -50,6 +50,68 @@ struct LockPoints\n     LockPoints() : height(0), time(0), maxInputBlock(nullptr) { }\n };\n \n+/** Epoch: RAII-style guard for using epoch-based graph traversal algorithms.\n+ *     When walking ancestors or descendants, we generally want to avoid\n+ * visiting the same transactions twice. Some traversal algorithms use\n+ * std::set (or setEntries) to deduplicate the transaction we visit.\n+ * However, use of std::set is algorithmically undesirable because it both\n+ * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+ * more dynamic memory allocations.\n+ *     In many algorithms we can replace std::set with an internal mempool\n+ * counter to track the time (or, \"epoch\") that we began a traversal, and\n+ * check + update a per-transaction epoch for each transaction we look at to\n+ * determine if that transaction has not yet been visited during the current\n+ * traversal's epoch.\n+ *     Algorithms using std::set can be replaced on a one by one basis.\n+ * Both techniques are not fundamentally incompatible across the codebase.\n+ * Generally speaking, however, the remaining use of std::set for mempool\n+ * traversal should be viewed as a TODO for replacement with an epoch based\n+ * traversal, rather than a preference for std::set over epochs in that\n+ * algorithm.\n+ */\n+\n+class Epoch",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r429627015",
      "id" : 429627015,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTYyNzAxNQ==",
      "original_commit_id" : "7485e0f9db4455212e930ba68c26daa972956faf",
      "original_line" : 73,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : null,
      "pull_request_review_id" : 417338366,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-26T12:05:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429627015",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r429627231"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429627231"
         }
      },
      "author_association" : "MEMBER",
      "body" : "From the Thread Safety Analysis [docs](https://clang.llvm.org/docs/ThreadSafetyAnalysis.html#acquire-acquire-shared-release-release-shared):\r\n> The caller must not hold the given capability on entry\r\n\r\nIt seems `LOCKS_EXCLUDED(epoch)` is redundant, no?",
      "commit_id" : "837d4e4f5aeb2f110143c59b7dd05eac6ae52b63",
      "created_at" : "2020-05-24T11:37:01Z",
      "diff_hunk" : "@@ -50,6 +50,68 @@ struct LockPoints\n     LockPoints() : height(0), time(0), maxInputBlock(nullptr) { }\n };\n \n+/** Epoch: RAII-style guard for using epoch-based graph traversal algorithms.\n+ *     When walking ancestors or descendants, we generally want to avoid\n+ * visiting the same transactions twice. Some traversal algorithms use\n+ * std::set (or setEntries) to deduplicate the transaction we visit.\n+ * However, use of std::set is algorithmically undesirable because it both\n+ * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+ * more dynamic memory allocations.\n+ *     In many algorithms we can replace std::set with an internal mempool\n+ * counter to track the time (or, \"epoch\") that we began a traversal, and\n+ * check + update a per-transaction epoch for each transaction we look at to\n+ * determine if that transaction has not yet been visited during the current\n+ * traversal's epoch.\n+ *     Algorithms using std::set can be replaced on a one by one basis.\n+ * Both techniques are not fundamentally incompatible across the codebase.\n+ * Generally speaking, however, the remaining use of std::set for mempool\n+ * traversal should be viewed as a TODO for replacement with an epoch based\n+ * traversal, rather than a preference for std::set over epochs in that\n+ * algorithm.\n+ */\n+\n+class Epoch\n+{\n+private:\n+    uint64_t m_raw_epoch;\n+    bool m_guarded;\n+\n+public:\n+    Epoch() : m_raw_epoch{0}, m_guarded{false} { }\n+\n+    Epoch(const Epoch&) = delete; // no copy constructor\n+    Epoch& operator=(const Epoch&) = delete; // not assignable\n+\n+    bool guarded() const { return m_guarded; }\n+\n+    class Marker {\n+    private:\n+        uint64_t m_marker;\n+\n+    public:\n+        Marker() : m_marker{0} { }\n+\n+        friend class Epoch;\n+    };\n+\n+    class SCOPED_LOCKABLE Guard {\n+    private:\n+        Epoch& m_epoch;\n+\n+    public:\n+        explicit Guard(Epoch& epoch) EXCLUSIVE_LOCK_FUNCTION(epoch) LOCKS_EXCLUDED(epoch);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r429627231",
      "id" : 429627231,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTYyNzIzMQ==",
      "original_commit_id" : "7485e0f9db4455212e930ba68c26daa972956faf",
      "original_line" : 102,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : null,
      "pull_request_review_id" : 417338366,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-26T12:05:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429627231",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r430353995"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/430353995"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm not seeing what benefit changing `Epoch::Guard::m_epoch` from reference to pointer would have -- the analysis shouldn't (and doesn't) treat them any different, as far as I can see?",
      "commit_id" : "837d4e4f5aeb2f110143c59b7dd05eac6ae52b63",
      "created_at" : "2020-05-26T11:51:32Z",
      "diff_hunk" : "@@ -50,6 +50,68 @@ struct LockPoints\n     LockPoints() : height(0), time(0), maxInputBlock(nullptr) { }\n };\n \n+/** Epoch: RAII-style guard for using epoch-based graph traversal algorithms.\n+ *     When walking ancestors or descendants, we generally want to avoid\n+ * visiting the same transactions twice. Some traversal algorithms use\n+ * std::set (or setEntries) to deduplicate the transaction we visit.\n+ * However, use of std::set is algorithmically undesirable because it both\n+ * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+ * more dynamic memory allocations.\n+ *     In many algorithms we can replace std::set with an internal mempool\n+ * counter to track the time (or, \"epoch\") that we began a traversal, and\n+ * check + update a per-transaction epoch for each transaction we look at to\n+ * determine if that transaction has not yet been visited during the current\n+ * traversal's epoch.\n+ *     Algorithms using std::set can be replaced on a one by one basis.\n+ * Both techniques are not fundamentally incompatible across the codebase.\n+ * Generally speaking, however, the remaining use of std::set for mempool\n+ * traversal should be viewed as a TODO for replacement with an epoch based\n+ * traversal, rather than a preference for std::set over epochs in that\n+ * algorithm.\n+ */\n+\n+class Epoch",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r430353995",
      "id" : 430353995,
      "in_reply_to_id" : 429627015,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDM1Mzk5NQ==",
      "original_commit_id" : "7485e0f9db4455212e930ba68c26daa972956faf",
      "original_line" : 73,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : null,
      "pull_request_review_id" : 418221221,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-26T12:05:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/430353995",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Incorporated @hebasto's suggested changes",
      "created_at" : "2020-05-26T12:07:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18017#issuecomment-633984070",
      "id" : 633984070,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18017",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMzk4NDA3MA==",
      "updated_at" : "2020-05-26T12:07:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/633984070",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r430479806"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/430479806"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Indeed :)\r\nIDK why I saw warnings...",
      "commit_id" : "837d4e4f5aeb2f110143c59b7dd05eac6ae52b63",
      "created_at" : "2020-05-26T14:59:56Z",
      "diff_hunk" : "@@ -50,6 +50,68 @@ struct LockPoints\n     LockPoints() : height(0), time(0), maxInputBlock(nullptr) { }\n };\n \n+/** Epoch: RAII-style guard for using epoch-based graph traversal algorithms.\n+ *     When walking ancestors or descendants, we generally want to avoid\n+ * visiting the same transactions twice. Some traversal algorithms use\n+ * std::set (or setEntries) to deduplicate the transaction we visit.\n+ * However, use of std::set is algorithmically undesirable because it both\n+ * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+ * more dynamic memory allocations.\n+ *     In many algorithms we can replace std::set with an internal mempool\n+ * counter to track the time (or, \"epoch\") that we began a traversal, and\n+ * check + update a per-transaction epoch for each transaction we look at to\n+ * determine if that transaction has not yet been visited during the current\n+ * traversal's epoch.\n+ *     Algorithms using std::set can be replaced on a one by one basis.\n+ * Both techniques are not fundamentally incompatible across the codebase.\n+ * Generally speaking, however, the remaining use of std::set for mempool\n+ * traversal should be viewed as a TODO for replacement with an epoch based\n+ * traversal, rather than a preference for std::set over epochs in that\n+ * algorithm.\n+ */\n+\n+class Epoch",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r430479806",
      "id" : 430479806,
      "in_reply_to_id" : 429627015,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ3OTgwNg==",
      "original_commit_id" : "7485e0f9db4455212e930ba68c26daa972956faf",
      "original_line" : 73,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : null,
      "pull_request_review_id" : 418386811,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-26T14:59:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/430479806",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@hebasto - `AssertLockNotHeld(m_epoch)` won't work -- epochs aren't sync.h locks. I think the annotation for UpdateForDescendents would be better made after #18191 is merged?",
      "created_at" : "2020-05-26T16:30:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18017#issuecomment-634134624",
      "id" : 634134624,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18017",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzNDEzNDYyNA==",
      "updated_at" : "2020-05-26T16:30:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/634134624",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ajtowns \r\n> @hebasto - `AssertLockNotHeld(m_epoch)` won't work -- epochs aren't sync.h locks. I think the annotation for UpdateForDescendents would be better made after #18191 is merged?\r\n\r\nAgree.",
      "created_at" : "2020-05-26T16:36:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18017#issuecomment-634138030",
      "id" : 634138030,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18017",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzNDEzODAzMA==",
      "updated_at" : "2020-05-26T16:36:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/634138030",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   }
]
