[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #17812 (config, net, test: asmap functional tests and feature refinements by jonatack)\n* #17428 (p2p: Try to preserve outbound block-relay-only connections during restart by hebasto)\n* #16883 (WIP: Qt: add QML based mobile GUI by icota)\n* #16367 (Multiprocess build support by ryanofsky)\n* #15112 (build: Optionally enable -Wzero-as-null-pointer-constant by Empact)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-02-05T23:18:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-582659603",
      "id" : 582659603,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MjY1OTYwMw==",
      "updated_at" : "2020-02-11T19:09:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/582659603",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for picking this up again. I hope we manage to do this this time.",
      "created_at" : "2020-02-06T11:22:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-582859339",
      "id" : 582859339,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4Mjg1OTMzOQ==",
      "updated_at" : "2020-02-06T11:22:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/582859339",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r375996088"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/375996088"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This will break building with both NAT-PMP and UPnP support...",
      "commit_id" : "c7e90ca40ad9b7c66f3429b792435e9279ceca6b",
      "created_at" : "2020-02-06T18:06:53Z",
      "diff_hunk" : "@@ -0,0 +1,221 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <arpa/inet.h>\n+#include <netinet/in.h>\n+#endif\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#endif\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif\n+\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_upnp_interrupt;\n+static std::thread g_upnp_thread;\n+\n+#ifdef USE_NATPMP\n+static void ThreadMapPort()\n+{\n+    int r;\n+    natpmp_t natpmp;\n+    natpmpresp_t response;\n+\n+    r = initnatpmp(&natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r < 0) {\n+        LogPrintf(\"NAT-PMP: initnatpmp() failed with %d error.\\n\", r);\n+        closenatpmp(&natpmp);\n+        return;\n+    }\n+\n+    if (fDiscover) {\n+        r = sendpublicaddressrequest(&natpmp);\n+        if (r < 0) {\n+            LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed with %d error.\\n\", r);\n+        } else {\n+            do {\n+                r = readnatpmpresponseorretry(&natpmp, &response);\n+            } while (r == NATPMP_TRYAGAIN);\n+            if (r < 0 || response.type != NATPMP_RESPTYPE_PUBLICADDRESS) {\n+                LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r);\n+            } else {\n+                const char* public_address = inet_ntoa(response.pnu.publicaddress.addr);\n+                if (public_address[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(public_address, resolved, false)) {\n+                        LogPrintf(\"NAT-PMP: public address = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_UPNP);\n+                    }\n+                } else {\n+                    LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed.\\n\");\n+                }\n+            }\n+        }\n+    }\n+\n+    const uint16_t port = GetListenPort();\n+    do {\n+        r = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, port, port, 3600 /*seconds*/);\n+        if (r < 0) {\n+            LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed with %d error.\\n\", r);\n+            break;\n+        }\n+\n+        do {\n+            r = readnatpmpresponseorretry(&natpmp, &response);\n+        } while (r == NATPMP_TRYAGAIN);\n+        if (r < 0 || response.type != NATPMP_RESPTYPE_TCPPORTMAPPING) {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r);\n+        } else {\n+            auto pm = response.pnu.newportmapping;\n+            if (port == pm.privateport && port == pm.mappedpublicport && pm.lifetime > 0) {\n+                LogPrintf(\"NAT-PMP: port mapping successful.\\n\");\n+            } else {\n+                LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed.\\n\");\n+            }\n+        }\n+\n+    } while (g_upnp_interrupt.sleep_for(std::chrono::minutes(20)));\n+\n+    r = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, port, port, /* remove a port mapping */ 0);\n+    if (r < 0) {\n+        LogPrintf(\"NAT-PMP: sendnewportmappingrequest(0) failed with %d error.\\n\", r);\n+    }\n+\n+    closenatpmp(&natpmp);\n+}\n+\n+#else // USE_UPNP",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r375996088",
      "id" : 375996088,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk5NjA4OA==",
      "original_commit_id" : "60e2524c8aa0edf5ce09d842cec09065cb854bcd",
      "original_position" : 119,
      "path" : "src/mapport.cpp",
      "position" : null,
      "pull_request_review_id" : 354660903,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "updated_at" : "2020-02-10T17:18:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/375996088",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r375999662"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/375999662"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> This will break building with both NAT-PMP and UPnP support...\r\n\r\nYes, I'm aware of that. This PR in its current state is intended for NAT-PMP functionality tests and concept (N)ACKs.",
      "commit_id" : "c7e90ca40ad9b7c66f3429b792435e9279ceca6b",
      "created_at" : "2020-02-06T18:14:29Z",
      "diff_hunk" : "@@ -0,0 +1,221 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <arpa/inet.h>\n+#include <netinet/in.h>\n+#endif\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#endif\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif\n+\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_upnp_interrupt;\n+static std::thread g_upnp_thread;\n+\n+#ifdef USE_NATPMP\n+static void ThreadMapPort()\n+{\n+    int r;\n+    natpmp_t natpmp;\n+    natpmpresp_t response;\n+\n+    r = initnatpmp(&natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r < 0) {\n+        LogPrintf(\"NAT-PMP: initnatpmp() failed with %d error.\\n\", r);\n+        closenatpmp(&natpmp);\n+        return;\n+    }\n+\n+    if (fDiscover) {\n+        r = sendpublicaddressrequest(&natpmp);\n+        if (r < 0) {\n+            LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed with %d error.\\n\", r);\n+        } else {\n+            do {\n+                r = readnatpmpresponseorretry(&natpmp, &response);\n+            } while (r == NATPMP_TRYAGAIN);\n+            if (r < 0 || response.type != NATPMP_RESPTYPE_PUBLICADDRESS) {\n+                LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r);\n+            } else {\n+                const char* public_address = inet_ntoa(response.pnu.publicaddress.addr);\n+                if (public_address[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(public_address, resolved, false)) {\n+                        LogPrintf(\"NAT-PMP: public address = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_UPNP);\n+                    }\n+                } else {\n+                    LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed.\\n\");\n+                }\n+            }\n+        }\n+    }\n+\n+    const uint16_t port = GetListenPort();\n+    do {\n+        r = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, port, port, 3600 /*seconds*/);\n+        if (r < 0) {\n+            LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed with %d error.\\n\", r);\n+            break;\n+        }\n+\n+        do {\n+            r = readnatpmpresponseorretry(&natpmp, &response);\n+        } while (r == NATPMP_TRYAGAIN);\n+        if (r < 0 || response.type != NATPMP_RESPTYPE_TCPPORTMAPPING) {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r);\n+        } else {\n+            auto pm = response.pnu.newportmapping;\n+            if (port == pm.privateport && port == pm.mappedpublicport && pm.lifetime > 0) {\n+                LogPrintf(\"NAT-PMP: port mapping successful.\\n\");\n+            } else {\n+                LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed.\\n\");\n+            }\n+        }\n+\n+    } while (g_upnp_interrupt.sleep_for(std::chrono::minutes(20)));\n+\n+    r = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, port, port, /* remove a port mapping */ 0);\n+    if (r < 0) {\n+        LogPrintf(\"NAT-PMP: sendnewportmappingrequest(0) failed with %d error.\\n\", r);\n+    }\n+\n+    closenatpmp(&natpmp);\n+}\n+\n+#else // USE_UPNP",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r375999662",
      "id" : 375999662,
      "in_reply_to_id" : 375996088,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk5OTY2Mg==",
      "original_commit_id" : "60e2524c8aa0edf5ce09d842cec09065cb854bcd",
      "original_position" : 119,
      "path" : "src/mapport.cpp",
      "position" : null,
      "pull_request_review_id" : 354665487,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "updated_at" : "2020-02-10T17:18:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/375999662",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2020-02-06T18:16:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-583039181",
      "id" : 583039181,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MzAzOTE4MQ==",
      "updated_at" : "2020-02-06T18:16:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/583039181",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "It is ready for reviewing now.",
      "created_at" : "2020-02-07T20:53:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-583606396",
      "id" : 583606396,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MzYwNjM5Ng==",
      "updated_at" : "2020-02-07T20:53:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/583606396",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Updated 4ff5349a3172d02fceb976bf4989996c88f86680 -> cf94431e8f4bfd6636998a17e2355feb2c5c3d58 ([pr18077.03](https://github.com/hebasto/bitcoin/commits/pr18077.03) -> [pr18077.04](https://github.com/hebasto/bitcoin/commits/pr18077.04), [compare](https://github.com/hebasto/bitcoin/compare/pr18077.03..pr18077.04)):\r\n\r\nadded `libnatpmp` package to macOS 10.14 native Travis build.",
      "created_at" : "2020-02-07T21:49:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-583630233",
      "id" : 583630233,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MzYzMDIzMw==",
      "updated_at" : "2020-02-07T21:49:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/583630233",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Updated cf94431e8f4bfd6636998a17e2355feb2c5c3d58 -> 88248a44241c8e3922a80729ce4a9a178ef2dbea ([pr18077.04](https://github.com/hebasto/bitcoin/commits/pr18077.04) -> [pr18077.05](https://github.com/hebasto/bitcoin/commits/pr18077.05), [compare](https://github.com/hebasto/bitcoin/compare/pr18077.04..pr18077.05)):\r\n\r\nadded:\r\n- changes to docs\r\n- release notes",
      "created_at" : "2020-02-08T08:17:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-583715048",
      "id" : 583715048,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MzcxNTA0OA==",
      "updated_at" : "2020-02-08T08:17:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/583715048",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2020-02-10T12:03:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-584090512",
      "id" : 584090512,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NDA5MDUxMg==",
      "updated_at" : "2020-02-10T12:03:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/584090512",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased after #17398 and #18081 have been merged.",
      "created_at" : "2020-02-10T17:20:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-584234105",
      "id" : 584234105,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NDIzNDEwNQ==",
      "updated_at" : "2020-02-10T17:20:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/584234105",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK, will test on my home router.",
      "created_at" : "2020-02-10T19:26:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-584307307",
      "id" : 584307307,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NDMwNzMwNw==",
      "updated_at" : "2020-02-10T19:26:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/584307307",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK. Lightly tested configure / build on macOS.\r\n\r\nUnfortunately I'm behind a IPv6 DS-Lite router, I can't test the IPv4 port forward. Perhaps `-7` could be replaced by something more readable.\r\n\r\n```\r\n2020-02-11T17:48:27Z natpmp thread start\r\n2020-02-11T17:48:27Z Bound to [::]:8333\r\n2020-02-11T17:48:27Z Bound to 0.0.0.0:8333\r\n2020-02-11T17:48:27Z init message: Loading P2P addresses...\r\n2020-02-11T17:48:27Z NAT-PMP: readnatpmpresponseorretry() for public address failed with -7 error.\r\n2020-02-11T17:48:27Z NAT-PMP: readnatpmpresponseorretry() for port mapping failed with -7 error. \r\n```\r\n\r\nI looked up the error code, and it's what I would expect given my setup:\r\n```\r\n/* NATPMP_ERR_NOGATEWAYSUPPORT : the gateway does not support NAT-PMP */\r\n#define NATPMP_ERR_NOGATEWAYSUPPORT (-7)\r\n```\r\n\r\nTwo suggesitons for followups, or this PR:\r\n* add checkbox in QT Settings (above UPNP)\r\n* add support for IPv6 pinhole if the library supports it, see #17012 (looks like it doesn't)",
      "created_at" : "2020-02-11T17:57:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-584768149",
      "id" : 584768149,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NDc2ODE0OQ==",
      "updated_at" : "2020-02-11T18:03:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/584768149",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@Sjors \r\n\r\nThank you for your review and testing.\r\n\r\n> I looked up the error code, and it's what I would expect given my setup:\r\n> \r\n> ```\r\n> /* NATPMP_ERR_NOGATEWAYSUPPORT : the gateway does not support NAT-PMP */\r\n> #define NATPMP_ERR_NOGATEWAYSUPPORT (-7)\r\n> ```\r\n\r\nAgree.\r\nBut in this initial PR I intentionally do not provide user-friendly error messages in order to keep `ThreadNatpmp()` dense and tight for easier reviewing ;)\r\n\r\nIn followups every library call (`initnatpmp()`, `sendpublicaddressrequest()` and `sendnewportmappingrequest()`) with the following `readnatpmpresponseorretry()` loops could be refactored out to separate functions with user-friendly error messages.\r\n\r\n> Two suggesitons for followups, or this PR:\r\n> \r\n>     * add checkbox in QT Settings (above UPNP)\r\n\r\nAgree. From the OP:\r\n> Some follow-ups are out of this PR's scope:\r\n> \r\n>     * mention NAT-PMP library in the version message\r\n> \r\n>     * integrate NAT-PMP into the GUI\r\n\r\n",
      "created_at" : "2020-02-11T19:11:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-584801614",
      "id" : 584801614,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18077",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NDgwMTYxNA==",
      "updated_at" : "2020-02-11T19:13:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/584801614",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r378006285"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/378006285"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Won't this overwrite the `g_mapport_thread` set above if both are enabled?",
      "commit_id" : "c7e90ca40ad9b7c66f3429b792435e9279ceca6b",
      "created_at" : "2020-02-12T02:12:13Z",
      "diff_hunk" : "@@ -0,0 +1,236 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <arpa/inet.h>\n+#include <netinet/in.h>\n+#endif // #ifdef WIN32\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif // #ifdef USE_UPNP\n+\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_mapport_interrupt;\n+static std::thread g_mapport_thread;\n+\n+#ifdef USE_NATPMP\n+static void ThreadNatpmp()\n+{\n+    int r;\n+    natpmp_t natpmp;\n+    natpmpresp_t response;\n+\n+    r = initnatpmp(&natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r < 0) {\n+        LogPrintf(\"NAT-PMP: initnatpmp() failed with %d error.\\n\", r);\n+        closenatpmp(&natpmp);\n+        return;\n+    }\n+\n+    if (fDiscover) {\n+        r = sendpublicaddressrequest(&natpmp);\n+        if (r < 0) {\n+            LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed with %d error.\\n\", r);\n+        } else {\n+            do {\n+                r = readnatpmpresponseorretry(&natpmp, &response);\n+            } while (r == NATPMP_TRYAGAIN);\n+            if (r < 0 || response.type != NATPMP_RESPTYPE_PUBLICADDRESS) {\n+                LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r);\n+            } else {\n+                const char* public_address = inet_ntoa(response.pnu.publicaddress.addr);\n+                if (public_address[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(public_address, resolved, false)) {\n+                        LogPrintf(\"NAT-PMP: public address = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed.\\n\");\n+                }\n+            }\n+        }\n+    }\n+\n+    const uint16_t port = GetListenPort();\n+    do {\n+        r = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, port, port, 3600 /*seconds*/);\n+        if (r < 0) {\n+            LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed with %d error.\\n\", r);\n+            break;\n+        }\n+\n+        do {\n+            r = readnatpmpresponseorretry(&natpmp, &response);\n+        } while (r == NATPMP_TRYAGAIN);\n+        if (r < 0 || response.type != NATPMP_RESPTYPE_TCPPORTMAPPING) {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r);\n+        } else {\n+            auto pm = response.pnu.newportmapping;\n+            if (port == pm.privateport && port == pm.mappedpublicport && pm.lifetime > 0) {\n+                LogPrintf(\"NAT-PMP: port mapping successful.\\n\");\n+            } else {\n+                LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed.\\n\");\n+            }\n+        }\n+\n+    } while (g_mapport_interrupt.sleep_for(std::chrono::minutes(20)));\n+\n+    r = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, port, port, /* remove a port mapping */ 0);\n+    if (r < 0) {\n+        LogPrintf(\"NAT-PMP: sendnewportmappingrequest(0) failed with %d error.\\n\", r);\n+    }\n+\n+    closenatpmp(&natpmp);\n+}\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+static void ThreadUpnp()\n+{\n+    std::string port = strprintf(\"%u\", GetListenPort());\n+    const char * multicastif = nullptr;\n+    const char * minissdpdpath = nullptr;\n+    struct UPNPDev * devlist = nullptr;\n+    char lanaddr[64];\n+\n+    int error = 0;\n+#if MINIUPNPC_API_VERSION < 14\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, &error);\n+#else\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, 2, &error);\n+#endif\n+\n+    struct UPNPUrls urls;\n+    struct IGDdatas data;\n+    int r;\n+\n+    r = UPNP_GetValidIGD(devlist, &urls, &data, lanaddr, sizeof(lanaddr));\n+    if (r == 1)\n+    {\n+        if (fDiscover) {\n+            char externalIPAddress[40];\n+            r = UPNP_GetExternalIPAddress(urls.controlURL, data.first.servicetype, externalIPAddress);\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"UPnP: GetExternalIPAddress() returned %d\\n\", r);\n+            } else {\n+                if (externalIPAddress[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(externalIPAddress, resolved, false)) {\n+                        LogPrintf(\"UPnP: ExternalIPAddress = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"UPnP: GetExternalIPAddress failed.\\n\");\n+                }\n+            }\n+        }\n+\n+        std::string strDesc = PACKAGE_NAME \" \" + FormatFullVersion();\n+\n+        do {\n+            r = UPNP_AddPortMapping(urls.controlURL, data.first.servicetype, port.c_str(), port.c_str(), lanaddr, strDesc.c_str(), \"TCP\", 0, \"0\");\n+\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"AddPortMapping(%s, %s, %s) failed with code %d (%s)\\n\", port, port, lanaddr, r, strupnperror(r));\n+            } else {\n+                LogPrintf(\"UPnP Port Mapping successful.\\n\");\n+            }\n+        } while (g_mapport_interrupt.sleep_for(std::chrono::minutes(20)));\n+\n+        r = UPNP_DeletePortMapping(urls.controlURL, data.first.servicetype, port.c_str(), \"TCP\", 0);\n+        LogPrintf(\"UPNP_DeletePortMapping() returned: %d\\n\", r);\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        FreeUPNPUrls(&urls);\n+    } else {\n+        LogPrintf(\"No valid UPnP IGDs found\\n\");\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        if (r != 0)\n+            FreeUPNPUrls(&urls);\n+    }\n+}\n+#endif // #ifdef USE_UPNP\n+\n+void StartMapPort(MapPort proto)\n+{\n+    if (!g_mapport_thread.joinable()) {\n+        assert(!g_mapport_interrupt);\n+        switch (proto) {\n+        case MapPort::NAT_PMP: {\n+#ifdef USE_NATPMP\n+            g_mapport_thread = std::thread((std::bind(&TraceThread<void (*)()>, \"natpmp\", &ThreadNatpmp)));\n+#endif // #ifdef USE_NATPMP\n+            return;\n+        }\n+        case MapPort::UPNP: {\n+#ifdef USE_UPNP\n+            g_mapport_thread = std::thread((std::bind(&TraceThread<void (*)()>, \"upnp\", &ThreadUpnp)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r378006285",
      "id" : 378006285,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAwNjI4NQ==",
      "original_commit_id" : "c7e90ca40ad9b7c66f3429b792435e9279ceca6b",
      "original_position" : 199,
      "path" : "src/mapport.cpp",
      "position" : 199,
      "pull_request_review_id" : 357148016,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "updated_at" : "2020-02-12T02:12:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/378006285",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r378072197"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/378072197"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I believe that the both port mapping protocols shouldn't be enabled simultaneously:\r\nhttps://github.com/bitcoin/bitcoin/blob/c7e90ca40ad9b7c66f3429b792435e9279ceca6b/src/init.cpp#L1781-L1786",
      "commit_id" : "c7e90ca40ad9b7c66f3429b792435e9279ceca6b",
      "created_at" : "2020-02-12T07:10:35Z",
      "diff_hunk" : "@@ -0,0 +1,236 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h>\n+#endif\n+\n+#include <mapport.h>\n+\n+#include <clientversion.h>\n+#include <logging.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <netbase.h>\n+#include <threadinterrupt.h>\n+#include <util/system.h>\n+\n+#ifdef USE_NATPMP\n+#include <natpmp.h>\n+#ifdef WIN32\n+#include <winsock2.h>\n+#else\n+#include <arpa/inet.h>\n+#include <netinet/in.h>\n+#endif // #ifdef WIN32\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+#include <miniupnpc/miniupnpc.h>\n+#include <miniupnpc/upnpcommands.h>\n+#include <miniupnpc/upnperrors.h>\n+// The minimum supported miniUPnPc API version is set to 10. This keeps compatibility\n+// with Ubuntu 16.04 LTS and Debian 8 libminiupnpc-dev packages.\n+static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n+#endif // #ifdef USE_UPNP\n+\n+#include <cassert>\n+#include <chrono>\n+#include <functional>\n+#include <string>\n+#include <thread>\n+\n+#if defined(USE_NATPMP) || defined(USE_UPNP)\n+static CThreadInterrupt g_mapport_interrupt;\n+static std::thread g_mapport_thread;\n+\n+#ifdef USE_NATPMP\n+static void ThreadNatpmp()\n+{\n+    int r;\n+    natpmp_t natpmp;\n+    natpmpresp_t response;\n+\n+    r = initnatpmp(&natpmp, /* detect gateway automatically */ 0, /* forced gateway - NOT APPLIED*/ 0);\n+    if (r < 0) {\n+        LogPrintf(\"NAT-PMP: initnatpmp() failed with %d error.\\n\", r);\n+        closenatpmp(&natpmp);\n+        return;\n+    }\n+\n+    if (fDiscover) {\n+        r = sendpublicaddressrequest(&natpmp);\n+        if (r < 0) {\n+            LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed with %d error.\\n\", r);\n+        } else {\n+            do {\n+                r = readnatpmpresponseorretry(&natpmp, &response);\n+            } while (r == NATPMP_TRYAGAIN);\n+            if (r < 0 || response.type != NATPMP_RESPTYPE_PUBLICADDRESS) {\n+                LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for public address failed with %d error.\\n\", r);\n+            } else {\n+                const char* public_address = inet_ntoa(response.pnu.publicaddress.addr);\n+                if (public_address[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(public_address, resolved, false)) {\n+                        LogPrintf(\"NAT-PMP: public address = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"NAT-PMP: sendpublicaddressrequest() failed.\\n\");\n+                }\n+            }\n+        }\n+    }\n+\n+    const uint16_t port = GetListenPort();\n+    do {\n+        r = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, port, port, 3600 /*seconds*/);\n+        if (r < 0) {\n+            LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed with %d error.\\n\", r);\n+            break;\n+        }\n+\n+        do {\n+            r = readnatpmpresponseorretry(&natpmp, &response);\n+        } while (r == NATPMP_TRYAGAIN);\n+        if (r < 0 || response.type != NATPMP_RESPTYPE_TCPPORTMAPPING) {\n+            LogPrintf(\"NAT-PMP: readnatpmpresponseorretry() for port mapping failed with %d error.\\n\", r);\n+        } else {\n+            auto pm = response.pnu.newportmapping;\n+            if (port == pm.privateport && port == pm.mappedpublicport && pm.lifetime > 0) {\n+                LogPrintf(\"NAT-PMP: port mapping successful.\\n\");\n+            } else {\n+                LogPrintf(\"NAT-PMP: sendnewportmappingrequest() failed.\\n\");\n+            }\n+        }\n+\n+    } while (g_mapport_interrupt.sleep_for(std::chrono::minutes(20)));\n+\n+    r = sendnewportmappingrequest(&natpmp, NATPMP_PROTOCOL_TCP, port, port, /* remove a port mapping */ 0);\n+    if (r < 0) {\n+        LogPrintf(\"NAT-PMP: sendnewportmappingrequest(0) failed with %d error.\\n\", r);\n+    }\n+\n+    closenatpmp(&natpmp);\n+}\n+#endif // #ifdef USE_NATPMP\n+\n+#ifdef USE_UPNP\n+static void ThreadUpnp()\n+{\n+    std::string port = strprintf(\"%u\", GetListenPort());\n+    const char * multicastif = nullptr;\n+    const char * minissdpdpath = nullptr;\n+    struct UPNPDev * devlist = nullptr;\n+    char lanaddr[64];\n+\n+    int error = 0;\n+#if MINIUPNPC_API_VERSION < 14\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, &error);\n+#else\n+    devlist = upnpDiscover(2000, multicastif, minissdpdpath, 0, 0, 2, &error);\n+#endif\n+\n+    struct UPNPUrls urls;\n+    struct IGDdatas data;\n+    int r;\n+\n+    r = UPNP_GetValidIGD(devlist, &urls, &data, lanaddr, sizeof(lanaddr));\n+    if (r == 1)\n+    {\n+        if (fDiscover) {\n+            char externalIPAddress[40];\n+            r = UPNP_GetExternalIPAddress(urls.controlURL, data.first.servicetype, externalIPAddress);\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"UPnP: GetExternalIPAddress() returned %d\\n\", r);\n+            } else {\n+                if (externalIPAddress[0]) {\n+                    CNetAddr resolved;\n+                    if (LookupHost(externalIPAddress, resolved, false)) {\n+                        LogPrintf(\"UPnP: ExternalIPAddress = %s\\n\", resolved.ToString());\n+                        AddLocal(resolved, LOCAL_MAPPED);\n+                    }\n+                } else {\n+                    LogPrintf(\"UPnP: GetExternalIPAddress failed.\\n\");\n+                }\n+            }\n+        }\n+\n+        std::string strDesc = PACKAGE_NAME \" \" + FormatFullVersion();\n+\n+        do {\n+            r = UPNP_AddPortMapping(urls.controlURL, data.first.servicetype, port.c_str(), port.c_str(), lanaddr, strDesc.c_str(), \"TCP\", 0, \"0\");\n+\n+            if (r != UPNPCOMMAND_SUCCESS) {\n+                LogPrintf(\"AddPortMapping(%s, %s, %s) failed with code %d (%s)\\n\", port, port, lanaddr, r, strupnperror(r));\n+            } else {\n+                LogPrintf(\"UPnP Port Mapping successful.\\n\");\n+            }\n+        } while (g_mapport_interrupt.sleep_for(std::chrono::minutes(20)));\n+\n+        r = UPNP_DeletePortMapping(urls.controlURL, data.first.servicetype, port.c_str(), \"TCP\", 0);\n+        LogPrintf(\"UPNP_DeletePortMapping() returned: %d\\n\", r);\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        FreeUPNPUrls(&urls);\n+    } else {\n+        LogPrintf(\"No valid UPnP IGDs found\\n\");\n+        freeUPNPDevlist(devlist); devlist = nullptr;\n+        if (r != 0)\n+            FreeUPNPUrls(&urls);\n+    }\n+}\n+#endif // #ifdef USE_UPNP\n+\n+void StartMapPort(MapPort proto)\n+{\n+    if (!g_mapport_thread.joinable()) {\n+        assert(!g_mapport_interrupt);\n+        switch (proto) {\n+        case MapPort::NAT_PMP: {\n+#ifdef USE_NATPMP\n+            g_mapport_thread = std::thread((std::bind(&TraceThread<void (*)()>, \"natpmp\", &ThreadNatpmp)));\n+#endif // #ifdef USE_NATPMP\n+            return;\n+        }\n+        case MapPort::UPNP: {\n+#ifdef USE_UPNP\n+            g_mapport_thread = std::thread((std::bind(&TraceThread<void (*)()>, \"upnp\", &ThreadUpnp)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18077#discussion_r378072197",
      "id" : 378072197,
      "in_reply_to_id" : 378006285,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODA3MjE5Nw==",
      "original_commit_id" : "c7e90ca40ad9b7c66f3429b792435e9279ceca6b",
      "original_position" : 199,
      "path" : "src/mapport.cpp",
      "position" : 199,
      "pull_request_review_id" : 357227561,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18077",
      "updated_at" : "2020-02-12T07:10:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/378072197",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   }
]
