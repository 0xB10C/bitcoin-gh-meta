[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#18011](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/18011.html) (Replace current benchmarking framework with nanobench by martinus)\n* [#17809](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/17809.html) (rpc: Auto-format RPCResult by MarcoFalke)\n* [#17804](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/17804.html) (doc: Misc RPC help fixes by MarcoFalke)\n* [#17786](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/17786.html) (refactor: Nuke policy/fees->mempool circular dependencies by hebasto)\n* [#17383](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/17383.html) (Refactor: Move consts to their correct translation units by jnewbery)\n* [#17060](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/17060.html) (Cache 26% more coins: Reduce CCoinsMap::value_type from 96 to 76 bytes by martinus)\n* [#15606](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15606.html) ([experimental] UTXO snapshots by jamesob)\n* [#10443](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/10443.html) (Add fee_est tool for debugging fee estimation code by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-01-25T00:37:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18000#issuecomment-578354949",
      "id" : 578354949,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18000",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3ODM1NDk0OQ==",
      "updated_at" : "2020-01-28T01:54:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/578354949",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm reviewing and testing it right now but from some benchmarks I did, I saw how the time goes down by 50%. However the performance increases by 19% percent.\r\n\r\nRegtest results only right now\r\n\r\nOn master (ef8e2cee9f5d157eeb3139b64e9c3a5fa4bf36f3):\r\n```\r\n$ time src/bitcoin-cli --regtest gettxoutsetinfo\r\n...\r\n> src/bitcoin-cli --regtest gettxoutsetinfo  0,00s user 0,00s system 23% cpu 0,014 total\r\n```\r\nWith this PR\r\n```\r\n$ time src/bitcoin-cli --regtest gettxoutsetinfo\r\n...\r\n> src/bitcoin-cli --regtest gettxoutsetinfo  0,00s user 0,00s system 42% cpu 0,007 total\r\n```",
      "created_at" : "2020-01-27T17:27:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18000#issuecomment-578859737",
      "id" : 578859737,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18000",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3ODg1OTczNw==",
      "updated_at" : "2020-01-27T17:27:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/578859737",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/12272949?v=4",
         "events_url" : "https://api.github.com/users/emilengler/events{/privacy}",
         "followers_url" : "https://api.github.com/users/emilengler/followers",
         "following_url" : "https://api.github.com/users/emilengler/following{/other_user}",
         "gists_url" : "https://api.github.com/users/emilengler/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/emilengler",
         "id" : 12272949,
         "login" : "emilengler",
         "node_id" : "MDQ6VXNlcjEyMjcyOTQ5",
         "organizations_url" : "https://api.github.com/users/emilengler/orgs",
         "received_events_url" : "https://api.github.com/users/emilengler/received_events",
         "repos_url" : "https://api.github.com/users/emilengler/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/emilengler/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/emilengler/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/emilengler"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Can you say more about current use cases of the `gettxoutsetinfo` function and maybe future use cases if it's significantly faster with this change?",
      "created_at" : "2020-01-27T20:03:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18000#issuecomment-578926752",
      "id" : 578926752,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18000",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3ODkyNjc1Mg==",
      "updated_at" : "2020-01-27T20:03:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/578926752",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I think it's perfectly fine to drop the \"transactions\" statistics. It doesn't really mean anything; it just happened to be easy to compute pre-pertxout, but even now it's mostly a hack.",
      "created_at" : "2020-01-27T21:18:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18000#issuecomment-578957115",
      "id" : 578957115,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18000",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3ODk1NzExNQ==",
      "updated_at" : "2020-01-27T21:18:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/578957115",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@emilengler  Thanks for giving it a try! But I think the benchmarks you are comparing are not well suited in this case. I assume you are running a standard regtest network, maybe generated a few hundred blocks and made some transactions by hand. In this case the UTXO set is very small and iterating over it will be extremely fast, so that it would not surprise me if there is no measurable upside to using the index (maybe it will be even a little slower as you saw). But the goal of this index is that the time of the call will stay constant for a realistically sized UTXO set. So a better indicator would be to try it on a synced mainnet or testnet node, where `gettxoutset` currently takes several minutes without the index, even on pretty high powered hardware.\r\n\r\n@ryanofsky  Sure, I will go along the different statistics the call provides to highlight which ones I think are more or less important:\r\n- `total_amount` The total amount of the current bitcoin supply. Tracking this number on a continual basis allows users to detect potential inflation bugs, such as CVE-2018-17144 (Example: [Bitmex Research](https://blog.bitmex.com/forkmonitor-unexpected-inflation-detection-and-warning-system/)). I think all users should be given the chance to continually check this, even on more affordable hardware. I am currently running a mainnet node on an Odroid HC2 and `gettxoutsetinfo` takes 7min 50s. Specs are roughly comparable to a Raspberry Pi 4, so it can keep up well with the chain otherwise. If I wanted to run a continual inflation detection on this hardware, I would not be able to do so when the UTXO set has grown another 20-25% (ignoring hashrate fluctuations).\r\n- `hash_serialized_2` The serialized hash of the UTXO set can be used for a quick comparison of the UTXO set between different notes. Essentially, it can be a stand-in for the latest blockhash and compared for sanity checks. BTCPayServer has been using it for their [FastSync](https://github.com/btcpayserver/btcpayserver-docker/tree/master/contrib/FastSync) feature, which will probably be replaced with `assume_utxo`, where a UTXO set hash (not necessarily this one) will play a role as well. I still need to sync up with @jamesob  about the latest plans for the hash and how this proposal can be compatible with his or even help/support it.\r\n- `txouts` The total number of unspent outputs is an interesting number to track from an operations standpoint. Users can see if coins are being consolidated or at which rate the UTXO set is growing. Example: [satoshi.info](https://statoshi.info/dashboard/db/unspent-transaction-output-set)\r\n- `bogosize` and `disk_size` might be also interesting to track but not as actionable, disc usage is probably much more efficient to collect from the OS\r\n- `transactions` it seems to be a nice-to-have metric that does not serve any real purpose afaict, as @sipa also noted\r\n- `height` and `bestblock` can be ignored since they are available from other RPCs, but are necessary to compare numbers between different machines\r\n\r\nFor future use cases (aside from integration with `assume_utxo` potentially) I don't have specific ideas yet, but it opens the door to track any other statistics of the UTXO set or block content in the index. So it may collect further metrics of interest where users currently parse the block data with their own custom software.",
      "created_at" : "2020-01-27T23:40:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18000#issuecomment-579009007",
      "id" : 579009007,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18000",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3OTAwOTAwNw==",
      "updated_at" : "2020-01-27T23:40:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/579009007",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@fjahr I'm a bit confused now, I ran the tests again on a full chain and master is MUCH faster than this Pull Request (4 MINUTES faster)\r\nOn master (2755b2b1092d0286022cf3cc3028e96f6bee2b34)\r\n```\r\n$ time src/bitcoin-cli --datadir=/media/emil/Files/Bitcoin/ gettxoutsetinfo\r\n{\r\n  \"height\": 614943,\r\n  \"bestblock\": \"0000000000000000000fa03a2ce4c6d7fb763e55402deac32371b898e8faba5e\",\r\n  \"transactions\": 38747934,\r\n  \"txouts\": 65245740,\r\n  \"bogosize\": 4903711195,\r\n  \"hash_serialized_2\": \"011d3eccd148b68a3bf039f0695bb4d77a23ba208dcd4d8ac073d867fd5bbef6\",\r\n  \"disk_size\": 4035082036,\r\n  \"total_amount\": 18186617.32125282\r\n}\r\nsrc/bitcoin-cli --datadir=/media/emil/Files/Bitcoin/ gettxoutsetinfo  0,00s user 0,01s system 0% cpu 57,428 total\r\n```\r\nOn fjahr:utxo-stats-index-rebase (663dbfbd1da60e91c9576629ace82b712d31668c)\r\n```\r\n$ time src/bitcoin-cli --datadir=/media/emil/Files/Bitcoin/ gettxoutsetinfo\r\n{\r\n  \"height\": 614937,\r\n  \"bestblock\": \"00000000000000000005973a14ac338b681e410922c7566e435107db1b1d807b\",\r\n  \"transactions\": 38745882,\r\n  \"txouts\": 65244661,\r\n  \"bogosize\": 4903634025,\r\n  \"utxo_set_hash\": \"87d3e7f807d6b428bf60e983a73137ef410cb510de1b5f4e650e081d044fc772\",\r\n  \"disk_size\": 4082447626,\r\n  \"total_amount\": 18186542.32125282\r\n}\r\nsrc/bitcoin-cli --datadir=/media/emil/Files/Bitcoin/ gettxoutsetinfo  0,01s user 0,00s system 0% cpu 5:01,42 total\r\n```",
      "created_at" : "2020-01-28T19:39:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18000#issuecomment-579418971",
      "id" : 579418971,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18000",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3OTQxODk3MQ==",
      "updated_at" : "2020-01-28T19:39:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/579418971",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/12272949?v=4",
         "events_url" : "https://api.github.com/users/emilengler/events{/privacy}",
         "followers_url" : "https://api.github.com/users/emilengler/followers",
         "following_url" : "https://api.github.com/users/emilengler/following{/other_user}",
         "gists_url" : "https://api.github.com/users/emilengler/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/emilengler",
         "id" : 12272949,
         "login" : "emilengler",
         "node_id" : "MDQ6VXNlcjEyMjcyOTQ5",
         "organizations_url" : "https://api.github.com/users/emilengler/orgs",
         "received_events_url" : "https://api.github.com/users/emilengler/received_events",
         "repos_url" : "https://api.github.com/users/emilengler/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/emilengler/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/emilengler/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/emilengler"
      }
   }
]
