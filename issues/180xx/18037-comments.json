[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Some relevant info about the analysis of the cost (maintenance burden) vs benefit (supporting a better tested & simpler codebase) of these changes \r\n\r\n**pros:**\r\n- these changes add a function to the scheduler with unit test coverage\r\n- the function would only be used when running regtest\r\n- intent is for this to support easier functional testing for other features \r\n- currently, two explicit use cases \r\n\r\n**cons:**\r\n- all code adds maintenance burden \r\n- c++ code specifically to support testing should only be added when necessary \r\n- the scheduler mock is not required for functionally testing the current use cases. workarounds are possible \r\n\r\nexplanation of the two use cases & workarounds.\r\n1. #18038 uses the mock to trigger the next attempt at initial broadcast, which is scheduled for every 10 minutes. Alternatively, the `REATTEMPT_BROADCAST_INTERVAL` constant that indicates scheduler frequency could be defined as a chain param and made more frequent for regtest (thanks @MarcoFalke for the suggestion).\r\n2. In PR #16698, specifically commit baf7de22108eb9081ddc700067b72409efbc382e, the mock would allow deleting some of the c++ code (but still be testable.) In the patch right now, the scheduler periodically calls `MaybeResendWalletTxs` which calls `ResubmitWalletTransactionsToMempool` which uses `nNextResend` to track time. `nNextResend` implements a mockable time so can be tested from the functional tests. If the scheduler mock is supported, the scheduler could directly invoke the resubmit function & drop the member var to maintain time tracking. ",
      "created_at" : "2020-01-31T05:52:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18037#issuecomment-580593078",
      "id" : 580593078,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18037",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MDU5MzA3OA==",
      "updated_at" : "2020-01-31T05:56:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/580593078",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "utACK 58c4c19.\r\n\r\nThis seems like a generally useful test harness, and the code looks basically correct to me. I think the pointer to the scheduler is a little crass, but it isn't a bad option considering the scheduler is created as a static in init.cpp (someone can clean it up later if they make the schedule a non static).\r\n\r\nThe time delta technically could underflow, but I don't think that's the base time being subtracted from is a time point (and we're far from the unix epoch time). If this weren't just testing harness, it might be worth it to check for underflow, but since we'd basically be having to actively try to shoot ourselves in the foot during a test to get an underflow this usage is fine. \r\n\r\nGreat work!",
      "created_at" : "2020-01-31T06:09:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18037#issuecomment-580596981",
      "id" : 580596981,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18037",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MDU5Njk4MQ==",
      "updated_at" : "2020-01-31T06:09:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/580596981",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK. \r\n\r\nLooks like there's an issue with the new `mockforward` unit test, as most of the [Travis instances](https://travis-ci.org/bitcoin/bitcoin/builds/644207906) are failing:\r\n```bash\r\ntest/scheduler_tests.cpp(158): Entering test case \"mockforward\"\r\ntest/scheduler_tests.cpp(188): error: in \"scheduler_tests/mockforward\": check num_tasks == 1 has failed [3 != 1]\r\ntest/scheduler_tests.cpp(191): error: in \"scheduler_tests/mockforward\": check counter == 2 has failed [0 != 2]\r\ntest/scheduler_tests.cpp(197): error: in \"scheduler_tests/mockforward\": check delta > 2*60 && delta < 3*60 has failed\r\ntest/scheduler_tests.cpp(158): Leaving test case \"mockforward\"; testing time: 6321us\r\ntest/scheduler_tests.cpp(13): Leaving test suite \"scheduler_tests\"; testing time: 146946us\r\n```",
      "created_at" : "2020-01-31T06:24:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18037#issuecomment-580600650",
      "id" : 580600650,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18037",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MDYwMDY1MA==",
      "updated_at" : "2020-01-31T06:24:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/580600650",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#17958](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/17958.html) (rpc: query general daemon information via RPC by brakmic)\n* [#17577](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/17577.html) (refactor: deduplicate the message sign/verify code by vasild)\n* [#16440](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16440.html) (BIP-322: Generic signed message format by kallewoof)\n* [#16365](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16365.html) (Log RPC parameters (arguments) if -debug=rpcparams by LarryRuane)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-01-31T08:40:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18037#issuecomment-580639273",
      "id" : 580639273,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18037",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MDYzOTI3Mw==",
      "updated_at" : "2020-01-31T08:40:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/580639273",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "No objection, but some observations:\r\n\r\n* In light of the test failures on some platforms, we obviously need to make sure this is doing the right thing. Timestamp handling isn't obviously trivial especially in combination with condition variables. See also the numerous scheduler crashed that no one can explain: #16307, #16027, #14200, ...\r\n\r\n* \"Mocking\" code so that tests run the mocked code and production runs a different code might defeat the whole point of having the tests in the first place. Tests (especially functional tests) are supposed to test the production code (paths) as closely as possible.\r\n\r\nSo my personal preference would be to go with some minimally invasive and simple approach like the chainparam. But if everyone else likes this mock approach because it could be used for other testing needs as well, then I won't object having this merged.",
      "created_at" : "2020-01-31T09:12:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18037#issuecomment-580650220",
      "id" : 580650220,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18037",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MDY1MDIyMA==",
      "updated_at" : "2020-01-31T09:13:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/580650220",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18037#discussion_r373789747"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18037"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/373789747"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: \"mockscheduler **is** for regression testing (-regtest mode) only\"?",
      "commit_id" : "58c4c1943e082060f38054ed4738478635ab9c31",
      "created_at" : "2020-02-01T16:56:00Z",
      "diff_hunk" : "@@ -366,6 +369,27 @@ static UniValue setmocktime(const JSONRPCRequest& request)\n     return NullUniValue;\n }\n \n+static UniValue mockscheduler(const JSONRPCRequest& request)\n+{\n+        RPCHelpMan{\"mockscheduler\",\n+            \"\\nBump the scheduler into the future (-regtest only)\\n\",\n+            {\n+                {\"delta_time\", RPCArg::Type::NUM, RPCArg::Optional::NO, \"Number of seconds to forward the scheduler into the future.\" },\n+            },\n+            RPCResults{},\n+            RPCExamples{\"\"},\n+        }.Check(request);\n+\n+    if (!Params().MineBlocksOnDemand())\n+        throw std::runtime_error(\"mockscheduler for regression testing (-regtest mode) only\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18037#discussion_r373789747",
      "id" : 373789747,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc4OTc0Nw==",
      "original_commit_id" : "58c4c1943e082060f38054ed4738478635ab9c31",
      "original_position" : 35,
      "path" : "src/rpc/misc.cpp",
      "position" : 35,
      "pull_request_review_id" : 351893286,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18037",
      "updated_at" : "2020-02-01T16:56:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/373789747",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/4500994?v=4",
         "events_url" : "https://api.github.com/users/kristapsk/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kristapsk/followers",
         "following_url" : "https://api.github.com/users/kristapsk/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kristapsk/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kristapsk",
         "id" : 4500994,
         "login" : "kristapsk",
         "node_id" : "MDQ6VXNlcjQ1MDA5OTQ=",
         "organizations_url" : "https://api.github.com/users/kristapsk/orgs",
         "received_events_url" : "https://api.github.com/users/kristapsk/received_events",
         "repos_url" : "https://api.github.com/users/kristapsk/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kristapsk/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kristapsk/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kristapsk"
      }
   }
]
