[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Some relevant info about the analysis of the cost (maintenance burden) vs benefit (supporting a better tested & simpler codebase) of these changes \r\n\r\n**pros:**\r\n- these changes add a function to the scheduler with unit test coverage\r\n- the function would only be used when running regtest\r\n- intent is for this to support easier functional testing for other features \r\n- currently, two explicit use cases \r\n\r\n**cons:**\r\n- all code adds maintenance burden \r\n- c++ code specifically to support testing should only be added when necessary \r\n- the scheduler mock is not required for functionally testing the current use cases. workarounds are possible \r\n\r\nexplanation of the two use cases & workarounds.\r\n1. #18038 uses the mock to trigger the next attempt at initial broadcast, which is scheduled for every 10 minutes. Alternatively, the `REATTEMPT_BROADCAST_INTERVAL` constant that indicates scheduler frequency could be defined as a chain param and made more frequent for regtest (thanks @MarcoFalke for the suggestion).\r\n2. In PR #16698, specifically commit baf7de22108eb9081ddc700067b72409efbc382e, the mock would allow deleting some of the c++ code (but still be testable.) In the patch right now, the scheduler periodically calls `MaybeResendWalletTxs` which calls `ResubmitWalletTransactionsToMempool` which uses `nNextResend` to track time. `nNextResend` implements a mockable time so can be tested from the functional tests. If the scheduler mock is supported, the scheduler could directly invoke the resubmit function & drop the member var to maintain time tracking. ",
      "created_at" : "2020-01-31T05:52:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18037#issuecomment-580593078",
      "id" : 580593078,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18037",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MDU5MzA3OA==",
      "updated_at" : "2020-01-31T05:56:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/580593078",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "utACK 58c4c19.\r\n\r\nThis seems like a generally useful test harness, and the code looks basically correct to me. I think the pointer to the scheduler is a little crass, but it isn't a bad option considering the scheduler is created as a static in init.cpp (someone can clean it up later if they make the schedule a non static).\r\n\r\nThe time delta technically could underflow, but I don't think that's the base time being subtracted from is a time point (and we're far from the unix epoch time). If this weren't just testing harness, it might be worth it to check for underflow, but since we'd basically be having to actively try to shoot ourselves in the foot during a test to get an underflow this usage is fine. \r\n\r\nGreat work!",
      "created_at" : "2020-01-31T06:09:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18037#issuecomment-580596981",
      "id" : 580596981,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18037",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MDU5Njk4MQ==",
      "updated_at" : "2020-01-31T06:09:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/580596981",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK. \r\n\r\nLooks like there's an issue with the new `mockforward` unit test, as most of the [Travis instances](https://travis-ci.org/bitcoin/bitcoin/builds/644207906) are failing:\r\n```bash\r\ntest/scheduler_tests.cpp(158): Entering test case \"mockforward\"\r\ntest/scheduler_tests.cpp(188): error: in \"scheduler_tests/mockforward\": check num_tasks == 1 has failed [3 != 1]\r\ntest/scheduler_tests.cpp(191): error: in \"scheduler_tests/mockforward\": check counter == 2 has failed [0 != 2]\r\ntest/scheduler_tests.cpp(197): error: in \"scheduler_tests/mockforward\": check delta > 2*60 && delta < 3*60 has failed\r\ntest/scheduler_tests.cpp(158): Leaving test case \"mockforward\"; testing time: 6321us\r\ntest/scheduler_tests.cpp(13): Leaving test suite \"scheduler_tests\"; testing time: 146946us\r\n```",
      "created_at" : "2020-01-31T06:24:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18037#issuecomment-580600650",
      "id" : 580600650,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18037",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MDYwMDY1MA==",
      "updated_at" : "2020-01-31T06:24:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/580600650",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   }
]
