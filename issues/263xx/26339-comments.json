[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "With the same build on Ubuntu 22.04 I could not reproduce this error with a number of tests. I did however take a shortcut which could have influenced the outcome, namely only performing a ~10,000 block rescan, but using `bitcoin-cli -rpctimeout=5 rescanblockchain 750000` so that my bitcoin-cli call would time out in the same way as yours before the rescan was complete.\r\n\r\nThe first timeout is expected as the function call will likely not return before a full chain rescan is complete. In my tests I could still check rescan progress and cancel the scan with `abortrescan` as expected. Additional `bitcoin-cli` calls after the rescan was complete such as `listunspent` also still worked.\r\n\r\n`SIGPIPE` on `b-http` indicates that bitcoin-qt tried to write back to an RPC/REST socket, presumably the call from `bitcoin-cli rescanblockchain` in this case, and found it closed. However my tests indicate that Bitcoin Core (and libevent) is generally robust when trying to write back to closed FDs:\r\n\r\n<details>\r\n  <summary>Log file for early cli return on rescanblockchain</summary>\r\n  \r\n```\r\n2022-10-19T21:25:10Z [libevent:debug] event_del: 0x7f7224004eb0 (fd -1), callback 0x7f7315b3ad70\r\n2022-10-19T21:25:10Z [libevent:debug] event_del: 0x7f7224004f30 (fd -1), callback 0x7f7315b3b500\r\n2022-10-19T21:25:10Z [libevent:debug] event_add: event: 0x7f7224004f30 (fd 21),  EV_WRITE   call 0x7f7315b3b500\r\n2022-10-19T21:25:10Z [libevent:debug] Epoll ADD(4) on fd 21 okay. Old events were 0; read change was 0 (none); write change was 1 (add); close change was 0 (none)\r\n2022-10-19T21:25:10Z [libevent:debug] event_add: event: 0x7f7224004eb0 (fd 21), EV_READ    call 0x7f7315b3ad70\r\n2022-10-19T21:25:10Z [libevent:debug] Epoll MOD(5) on fd 21 okay. Old events were 4; read change was 1 (add); write change was 0 (none); close change was 0 (none)\r\n2022-10-19T21:25:10Z [libevent:debug] event_del: 0x7f7224004f30 (fd 21), callback 0x7f7315b3b500\r\n2022-10-19T21:25:10Z [libevent:debug] Epoll MOD(1) on fd 21 okay. Old events were 6; read change was 0 (none); write change was 2 (del); close change was 0 (none)\r\n2022-10-19T21:25:10Z [libevent:debug] event_add: event: 0x7f7224004eb0 (fd 21), EV_READ   EV_TIMEOUT call 0x7f7315b3ad70\r\n2022-10-19T21:25:10Z [libevent:debug] event_add: event 0x7f7224004eb0, timeout in 30 seconds 0 useconds, call 0x7f7315b3ad70\r\n2022-10-19T21:25:10Z [libevent:debug] event_del: 0x7f7224004f30 (fd 21), callback 0x7f7315b3b500\r\n2022-10-19T21:25:10Z [libevent:debug] event_add: event: 0x7f7224004eb0 (fd 21), EV_READ   EV_TIMEOUT call 0x7f7315b3ad70\r\n2022-10-19T21:25:10Z [libevent:debug] event_add: event 0x7f7224004eb0, timeout in 30 seconds 0 useconds, call 0x7f7315b3ad70\r\n2022-10-19T21:25:10Z [libevent:debug] timeout_next: event: 0x7f7224004eb0, in 30 seconds, 0 useconds\r\n2022-10-19T21:25:10Z [libevent:debug] epoll_dispatch: epoll_wait reports 1\r\n2022-10-19T21:25:10Z [libevent:debug] event_active: 0x7f7224004eb0 (fd 21), res 2, callback 0x7f7315b3ad70\r\n2022-10-19T21:25:10Z [libevent:debug] event_process_active: event: 0x7f7224004eb0, EV_READ   call 0x7f7315b3ad70\r\n2022-10-19T21:25:10Z [libevent:debug] event_add: event: 0x7f7224004eb0 (fd 21), EV_READ   EV_TIMEOUT call 0x7f7315b3ad70\r\n2022-10-19T21:25:10Z [libevent:debug] event_add: event 0x7f7224004eb0, timeout in 87440 seconds 75927 useconds, call 0x7f7315b3ad70\r\n2022-10-19T21:25:10Z [libevent:debug] evhttp_add_header: key: Host val: 127.0.0.1\r\n\r\n2022-10-19T21:25:10Z [libevent:debug] evhttp_add_header: key: Connection val: close\r\n\r\n2022-10-19T21:25:10Z [libevent:debug] evhttp_add_header: key: Content-Type val: application/json\r\n\r\n2022-10-19T21:25:10Z [libevent:debug] evhttp_add_header: key: Authorization val: Basic X19jb29raWVfXzo5MGUxNTRjOTA2NWM5ODlkMmM1MTg3NTE1NTM0NDljMzUwNzEzODFmNjQ5ZjA5MGU4ZjBmMTUzZGY3MWI1MzM0\r\n\r\n2022-10-19T21:25:10Z [libevent:debug] evhttp_add_header: key: Content-Length val: 55\r\n\r\n2022-10-19T21:25:10Z [libevent:debug] evhttp_read_header: checking for post data on 21\r\n\r\n2022-10-19T21:25:10Z [libevent:debug] evhttp_get_body_length: bytes to read: 55 (in buffer 55)\r\n\r\n2022-10-19T21:25:10Z [libevent:debug] event_del: 0x7f7224004eb0 (fd 21), callback 0x7f7315b3ad70\r\n2022-10-19T21:25:10Z [libevent:debug] Epoll DEL(1) on fd 21 okay. Old events were 2; read change was 2 (del); write change was 0 (none); close change was 0 (none)\r\n2022-10-19T21:25:10Z [libevent:debug] event_del: 0x7f7224004eb0 (fd 21), callback 0x7f7315b3ad70\r\n2022-10-19T21:25:10Z [libevent:debug] event_del: 0x7f7224004eb0 (fd 21), callback 0x7f7315b3ad70\r\n2022-10-19T21:25:10Z [http] Received a POST request for / from 127.0.0.1:56524\r\n2022-10-19T21:25:10Z [rpc] ThreadRPCServer method=rescanblockchain user=__cookie__\r\n2022-10-19T21:25:10Z [timeouttestwallet] Rescan started from block 000000000000000000073cdaa0c1e5f91707f7b3217a4b3265d2e783f2fa83db...\r\n2022-10-19T21:25:30Z [timeouttestwallet] Scanning current mempool transactions.\r\n2022-10-19T21:25:30Z [timeouttestwallet] Rescan completed in           19911ms\r\n2022-10-19T21:25:30Z [libevent:debug] evhttp_add_header: key: Content-Type val: application/json\r\n\r\n2022-10-19T21:25:30Z [libevent:debug] event_active: 0x7f71e418b040 (fd -1), res 0, callback 0x56005b0b71c0\r\n2022-10-19T21:25:30Z [libevent:debug] epoll_dispatch: epoll_wait reports 1\r\n2022-10-19T21:25:30Z [libevent:debug] event_active: 0x7f72740688e0 (fd 44), res 2, callback 0x7f7315b45620\r\n2022-10-19T21:25:30Z [libevent:debug] event_del: 0x7f71e418b040 (fd -1), callback 0x56005b0b71c0\r\n2022-10-19T21:25:30Z [libevent:debug] event_process_active: event: 0x7f71e418b040,    call 0x56005b0b71c0\r\n2022-10-19T21:25:30Z [libevent:debug] evhttp_add_header: key: Date val: Wed, 19 Oct 2022 21:25:30 GMT\r\n\r\n2022-10-19T21:25:30Z [libevent:debug] evhttp_add_header: key: Content-Length val: 76\r\n\r\n2022-10-19T21:25:30Z [libevent:debug] evhttp_add_header: key: Connection val: close\r\n\r\n2022-10-19T21:25:30Z [libevent:debug] evhttp_write_buffer: preparing to write buffer\r\n\r\n2022-10-19T21:25:30Z [libevent:debug] event_add: event: 0x7f7224004eb0 (fd 21), EV_READ   EV_TIMEOUT call 0x7f7315b3ad70\r\n2022-10-19T21:25:30Z [libevent:debug] Epoll ADD(1) on fd 21 okay. Old events were 0; read change was 1 (add); write change was 0 (none); close change was 0 (none)\r\n2022-10-19T21:25:30Z [libevent:debug] event_add: event 0x7f7224004eb0, timeout in 30 seconds 0 useconds, call 0x7f7315b3ad70\r\n2022-10-19T21:25:30Z [libevent:debug] event_add: event: 0x7f7224004f30 (fd 21),  EV_WRITE  EV_TIMEOUT call 0x7f7315b3b500\r\n2022-10-19T21:25:30Z [libevent:debug] Epoll MOD(5) on fd 21 okay. Old events were 2; read change was 0 (none); write change was 1 (add); close change was 0 (none)\r\n2022-10-19T21:25:30Z [libevent:debug] event_add: event 0x7f7224004f30, timeout in 30 seconds 0 useconds, call 0x7f7315b3b500\r\n2022-10-19T21:25:30Z [libevent:debug] event_add: event: 0x7f7224004eb0 (fd 21), EV_READ   EV_TIMEOUT call 0x7f7315b3ad70\r\n2022-10-19T21:25:30Z [libevent:debug] event_add: event 0x7f7224004eb0, timeout in 30 seconds 0 useconds, call 0x7f7315b3ad70\r\n2022-10-19T21:25:30Z [libevent:debug] event_add: event: 0x7f7224004f30 (fd 21),  EV_WRITE  EV_TIMEOUT call 0x7f7315b3b500\r\n2022-10-19T21:25:30Z [libevent:debug] event_add: event 0x7f7224004f30, timeout in 30 seconds 0 useconds, call 0x7f7315b3b500\r\n2022-10-19T21:25:30Z [libevent:debug] event_del: 0x7f71e418b040 (fd -1), callback 0x56005b0b71c0\r\n2022-10-19T21:25:30Z [libevent:debug] event_process_active: event: 0x7f72740688e0, EV_READ   call 0x7f7315b45620\r\n2022-10-19T21:25:30Z [libevent:debug] timeout_next: event: 0x7f7224004eb0, in 30 seconds, 0 useconds\r\n2022-10-19T21:25:30Z [libevent:debug] epoll_dispatch: epoll_wait reports 1\r\n2022-10-19T21:25:30Z [libevent:debug] event_active: 0x7f7224004f30 (fd 21), res 4, callback 0x7f7315b3b500\r\n2022-10-19T21:25:30Z [libevent:debug] event_active: 0x7f7224004eb0 (fd 21), res 2, callback 0x7f7315b3ad70\r\n2022-10-19T21:25:30Z [libevent:debug] event_process_active: event: 0x7f7224004f30,  EV_WRITE  call 0x7f7315b3b500\r\n2022-10-19T21:25:30Z [libevent:debug] event_add: event: 0x7f7224004f30 (fd 21),  EV_WRITE  EV_TIMEOUT call 0x7f7315b3b500\r\n2022-10-19T21:25:30Z [libevent:debug] event_add: event 0x7f7224004f30, timeout in 87459 seconds 987941 useconds, call 0x7f7315b3b500\r\n2022-10-19T21:25:30Z [libevent:debug] event_del: 0x7f7224004f30 (fd 21), callback 0x7f7315b3b500\r\n2022-10-19T21:25:30Z [libevent:debug] Epoll MOD(1) on fd 21 okay. Old events were 6; read change was 0 (none); write change was 2 (del); close change was 0 (none)\r\n2022-10-19T21:25:30Z [libevent:debug] event_callback_finalize_many_: 3 events finalizing\r\n2022-10-19T21:25:30Z [libevent:debug] event_del: 0x7f7224004eb0 (fd 21), callback 0x7f7315b3ad70\r\n2022-10-19T21:25:30Z [libevent:debug] Epoll DEL(1) on fd 21 gave Bad file descriptor: DEL was unnecessary.\r\n2022-10-19T21:25:30Z [libevent:debug] event_del: 0x7f7224004f30 (fd 21), callback 0x7f7315b3b500\r\n2022-10-19T21:25:30Z [libevent:debug] event_process_active: event: 0x7f7224004f30,  EV_WRITE  call 0x7f7315b38720\r\n```\r\n</details>\r\n\r\nI am not able to decipher your particular libevent stacktrace, but perhaps someone else (@promag ?) might know more.",
      "created_at" : "2022-10-19T21:38:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/26339#issuecomment-1284601207",
      "id" : 1284601207,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26339",
      "node_id" : "IC_kwDOABII585MkXV3",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1284601207/reactions"
      },
      "updated_at" : "2022-10-19T21:38:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1284601207",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@willcl-ark I tried reproducing the crash using the `-rpctimeout` option that you mentioned but am not finding it:\r\n\r\n    $ bitcoin-cli -rpctimeout=5 rescanblockchain 750000\r\n    Error parsing command line arguments: Invalid parameter -rpctimeout=5\r\n\r\nDid you type it wrongly?\r\n\r\nEdit: never mind - it's `-rpcclienttimeout=5`, and trying to shortcut it using that doesn't make it crash for me either. I'll try another very large rescan overnight tonight to see if it crashes again.\r\n\r\n    $ bitcoin-cli -rpcclienttimeout=1 rescanblockchain 700000 700100\r\n    error: timeout on transient error: Could not connect to the server 127.0.0.1:8332 (error code 0 - \"timeout reached\")\r\n    \r\n    Make sure the bitcoind server is running and that you are connecting to the correct RPC port.\r\n    \r\n    $ bitcoin-cli -rpcclienttimeout=11 rescanblockchain 700000 700100\r\n    {\r\n      \"start_height\": 700000,\r\n      \"stop_height\": 700100\r\n    }\r\n\r\nie. after the timeout the bitcoin-qt is still responsive.",
      "created_at" : "2022-10-19T22:55:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/26339#issuecomment-1284655262",
      "id" : 1284655262,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26339",
      "node_id" : "IC_kwDOABII585Mkkie",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1284655262/reactions"
      },
      "updated_at" : "2022-10-19T23:14:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1284655262",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/573356?v=4",
         "events_url" : "https://api.github.com/users/dooglus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dooglus/followers",
         "following_url" : "https://api.github.com/users/dooglus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dooglus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dooglus",
         "id" : 573356,
         "login" : "dooglus",
         "node_id" : "MDQ6VXNlcjU3MzM1Ng==",
         "organizations_url" : "https://api.github.com/users/dooglus/orgs",
         "received_events_url" : "https://api.github.com/users/dooglus/received_events",
         "repos_url" : "https://api.github.com/users/dooglus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dooglus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dooglus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dooglus"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Ah yes, it should say `rpcclienttimeout`. And it's not a crash per se, but just the rpc not returning before the timeout.",
      "created_at" : "2022-10-19T23:31:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/26339#issuecomment-1284700324",
      "id" : 1284700324,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26339",
      "node_id" : "IC_kwDOABII585Mkvik",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1284700324/reactions"
      },
      "updated_at" : "2022-10-19T23:31:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1284700324",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "The bitcoin-qt process exited immediately upon receiving a SIGPIPE signal. I'd call that a crash. No clean shutdown, it just stopped running.\r\n\r\nI've seen lots of timeouts from bitcoin-cli in the past but never before yesterday have I seen it cause the bitcoin server to exit.",
      "created_at" : "2022-10-19T23:50:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/26339#issuecomment-1284712232",
      "id" : 1284712232,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26339",
      "node_id" : "IC_kwDOABII585Mkyco",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1284712232/reactions"
      },
      "updated_at" : "2022-10-19T23:51:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1284712232",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/573356?v=4",
         "events_url" : "https://api.github.com/users/dooglus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dooglus/followers",
         "following_url" : "https://api.github.com/users/dooglus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dooglus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dooglus",
         "id" : 573356,
         "login" : "dooglus",
         "node_id" : "MDQ6VXNlcjU3MzM1Ng==",
         "organizations_url" : "https://api.github.com/users/dooglus/orgs",
         "received_events_url" : "https://api.github.com/users/dooglus/received_events",
         "repos_url" : "https://api.github.com/users/dooglus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dooglus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dooglus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dooglus"
      }
   }
]
