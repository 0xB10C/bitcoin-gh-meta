{
   "assignee" : null,
   "assignees" : [],
   "body" : "The following scenario will not notify the caller of the fact `tx0` has been dropped:\r\n\r\n1. User 1 receives BTC in tx0 from utxo1 in block aa1.\r\n2. User 2 receives BTC in tx1 from utxo1 (same) in block bb1\r\n3. User 1 sees 2 confirmations at block aa3.\r\n4. Reorg into bb chain.\r\n5. User 1 asks `listsinceblock aa3` and does not see that tx0 is now invalidated.\r\n\r\nSee `listsinceblock.py` commit for related test.\r\n\r\nThe proposed fix is to iterate from the given block down to the fork point, and to check each transaction in the blocks against the wallet, in addition to including all transactions from the fork point to the active chain tip (the current behavior). Any transactions that were present will now also be listed in the `listsinceblock` output in a new `reorged` array. This operation may be a bit heavy but the circumstances (and perceived frequency of occurrence) warrant it, I believe.\r\n\r\nExample output:\r\n```Python\r\n{\r\n  'transactions': [],\r\n  'reorged': [\r\n    {\r\n      'walletconflicts': [],\r\n      'vout': 1,\r\n      'account': '',\r\n      'timereceived': 1485234857,\r\n      'time': 1485234857,\r\n      'amount': '1.00000000',\r\n      'bip125-replaceable': 'unknown',\r\n      'trusted': False,\r\n      'category': 'receive',\r\n      'txid': 'ce673859a30dee1d2ebdb3c05f2eea7b1da54baf68f93bb8bfe37c5f09ed22ff',\r\n      'address': 'miqEt4kWp9zSizwGGuUWLAmxEcTW9bFUnQ',\r\n      'label': '',\r\n      'confirmations': -7\r\n    }\r\n  ],\r\n  'lastblock': '7a388f27d09e3699102a4ebf81597d974fc4c72093eeaa02adffbbf7527f6715'\r\n}\r\n```\r\n\r\nI believe this addresses the comment by @luke-jr in https://github.com/bitcoin/bitcoin/pull/9516#issuecomment-274190081 but I could be wrong..\r\n",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 5,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9622/comments",
   "created_at" : "2017-01-24T05:41:12Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9622/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/9622",
   "id" : 202729664,
   "labels" : [
      {
         "color" : "0052cc",
         "default" : false,
         "id" : 98279177,
         "name" : "RPC/REST/ZMQ",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/RPC/REST/ZMQ"
      },
      {
         "color" : "02d7e1",
         "default" : false,
         "id" : 149424,
         "name" : "Wallet",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Wallet"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9622/labels{/name}",
   "locked" : false,
   "milestone" : {
      "closed_at" : null,
      "closed_issues" : 82,
      "created_at" : "2016-06-13T14:18:51Z",
      "creator" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=3",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      },
      "description" : "",
      "due_on" : null,
      "html_url" : "https://github.com/bitcoin/bitcoin/milestone/21",
      "id" : 1823680,
      "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/milestones/21/labels",
      "number" : 21,
      "open_issues" : 21,
      "state" : "open",
      "title" : "0.14.0",
      "updated_at" : "2017-01-25T16:28:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/milestones/21"
   },
   "number" : 9622,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/9622.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9622",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/9622.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9622"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "title" : "[rpc] Bug-fix: listsinceblock should include lost transactions when parameter is a reorg'd block",
   "updated_at" : "2017-01-25T22:47:45Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9622",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/250224?v=3",
      "events_url" : "https://api.github.com/users/kallewoof/events{/privacy}",
      "followers_url" : "https://api.github.com/users/kallewoof/followers",
      "following_url" : "https://api.github.com/users/kallewoof/following{/other_user}",
      "gists_url" : "https://api.github.com/users/kallewoof/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/kallewoof",
      "id" : 250224,
      "login" : "kallewoof",
      "organizations_url" : "https://api.github.com/users/kallewoof/orgs",
      "received_events_url" : "https://api.github.com/users/kallewoof/received_events",
      "repos_url" : "https://api.github.com/users/kallewoof/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/kallewoof/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/kallewoof"
   }
}
