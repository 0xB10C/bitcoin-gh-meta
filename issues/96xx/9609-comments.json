[
   {
      "body" : "(fixes #9212)\n\nOn January 21, 2017 1:54:26 AM EST, Cory Fields <notifications@github.com> wrote:\n>First change is from @TheBlueMatt.\n>\n>https://github.com/bitcoin/bitcoin/pull/8708/commits/462965635e8bf9c2754c27946f8b05560b8ddd84\n>added assertions to ensure that we never send out any messages before\n>version negotiation has completed, but a few issues remain.\n>\n>In cases where the version message failed to deserialize fully, we can\n>end up with only some of the vars set, leading to sending messages that\n>shouldn't be sent.\n>\n>Additionally, the ForEach* functions allow the caller to send messages\n>to all nodes, including those that aren't yet fully connected. To\n>prevent that, filter out nodes that definitely shouldn't be\n>sending/processing messages.\n>\n>As a follow-up, I'd like to remove the assert, as I think it's done its\n>job, but I'll save that discussion for another PR because I think\n>@TheBlueMatt mentioned that he'd prefer to keep it.\n>You can view, comment on, or merge this pull request online at:\n>\n>  https://github.com/bitcoin/bitcoin/pull/9609\n>\n>-- Commit Summary --\n>\n>  * Dont deserialize nVersion into CNode, should fix #9212\n>  * net: deserialize the entire version message locally\n>* net: don't run callbacks on nodes that haven't completed the version\n>handshake\n>\n>-- File Changes --\n>\n>    M src/net.cpp (7)\n>    M src/net.h (38)\n>    M src/net_processing.cpp (54)\n>\n>-- Patch Links --\n>\n>https://github.com/bitcoin/bitcoin/pull/9609.patch\n>https://github.com/bitcoin/bitcoin/pull/9609.diff\n>\n>-- \n>You are receiving this because you were mentioned.\n>Reply to this email directly or view it on GitHub:\n>https://github.com/bitcoin/bitcoin/pull/9609\n",
      "created_at" : "2017-01-21T15:14:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9609#issuecomment-274267476",
      "id" : 274267476,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9609",
      "updated_at" : "2017-01-21T15:14:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/274267476",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9609#discussion_r97203764"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/97203764"
         }
      },
      "body" : "This block no longer accesses a cs_filter protected variable. The lock and braces should be removed.",
      "commit_id" : "c7f0bca19ca5bf172f457a6bd7c0e9df13ea14ba",
      "created_at" : "2017-01-21T18:36:08Z",
      "diff_hunk" : "@@ -1232,18 +1239,15 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n         if (!vRecv.empty())\n             vRecv >> addrFrom >> nNonce;\n         if (!vRecv.empty()) {\n-            vRecv >> LIMITED_STRING(pfrom->strSubVer, MAX_SUBVERSION_LENGTH);\n-            pfrom->cleanSubVer = SanitizeString(pfrom->strSubVer);\n+            vRecv >> LIMITED_STRING(strSubVer, MAX_SUBVERSION_LENGTH);\n         }\n         if (!vRecv.empty()) {\n-            vRecv >> pfrom->nStartingHeight;\n+            vRecv >> nStartingHeight;\n         }\n         {\n             LOCK(pfrom->cs_filter);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9609#discussion_r97203764",
      "id" : 97203764,
      "original_commit_id" : "bd3725ef6ca1ac455a12bb791d8ef23b12dc1d02",
      "original_position" : 41,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 17812080,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9609",
      "updated_at" : "2017-01-21T19:55:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/97203764",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9609#discussion_r97203772"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/97203772"
         }
      },
      "body" : "This was protected by cs_filter above.",
      "commit_id" : "c7f0bca19ca5bf172f457a6bd7c0e9df13ea14ba",
      "created_at" : "2017-01-21T18:36:31Z",
      "diff_hunk" : "@@ -1254,7 +1258,19 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n             return true;\n         }\n \n+        pfrom->nServices = nServices;\n         pfrom->addrLocal = addrMe;\n+        pfrom->strSubVer = strSubVer;\n+        pfrom->cleanSubVer = SanitizeString(strSubVer);\n+        pfrom->nStartingHeight = nStartingHeight;\n+        pfrom->fRelayTxes = fRelay;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9609#discussion_r97203772",
      "id" : 97203772,
      "original_commit_id" : "bd3725ef6ca1ac455a12bb791d8ef23b12dc1d02",
      "original_position" : 59,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 17812085,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9609",
      "updated_at" : "2017-01-21T19:55:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/97203772",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9609#discussion_r97203893"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/97203893"
         }
      },
      "body" : "nVersion should be made atomic.",
      "commit_id" : "c7f0bca19ca5bf172f457a6bd7c0e9df13ea14ba",
      "created_at" : "2017-01-21T18:44:08Z",
      "diff_hunk" : "@@ -1254,7 +1258,19 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n             return true;\n         }\n \n+        pfrom->nServices = nServices;\n         pfrom->addrLocal = addrMe;\n+        pfrom->strSubVer = strSubVer;\n+        pfrom->cleanSubVer = SanitizeString(strSubVer);\n+        pfrom->nStartingHeight = nStartingHeight;\n+        pfrom->fRelayTxes = fRelay;\n+        pfrom->fClient = !(nServices & NODE_NETWORK);\n+\n+        // Change version\n+        pfrom->SetSendVersion(nSendVersion);\n+        pfrom->nVersion = nVersion;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9609#discussion_r97203893",
      "id" : 97203893,
      "original_commit_id" : "bd3725ef6ca1ac455a12bb791d8ef23b12dc1d02",
      "original_position" : 64,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 17812217,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9609",
      "updated_at" : "2017-01-21T19:55:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/97203893",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "@gmaxwell ACK all of those, will fix.",
      "created_at" : "2017-01-21T18:47:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9609#issuecomment-274280245",
      "id" : 274280245,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9609",
      "updated_at" : "2017-01-21T18:47:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/274280245",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9609#discussion_r97215932"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/97215932"
         }
      },
      "body" : "If we set succesfully connected and nversion before sending VERACK is it possible that some other thread will send some other message to this peer before VERACK has been sent?",
      "commit_id" : "c7f0bca19ca5bf172f457a6bd7c0e9df13ea14ba",
      "created_at" : "2017-01-22T08:00:41Z",
      "diff_hunk" : "@@ -1278,11 +1291,7 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n         UpdatePreferredDownload(pfrom, State(pfrom->GetId()));\n         }\n \n-        // Change version\n         connman.PushMessage(pfrom, CNetMsgMaker(INIT_PROTO_VERSION).Make(NetMsgType::VERACK));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9609#discussion_r97215932",
      "id" : 97215932,
      "original_commit_id" : "3769071e1bb7b6e3887a5e0fb481d2ddd8720556",
      "original_position" : 90,
      "path" : "src/net_processing.cpp",
      "position" : 109,
      "pull_request_review_id" : 17822879,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9609",
      "updated_at" : "2017-01-22T08:00:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/97215932",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9609#discussion_r97229279"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/97229279"
         }
      },
      "body" : "Yes, and that's ok. It's seen on the current network.\r\n\r\nWhat's not ok is that messages before VERACK could possibly end up being sent with the upgraded version. So i suppose setting the sendversion should stay as-is, after the VERACK.",
      "commit_id" : "c7f0bca19ca5bf172f457a6bd7c0e9df13ea14ba",
      "created_at" : "2017-01-22T18:10:42Z",
      "diff_hunk" : "@@ -1278,11 +1291,7 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n         UpdatePreferredDownload(pfrom, State(pfrom->GetId()));\n         }\n \n-        // Change version\n         connman.PushMessage(pfrom, CNetMsgMaker(INIT_PROTO_VERSION).Make(NetMsgType::VERACK));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9609#discussion_r97229279",
      "id" : 97229279,
      "original_commit_id" : "3769071e1bb7b6e3887a5e0fb481d2ddd8720556",
      "original_position" : 90,
      "path" : "src/net_processing.cpp",
      "position" : 109,
      "pull_request_review_id" : 17834140,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9609",
      "updated_at" : "2017-01-22T18:10:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/97229279",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9609#discussion_r97230197"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9609"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/97230197"
         }
      },
      "body" : "Er, that doesn't work, it just reintroduces the problem that we're attempting to solve.\r\n\r\nA mutex for a group of these attributes may be unavoidable. I'll poke at it some more.",
      "commit_id" : "c7f0bca19ca5bf172f457a6bd7c0e9df13ea14ba",
      "created_at" : "2017-01-22T18:52:55Z",
      "diff_hunk" : "@@ -1278,11 +1291,7 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n         UpdatePreferredDownload(pfrom, State(pfrom->GetId()));\n         }\n \n-        // Change version\n         connman.PushMessage(pfrom, CNetMsgMaker(INIT_PROTO_VERSION).Make(NetMsgType::VERACK));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9609#discussion_r97230197",
      "id" : 97230197,
      "original_commit_id" : "3769071e1bb7b6e3887a5e0fb481d2ddd8720556",
      "original_position" : 90,
      "path" : "src/net_processing.cpp",
      "position" : 109,
      "pull_request_review_id" : 17835017,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9609",
      "updated_at" : "2017-01-22T18:52:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/97230197",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   }
]
