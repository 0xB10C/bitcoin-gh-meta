[
   {
      "author_association" : "MEMBER",
      "body" : "An example of running the generated perf data file through [hotspot](https://github.com/KDAB/hotspot):\r\n\r\n![selection_109](https://user-images.githubusercontent.com/73197/47235981-b33ebd80-d3a8-11e8-96bd-30f6f91b95f4.png)\r\n",
      "created_at" : "2018-10-19T18:10:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14519#issuecomment-431450614",
      "id" : 431450614,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14519",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQzMTQ1MDYxNA==",
      "updated_at" : "2018-10-19T18:10:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/431450614",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14519#discussion_r226737926"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14519"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/226737926"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Maybe comment `# Frequency in Hz`",
      "commit_id" : "358e757d566d5f659901acc6f15fa9eb6eb3e741",
      "created_at" : "2018-10-19T18:15:42Z",
      "diff_hunk" : "@@ -267,6 +267,70 @@ def assert_debug_log(self, expected_msgs):\n                 if re.search(re.escape(expected_msg), log, flags=re.MULTILINE) is None:\n                     self._raise_assertion_error('Expected message \"{}\" does not partially match log:\\n\\n{}\\n\\n'.format(expected_msg, print_log))\n \n+    @contextlib.contextmanager\n+    def profile_with_perf(self, profile_name=None):\n+        \"\"\"\n+        Context manager that allows easy profiling of node activity using `perf`.\n+\n+        Perf will sample the running node and will generate profile data in the node's\n+        datadir. The profile data can then be presented using `perf report` or a graphical\n+        tool like `hotspot`<https://github.com/KDAB/hotspot>.\n+\n+        To see useful textual output, run\n+\n+            perf report -i /path/to/datadir/node-0.perf.data --stdio | c++filt | less\n+\n+        See also:\n+\n+            Installing perf: https://askubuntu.com/q/50145\n+            Perf examples: http://www.brendangregg.com/perf.html\n+\n+        Kwargs:\n+\n+            profile_name (str): If specified, this string will be appended to the\n+                profile data filename generated by perf.\n+\n+        Usage:\n+\n+            with node.profile_with_perf(\"some-function\"):\n+                # Perform activity on the node you're interested in profiling, e.g.:\n+                for _ in range(10000):\n+                    node.p2p.send_message(some_large_message)\n+        \"\"\"\n+        subp = None\n+\n+        def test_success(cmd):\n+            return subprocess.run(\n+                cmd, shell=True,\n+                stderr=subprocess.DEVNULL, stdout=subprocess.DEVNULL).returncode == 0\n+\n+        if not test_success('readelf -S {} | grep .debug_str'.format(self.binary)):\n+            self.log.warning(\n+                \"perf output won't be very useful without debug symbols compiled into bitcoind\")\n+\n+        if not test_success('which perf'):\n+            self.log.warning(\"Can't profile with perf; must install perf-tools\")\n+        else:\n+            suffix = \"-{}\".format(profile_name) if profile_name else \"\"\n+            output_path = os.path.join(\n+                self.datadir, \"node-{}{}.perf.data\".format(self.index, suffix))\n+\n+            cmd = [\n+                'perf', 'record',\n+                '-g',\n+                '--call-graph', 'dwarf',\n+                '-F', '101',",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14519#discussion_r226737926",
      "id" : 226737926,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIyNjczNzkyNg==",
      "original_commit_id" : "b93a17c3153f050eb37292b51463b0aaa5860f1a",
      "original_position" : 56,
      "path" : "test/functional/test_framework/test_node.py",
      "position" : null,
      "pull_request_review_id" : 166639838,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14519",
      "updated_at" : "2018-10-19T20:44:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/226737926",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14519#discussion_r226739869"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14519"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/226739869"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Escaping self.binary with [shlex.quote](https://docs.python.org/3/library/shlex.html#shlex.quote) would let it work with any filename.",
      "commit_id" : "358e757d566d5f659901acc6f15fa9eb6eb3e741",
      "created_at" : "2018-10-19T18:22:27Z",
      "diff_hunk" : "@@ -267,6 +267,70 @@ def assert_debug_log(self, expected_msgs):\n                 if re.search(re.escape(expected_msg), log, flags=re.MULTILINE) is None:\n                     self._raise_assertion_error('Expected message \"{}\" does not partially match log:\\n\\n{}\\n\\n'.format(expected_msg, print_log))\n \n+    @contextlib.contextmanager\n+    def profile_with_perf(self, profile_name=None):\n+        \"\"\"\n+        Context manager that allows easy profiling of node activity using `perf`.\n+\n+        Perf will sample the running node and will generate profile data in the node's\n+        datadir. The profile data can then be presented using `perf report` or a graphical\n+        tool like `hotspot`<https://github.com/KDAB/hotspot>.\n+\n+        To see useful textual output, run\n+\n+            perf report -i /path/to/datadir/node-0.perf.data --stdio | c++filt | less\n+\n+        See also:\n+\n+            Installing perf: https://askubuntu.com/q/50145\n+            Perf examples: http://www.brendangregg.com/perf.html\n+\n+        Kwargs:\n+\n+            profile_name (str): If specified, this string will be appended to the\n+                profile data filename generated by perf.\n+\n+        Usage:\n+\n+            with node.profile_with_perf(\"some-function\"):\n+                # Perform activity on the node you're interested in profiling, e.g.:\n+                for _ in range(10000):\n+                    node.p2p.send_message(some_large_message)\n+        \"\"\"\n+        subp = None\n+\n+        def test_success(cmd):\n+            return subprocess.run(\n+                cmd, shell=True,\n+                stderr=subprocess.DEVNULL, stdout=subprocess.DEVNULL).returncode == 0\n+\n+        if not test_success('readelf -S {} | grep .debug_str'.format(self.binary)):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14519#discussion_r226739869",
      "id" : 226739869,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIyNjczOTg2OQ==",
      "original_commit_id" : "b93a17c3153f050eb37292b51463b0aaa5860f1a",
      "original_position" : 41,
      "path" : "test/functional/test_framework/test_node.py",
      "position" : null,
      "pull_request_review_id" : 166639838,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14519",
      "updated_at" : "2018-10-19T20:44:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/226739869",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review, @ryanofsky. I really like your suggestions and so I've incorporated them all into a rebase.\r\n\r\nYou can now pass `--perf` when running an individual test file and all nodes will be profiled for the duration of the test. Here's an example run:\r\n```sh\r\n$ ./test/functional/p2p_unrequested_blocks.py --perf\r\n\r\n2018-10-19T20:36:06.542000Z TestFramework (INFO): Initializing test directory /tmp/test71_cfvsc\r\n...\r\n2018-10-19T20:36:09.206000Z TestFramework (INFO): Stopping nodes\r\n2018-10-19T20:36:09.384000Z TestFramework.node0 (INFO): Wrote perf output to '/tmp/test71_cfvsc/node0/node-0-AcceptBlockTest.perf.data'\r\n2018-10-19T20:36:09.558000Z TestFramework.node1 (INFO): Wrote perf output to '/tmp/test71_cfvsc/node1/node-1-AcceptBlockTest.perf.data'\r\n2018-10-19T20:36:09.608000Z TestFramework (WARNING): Not cleaning up dir /tmp/test71_cfvsc due to perf data\r\n2018-10-19T20:36:09.608000Z TestFramework (INFO): Tests successful\r\n\r\n```",
      "created_at" : "2018-10-19T20:38:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14519#issuecomment-431491862",
      "id" : 431491862,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14519",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQzMTQ5MTg2Mg==",
      "updated_at" : "2018-10-19T20:38:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/431491862",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   }
]
