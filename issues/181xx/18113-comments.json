[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #17487 (coins: allow write to disk without cache drop by jamesob)\n* #9384 (CCoinsViewCache code cleanup & deduplication by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-02-11T05:48:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18113#issuecomment-584486715",
      "id" : 584486715,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18113",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NDQ4NjcxNQ==",
      "updated_at" : "2020-02-11T18:56:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/584486715",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Fixed a whitespace oops that our linters didn't like.",
      "created_at" : "2020-02-11T16:38:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18113#issuecomment-584726951",
      "id" : 584726951,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18113",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NDcyNjk1MQ==",
      "updated_at" : "2020-02-11T16:38:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/584726951",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK, will review (this was discussed in part in the meeting log of https://bitcoincore.reviews/17487.html)",
      "created_at" : "2020-02-19T19:31:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18113#issuecomment-588405436",
      "id" : 588405436,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18113",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4ODQwNTQzNg==",
      "updated_at" : "2020-02-19T19:31:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/588405436",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18113#discussion_r394108204"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18113"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/394108204"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "grammar issue- \"which is does exist\" \r\nmaybe- \"which actually does exist\" \r\n\r\nalso, I find this sentence a bit confusing, mostly because of the phrasing of \"will\" vs \"might\". If a coin exists in the parent view & gets incorrectly marked as FRESH, is there a way it could still be deleted from the parent when the cache is flushed? ",
      "commit_id" : "9288d747e849b126930ef9e2f623ce6746555ed4",
      "created_at" : "2020-03-18T05:03:26Z",
      "diff_hunk" : "@@ -115,13 +115,20 @@ struct CCoinsCacheEntry\n     unsigned char flags;\n \n     enum Flags {\n-        DIRTY = (1 << 0), // This cache entry is potentially different from the version in the parent view.\n-        FRESH = (1 << 1), // The parent view does not have this entry (or it is pruned).\n-        /* Note that FRESH is a performance optimization with which we can\n-         * erase coins that are fully spent if we know we do not need to\n-         * flush the changes to the parent cache.  It is always safe to\n-         * not mark FRESH if that condition is not guaranteed.\n-         */\n+        //! This cache entry is potentially different from the version in the parent cache.\n+        //! Failing to mark a coin as DIRTY when it is potentially different from the\n+        //! parent view will cause a consensus failure, since the coin's state won't get\n+        //! written to the parent when the cache is flushed.\n+        //! Note that all empty coins in the cache MUST be DIRTY.\n+        DIRTY = (1 << 0),\n+        //! The parent cache does not have this coin (or it is spent in the parent cache).\n+        //! If a FRESH coin is spent in this cache, then it can be deleted entirely\n+        //! and doesn't ever need to be flushed to the parent. This is a performance\n+        //! optimization. Note that a coin cannot be both FRESH and empty.\n+        //! Marking a coin FRESH which is does exist in the parent view will",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18113#discussion_r394108204",
      "id" : 394108204,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDEwODIwNA==",
      "original_commit_id" : "9288d747e849b126930ef9e2f623ce6746555ed4",
      "original_position" : 21,
      "path" : "src/coins.h",
      "position" : 21,
      "pull_request_review_id" : 376566237,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18113",
      "updated_at" : "2020-03-18T05:06:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/394108204",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18113#discussion_r394112049"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18113"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/394112049"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> grammar issue- \"which is does exist\"\r\n> maybe- \"which actually does exist\"\r\n\r\nOr simply \"exists\"?",
      "commit_id" : "9288d747e849b126930ef9e2f623ce6746555ed4",
      "created_at" : "2020-03-18T05:21:26Z",
      "diff_hunk" : "@@ -115,13 +115,20 @@ struct CCoinsCacheEntry\n     unsigned char flags;\n \n     enum Flags {\n-        DIRTY = (1 << 0), // This cache entry is potentially different from the version in the parent view.\n-        FRESH = (1 << 1), // The parent view does not have this entry (or it is pruned).\n-        /* Note that FRESH is a performance optimization with which we can\n-         * erase coins that are fully spent if we know we do not need to\n-         * flush the changes to the parent cache.  It is always safe to\n-         * not mark FRESH if that condition is not guaranteed.\n-         */\n+        //! This cache entry is potentially different from the version in the parent cache.\n+        //! Failing to mark a coin as DIRTY when it is potentially different from the\n+        //! parent view will cause a consensus failure, since the coin's state won't get\n+        //! written to the parent when the cache is flushed.\n+        //! Note that all empty coins in the cache MUST be DIRTY.\n+        DIRTY = (1 << 0),\n+        //! The parent cache does not have this coin (or it is spent in the parent cache).\n+        //! If a FRESH coin is spent in this cache, then it can be deleted entirely\n+        //! and doesn't ever need to be flushed to the parent. This is a performance\n+        //! optimization. Note that a coin cannot be both FRESH and empty.\n+        //! Marking a coin FRESH which is does exist in the parent view will",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18113#discussion_r394112049",
      "id" : 394112049,
      "in_reply_to_id" : 394108204,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDExMjA0OQ==",
      "original_commit_id" : "9288d747e849b126930ef9e2f623ce6746555ed4",
      "original_position" : 21,
      "path" : "src/coins.h",
      "position" : 21,
      "pull_request_review_id" : 376571028,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18113",
      "updated_at" : "2020-03-18T05:21:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/394112049",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/4015903?v=4",
         "events_url" : "https://api.github.com/users/jkczyz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jkczyz/followers",
         "following_url" : "https://api.github.com/users/jkczyz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jkczyz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jkczyz",
         "id" : 4015903,
         "login" : "jkczyz",
         "node_id" : "MDQ6VXNlcjQwMTU5MDM=",
         "organizations_url" : "https://api.github.com/users/jkczyz/orgs",
         "received_events_url" : "https://api.github.com/users/jkczyz/received_events",
         "repos_url" : "https://api.github.com/users/jkczyz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jkczyz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jkczyz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jkczyz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18113#discussion_r394425148"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18113"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/394425148"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Block 1,983,702 -- about 26 years from now? Is that a timestamp rolling over or something?\r\nI thought BIP34 (block height in coinbase) will prevent this from ever happening since it was enforced:\r\n\r\n> Block number 227,835 (timestamp 2013-03-24 15:49:13 GMT) was the last version 1 block.",
      "commit_id" : "9288d747e849b126930ef9e2f623ce6746555ed4",
      "created_at" : "2020-03-18T15:16:25Z",
      "diff_hunk" : "@@ -77,8 +75,26 @@ void CCoinsViewCache::AddCoin(const COutPoint &outpoint, Coin&& coin, bool possi\n     }\n     if (!possible_overwrite) {\n         if (!it->second.coin.IsSpent()) {\n-            throw std::logic_error(\"Adding new coin that replaces non-pruned entry\");\n+            throw std::logic_error(\"Attempted to overwrite an unspent coin\");\n         }\n+        // If the coin exists in this cache, is spent and is DIRTY, then\n+        // its spentness hasn't been flushed to the parent cache. We're\n+        // re-adding the coin to this cache now but we can't mark it as FRESH.\n+        // If we mark it FRESH and then spend it before the cache is flushed\n+        // we would remove it from this cache and would never flush spentness\n+        // to the parent cache.\n+        //\n+        // Re-adding a spent coin can happen in the case of a re-org (the coin\n+        // is 'spent' when the block containing it is disconnected and then\n+        // re-added if it also appears in the newly connected blocks). It can\n+        // also happen in the case of duplicate txids. In practice, BIP30 and\n+        // BIP34 ensure that the only duplicate transactions before block\n+        // 1,983,702 are the two pairs of coinbase txs at heights 91812/91842",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18113#discussion_r394425148",
      "id" : 394425148,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQyNTE0OA==",
      "original_commit_id" : "9288d747e849b126930ef9e2f623ce6746555ed4",
      "original_position" : 38,
      "path" : "src/coins.cpp",
      "position" : 38,
      "pull_request_review_id" : 376964867,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18113",
      "updated_at" : "2020-03-18T15:16:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/394425148",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2084648?v=4",
         "events_url" : "https://api.github.com/users/pinheadmz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pinheadmz/followers",
         "following_url" : "https://api.github.com/users/pinheadmz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pinheadmz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pinheadmz",
         "id" : 2084648,
         "login" : "pinheadmz",
         "node_id" : "MDQ6VXNlcjIwODQ2NDg=",
         "organizations_url" : "https://api.github.com/users/pinheadmz/orgs",
         "received_events_url" : "https://api.github.com/users/pinheadmz/received_events",
         "repos_url" : "https://api.github.com/users/pinheadmz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pinheadmz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pinheadmz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pinheadmz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18113#discussion_r394433944"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18113"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/394433944"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "What is an \"empty\" coin?",
      "commit_id" : "9288d747e849b126930ef9e2f623ce6746555ed4",
      "created_at" : "2020-03-18T15:27:47Z",
      "diff_hunk" : "@@ -115,13 +115,20 @@ struct CCoinsCacheEntry\n     unsigned char flags;\n \n     enum Flags {\n-        DIRTY = (1 << 0), // This cache entry is potentially different from the version in the parent view.\n-        FRESH = (1 << 1), // The parent view does not have this entry (or it is pruned).\n-        /* Note that FRESH is a performance optimization with which we can\n-         * erase coins that are fully spent if we know we do not need to\n-         * flush the changes to the parent cache.  It is always safe to\n-         * not mark FRESH if that condition is not guaranteed.\n-         */\n+        //! This cache entry is potentially different from the version in the parent cache.\n+        //! Failing to mark a coin as DIRTY when it is potentially different from the\n+        //! parent view will cause a consensus failure, since the coin's state won't get\n+        //! written to the parent when the cache is flushed.\n+        //! Note that all empty coins in the cache MUST be DIRTY.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18113#discussion_r394433944",
      "id" : 394433944,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDQzMzk0NA==",
      "original_commit_id" : "9288d747e849b126930ef9e2f623ce6746555ed4",
      "original_position" : 15,
      "path" : "src/coins.h",
      "position" : 15,
      "pull_request_review_id" : 376975903,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18113",
      "updated_at" : "2020-03-18T15:27:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/394433944",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2084648?v=4",
         "events_url" : "https://api.github.com/users/pinheadmz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pinheadmz/followers",
         "following_url" : "https://api.github.com/users/pinheadmz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pinheadmz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pinheadmz",
         "id" : 2084648,
         "login" : "pinheadmz",
         "node_id" : "MDQ6VXNlcjIwODQ2NDg=",
         "organizations_url" : "https://api.github.com/users/pinheadmz/orgs",
         "received_events_url" : "https://api.github.com/users/pinheadmz/received_events",
         "repos_url" : "https://api.github.com/users/pinheadmz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pinheadmz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pinheadmz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pinheadmz"
      }
   }
]
