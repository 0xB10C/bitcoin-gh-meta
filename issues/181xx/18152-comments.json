[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #17877 (qt, refactor: Make enums in BitcoinUnits class scoped by hebasto)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-02-15T18:37:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18152#issuecomment-586629097",
      "id" : 586629097,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18152",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NjYyOTA5Nw==",
      "updated_at" : "2020-02-26T14:41:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/586629097",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18152#discussion_r384670633"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18152"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384670633"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm not sure what motivation is exposing the import state, but it seems like you'd want the state to be `INIT_REINDEX` not `INIT_IMPORT` during reindexing (see [`ThreadImport`](https://github.com/bitcoin/bitcoin/blob/e5d47ed8fd3724cc5295fca70573f1edf552ff62/src/init.cpp#L676-L693)) so I don't understand the way these are prioritized",
      "commit_id" : "7a2a5edc09986bcbcfd370ece644e7c31fa71b25",
      "created_at" : "2020-02-26T18:09:59Z",
      "diff_hunk" : "@@ -226,31 +226,39 @@ static void BannedListChanged(ClientModel *clientmodel)\n     assert(invoked);\n }\n \n-static void BlockTipChanged(ClientModel *clientmodel, bool initialSync, int height, int64_t blockTime, double verificationProgress, bool fHeader)\n+static ClientModel::NotificationStatus GetNotificationStatus (interfaces::Node& node, bool initial_sync)\n {\n-    // lock free async UI updates in case we have a new block tip\n-    // during initial sync, only update the UI if the last update\n-    // was > 250ms (MODEL_UPDATE_DELAY) ago\n-    int64_t now = 0;\n-    if (initialSync)\n-        now = GetTimeMillis();\n-\n-    int64_t& nLastUpdateNotification = fHeader ? nLastHeaderTipUpdateNotification : nLastBlockTipUpdateNotification;\n+    if (node.getImporting()) return ClientModel::NotificationStatus::INIT_IMPORT;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18152#discussion_r384670633",
      "id" : 384670633,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDY3MDYzMw==",
      "original_commit_id" : "5bdd2831ee8092643fadc66e486aa3d839d05f6c",
      "original_position" : 15,
      "path" : "src/qt/clientmodel.cpp",
      "position" : null,
      "pull_request_review_id" : 365125185,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18152",
      "updated_at" : "2020-03-04T21:34:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384670633",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18152#discussion_r384672745"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18152"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384672745"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't see how this could be right. It appears to be never calling numBlockChanged at all during POST_INIT state\r\n\r\nUsage of throttle here is also potentially confusing. \"throttle\" bool should indicate when to slow down notifications, not when to send them",
      "commit_id" : "7a2a5edc09986bcbcfd370ece644e7c31fa71b25",
      "created_at" : "2020-02-26T18:13:46Z",
      "diff_hunk" : "@@ -226,31 +226,39 @@ static void BannedListChanged(ClientModel *clientmodel)\n     assert(invoked);\n }\n \n-static void BlockTipChanged(ClientModel *clientmodel, bool initialSync, int height, int64_t blockTime, double verificationProgress, bool fHeader)\n+static ClientModel::NotificationStatus GetNotificationStatus (interfaces::Node& node, bool initial_sync)\n {\n-    // lock free async UI updates in case we have a new block tip\n-    // during initial sync, only update the UI if the last update\n-    // was > 250ms (MODEL_UPDATE_DELAY) ago\n-    int64_t now = 0;\n-    if (initialSync)\n-        now = GetTimeMillis();\n-\n-    int64_t& nLastUpdateNotification = fHeader ? nLastHeaderTipUpdateNotification : nLastBlockTipUpdateNotification;\n+    if (node.getImporting()) return ClientModel::NotificationStatus::INIT_IMPORT;\n+    if (node.getReindex()) return ClientModel::NotificationStatus::INIT_REINDEX;\n+    if (initial_sync) return ClientModel::NotificationStatus::INIT_DOWNLOAD;\n+    return ClientModel::NotificationStatus::POST_INIT;\n+}\n \n+static void BlockTipChanged(ClientModel *clientmodel, bool initialSync, int height, int64_t blockTime, double verificationProgress, bool fHeader)\n+{\n     if (fHeader) {\n         // cache best headers time and height to reduce future cs_main locks\n         clientmodel->cachedBestHeaderHeight = height;\n         clientmodel->cachedBestHeaderTime = blockTime;\n     }\n \n-    // During initial sync, block notifications, and header notifications from reindexing are both throttled.\n-    if (!initialSync || (fHeader && !clientmodel->node().getReindex()) || now - nLastUpdateNotification > MODEL_UPDATE_DELAY) {\n-        //pass an async signal to the UI thread\n+    const ClientModel::NotificationStatus status = GetNotificationStatus(clientmodel->node(), initialSync);\n+    const bool throttle = (status == ClientModel::NotificationStatus::INIT_DOWNLOAD && !fHeader) ||",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18152#discussion_r384672745",
      "id" : 384672745,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDY3Mjc0NQ==",
      "original_commit_id" : "5bdd2831ee8092643fadc66e486aa3d839d05f6c",
      "original_position" : 33,
      "path" : "src/qt/clientmodel.cpp",
      "position" : null,
      "pull_request_review_id" : 365125185,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18152",
      "updated_at" : "2020-03-04T21:34:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/384672745",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ryanofsky \r\nThank you for your review. Your comments have been addressed.\r\n\r\nAlso rebased due to #17399.",
      "created_at" : "2020-03-04T21:36:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18152#issuecomment-594862645",
      "id" : 594862645,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18152",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5NDg2MjY0NQ==",
      "updated_at" : "2020-03-04T21:36:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/594862645",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18152#discussion_r387949044"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18152"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/387949044"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Reworked.",
      "commit_id" : "7a2a5edc09986bcbcfd370ece644e7c31fa71b25",
      "created_at" : "2020-03-04T21:37:25Z",
      "diff_hunk" : "@@ -226,31 +226,39 @@ static void BannedListChanged(ClientModel *clientmodel)\n     assert(invoked);\n }\n \n-static void BlockTipChanged(ClientModel *clientmodel, bool initialSync, int height, int64_t blockTime, double verificationProgress, bool fHeader)\n+static ClientModel::NotificationStatus GetNotificationStatus (interfaces::Node& node, bool initial_sync)\n {\n-    // lock free async UI updates in case we have a new block tip\n-    // during initial sync, only update the UI if the last update\n-    // was > 250ms (MODEL_UPDATE_DELAY) ago\n-    int64_t now = 0;\n-    if (initialSync)\n-        now = GetTimeMillis();\n-\n-    int64_t& nLastUpdateNotification = fHeader ? nLastHeaderTipUpdateNotification : nLastBlockTipUpdateNotification;\n+    if (node.getImporting()) return ClientModel::NotificationStatus::INIT_IMPORT;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18152#discussion_r387949044",
      "id" : 387949044,
      "in_reply_to_id" : 384670633,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk0OTA0NA==",
      "original_commit_id" : "5bdd2831ee8092643fadc66e486aa3d839d05f6c",
      "original_position" : 15,
      "path" : "src/qt/clientmodel.cpp",
      "position" : null,
      "pull_request_review_id" : 369141398,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18152",
      "updated_at" : "2020-03-04T21:37:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/387949044",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18152#discussion_r387949158"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18152"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/387949158"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "7a2a5edc09986bcbcfd370ece644e7c31fa71b25",
      "created_at" : "2020-03-04T21:37:39Z",
      "diff_hunk" : "@@ -226,31 +226,39 @@ static void BannedListChanged(ClientModel *clientmodel)\n     assert(invoked);\n }\n \n-static void BlockTipChanged(ClientModel *clientmodel, bool initialSync, int height, int64_t blockTime, double verificationProgress, bool fHeader)\n+static ClientModel::NotificationStatus GetNotificationStatus (interfaces::Node& node, bool initial_sync)\n {\n-    // lock free async UI updates in case we have a new block tip\n-    // during initial sync, only update the UI if the last update\n-    // was > 250ms (MODEL_UPDATE_DELAY) ago\n-    int64_t now = 0;\n-    if (initialSync)\n-        now = GetTimeMillis();\n-\n-    int64_t& nLastUpdateNotification = fHeader ? nLastHeaderTipUpdateNotification : nLastBlockTipUpdateNotification;\n+    if (node.getImporting()) return ClientModel::NotificationStatus::INIT_IMPORT;\n+    if (node.getReindex()) return ClientModel::NotificationStatus::INIT_REINDEX;\n+    if (initial_sync) return ClientModel::NotificationStatus::INIT_DOWNLOAD;\n+    return ClientModel::NotificationStatus::POST_INIT;\n+}\n \n+static void BlockTipChanged(ClientModel *clientmodel, bool initialSync, int height, int64_t blockTime, double verificationProgress, bool fHeader)\n+{\n     if (fHeader) {\n         // cache best headers time and height to reduce future cs_main locks\n         clientmodel->cachedBestHeaderHeight = height;\n         clientmodel->cachedBestHeaderTime = blockTime;\n     }\n \n-    // During initial sync, block notifications, and header notifications from reindexing are both throttled.\n-    if (!initialSync || (fHeader && !clientmodel->node().getReindex()) || now - nLastUpdateNotification > MODEL_UPDATE_DELAY) {\n-        //pass an async signal to the UI thread\n+    const ClientModel::NotificationStatus status = GetNotificationStatus(clientmodel->node(), initialSync);\n+    const bool throttle = (status == ClientModel::NotificationStatus::INIT_DOWNLOAD && !fHeader) ||",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18152#discussion_r387949158",
      "id" : 387949158,
      "in_reply_to_id" : 384672745,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzk0OTE1OA==",
      "original_commit_id" : "5bdd2831ee8092643fadc66e486aa3d839d05f6c",
      "original_position" : 33,
      "path" : "src/qt/clientmodel.cpp",
      "position" : null,
      "pull_request_review_id" : 369141541,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18152",
      "updated_at" : "2020-03-04T21:37:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/387949158",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   }
]
