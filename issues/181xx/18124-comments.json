[
   {
      "author_association" : "MEMBER",
      "body" : "I'm not sure whether it's better to crash than start with a \"wrong\" locale. We're already avoiding using locale-dependent functions in pretty much all important places.\r\n\r\nEdit: also, why are our assumptions different for bitcoin-qt and bitcoind?",
      "created_at" : "2020-02-12T15:36:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18124#issuecomment-585264292",
      "id" : 585264292,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18124",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NTI2NDI5Mg==",
      "updated_at" : "2020-02-12T15:42:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/585264292",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@laanwj I think you misunderstand the patch. Note that currently there is no way for a user to make `bitcoind` or `bitcoin-qt` start with the \"wrong\" locale.\r\n\r\nThis is just a sanity check that makes sure that the assumption we know to be true today remain true also in the future. Like `ECC_InitSanityCheck`, `Random_SanityCheck`, etc it tests that our assumptions hold true also in practice at run-time. What risks do you see?",
      "created_at" : "2020-02-12T15:45:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18124#issuecomment-585268983",
      "id" : 585268983,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18124",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NTI2ODk4Mw==",
      "updated_at" : "2020-02-12T16:07:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/585268983",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This is just my personal opinion but I think this adds some quite ugly code into our already convoluted initialization process, using weird functions such as `setlocale`. I'd prefer to avoid it and focus on getting rid of locale dependent functions where it's a problem.\r\n\r\nIf we decide to do this, I'd prefer to add the common checks to the other sanity checks and not distinguish between  `bitcoind.cpp`/`qt/bitcoin.cpp`.\r\n",
      "created_at" : "2020-02-12T15:53:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18124#issuecomment-585272928",
      "id" : 585272928,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18124",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NTI3MjkyOA==",
      "updated_at" : "2020-02-12T15:56:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/585272928",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@laanwj How would you suggest checking for the assumed locales in a less ugly way?\r\n\r\nHow do you suggest reading the C locale without using `setlocale`? (Please note that the C locale is *not* the same thing as the C++ locale.)",
      "created_at" : "2020-02-12T15:58:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18124#issuecomment-585275389",
      "id" : 585275389,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18124",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NTI3NTM4OQ==",
      "updated_at" : "2020-02-12T15:58:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/585275389",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> If we decide to do this, I'd prefer to add the common checks to the other sanity checks and not distinguish between `bitcoind.cpp`/`qt/bitcoin.cpp`.\r\n\r\nBut we're making different assumptions for `bitcoind` and `bitcoin-qt`, no?\r\n\r\n| Program        | C locale (`setlocale`) | Global C++ locale (`std::locale`) |\r\n| ------------- | ------------- | ----- |\r\n| `bitcoind`      | `C` (classic) | `C` (classic) |\r\n| `bitcoin-qt`      | No assumed locale  | `C` (classic) |\r\n\r\nWe want the C locale to be user-defined in `bitcoin-qt` but not in `bitcoind`, right?",
      "created_at" : "2020-02-12T16:04:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18124#issuecomment-585278347",
      "id" : 585278347,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18124",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NTI3ODM0Nw==",
      "updated_at" : "2020-02-12T16:04:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/585278347",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Perhaps I should have included a few examples in the PR title. The gotcha list could be made very long, but this is a C locale gotcha example :)\r\n\r\n```\r\n$ cling\r\n[cling]$ #include <clocale>\r\n[cling]$ #include <string>\r\n[cling]$ std::string current_locale = {setlocale(LC_ALL, nullptr)}\r\n(std::string &) \"C\"\r\n[cling]$ std::to_string(1.23)\r\n(std::string) \"1.230000\"\r\n[cling]$ setlocale(LC_ALL, \"de_DE\");\r\n[cling]$ std::to_string(1.23)\r\n(std::string) \"1,230000\"\r\n```\r\n\r\nPerhaps surprisingly `std::to_string` cares about the C locale and not the global C++ locale.",
      "created_at" : "2020-02-12T16:14:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18124#issuecomment-585283654",
      "id" : 585283654,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18124",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NTI4MzY1NA==",
      "updated_at" : "2020-02-12T16:17:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/585283654",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "And a C++ locale gotcha:\r\n\r\n```\r\n$ cling\r\n[cling]$ #include <locale>\r\n[cling]$ #include <sstream>\r\n[cling]$ std::locale{}.name()\r\n(std::string) \"C\"\r\n[cling]$ std::ostringstream oss1;\r\n[cling]$ oss1 << 1000000;\r\n[cling]$ std::string s1 = oss1.str()\r\n(std::string &) \"1000000\"\r\n[cling]$ std::locale::global(std::locale(\"de_DE\"));\r\n[cling]$ std::ostringstream oss2;\r\n[cling]$ oss2 << 1000000;\r\n[cling]$ std::string s2 = oss2.str()\r\n(std::string &) \"1.000.000\"\r\n```",
      "created_at" : "2020-02-12T16:22:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18124#issuecomment-585287999",
      "id" : 585287999,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18124",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NTI4Nzk5OQ==",
      "updated_at" : "2020-02-12T16:24:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/585287999",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   }
]
