[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r357709665"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/357709665"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in commit 6d1491603f6dfb9f755e60d77685635c35d5a48b: \r\n\r\nIs m_chain.SetTip assumed to be under cs_main? If yes, this should say ` ... = WITH_LOCK(cs_main, return m_chain.Tip());`",
      "commit_id" : "23283174f4e6f92c5eee1f7f1f94ceed8405099a",
      "created_at" : "2019-12-13T15:51:26Z",
      "diff_hunk" : "@@ -4908,6 +4908,13 @@ void CChainState::CheckBlockIndex(const Consensus::Params& consensusParams)\n     assert(nNodes == forward.size());\n }\n \n+std::string CChainState::ToString()\n+{\n+    CBlockIndex* tip = m_chain.Tip();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r357709665",
      "id" : 357709665,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NzcwOTY2NQ==",
      "original_commit_id" : "6d1491603f6dfb9f755e60d77685635c35d5a48b",
      "original_position" : 6,
      "path" : "src/validation.cpp",
      "position" : 206,
      "pull_request_review_id" : 331955313,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737",
      "updated_at" : "2019-12-13T16:31:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/357709665",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r357709949"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/357709949"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in commit 6d14916:\r\n\r\nI think the arguments are switched?",
      "commit_id" : "23283174f4e6f92c5eee1f7f1f94ceed8405099a",
      "created_at" : "2019-12-13T15:52:03Z",
      "diff_hunk" : "@@ -4908,6 +4908,13 @@ void CChainState::CheckBlockIndex(const Consensus::Params& consensusParams)\n     assert(nNodes == forward.size());\n }\n \n+std::string CChainState::ToString()\n+{\n+    CBlockIndex* tip = m_chain.Tip();\n+    return strprintf(\"Chainstate [%s] @ height %d\",\n+        tip ? tip->nHeight : -1, tip ? tip->GetBlockHash().ToString() : \"null\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r357709949",
      "id" : 357709949,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NzcwOTk0OQ==",
      "original_commit_id" : "6d1491603f6dfb9f755e60d77685635c35d5a48b",
      "original_position" : 8,
      "path" : "src/validation.cpp",
      "position" : 209,
      "pull_request_review_id" : 331955313,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737",
      "updated_at" : "2019-12-13T16:31:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/357709949",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r357711715"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/357711715"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in commit 6b62d2f15397226b273cb87f56b8978404fd415f:\r\n\r\nShould be const to ensure at compile time that we know whether a chainstate was created from a snapshot?",
      "commit_id" : "23283174f4e6f92c5eee1f7f1f94ceed8405099a",
      "created_at" : "2019-12-13T15:55:41Z",
      "diff_hunk" : "@@ -611,6 +611,13 @@ class CChainState {\n     //! @see CChain, CBlockIndex.\n     CChain m_chain;\n \n+    /**\n+     * The blockhash which is the base of the snapshot this chainstate was created from.\n+     *\n+     * IsNull() if this chainstate was not created from a snapshot.\n+     */\n+    uint256 m_from_snapshot_blockhash{};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r357711715",
      "id" : 357711715,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NzcxMTcxNQ==",
      "original_commit_id" : "6b62d2f15397226b273cb87f56b8978404fd415f",
      "original_position" : 18,
      "path" : "src/validation.h",
      "position" : 39,
      "pull_request_review_id" : 331955313,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737",
      "updated_at" : "2019-12-13T16:31:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/357711715",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r357712223"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/357712223"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in commit 6b62d2f15397226b273cb87f56b8978404fd415f:\r\n\r\nconstructors (especially single arg ones) should be explicit. Otherwise any hash can be passed into a function that accepts a chainstate. Hmmm",
      "commit_id" : "23283174f4e6f92c5eee1f7f1f94ceed8405099a",
      "created_at" : "2019-12-13T15:56:44Z",
      "diff_hunk" : "@@ -583,7 +583,7 @@ class CChainState {\n \n public:\n     CChainState(BlockManager& blockman) : m_blockman(blockman) {}\n-    CChainState();\n+    CChainState(uint256 from_snapshot_blockhash = uint256());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r357712223",
      "id" : 357712223,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NzcxMjIyMw==",
      "original_commit_id" : "6b62d2f15397226b273cb87f56b8978404fd415f",
      "original_position" : 5,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 331955313,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737",
      "updated_at" : "2019-12-13T16:31:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/357712223",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r357712757"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/357712757"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in commit 6b62d2f15397226b273cb87f56b8978404fd415f:\r\n\r\nNow the arguments are correct. Might just squash the commits?",
      "commit_id" : "23283174f4e6f92c5eee1f7f1f94ceed8405099a",
      "created_at" : "2019-12-13T15:57:52Z",
      "diff_hunk" : "@@ -4908,6 +4908,13 @@ void CChainState::CheckBlockIndex(const Consensus::Params& consensusParams)\n     assert(nNodes == forward.size());\n }\n \n+std::string CChainState::ToString()\n+{\n+    CBlockIndex* tip = m_chain.Tip();\n+    return strprintf(\"Chainstate [%s] @ height %d\",\n+        tip ? tip->nHeight : -1, tip ? tip->GetBlockHash().ToString() : \"null\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r357712757",
      "id" : 357712757,
      "in_reply_to_id" : 357709949,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NzcxMjc1Nw==",
      "original_commit_id" : "6d1491603f6dfb9f755e60d77685635c35d5a48b",
      "original_position" : 8,
      "path" : "src/validation.cpp",
      "position" : 209,
      "pull_request_review_id" : 331955313,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737",
      "updated_at" : "2019-12-13T16:31:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/357712757",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r357713099"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/357713099"
         }
      },
      "author_association" : "MEMBER",
      "body" : "style-nit in 6b62d2f15397226b273cb87f56b8978404fd415f:\r\n\r\nThe colon goes into a new line according to our clang-format",
      "commit_id" : "23283174f4e6f92c5eee1f7f1f94ceed8405099a",
      "created_at" : "2019-12-13T15:58:41Z",
      "diff_hunk" : "@@ -1245,7 +1245,9 @@ void CoinsViews::InitCache()\n \n // NOTE: for now m_blockman is set to a global, but this will be changed\n // in a future commit.\n-CChainState::CChainState() : m_blockman(g_blockman) {}\n+CChainState::CChainState(uint256 from_snapshot_blockhash) :",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r357713099",
      "id" : 357713099,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NzcxMzA5OQ==",
      "original_commit_id" : "6b62d2f15397226b273cb87f56b8978404fd415f",
      "original_position" : 5,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 331955313,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737",
      "updated_at" : "2019-12-13T16:31:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/357713099",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r357716948"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/357716948"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in commit 6a629cfd02:\r\n\r\nWouldn't this need to happen under some chainstate manager lock? Otherwise the chainstate might point to uninitialized memory in case of a race where \" Its contents will be freed when background validation of the snapshot has completed.\"",
      "commit_id" : "23283174f4e6f92c5eee1f7f1f94ceed8405099a",
      "created_at" : "2019-12-13T16:07:06Z",
      "diff_hunk" : "@@ -757,6 +762,111 @@ bool InvalidateBlock(BlockValidationState& state, const CChainParams& chainparam\n /** Remove invalidity status from a block and its descendants. */\n void ResetBlockFailureFlags(CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+/**\n+ * Provides an interface for creating and interacting with multiple\n+ * chainstates, as well as a means to initialize chainstates from a\n+ * UTXO snapshot. Managed chainstates can be maintained at different\n+ * heights simultaneously.\n+ *\n+ * This class provides abstractions that allow the retrieval of the current\n+ * most-work chainstate (\"Active\") as well as chainstates which may be in\n+ * background use to validate UTXO snapshots.\n+ *\n+ * A few quick definitions:\n+ *\n+ * *IBD chainstate*: a chainstate populated via initial block download.\n+ *\n+ * *Snapshot chainstate*: a chainstate populated by loading in an\n+ *    assumed-valid UTXO snapshot.\n+ *\n+ * *Active chainstate*: the chainstate containing the current most-work\n+ *    chain. Consulted by most parts of the system (net_processing,\n+ *    wallet) as a reflection of the current chain and UTXO set.\n+ *    This may either be an IBD chainstate or a snapshot chainstate.\n+ *\n+ * *Background validation chainstate*: an IBD chainstate for which the\n+ *    IBD process is happening in the background while use of the\n+ *    active chainstate allows the rest of the system to function.\n+ *\n+ * *Validated chainstate*: a chainstate whose validity is not assumed.\n+ *    This could be an IBD chainstate, or a snapshot chainstate for\n+ *    which background validation (up to the base of the snapshot)\n+ *    has completed.\n+ */\n+class ChainstateManager\n+{\n+private:\n+    //! The chainstate used under normal operation (i.e. \"regular\" IBD) or,\n+    //! if a snapshot is in use, for background validation. Its contents will\n+    //! be freed when background validation of the snapshot has completed.\n+    std::unique_ptr<CChainState> m_ibd_chainstate;\n+\n+    //! A chainstate initialized on the basis of a UTXO snapshot. If this is\n+    //! non-null, it is always our active chainstate unless proven invalid.\n+    std::unique_ptr<CChainState> m_snapshot_chainstate;\n+\n+    //! Points to either the ibd or snapshot chainstate; indicates our\n+    //! most-work chain.\n+    CChainState* m_active_chainstate;\n+\n+    //! The base blockhash of the active UTXO snapshot (if one is being used)\n+    uint256 m_snapshot_blockhash{};\n+\n+    //! If true, the assumed-valid chainstate has been fully validated\n+    //! by the background validation chainstate.\n+    bool m_snapshot_validated{false};\n+\n+    // For access to m_active_chainstate.\n+    friend CChain& ChainActive();\n+\n+public:\n+    //! Instantiate a new chainstate and assign it based upon whether it is\n+    //! from a snapshot.\n+    //!\n+    //! @param[in] activate   If true, make this new chainstate the active one.\n+    //! @param[in] snapshot_blockhash   If given, signify that this chainstate\n+    //!                                 is based on a snapshot.\n+    CChainState& InitializeChainstate(\n+        bool activate = true, const uint256& snapshot_blockhash = uint256());\n+\n+    //! Get all chainstates currently being used.\n+    std::vector<CChainState*> GetAll();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r357716948",
      "id" : 357716948,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NzcxNjk0OA==",
      "original_commit_id" : "6a629cfd02907162cea4dbef86837ee4c01bf157",
      "original_position" : 91,
      "path" : "src/validation.h",
      "position" : 139,
      "pull_request_review_id" : 331955313,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737",
      "updated_at" : "2019-12-13T16:31:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/357716948",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r357719170"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/357719170"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in commit 6a629cfd029071: \r\n\r\nHow and why is this different from `return !m_ibd_chainstate`?",
      "commit_id" : "23283174f4e6f92c5eee1f7f1f94ceed8405099a",
      "created_at" : "2019-12-13T16:11:38Z",
      "diff_hunk" : "@@ -757,6 +762,111 @@ bool InvalidateBlock(BlockValidationState& state, const CChainParams& chainparam\n /** Remove invalidity status from a block and its descendants. */\n void ResetBlockFailureFlags(CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+/**\n+ * Provides an interface for creating and interacting with multiple\n+ * chainstates, as well as a means to initialize chainstates from a\n+ * UTXO snapshot. Managed chainstates can be maintained at different\n+ * heights simultaneously.\n+ *\n+ * This class provides abstractions that allow the retrieval of the current\n+ * most-work chainstate (\"Active\") as well as chainstates which may be in\n+ * background use to validate UTXO snapshots.\n+ *\n+ * A few quick definitions:\n+ *\n+ * *IBD chainstate*: a chainstate populated via initial block download.\n+ *\n+ * *Snapshot chainstate*: a chainstate populated by loading in an\n+ *    assumed-valid UTXO snapshot.\n+ *\n+ * *Active chainstate*: the chainstate containing the current most-work\n+ *    chain. Consulted by most parts of the system (net_processing,\n+ *    wallet) as a reflection of the current chain and UTXO set.\n+ *    This may either be an IBD chainstate or a snapshot chainstate.\n+ *\n+ * *Background validation chainstate*: an IBD chainstate for which the\n+ *    IBD process is happening in the background while use of the\n+ *    active chainstate allows the rest of the system to function.\n+ *\n+ * *Validated chainstate*: a chainstate whose validity is not assumed.\n+ *    This could be an IBD chainstate, or a snapshot chainstate for\n+ *    which background validation (up to the base of the snapshot)\n+ *    has completed.\n+ */\n+class ChainstateManager\n+{\n+private:\n+    //! The chainstate used under normal operation (i.e. \"regular\" IBD) or,\n+    //! if a snapshot is in use, for background validation. Its contents will\n+    //! be freed when background validation of the snapshot has completed.\n+    std::unique_ptr<CChainState> m_ibd_chainstate;\n+\n+    //! A chainstate initialized on the basis of a UTXO snapshot. If this is\n+    //! non-null, it is always our active chainstate unless proven invalid.\n+    std::unique_ptr<CChainState> m_snapshot_chainstate;\n+\n+    //! Points to either the ibd or snapshot chainstate; indicates our\n+    //! most-work chain.\n+    CChainState* m_active_chainstate;\n+\n+    //! The base blockhash of the active UTXO snapshot (if one is being used)\n+    uint256 m_snapshot_blockhash{};\n+\n+    //! If true, the assumed-valid chainstate has been fully validated\n+    //! by the background validation chainstate.\n+    bool m_snapshot_validated{false};\n+\n+    // For access to m_active_chainstate.\n+    friend CChain& ChainActive();\n+\n+public:\n+    //! Instantiate a new chainstate and assign it based upon whether it is\n+    //! from a snapshot.\n+    //!\n+    //! @param[in] activate   If true, make this new chainstate the active one.\n+    //! @param[in] snapshot_blockhash   If given, signify that this chainstate\n+    //!                                 is based on a snapshot.\n+    CChainState& InitializeChainstate(\n+        bool activate = true, const uint256& snapshot_blockhash = uint256());\n+\n+    //! Get all chainstates currently being used.\n+    std::vector<CChainState*> GetAll();\n+\n+    //! The most-work chain.\n+    CChain& ActiveChain() const;\n+    int ActiveHeight() const { return ActiveChain().Height(); }\n+    CBlockIndex* ActiveTip() const { return ActiveChain().Tip(); }\n+\n+    bool IsSnapshotActive() const;\n+\n+    uint256 SnapshotBlockhash() const { return m_snapshot_blockhash; }\n+\n+    //! Is there a snapshot in use and has it been fully validated?\n+    bool IsSnapshotValidated() const { return m_snapshot_validated; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r357719170",
      "id" : 357719170,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NzcxOTE3MA==",
      "original_commit_id" : "6a629cfd02907162cea4dbef86837ee4c01bf157",
      "original_position" : 103,
      "path" : "src/validation.h",
      "position" : 156,
      "pull_request_review_id" : 331955313,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737",
      "updated_at" : "2019-12-13T16:31:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/357719170",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r357721286"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/357721286"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in commit 6a629cfd02907162ce:\r\n\r\nI wonder if this method needs to happen under some kind of lock. Otherwise there might be a race in validation or net processing where the chainstate is switched down under during a call.",
      "commit_id" : "23283174f4e6f92c5eee1f7f1f94ceed8405099a",
      "created_at" : "2019-12-13T16:16:07Z",
      "diff_hunk" : "@@ -5116,3 +5116,68 @@ class CMainCleanup\n     }\n };\n static CMainCleanup instance_of_cmaincleanup;\n+\n+std::vector<CChainState*> ChainstateManager::GetAll()\n+{\n+    std::vector<CChainState*> out;\n+\n+    if (!IsSnapshotValidated() && m_ibd_chainstate) {\n+        out.push_back(m_ibd_chainstate.get());\n+    }\n+\n+    if (m_snapshot_chainstate) {\n+        out.push_back(m_snapshot_chainstate.get());\n+    }\n+\n+    return out;\n+}\n+\n+CChainState& ChainstateManager::InitializeChainstate(\n+    bool activate, const uint256& snapshot_blockhash)\n+{\n+    std::unique_ptr<CChainState>& to_modify = (\n+        snapshot_blockhash.IsNull() ? m_ibd_chainstate : m_snapshot_chainstate);\n+\n+    to_modify.reset(new CChainState(snapshot_blockhash));\n+\n+    if (activate) {\n+        LogPrintf(\"Switching active chainstate to %s\\n\", snapshot_blockhash.ToString());\n+        m_active_chainstate = to_modify.get();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r357721286",
      "id" : 357721286,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NzcyMTI4Ng==",
      "original_commit_id" : "6a629cfd02907162cea4dbef86837ee4c01bf157",
      "original_position" : 30,
      "path" : "src/validation.cpp",
      "position" : 255,
      "pull_request_review_id" : 331955313,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737",
      "updated_at" : "2019-12-13T16:31:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/357721286",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r357723785"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/357723785"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in commit 6a629cfd0290716:\r\n\r\nHow and why is this different from `return m_active_chainstate->m_snapshot_blockhash;`?",
      "commit_id" : "23283174f4e6f92c5eee1f7f1f94ceed8405099a",
      "created_at" : "2019-12-13T16:21:52Z",
      "diff_hunk" : "@@ -757,6 +762,111 @@ bool InvalidateBlock(BlockValidationState& state, const CChainParams& chainparam\n /** Remove invalidity status from a block and its descendants. */\n void ResetBlockFailureFlags(CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+/**\n+ * Provides an interface for creating and interacting with multiple\n+ * chainstates, as well as a means to initialize chainstates from a\n+ * UTXO snapshot. Managed chainstates can be maintained at different\n+ * heights simultaneously.\n+ *\n+ * This class provides abstractions that allow the retrieval of the current\n+ * most-work chainstate (\"Active\") as well as chainstates which may be in\n+ * background use to validate UTXO snapshots.\n+ *\n+ * A few quick definitions:\n+ *\n+ * *IBD chainstate*: a chainstate populated via initial block download.\n+ *\n+ * *Snapshot chainstate*: a chainstate populated by loading in an\n+ *    assumed-valid UTXO snapshot.\n+ *\n+ * *Active chainstate*: the chainstate containing the current most-work\n+ *    chain. Consulted by most parts of the system (net_processing,\n+ *    wallet) as a reflection of the current chain and UTXO set.\n+ *    This may either be an IBD chainstate or a snapshot chainstate.\n+ *\n+ * *Background validation chainstate*: an IBD chainstate for which the\n+ *    IBD process is happening in the background while use of the\n+ *    active chainstate allows the rest of the system to function.\n+ *\n+ * *Validated chainstate*: a chainstate whose validity is not assumed.\n+ *    This could be an IBD chainstate, or a snapshot chainstate for\n+ *    which background validation (up to the base of the snapshot)\n+ *    has completed.\n+ */\n+class ChainstateManager\n+{\n+private:\n+    //! The chainstate used under normal operation (i.e. \"regular\" IBD) or,\n+    //! if a snapshot is in use, for background validation. Its contents will\n+    //! be freed when background validation of the snapshot has completed.\n+    std::unique_ptr<CChainState> m_ibd_chainstate;\n+\n+    //! A chainstate initialized on the basis of a UTXO snapshot. If this is\n+    //! non-null, it is always our active chainstate unless proven invalid.\n+    std::unique_ptr<CChainState> m_snapshot_chainstate;\n+\n+    //! Points to either the ibd or snapshot chainstate; indicates our\n+    //! most-work chain.\n+    CChainState* m_active_chainstate;\n+\n+    //! The base blockhash of the active UTXO snapshot (if one is being used)\n+    uint256 m_snapshot_blockhash{};\n+\n+    //! If true, the assumed-valid chainstate has been fully validated\n+    //! by the background validation chainstate.\n+    bool m_snapshot_validated{false};\n+\n+    // For access to m_active_chainstate.\n+    friend CChain& ChainActive();\n+\n+public:\n+    //! Instantiate a new chainstate and assign it based upon whether it is\n+    //! from a snapshot.\n+    //!\n+    //! @param[in] activate   If true, make this new chainstate the active one.\n+    //! @param[in] snapshot_blockhash   If given, signify that this chainstate\n+    //!                                 is based on a snapshot.\n+    CChainState& InitializeChainstate(\n+        bool activate = true, const uint256& snapshot_blockhash = uint256());\n+\n+    //! Get all chainstates currently being used.\n+    std::vector<CChainState*> GetAll();\n+\n+    //! The most-work chain.\n+    CChain& ActiveChain() const;\n+    int ActiveHeight() const { return ActiveChain().Height(); }\n+    CBlockIndex* ActiveTip() const { return ActiveChain().Tip(); }\n+\n+    bool IsSnapshotActive() const;\n+\n+    uint256 SnapshotBlockhash() const { return m_snapshot_blockhash; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r357723785",
      "id" : 357723785,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NzcyMzc4NQ==",
      "original_commit_id" : "6a629cfd02907162cea4dbef86837ee4c01bf157",
      "original_position" : 100,
      "path" : "src/validation.h",
      "position" : 153,
      "pull_request_review_id" : 331955313,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737",
      "updated_at" : "2019-12-13T16:31:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/357723785",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r357727259"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/357727259"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in commit 4813167d989c:\r\n\r\nIs this comment no longer relevant?",
      "commit_id" : "23283174f4e6f92c5eee1f7f1f94ceed8405099a",
      "created_at" : "2019-12-13T16:29:30Z",
      "diff_hunk" : "@@ -1463,8 +1467,7 @@ bool AppInitMain(NodeContext& node)\n             bool is_coinsview_empty;\n             try {\n                 LOCK(cs_main);\n-                // This statement makes ::ChainstateActive() usable.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r357727259",
      "id" : 357727259,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1NzcyNzI1OQ==",
      "original_commit_id" : "4813167d989c5777eb8b5133dedd93b12e1cc207",
      "original_position" : 32,
      "path" : "src/init.cpp",
      "position" : 32,
      "pull_request_review_id" : 331955313,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737",
      "updated_at" : "2019-12-13T16:31:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/357727259",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r357890585"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/357890585"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Agree. Same question for other methods.",
      "commit_id" : "23283174f4e6f92c5eee1f7f1f94ceed8405099a",
      "created_at" : "2019-12-14T02:14:57Z",
      "diff_hunk" : "@@ -757,6 +762,111 @@ bool InvalidateBlock(BlockValidationState& state, const CChainParams& chainparam\n /** Remove invalidity status from a block and its descendants. */\n void ResetBlockFailureFlags(CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+/**\n+ * Provides an interface for creating and interacting with multiple\n+ * chainstates, as well as a means to initialize chainstates from a\n+ * UTXO snapshot. Managed chainstates can be maintained at different\n+ * heights simultaneously.\n+ *\n+ * This class provides abstractions that allow the retrieval of the current\n+ * most-work chainstate (\"Active\") as well as chainstates which may be in\n+ * background use to validate UTXO snapshots.\n+ *\n+ * A few quick definitions:\n+ *\n+ * *IBD chainstate*: a chainstate populated via initial block download.\n+ *\n+ * *Snapshot chainstate*: a chainstate populated by loading in an\n+ *    assumed-valid UTXO snapshot.\n+ *\n+ * *Active chainstate*: the chainstate containing the current most-work\n+ *    chain. Consulted by most parts of the system (net_processing,\n+ *    wallet) as a reflection of the current chain and UTXO set.\n+ *    This may either be an IBD chainstate or a snapshot chainstate.\n+ *\n+ * *Background validation chainstate*: an IBD chainstate for which the\n+ *    IBD process is happening in the background while use of the\n+ *    active chainstate allows the rest of the system to function.\n+ *\n+ * *Validated chainstate*: a chainstate whose validity is not assumed.\n+ *    This could be an IBD chainstate, or a snapshot chainstate for\n+ *    which background validation (up to the base of the snapshot)\n+ *    has completed.\n+ */\n+class ChainstateManager\n+{\n+private:\n+    //! The chainstate used under normal operation (i.e. \"regular\" IBD) or,\n+    //! if a snapshot is in use, for background validation. Its contents will\n+    //! be freed when background validation of the snapshot has completed.\n+    std::unique_ptr<CChainState> m_ibd_chainstate;\n+\n+    //! A chainstate initialized on the basis of a UTXO snapshot. If this is\n+    //! non-null, it is always our active chainstate unless proven invalid.\n+    std::unique_ptr<CChainState> m_snapshot_chainstate;\n+\n+    //! Points to either the ibd or snapshot chainstate; indicates our\n+    //! most-work chain.\n+    CChainState* m_active_chainstate;\n+\n+    //! The base blockhash of the active UTXO snapshot (if one is being used)\n+    uint256 m_snapshot_blockhash{};\n+\n+    //! If true, the assumed-valid chainstate has been fully validated\n+    //! by the background validation chainstate.\n+    bool m_snapshot_validated{false};\n+\n+    // For access to m_active_chainstate.\n+    friend CChain& ChainActive();\n+\n+public:\n+    //! Instantiate a new chainstate and assign it based upon whether it is\n+    //! from a snapshot.\n+    //!\n+    //! @param[in] activate   If true, make this new chainstate the active one.\n+    //! @param[in] snapshot_blockhash   If given, signify that this chainstate\n+    //!                                 is based on a snapshot.\n+    CChainState& InitializeChainstate(\n+        bool activate = true, const uint256& snapshot_blockhash = uint256());\n+\n+    //! Get all chainstates currently being used.\n+    std::vector<CChainState*> GetAll();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r357890585",
      "id" : 357890585,
      "in_reply_to_id" : 357716948,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1Nzg5MDU4NQ==",
      "original_commit_id" : "6a629cfd02907162cea4dbef86837ee4c01bf157",
      "original_position" : 91,
      "path" : "src/validation.h",
      "position" : 139,
      "pull_request_review_id" : 332189983,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737",
      "updated_at" : "2019-12-14T02:14:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/357890585",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r358506358"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/358506358"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "6b62d2f\r\n\r\nEven if I understand what you mean by an assumed-valid UTXO, I think it may confuse readers try to learn what's the difference is between assume-utxo and assume-valid. Wouldn't be shock by a simple `assume-utxo snapshot`.",
      "commit_id" : "23283174f4e6f92c5eee1f7f1f94ceed8405099a",
      "created_at" : "2019-12-16T22:45:42Z",
      "diff_hunk" : "@@ -757,6 +762,111 @@ bool InvalidateBlock(BlockValidationState& state, const CChainParams& chainparam\n /** Remove invalidity status from a block and its descendants. */\n void ResetBlockFailureFlags(CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+/**\n+ * Provides an interface for creating and interacting with multiple\n+ * chainstates, as well as a means to initialize chainstates from a\n+ * UTXO snapshot. Managed chainstates can be maintained at different\n+ * heights simultaneously.\n+ *\n+ * This class provides abstractions that allow the retrieval of the current\n+ * most-work chainstate (\"Active\") as well as chainstates which may be in\n+ * background use to validate UTXO snapshots.\n+ *\n+ * A few quick definitions:\n+ *\n+ * *IBD chainstate*: a chainstate populated via initial block download.\n+ *\n+ * *Snapshot chainstate*: a chainstate populated by loading in an\n+ *    assumed-valid UTXO snapshot.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r358506358",
      "id" : 358506358,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1ODUwNjM1OA==",
      "original_commit_id" : "6a629cfd02907162cea4dbef86837ee4c01bf157",
      "original_position" : 38,
      "path" : "src/validation.h",
      "position" : 81,
      "pull_request_review_id" : 332918349,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737",
      "updated_at" : "2019-12-16T23:13:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/358506358",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r358507123"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/358507123"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "6b62d2f\r\n\r\nIt's ambiguous here, do you mean a chainstate for which validity is assumed ? Overall, what's the definition of validity w.r.t to chainstates types ? I.e a IBD chainstate is always considered valid (because all consensus checks are done by us) or only when it's out-of-IBD? What's about a assume-valid IBD chainstate ?",
      "commit_id" : "23283174f4e6f92c5eee1f7f1f94ceed8405099a",
      "created_at" : "2019-12-16T22:48:01Z",
      "diff_hunk" : "@@ -757,6 +762,111 @@ bool InvalidateBlock(BlockValidationState& state, const CChainParams& chainparam\n /** Remove invalidity status from a block and its descendants. */\n void ResetBlockFailureFlags(CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+/**\n+ * Provides an interface for creating and interacting with multiple\n+ * chainstates, as well as a means to initialize chainstates from a\n+ * UTXO snapshot. Managed chainstates can be maintained at different\n+ * heights simultaneously.\n+ *\n+ * This class provides abstractions that allow the retrieval of the current\n+ * most-work chainstate (\"Active\") as well as chainstates which may be in\n+ * background use to validate UTXO snapshots.\n+ *\n+ * A few quick definitions:\n+ *\n+ * *IBD chainstate*: a chainstate populated via initial block download.\n+ *\n+ * *Snapshot chainstate*: a chainstate populated by loading in an\n+ *    assumed-valid UTXO snapshot.\n+ *\n+ * *Active chainstate*: the chainstate containing the current most-work\n+ *    chain. Consulted by most parts of the system (net_processing,\n+ *    wallet) as a reflection of the current chain and UTXO set.\n+ *    This may either be an IBD chainstate or a snapshot chainstate.\n+ *\n+ * *Background validation chainstate*: an IBD chainstate for which the\n+ *    IBD process is happening in the background while use of the\n+ *    active chainstate allows the rest of the system to function.\n+ *\n+ * *Validated chainstate*: a chainstate whose validity is not assumed.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r358507123",
      "id" : 358507123,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1ODUwNzEyMw==",
      "original_commit_id" : "6a629cfd02907162cea4dbef86837ee4c01bf157",
      "original_position" : 49,
      "path" : "src/validation.h",
      "position" : 92,
      "pull_request_review_id" : 332918349,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737",
      "updated_at" : "2019-12-16T23:13:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/358507123",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r358507922"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/358507922"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "6b62d2f\r\n\r\nLogger is weird, given than default activate is true, no blockhash is going to be display, maybe `snapshot_blockhash.IsNull ? \"an IBD one\" : snapshot_blockhash.ToString()`",
      "commit_id" : "23283174f4e6f92c5eee1f7f1f94ceed8405099a",
      "created_at" : "2019-12-16T22:50:19Z",
      "diff_hunk" : "@@ -5116,3 +5116,68 @@ class CMainCleanup\n     }\n };\n static CMainCleanup instance_of_cmaincleanup;\n+\n+std::vector<CChainState*> ChainstateManager::GetAll()\n+{\n+    std::vector<CChainState*> out;\n+\n+    if (!IsSnapshotValidated() && m_ibd_chainstate) {\n+        out.push_back(m_ibd_chainstate.get());\n+    }\n+\n+    if (m_snapshot_chainstate) {\n+        out.push_back(m_snapshot_chainstate.get());\n+    }\n+\n+    return out;\n+}\n+\n+CChainState& ChainstateManager::InitializeChainstate(\n+    bool activate, const uint256& snapshot_blockhash)\n+{\n+    std::unique_ptr<CChainState>& to_modify = (\n+        snapshot_blockhash.IsNull() ? m_ibd_chainstate : m_snapshot_chainstate);\n+\n+    to_modify.reset(new CChainState(snapshot_blockhash));\n+\n+    if (activate) {\n+        LogPrintf(\"Switching active chainstate to %s\\n\", snapshot_blockhash.ToString());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r358507922",
      "id" : 358507922,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1ODUwNzkyMg==",
      "original_commit_id" : "6a629cfd02907162cea4dbef86837ee4c01bf157",
      "original_position" : 29,
      "path" : "src/validation.cpp",
      "position" : 254,
      "pull_request_review_id" : 332918349,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737",
      "updated_at" : "2019-12-16T23:13:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/358507922",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r358508803"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/358508803"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "6b62d2f\r\n\r\nI think consequences of activating a non valid chainstate by mistake can be pretty bad, would be better to have default to false in case of buggy call of this method.",
      "commit_id" : "23283174f4e6f92c5eee1f7f1f94ceed8405099a",
      "created_at" : "2019-12-16T22:52:45Z",
      "diff_hunk" : "@@ -757,6 +762,111 @@ bool InvalidateBlock(BlockValidationState& state, const CChainParams& chainparam\n /** Remove invalidity status from a block and its descendants. */\n void ResetBlockFailureFlags(CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+/**\n+ * Provides an interface for creating and interacting with multiple\n+ * chainstates, as well as a means to initialize chainstates from a\n+ * UTXO snapshot. Managed chainstates can be maintained at different\n+ * heights simultaneously.\n+ *\n+ * This class provides abstractions that allow the retrieval of the current\n+ * most-work chainstate (\"Active\") as well as chainstates which may be in\n+ * background use to validate UTXO snapshots.\n+ *\n+ * A few quick definitions:\n+ *\n+ * *IBD chainstate*: a chainstate populated via initial block download.\n+ *\n+ * *Snapshot chainstate*: a chainstate populated by loading in an\n+ *    assumed-valid UTXO snapshot.\n+ *\n+ * *Active chainstate*: the chainstate containing the current most-work\n+ *    chain. Consulted by most parts of the system (net_processing,\n+ *    wallet) as a reflection of the current chain and UTXO set.\n+ *    This may either be an IBD chainstate or a snapshot chainstate.\n+ *\n+ * *Background validation chainstate*: an IBD chainstate for which the\n+ *    IBD process is happening in the background while use of the\n+ *    active chainstate allows the rest of the system to function.\n+ *\n+ * *Validated chainstate*: a chainstate whose validity is not assumed.\n+ *    This could be an IBD chainstate, or a snapshot chainstate for\n+ *    which background validation (up to the base of the snapshot)\n+ *    has completed.\n+ */\n+class ChainstateManager\n+{\n+private:\n+    //! The chainstate used under normal operation (i.e. \"regular\" IBD) or,\n+    //! if a snapshot is in use, for background validation. Its contents will\n+    //! be freed when background validation of the snapshot has completed.\n+    std::unique_ptr<CChainState> m_ibd_chainstate;\n+\n+    //! A chainstate initialized on the basis of a UTXO snapshot. If this is\n+    //! non-null, it is always our active chainstate unless proven invalid.\n+    std::unique_ptr<CChainState> m_snapshot_chainstate;\n+\n+    //! Points to either the ibd or snapshot chainstate; indicates our\n+    //! most-work chain.\n+    CChainState* m_active_chainstate;\n+\n+    //! The base blockhash of the active UTXO snapshot (if one is being used)\n+    uint256 m_snapshot_blockhash{};\n+\n+    //! If true, the assumed-valid chainstate has been fully validated\n+    //! by the background validation chainstate.\n+    bool m_snapshot_validated{false};\n+\n+    // For access to m_active_chainstate.\n+    friend CChain& ChainActive();\n+\n+public:\n+    //! Instantiate a new chainstate and assign it based upon whether it is\n+    //! from a snapshot.\n+    //!\n+    //! @param[in] activate   If true, make this new chainstate the active one.\n+    //! @param[in] snapshot_blockhash   If given, signify that this chainstate\n+    //!                                 is based on a snapshot.\n+    CChainState& InitializeChainstate(\n+        bool activate = true, const uint256& snapshot_blockhash = uint256());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r358508803",
      "id" : 358508803,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1ODUwODgwMw==",
      "original_commit_id" : "6a629cfd02907162cea4dbef86837ee4c01bf157",
      "original_position" : 88,
      "path" : "src/validation.h",
      "position" : 136,
      "pull_request_review_id" : 332918349,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737",
      "updated_at" : "2019-12-16T23:13:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/358508803",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r358510858"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/358510858"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Agree, could be removed in GetAll, if idea is to garbage collect m_ibd_chainstate when foreground utxo get validated",
      "commit_id" : "23283174f4e6f92c5eee1f7f1f94ceed8405099a",
      "created_at" : "2019-12-16T22:58:22Z",
      "diff_hunk" : "@@ -757,6 +762,111 @@ bool InvalidateBlock(BlockValidationState& state, const CChainParams& chainparam\n /** Remove invalidity status from a block and its descendants. */\n void ResetBlockFailureFlags(CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+/**\n+ * Provides an interface for creating and interacting with multiple\n+ * chainstates, as well as a means to initialize chainstates from a\n+ * UTXO snapshot. Managed chainstates can be maintained at different\n+ * heights simultaneously.\n+ *\n+ * This class provides abstractions that allow the retrieval of the current\n+ * most-work chainstate (\"Active\") as well as chainstates which may be in\n+ * background use to validate UTXO snapshots.\n+ *\n+ * A few quick definitions:\n+ *\n+ * *IBD chainstate*: a chainstate populated via initial block download.\n+ *\n+ * *Snapshot chainstate*: a chainstate populated by loading in an\n+ *    assumed-valid UTXO snapshot.\n+ *\n+ * *Active chainstate*: the chainstate containing the current most-work\n+ *    chain. Consulted by most parts of the system (net_processing,\n+ *    wallet) as a reflection of the current chain and UTXO set.\n+ *    This may either be an IBD chainstate or a snapshot chainstate.\n+ *\n+ * *Background validation chainstate*: an IBD chainstate for which the\n+ *    IBD process is happening in the background while use of the\n+ *    active chainstate allows the rest of the system to function.\n+ *\n+ * *Validated chainstate*: a chainstate whose validity is not assumed.\n+ *    This could be an IBD chainstate, or a snapshot chainstate for\n+ *    which background validation (up to the base of the snapshot)\n+ *    has completed.\n+ */\n+class ChainstateManager\n+{\n+private:\n+    //! The chainstate used under normal operation (i.e. \"regular\" IBD) or,\n+    //! if a snapshot is in use, for background validation. Its contents will\n+    //! be freed when background validation of the snapshot has completed.\n+    std::unique_ptr<CChainState> m_ibd_chainstate;\n+\n+    //! A chainstate initialized on the basis of a UTXO snapshot. If this is\n+    //! non-null, it is always our active chainstate unless proven invalid.\n+    std::unique_ptr<CChainState> m_snapshot_chainstate;\n+\n+    //! Points to either the ibd or snapshot chainstate; indicates our\n+    //! most-work chain.\n+    CChainState* m_active_chainstate;\n+\n+    //! The base blockhash of the active UTXO snapshot (if one is being used)\n+    uint256 m_snapshot_blockhash{};\n+\n+    //! If true, the assumed-valid chainstate has been fully validated\n+    //! by the background validation chainstate.\n+    bool m_snapshot_validated{false};\n+\n+    // For access to m_active_chainstate.\n+    friend CChain& ChainActive();\n+\n+public:\n+    //! Instantiate a new chainstate and assign it based upon whether it is\n+    //! from a snapshot.\n+    //!\n+    //! @param[in] activate   If true, make this new chainstate the active one.\n+    //! @param[in] snapshot_blockhash   If given, signify that this chainstate\n+    //!                                 is based on a snapshot.\n+    CChainState& InitializeChainstate(\n+        bool activate = true, const uint256& snapshot_blockhash = uint256());\n+\n+    //! Get all chainstates currently being used.\n+    std::vector<CChainState*> GetAll();\n+\n+    //! The most-work chain.\n+    CChain& ActiveChain() const;\n+    int ActiveHeight() const { return ActiveChain().Height(); }\n+    CBlockIndex* ActiveTip() const { return ActiveChain().Tip(); }\n+\n+    bool IsSnapshotActive() const;\n+\n+    uint256 SnapshotBlockhash() const { return m_snapshot_blockhash; }\n+\n+    //! Is there a snapshot in use and has it been fully validated?\n+    bool IsSnapshotValidated() const { return m_snapshot_validated; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r358510858",
      "id" : 358510858,
      "in_reply_to_id" : 357719170,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1ODUxMDg1OA==",
      "original_commit_id" : "6a629cfd02907162cea4dbef86837ee4c01bf157",
      "original_position" : 103,
      "path" : "src/validation.h",
      "position" : 156,
      "pull_request_review_id" : 332918349,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737",
      "updated_at" : "2019-12-16T23:13:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/358510858",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r358511242"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/358511242"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "6a629cf\r\n\r\nnit: you can move body function to validation.cpp, like `IsSnapshotActive`",
      "commit_id" : "23283174f4e6f92c5eee1f7f1f94ceed8405099a",
      "created_at" : "2019-12-16T22:59:21Z",
      "diff_hunk" : "@@ -757,6 +762,111 @@ bool InvalidateBlock(BlockValidationState& state, const CChainParams& chainparam\n /** Remove invalidity status from a block and its descendants. */\n void ResetBlockFailureFlags(CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+/**\n+ * Provides an interface for creating and interacting with multiple\n+ * chainstates, as well as a means to initialize chainstates from a\n+ * UTXO snapshot. Managed chainstates can be maintained at different\n+ * heights simultaneously.\n+ *\n+ * This class provides abstractions that allow the retrieval of the current\n+ * most-work chainstate (\"Active\") as well as chainstates which may be in\n+ * background use to validate UTXO snapshots.\n+ *\n+ * A few quick definitions:\n+ *\n+ * *IBD chainstate*: a chainstate populated via initial block download.\n+ *\n+ * *Snapshot chainstate*: a chainstate populated by loading in an\n+ *    assumed-valid UTXO snapshot.\n+ *\n+ * *Active chainstate*: the chainstate containing the current most-work\n+ *    chain. Consulted by most parts of the system (net_processing,\n+ *    wallet) as a reflection of the current chain and UTXO set.\n+ *    This may either be an IBD chainstate or a snapshot chainstate.\n+ *\n+ * *Background validation chainstate*: an IBD chainstate for which the\n+ *    IBD process is happening in the background while use of the\n+ *    active chainstate allows the rest of the system to function.\n+ *\n+ * *Validated chainstate*: a chainstate whose validity is not assumed.\n+ *    This could be an IBD chainstate, or a snapshot chainstate for\n+ *    which background validation (up to the base of the snapshot)\n+ *    has completed.\n+ */\n+class ChainstateManager\n+{\n+private:\n+    //! The chainstate used under normal operation (i.e. \"regular\" IBD) or,\n+    //! if a snapshot is in use, for background validation. Its contents will\n+    //! be freed when background validation of the snapshot has completed.\n+    std::unique_ptr<CChainState> m_ibd_chainstate;\n+\n+    //! A chainstate initialized on the basis of a UTXO snapshot. If this is\n+    //! non-null, it is always our active chainstate unless proven invalid.\n+    std::unique_ptr<CChainState> m_snapshot_chainstate;\n+\n+    //! Points to either the ibd or snapshot chainstate; indicates our\n+    //! most-work chain.\n+    CChainState* m_active_chainstate;\n+\n+    //! The base blockhash of the active UTXO snapshot (if one is being used)\n+    uint256 m_snapshot_blockhash{};\n+\n+    //! If true, the assumed-valid chainstate has been fully validated\n+    //! by the background validation chainstate.\n+    bool m_snapshot_validated{false};\n+\n+    // For access to m_active_chainstate.\n+    friend CChain& ChainActive();\n+\n+public:\n+    //! Instantiate a new chainstate and assign it based upon whether it is\n+    //! from a snapshot.\n+    //!\n+    //! @param[in] activate   If true, make this new chainstate the active one.\n+    //! @param[in] snapshot_blockhash   If given, signify that this chainstate\n+    //!                                 is based on a snapshot.\n+    CChainState& InitializeChainstate(\n+        bool activate = true, const uint256& snapshot_blockhash = uint256());\n+\n+    //! Get all chainstates currently being used.\n+    std::vector<CChainState*> GetAll();\n+\n+    //! The most-work chain.\n+    CChain& ActiveChain() const;\n+    int ActiveHeight() const { return ActiveChain().Height(); }\n+    CBlockIndex* ActiveTip() const { return ActiveChain().Tip(); }\n+\n+    bool IsSnapshotActive() const;\n+\n+    uint256 SnapshotBlockhash() const { return m_snapshot_blockhash; }\n+\n+    //! Is there a snapshot in use and has it been fully validated?\n+    bool IsSnapshotValidated() const { return m_snapshot_validated; }\n+\n+    //! @returns true if this chainstate is being used to validate an active\n+    //!          snapshot in the background.\n+    bool IsBackgroundValidationChainstate(CChainState* chainstate) const\n+    {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r358511242",
      "id" : 358511242,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1ODUxMTI0Mg==",
      "original_commit_id" : "6a629cfd02907162cea4dbef86837ee4c01bf157",
      "original_position" : 108,
      "path" : "src/validation.h",
      "position" : 161,
      "pull_request_review_id" : 332918349,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737",
      "updated_at" : "2019-12-16T23:13:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/358511242",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r358511722"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/358511722"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "6a629cf\r\n\r\nMaybe reset `m_snapshot_blockhash` to null and `m_snapshot_validated` to false?",
      "commit_id" : "23283174f4e6f92c5eee1f7f1f94ceed8405099a",
      "created_at" : "2019-12-16T23:00:48Z",
      "diff_hunk" : "@@ -5116,3 +5116,68 @@ class CMainCleanup\n     }\n };\n static CMainCleanup instance_of_cmaincleanup;\n+\n+std::vector<CChainState*> ChainstateManager::GetAll()\n+{\n+    std::vector<CChainState*> out;\n+\n+    if (!IsSnapshotValidated() && m_ibd_chainstate) {\n+        out.push_back(m_ibd_chainstate.get());\n+    }\n+\n+    if (m_snapshot_chainstate) {\n+        out.push_back(m_snapshot_chainstate.get());\n+    }\n+\n+    return out;\n+}\n+\n+CChainState& ChainstateManager::InitializeChainstate(\n+    bool activate, const uint256& snapshot_blockhash)\n+{\n+    std::unique_ptr<CChainState>& to_modify = (\n+        snapshot_blockhash.IsNull() ? m_ibd_chainstate : m_snapshot_chainstate);\n+\n+    to_modify.reset(new CChainState(snapshot_blockhash));\n+\n+    if (activate) {\n+        LogPrintf(\"Switching active chainstate to %s\\n\", snapshot_blockhash.ToString());\n+        m_active_chainstate = to_modify.get();\n+    }\n+\n+    return *to_modify.get();\n+}\n+\n+CChain& ChainstateManager::ActiveChain() const\n+{\n+    return m_active_chainstate->m_chain;\n+}\n+\n+bool ChainstateManager::IsSnapshotActive() const\n+{\n+    return m_snapshot_chainstate && m_active_chainstate == m_snapshot_chainstate.get();\n+}\n+\n+CChainState& ChainstateManager::ValidatedChainstate() const\n+{\n+    if (m_snapshot_chainstate && IsSnapshotValidated()) {\n+        return *m_snapshot_chainstate.get();\n+    }\n+    assert(m_ibd_chainstate);\n+    return *m_ibd_chainstate.get();\n+}\n+\n+void ChainstateManager::Unload()\n+{\n+    for (CChainState* chainstate : this->GetAll()) {\n+        chainstate->m_chain.SetTip(nullptr);\n+        chainstate->UnloadBlockIndex();\n+    }\n+}\n+\n+void ChainstateManager::Reset()\n+{\n+    m_ibd_chainstate.reset();\n+    m_snapshot_chainstate.reset();\n+    m_active_chainstate = nullptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r358511722",
      "id" : 358511722,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1ODUxMTcyMg==",
      "original_commit_id" : "6a629cfd02907162cea4dbef86837ee4c01bf157",
      "original_position" : 67,
      "path" : "src/validation.cpp",
      "position" : 294,
      "pull_request_review_id" : 332918349,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737",
      "updated_at" : "2019-12-16T23:13:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/358511722",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r358514335"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/358514335"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "175e570\r\n\r\nI'm not sure if `RewindBlockIndex` is still relevant.\r\n\r\nFollowing Suhas comment https://github.com/bitcoin/bitcoin/pull/8149#issuecomment-257943026, it was added to let upgrading nodes after segwit activation redownload consensus data without redownloading the whole blockchain.\r\n\r\nAccording to sipa in #15402, the rewinding logic \"is probably becoming increasingly unnecessary, as very few pre-0.13.1 nodes remain that would care to upgrade\".\r\n\r\nFurther, it doesn't make sense for the assumed-valid UTXO chainstate to rewind until first insufficiently-validated block, all utxo hash are going to be post segwit. It only makes sense for the ibd chainstate. ",
      "commit_id" : "23283174f4e6f92c5eee1f7f1f94ceed8405099a",
      "created_at" : "2019-12-16T23:08:56Z",
      "diff_hunk" : "@@ -1566,7 +1566,7 @@ bool AppInitMain(NodeContext& node)\n                 // It both disconnects blocks based on ::ChainActive(), and drops block data in\n                 // BlockIndex() based on lack of available witness data.\n                 uiInterface.InitMessage(_(\"Rewinding blocks...\").translated);\n-                if (!RewindBlockIndex(chainparams)) {\n+                if (!::ChainstateActive().RewindBlockIndex(chainparams)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r358514335",
      "id" : 358514335,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1ODUxNDMzNQ==",
      "original_commit_id" : "175e5704ad6b1ceaaaf7925d36045e7e7700a6ff",
      "original_position" : 5,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 332918349,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737",
      "updated_at" : "2019-12-16T23:13:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/358514335",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r358515509"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/358515509"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "4813167\r\n\r\nJust iterate for the `VerifyDB`, pruning and best block seen by RPC maybe should be common to both chainstates ?",
      "commit_id" : "23283174f4e6f92c5eee1f7f1f94ceed8405099a",
      "created_at" : "2019-12-16T23:12:43Z",
      "diff_hunk" : "@@ -1517,93 +1520,125 @@ bool AppInitMain(NodeContext& node)\n                 // At this point we're either in reindex or we've loaded a useful\n                 // block tree into BlockIndex()!\n \n-                ::ChainstateActive().InitCoinsDB(\n-                    /* cache_size_bytes */ nCoinDBCache,\n-                    /* in_memory */ false,\n-                    /* should_wipe */ fReset || fReindexChainState);\n-\n-                ::ChainstateActive().CoinsErrorCatcher().AddReadErrCallback([]() {\n-                    uiInterface.ThreadSafeMessageBox(\n-                        _(\"Error reading from database, shutting down.\").translated,\n-                        \"\", CClientUIInterface::MSG_ERROR);\n-                });\n-\n-                // If necessary, upgrade from older database format.\n-                // This is a no-op if we cleared the coinsviewdb with -reindex or -reindex-chainstate\n-                if (!::ChainstateActive().CoinsDB().Upgrade()) {\n-                    strLoadError = _(\"Error upgrading chainstate database\").translated;\n-                    break;\n-                }\n-\n-                // ReplayBlocks is a no-op if we cleared the coinsviewdb with -reindex or -reindex-chainstate\n-                if (!::ChainstateActive().ReplayBlocks(chainparams)) {\n-                    strLoadError = _(\"Unable to replay blocks. You will need to rebuild the database using -reindex-chainstate.\").translated;\n-                    break;\n-                }\n-\n-                // The on-disk coinsdb is now in a good state, create the cache\n-                ::ChainstateActive().InitCoinsCache();\n-                assert(::ChainstateActive().CanFlushToDisk());\n+                bool failed_chainstate_init = false;\n+\n+                for (CChainState* chainstate : g_chainman.GetAll()) {\n+                    LogPrintf(\"Initializing chainstate %s\\n\", chainstate->ToString());\n+                    chainstate->InitCoinsDB(\n+                        /* cache_size_bytes */ nCoinDBCache,\n+                        /* in_memory */ false,\n+                        /* should_wipe */ fReset || fReindexChainState);\n+\n+                    chainstate->CoinsErrorCatcher().AddReadErrCallback([]() {\n+                        uiInterface.ThreadSafeMessageBox(\n+                            _(\"Error reading from database, shutting down.\").translated,\n+                            \"\", CClientUIInterface::MSG_ERROR);\n+                    });\n+\n+                    // If necessary, upgrade from older database format.\n+                    // This is a no-op if we cleared the coinsviewdb with -reindex or -reindex-chainstate\n+                    if (!chainstate->CoinsDB().Upgrade()) {\n+                        strLoadError = _(\"Error upgrading chainstate database\").translated;\n+                        failed_chainstate_init = true;\n+                        break;\n+                    }\n \n-                is_coinsview_empty = fReset || fReindexChainState ||\n-                    ::ChainstateActive().CoinsTip().GetBestBlock().IsNull();\n-                if (!is_coinsview_empty) {\n-                    // LoadChainTip initializes the chain based on CoinsTip()'s best block\n-                    if (!::ChainstateActive().LoadChainTip(chainparams)) {\n-                        strLoadError = _(\"Error initializing block database\").translated;\n+                    // ReplayBlocks is a no-op if we cleared the coinsviewdb with -reindex or -reindex-chainstate\n+                    if (!chainstate->ReplayBlocks(chainparams)) {\n+                        strLoadError = _(\"Unable to replay blocks. You will need to rebuild the database using -reindex-chainstate.\").translated;\n+                        failed_chainstate_init = true;\n                         break;\n                     }\n-                    assert(::ChainActive().Tip() != nullptr);\n+\n+                    // The on-disk coinsdb is now in a good state, create the cache\n+                    chainstate->InitCoinsCache();\n+                    assert(chainstate->CanFlushToDisk());\n+\n+                    is_coinsview_empty = fReset || fReindexChainState ||\n+                        chainstate->CoinsTip().GetBestBlock().IsNull();\n+                    if (!is_coinsview_empty) {\n+                        // LoadChainTip initializes the chain based on CoinsTip()'s best block\n+                        if (!chainstate->LoadChainTip(chainparams)) {\n+                            strLoadError = _(\"Error initializing block database\").translated;\n+                            failed_chainstate_init = true;\n+                            break;\n+                        }\n+                        assert(chainstate->m_chain.Tip() != nullptr);\n+                    }\n+                }\n+\n+                if (failed_chainstate_init) {\n+                    // Necessary to have a break here because the above breaks\n+                    // are local to the per-chainstate loop.\n+                    break;\n                 }\n             } catch (const std::exception& e) {\n                 LogPrintf(\"%s\\n\", e.what());\n                 strLoadError = _(\"Error opening block database\").translated;\n                 break;\n             }\n \n-            if (!fReset) {\n-                // Note that RewindBlockIndex MUST run even if we're about to -reindex-chainstate.\n-                // It both disconnects blocks based on ::ChainActive(), and drops block data in\n-                // BlockIndex() based on lack of available witness data.\n-                uiInterface.InitMessage(_(\"Rewinding blocks...\").translated);\n-                if (!::ChainstateActive().RewindBlockIndex(chainparams)) {\n-                    strLoadError = _(\"Unable to rewind the database to a pre-fork state. You will need to redownload the blockchain\").translated;\n-                    break;\n+            for (CChainState* chainstate : g_chainman.GetAll()) {\n+                if (!fReset) {\n+                    // Note that RewindBlockIndex MUST run even if we're about to -reindex-chainstate.\n+                    // It both disconnects blocks based on ::ChainActive(), and drops block data in\n+                    // BlockIndex() based on lack of available witness data.\n+                    uiInterface.InitMessage(_(\"Rewinding blocks...\").translated);\n+                    if (!chainstate->RewindBlockIndex(chainparams)) {\n+                        strLoadError = _(\n+                            \"Unable to rewind the database to a pre-fork state. \"\n+                            \"You will need to redownload the blockchain\").translated;\n+                        break;\n+                    }\n                 }\n             }\n \n+            bool failed_verification = false;\n+\n             try {\n                 LOCK(cs_main);\n-                if (!is_coinsview_empty) {\n-                    uiInterface.InitMessage(_(\"Verifying blocks...\").translated);\n-                    if (fHavePruned && gArgs.GetArg(\"-checkblocks\", DEFAULT_CHECKBLOCKS) > MIN_BLOCKS_TO_KEEP) {\n-                        LogPrintf(\"Prune: pruned datadir may not have more than %d blocks; only checking available blocks\\n\",\n-                            MIN_BLOCKS_TO_KEEP);\n-                    }\n-\n-                    CBlockIndex* tip = ::ChainActive().Tip();\n-                    RPCNotifyBlockChange(true, tip);\n-                    if (tip && tip->nTime > GetAdjustedTime() + 2 * 60 * 60) {\n-                        strLoadError = _(\"The block database contains a block which appears to be from the future. \"\n-                                \"This may be due to your computer's date and time being set incorrectly. \"\n-                                \"Only rebuild the block database if you are sure that your computer's date and time are correct\").translated;\n-                        break;\n-                    }\n \n-                    if (!CVerifyDB().VerifyDB(chainparams, &::ChainstateActive().CoinsDB(), gArgs.GetArg(\"-checklevel\", DEFAULT_CHECKLEVEL),\n-                                  gArgs.GetArg(\"-checkblocks\", DEFAULT_CHECKBLOCKS))) {\n-                        strLoadError = _(\"Corrupted block database detected\").translated;\n-                        break;\n+                for (CChainState* chainstate : g_chainman.GetAll()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r358515509",
      "id" : 358515509,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1ODUxNTUwOQ==",
      "original_commit_id" : "4813167d989c5777eb8b5133dedd93b12e1cc207",
      "original_position" : 181,
      "path" : "src/init.cpp",
      "position" : 181,
      "pull_request_review_id" : 332918349,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737",
      "updated_at" : "2019-12-16T23:13:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/358515509",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r358853789"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/358853789"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks for raising this point. Initially, I had all pointers in the ChainstateManager protected by a private `m_cs` lock. I later found that there were irreconcilable lock inversions that happened during initialization - because a function like `ChainActive()` would necessarily have to acquire `ChainstateManager.m_cs`, there were many tricky inversions that happened between that lock and others like `cs_main` since ChainActive() is used so pervasively throughout the code. \r\n\r\nAs a result, I removed the chainman-specific lock and replaced it with `cs_main` in a later commit (https://github.com/bitcoin/bitcoin/pull/15606/commits/f1fa917e2081dd8d1847cbb23a0eae5a2cded2e5). Because ChainActive() isn't formally annotated as being protected by cs_main, and use of ChainstateManager always happens while under the protection of cs_main, I figured I could forgo adding those annotations now. But now that the point has been raised, I think it's probably worth addressing in this PR. \r\n\r\nSo I'll add the `cs_main` annotations to the relevant ChainManager parts. Though of course this will entail annotating ChainActive() and there will come with many other (mostly trivial) changes.",
      "commit_id" : "23283174f4e6f92c5eee1f7f1f94ceed8405099a",
      "created_at" : "2019-12-17T15:23:30Z",
      "diff_hunk" : "@@ -757,6 +762,111 @@ bool InvalidateBlock(BlockValidationState& state, const CChainParams& chainparam\n /** Remove invalidity status from a block and its descendants. */\n void ResetBlockFailureFlags(CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+/**\n+ * Provides an interface for creating and interacting with multiple\n+ * chainstates, as well as a means to initialize chainstates from a\n+ * UTXO snapshot. Managed chainstates can be maintained at different\n+ * heights simultaneously.\n+ *\n+ * This class provides abstractions that allow the retrieval of the current\n+ * most-work chainstate (\"Active\") as well as chainstates which may be in\n+ * background use to validate UTXO snapshots.\n+ *\n+ * A few quick definitions:\n+ *\n+ * *IBD chainstate*: a chainstate populated via initial block download.\n+ *\n+ * *Snapshot chainstate*: a chainstate populated by loading in an\n+ *    assumed-valid UTXO snapshot.\n+ *\n+ * *Active chainstate*: the chainstate containing the current most-work\n+ *    chain. Consulted by most parts of the system (net_processing,\n+ *    wallet) as a reflection of the current chain and UTXO set.\n+ *    This may either be an IBD chainstate or a snapshot chainstate.\n+ *\n+ * *Background validation chainstate*: an IBD chainstate for which the\n+ *    IBD process is happening in the background while use of the\n+ *    active chainstate allows the rest of the system to function.\n+ *\n+ * *Validated chainstate*: a chainstate whose validity is not assumed.\n+ *    This could be an IBD chainstate, or a snapshot chainstate for\n+ *    which background validation (up to the base of the snapshot)\n+ *    has completed.\n+ */\n+class ChainstateManager\n+{\n+private:\n+    //! The chainstate used under normal operation (i.e. \"regular\" IBD) or,\n+    //! if a snapshot is in use, for background validation. Its contents will\n+    //! be freed when background validation of the snapshot has completed.\n+    std::unique_ptr<CChainState> m_ibd_chainstate;\n+\n+    //! A chainstate initialized on the basis of a UTXO snapshot. If this is\n+    //! non-null, it is always our active chainstate unless proven invalid.\n+    std::unique_ptr<CChainState> m_snapshot_chainstate;\n+\n+    //! Points to either the ibd or snapshot chainstate; indicates our\n+    //! most-work chain.\n+    CChainState* m_active_chainstate;\n+\n+    //! The base blockhash of the active UTXO snapshot (if one is being used)\n+    uint256 m_snapshot_blockhash{};\n+\n+    //! If true, the assumed-valid chainstate has been fully validated\n+    //! by the background validation chainstate.\n+    bool m_snapshot_validated{false};\n+\n+    // For access to m_active_chainstate.\n+    friend CChain& ChainActive();\n+\n+public:\n+    //! Instantiate a new chainstate and assign it based upon whether it is\n+    //! from a snapshot.\n+    //!\n+    //! @param[in] activate   If true, make this new chainstate the active one.\n+    //! @param[in] snapshot_blockhash   If given, signify that this chainstate\n+    //!                                 is based on a snapshot.\n+    CChainState& InitializeChainstate(\n+        bool activate = true, const uint256& snapshot_blockhash = uint256());\n+\n+    //! Get all chainstates currently being used.\n+    std::vector<CChainState*> GetAll();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r358853789",
      "id" : 358853789,
      "in_reply_to_id" : 357716948,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1ODg1Mzc4OQ==",
      "original_commit_id" : "6a629cfd02907162cea4dbef86837ee4c01bf157",
      "original_position" : 91,
      "path" : "src/validation.h",
      "position" : 139,
      "pull_request_review_id" : 333356348,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737",
      "updated_at" : "2019-12-17T15:23:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/358853789",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r358858324"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/358858324"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Also, it's worth noting that the comment you quote is out of date (my fault!). We don't actually free the contents of the background validation chainstate *immediately* when validation completes - [we do it during shutdown](https://github.com/bitcoin/bitcoin/pull/15606/commits/8d6e0c34c32c5b95c126a963b16b5aebf707acbd#diff-24efdb00bfbe56b140fb006b562cc70bR5653-R5679) when `g_chainman.Reset()` is called. \r\n\r\nThe reason I don't do it immediately after validation is complete is so that we can be sure that no other parts of the code are still making reference to that pointer. This also relates to your question below about `IsSnapshotValidated()` - the extra piece of state (`m_snapshot_validated`) is used to track whether or not we need to do this cleanup.",
      "commit_id" : "23283174f4e6f92c5eee1f7f1f94ceed8405099a",
      "created_at" : "2019-12-17T15:30:30Z",
      "diff_hunk" : "@@ -757,6 +762,111 @@ bool InvalidateBlock(BlockValidationState& state, const CChainParams& chainparam\n /** Remove invalidity status from a block and its descendants. */\n void ResetBlockFailureFlags(CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+/**\n+ * Provides an interface for creating and interacting with multiple\n+ * chainstates, as well as a means to initialize chainstates from a\n+ * UTXO snapshot. Managed chainstates can be maintained at different\n+ * heights simultaneously.\n+ *\n+ * This class provides abstractions that allow the retrieval of the current\n+ * most-work chainstate (\"Active\") as well as chainstates which may be in\n+ * background use to validate UTXO snapshots.\n+ *\n+ * A few quick definitions:\n+ *\n+ * *IBD chainstate*: a chainstate populated via initial block download.\n+ *\n+ * *Snapshot chainstate*: a chainstate populated by loading in an\n+ *    assumed-valid UTXO snapshot.\n+ *\n+ * *Active chainstate*: the chainstate containing the current most-work\n+ *    chain. Consulted by most parts of the system (net_processing,\n+ *    wallet) as a reflection of the current chain and UTXO set.\n+ *    This may either be an IBD chainstate or a snapshot chainstate.\n+ *\n+ * *Background validation chainstate*: an IBD chainstate for which the\n+ *    IBD process is happening in the background while use of the\n+ *    active chainstate allows the rest of the system to function.\n+ *\n+ * *Validated chainstate*: a chainstate whose validity is not assumed.\n+ *    This could be an IBD chainstate, or a snapshot chainstate for\n+ *    which background validation (up to the base of the snapshot)\n+ *    has completed.\n+ */\n+class ChainstateManager\n+{\n+private:\n+    //! The chainstate used under normal operation (i.e. \"regular\" IBD) or,\n+    //! if a snapshot is in use, for background validation. Its contents will\n+    //! be freed when background validation of the snapshot has completed.\n+    std::unique_ptr<CChainState> m_ibd_chainstate;\n+\n+    //! A chainstate initialized on the basis of a UTXO snapshot. If this is\n+    //! non-null, it is always our active chainstate unless proven invalid.\n+    std::unique_ptr<CChainState> m_snapshot_chainstate;\n+\n+    //! Points to either the ibd or snapshot chainstate; indicates our\n+    //! most-work chain.\n+    CChainState* m_active_chainstate;\n+\n+    //! The base blockhash of the active UTXO snapshot (if one is being used)\n+    uint256 m_snapshot_blockhash{};\n+\n+    //! If true, the assumed-valid chainstate has been fully validated\n+    //! by the background validation chainstate.\n+    bool m_snapshot_validated{false};\n+\n+    // For access to m_active_chainstate.\n+    friend CChain& ChainActive();\n+\n+public:\n+    //! Instantiate a new chainstate and assign it based upon whether it is\n+    //! from a snapshot.\n+    //!\n+    //! @param[in] activate   If true, make this new chainstate the active one.\n+    //! @param[in] snapshot_blockhash   If given, signify that this chainstate\n+    //!                                 is based on a snapshot.\n+    CChainState& InitializeChainstate(\n+        bool activate = true, const uint256& snapshot_blockhash = uint256());\n+\n+    //! Get all chainstates currently being used.\n+    std::vector<CChainState*> GetAll();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r358858324",
      "id" : 358858324,
      "in_reply_to_id" : 357716948,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1ODg1ODMyNA==",
      "original_commit_id" : "6a629cfd02907162cea4dbef86837ee4c01bf157",
      "original_position" : 91,
      "path" : "src/validation.h",
      "position" : 139,
      "pull_request_review_id" : 333362196,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737",
      "updated_at" : "2019-12-17T15:30:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/358858324",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r358859057"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/358859057"
         }
      },
      "author_association" : "MEMBER",
      "body" : "See my comment above for background: https://github.com/bitcoin/bitcoin/pull/17737#discussion_r358858324. Perhaps we can do this without necessarily needing to maintain extra state (`m_snapshot_validated`) for it. I'll look into it.",
      "commit_id" : "23283174f4e6f92c5eee1f7f1f94ceed8405099a",
      "created_at" : "2019-12-17T15:31:40Z",
      "diff_hunk" : "@@ -757,6 +762,111 @@ bool InvalidateBlock(BlockValidationState& state, const CChainParams& chainparam\n /** Remove invalidity status from a block and its descendants. */\n void ResetBlockFailureFlags(CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+/**\n+ * Provides an interface for creating and interacting with multiple\n+ * chainstates, as well as a means to initialize chainstates from a\n+ * UTXO snapshot. Managed chainstates can be maintained at different\n+ * heights simultaneously.\n+ *\n+ * This class provides abstractions that allow the retrieval of the current\n+ * most-work chainstate (\"Active\") as well as chainstates which may be in\n+ * background use to validate UTXO snapshots.\n+ *\n+ * A few quick definitions:\n+ *\n+ * *IBD chainstate*: a chainstate populated via initial block download.\n+ *\n+ * *Snapshot chainstate*: a chainstate populated by loading in an\n+ *    assumed-valid UTXO snapshot.\n+ *\n+ * *Active chainstate*: the chainstate containing the current most-work\n+ *    chain. Consulted by most parts of the system (net_processing,\n+ *    wallet) as a reflection of the current chain and UTXO set.\n+ *    This may either be an IBD chainstate or a snapshot chainstate.\n+ *\n+ * *Background validation chainstate*: an IBD chainstate for which the\n+ *    IBD process is happening in the background while use of the\n+ *    active chainstate allows the rest of the system to function.\n+ *\n+ * *Validated chainstate*: a chainstate whose validity is not assumed.\n+ *    This could be an IBD chainstate, or a snapshot chainstate for\n+ *    which background validation (up to the base of the snapshot)\n+ *    has completed.\n+ */\n+class ChainstateManager\n+{\n+private:\n+    //! The chainstate used under normal operation (i.e. \"regular\" IBD) or,\n+    //! if a snapshot is in use, for background validation. Its contents will\n+    //! be freed when background validation of the snapshot has completed.\n+    std::unique_ptr<CChainState> m_ibd_chainstate;\n+\n+    //! A chainstate initialized on the basis of a UTXO snapshot. If this is\n+    //! non-null, it is always our active chainstate unless proven invalid.\n+    std::unique_ptr<CChainState> m_snapshot_chainstate;\n+\n+    //! Points to either the ibd or snapshot chainstate; indicates our\n+    //! most-work chain.\n+    CChainState* m_active_chainstate;\n+\n+    //! The base blockhash of the active UTXO snapshot (if one is being used)\n+    uint256 m_snapshot_blockhash{};\n+\n+    //! If true, the assumed-valid chainstate has been fully validated\n+    //! by the background validation chainstate.\n+    bool m_snapshot_validated{false};\n+\n+    // For access to m_active_chainstate.\n+    friend CChain& ChainActive();\n+\n+public:\n+    //! Instantiate a new chainstate and assign it based upon whether it is\n+    //! from a snapshot.\n+    //!\n+    //! @param[in] activate   If true, make this new chainstate the active one.\n+    //! @param[in] snapshot_blockhash   If given, signify that this chainstate\n+    //!                                 is based on a snapshot.\n+    CChainState& InitializeChainstate(\n+        bool activate = true, const uint256& snapshot_blockhash = uint256());\n+\n+    //! Get all chainstates currently being used.\n+    std::vector<CChainState*> GetAll();\n+\n+    //! The most-work chain.\n+    CChain& ActiveChain() const;\n+    int ActiveHeight() const { return ActiveChain().Height(); }\n+    CBlockIndex* ActiveTip() const { return ActiveChain().Tip(); }\n+\n+    bool IsSnapshotActive() const;\n+\n+    uint256 SnapshotBlockhash() const { return m_snapshot_blockhash; }\n+\n+    //! Is there a snapshot in use and has it been fully validated?\n+    bool IsSnapshotValidated() const { return m_snapshot_validated; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r358859057",
      "id" : 358859057,
      "in_reply_to_id" : 357719170,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1ODg1OTA1Nw==",
      "original_commit_id" : "6a629cfd02907162cea4dbef86837ee4c01bf157",
      "original_position" : 103,
      "path" : "src/validation.h",
      "position" : 156,
      "pull_request_review_id" : 333363176,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737",
      "updated_at" : "2019-12-17T15:31:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/358859057",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r358859358"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/358859358"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In practice all usages of this happen under `cs_main`, but as I said above I'll do explicit annotations.",
      "commit_id" : "23283174f4e6f92c5eee1f7f1f94ceed8405099a",
      "created_at" : "2019-12-17T15:32:09Z",
      "diff_hunk" : "@@ -5116,3 +5116,68 @@ class CMainCleanup\n     }\n };\n static CMainCleanup instance_of_cmaincleanup;\n+\n+std::vector<CChainState*> ChainstateManager::GetAll()\n+{\n+    std::vector<CChainState*> out;\n+\n+    if (!IsSnapshotValidated() && m_ibd_chainstate) {\n+        out.push_back(m_ibd_chainstate.get());\n+    }\n+\n+    if (m_snapshot_chainstate) {\n+        out.push_back(m_snapshot_chainstate.get());\n+    }\n+\n+    return out;\n+}\n+\n+CChainState& ChainstateManager::InitializeChainstate(\n+    bool activate, const uint256& snapshot_blockhash)\n+{\n+    std::unique_ptr<CChainState>& to_modify = (\n+        snapshot_blockhash.IsNull() ? m_ibd_chainstate : m_snapshot_chainstate);\n+\n+    to_modify.reset(new CChainState(snapshot_blockhash));\n+\n+    if (activate) {\n+        LogPrintf(\"Switching active chainstate to %s\\n\", snapshot_blockhash.ToString());\n+        m_active_chainstate = to_modify.get();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r358859358",
      "id" : 358859358,
      "in_reply_to_id" : 357721286,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1ODg1OTM1OA==",
      "original_commit_id" : "6a629cfd02907162cea4dbef86837ee4c01bf157",
      "original_position" : 30,
      "path" : "src/validation.cpp",
      "position" : 255,
      "pull_request_review_id" : 333363576,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737",
      "updated_at" : "2019-12-17T15:32:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/358859358",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r358859584"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/358859584"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think you're right here, I'll remove this.",
      "commit_id" : "23283174f4e6f92c5eee1f7f1f94ceed8405099a",
      "created_at" : "2019-12-17T15:32:30Z",
      "diff_hunk" : "@@ -757,6 +762,111 @@ bool InvalidateBlock(BlockValidationState& state, const CChainParams& chainparam\n /** Remove invalidity status from a block and its descendants. */\n void ResetBlockFailureFlags(CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+/**\n+ * Provides an interface for creating and interacting with multiple\n+ * chainstates, as well as a means to initialize chainstates from a\n+ * UTXO snapshot. Managed chainstates can be maintained at different\n+ * heights simultaneously.\n+ *\n+ * This class provides abstractions that allow the retrieval of the current\n+ * most-work chainstate (\"Active\") as well as chainstates which may be in\n+ * background use to validate UTXO snapshots.\n+ *\n+ * A few quick definitions:\n+ *\n+ * *IBD chainstate*: a chainstate populated via initial block download.\n+ *\n+ * *Snapshot chainstate*: a chainstate populated by loading in an\n+ *    assumed-valid UTXO snapshot.\n+ *\n+ * *Active chainstate*: the chainstate containing the current most-work\n+ *    chain. Consulted by most parts of the system (net_processing,\n+ *    wallet) as a reflection of the current chain and UTXO set.\n+ *    This may either be an IBD chainstate or a snapshot chainstate.\n+ *\n+ * *Background validation chainstate*: an IBD chainstate for which the\n+ *    IBD process is happening in the background while use of the\n+ *    active chainstate allows the rest of the system to function.\n+ *\n+ * *Validated chainstate*: a chainstate whose validity is not assumed.\n+ *    This could be an IBD chainstate, or a snapshot chainstate for\n+ *    which background validation (up to the base of the snapshot)\n+ *    has completed.\n+ */\n+class ChainstateManager\n+{\n+private:\n+    //! The chainstate used under normal operation (i.e. \"regular\" IBD) or,\n+    //! if a snapshot is in use, for background validation. Its contents will\n+    //! be freed when background validation of the snapshot has completed.\n+    std::unique_ptr<CChainState> m_ibd_chainstate;\n+\n+    //! A chainstate initialized on the basis of a UTXO snapshot. If this is\n+    //! non-null, it is always our active chainstate unless proven invalid.\n+    std::unique_ptr<CChainState> m_snapshot_chainstate;\n+\n+    //! Points to either the ibd or snapshot chainstate; indicates our\n+    //! most-work chain.\n+    CChainState* m_active_chainstate;\n+\n+    //! The base blockhash of the active UTXO snapshot (if one is being used)\n+    uint256 m_snapshot_blockhash{};\n+\n+    //! If true, the assumed-valid chainstate has been fully validated\n+    //! by the background validation chainstate.\n+    bool m_snapshot_validated{false};\n+\n+    // For access to m_active_chainstate.\n+    friend CChain& ChainActive();\n+\n+public:\n+    //! Instantiate a new chainstate and assign it based upon whether it is\n+    //! from a snapshot.\n+    //!\n+    //! @param[in] activate   If true, make this new chainstate the active one.\n+    //! @param[in] snapshot_blockhash   If given, signify that this chainstate\n+    //!                                 is based on a snapshot.\n+    CChainState& InitializeChainstate(\n+        bool activate = true, const uint256& snapshot_blockhash = uint256());\n+\n+    //! Get all chainstates currently being used.\n+    std::vector<CChainState*> GetAll();\n+\n+    //! The most-work chain.\n+    CChain& ActiveChain() const;\n+    int ActiveHeight() const { return ActiveChain().Height(); }\n+    CBlockIndex* ActiveTip() const { return ActiveChain().Tip(); }\n+\n+    bool IsSnapshotActive() const;\n+\n+    uint256 SnapshotBlockhash() const { return m_snapshot_blockhash; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r358859584",
      "id" : 358859584,
      "in_reply_to_id" : 357723785,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1ODg1OTU4NA==",
      "original_commit_id" : "6a629cfd02907162cea4dbef86837ee4c01bf157",
      "original_position" : 100,
      "path" : "src/validation.h",
      "position" : 153,
      "pull_request_review_id" : 333363872,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737",
      "updated_at" : "2019-12-17T15:32:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/358859584",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r358860840"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/358860840"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this method is called so infrequently and has such major effects that it'd be hard to accidentally do anything one way or the other, and the results would be immediately obvious and buggy. But to your point, maybe I should remove the default parameters so that everything has to be explicit.",
      "commit_id" : "23283174f4e6f92c5eee1f7f1f94ceed8405099a",
      "created_at" : "2019-12-17T15:34:40Z",
      "diff_hunk" : "@@ -757,6 +762,111 @@ bool InvalidateBlock(BlockValidationState& state, const CChainParams& chainparam\n /** Remove invalidity status from a block and its descendants. */\n void ResetBlockFailureFlags(CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+/**\n+ * Provides an interface for creating and interacting with multiple\n+ * chainstates, as well as a means to initialize chainstates from a\n+ * UTXO snapshot. Managed chainstates can be maintained at different\n+ * heights simultaneously.\n+ *\n+ * This class provides abstractions that allow the retrieval of the current\n+ * most-work chainstate (\"Active\") as well as chainstates which may be in\n+ * background use to validate UTXO snapshots.\n+ *\n+ * A few quick definitions:\n+ *\n+ * *IBD chainstate*: a chainstate populated via initial block download.\n+ *\n+ * *Snapshot chainstate*: a chainstate populated by loading in an\n+ *    assumed-valid UTXO snapshot.\n+ *\n+ * *Active chainstate*: the chainstate containing the current most-work\n+ *    chain. Consulted by most parts of the system (net_processing,\n+ *    wallet) as a reflection of the current chain and UTXO set.\n+ *    This may either be an IBD chainstate or a snapshot chainstate.\n+ *\n+ * *Background validation chainstate*: an IBD chainstate for which the\n+ *    IBD process is happening in the background while use of the\n+ *    active chainstate allows the rest of the system to function.\n+ *\n+ * *Validated chainstate*: a chainstate whose validity is not assumed.\n+ *    This could be an IBD chainstate, or a snapshot chainstate for\n+ *    which background validation (up to the base of the snapshot)\n+ *    has completed.\n+ */\n+class ChainstateManager\n+{\n+private:\n+    //! The chainstate used under normal operation (i.e. \"regular\" IBD) or,\n+    //! if a snapshot is in use, for background validation. Its contents will\n+    //! be freed when background validation of the snapshot has completed.\n+    std::unique_ptr<CChainState> m_ibd_chainstate;\n+\n+    //! A chainstate initialized on the basis of a UTXO snapshot. If this is\n+    //! non-null, it is always our active chainstate unless proven invalid.\n+    std::unique_ptr<CChainState> m_snapshot_chainstate;\n+\n+    //! Points to either the ibd or snapshot chainstate; indicates our\n+    //! most-work chain.\n+    CChainState* m_active_chainstate;\n+\n+    //! The base blockhash of the active UTXO snapshot (if one is being used)\n+    uint256 m_snapshot_blockhash{};\n+\n+    //! If true, the assumed-valid chainstate has been fully validated\n+    //! by the background validation chainstate.\n+    bool m_snapshot_validated{false};\n+\n+    // For access to m_active_chainstate.\n+    friend CChain& ChainActive();\n+\n+public:\n+    //! Instantiate a new chainstate and assign it based upon whether it is\n+    //! from a snapshot.\n+    //!\n+    //! @param[in] activate   If true, make this new chainstate the active one.\n+    //! @param[in] snapshot_blockhash   If given, signify that this chainstate\n+    //!                                 is based on a snapshot.\n+    CChainState& InitializeChainstate(\n+        bool activate = true, const uint256& snapshot_blockhash = uint256());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17737#discussion_r358860840",
      "id" : 358860840,
      "in_reply_to_id" : 358508803,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1ODg2MDg0MA==",
      "original_commit_id" : "6a629cfd02907162cea4dbef86837ee4c01bf157",
      "original_position" : 88,
      "path" : "src/validation.h",
      "position" : 136,
      "pull_request_review_id" : 333365587,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17737",
      "updated_at" : "2019-12-17T15:34:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/358860840",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   }
]
