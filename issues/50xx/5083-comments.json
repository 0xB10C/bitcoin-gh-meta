[
   {
      "body" : "It's not really moved out. The ProcessBlock logic just inserts a block after basic checks into the block database, and then calls ActivateBestChain to reorganize until a stable point is reached. Since inserting a block into the database may cause anything between 0 and infinity blocks to processed, it doesn't really make sense for it to return a specific rejection reason anymore (furthermore, we need to handle those rejection reasons internally during the reorg to find what to do next).\r\n\r\nThis affects #1816 and #3727 too (I've mentioned this problem in #3727, but wasn't aware it had further implications).\r\n\r\nThere are two solutions, IMHO:\r\n* Either have a more generic callback mechanism to be informed about block validity checks when they happen (rather than just a nodeid now), so submitblock etc can install their own handler to catch the result and report about it, in addition to ProcessBlock installing a nodeid listener that does BIP61 rejection notice or DOS banning.\r\n* Make submitblock call ConnectBlock directly (which should always work if its predecessor is the current tip, and otherwise submitblock should already fail anyway). The problem with this is some logic which is in AcceptBlock rather than ConnectBlock or CheckBlock, so would need to be duplicated (in particular, BIP34 version checks). Moving those should be easy, though.\r\n\r\nThe first solution is more generic and allows for better decoupling of network handling and consensus rules, but the second is probably faster to do.",
      "created_at" : "2014-10-13T21:53:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/5083#issuecomment-58960522",
      "id" : 58960522,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5083",
      "updated_at" : "2014-10-13T21:53:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/58960522",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Do we really want to be putting potentially-invalid blocks in the block database in the first place?",
      "created_at" : "2014-10-13T22:01:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/5083#issuecomment-58961533",
      "id" : 58961533,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5083",
      "updated_at" : "2014-10-13T22:01:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/58961533",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "body" : "I don't want to cause a reorg for every side side branch we receive just to be able to validate it, only to reorg back afterwards because the earlier branch is just as long or longer anyway.",
      "created_at" : "2014-10-13T22:04:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/5083#issuecomment-58961847",
      "id" : 58961847,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5083",
      "updated_at" : "2014-10-13T22:04:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/58961847",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Also, receiving a block can cause connection of successor blocks (orphans pre-HF, unlinked blocks post-HF).",
      "created_at" : "2014-10-13T22:05:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/5083#issuecomment-58961983",
      "id" : 58961983,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5083",
      "updated_at" : "2014-10-13T22:05:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/58961983",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "@sipa Why would we receive a block if we aren't planning to reorg on it? O.o\r\n\r\nBesides, can't we just \"reorg\" in memory now anyway (and not affect the main tip)?",
      "created_at" : "2014-10-13T22:20:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/5083#issuecomment-58963529",
      "id" : 58963529,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5083",
      "updated_at" : "2014-10-13T22:20:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/58963529",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "body" : "@luke-jr (in HF) we download any block along a chain that is a potential improvement to the one we have currently as active. But we can only reorg to it if all ancestor blocks are available, which is potentially never.\r\n\r\nThere can still be competing chains, and you don't know which one you'll end up receiving first. Maybe there are two potentially improving branches, but the longer one has an invalid block, or the peer that has it is too slow. In that case you need to reorg to the shorter of the two anyway.\r\n\r\nAnd yes, of course we can reorg to anything in memory, but that is slow (it needs signature checks, which we'd rather delay as much as possible) and potentially requires unbounded memory.",
      "created_at" : "2014-10-13T23:38:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/5083#issuecomment-58970450",
      "id" : 58970450,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/5083",
      "updated_at" : "2014-10-13T23:38:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/58970450",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   }
]
