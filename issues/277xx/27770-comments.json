[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#27596](https://github.com/bitcoin/bitcoin/pull/27596) (assumeutxo (2) by jamesob)\n* [#27534](https://github.com/bitcoin/bitcoin/pull/27534) (rpc: add 'getnetmsgstats', new rpc to view network message statistics by satsie)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-05-26T21:14:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27770#issuecomment-1564964321",
      "id" : 1564964321,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27770",
      "node_id" : "IC_kwDOABII585dR3Xh",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1564964321/reactions"
      },
      "updated_at" : "2023-05-26T22:22:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1564964321",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Not sure. My preference would be to figure out why the blocks are of different size and then make that deterministic instead.",
      "created_at" : "2023-05-27T13:57:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27770#issuecomment-1565431844",
      "id" : 1565431844,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27770",
      "node_id" : "IC_kwDOABII585dTpgk",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1565431844/reactions"
      },
      "updated_at" : "2023-05-27T13:57:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1565431844",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Not sure. My preference would be to figure out why the blocks are of different size and then make that deterministic instead.\r\n\r\nI started there but.. do we really care? (aside from dev curiosity, where I agree that wouldn't be bad to know why).\r\n\r\nThe test goal is to exercise `getblockfrompeer` and not pruning nor where blocks are stored. Having all those hardcoded heights, expecting to have a precise number of blocks in each block file, looks quite fragile.\r\n\r\nI mean, all the hardcoded `pruneheight` numbers and `pruneblockchain(num)` calls looks random at first. It takes a bit to realize that the numbers were picked to prune one block file at time. The `pruneblockchain()` numbers are also extended a bit just in case block files are bigger. Check how they are called: `pruneblockchain(300)`,  `pruneblockchain(700)` when each block file has ~250 blocks; this is my local `getblockfileinfo()` output on each of the three block files presented in the test prior the first `pruneblockchain` call:\r\n\r\n{'blocks_num': 249, 'lowest_block': 0, 'highest_block': 248, 'data_size': 65319, 'undo_size': 10168}\r\n{'blocks_num': 251, 'lowest_block': 249, 'highest_block': 499, 'data_size': 65511, 'undo_size': 10291}\r\n{'blocks_num': 106, 'lowest_block': 500, 'highest_block': 605, 'data_size': 27666, 'undo_size': 4346}\r\n\r\n At least with the `getblockfileinfo()` call we are explicitly pruning the first file, then the second one, etc. Without having to remember how many blocks are stored in each file, nor requiring to extend the prune height just in case.\r\n\r\nI also think that `getblockfileinfo` could be useful in other test contexts as well. Plus, I'm not sure how people call `pruneblockchain` right now, sounds like they blindly call it with a height and only realize up to which block the node pruned the chain when the command returns.\r\n\r\n(if we choose to go into this direction, can remove the remaining hardcoded prune heights in the test).",
      "created_at" : "2023-05-27T20:53:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27770#issuecomment-1565677870",
      "id" : 1565677870,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27770",
      "node_id" : "IC_kwDOABII585dUlku",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1565677870/reactions"
      },
      "updated_at" : "2023-05-28T13:57:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1565677870",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I started there but.. do we really care?\r\n\r\nWe definitely care enough to investigate further, before adding a new RPC command to fix an intermittent issue in a functional test.\r\n\r\nLooks like @theStack has done that investigation here: https://github.com/bitcoin/bitcoin/issues/27749#issuecomment-1566354933, and @mzumsande has suggested a potential alternative fix: https://github.com/bitcoin/bitcoin/issues/27749#issuecomment-1566554075:\r\n> add a sync_blocks call between node0 and node2 before letting node0 generate the 400 blocks. This should guarantee that all of these 400 blocks will be processed by compact block reconstruction.",
      "created_at" : "2023-05-29T09:49:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27770#issuecomment-1566869276",
      "id" : 1566869276,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27770",
      "node_id" : "IC_kwDOABII585dZIcc",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1566869276/reactions"
      },
      "updated_at" : "2023-05-29T09:49:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1566869276",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> > I started there but.. do we really care?\r\n> \r\n> We definitely care enough to investigate further, before adding a new RPC command to fix an intermittent issue in a functional test.\r\n> \r\n> Looks like @theStack has done that investigation here: [#27749 (comment)](https://github.com/bitcoin/bitcoin/issues/27749#issuecomment-1566354933), and @mzumsande has suggested a potential alternative fix: [#27749 (comment)](https://github.com/bitcoin/bitcoin/issues/27749#issuecomment-1566554075):\r\n> \r\n> > add a sync_blocks call between node0 and node2 before letting node0 generate the 400 blocks. This should guarantee that all of these 400 blocks will be processed by compact block reconstruction.\r\n\r\nYeah, I know. theStack investigation is awesome!. We kept ping-ponging about it after this PR was pushed :). And also martin's fix sounds good.\r\n\r\nIf you don't like the first sentence in my previous [comment](https://github.com/bitcoin/bitcoin/pull/27770#issuecomment-1565677870) remove it. It was just the intro, no hard feelings. The background rationale there still applies even with the investigation and the possible fix.\r\n\r\nThe test is still fragile, the hardcoded `pruneblockchain` heights are off by a good degree to cover possible pruning diffs, an also not well documented. I don't think that anyone knew that the `pruneblockchain(300)` or `pruneblockchain(700)` test calls are there to remove the first and second block file (when first block file highest block number is 250, and second one is 500..).\r\n\r\nFurthermore, what theStack analysis really says is that `pruneblockchain` result is not accurate. Which is the real issue for me. The RPC command result description says that it returns the \"height of the last block pruned\", which could not be true as blocks could have been stored out of order.\r\nSo retrieving block height 249 as \"last block pruned\" doesn't mean that block 248 has been pruned from disk.\r\n\r\nSo, I actually think that adding the `getblockfileinfo` RPC command makes even more sense now. Not to solve the current intermittent issue, but to make the manual pruning process clearer for users and tests (check the penultimate paragraph in my previous [comment](https://github.com/bitcoin/bitcoin/issues/27749#issuecomment-1566554075)). And also as a debugging tool.",
      "created_at" : "2023-05-29T13:48:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27770#issuecomment-1567161622",
      "id" : 1567161622,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27770",
      "node_id" : "IC_kwDOABII585daP0W",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1567161622/reactions"
      },
      "updated_at" : "2023-05-30T13:26:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1567161622",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> But is it really incorrect that the \"last block pruned\" is 249? Yes, this doesn't imply that all blocks before have been pruned as well - but the RPC description isn't claiming that.\r\n\r\nThat would be the devil's advocate argument. It works for us, but not for our users.\r\nLet's agree that while it's not clearly stated, anyone reading the RPC result description would understand that all blocks prior the returned height were pruned.\r\n\r\n> But I think that introducing any new RPC should primarily have some benefit to users, so that should be the main selling point - the use in tests should be more of a side benefit.\r\n\r\nYeah, I agree. But also, I think there is some synergy between the functional tests and other projects building upon core's API as well. Sometimes commands that are useful for tests, not for end users, and also useful for other projects.\r\n\r\nI think that this one makes the manual pruning process a bit clearer. So there is no blind `pruneblockchain(<height>)` call. Right now callers only realize up to which block the node pruned the chain when the command returns (and that is not even accurate enough).\r\nGreat to hear that this has benefits for `assumeUTXO` as well.",
      "created_at" : "2023-05-29T15:55:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27770#issuecomment-1567299154",
      "id" : 1567299154,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27770",
      "node_id" : "IC_kwDOABII585daxZS",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1567299154/reactions"
      },
      "updated_at" : "2023-05-30T00:00:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1567299154",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "What about a one-line fix to clear the test issue and then a follow-up with the RPC, which may take longer to review than a trivial one-line patch?",
      "created_at" : "2023-05-30T06:57:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27770#issuecomment-1567870784",
      "id" : 1567870784,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27770",
      "node_id" : "IC_kwDOABII585dc89A",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1567870784/reactions"
      },
      "updated_at" : "2023-05-30T06:57:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1567870784",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> What about a one-line fix to clear the test issue and then a follow-up with the RPC, which may take longer to review than a trivial one-line patch?\r\n\r\nnp for me. @mzumsande do you want to go ahead with your fix? I can just relabel this PR to \"Implement getblockfileinfo RPC command\" and done.",
      "created_at" : "2023-05-30T12:35:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27770#issuecomment-1568357831",
      "id" : 1568357831,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27770",
      "node_id" : "IC_kwDOABII585dez3H",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1568357831/reactions"
      },
      "updated_at" : "2023-05-30T12:35:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1568357831",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   }
]
