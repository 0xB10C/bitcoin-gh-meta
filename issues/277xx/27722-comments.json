[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I think #27245 which uses `evhttp_connection_set_closecb` is needed to avoid this, but:\r\n- it doesn't seem to be slated for v25.0\r\n- I experience this in one of the libevent versions that #27245 doesn't address",
      "created_at" : "2023-05-23T13:05:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27722#issuecomment-1559296260",
      "id" : 1559296260,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27722",
      "node_id" : "IC_kwDOABII585c8PkE",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1559296260/reactions"
      },
      "updated_at" : "2023-05-23T13:19:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1559296260",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for reporting! I observed this issue sporadically, but were never able to reproduce it until now. With the help of your description (_\"... interrupting bitcoin-cli before it has received the reply ...\"_) I found it's actually quite trivial at least on my machine:\r\n\r\n1. startup `bitcoind -debug=http` (and any other desired flags; note that the hangup also happens without the debug flag, but this allows us to see where it's hanging)\r\n2. execute `bitcoin-cli waitforblockheight 1234567` (or any other RPC call which doesn't terminate immediately)\r\n3. terminate bitcoin-cli via CTRL-C\r\n4. terminate bitcoind via CTRL-C\r\n\r\nThe shutdown leads to the following messages and then hangs forever:\r\n```\r\n2023-05-23T13:58:01Z [http] Unregistering HTTP handler for / (exactmatch 1)\r\n2023-05-23T13:58:01Z [http] Unregistering HTTP handler for /wallet/ (exactmatch 0)\r\n2023-05-23T13:58:01Z [http] Stopping HTTP server\r\n2023-05-23T13:58:01Z [http] Waiting for HTTP worker threads to exit\r\n2023-05-23T13:58:01Z [http] Waiting for 1 requests to stop HTTP server\r\n2023-05-23T13:58:01Z [http] Exited http event loop\r\n2023-05-23T13:58:01Z msghand thread exit\r\n2023-05-23T13:58:01Z net thread exit\r\n2023-05-23T13:58:03Z opencon thread exit\r\n```\r\n\r\nTested on master branch (commit 5ef2c1ee7a7416907e0f9135dc0701a88d92a7f6) with default configuration, running OpenBSD 7.3 with libevent 2.1.12 here.",
      "created_at" : "2023-05-23T14:02:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27722#issuecomment-1559453982",
      "id" : 1559453982,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27722",
      "node_id" : "IC_kwDOABII585c82Ee",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1559453982/reactions"
      },
      "updated_at" : "2023-05-23T14:02:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1559453982",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I was able to fix this with my branch here https://github.com/Crypt-iQ/bitcoin/commit/4fd7adb30f584664421b6431bce8ebcbf7ceef2f by adding a `evhttp_connection_set_closecb` callback. I didn't need to modify the logic related to `EV_READ` and no functional test errors are introduced on my machine",
      "created_at" : "2023-05-23T16:00:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27722#issuecomment-1559731418",
      "id" : 1559731418,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27722",
      "node_id" : "IC_kwDOABII585c95za",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1559731418/reactions"
      },
      "updated_at" : "2023-05-23T16:00:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1559731418",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> I was able to fix this with my branch here [Crypt-iQ@4fd7adb](https://github.com/Crypt-iQ/bitcoin/commit/4fd7adb30f584664421b6431bce8ebcbf7ceef2f) by adding a `evhttp_connection_set_closecb` callback. I didn't need to modify the logic related to `EV_READ` and no functional test errors are introduced on my machine\r\n\r\nCan confirm that this patch fixes the issue on my side. ",
      "created_at" : "2023-05-24T18:09:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27722#issuecomment-1561718193",
      "id" : 1561718193,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27722",
      "node_id" : "IC_kwDOABII585dFe2x",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1561718193/reactions"
      },
      "updated_at" : "2023-05-24T18:09:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1561718193",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Hmmm, curiously enough I was not able to reproduce using either method on master @ aa6cc5bec9 \r\n\r\nWith @theStack method:\r\n\r\n```log\r\n2023-05-26T10:39:07Z [http] Received a POST request for / from 127.0.0.1:50704\r\n^C2023-05-26T10:39:10Z [http] Interrupting HTTP server\r\n2023-05-26T10:39:10Z tor: Thread interrupt\r\n2023-05-26T10:39:10Z torcontrol thread exit\r\n2023-05-26T10:39:10Z addcon thread exit\r\n2023-05-26T10:39:10Z opencon thread exit\r\n2023-05-26T10:39:10Z Shutdown: In progress...\r\n2023-05-26T10:39:10Z [http] Unregistering HTTP handler for / (exactmatch 1)\r\n2023-05-26T10:39:10Z [http] Unregistering HTTP handler for /wallet/ (exactmatch 0)\r\n2023-05-26T10:39:10Z [http] Stopping HTTP server\r\n2023-05-26T10:39:10Z [http] Waiting for HTTP worker threads to exit\r\n2023-05-26T10:39:10Z [http] Waiting for 1 requests to stop HTTP server\r\n2023-05-26T10:39:10Z [http] Waiting for HTTP event thread to exit\r\n2023-05-26T10:39:10Z [http] Exited http event loop\r\n2023-05-26T10:39:10Z [http] Stopped HTTP server\r\n2023-05-26T10:39:10Z loadblk thread exit\r\n2023-05-26T10:39:10Z net thread exit\r\n2023-05-26T10:39:10Z msghand thread exit\r\n2023-05-26T10:39:10Z DumpAnchors: Flush 0 outbound block-relay-only peer addresses to anchors.dat started\r\n2023-05-26T10:39:10Z DumpAnchors: Flush 0 outbound block-relay-only peer addresses to anchors.dat completed (0.00s)\r\n2023-05-26T10:39:10Z scheduler thread exit\r\n2023-05-26T10:39:16Z Shutdown: done\r\n```\r\n\r\nWith @Crypt-iQ method:\r\n\r\n<details>\r\n<summary>Details</summary>\r\n\r\n```log\r\n... many lines like this\r\n2023-05-26T10:42:04Z [http] Received a POST request for / from 127.0.0.1:59546\r\n2023-05-26T10:42:04Z [http] Received a POST request for / from 127.0.0.1:59562\r\n2023-05-26T10:42:04Z [http] Received a POST request for / from 127.0.0.1:59566\r\n2023-05-26T10:42:04Z [http] Received a POST request for / from 127.0.0.1:59570\r\n2023-05-26T10:42:04Z [http] Received a POST request for / from 127.0.0.1:59574\r\n2023-05-26T10:42:04Z [http] Received a POST request for / from 127.0.0.1:59580\r\n2023-05-26T10:42:04Z [http] Received a POST request for / from 127.0.0.1:59590\r\n2023-05-26T10:42:04Z [http] Received a POST request for / from 127.0.0.1:59596\r\n2023-05-26T10:42:04Z [http] Received a POST request for / from 127.0.0.1:59606\r\n2023-05-26T10:42:04Z [http] Received a POST request for / from 127.0.0.1:59616\r\n2023-05-26T10:42:04Z [http] Received a POST request for / from 127.0.0.1:59618\r\n2023-05-26T10:42:04Z [http] Received a POST request for / from 127.0.0.1:59636\r\n2023-05-26T10:42:04Z [http] Received a POST request for / from 127.0.0.1:59638\r\n2023-05-26T10:42:04Z [http] Received a POST request for / from 127.0.0.1:59660\r\n2023-05-26T10:42:04Z [http] Received a POST request for / from 127.0.0.1:59658\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:59686\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:59684\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:59704\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:59706\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:59722\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:59734\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:59740\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:59746\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:59760\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:59774\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:59790\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:59792\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:59798\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:59802\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:59804\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:59818\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:59822\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:59828\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:59826\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:59840\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:59854\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:59864\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:59866\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:59870\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:59868\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:59886\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:59900\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:59914\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:59928\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:59944\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:59960\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:59964\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:59968\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:59980\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:59982\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60002\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60004\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60010\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60008\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60018\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60016\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60038\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60044\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60048\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60054\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60066\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60064\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60080\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60082\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60108\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60110\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60124\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60128\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60130\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60142\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60154\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60158\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60170\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60168\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60186\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60184\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60196\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60198\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60224\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60226\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60242\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60244\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60258\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60256\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60284\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60296\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60298\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60310\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60320\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60336\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60344\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60342\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60362\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60370\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60378\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60382\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60386\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60388\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60400\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60402\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60422\r\n2023-05-26T10:42:05Z [http] Received a POST request for / from 127.0.0.1:60430\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60436\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60450\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60462\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60468\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60472\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60470\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60494\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60496\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60508\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60510\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60514\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60522\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60524\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60532\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60544\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60552\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60556\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60560\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60570\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60582\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60592\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60598\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60612\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60614\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60620\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60626\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60628\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60646\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60654\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60652\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60676\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60678\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60680\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60688\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60700\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60706\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60710\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60712\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60724\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60736\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60750\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60756\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60760\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60772\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60776\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60788\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60802\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60814\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60816\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60828\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60830\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60846\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60848\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60854\r\n2023-05-26T10:42:06Z [http] Received a POST request for / from 127.0.0.1:60866\r\n2023-05-26T10:42:07Z [http] Received a POST request for / from 127.0.0.1:60880\r\n2023-05-26T10:42:07Z [http] Received a POST request for / from 127.0.0.1:60892\r\n2023-05-26T10:42:07Z [http] Received a POST request for / from 127.0.0.1:60896\r\n2023-05-26T10:42:07Z [http] Received a POST request for / from 127.0.0.1:60906\r\n2023-05-26T10:42:07Z [http] Received a POST request for / from 127.0.0.1:60918\r\n2023-05-26T10:42:07Z [http] Received a POST request for / from 127.0.0.1:60934\r\n2023-05-26T10:42:07Z [http] Received a POST request for / from 127.0.0.1:60940\r\n2023-05-26T10:42:07Z [http] Received a POST request for / from 127.0.0.1:60950\r\n2023-05-26T10:42:07Z [http] Received a POST request for / from 127.0.0.1:60960\r\n2023-05-26T10:42:07Z [http] Received a POST request for / from 127.0.0.1:60972\r\n2023-05-26T10:42:07Z [http] Received a POST request for / from 127.0.0.1:60988\r\n2023-05-26T10:42:07Z [http] Received a POST request for / from 127.0.0.1:60994\r\n2023-05-26T10:42:07Z [http] Received a POST request for / from 127.0.0.1:32772\r\n2023-05-26T10:42:07Z [http] Received a POST request for / from 127.0.0.1:32774\r\n2023-05-26T10:42:07Z [http] Received a POST request for / from 127.0.0.1:32776\r\n2023-05-26T10:42:07Z [http] Received a POST request for / from 127.0.0.1:32778\r\n2023-05-26T10:42:07Z [http] Received a POST request for / from 127.0.0.1:32788\r\n2023-05-26T10:42:07Z [http] Received a POST request for / from 127.0.0.1:32802\r\n2023-05-26T10:42:07Z [http] Received a POST request for / from 127.0.0.1:32812\r\n2023-05-26T10:42:07Z [http] Received a POST request for / from 127.0.0.1:32828\r\n2023-05-26T10:42:07Z [http] Received a POST request for / from 127.0.0.1:32830\r\n2023-05-26T10:42:07Z [http] Received a POST request for / from 127.0.0.1:32832\r\n2023-05-26T10:42:07Z [http] Received a POST request for / from 127.0.0.1:32846\r\n2023-05-26T10:42:07Z [http] Received a POST request for / from 127.0.0.1:32854\r\n2023-05-26T10:42:07Z [http] Received a POST request for / from 127.0.0.1:32870\r\n2023-05-26T10:42:07Z [http] Received a POST request for / from 127.0.0.1:32872\r\n2023-05-26T10:42:07Z [http] Received a POST request for / from 127.0.0.1:32876\r\n2023-05-26T10:42:07Z [http] Received a POST request for / from 127.0.0.1:32890\r\n2023-05-26T10:42:07Z [http] Received a POST request for / from 127.0.0.1:32892\r\n2023-05-26T10:42:07Z [http] Received a POST request for / from 127.0.0.1:32904\r\n2023-05-26T10:42:07Z [http] Received a POST request for / from 127.0.0.1:32906\r\n2023-05-26T10:42:07Z [http] Received a POST request for / from 127.0.0.1:32912\r\n2023-05-26T10:42:07Z [http] Received a POST request for / from 127.0.0.1:32928\r\n2023-05-26T10:42:07Z [http] Received a POST request for / from 127.0.0.1:32934\r\n^C2023-05-26T10:42:14Z [http] Interrupting HTTP server\r\n2023-05-26T10:42:14Z tor: Thread interrupt\r\n2023-05-26T10:42:14Z torcontrol thread exit\r\n2023-05-26T10:42:14Z opencon thread exit\r\n2023-05-26T10:42:14Z addcon thread exit\r\n2023-05-26T10:42:14Z Shutdown: In progress...\r\n2023-05-26T10:42:14Z [http] Unregistering HTTP handler for / (exactmatch 1)\r\n2023-05-26T10:42:14Z [http] Unregistering HTTP handler for /wallet/ (exactmatch 0)\r\n2023-05-26T10:42:14Z [http] Stopping HTTP server\r\n2023-05-26T10:42:14Z [http] Waiting for HTTP worker threads to exit\r\n2023-05-26T10:42:14Z [http] Exited http event loop\r\n2023-05-26T10:42:14Z [http] Waiting for HTTP event thread to exit\r\n2023-05-26T10:42:14Z [http] Stopped HTTP server\r\n2023-05-26T10:42:14Z net thread exit\r\n2023-05-26T10:42:14Z loadblk thread exit\r\n2023-05-26T10:42:14Z msghand thread exit\r\n2023-05-26T10:42:14Z DumpAnchors: Flush 0 outbound block-relay-only peer addresses to anchors.dat started\r\n2023-05-26T10:42:14Z DumpAnchors: Flush 0 outbound block-relay-only peer addresses to anchors.dat completed (0.00s)\r\n2023-05-26T10:42:14Z scheduler thread exit\r\n2023-05-26T10:42:15Z Shutdown: done\r\n```\r\n\r\n</details>",
      "created_at" : "2023-05-26T10:44:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27722#issuecomment-1564196898",
      "id" : 1564196898,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27722",
      "node_id" : "IC_kwDOABII585dO8Ai",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1564196898/reactions"
      },
      "updated_at" : "2023-05-26T10:44:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1564196898",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@willcl-ark can you find what libevent version you're using? ",
      "created_at" : "2023-05-26T13:15:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27722#issuecomment-1564380223",
      "id" : 1564380223,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27722",
      "node_id" : "IC_kwDOABII585dPow_",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1564380223/reactions"
      },
      "updated_at" : "2023-05-26T13:15:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1564380223",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "This bug appeared in the [nix-bitcoin](https://github.com/fort-nix/nix-bitcoin/) [test suite](https://github.com/fort-nix/nix-bitcoin/blob/master/test/tests.py). I can confirm that it is fixed by https://github.com/Crypt-iQ/bitcoin/commit/4fd7adb30f584664421b6431bce8ebcbf7ceef2f.\r\n\r\n\r\n<details>\r\n<summary>Details</summary>\r\n\r\nThe test is executed inside a QEMU VM and runs `bitcoind` together with a bunch of client services (like `clightning`, `lnd`, `joinmarket`). It then stops all services, including `bitcoind`.\r\nSometimes `bitcoind` hangs during shutdown:\r\n1. First, it waits for a few minutes at [httpserver.cpp#L469](https://github.com/bitcoin/bitcoin/blob/v25.0/src/httpserver.cpp#L469) (`[http] Waiting for HTTP worker threads to exit`)\r\n2. Then it hangs indefinitely at [httpserver.cpp#L484](https://github.com/bitcoin/bitcoin/blob/v25.0/src/httpserver.cpp#L484) (`[http] Waiting for 1 requests to stop HTTP server`')\r\n\r\n`bitcoind` gets shutdown *after* all client services have exited, so there are never any lingering active connections.\r\n\r\nThis bug is hard to reproduce in the context of the test suite.\r\nI once could consistently trigger it on my desktop system, but never again after rebooting the system.\r\nCurrently, I can reproduce it in 80% of all test runs on our [nix-bitcoin server](https://nixbitcoin.org).\r\n\r\n[Here's the log output](https://gist.github.com/erikarvstedt/843f6d5fdb545b52f6bd34bc66651c52) of the shutdown sequence, interspersed with gdb backtraces of all threads.\r\n\r\n</details>\r\n\r\n",
      "created_at" : "2023-05-30T18:31:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27722#issuecomment-1568888056",
      "id" : 1568888056,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27722",
      "node_id" : "IC_kwDOABII585dg1T4",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1568888056/reactions"
      },
      "updated_at" : "2023-05-30T20:30:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1568888056",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/36110478?v=4",
         "events_url" : "https://api.github.com/users/erikarvstedt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/erikarvstedt/followers",
         "following_url" : "https://api.github.com/users/erikarvstedt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/erikarvstedt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/erikarvstedt",
         "id" : 36110478,
         "login" : "erikarvstedt",
         "node_id" : "MDQ6VXNlcjM2MTEwNDc4",
         "organizations_url" : "https://api.github.com/users/erikarvstedt/orgs",
         "received_events_url" : "https://api.github.com/users/erikarvstedt/received_events",
         "repos_url" : "https://api.github.com/users/erikarvstedt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/erikarvstedt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/erikarvstedt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/erikarvstedt"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@erikarvstedt it seems like there's a call to `importmulti` that is outstanding while bitcoind is trying to shut down",
      "created_at" : "2023-05-30T19:26:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27722#issuecomment-1568965050",
      "id" : 1568965050,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27722",
      "node_id" : "IC_kwDOABII585dhIG6",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1568965050/reactions"
      },
      "updated_at" : "2023-05-30T19:26:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1568965050",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "@Crypt-iQ, the slow progress of `importmulti` is indeed a separate issue. Maybe it has existed before and was just uncovered by https://github.com/bitcoin/bitcoin/pull/26742. I'll check this later.\r\nI've updated my previous post. ",
      "created_at" : "2023-05-30T20:43:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27722#issuecomment-1569074534",
      "id" : 1569074534,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27722",
      "node_id" : "IC_kwDOABII585dhi1m",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1569074534/reactions"
      },
      "updated_at" : "2023-05-30T21:12:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1569074534",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/36110478?v=4",
         "events_url" : "https://api.github.com/users/erikarvstedt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/erikarvstedt/followers",
         "following_url" : "https://api.github.com/users/erikarvstedt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/erikarvstedt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/erikarvstedt",
         "id" : 36110478,
         "login" : "erikarvstedt",
         "node_id" : "MDQ6VXNlcjM2MTEwNDc4",
         "organizations_url" : "https://api.github.com/users/erikarvstedt/orgs",
         "received_events_url" : "https://api.github.com/users/erikarvstedt/received_events",
         "repos_url" : "https://api.github.com/users/erikarvstedt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/erikarvstedt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/erikarvstedt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/erikarvstedt"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> @willcl-ark can you find what libevent version you're using?\r\n\r\nI am using libevent 2.1.12 (like TheStack)",
      "created_at" : "2023-05-31T10:23:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27722#issuecomment-1569922589",
      "id" : 1569922589,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27722",
      "node_id" : "IC_kwDOABII585dkx4d",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1569922589/reactions"
      },
      "updated_at" : "2023-05-31T10:23:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1569922589",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   }
]
