[
   {
      "author_association" : "MEMBER",
      "body" : "Great! Thanks for this. I'm active in these neighborhoods today as well, since adding some `-stopatheight`/restart logic to the functional tests in #27596 has turned up some issues with `CheckBlockIndex()`, which are maybe related to some of the changes here. So I'll be looking at this shortly.",
      "created_at" : "2023-05-24T20:05:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1561858383",
      "id" : 1561858383,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27746",
      "node_id" : "IC_kwDOABII585dGBFP",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1561858383/reactions"
      },
      "updated_at" : "2023-05-24T20:05:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1561858383",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [mzumsande](https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1478071545) |\n| Stale ACK | [achow101](https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1484375498), [ryanofsky](https://github.com/bitcoin/bitcoin/pull/27746#pullrequestreview-1483231139) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#27866](https://github.com/bitcoin/bitcoin/pull/27866) (blockstorage: Return on fatal flush errors by TheCharlatan)\n* [#27861](https://github.com/bitcoin/bitcoin/pull/27861) (kernel: Add interrupt class by TheCharlatan)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-05-25T06:05:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1562326140",
      "id" : 1562326140,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27746",
      "node_id" : "IC_kwDOABII585dHzR8",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1562326140/reactions"
      },
      "updated_at" : "2023-06-17T01:21:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1562326140",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "The first two commits up to f50fa248f1d904be5f33a29c837f74a2cca8abc0 look good to me.\r\n\r\nHow do you see the division of labor between `ChainstateManager` and `BlockManager`? The `ChainState` doc currently says:\r\n\r\n> Anything that is contingent on the current tip of the chain is stored here, whereas block information and metadata independent of the current tip is kept in `BlockManager`.\r\n\r\nIn any case moving `AcceptBlock` from `Chainstate` to `ChainstateManager` seems an improvement.",
      "created_at" : "2023-05-31T16:41:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1570566067",
      "id" : 1570566067,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27746",
      "node_id" : "IC_kwDOABII585dnO-z",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1570566067/reactions"
      },
      "updated_at" : "2023-05-31T16:41:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1570566067",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1212154654"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212154654"
         }
      },
      "author_association" : "MEMBER",
      "body" : "534b6f99a3779465678f39ed2704da6049c6469d: this function seems to come out of nowhere and is only used in a test. ",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-05-31T18:43:09Z",
      "diff_hunk" : "@@ -975,6 +932,25 @@ class ChainstateManager\n     //! chainstate to avoid duplicating block metadata.\n     node::BlockManager m_blockman;\n \n+    /**\n+     * Every received block is assigned a unique and increasing identifier, so we\n+     * know which one to give priority in case of a fork.\n+     */\n+    /** Blocks loaded from disk are assigned id 0, so start the counter at 1. */\n+    int32_t nBlockSequenceId GUARDED_BY(::cs_main) = 1;\n+    /** Decreasing counter (used by subsequent preciousblock calls). */\n+    int32_t nBlockReverseSequenceId = -1;\n+    /** chainwork for the last block that preciousblock has been applied to. */\n+    arith_uint256 nLastPreciousChainwork = 0;\n+\n+    void ResetBlockSequenceCounters() EXCLUSIVE_LOCKS_REQUIRED(::cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1212154654",
      "id" : 1212154654,
      "line" : 959,
      "node_id" : "PRRC_kwDOABII585IQAMe",
      "original_commit_id" : "534b6f99a3779465678f39ed2704da6049c6469d",
      "original_line" : 959,
      "original_position" : 101,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 115,
      "pull_request_review_id" : 1453921658,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212154654/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-31T18:44:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212154654",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1212161483"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212161483"
         }
      },
      "author_association" : "MEMBER",
      "body" : "534b6f99a3779465678f39ed2704da6049c6469d: maybe use this refactor as an opportunity to add a comment explaining the somewhat obtuse line above",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-05-31T18:48:56Z",
      "diff_hunk" : "@@ -3440,8 +3440,22 @@ void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {\n     }\n }\n \n+void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n+{\n+    // FIXME: the background-validation chainstate should only add new entries\n+    // that build on blocks for which we actually have all the data, while the\n+    // snapshot chainstate (if we have one) is able to build on blocks that are\n+    // missing but for which BLOCK_ASSUME_VALID is set.\n+    // So this is broken right now. XXX\n+    AssertLockHeld(cs_main);\n+    if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1212161483",
      "id" : 1212161483,
      "line" : 3416,
      "node_id" : "PRRC_kwDOABII585IQB3L",
      "original_commit_id" : "534b6f99a3779465678f39ed2704da6049c6469d",
      "original_line" : 3416,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 46,
      "pull_request_review_id" : 1453931065,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212161483/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-31T19:10:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212161483",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1212164200"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212164200"
         }
      },
      "author_association" : "MEMBER",
      "body" : "534b6f99a3779465678f39ed2704da6049c6469d if it's broken in master, can we fix it _before_ refactoring? Alternatively there could be a `This will be fixed in the next commit` comment.\r\n\r\nI'm also confused by the comment. `TryAddBlockIndexCandidate` is only called from `ReceivedBlockTransactions` after it sets `BLOCK_VALID_TRANSACTIONS`. So are you saying we're currently too strict? Was there a regression somewhere? \r\n",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-05-31T18:50:12Z",
      "diff_hunk" : "@@ -3440,8 +3440,22 @@ void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {\n     }\n }\n \n+void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n+{\n+    // FIXME: the background-validation chainstate should only add new entries\n+    // that build on blocks for which we actually have all the data, while the\n+    // snapshot chainstate (if we have one) is able to build on blocks that are\n+    // missing but for which BLOCK_ASSUME_VALID is set.\n+    // So this is broken right now. XXX",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1212164200",
      "id" : 1212164200,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585IQCho",
      "original_commit_id" : "534b6f99a3779465678f39ed2704da6049c6469d",
      "original_line" : 3449,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1453931065,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212164200/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-31T19:10:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212164200",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1212173301"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212173301"
         }
      },
      "author_association" : "MEMBER",
      "body" : "534b6f99a3779465678f39ed2704da6049c6469d: `\"active\" :\"background\"`?",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-05-31T18:54:47Z",
      "diff_hunk" : "@@ -3440,8 +3440,22 @@ void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {\n     }\n }\n \n+void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n+{\n+    // FIXME: the background-validation chainstate should only add new entries\n+    // that build on blocks for which we actually have all the data, while the\n+    // snapshot chainstate (if we have one) is able to build on blocks that are\n+    // missing but for which BLOCK_ASSUME_VALID is set.\n+    // So this is broken right now. XXX\n+    AssertLockHeld(cs_main);\n+    if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {\n+        LogPrintf(\"TryAddBlockIndexCandidate: %s is now a candidate (%s)\\n\", pindex->GetBlockHash().ToString(), (this == &m_chainman.ActiveChainstate() ? \"active\" : \"inactive\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1212173301",
      "id" : 1212173301,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585IQEv1",
      "original_commit_id" : "534b6f99a3779465678f39ed2704da6049c6469d",
      "original_line" : 3452,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1453931065,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212173301/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-31T19:10:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212173301",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1212186629"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212186629"
         }
      },
      "author_association" : "MEMBER",
      "body" : "534b6f99a3779465678f39ed2704da6049c6469d Previously `LoadExternalBlockFile` was only called on the `ActiveChainstate()`, now you're looping over both. This is ok? If possible, it would be good to move the change to `LoadExternalBlockFile` into a separate commit.",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-05-31T19:06:19Z",
      "diff_hunk" : "@@ -4629,7 +4647,14 @@ void Chainstate::LoadExternalBlockFile(\n                 // Activate the genesis block so normal node progress can continue\n                 if (hash == params.GetConsensus().hashGenesisBlock) {\n                     BlockValidationState state;\n-                    if (!ActivateBestChain(state, nullptr)) {\n+                    bool genesis_activation_failure = false;\n+                    for (auto c : GetAll()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1212186629",
      "id" : 1212186629,
      "line" : 4602,
      "node_id" : "PRRC_kwDOABII585IQIAF",
      "original_commit_id" : "534b6f99a3779465678f39ed2704da6049c6469d",
      "original_line" : 4602,
      "original_position" : 206,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 308,
      "pull_request_review_id" : 1453931065,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212186629/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-31T19:10:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212186629",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> How do you see the division of labor between `ChainstateManager` and `BlockManager`? The `ChainState` doc currently says:\r\n> \r\n> > Anything that is contingent on the current tip of the chain is stored here, whereas block information and metadata independent of the current tip is kept in `BlockManager`.\r\n\r\nI think of `BlockManager` as being a generic backend database of block (and undo) data, while any validation-related logic should live in `Chainstate` (if it relies on chainstate-specific information) or somewhere else (either a static function in validation or in `ChainstateManager` as I propose here) if not.\r\n\r\nI think `AcceptBlock` could also be a static function in `validation.cpp`; I mostly just wanted to get it out of `Chainstate` because I think that having block storage be coupled to a particular chainstate is a confusing idea, but I can go either way on whether it belongs in ChainstateManager or not.",
      "created_at" : "2023-06-05T17:23:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1577187405",
      "id" : 1577187405,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27746",
      "node_id" : "IC_kwDOABII585eAfhN",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1577187405/reactions"
      },
      "updated_at" : "2023-06-05T17:23:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1577187405",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1227262047"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227262047"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 99e28b1a58b9864e4f393a2a065ef63f12eb8b85 \"Tighten requirements for adding elements to setBlockIndexCandidates\"\r\n\r\nIs this test case expected to fail with the changes in this commit or is it just expected to be incorrect? I tried re-enabling it and it passes.",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-12T21:27:34Z",
      "diff_hunk" : "@@ -96,15 +98,14 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     auto exp_tip2 = c2.m_chain.Tip();\n     BOOST_CHECK_EQUAL(active_tip2, exp_tip2);\n \n-    // Ensure that these pointers actually correspond to different\n-    // CCoinsViewCache instances.\n-    BOOST_CHECK(exp_tip != exp_tip2);\n-\n     // Let scheduler events finish running to avoid accessing memory that is going to be unloaded\n     SyncWithValidationInterfaceQueue();\n }\n \n //! Test rebalancing the caches associated with each chainstate.\n+// FIXME: Need to rewrite this test under the requirement that snapshots always\n+// correspond to blocks in the block index.\n+#if 0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1227262047",
      "id" : 1227262047,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JJohf",
      "original_commit_id" : "df3655c12cf3672bb1c08ded6228405ae933f05b",
      "original_line" : 108,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1475849986,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227262047/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-12T21:31:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227262047",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1227262861"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227262861"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 99e28b1a58b9864e4f393a2a065ef63f12eb8b85 \"Tighten requirements for adding elements to setBlockIndexCandidates\"\r\n\r\nIs this check expected to fail? I tried uncommenting it and the test passes.",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-12T21:28:41Z",
      "diff_hunk" : "@@ -349,7 +351,7 @@ struct SnapshotTestSetup : TestChain100Setup {\n         }\n \n         // Snapshot should refuse to load after one has already loaded.\n-        BOOST_REQUIRE(!CreateAndActivateUTXOSnapshot(this));\n+        //BOOST_REQUIRE(!CreateAndActivateUTXOSnapshot(this));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1227262861",
      "id" : 1227262861,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JJouN",
      "original_commit_id" : "df3655c12cf3672bb1c08ded6228405ae933f05b",
      "original_line" : 354,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1475849986,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227262861/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-12T21:31:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227262861",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1227265509"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227265509"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 99e28b1a58b9864e4f393a2a065ef63f12eb8b85 \"Tighten requirements for adding elements to setBlockIndexCandidates\"\r\n\r\nThis diff makes the test work, assuming that `TryAddBlockIndexCandidate` is working as it is supposed to be.\r\n\r\n```diff\r\ndiff --git a/src/test/validation_chainstatemanager_tests.cpp b/src/test/validation_chainstatemanager_tests.cpp\r\nindex 8fab53c5c5..b9fe054a64 100644\r\n--- a/src/test/validation_chainstatemanager_tests.cpp\r\n+++ b/src/test/validation_chainstatemanager_tests.cpp\r\n@@ -413,7 +411,6 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_activate_snapshot, SnapshotTestSetup)\r\n //!   chainstate only contains fully validated blocks and the other chainstate contains all blocks,\r\n //!   even those assumed-valid.\r\n //!\r\n-#if 0\r\n BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\r\n {\r\n     ChainstateManager& chainman = *Assert(m_node.chainman);\r\n@@ -427,6 +424,7 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\r\n     const int assumed_valid_start_idx = last_assumed_valid_idx - expected_assumed_valid;\r\n \r\n     CBlockIndex* validated_tip{nullptr};\r\n+    CBlockIndex* assumed_base{nullptr};\r\n     CBlockIndex* assumed_tip{WITH_LOCK(chainman.GetMutex(), return chainman.ActiveChain().Tip())};\r\n \r\n     auto reload_all_block_indexes = [&]() {\r\n@@ -440,10 +438,10 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\r\n         WITH_LOCK(::cs_main, chainman.LoadBlockIndex());\r\n     };\r\n \r\n-    // Ensure that without any assumed-valid BlockIndex entries, all entries are considered\r\n-    // tip candidates.\r\n+    // Ensure that without any assumed-valid BlockIndex entries, only the current tip is\r\n+    // considered as a candidate.\r\n     reload_all_block_indexes();\r\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), cs1.m_chain.Height() + 1);\r\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), 1);\r\n \r\n     // Mark some region of the chain assumed-valid.\r\n     for (int i = 0; i <= cs1.m_chain.Height(); ++i) {\r\n@@ -462,27 +460,33 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\r\n             validated_tip = index;\r\n             BOOST_CHECK(!index->IsAssumedValid());\r\n         }\r\n+        // Note the block after the last assumed valid block as the snapshot base\r\n+        if (i == last_assumed_valid_idx) {\r\n+            assumed_base = index;\r\n+            BOOST_CHECK(!index->IsAssumedValid());\r\n+        }\r\n     }\r\n \r\n     BOOST_CHECK_EQUAL(expected_assumed_valid, num_assumed_valid);\r\n \r\n     Chainstate& cs2 = WITH_LOCK(::cs_main,\r\n-        return chainman.ActivateExistingSnapshot(&mempool, GetRandHash()));\r\n+        return chainman.ActivateExistingSnapshot(&mempool, *assumed_base->phashBlock));\r\n+\r\n+    // Set tip of the fully validated chain to be the validated tip\r\n+    cs1.m_chain.SetTip(*validated_tip);\r\n \r\n     reload_all_block_indexes();\r\n \r\n-    // The fully validated chain only has candidates up to the start of the assumed-valid\r\n-    // blocks.\r\n+    // The fully validated chain should have the current validated tip, the assumed valid\r\n+    // blocks, and the assumed valid base as candidates.\r\n     BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(validated_tip), 1);\r\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(assumed_tip), 0);\r\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), assumed_valid_start_idx);\r\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), expected_assumed_valid + 2);\r\n \r\n     // The assumed-valid tolerant chain has all blocks as candidates.\r\n     BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.count(validated_tip), 1);\r\n     BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.count(assumed_tip), 1);\r\n     BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.size(), num_indexes);\r\n }\r\n-#endif\r\n \r\n //! Ensure that snapshot chainstates initialize properly when found on disk.\r\n BOOST_FIXTURE_TEST_CASE(chainstatemanager_snapshot_init, SnapshotTestSetup)\r\n```",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-12T21:31:38Z",
      "diff_hunk" : "@@ -411,6 +413,7 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_activate_snapshot, SnapshotTestSetup)\n //!   chainstate only contains fully validated blocks and the other chainstate contains all blocks,\n //!   even those assumed-valid.\n //!\n+#if 0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1227265509",
      "id" : 1227265509,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JJpXl",
      "original_commit_id" : "df3655c12cf3672bb1c08ded6228405ae933f05b",
      "original_line" : 416,
      "original_position" : 78,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1475849986,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227265509/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-12T21:31:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227265509",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228448590"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228448590"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Split this out into its own commit.",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-13T17:06:01Z",
      "diff_hunk" : "@@ -975,6 +932,25 @@ class ChainstateManager\n     //! chainstate to avoid duplicating block metadata.\n     node::BlockManager m_blockman;\n \n+    /**\n+     * Every received block is assigned a unique and increasing identifier, so we\n+     * know which one to give priority in case of a fork.\n+     */\n+    /** Blocks loaded from disk are assigned id 0, so start the counter at 1. */\n+    int32_t nBlockSequenceId GUARDED_BY(::cs_main) = 1;\n+    /** Decreasing counter (used by subsequent preciousblock calls). */\n+    int32_t nBlockReverseSequenceId = -1;\n+    /** chainwork for the last block that preciousblock has been applied to. */\n+    arith_uint256 nLastPreciousChainwork = 0;\n+\n+    void ResetBlockSequenceCounters() EXCLUSIVE_LOCKS_REQUIRED(::cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228448590",
      "id" : 1228448590,
      "in_reply_to_id" : 1212154654,
      "line" : 959,
      "node_id" : "PRRC_kwDOABII585JOKNO",
      "original_commit_id" : "534b6f99a3779465678f39ed2704da6049c6469d",
      "original_line" : 959,
      "original_position" : 101,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 115,
      "pull_request_review_id" : 1477683984,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228448590/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-13T17:06:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228448590",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228449099"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228449099"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this should be a bit better now?",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-13T17:06:32Z",
      "diff_hunk" : "@@ -3440,8 +3440,22 @@ void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {\n     }\n }\n \n+void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n+{\n+    // FIXME: the background-validation chainstate should only add new entries\n+    // that build on blocks for which we actually have all the data, while the\n+    // snapshot chainstate (if we have one) is able to build on blocks that are\n+    // missing but for which BLOCK_ASSUME_VALID is set.\n+    // So this is broken right now. XXX\n+    AssertLockHeld(cs_main);\n+    if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228449099",
      "id" : 1228449099,
      "in_reply_to_id" : 1212161483,
      "line" : 3416,
      "node_id" : "PRRC_kwDOABII585JOKVL",
      "original_commit_id" : "534b6f99a3779465678f39ed2704da6049c6469d",
      "original_line" : 3416,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 46,
      "pull_request_review_id" : 1477684761,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228449099/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-13T17:06:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228449099",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228470071"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228470071"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Sorry that comment was confusing.  I dropped it, and instead change the behavior around managing `setBlockIndexCandidates` in the last two commits. \r\n\r\nI think master has a couple bugs. When we start up, in `LoadBlockIndex()` we weren't adding blocks that have been downloaded and have more work than the background chainstate's tip to `setBlockIndexCandidates`, which prevents those blocks from being validated and connected on startup.  Also, because `AcceptBlock()` is a member of `Chainstate`, it's at best confusing to reason about whether a block that would advance the tip of a chainstate would always be added to a chainstate's `setBlockIndexCandidates` (it depends on yet-more logic around where a block came from and guessing about which chainstate might need it).\r\n\r\nThe new code tries to simplify things by establishing that the background chainstate is only trying to connect blocks towards the snapshot block, and that all blocks for which we HAVE_DATA and have more work than the background chainstate's tip (and which are ancestors of the snapshot block) will be added to the background chainstate's `setBlockIndexCandidates`. Also, the logic bug in `LoadBlockIndex` should be fixed in the last commit here.",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-13T17:27:27Z",
      "diff_hunk" : "@@ -3440,8 +3440,22 @@ void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {\n     }\n }\n \n+void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n+{\n+    // FIXME: the background-validation chainstate should only add new entries\n+    // that build on blocks for which we actually have all the data, while the\n+    // snapshot chainstate (if we have one) is able to build on blocks that are\n+    // missing but for which BLOCK_ASSUME_VALID is set.\n+    // So this is broken right now. XXX",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228470071",
      "id" : 1228470071,
      "in_reply_to_id" : 1212164200,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JOPc3",
      "original_commit_id" : "534b6f99a3779465678f39ed2704da6049c6469d",
      "original_line" : 3449,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1477717138,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228470071/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-13T17:27:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228470071",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228471308"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228471308"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This LogPrintf() disappeared during my edits, so this is gone now.",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-13T17:28:46Z",
      "diff_hunk" : "@@ -3440,8 +3440,22 @@ void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {\n     }\n }\n \n+void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n+{\n+    // FIXME: the background-validation chainstate should only add new entries\n+    // that build on blocks for which we actually have all the data, while the\n+    // snapshot chainstate (if we have one) is able to build on blocks that are\n+    // missing but for which BLOCK_ASSUME_VALID is set.\n+    // So this is broken right now. XXX\n+    AssertLockHeld(cs_main);\n+    if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {\n+        LogPrintf(\"TryAddBlockIndexCandidate: %s is now a candidate (%s)\\n\", pindex->GetBlockHash().ToString(), (this == &m_chainman.ActiveChainstate() ? \"active\" : \"inactive\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228471308",
      "id" : 1228471308,
      "in_reply_to_id" : 1212173301,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JOPwM",
      "original_commit_id" : "534b6f99a3779465678f39ed2704da6049c6469d",
      "original_line" : 3452,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1477719362,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228471308/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-13T17:28:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228471308",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228475690"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228475690"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If you're asking if it's ok to call `ActivateBestChain()` on both chainstates, the answer to that is essentially always \"yes\".  ABC() doesn't do anything if no new candidates for most-work chain have been added to our block index; but if any block that has more work than our tip is now available we want to try to connect it.\r\n\r\nWhen calling `LoadExternalBlockFile()`, we're adding blocks that theoretically could be of interest to either chainstate; so I think it makes sense to separate the block storage and import from any particular chainstate.\r\n\r\nI'm not sure how easy this would be to separate out into its own commit, because this invokes `AcceptBlock()` as well...  Hopefully the commit is more manageable now that I've split a bunch of other stuff out?  Let me know if you see a good way to shrink this commit more and I can take a stab at it.",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-13T17:33:03Z",
      "diff_hunk" : "@@ -4629,7 +4647,14 @@ void Chainstate::LoadExternalBlockFile(\n                 // Activate the genesis block so normal node progress can continue\n                 if (hash == params.GetConsensus().hashGenesisBlock) {\n                     BlockValidationState state;\n-                    if (!ActivateBestChain(state, nullptr)) {\n+                    bool genesis_activation_failure = false;\n+                    for (auto c : GetAll()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228475690",
      "id" : 1228475690,
      "in_reply_to_id" : 1212186629,
      "line" : 4602,
      "node_id" : "PRRC_kwDOABII585JOQ0q",
      "original_commit_id" : "534b6f99a3779465678f39ed2704da6049c6469d",
      "original_line" : 4602,
      "original_position" : 206,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 308,
      "pull_request_review_id" : 1477726472,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228475690/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-13T17:33:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228475690",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228476418"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228476418"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah, thanks for noticing this. I believe I had an earlier version of this branch with `assert()`'s added in to ensure that the snapshot base was never `nullptr`, and so this test had been failing.  I guess I removed those asserts before pushing...  I've re-enabled the test for now, but really this test should be re-written so that snapshots are always at blocks in the block index.",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-13T17:33:50Z",
      "diff_hunk" : "@@ -96,15 +98,14 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     auto exp_tip2 = c2.m_chain.Tip();\n     BOOST_CHECK_EQUAL(active_tip2, exp_tip2);\n \n-    // Ensure that these pointers actually correspond to different\n-    // CCoinsViewCache instances.\n-    BOOST_CHECK(exp_tip != exp_tip2);\n-\n     // Let scheduler events finish running to avoid accessing memory that is going to be unloaded\n     SyncWithValidationInterfaceQueue();\n }\n \n //! Test rebalancing the caches associated with each chainstate.\n+// FIXME: Need to rewrite this test under the requirement that snapshots always\n+// correspond to blocks in the block index.\n+#if 0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228476418",
      "id" : 1228476418,
      "in_reply_to_id" : 1227262047,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JORAC",
      "original_commit_id" : "df3655c12cf3672bb1c08ded6228405ae933f05b",
      "original_line" : 108,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1477727655,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228476418/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-13T17:33:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228476418",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228477327"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228477327"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I have no idea why I commented this out -- I've re-added as well.",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-13T17:34:46Z",
      "diff_hunk" : "@@ -349,7 +351,7 @@ struct SnapshotTestSetup : TestChain100Setup {\n         }\n \n         // Snapshot should refuse to load after one has already loaded.\n-        BOOST_REQUIRE(!CreateAndActivateUTXOSnapshot(this));\n+        //BOOST_REQUIRE(!CreateAndActivateUTXOSnapshot(this));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228477327",
      "id" : 1228477327,
      "in_reply_to_id" : 1227262861,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JOROP",
      "original_commit_id" : "df3655c12cf3672bb1c08ded6228405ae933f05b",
      "original_line" : 354,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1477729042,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228477327/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-13T17:34:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228477327",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228498661"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228498661"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks, I took these changes and re-enabled the test.",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-13T17:51:47Z",
      "diff_hunk" : "@@ -411,6 +413,7 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_activate_snapshot, SnapshotTestSetup)\n //!   chainstate only contains fully validated blocks and the other chainstate contains all blocks,\n //!   even those assumed-valid.\n //!\n+#if 0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228498661",
      "id" : 1228498661,
      "in_reply_to_id" : 1227265509,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JOWbl",
      "original_commit_id" : "df3655c12cf3672bb1c08ded6228405ae933f05b",
      "original_line" : 416,
      "original_position" : 78,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1477759637,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228498661/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-13T17:51:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228498661",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@sjors @achow101 Thanks for the review! I split up the big commit as @sjors suggested, and with the test fixes I think this is ready to be moved out of Draft status.\r\n",
      "created_at" : "2023-06-13T17:54:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1589777766",
      "id" : 1589777766,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27746",
      "node_id" : "IC_kwDOABII585ewhVm",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1589777766/reactions"
      },
      "updated_at" : "2023-06-13T17:54:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1589777766",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228709228"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228709228"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "typo: is -> if\r\nAlso, another way for `AcceptBlock()` to return false is if the block/header are valid, but `SaveBlockToDisk()` failed for some reason (e.g. missing disk space).",
      "commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "created_at" : "2023-06-13T21:21:13Z",
      "diff_hunk" : "@@ -1128,6 +1125,29 @@ class ChainstateManager\n      */\n     bool ProcessNewBlockHeaders(const std::vector<CBlockHeader>& block, bool min_pow_checked, BlockValidationState& state, const CBlockIndex** ppindex = nullptr) LOCKS_EXCLUDED(cs_main);\n \n+    /**\n+     * Sufficiently validate a block for disk storage (and store on disk).\n+     *\n+     * @param[in]   pblock          The block we want to process.\n+     * @param[in]   fRequested      Whether we requested this block from a\n+     *                              peer.\n+     * @param[in]   dbp             The location on disk, if we are importing\n+     *                              this block from prior storage.\n+     * @param[in]   min_pow_checked True if proof-of-work anti-DoS checks have\n+     *                              been done by caller for headers chain\n+     *\n+     * @param[out]  state       The state of the block validation.\n+     * @param[out]  ppindex     Optional return parameter to get the\n+     *                          CBlockIndex pointer for this block.\n+     * @param[out]  fNewBlock   Optional return parameter to indicate if the\n+     *                          block is new to our storage.\n+     *\n+     * @returns   False is the block or header is invalid; true otherwise.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228709228",
      "id" : 1228709228,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JPJ1s",
      "original_commit_id" : "ac3220a63ad1c4e73a8191f57ad921db04729af8",
      "original_line" : 1158,
      "original_position" : 114,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 1478071545,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228709228/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T21:59:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228709228",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1229850689"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229850689"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> this test should be re-written so that snapshots are always at blocks in the block index.\r\n\r\nDoes it? AFAICT, it doesn't test anything within the block index at all, and the only part that does is `LoadGenesisBlock`.",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-14T15:57:05Z",
      "diff_hunk" : "@@ -96,15 +98,14 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     auto exp_tip2 = c2.m_chain.Tip();\n     BOOST_CHECK_EQUAL(active_tip2, exp_tip2);\n \n-    // Ensure that these pointers actually correspond to different\n-    // CCoinsViewCache instances.\n-    BOOST_CHECK(exp_tip != exp_tip2);\n-\n     // Let scheduler events finish running to avoid accessing memory that is going to be unloaded\n     SyncWithValidationInterfaceQueue();\n }\n \n //! Test rebalancing the caches associated with each chainstate.\n+// FIXME: Need to rewrite this test under the requirement that snapshots always\n+// correspond to blocks in the block index.\n+#if 0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1229850689",
      "id" : 1229850689,
      "in_reply_to_id" : 1227262047,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JTghB",
      "original_commit_id" : "df3655c12cf3672bb1c08ded6228405ae933f05b",
      "original_line" : 108,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1479818774,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229850689/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T15:57:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229850689",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1229858664"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229858664"
         }
      },
      "author_association" : "MEMBER",
      "body" : "See https://github.com/bitcoin/bitcoin/pull/27746/files#diff-dbada1fe3a3d0af884304dd28be8c9df74b592401dec2c6400f6b491aefe6c9bL141\r\n\r\n```c++\r\nChainstate& c2 = WITH_LOCK(cs_main, return manager.ActivateExistingSnapshot(&mempool, GetRandHash()));\r\n```\r\n\r\nTrying to activate a snapshot for a block that is not in the block index ought to be an illegal operation.",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-14T16:03:01Z",
      "diff_hunk" : "@@ -96,15 +98,14 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     auto exp_tip2 = c2.m_chain.Tip();\n     BOOST_CHECK_EQUAL(active_tip2, exp_tip2);\n \n-    // Ensure that these pointers actually correspond to different\n-    // CCoinsViewCache instances.\n-    BOOST_CHECK(exp_tip != exp_tip2);\n-\n     // Let scheduler events finish running to avoid accessing memory that is going to be unloaded\n     SyncWithValidationInterfaceQueue();\n }\n \n //! Test rebalancing the caches associated with each chainstate.\n+// FIXME: Need to rewrite this test under the requirement that snapshots always\n+// correspond to blocks in the block index.\n+#if 0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1229858664",
      "id" : 1229858664,
      "in_reply_to_id" : 1227262047,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JTido",
      "original_commit_id" : "df3655c12cf3672bb1c08ded6228405ae933f05b",
      "original_line" : 108,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1479831868,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229858664/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T16:09:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229858664",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1229903387"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229903387"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah I see. Seems like this could be easily resolved by using `TestChain100Setup`\r\n\r\n```diff\r\ndiff --git a/src/test/validation_chainstatemanager_tests.cpp b/src/test/validation_chainstatemanager_tests.cpp\r\nindex 2d0e1705fd..3d90bdcc26 100644\r\n--- a/src/test/validation_chainstatemanager_tests.cpp\r\n+++ b/src/test/validation_chainstatemanager_tests.cpp\r\n@@ -105,7 +105,7 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\r\n }\r\n \r\n //! Test rebalancing the caches associated with each chainstate.\r\n-BOOST_AUTO_TEST_CASE(chainstatemanager_rebalance_caches)\r\n+BOOST_FIXTURE_TEST_CASE(chainstatemanager_rebalance_caches, TestChain100Setup)\r\n {\r\n     ChainstateManager& manager = *m_node.chainman;\r\n     CTxMemPool& mempool = *m_node.mempool;\r\n@@ -118,7 +118,7 @@ BOOST_AUTO_TEST_CASE(chainstatemanager_rebalance_caches)\r\n \r\n     // Create a legacy (IBD) chainstate.\r\n     //\r\n-    Chainstate& c1 = WITH_LOCK(::cs_main, return manager.InitializeChainstate(&mempool));\r\n+    Chainstate& c1 = manager.ActiveChainstate();\r\n     chainstates.push_back(&c1);\r\n     c1.InitCoinsDB(\r\n         /*cache_size_bytes=*/1 << 23, /*in_memory=*/true, /*should_wipe=*/false);\r\n@@ -126,8 +126,6 @@ BOOST_AUTO_TEST_CASE(chainstatemanager_rebalance_caches)\r\n     {\r\n         LOCK(::cs_main);\r\n         c1.InitCoinsCache(1 << 23);\r\n-        BOOST_REQUIRE(c1.LoadGenesisBlock());\r\n-        c1.CoinsTip().SetBestBlock(InsecureRand256());\r\n         manager.MaybeRebalanceCaches();\r\n     }\r\n \r\n@@ -136,7 +134,8 @@ BOOST_AUTO_TEST_CASE(chainstatemanager_rebalance_caches)\r\n \r\n     // Create a snapshot-based chainstate.\r\n     //\r\n-    Chainstate& c2 = WITH_LOCK(cs_main, return manager.ActivateExistingSnapshot(&mempool, GetRandHash()));\r\n+    CBlockIndex* snapshot_base{WITH_LOCK(manager.GetMutex(), return manager.ActiveChain()[manager.ActiveChain().Height() / 2])};\r\n+    Chainstate& c2 = WITH_LOCK(cs_main, return manager.ActivateExistingSnapshot(&mempool, *snapshot_base->phashBlock));\r\n     chainstates.push_back(&c2);\r\n     c2.InitCoinsDB(\r\n         /*cache_size_bytes=*/1 << 23, /*in_memory=*/true, /*should_wipe=*/false);\r\n@@ -144,8 +143,6 @@ BOOST_AUTO_TEST_CASE(chainstatemanager_rebalance_caches)\r\n     {\r\n         LOCK(::cs_main);\r\n         c2.InitCoinsCache(1 << 23);\r\n-        BOOST_REQUIRE(c2.LoadGenesisBlock());\r\n-        c2.CoinsTip().SetBestBlock(InsecureRand256());\r\n         manager.MaybeRebalanceCaches();\r\n     }\r\n \r\n```",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-14T16:42:20Z",
      "diff_hunk" : "@@ -96,15 +98,14 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     auto exp_tip2 = c2.m_chain.Tip();\n     BOOST_CHECK_EQUAL(active_tip2, exp_tip2);\n \n-    // Ensure that these pointers actually correspond to different\n-    // CCoinsViewCache instances.\n-    BOOST_CHECK(exp_tip != exp_tip2);\n-\n     // Let scheduler events finish running to avoid accessing memory that is going to be unloaded\n     SyncWithValidationInterfaceQueue();\n }\n \n //! Test rebalancing the caches associated with each chainstate.\n+// FIXME: Need to rewrite this test under the requirement that snapshots always\n+// correspond to blocks in the block index.\n+#if 0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1229903387",
      "id" : 1229903387,
      "in_reply_to_id" : 1227262047,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JTtYb",
      "original_commit_id" : "df3655c12cf3672bb1c08ded6228405ae933f05b",
      "original_line" : 108,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1479901411,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229903387/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T16:42:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229903387",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1230085759"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1230085759"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "how about inserting and returning here in the `!is_bg_chainstate` case, so that we can skip the `GetAncestor()` call when dealing with the snapshot chainstate?",
      "commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "created_at" : "2023-06-14T19:42:25Z",
      "diff_hunk" : "@@ -3414,7 +3414,17 @@ void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n     AssertLockHeld(cs_main);\n     // If the block has more work than our tip, then it should be a candidate for most-work-chain.\n     if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {\n-        setBlockIndexCandidates.insert(pindex);\n+        // The active chainstate should always add entries that have more work than the tip.\n+        // For the background chainstate, we only consider connecting blocks\n+        // towards the snapshot base.\n+        bool is_bg_chainstate = m_chainman.IsSnapshotActive() && m_chainman.IsBackgroundChainstate(this) && !m_disabled;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1230085759",
      "id" : 1230085759,
      "line" : 3417,
      "node_id" : "PRRC_kwDOABII585JUZ5_",
      "original_commit_id" : "e08dc8c14fc9dbd97db46482052ecb8d4163cfc2",
      "original_line" : 3417,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 47,
      "pull_request_review_id" : 1478071545,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1230085759/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T21:59:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1230085759",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1230212278"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1230212278"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't think this line does anything. It's called during init from `LoadChainstate() -> DetectSnapshotChainstate()`, at which point `m_snapshot_chainstate->m_snapshot_entry` isn't set yet. That only happens right after, in `CompleteChainstateInitialization() -> LoadBlockIndex()`.\r\n\r\nThe ctor of `Chainstate` also wouldn't have set `m_snapshot_entry` for the same reason (the block index is loaded after the chainstate).",
      "commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "created_at" : "2023-06-14T21:58:00Z",
      "diff_hunk" : "@@ -5644,6 +5659,7 @@ Chainstate& ChainstateManager::ActivateExistingSnapshot(CTxMemPool* mempool, uin\n         std::make_unique<Chainstate>(mempool, m_blockman, *this, base_blockhash);\n     LogPrintf(\"[snapshot] switching active chainstate to %s\\n\", m_snapshot_chainstate->ToString());\n     m_active_chainstate = m_snapshot_chainstate.get();\n+    m_ibd_chainstate->m_snapshot_entry = m_snapshot_chainstate->m_snapshot_entry;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1230212278",
      "id" : 1230212278,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JU4y2",
      "original_commit_id" : "1880b5412e6ac457dd3462b768a03d7b81ad0c96",
      "original_line" : 5662,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1478071545,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1230212278/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T22:25:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1230212278",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1231392094"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1231392094"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thank you! I took this and updated the commit where this test was changed.",
      "commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "created_at" : "2023-06-15T18:22:15Z",
      "diff_hunk" : "@@ -96,15 +98,14 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     auto exp_tip2 = c2.m_chain.Tip();\n     BOOST_CHECK_EQUAL(active_tip2, exp_tip2);\n \n-    // Ensure that these pointers actually correspond to different\n-    // CCoinsViewCache instances.\n-    BOOST_CHECK(exp_tip != exp_tip2);\n-\n     // Let scheduler events finish running to avoid accessing memory that is going to be unloaded\n     SyncWithValidationInterfaceQueue();\n }\n \n //! Test rebalancing the caches associated with each chainstate.\n+// FIXME: Need to rewrite this test under the requirement that snapshots always\n+// correspond to blocks in the block index.\n+#if 0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1231392094",
      "id" : 1231392094,
      "in_reply_to_id" : 1227262047,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JZY1e",
      "original_commit_id" : "df3655c12cf3672bb1c08ded6228405ae933f05b",
      "original_line" : 108,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1482164683,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1231392094/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-15T18:22:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1231392094",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1231392237"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1231392237"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "created_at" : "2023-06-15T18:22:24Z",
      "diff_hunk" : "@@ -1128,6 +1125,29 @@ class ChainstateManager\n      */\n     bool ProcessNewBlockHeaders(const std::vector<CBlockHeader>& block, bool min_pow_checked, BlockValidationState& state, const CBlockIndex** ppindex = nullptr) LOCKS_EXCLUDED(cs_main);\n \n+    /**\n+     * Sufficiently validate a block for disk storage (and store on disk).\n+     *\n+     * @param[in]   pblock          The block we want to process.\n+     * @param[in]   fRequested      Whether we requested this block from a\n+     *                              peer.\n+     * @param[in]   dbp             The location on disk, if we are importing\n+     *                              this block from prior storage.\n+     * @param[in]   min_pow_checked True if proof-of-work anti-DoS checks have\n+     *                              been done by caller for headers chain\n+     *\n+     * @param[out]  state       The state of the block validation.\n+     * @param[out]  ppindex     Optional return parameter to get the\n+     *                          CBlockIndex pointer for this block.\n+     * @param[out]  fNewBlock   Optional return parameter to indicate if the\n+     *                          block is new to our storage.\n+     *\n+     * @returns   False is the block or header is invalid; true otherwise.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1231392237",
      "id" : 1231392237,
      "in_reply_to_id" : 1228709228,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JZY3t",
      "original_commit_id" : "ac3220a63ad1c4e73a8191f57ad921db04729af8",
      "original_line" : 1158,
      "original_position" : 114,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 1482165009,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1231392237/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-15T18:22:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1231392237",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1231392858"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1231392858"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Agreed, good idea.",
      "commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "created_at" : "2023-06-15T18:22:53Z",
      "diff_hunk" : "@@ -3414,7 +3414,17 @@ void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n     AssertLockHeld(cs_main);\n     // If the block has more work than our tip, then it should be a candidate for most-work-chain.\n     if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {\n-        setBlockIndexCandidates.insert(pindex);\n+        // The active chainstate should always add entries that have more work than the tip.\n+        // For the background chainstate, we only consider connecting blocks\n+        // towards the snapshot base.\n+        bool is_bg_chainstate = m_chainman.IsSnapshotActive() && m_chainman.IsBackgroundChainstate(this) && !m_disabled;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1231392858",
      "id" : 1231392858,
      "in_reply_to_id" : 1230085759,
      "line" : 3417,
      "node_id" : "PRRC_kwDOABII585JZZBa",
      "original_commit_id" : "e08dc8c14fc9dbd97db46482052ecb8d4163cfc2",
      "original_line" : 3417,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 47,
      "pull_request_review_id" : 1482165706,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1231392858/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-15T18:22:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1231392858",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1231393061"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1231393061"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good catch, removed this and left a comment there instead.",
      "commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "created_at" : "2023-06-15T18:23:02Z",
      "diff_hunk" : "@@ -5644,6 +5659,7 @@ Chainstate& ChainstateManager::ActivateExistingSnapshot(CTxMemPool* mempool, uin\n         std::make_unique<Chainstate>(mempool, m_blockman, *this, base_blockhash);\n     LogPrintf(\"[snapshot] switching active chainstate to %s\\n\", m_snapshot_chainstate->ToString());\n     m_active_chainstate = m_snapshot_chainstate.get();\n+    m_ibd_chainstate->m_snapshot_entry = m_snapshot_chainstate->m_snapshot_entry;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1231393061",
      "id" : 1231393061,
      "in_reply_to_id" : 1230212278,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JZZEl",
      "original_commit_id" : "1880b5412e6ac457dd3462b768a03d7b81ad0c96",
      "original_line" : 5662,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1482165883,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1231393061/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-15T18:23:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1231393061",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232107866"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232107866"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Explicitly track maximum block height stored in undo files\" (6cc09f4759444218d1b493a1bcf44bb63f3160d2)\r\n\r\nWhen I first read this comment, I misinterpreted \"whose undo data is in m_last_blockfile\" to mean \"whose undo data belongs in m_last_blockfile\" as opposed to \"whose undo data has already been written to m_last_blockfile\". So I was confused about how it was working. Would suggest changing this sentence to something like \"Track the height of the highest block in m_last_blockfile whose undo data has been written.\"\r\n\r\nI also don't think if would hurt if there could be more explanation after this like: \"Block data is written to block files in download order, but is written to undo files in validation order, which is usually in order by height. To avoid wasting disk space, undo files will be will trimmed whenever the corresponding block file is finalized and the height of the highest block written to the block file equals the height of the highest block written to the undo file. This is a heuristic and can sometimes preemptively trim undo files that will write more data later, and sometimes fail to trim undo files that can't have more data written later.\"",
      "commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "created_at" : "2023-06-16T11:07:14Z",
      "diff_hunk" : "@@ -126,6 +126,12 @@ class BlockManager\n     RecursiveMutex cs_LastBlockFile;\n     std::vector<CBlockFileInfo> m_blockfile_info;\n     int m_last_blockfile = 0;\n+    // Track the largest height block whose undo data is in m_last_blockfile.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232107866",
      "id" : 1232107866,
      "line" : 128,
      "node_id" : "PRRC_kwDOABII585JcHla",
      "original_commit_id" : "6cc09f4759444218d1b493a1bcf44bb63f3160d2",
      "original_line" : 129,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.h",
      "position" : 21,
      "pull_request_review_id" : 1483231139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232107866/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-16T23:01:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232107866",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232240800"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232240800"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Move block-arrival information / preciousblock counters to ChainstateManager\" (2ebdfa8529b222de0db6d7114e9e5a1622fecfd0)\r\n\r\nJust IMO, but I think it would good to delete the `m_chainman.nBlockSequenceId = 1` line in this commit instead of next commit \"Add wrapper for adding entries to a chainstates block index candidates\" (df6576d48e4daff2b9787fe7d2d254ffce2eb998). I also think it would also be good to rename `UnloadBlockIndex` to `ClearBlockIndexCandidates` here. Doing these things would leave the code in a less confusing state after this commit, even if it makes this diff a little bigger.",
      "commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "created_at" : "2023-06-16T13:17:30Z",
      "diff_hunk" : "@@ -4370,7 +4370,7 @@ bool Chainstate::NeedsRedownload() const\n void Chainstate::UnloadBlockIndex()\n {\n     AssertLockHeld(::cs_main);\n-    nBlockSequenceId = 1;\n+    m_chainman.nBlockSequenceId = 1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232240800",
      "id" : 1232240800,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JcoCg",
      "original_commit_id" : "2ebdfa8529b222de0db6d7114e9e5a1622fecfd0",
      "original_line" : 4373,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1483231139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232240800/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-16T23:01:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232240800",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232489431"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232489431"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Tighten requirements for adding elements to setBlockIndexCandidates\" (b0b48b3e986319fe8cd5a80052099070279ce5c0)\r\n\r\nNote for reviewers: A real hash is being passed instead of GetRandHash() now, because of discussion https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1227262047, because `ActivateExistingSnapshot` should not be expected to work when called with an invalid blockhash even if it does work now.",
      "commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "created_at" : "2023-06-16T16:39:26Z",
      "diff_hunk" : "@@ -138,16 +134,15 @@ BOOST_AUTO_TEST_CASE(chainstatemanager_rebalance_caches)\n \n     // Create a snapshot-based chainstate.\n     //\n-    Chainstate& c2 = WITH_LOCK(cs_main, return manager.ActivateExistingSnapshot(&mempool, GetRandHash()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232489431",
      "id" : 1232489431,
      "line" : 141,
      "node_id" : "PRRC_kwDOABII585JdkvX",
      "original_commit_id" : "b0b48b3e986319fe8cd5a80052099070279ce5c0",
      "original_line" : 141,
      "original_position" : 78,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 78,
      "pull_request_review_id" : 1483231139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232489431/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-16T23:01:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232489431",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232578002"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232578002"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Update CheckBlockIndex invariants for snapshotted chains\" (bb47ea918c19cd7063f529c0087bd156af18b499):\r\n\r\nI think this also needs to add `if (pindex == pindexFirstAssumeValid) pindexFirstAssumeValid = nullptr;` at line 4881 to reset `pindexFirstAssumeValid` when moving to a sibling.",
      "commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "created_at" : "2023-06-16T18:08:43Z",
      "diff_hunk" : "@@ -4711,12 +4711,14 @@ void Chainstate::CheckBlockIndex()\n     CBlockIndex* pindexFirstNotTransactionsValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_TRANSACTIONS (regardless of being valid or not).\n     CBlockIndex* pindexFirstNotChainValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_CHAIN (regardless of being valid or not).\n     CBlockIndex* pindexFirstNotScriptsValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_SCRIPTS (regardless of being valid or not).\n+    CBlockIndex* pindexFirstAssumeValid = nullptr; // Oldest ancestor of pindex which has BLOCK_ASSUMED_VALID\n     while (pindex != nullptr) {\n         nNodes++;\n+        if (pindexFirstAssumeValid == nullptr && pindex->nStatus & BLOCK_ASSUMED_VALID) pindexFirstAssumeValid = pindex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232578002",
      "id" : 1232578002,
      "line" : 4726,
      "node_id" : "PRRC_kwDOABII585Jd6XS",
      "original_commit_id" : "bb47ea918c19cd7063f529c0087bd156af18b499",
      "original_line" : 4717,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 354,
      "pull_request_review_id" : 1483231139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232578002/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-16T23:01:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232578002",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232705541"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232705541"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Update CheckBlockIndex invariants for snapshotted chains\" (bb47ea918c19cd7063f529c0087bd156af18b499)\r\n\r\nNote: This change is partially reverting [`8f5710f`](https://github.com/bitcoin/bitcoin/pull/21526/commits/8f5710fd0ac5173b577e5d00708485170b321bcc) from #21526",
      "commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "created_at" : "2023-06-16T20:03:10Z",
      "diff_hunk" : "@@ -4711,12 +4711,14 @@ void Chainstate::CheckBlockIndex()\n     CBlockIndex* pindexFirstNotTransactionsValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_TRANSACTIONS (regardless of being valid or not).\n     CBlockIndex* pindexFirstNotChainValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_CHAIN (regardless of being valid or not).\n     CBlockIndex* pindexFirstNotScriptsValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_SCRIPTS (regardless of being valid or not).\n+    CBlockIndex* pindexFirstAssumeValid = nullptr; // Oldest ancestor of pindex which has BLOCK_ASSUMED_VALID\n     while (pindex != nullptr) {\n         nNodes++;\n+        if (pindexFirstAssumeValid == nullptr && pindex->nStatus & BLOCK_ASSUMED_VALID) pindexFirstAssumeValid = pindex;\n         if (pindexFirstInvalid == nullptr && pindex->nStatus & BLOCK_FAILED_VALID) pindexFirstInvalid = pindex;\n         // Assumed-valid index entries will not have data since we haven't downloaded the\n         // full block yet.\n-        if (pindexFirstMissing == nullptr && !(pindex->nStatus & BLOCK_HAVE_DATA) && !pindex->IsAssumedValid()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232705541",
      "id" : 1232705541,
      "line" : 4713,
      "node_id" : "PRRC_kwDOABII585JeZgF",
      "original_commit_id" : "bb47ea918c19cd7063f529c0087bd156af18b499",
      "original_line" : 4719,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 358,
      "pull_request_review_id" : 1483231139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232705541/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-16T23:01:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232705541",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232733285"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232733285"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Update CheckBlockIndex invariants for snapshotted chains\" (bb47ea918c19cd7063f529c0087bd156af18b499)\r\n\r\nShould also delete this \"Assumed-valid index entries will not have data\" comment, I think, since it doesn't really explain anything and no longer seems relevant here",
      "commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "created_at" : "2023-06-16T20:14:07Z",
      "diff_hunk" : "@@ -4711,12 +4711,14 @@ void Chainstate::CheckBlockIndex()\n     CBlockIndex* pindexFirstNotTransactionsValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_TRANSACTIONS (regardless of being valid or not).\n     CBlockIndex* pindexFirstNotChainValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_CHAIN (regardless of being valid or not).\n     CBlockIndex* pindexFirstNotScriptsValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_SCRIPTS (regardless of being valid or not).\n+    CBlockIndex* pindexFirstAssumeValid = nullptr; // Oldest ancestor of pindex which has BLOCK_ASSUMED_VALID\n     while (pindex != nullptr) {\n         nNodes++;\n+        if (pindexFirstAssumeValid == nullptr && pindex->nStatus & BLOCK_ASSUMED_VALID) pindexFirstAssumeValid = pindex;\n         if (pindexFirstInvalid == nullptr && pindex->nStatus & BLOCK_FAILED_VALID) pindexFirstInvalid = pindex;\n         // Assumed-valid index entries will not have data since we haven't downloaded the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232733285",
      "id" : 1232733285,
      "line" : 4728,
      "node_id" : "PRRC_kwDOABII585JegRl",
      "original_commit_id" : "bb47ea918c19cd7063f529c0087bd156af18b499",
      "original_line" : 4719,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 356,
      "pull_request_review_id" : 1483231139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232733285/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-16T23:01:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232733285",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232743393"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232743393"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Update CheckBlockIndex invariants for snapshotted chains\" (bb47ea918c19cd7063f529c0087bd156af18b499)\r\n\r\nThis is very pedantic but the phrase \"snapshotted chain\" here and in the commit description doesn't really parse for me. It sounds like a chain a snapshot was created from, not a chain created from a snapshot. Could maybe replace \"snapshotted chain\" with \"chain based on assumeutxo snapshot\"",
      "commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "created_at" : "2023-06-16T20:25:25Z",
      "diff_hunk" : "@@ -4837,7 +4845,12 @@ void Chainstate::CheckBlockIndex()\n             // So if this block is itself better than m_chain.Tip() and it wasn't in\n             // setBlockIndexCandidates, then it must be in m_blocks_unlinked.\n             if (!CBlockIndexWorkComparator()(pindex, m_chain.Tip()) && setBlockIndexCandidates.count(pindex) == 0) {\n-                if (pindexFirstInvalid == nullptr) {\n+                if (pindexFirstInvalid == nullptr && pindexFirstAssumeValid == nullptr) {\n+                    // If this is a snapshotted chain, then this block could",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232743393",
      "id" : 1232743393,
      "line" : 4858,
      "node_id" : "PRRC_kwDOABII585Jeivh",
      "original_commit_id" : "bb47ea918c19cd7063f529c0087bd156af18b499",
      "original_line" : 4849,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 393,
      "pull_request_review_id" : 1483231139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232743393/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-16T23:01:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232743393",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232771857"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232771857"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Fix initialization of setBlockIndexCandidates when working with multiple chainstates\" (f02125f1c7ba1c77c6d4ddb028999090fe5298eb)\r\n\r\nI think it would be good to drop this whole for-loop. The loop was originally added in [`0fd599a`](https://github.com/bitcoin/bitcoin/pull/23174/commits/0fd599a51a700c028d6f7ed8067d2d9f6e6a04a5) from #23174 to compute `first_assumed_valid_height`. Adding the asserts there was really an afterthought, so keeping this loop just to make assertions about ChainStateManager doesn't seem worth it. Dropping the loop and asserts would also allow dropping the reliesOnAssumedValid method, which would be nice to get rid of.",
      "commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "created_at" : "2023-06-16T20:54:46Z",
      "diff_hunk" : "@@ -4446,9 +4443,6 @@ bool ChainstateManager::LoadBlockIndex()\n                 assert(any_chain([](auto chainstate) { return chainstate->reliesOnAssumedValid(); }));\n                 assert(any_chain([](auto chainstate) { return !chainstate->reliesOnAssumedValid(); }));\n \n-                first_assumed_valid_height = block->nHeight;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232771857",
      "id" : 1232771857,
      "line" : 4407,
      "node_id" : "PRRC_kwDOABII585JepsR",
      "original_commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "original_line" : 4449,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 228,
      "pull_request_review_id" : 1483231139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232771857/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-16T23:01:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232771857",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232772481"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232772481"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In b0b48b3e986319fe8cd5a80052099070279ce5c0 \"Tighten requirements for adding elements to setBlockIndexCandidates\"\r\n\r\nnit: can inline\r\n\r\n```suggestion\r\n            if (m_snapshot_entry->GetAncestor(pindex->nHeight) == pindex) {\r\n```",
      "commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "created_at" : "2023-06-16T20:55:51Z",
      "diff_hunk" : "@@ -3414,7 +3414,21 @@ void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n     AssertLockHeld(cs_main);\n     // If the block has more work than our tip, then it should be a candidate for most-work-chain.\n     if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {\n-        setBlockIndexCandidates.insert(pindex);\n+        bool is_bg_chainstate = m_chainman.IsSnapshotActive() && m_chainman.IsBackgroundChainstate(this) && !m_disabled;\n+        if (!is_bg_chainstate) {\n+            // The active chainstate should always add entries that have more\n+            // work than the tip.\n+            setBlockIndexCandidates.insert(pindex);\n+        } else {\n+            // For the background chainstate, we only consider connecting blocks\n+            // towards the snapshot base (which can't be nullptr or else we'll\n+            // never make progress).\n+            assert(m_snapshot_entry != nullptr);\n+            bool ancestor_of_snapshot_base = (m_snapshot_entry->GetAncestor(pindex->nHeight) == pindex);\n+            if (ancestor_of_snapshot_base) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232772481",
      "id" : 1232772481,
      "line" : 3428,
      "node_id" : "PRRC_kwDOABII585Jep2B",
      "original_commit_id" : "b0b48b3e986319fe8cd5a80052099070279ce5c0",
      "original_line" : 3428,
      "original_position" : 16,
      "original_start_line" : 3427,
      "path" : "src/validation.cpp",
      "position" : 58,
      "pull_request_review_id" : 1484375498,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232772481/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 3427,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-06-16T21:16:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232772481",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232795224"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232795224"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Explicitly track snapshot block header when using multiple chainstates\" (d2ccbd3541622147ab0d4b808a1b9388ddcd7948)\r\n\r\nI don't think adding this `Chainstate::m_snapshot_entry` variable is a good idea. I don't like how it has different meanings for different chainstates (starting point of validation for the snapshot chainstate, and ending point for the background chainstate), and the lack of documentation, and the complicated initialization which happens in the Chainstate constructor for the snapshot chainstate, but also in `ActivateSnapshot` for both chainstates, and then again in `LoadBlockIndex` for both chainstates, and pointedly _not_ in `ActivateExistingSnapshot` according to a new comment there saying it will be initialized later... It just seems like a lot of complexity for new variable which is redundant with the existing `m_from_snapshot_blockhash` variable and is only used one place, in `Chainstate::TryAddBlockIndexCandidate`.\r\n\r\nI think it would be better if `Chainstate::TryAddBlockIndexCandidate` just used snapshot chainstate's `m_from_snapshot_blockhash` value directly. Or if that is too inefficient, we could add a `m_from_snapshot_blockindex` member that mirrors `m_from_snapshot_blockhash` and is const and could be initialized straightforwardly in the `ChainState` constructor.",
      "commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "created_at" : "2023-06-16T21:25:58Z",
      "diff_hunk" : "@@ -491,6 +491,13 @@ class Chainstate\n     //! is set to true on the snapshot chainstate.\n     bool m_disabled GUARDED_BY(::cs_main) {false};\n \n+    void UpdateSnapshotBaseEntry(const CBlockIndex *entry) EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n+        { m_snapshot_entry = entry; }\n+\n+    //! Track the snapshot entry",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232795224",
      "id" : 1232795224,
      "line" : 497,
      "node_id" : "PRRC_kwDOABII585JevZY",
      "original_commit_id" : "d2ccbd3541622147ab0d4b808a1b9388ddcd7948",
      "original_line" : 497,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 25,
      "pull_request_review_id" : 1483231139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232795224/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-16T23:01:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232795224",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232807245"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232807245"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228470071e\r\n\r\n> I think master has a couple bugs.\r\n\r\nI'm curious if there is actually more than one bug. The one bug I know about is the bug introduced \r\n[`0fd599a`](https://github.com/bitcoin/bitcoin/pull/23174/commits/0fd599a51a700c028d6f7ed8067d2d9f6e6a04a5) from #23174 where `LoadBlockIndex` is misinterpreting the `BLOCK_ASSUMED_VALID` flag, and setting `first_assumed_valid_height` to the height of the first assumed valid block, instead of the height of the first block after the last assumed valid block (i.e. the snapshot height). I think it's pretty bad that we didn't catch this bug in review, or push for a more realistic test that would have caught it, or followed up on the suggestion from Marco https://github.com/bitcoin/bitcoin/pull/23174#discussion_r768600512 to just add blocks to `setBlockIndexCandidates` linearly, which is what this PR does, and is much more straightforward.\r\n\r\nAre there other known bugs? Are the changes to `AcceptBlock` meant to fix a bug or more to prevent a potential bug? Does the change to `ChainstateManager::ReceivedBlockTransactions` fix a bug? It seems like maybe it could prevent inappropriate blocks being added as candidates to the background chainstate, but it's not clear.",
      "commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "created_at" : "2023-06-16T21:37:44Z",
      "diff_hunk" : "@@ -3440,8 +3440,22 @@ void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {\n     }\n }\n \n+void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n+{\n+    // FIXME: the background-validation chainstate should only add new entries\n+    // that build on blocks for which we actually have all the data, while the\n+    // snapshot chainstate (if we have one) is able to build on blocks that are\n+    // missing but for which BLOCK_ASSUME_VALID is set.\n+    // So this is broken right now. XXX",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232807245",
      "id" : 1232807245,
      "in_reply_to_id" : 1212164200,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JeyVN",
      "original_commit_id" : "534b6f99a3779465678f39ed2704da6049c6469d",
      "original_line" : 3449,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1483231139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232807245/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-16T23:01:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232807245",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232868270"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232868270"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think I concur with @ryanofsky here. I'll have to double check, but in actual usage in #27596, I think I found that the one usage of this had another (existing) way of getting at this data. I'm afk for a few days, but will verify when I get back.",
      "commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "created_at" : "2023-06-16T23:06:31Z",
      "diff_hunk" : "@@ -491,6 +491,13 @@ class Chainstate\n     //! is set to true on the snapshot chainstate.\n     bool m_disabled GUARDED_BY(::cs_main) {false};\n \n+    void UpdateSnapshotBaseEntry(const CBlockIndex *entry) EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n+        { m_snapshot_entry = entry; }\n+\n+    //! Track the snapshot entry",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232868270",
      "id" : 1232868270,
      "in_reply_to_id" : 1232795224,
      "line" : 497,
      "node_id" : "PRRC_kwDOABII585JfBOu",
      "original_commit_id" : "d2ccbd3541622147ab0d4b808a1b9388ddcd7948",
      "original_line" : 497,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 25,
      "pull_request_review_id" : 1484538346,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232868270/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-16T23:06:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232868270",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232921513"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232921513"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I agree with your criticisms that the way this is written is pretty confusing (it took me a while to get it right in the first place, and I found this hard to reason about).  \r\n\r\nI wanted to capture the idea that the hash `m_from_snapshot_blockhash` must always be in our block index, so that we never have to worry when we look it up in the block index that it might be missing, and we have to deal with a nullptr case.\r\n\r\nHowever, I couldn't see how to make it a const that is straightforwardly initialized in `Chainstate`, because there are two different cases to consider (activating a snapshot for the first time, versus detecting that we have a snapshot on restart).\r\n\r\nAlso, while this PR introduces one place where this CBlockIndex is used, I expect that we'll use it again in the `net_processing` code which will download blocks toward the snapshot base.\r\n\r\nHere are a few options I can think of to improve this:\r\n* just look the hash up every time we need to use it (both in `TryAddBlockIndexCandidate` and wherever it is needed in `net_processing`, likely one additional place), avoiding the storage of redundant information\r\n* lazily fill it in so that we only look it up once, and then use the looked-up value for future requests\r\n* move the knowledge of the snapshot base to `ChainstateManager`, so that we don't store redundant information in both chainstates (this could be done along with either of the first two ideas, I think?)\r\n",
      "commit_id" : "1aebb99a10f9977e1d1bf4b923e2a2e984c76160",
      "created_at" : "2023-06-17T01:19:05Z",
      "diff_hunk" : "@@ -491,6 +491,13 @@ class Chainstate\n     //! is set to true on the snapshot chainstate.\n     bool m_disabled GUARDED_BY(::cs_main) {false};\n \n+    void UpdateSnapshotBaseEntry(const CBlockIndex *entry) EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n+        { m_snapshot_entry = entry; }\n+\n+    //! Track the snapshot entry",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232921513",
      "id" : 1232921513,
      "in_reply_to_id" : 1232795224,
      "line" : 497,
      "node_id" : "PRRC_kwDOABII585JfOOp",
      "original_commit_id" : "d2ccbd3541622147ab0d4b808a1b9388ddcd7948",
      "original_line" : 497,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 25,
      "pull_request_review_id" : 1484629167,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232921513/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-17T01:19:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232921513",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232921766"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232921766"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done in 0274b79285f781c3374678208dc3e00607907c7f",
      "commit_id" : "1aebb99a10f9977e1d1bf4b923e2a2e984c76160",
      "created_at" : "2023-06-17T01:21:07Z",
      "diff_hunk" : "@@ -3414,7 +3414,21 @@ void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n     AssertLockHeld(cs_main);\n     // If the block has more work than our tip, then it should be a candidate for most-work-chain.\n     if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {\n-        setBlockIndexCandidates.insert(pindex);\n+        bool is_bg_chainstate = m_chainman.IsSnapshotActive() && m_chainman.IsBackgroundChainstate(this) && !m_disabled;\n+        if (!is_bg_chainstate) {\n+            // The active chainstate should always add entries that have more\n+            // work than the tip.\n+            setBlockIndexCandidates.insert(pindex);\n+        } else {\n+            // For the background chainstate, we only consider connecting blocks\n+            // towards the snapshot base (which can't be nullptr or else we'll\n+            // never make progress).\n+            assert(m_snapshot_entry != nullptr);\n+            bool ancestor_of_snapshot_base = (m_snapshot_entry->GetAncestor(pindex->nHeight) == pindex);\n+            if (ancestor_of_snapshot_base) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232921766",
      "id" : 1232921766,
      "in_reply_to_id" : 1232772481,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JfOSm",
      "original_commit_id" : "b0b48b3e986319fe8cd5a80052099070279ce5c0",
      "original_line" : 3428,
      "original_position" : 16,
      "original_start_line" : 3427,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1484629417,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232921766/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-06-17T01:21:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232921766",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232921860"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232921860"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks -- this is much better, took your language in daeba143a718c95b11432aed909781affe33efea.",
      "commit_id" : "1aebb99a10f9977e1d1bf4b923e2a2e984c76160",
      "created_at" : "2023-06-17T01:22:04Z",
      "diff_hunk" : "@@ -126,6 +126,12 @@ class BlockManager\n     RecursiveMutex cs_LastBlockFile;\n     std::vector<CBlockFileInfo> m_blockfile_info;\n     int m_last_blockfile = 0;\n+    // Track the largest height block whose undo data is in m_last_blockfile.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232921860",
      "id" : 1232921860,
      "in_reply_to_id" : 1232107866,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JfOUE",
      "original_commit_id" : "6cc09f4759444218d1b493a1bcf44bb63f3160d2",
      "original_line" : 129,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.h",
      "position" : null,
      "pull_request_review_id" : 1484629548,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232921860/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-17T01:22:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232921860",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232922177"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232922177"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed in 95680a6e90bbf27183dcf09b5c450494d356ebe5.\r\nGood catch, thanks.  It seems unfortunate that this wasn't caught by any unit tests; perhaps we should come up with a test case that will more fully exercise all of the `CheckBlockIndex()` logic?",
      "commit_id" : "1aebb99a10f9977e1d1bf4b923e2a2e984c76160",
      "created_at" : "2023-06-17T01:22:51Z",
      "diff_hunk" : "@@ -4711,12 +4711,14 @@ void Chainstate::CheckBlockIndex()\n     CBlockIndex* pindexFirstNotTransactionsValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_TRANSACTIONS (regardless of being valid or not).\n     CBlockIndex* pindexFirstNotChainValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_CHAIN (regardless of being valid or not).\n     CBlockIndex* pindexFirstNotScriptsValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_SCRIPTS (regardless of being valid or not).\n+    CBlockIndex* pindexFirstAssumeValid = nullptr; // Oldest ancestor of pindex which has BLOCK_ASSUMED_VALID\n     while (pindex != nullptr) {\n         nNodes++;\n+        if (pindexFirstAssumeValid == nullptr && pindex->nStatus & BLOCK_ASSUMED_VALID) pindexFirstAssumeValid = pindex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232922177",
      "id" : 1232922177,
      "in_reply_to_id" : 1232578002,
      "line" : 4709,
      "node_id" : "PRRC_kwDOABII585JfOZB",
      "original_commit_id" : "bb47ea918c19cd7063f529c0087bd156af18b499",
      "original_line" : 4717,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 361,
      "pull_request_review_id" : 1484629997,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232922177/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-17T01:22:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232922177",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232922226"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232922226"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good catch, that comment was incorrect (blocks retain their assumevalid status until they are validated, which can be some time after they are downloaded).  Removed this comment in 95680a6e90bbf27183dcf09b5c450494d356ebe5.",
      "commit_id" : "1aebb99a10f9977e1d1bf4b923e2a2e984c76160",
      "created_at" : "2023-06-17T01:23:14Z",
      "diff_hunk" : "@@ -4711,12 +4711,14 @@ void Chainstate::CheckBlockIndex()\n     CBlockIndex* pindexFirstNotTransactionsValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_TRANSACTIONS (regardless of being valid or not).\n     CBlockIndex* pindexFirstNotChainValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_CHAIN (regardless of being valid or not).\n     CBlockIndex* pindexFirstNotScriptsValid = nullptr; // Oldest ancestor of pindex which does not have BLOCK_VALID_SCRIPTS (regardless of being valid or not).\n+    CBlockIndex* pindexFirstAssumeValid = nullptr; // Oldest ancestor of pindex which has BLOCK_ASSUMED_VALID\n     while (pindex != nullptr) {\n         nNodes++;\n+        if (pindexFirstAssumeValid == nullptr && pindex->nStatus & BLOCK_ASSUMED_VALID) pindexFirstAssumeValid = pindex;\n         if (pindexFirstInvalid == nullptr && pindex->nStatus & BLOCK_FAILED_VALID) pindexFirstInvalid = pindex;\n         // Assumed-valid index entries will not have data since we haven't downloaded the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232922226",
      "id" : 1232922226,
      "in_reply_to_id" : 1232733285,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JfOZy",
      "original_commit_id" : "bb47ea918c19cd7063f529c0087bd156af18b499",
      "original_line" : 4719,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1484630070,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232922226/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-17T01:23:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232922226",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232922290"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232922290"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good point, fixed in this place in the code in 95680a6e90bbf27183dcf09b5c450494d356ebe5.  Will try to fix up the commit descriptions when I squash/rebase. \r\n\r\nEdit: this is now fixed in the commit messages as well.",
      "commit_id" : "1ce79c5672989c20ba7c927fac2cb8d525ba7525",
      "created_at" : "2023-06-17T01:23:50Z",
      "diff_hunk" : "@@ -4837,7 +4845,12 @@ void Chainstate::CheckBlockIndex()\n             // So if this block is itself better than m_chain.Tip() and it wasn't in\n             // setBlockIndexCandidates, then it must be in m_blocks_unlinked.\n             if (!CBlockIndexWorkComparator()(pindex, m_chain.Tip()) && setBlockIndexCandidates.count(pindex) == 0) {\n-                if (pindexFirstInvalid == nullptr) {\n+                if (pindexFirstInvalid == nullptr && pindexFirstAssumeValid == nullptr) {\n+                    // If this is a snapshotted chain, then this block could",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232922290",
      "id" : 1232922290,
      "in_reply_to_id" : 1232743393,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JfOay",
      "original_commit_id" : "bb47ea918c19cd7063f529c0087bd156af18b499",
      "original_line" : 4849,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1484630205,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232922290/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-17T13:20:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232922290",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232923062"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232923062"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah, ok -- I've removed this in 1aebb99a10f9977e1d1bf4b923e2a2e984c76160.\r\n\r\nSo, one thing I haven't fixed yet is the reference to `pindex->IsAssumedValid()` just below this for loop:\r\n\r\n```c++\r\n\r\n        for (CBlockIndex* pindex : vSortedByHeight) {\r\n            if (ShutdownRequested()) return false;\r\n            if (pindex->IsAssumedValid() ||\r\n                    (pindex->IsValid(BLOCK_VALID_TRANSACTIONS) &&\r\n                     (pindex->HaveTxsDownloaded() || pindex->pprev == nullptr))) {\r\n\r\n                for (Chainstate* chainstate : GetAll()) {\r\n                    chainstate->TryAddBlockIndexCandidate(pindex);\r\n                }\r\n            }\r\n```\r\n\r\nReally, the assumed-valid status bit has nothing to do with whether a block index should be a most-work-chain candidate, except that right when a snapshot is activated, we need the base block to be added to `setBlockIndexCandidates` for the chain that is based on that snapshot.  Probably I should fix this in this PR as well?",
      "commit_id" : "1aebb99a10f9977e1d1bf4b923e2a2e984c76160",
      "created_at" : "2023-06-17T01:27:09Z",
      "diff_hunk" : "@@ -4446,9 +4443,6 @@ bool ChainstateManager::LoadBlockIndex()\n                 assert(any_chain([](auto chainstate) { return chainstate->reliesOnAssumedValid(); }));\n                 assert(any_chain([](auto chainstate) { return !chainstate->reliesOnAssumedValid(); }));\n \n-                first_assumed_valid_height = block->nHeight;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232923062",
      "id" : 1232923062,
      "in_reply_to_id" : 1232771857,
      "line" : 4407,
      "node_id" : "PRRC_kwDOABII585JfOm2",
      "original_commit_id" : "f02125f1c7ba1c77c6d4ddb028999090fe5298eb",
      "original_line" : 4449,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 232,
      "pull_request_review_id" : 1484631732,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232923062/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-17T01:27:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232923062",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232925887"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232925887"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I guess the fairest thing to say is that the changes to `AcceptBlock()` are to prevent a future bug -- it's possible that we could write code that somehow gets it right, but the design of selectively adding blocks to one chainstate's block index, and not the other, is one that I found very confusing. \r\n\r\nAs an example, if you took #24008 (which proposed logic for determining which chainstate to invoke AcceptBlock() on) and combined that with changing the logic in `AcceptBlock()` so that the background chainstate wouldn't bother processing blocks that are past the snapshot base, then that would be problematic if we were to allow pruning the snapshot-based-chain while the background sync is running (because according to the logic in #24008, if the block is already on the active chain, then we give it to the background chainstate to process).  That's 2 hypotheticals so certainly this is speculative, but I think that those changes would all make sense on their own, so the fact that they fail to compose with the code in master is a sign to me that we should take a different design.",
      "commit_id" : "1aebb99a10f9977e1d1bf4b923e2a2e984c76160",
      "created_at" : "2023-06-17T01:46:17Z",
      "diff_hunk" : "@@ -3440,8 +3440,22 @@ void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {\n     }\n }\n \n+void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n+{\n+    // FIXME: the background-validation chainstate should only add new entries\n+    // that build on blocks for which we actually have all the data, while the\n+    // snapshot chainstate (if we have one) is able to build on blocks that are\n+    // missing but for which BLOCK_ASSUME_VALID is set.\n+    // So this is broken right now. XXX",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232925887",
      "id" : 1232925887,
      "in_reply_to_id" : 1212164200,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JfPS_",
      "original_commit_id" : "534b6f99a3779465678f39ed2704da6049c6469d",
      "original_line" : 3449,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1484635600,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232925887/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-17T01:46:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232925887",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks @ryanofsky for the detailed review.  I've addressed many of the comments in fixup commits, which are tagged here for easier review:  [27746.1](https://github.com/sdaftuar/bitcoin/tree/27746.1).  I've now squashed those fixups into place and pushed.  Still outstanding for me to look at:\r\n\r\n- [ ] Move AcceptBlock to not be a member of ChainstateManager. I think you're right that this is better if we pull it out of the class.\r\n- [x] Clean up the commits mentioned here: https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232240800\r\n- [ ] Resolve the issue mentioned here: https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232795224\r\n- [ ] Fix the usage of `pindex->IsAssumedValid()` that I mentioned here: https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232923062\r\n- [ ] See if I can add some kind of test that would have caught the bug you mentioned in CheckBlockIndex here: https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1232922177",
      "created_at" : "2023-06-17T13:19:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1595757923",
      "id" : 1595757923,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27746",
      "node_id" : "IC_kwDOABII585fHVVj",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1595757923/reactions"
      },
      "updated_at" : "2023-06-17T13:29:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1595757923",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1233062742"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233062742"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done in latest push.",
      "commit_id" : "1ce79c5672989c20ba7c927fac2cb8d525ba7525",
      "created_at" : "2023-06-17T13:29:42Z",
      "diff_hunk" : "@@ -4370,7 +4370,7 @@ bool Chainstate::NeedsRedownload() const\n void Chainstate::UnloadBlockIndex()\n {\n     AssertLockHeld(::cs_main);\n-    nBlockSequenceId = 1;\n+    m_chainman.nBlockSequenceId = 1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1233062742",
      "id" : 1233062742,
      "in_reply_to_id" : 1232240800,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JfwtW",
      "original_commit_id" : "2ebdfa8529b222de0db6d7114e9e5a1622fecfd0",
      "original_line" : 4373,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1484825023,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233062742/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-17T13:29:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233062742",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   }
]
