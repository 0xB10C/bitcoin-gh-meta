[
   {
      "author_association" : "MEMBER",
      "body" : "Great! Thanks for this. I'm active in these neighborhoods today as well, since adding some `-stopatheight`/restart logic to the functional tests in #27596 has turned up some issues with `CheckBlockIndex()`, which are maybe related to some of the changes here. So I'll be looking at this shortly.",
      "created_at" : "2023-05-24T20:05:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1561858383",
      "id" : 1561858383,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27746",
      "node_id" : "IC_kwDOABII585dGBFP",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1561858383/reactions"
      },
      "updated_at" : "2023-05-24T20:05:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1561858383",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#27711](https://github.com/bitcoin/bitcoin/pull/27711) (kernel: Remove shutdown from kernel library by TheCharlatan)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-05-25T06:05:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#issuecomment-1562326140",
      "id" : 1562326140,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27746",
      "node_id" : "IC_kwDOABII585dHzR8",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1562326140/reactions"
      },
      "updated_at" : "2023-05-25T07:49:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1562326140",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1212154654"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212154654"
         }
      },
      "author_association" : "MEMBER",
      "body" : "534b6f99a3779465678f39ed2704da6049c6469d: this function seems to come out of nowhere and is only used in a test. ",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-05-31T18:43:09Z",
      "diff_hunk" : "@@ -975,6 +932,25 @@ class ChainstateManager\n     //! chainstate to avoid duplicating block metadata.\n     node::BlockManager m_blockman;\n \n+    /**\n+     * Every received block is assigned a unique and increasing identifier, so we\n+     * know which one to give priority in case of a fork.\n+     */\n+    /** Blocks loaded from disk are assigned id 0, so start the counter at 1. */\n+    int32_t nBlockSequenceId GUARDED_BY(::cs_main) = 1;\n+    /** Decreasing counter (used by subsequent preciousblock calls). */\n+    int32_t nBlockReverseSequenceId = -1;\n+    /** chainwork for the last block that preciousblock has been applied to. */\n+    arith_uint256 nLastPreciousChainwork = 0;\n+\n+    void ResetBlockSequenceCounters() EXCLUSIVE_LOCKS_REQUIRED(::cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1212154654",
      "id" : 1212154654,
      "line" : 959,
      "node_id" : "PRRC_kwDOABII585IQAMe",
      "original_commit_id" : "534b6f99a3779465678f39ed2704da6049c6469d",
      "original_line" : 959,
      "original_position" : 101,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 115,
      "pull_request_review_id" : 1453921658,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212154654/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-31T18:44:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212154654",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1212161483"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212161483"
         }
      },
      "author_association" : "MEMBER",
      "body" : "534b6f99a3779465678f39ed2704da6049c6469d: maybe use this refactor as an opportunity to add a comment explaining the somewhat obtuse line above",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-05-31T18:48:56Z",
      "diff_hunk" : "@@ -3440,8 +3440,22 @@ void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {\n     }\n }\n \n+void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n+{\n+    // FIXME: the background-validation chainstate should only add new entries\n+    // that build on blocks for which we actually have all the data, while the\n+    // snapshot chainstate (if we have one) is able to build on blocks that are\n+    // missing but for which BLOCK_ASSUME_VALID is set.\n+    // So this is broken right now. XXX\n+    AssertLockHeld(cs_main);\n+    if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1212161483",
      "id" : 1212161483,
      "line" : 3416,
      "node_id" : "PRRC_kwDOABII585IQB3L",
      "original_commit_id" : "534b6f99a3779465678f39ed2704da6049c6469d",
      "original_line" : 3416,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 46,
      "pull_request_review_id" : 1453931065,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212161483/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-31T19:10:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212161483",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1212164200"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212164200"
         }
      },
      "author_association" : "MEMBER",
      "body" : "534b6f99a3779465678f39ed2704da6049c6469d if it's broken in master, can we fix it _before_ refactoring? Alternatively there could be a `This will be fixed in the next commit` comment.\r\n\r\nI'm also confused by the comment. `TryAddBlockIndexCandidate` is only called from `ReceivedBlockTransactions` after it sets `BLOCK_VALID_TRANSACTIONS`. So are you saying we're currently too strict? Was there a regression somewhere? \r\n",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-05-31T18:50:12Z",
      "diff_hunk" : "@@ -3440,8 +3440,22 @@ void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {\n     }\n }\n \n+void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n+{\n+    // FIXME: the background-validation chainstate should only add new entries\n+    // that build on blocks for which we actually have all the data, while the\n+    // snapshot chainstate (if we have one) is able to build on blocks that are\n+    // missing but for which BLOCK_ASSUME_VALID is set.\n+    // So this is broken right now. XXX",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1212164200",
      "id" : 1212164200,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585IQCho",
      "original_commit_id" : "534b6f99a3779465678f39ed2704da6049c6469d",
      "original_line" : 3449,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1453931065,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212164200/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-31T19:10:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212164200",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1212173301"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212173301"
         }
      },
      "author_association" : "MEMBER",
      "body" : "534b6f99a3779465678f39ed2704da6049c6469d: `\"active\" :\"background\"`?",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-05-31T18:54:47Z",
      "diff_hunk" : "@@ -3440,8 +3440,22 @@ void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {\n     }\n }\n \n+void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n+{\n+    // FIXME: the background-validation chainstate should only add new entries\n+    // that build on blocks for which we actually have all the data, while the\n+    // snapshot chainstate (if we have one) is able to build on blocks that are\n+    // missing but for which BLOCK_ASSUME_VALID is set.\n+    // So this is broken right now. XXX\n+    AssertLockHeld(cs_main);\n+    if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {\n+        LogPrintf(\"TryAddBlockIndexCandidate: %s is now a candidate (%s)\\n\", pindex->GetBlockHash().ToString(), (this == &m_chainman.ActiveChainstate() ? \"active\" : \"inactive\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1212173301",
      "id" : 1212173301,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585IQEv1",
      "original_commit_id" : "534b6f99a3779465678f39ed2704da6049c6469d",
      "original_line" : 3452,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1453931065,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212173301/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-31T19:10:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212173301",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1212186629"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212186629"
         }
      },
      "author_association" : "MEMBER",
      "body" : "534b6f99a3779465678f39ed2704da6049c6469d Previously `LoadExternalBlockFile` was only called on the `ActiveChainstate()`, now you're looping over both. This is ok? If possible, it would be good to move the change to `LoadExternalBlockFile` into a separate commit.",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-05-31T19:06:19Z",
      "diff_hunk" : "@@ -4629,7 +4647,14 @@ void Chainstate::LoadExternalBlockFile(\n                 // Activate the genesis block so normal node progress can continue\n                 if (hash == params.GetConsensus().hashGenesisBlock) {\n                     BlockValidationState state;\n-                    if (!ActivateBestChain(state, nullptr)) {\n+                    bool genesis_activation_failure = false;\n+                    for (auto c : GetAll()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1212186629",
      "id" : 1212186629,
      "line" : 4602,
      "node_id" : "PRRC_kwDOABII585IQIAF",
      "original_commit_id" : "534b6f99a3779465678f39ed2704da6049c6469d",
      "original_line" : 4602,
      "original_position" : 206,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 308,
      "pull_request_review_id" : 1453931065,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212186629/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-31T19:10:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1212186629",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1227262047"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227262047"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 99e28b1a58b9864e4f393a2a065ef63f12eb8b85 \"Tighten requirements for adding elements to setBlockIndexCandidates\"\r\n\r\nIs this test case expected to fail with the changes in this commit or is it just expected to be incorrect? I tried re-enabling it and it passes.",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-12T21:27:34Z",
      "diff_hunk" : "@@ -96,15 +98,14 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     auto exp_tip2 = c2.m_chain.Tip();\n     BOOST_CHECK_EQUAL(active_tip2, exp_tip2);\n \n-    // Ensure that these pointers actually correspond to different\n-    // CCoinsViewCache instances.\n-    BOOST_CHECK(exp_tip != exp_tip2);\n-\n     // Let scheduler events finish running to avoid accessing memory that is going to be unloaded\n     SyncWithValidationInterfaceQueue();\n }\n \n //! Test rebalancing the caches associated with each chainstate.\n+// FIXME: Need to rewrite this test under the requirement that snapshots always\n+// correspond to blocks in the block index.\n+#if 0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1227262047",
      "id" : 1227262047,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JJohf",
      "original_commit_id" : "df3655c12cf3672bb1c08ded6228405ae933f05b",
      "original_line" : 108,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1475849986,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227262047/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-12T21:31:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227262047",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1227262861"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227262861"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 99e28b1a58b9864e4f393a2a065ef63f12eb8b85 \"Tighten requirements for adding elements to setBlockIndexCandidates\"\r\n\r\nIs this check expected to fail? I tried uncommenting it and the test passes.",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-12T21:28:41Z",
      "diff_hunk" : "@@ -349,7 +351,7 @@ struct SnapshotTestSetup : TestChain100Setup {\n         }\n \n         // Snapshot should refuse to load after one has already loaded.\n-        BOOST_REQUIRE(!CreateAndActivateUTXOSnapshot(this));\n+        //BOOST_REQUIRE(!CreateAndActivateUTXOSnapshot(this));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1227262861",
      "id" : 1227262861,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JJouN",
      "original_commit_id" : "df3655c12cf3672bb1c08ded6228405ae933f05b",
      "original_line" : 354,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1475849986,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227262861/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-12T21:31:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227262861",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1227265509"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227265509"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 99e28b1a58b9864e4f393a2a065ef63f12eb8b85 \"Tighten requirements for adding elements to setBlockIndexCandidates\"\r\n\r\nThis diff makes the test work, assuming that `TryAddBlockIndexCandidate` is working as it is supposed to be.\r\n\r\n```diff\r\ndiff --git a/src/test/validation_chainstatemanager_tests.cpp b/src/test/validation_chainstatemanager_tests.cpp\r\nindex 8fab53c5c5..b9fe054a64 100644\r\n--- a/src/test/validation_chainstatemanager_tests.cpp\r\n+++ b/src/test/validation_chainstatemanager_tests.cpp\r\n@@ -413,7 +411,6 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_activate_snapshot, SnapshotTestSetup)\r\n //!   chainstate only contains fully validated blocks and the other chainstate contains all blocks,\r\n //!   even those assumed-valid.\r\n //!\r\n-#if 0\r\n BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\r\n {\r\n     ChainstateManager& chainman = *Assert(m_node.chainman);\r\n@@ -427,6 +424,7 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\r\n     const int assumed_valid_start_idx = last_assumed_valid_idx - expected_assumed_valid;\r\n \r\n     CBlockIndex* validated_tip{nullptr};\r\n+    CBlockIndex* assumed_base{nullptr};\r\n     CBlockIndex* assumed_tip{WITH_LOCK(chainman.GetMutex(), return chainman.ActiveChain().Tip())};\r\n \r\n     auto reload_all_block_indexes = [&]() {\r\n@@ -440,10 +438,10 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\r\n         WITH_LOCK(::cs_main, chainman.LoadBlockIndex());\r\n     };\r\n \r\n-    // Ensure that without any assumed-valid BlockIndex entries, all entries are considered\r\n-    // tip candidates.\r\n+    // Ensure that without any assumed-valid BlockIndex entries, only the current tip is\r\n+    // considered as a candidate.\r\n     reload_all_block_indexes();\r\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), cs1.m_chain.Height() + 1);\r\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), 1);\r\n \r\n     // Mark some region of the chain assumed-valid.\r\n     for (int i = 0; i <= cs1.m_chain.Height(); ++i) {\r\n@@ -462,27 +460,33 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\r\n             validated_tip = index;\r\n             BOOST_CHECK(!index->IsAssumedValid());\r\n         }\r\n+        // Note the block after the last assumed valid block as the snapshot base\r\n+        if (i == last_assumed_valid_idx) {\r\n+            assumed_base = index;\r\n+            BOOST_CHECK(!index->IsAssumedValid());\r\n+        }\r\n     }\r\n \r\n     BOOST_CHECK_EQUAL(expected_assumed_valid, num_assumed_valid);\r\n \r\n     Chainstate& cs2 = WITH_LOCK(::cs_main,\r\n-        return chainman.ActivateExistingSnapshot(&mempool, GetRandHash()));\r\n+        return chainman.ActivateExistingSnapshot(&mempool, *assumed_base->phashBlock));\r\n+\r\n+    // Set tip of the fully validated chain to be the validated tip\r\n+    cs1.m_chain.SetTip(*validated_tip);\r\n \r\n     reload_all_block_indexes();\r\n \r\n-    // The fully validated chain only has candidates up to the start of the assumed-valid\r\n-    // blocks.\r\n+    // The fully validated chain should have the current validated tip, the assumed valid\r\n+    // blocks, and the assumed valid base as candidates.\r\n     BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(validated_tip), 1);\r\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(assumed_tip), 0);\r\n-    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), assumed_valid_start_idx);\r\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), expected_assumed_valid + 2);\r\n \r\n     // The assumed-valid tolerant chain has all blocks as candidates.\r\n     BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.count(validated_tip), 1);\r\n     BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.count(assumed_tip), 1);\r\n     BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.size(), num_indexes);\r\n }\r\n-#endif\r\n \r\n //! Ensure that snapshot chainstates initialize properly when found on disk.\r\n BOOST_FIXTURE_TEST_CASE(chainstatemanager_snapshot_init, SnapshotTestSetup)\r\n```",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-12T21:31:38Z",
      "diff_hunk" : "@@ -411,6 +413,7 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_activate_snapshot, SnapshotTestSetup)\n //!   chainstate only contains fully validated blocks and the other chainstate contains all blocks,\n //!   even those assumed-valid.\n //!\n+#if 0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1227265509",
      "id" : 1227265509,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JJpXl",
      "original_commit_id" : "df3655c12cf3672bb1c08ded6228405ae933f05b",
      "original_line" : 416,
      "original_position" : 78,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1475849986,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227265509/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-12T21:31:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227265509",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228448590"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228448590"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Split this out into its own commit.",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-13T17:06:01Z",
      "diff_hunk" : "@@ -975,6 +932,25 @@ class ChainstateManager\n     //! chainstate to avoid duplicating block metadata.\n     node::BlockManager m_blockman;\n \n+    /**\n+     * Every received block is assigned a unique and increasing identifier, so we\n+     * know which one to give priority in case of a fork.\n+     */\n+    /** Blocks loaded from disk are assigned id 0, so start the counter at 1. */\n+    int32_t nBlockSequenceId GUARDED_BY(::cs_main) = 1;\n+    /** Decreasing counter (used by subsequent preciousblock calls). */\n+    int32_t nBlockReverseSequenceId = -1;\n+    /** chainwork for the last block that preciousblock has been applied to. */\n+    arith_uint256 nLastPreciousChainwork = 0;\n+\n+    void ResetBlockSequenceCounters() EXCLUSIVE_LOCKS_REQUIRED(::cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228448590",
      "id" : 1228448590,
      "in_reply_to_id" : 1212154654,
      "line" : 959,
      "node_id" : "PRRC_kwDOABII585JOKNO",
      "original_commit_id" : "534b6f99a3779465678f39ed2704da6049c6469d",
      "original_line" : 959,
      "original_position" : 101,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 115,
      "pull_request_review_id" : 1477683984,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228448590/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-13T17:06:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228448590",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228449099"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228449099"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this should be a bit better now?",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-13T17:06:32Z",
      "diff_hunk" : "@@ -3440,8 +3440,22 @@ void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {\n     }\n }\n \n+void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n+{\n+    // FIXME: the background-validation chainstate should only add new entries\n+    // that build on blocks for which we actually have all the data, while the\n+    // snapshot chainstate (if we have one) is able to build on blocks that are\n+    // missing but for which BLOCK_ASSUME_VALID is set.\n+    // So this is broken right now. XXX\n+    AssertLockHeld(cs_main);\n+    if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228449099",
      "id" : 1228449099,
      "in_reply_to_id" : 1212161483,
      "line" : 3416,
      "node_id" : "PRRC_kwDOABII585JOKVL",
      "original_commit_id" : "534b6f99a3779465678f39ed2704da6049c6469d",
      "original_line" : 3416,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 46,
      "pull_request_review_id" : 1477684761,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228449099/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-13T17:06:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228449099",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228470071"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228470071"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Sorry that comment was confusing.  I dropped it, and instead change the behavior around managing `setBlockIndexCandidates` in the last two commits. \r\n\r\nI think master has a couple bugs. When we start up, in `LoadBlockIndex()` we weren't adding blocks that have been downloaded and have more work than the background chainstate's tip to `setBlockIndexCandidates`, which prevents those blocks from being validated and connected on startup.  Also, because `AcceptBlock()` is a member of `Chainstate`, it's at best confusing to reason about whether a block that would advance the tip of a chainstate would always be added to a chainstate's `setBlockIndexCandidates` (it depends on yet-more logic around where a block came from and guessing about which chainstate might need it).\r\n\r\nThe new code tries to simplify things by establishing that the background chainstate is only trying to connect blocks towards the snapshot block, and that all blocks for which we HAVE_DATA and have more work than the background chainstate's tip (and which are ancestors of the snapshot block) will be added to the background chainstate's `setBlockIndexCandidates`. Also, the logic bug in `LoadBlockIndex` should be fixed in the last commit here.",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-13T17:27:27Z",
      "diff_hunk" : "@@ -3440,8 +3440,22 @@ void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {\n     }\n }\n \n+void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n+{\n+    // FIXME: the background-validation chainstate should only add new entries\n+    // that build on blocks for which we actually have all the data, while the\n+    // snapshot chainstate (if we have one) is able to build on blocks that are\n+    // missing but for which BLOCK_ASSUME_VALID is set.\n+    // So this is broken right now. XXX",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228470071",
      "id" : 1228470071,
      "in_reply_to_id" : 1212164200,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JOPc3",
      "original_commit_id" : "534b6f99a3779465678f39ed2704da6049c6469d",
      "original_line" : 3449,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1477717138,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228470071/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-13T17:27:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228470071",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228471308"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228471308"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This LogPrintf() disappeared during my edits, so this is gone now.",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-13T17:28:46Z",
      "diff_hunk" : "@@ -3440,8 +3440,22 @@ void Chainstate::ResetBlockFailureFlags(CBlockIndex *pindex) {\n     }\n }\n \n+void Chainstate::TryAddBlockIndexCandidate(CBlockIndex* pindex)\n+{\n+    // FIXME: the background-validation chainstate should only add new entries\n+    // that build on blocks for which we actually have all the data, while the\n+    // snapshot chainstate (if we have one) is able to build on blocks that are\n+    // missing but for which BLOCK_ASSUME_VALID is set.\n+    // So this is broken right now. XXX\n+    AssertLockHeld(cs_main);\n+    if (m_chain.Tip() == nullptr || !setBlockIndexCandidates.value_comp()(pindex, m_chain.Tip())) {\n+        LogPrintf(\"TryAddBlockIndexCandidate: %s is now a candidate (%s)\\n\", pindex->GetBlockHash().ToString(), (this == &m_chainman.ActiveChainstate() ? \"active\" : \"inactive\"));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228471308",
      "id" : 1228471308,
      "in_reply_to_id" : 1212173301,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JOPwM",
      "original_commit_id" : "534b6f99a3779465678f39ed2704da6049c6469d",
      "original_line" : 3452,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1477719362,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228471308/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-13T17:28:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228471308",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228475690"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228475690"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If you're asking if it's ok to call `ActivateBestChain()` on both chainstates, the answer to that is essentially always \"yes\".  ABC() doesn't do anything if no new candidates for most-work chain have been added to our block index; but if any block that has more work than our tip is now available we want to try to connect it.\r\n\r\nWhen calling `LoadExternalBlockFile()`, we're adding blocks that theoretically could be of interest to either chainstate; so I think it makes sense to separate the block storage and import from any particular chainstate.\r\n\r\nI'm not sure how easy this would be to separate out into its own commit, because this invokes `AcceptBlock()` as well...  Hopefully the commit is more manageable now that I've split a bunch of other stuff out?  Let me know if you see a good way to shrink this commit more and I can take a stab at it.",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-13T17:33:03Z",
      "diff_hunk" : "@@ -4629,7 +4647,14 @@ void Chainstate::LoadExternalBlockFile(\n                 // Activate the genesis block so normal node progress can continue\n                 if (hash == params.GetConsensus().hashGenesisBlock) {\n                     BlockValidationState state;\n-                    if (!ActivateBestChain(state, nullptr)) {\n+                    bool genesis_activation_failure = false;\n+                    for (auto c : GetAll()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228475690",
      "id" : 1228475690,
      "in_reply_to_id" : 1212186629,
      "line" : 4602,
      "node_id" : "PRRC_kwDOABII585JOQ0q",
      "original_commit_id" : "534b6f99a3779465678f39ed2704da6049c6469d",
      "original_line" : 4602,
      "original_position" : 206,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 308,
      "pull_request_review_id" : 1477726472,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228475690/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-13T17:33:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228475690",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228476418"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228476418"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah, thanks for noticing this. I believe I had an earlier version of this branch with `assert()`'s added in to ensure that the snapshot base was never `nullptr`, and so this test had been failing.  I guess I removed those asserts before pushing...  I've re-enabled the test for now, but really this test should be re-written so that snapshots are always at blocks in the block index.",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-13T17:33:50Z",
      "diff_hunk" : "@@ -96,15 +98,14 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     auto exp_tip2 = c2.m_chain.Tip();\n     BOOST_CHECK_EQUAL(active_tip2, exp_tip2);\n \n-    // Ensure that these pointers actually correspond to different\n-    // CCoinsViewCache instances.\n-    BOOST_CHECK(exp_tip != exp_tip2);\n-\n     // Let scheduler events finish running to avoid accessing memory that is going to be unloaded\n     SyncWithValidationInterfaceQueue();\n }\n \n //! Test rebalancing the caches associated with each chainstate.\n+// FIXME: Need to rewrite this test under the requirement that snapshots always\n+// correspond to blocks in the block index.\n+#if 0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228476418",
      "id" : 1228476418,
      "in_reply_to_id" : 1227262047,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JORAC",
      "original_commit_id" : "df3655c12cf3672bb1c08ded6228405ae933f05b",
      "original_line" : 108,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1477727655,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228476418/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-13T17:33:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228476418",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228477327"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228477327"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I have no idea why I commented this out -- I've re-added as well.",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-13T17:34:46Z",
      "diff_hunk" : "@@ -349,7 +351,7 @@ struct SnapshotTestSetup : TestChain100Setup {\n         }\n \n         // Snapshot should refuse to load after one has already loaded.\n-        BOOST_REQUIRE(!CreateAndActivateUTXOSnapshot(this));\n+        //BOOST_REQUIRE(!CreateAndActivateUTXOSnapshot(this));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228477327",
      "id" : 1228477327,
      "in_reply_to_id" : 1227262861,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JOROP",
      "original_commit_id" : "df3655c12cf3672bb1c08ded6228405ae933f05b",
      "original_line" : 354,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1477729042,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228477327/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-13T17:34:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228477327",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228498661"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228498661"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks, I took these changes and re-enabled the test.",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-13T17:51:47Z",
      "diff_hunk" : "@@ -411,6 +413,7 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_activate_snapshot, SnapshotTestSetup)\n //!   chainstate only contains fully validated blocks and the other chainstate contains all blocks,\n //!   even those assumed-valid.\n //!\n+#if 0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1228498661",
      "id" : 1228498661,
      "in_reply_to_id" : 1227265509,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JOWbl",
      "original_commit_id" : "df3655c12cf3672bb1c08ded6228405ae933f05b",
      "original_line" : 416,
      "original_position" : 78,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1477759637,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228498661/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-13T17:51:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1228498661",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1229850689"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229850689"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> this test should be re-written so that snapshots are always at blocks in the block index.\r\n\r\nDoes it? AFAICT, it doesn't test anything within the block index at all, and the only part that does is `LoadGenesisBlock`.",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-14T15:57:05Z",
      "diff_hunk" : "@@ -96,15 +98,14 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     auto exp_tip2 = c2.m_chain.Tip();\n     BOOST_CHECK_EQUAL(active_tip2, exp_tip2);\n \n-    // Ensure that these pointers actually correspond to different\n-    // CCoinsViewCache instances.\n-    BOOST_CHECK(exp_tip != exp_tip2);\n-\n     // Let scheduler events finish running to avoid accessing memory that is going to be unloaded\n     SyncWithValidationInterfaceQueue();\n }\n \n //! Test rebalancing the caches associated with each chainstate.\n+// FIXME: Need to rewrite this test under the requirement that snapshots always\n+// correspond to blocks in the block index.\n+#if 0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1229850689",
      "id" : 1229850689,
      "in_reply_to_id" : 1227262047,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JTghB",
      "original_commit_id" : "df3655c12cf3672bb1c08ded6228405ae933f05b",
      "original_line" : 108,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1479818774,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229850689/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T15:57:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229850689",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1229858664"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229858664"
         }
      },
      "author_association" : "MEMBER",
      "body" : "See https://github.com/bitcoin/bitcoin/pull/27746/files#diff-dbada1fe3a3d0af884304dd28be8c9df74b592401dec2c6400f6b491aefe6c9bL141\r\n\r\n```c++\r\nChainstate& c2 = WITH_LOCK(cs_main, return manager.ActivateExistingSnapshot(&mempool, GetRandHash()));\r\n```\r\n\r\nTrying to activate a snapshot for a block that is not in the block index ought to be an illegal operation.",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-14T16:03:01Z",
      "diff_hunk" : "@@ -96,15 +98,14 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     auto exp_tip2 = c2.m_chain.Tip();\n     BOOST_CHECK_EQUAL(active_tip2, exp_tip2);\n \n-    // Ensure that these pointers actually correspond to different\n-    // CCoinsViewCache instances.\n-    BOOST_CHECK(exp_tip != exp_tip2);\n-\n     // Let scheduler events finish running to avoid accessing memory that is going to be unloaded\n     SyncWithValidationInterfaceQueue();\n }\n \n //! Test rebalancing the caches associated with each chainstate.\n+// FIXME: Need to rewrite this test under the requirement that snapshots always\n+// correspond to blocks in the block index.\n+#if 0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1229858664",
      "id" : 1229858664,
      "in_reply_to_id" : 1227262047,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JTido",
      "original_commit_id" : "df3655c12cf3672bb1c08ded6228405ae933f05b",
      "original_line" : 108,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1479831868,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229858664/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T16:09:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229858664",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1229903387"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229903387"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah I see. Seems like this could be easily resolved by using `TestChain100Setup`\r\n\r\n```diff\r\ndiff --git a/src/test/validation_chainstatemanager_tests.cpp b/src/test/validation_chainstatemanager_tests.cpp\r\nindex 2d0e1705fd..3d90bdcc26 100644\r\n--- a/src/test/validation_chainstatemanager_tests.cpp\r\n+++ b/src/test/validation_chainstatemanager_tests.cpp\r\n@@ -105,7 +105,7 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\r\n }\r\n \r\n //! Test rebalancing the caches associated with each chainstate.\r\n-BOOST_AUTO_TEST_CASE(chainstatemanager_rebalance_caches)\r\n+BOOST_FIXTURE_TEST_CASE(chainstatemanager_rebalance_caches, TestChain100Setup)\r\n {\r\n     ChainstateManager& manager = *m_node.chainman;\r\n     CTxMemPool& mempool = *m_node.mempool;\r\n@@ -118,7 +118,7 @@ BOOST_AUTO_TEST_CASE(chainstatemanager_rebalance_caches)\r\n \r\n     // Create a legacy (IBD) chainstate.\r\n     //\r\n-    Chainstate& c1 = WITH_LOCK(::cs_main, return manager.InitializeChainstate(&mempool));\r\n+    Chainstate& c1 = manager.ActiveChainstate();\r\n     chainstates.push_back(&c1);\r\n     c1.InitCoinsDB(\r\n         /*cache_size_bytes=*/1 << 23, /*in_memory=*/true, /*should_wipe=*/false);\r\n@@ -126,8 +126,6 @@ BOOST_AUTO_TEST_CASE(chainstatemanager_rebalance_caches)\r\n     {\r\n         LOCK(::cs_main);\r\n         c1.InitCoinsCache(1 << 23);\r\n-        BOOST_REQUIRE(c1.LoadGenesisBlock());\r\n-        c1.CoinsTip().SetBestBlock(InsecureRand256());\r\n         manager.MaybeRebalanceCaches();\r\n     }\r\n \r\n@@ -136,7 +134,8 @@ BOOST_AUTO_TEST_CASE(chainstatemanager_rebalance_caches)\r\n \r\n     // Create a snapshot-based chainstate.\r\n     //\r\n-    Chainstate& c2 = WITH_LOCK(cs_main, return manager.ActivateExistingSnapshot(&mempool, GetRandHash()));\r\n+    CBlockIndex* snapshot_base{WITH_LOCK(manager.GetMutex(), return manager.ActiveChain()[manager.ActiveChain().Height() / 2])};\r\n+    Chainstate& c2 = WITH_LOCK(cs_main, return manager.ActivateExistingSnapshot(&mempool, *snapshot_base->phashBlock));\r\n     chainstates.push_back(&c2);\r\n     c2.InitCoinsDB(\r\n         /*cache_size_bytes=*/1 << 23, /*in_memory=*/true, /*should_wipe=*/false);\r\n@@ -144,8 +143,6 @@ BOOST_AUTO_TEST_CASE(chainstatemanager_rebalance_caches)\r\n     {\r\n         LOCK(::cs_main);\r\n         c2.InitCoinsCache(1 << 23);\r\n-        BOOST_REQUIRE(c2.LoadGenesisBlock());\r\n-        c2.CoinsTip().SetBestBlock(InsecureRand256());\r\n         manager.MaybeRebalanceCaches();\r\n     }\r\n \r\n```",
      "commit_id" : "89e8826545a27d5b77a331865d10bfcec0e7da8c",
      "created_at" : "2023-06-14T16:42:20Z",
      "diff_hunk" : "@@ -96,15 +98,14 @@ BOOST_AUTO_TEST_CASE(chainstatemanager)\n     auto exp_tip2 = c2.m_chain.Tip();\n     BOOST_CHECK_EQUAL(active_tip2, exp_tip2);\n \n-    // Ensure that these pointers actually correspond to different\n-    // CCoinsViewCache instances.\n-    BOOST_CHECK(exp_tip != exp_tip2);\n-\n     // Let scheduler events finish running to avoid accessing memory that is going to be unloaded\n     SyncWithValidationInterfaceQueue();\n }\n \n //! Test rebalancing the caches associated with each chainstate.\n+// FIXME: Need to rewrite this test under the requirement that snapshots always\n+// correspond to blocks in the block index.\n+#if 0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27746#discussion_r1229903387",
      "id" : 1229903387,
      "in_reply_to_id" : 1227262047,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JTtYb",
      "original_commit_id" : "df3655c12cf3672bb1c08ded6228405ae933f05b",
      "original_line" : 108,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1479901411,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27746",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229903387/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T16:42:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1229903387",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   }
]
