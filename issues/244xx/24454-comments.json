[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24454#discussion_r816853073"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24454"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/816853073"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Linter unhappy\r\n```\r\n$ test/lint/lint-python.sh \r\ntest/functional/rpc_psbt.py:660:30: F821 undefined name 'ser_compact_size'\r\ntest/functional/rpc_psbt.py:661:51: F821 undefined name 'ser_compact_size'\r\n```\r\nFix:\r\n```diff\r\n--- a/test/functional/rpc_psbt.py\r\n+++ b/test/functional/rpc_psbt.py\r\n@@ -10,6 +10,7 @@ from itertools import product\r\n \r\n from test_framework.descriptors import descsum_create\r\n from test_framework.key import ECKey\r\n+from test_framework.messages import ser_compact_size\r\n from test_framework.test_framework import BitcoinTestFramework\r\n from test_framework.util import (\r\n```\r\n",
      "commit_id" : "765b1387f10c9af2ca90d7ee0bdc1a891ce293aa",
      "created_at" : "2022-03-01T15:03:45Z",
      "diff_hunk" : "@@ -655,10 +655,11 @@ def test_psbt_input_keys(psbt_input, keys):\n                 break\n         psbt_in = dec[\"inputs\"][input_idx]\n         # Calculate the input weight\n-        # (prevout + sequence + length of scriptSig + 2 bytes buffer) * 4 + len of scriptwitness\n+        # (prevout + sequence + length of scriptSig + scriptsig) * 4 + num scriptWitness stack items + (length of stack item + stack item) * N stack items\n         len_scriptsig = len(psbt_in[\"final_scriptSig\"][\"hex\"]) // 2 if \"final_scriptSig\" in psbt_in else 0\n-        len_scriptwitness = len(psbt_in[\"final_scriptwitness\"][\"hex\"]) // 2 if \"final_scriptwitness\" in psbt_in else 0\n-        input_weight = ((41 + len_scriptsig + 2) * 4) + len_scriptwitness\n+        len_scriptsig += len(ser_compact_size(len_scriptsig))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24454#discussion_r816853073",
      "id" : 816853073,
      "line" : 661,
      "node_id" : "PRRC_kwDOABII584wsDBR",
      "original_commit_id" : "2c09ad698f8da94346cc14ab1366cb7a5e727d88",
      "original_line" : 661,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "test/functional/rpc_psbt.py",
      "position" : 17,
      "pull_request_review_id" : 896420575,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24454",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/816853073/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-01T15:03:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/816853073",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24454#discussion_r816962062"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24454"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/816962062"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe in both tests use `WITNESS_SCALE_FACTOR` if I'm not confused\r\n\r\n```diff\r\n from test_framework.key import ECKey\r\n-from test_framework.messages import ser_compact_size\r\n+from test_framework.messages import (\r\n+    ser_compact_size,\r\n+    WITNESS_SCALE_FACTOR,\r\n+)\r\n from test_framework.test_framework import BitcoinTestFramework\r\n@@ -656,11 +659,13 @@ class PSBTTest(BitcoinTestFramework):\r\n         # Calculate the input weight\r\n-        # (prevout + sequence + length of scriptSig + scriptsig) * 4 + num scriptWitness stack items + (length of stack item + stack item) * N stack items\r\n+        # (prevout + sequence + length of scriptSig + scriptsig) * WITNESS_SCALE_FACTOR + num scriptWitness stack items + (length of stack item + stack item) * N stack items\r\n         len_scriptsig = len(psbt_in[\"final_scriptSig\"][\"hex\"]) // 2 if \"final_scriptSig\" in psbt_in else 0\r\n         len_scriptsig += len(ser_compact_size(len_scriptsig))\r\n         len_scriptwitness = (sum([(len(x) // 2) + ser_compact_size(len(x) // 2) for x in psbt_in[\"final_scriptwitness\"]]) + len(psbt_in[\"final_scriptwiness\"])) if \"final_scriptwitness\" in psbt_in else 0\r\n-        input_weight = ((40 + len_scriptsig) * 4) + len_scriptwitness\r\n+        input_weight = ((40 + len_scriptsig) * WITNESS_SCALE_FACTOR) + len_scriptwitness\r\n```\r\n",
      "commit_id" : "6f6529a4ffafdab885c40422a1e57e8b49559ede",
      "created_at" : "2022-03-01T16:55:58Z",
      "diff_hunk" : "@@ -655,10 +656,11 @@ def test_psbt_input_keys(psbt_input, keys):\n                 break\n         psbt_in = dec[\"inputs\"][input_idx]\n         # Calculate the input weight\n-        # (prevout + sequence + length of scriptSig + 2 bytes buffer) * 4 + len of scriptwitness\n+        # (prevout + sequence + length of scriptSig + scriptsig) * 4 + num scriptWitness stack items + (length of stack item + stack item) * N stack items",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24454#discussion_r816962062",
      "id" : 816962062,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584wsdoO",
      "original_commit_id" : "765b1387f10c9af2ca90d7ee0bdc1a891ce293aa",
      "original_line" : 659,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "test/functional/rpc_psbt.py",
      "position" : null,
      "pull_request_review_id" : 896573285,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24454",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/816962062/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-01T17:14:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/816962062",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#20892](https://github.com/bitcoin/bitcoin/pull/20892) (tests: Run both descriptor and legacy tests within a single test invocation by achow101)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-03-02T06:26:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24454#issuecomment-1056352552",
      "id" : 1056352552,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24454",
      "node_id" : "IC_kwDOABII584-9qko",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1056352552/reactions"
      },
      "updated_at" : "2022-03-02T06:26:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1056352552",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24454#discussion_r817574836"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24454"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/817574836"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "6f6529a4ffafdab885c40422a1e57e8b49559ede",
      "created_at" : "2022-03-02T10:53:17Z",
      "diff_hunk" : "@@ -655,10 +656,11 @@ def test_psbt_input_keys(psbt_input, keys):\n                 break\n         psbt_in = dec[\"inputs\"][input_idx]\n         # Calculate the input weight\n-        # (prevout + sequence + length of scriptSig + 2 bytes buffer) * 4 + len of scriptwitness\n+        # (prevout + sequence + length of scriptSig + scriptsig) * 4 + num scriptWitness stack items + (length of stack item + stack item) * N stack items",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24454#discussion_r817574836",
      "id" : 817574836,
      "in_reply_to_id" : 816962062,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584wuzO0",
      "original_commit_id" : "765b1387f10c9af2ca90d7ee0bdc1a891ce293aa",
      "original_line" : 659,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "test/functional/rpc_psbt.py",
      "position" : null,
      "pull_request_review_id" : 897410659,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24454",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/817574836/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-02T10:53:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/817574836",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Running `wallet_send.py` on loop with this branch and some pprints to see the values, saw this error after a few dozen runs\r\n```\r\n2022-03-02T22:44:14.061000Z TestFramework (INFO): External outputs\r\nlen_scriptSig: 132\r\nlen_scriptwitness: 0\r\ninput_weight: 688\r\n2022-03-02T22:44:14.866000Z TestFramework (ERROR): Assertion failed\r\nTraceback (most recent call last):\r\n  File \"/home/jon/projects/bitcoin/bitcoin/test/functional/test_framework/test_framework.py\", line 132, in main\r\n    self.run_test()\r\n  File \"/home/jon/projects/bitcoin/bitcoin/test/functional/wallet_send.py\", line 569, in run_test\r\n    assert_fee_amount(testres[\"fees\"][\"base\"], testres[\"vsize\"], Decimal(0.0001))\r\n  File \"/home/jon/projects/bitcoin/bitcoin/test/functional/test_framework/util.py\", line 42, in assert_fee_amount\r\n    raise AssertionError(\"Fee of %s BTC too low! (Should be %s BTC)\" % (str(fee), str(target_fee)))\r\nAssertionError: Fee of 0.00003130 BTC too low! (Should be 0.0000314 BTC)\r\n```\r\nThe usual values I'm seeing on this branch are (see https://github.com/bitcoin/bitcoin/pull/24454#pullrequestreview-896573285 above for more detail)\r\n```\r\nlen_scriptSig: 133\r\nlen_scriptwitness: 0\r\ninput_weight: 692\r\n```\r\n",
      "created_at" : "2022-03-02T23:28:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24454#issuecomment-1057493446",
      "id" : 1057493446,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24454",
      "node_id" : "IC_kwDOABII584_CBHG",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1057493446/reactions"
      },
      "updated_at" : "2022-03-02T23:28:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1057493446",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Hmm. I guess that error is now the same problem in the other direction. I've added a `+ 1` to the  calculation as an additional buffer. Running this repeatedly shows no failures in 200+ runs.",
      "created_at" : "2022-03-03T12:03:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24454#issuecomment-1057974266",
      "id" : 1057974266,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24454",
      "node_id" : "IC_kwDOABII584_D2f6",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1057974266/reactions"
      },
      "updated_at" : "2022-03-03T12:03:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1057974266",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   }
]
