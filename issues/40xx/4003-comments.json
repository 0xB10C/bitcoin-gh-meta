[
   {
      "body" : "This is very strange. Why would it be unable to open the database file but only when you shut down?\r\n\r\nIn any case, can you try (may need db4.8-util or similar package):\r\n```bash\r\ncd ~/.bitcoin\r\nmv wallet.dat wallet.dat.backup\r\ndb4.8_dump wallet.dat.backup | db4.8_load wallet.dat\r\n```\r\n",
      "created_at" : "2014-04-05T09:15:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/4003#issuecomment-39633076",
      "id" : 39633076,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4003",
      "updated_at" : "2014-04-05T09:15:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/39633076",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "The first time I noticed the error was shortly after using rsync to copy my whole home directory over to a new laptop.  The one I was copying from was running bitcoin-qt at the time.  I figured that was a bad idea, so went to shut bitcoin-qt down and re-run the sync, and it was then that I saw the error message.  I was wondering if the problem could have been caused by rsync reading the wallet file while it was open.  But as I say, the laptop had frozen on resume shortly before this as well.\r\n\r\nI restarted bitcoin, it came up just fine, but again when I went to shut it down, I saw the same error again.\r\n\r\nAnd interestingly, even after copying everything over to the new laptop, I saw the same error on the new laptop the first time I ran it.  But just this morning I was able to shut it down without the error, so it looks like the problem eventually resolved itself.\r\n\r\nHere's a screenshot I took the first time the error happened.  Both dialogs are on the screen at the same time.\r\n\r\n![screenshot - 14-04-04 - 07 15 45 am](https://cloud.githubusercontent.com/assets/573356/2623414/1089aaea-bced-11e3-8d11-40d46c9de99b.png)\r\n\r\nI should probably mention that I'm using libdb5.3++-dev and had to use a ./configure flag for non-compatible wallets, but I've been using that for a long time.\r\n\r\nRunning the dump/load commands completes without error (on the new laptop where the problem is already apparently fixed), and makes the wallet considerably smaller:\r\n\r\n    $ cp ~/.bitcoin/wallet.dat wallet.dat.before\r\n    $ db5.3_dump wallet.dat.before | db5.3_load wallet.dat.after\r\n    $ ls -lh wallet.dat*\r\n    -rw-r--r-- 1 chris chris 140M Apr  5 11:11 wallet.dat.after\r\n    -rw------- 1 chris chris 151M Apr  5 11:10 wallet.dat.before\r\n    $ \r\n\r\nI'll try it on the old laptop where the error presumably still happens.",
      "created_at" : "2014-04-05T18:13:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/4003#issuecomment-39646212",
      "id" : 39646212,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4003",
      "updated_at" : "2014-04-05T18:13:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/39646212",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/573356?v=3",
         "events_url" : "https://api.github.com/users/dooglus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dooglus/followers",
         "following_url" : "https://api.github.com/users/dooglus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dooglus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dooglus",
         "id" : 573356,
         "login" : "dooglus",
         "organizations_url" : "https://api.github.com/users/dooglus/orgs",
         "received_events_url" : "https://api.github.com/users/dooglus/received_events",
         "repos_url" : "https://api.github.com/users/dooglus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dooglus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dooglus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dooglus"
      }
   },
   {
      "body" : "On the old laptop:\r\n\r\n    $ db5.3_dump wallet.dat.before | db5.3_load wallet.dat.after\r\n    $ ls -l wallet.dat.*\r\n    -rw-r--r-- 1 chris chris 146464768 Apr  5 11:19 wallet.dat.after\r\n    -rw------- 1 chris chris 157814784 Apr  5 11:17 wallet.dat.before\r\n    $ \r\n\r\nThen I ran bitcoin-qt on the 'before' version of the wallet, and it did still crash on shutdown.  It definitely loaded up, showed the wallet balance, and started catching up with the blockchain.\r\n\r\n![screenshot - 14-04-05 - 11 27 12 am](https://cloud.githubusercontent.com/assets/573356/2623455/1b832216-bcf0-11e3-8a26-47191ae63bb3.png)\r\n\r\n",
      "created_at" : "2014-04-05T18:29:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/4003#issuecomment-39646679",
      "id" : 39646679,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4003",
      "updated_at" : "2014-04-05T18:29:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/39646679",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/573356?v=3",
         "events_url" : "https://api.github.com/users/dooglus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dooglus/followers",
         "following_url" : "https://api.github.com/users/dooglus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dooglus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dooglus",
         "id" : 573356,
         "login" : "dooglus",
         "organizations_url" : "https://api.github.com/users/dooglus/orgs",
         "received_events_url" : "https://api.github.com/users/dooglus/received_events",
         "repos_url" : "https://api.github.com/users/dooglus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dooglus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dooglus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dooglus"
      }
   },
   {
      "body" : "Running bitcoin-qt with the 'wallet.dat.after' file created using those db util commands fixed the problem.  I can now start and close the wallet without error messages.",
      "created_at" : "2014-04-05T18:38:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/4003#issuecomment-39646994",
      "id" : 39646994,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4003",
      "updated_at" : "2014-04-05T18:38:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/39646994",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/573356?v=3",
         "events_url" : "https://api.github.com/users/dooglus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dooglus/followers",
         "following_url" : "https://api.github.com/users/dooglus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dooglus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dooglus",
         "id" : 573356,
         "login" : "dooglus",
         "organizations_url" : "https://api.github.com/users/dooglus/orgs",
         "received_events_url" : "https://api.github.com/users/dooglus/received_events",
         "repos_url" : "https://api.github.com/users/dooglus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dooglus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dooglus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dooglus"
      }
   }
]
