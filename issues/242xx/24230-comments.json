[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-02-01T17:54:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1027125114",
      "id" : 1027125114,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII5849OK96",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1027125114/reactions"
      },
      "updated_at" : "2022-02-01T17:54:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1027125114",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased 8d8cdcb37005030f646ba3c45f7f54f556efb8bf -> 1fcfc73ba4e8180a8667868529774ab7b302ab5d ([`pr/indexy.1`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.1) -> [`pr/indexy.2`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.2), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/indexy.1-rebase..pr/indexy.2)) due to conflict with #22932. Also fixed some bugs in the last commit ð\r\n",
      "created_at" : "2022-02-01T21:47:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1027319018",
      "id" : 1027319018,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII5849O6Tq",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1027319018/reactions"
      },
      "updated_at" : "2022-02-01T21:47:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1027319018",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#24931](https://github.com/bitcoin/bitcoin/pull/24931) (Strengthen thread safety assertions by ajtowns)\n* [#24915](https://github.com/bitcoin/bitcoin/pull/24915) (lint: Convert lint-circular-dependencies.sh to Python by Smlep)\n* [#24811](https://github.com/bitcoin/bitcoin/pull/24811) (refactor: Prepare for moving ArgsManager out of util/system by Empact)\n* [#24150](https://github.com/bitcoin/bitcoin/pull/24150) (refactor: move index class members from protected to private by jonatack)\n* [#23997](https://github.com/bitcoin/bitcoin/pull/23997) (wallet: avoid rescans under assumed-valid blocks by jamesob)\n* [#22485](https://github.com/bitcoin/bitcoin/pull/22485) (index: doc/log BaseIndex sync behavior with empty datadir by jamesob)\n* [#21726](https://github.com/bitcoin/bitcoin/pull/21726) (Improve Indices on pruned nodes via prune blockers by fjahr)\n* [#19888](https://github.com/bitcoin/bitcoin/pull/19888) (rpc, test: Improve getblockstats for unspendables by fjahr)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-02-02T04:02:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1027553252",
      "id" : 1027553252,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII5849Pzfk",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1027553252/reactions"
      },
      "updated_at" : "2022-04-25T08:43:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1027553252",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Updated 1fcfc73ba4e8180a8667868529774ab7b302ab5d -> c5be433bf3f1a2b5b96cbe00608eff24136e6f51 ([`pr/indexy.2`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.2) -> [`pr/indexy.3`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.3), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/indexy.2..pr/indexy.3)) fixing asan error https://cirrus-ci.com/task/5137882733084672 and lint error https://cirrus-ci.com/task/5208251477262336. Did not look into tsan failure https://cirrus-ci.com/task/4574932779663360 and multiprocess blockfilter_index_tests segfault https://cirrus-ci.com/task/4856407756374016, but I think they may be addressed by the asan fix",
      "created_at" : "2022-02-02T20:55:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1028349864",
      "id" : 1028349864,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII5849S1-o",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1028349864/reactions"
      },
      "updated_at" : "2022-02-02T20:55:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1028349864",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Updated c5be433bf3f1a2b5b96cbe00608eff24136e6f51 -> 3ab1ebeff4328dc1a456a3323d8a41f0200d7be2 ([`pr/indexy.3`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.3) -> [`pr/indexy.4`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.4), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/indexy.3..pr/indexy.4)) fixing `blockfilter_index_initial_sync` crash that I could not produce locally but I believe was causing CI failures https://cirrus-ci.com/task/6670649857933312, https://cirrus-ci.com/task/5755856183623680, and https://cirrus-ci.com/task/4981799997669376",
      "created_at" : "2022-02-03T22:39:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1029467943",
      "id" : 1029467943,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII5849XG8n",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1029467943/reactions"
      },
      "updated_at" : "2022-02-03T22:39:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1029467943",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801627743"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801627743"
         }
      },
      "author_association" : "MEMBER",
      "body" : "dc4675ddaca8d0d1d40847191cb21ccd116a6a3c : why bother with a pointer here? To make it consistent with `phashBlock` in `CBlockIndex`? I assume it's not just to shave 31 bytes of the `BlockInfo` size?",
      "commit_id" : "2acbc24a0ebcb2dc9f73f5a18964e796507e8ab5",
      "created_at" : "2022-02-08T13:26:37Z",
      "diff_hunk" : "@@ -67,6 +68,20 @@ class FoundBlock\n     mutable bool found = false;\n };\n \n+//! Block data sent with blockConnected, blockDisconnected notifications.\n+struct BlockInfo {\n+    const uint256& hash;\n+    const uint256* prev_hash = nullptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801627743",
      "id" : 801627743,
      "line" : 83,
      "node_id" : "PRRC_kwDOABII584vx95f",
      "original_commit_id" : "dc4675ddaca8d0d1d40847191cb21ccd116a6a3c",
      "original_line" : 83,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/interfaces/chain.h",
      "position" : 43,
      "pull_request_review_id" : 876022016,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801627743/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-08T15:31:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801627743",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801653113"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801653113"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ae26ae5d3a1d32ce212d66477b71a5ac03354338: you're using `context()` here, but `src/interfaces/chain.h` suggests that should only be done in a test. Does this need a TODO? Is this resolved in one of the followup PRs?",
      "commit_id" : "2acbc24a0ebcb2dc9f73f5a18964e796507e8ab5",
      "created_at" : "2022-02-08T13:52:54Z",
      "diff_hunk" : "@@ -345,9 +350,9 @@ void BaseIndex::Interrupt()\n     m_interrupt();\n }\n \n-bool BaseIndex::Start(CChainState& active_chainstate)\n+bool BaseIndex::Start()\n {\n-    m_chainstate = &active_chainstate;\n+    m_chainstate = &m_chain->context()->chainman->ActiveChainstate();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801653113",
      "id" : 801653113,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584vyEF5",
      "original_commit_id" : "ae26ae5d3a1d32ce212d66477b71a5ac03354338",
      "original_line" : 355,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 876022016,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801653113/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-08T15:31:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801653113",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801675097"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801675097"
         }
      },
      "author_association" : "MEMBER",
      "body" : "515a1dbce29078a1e90dc3f97bf25b309face9bb: this might warrant a TODO (or note in the commit message) that this `CBlockIndex` is going away in a later commit.",
      "commit_id" : "2acbc24a0ebcb2dc9f73f5a18964e796507e8ab5",
      "created_at" : "2022-02-08T14:14:33Z",
      "diff_hunk" : "@@ -209,22 +210,23 @@ size_t BlockFilterIndex::WriteFilterToDisk(FlatFilePos& pos, const BlockFilter&\n     return data_size;\n }\n \n-bool BlockFilterIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+bool BlockFilterIndex::CustomAppend(const interfaces::BlockInfo& block)\n {\n     CBlockUndo block_undo;\n     uint256 prev_header;\n \n-    if (pindex->nHeight > 0) {\n+    if (block.height > 0) {\n+        const CBlockIndex* pindex = WITH_LOCK(cs_main, return m_chainstate->m_blockman.LookupBlockIndex(block.hash));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801675097",
      "id" : 801675097,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584vyJdZ",
      "original_commit_id" : "515a1dbce29078a1e90dc3f97bf25b309face9bb",
      "original_line" : 219,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.cpp",
      "position" : null,
      "pull_request_review_id" : 876022016,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801675097/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-08T15:31:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801675097",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801691396"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801691396"
         }
      },
      "author_association" : "MEMBER",
      "body" : "15398b1677362f4d98ffc786f1ae9976ad595ea8: comment above needs update",
      "commit_id" : "2acbc24a0ebcb2dc9f73f5a18964e796507e8ab5",
      "created_at" : "2022-02-08T14:29:51Z",
      "diff_hunk" : "@@ -28,7 +30,7 @@ struct IndexSummary {\n  * CValidationInterface and ensures blocks are indexed sequentially according\n  * to their position in the active chain.\n  */\n-class BaseIndex : public CValidationInterface",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801691396",
      "id" : 801691396,
      "line" : 27,
      "node_id" : "PRRC_kwDOABII584vyNcE",
      "original_commit_id" : "15398b1677362f4d98ffc786f1ae9976ad595ea8",
      "original_line" : 27,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/index/base.h",
      "position" : 30,
      "pull_request_review_id" : 876022016,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801691396/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-08T15:31:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801691396",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801711644"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801711644"
         }
      },
      "author_association" : "MEMBER",
      "body" : "15398b1677362f4d98ffc786f1ae9976ad595ea8 nit: \"and reindex\" (I haven't checked if re-index nukes all the indexes, or if it leaves them alone until the previous best block is reached again)",
      "commit_id" : "2acbc24a0ebcb2dc9f73f5a18964e796507e8ab5",
      "created_at" : "2022-02-08T14:46:41Z",
      "diff_hunk" : "@@ -81,6 +81,8 @@ struct BlockInfo {\n     unsigned undo_pos = 0;\n     const CBlock* data = nullptr;\n     const CBlockUndo* undo_data = nullptr;\n+    //! Block is from the tip of the chain (always true except during initial sync)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801711644",
      "id" : 801711644,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584vySYc",
      "original_commit_id" : "15398b1677362f4d98ffc786f1ae9976ad595ea8",
      "original_line" : 84,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/interfaces/chain.h",
      "position" : null,
      "pull_request_review_id" : 876022016,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801711644/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-08T15:31:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801711644",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801842132"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801842132"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801627743\r\n\r\n> [dc4675d](https://github.com/bitcoin/bitcoin/commit/dc4675ddaca8d0d1d40847191cb21ccd116a6a3c) : why bother with a pointer here? To make it consistent with `phashBlock` in `CBlockIndex`? I assume it's not just to shave 31 bytes of the `BlockInfo` size?\r\n\r\nYes, hash is a reference and prev_hash is a pointer to minimize copying and make the struct small. C++ doesn't provide named arguments, so I'm defining the struct as a substitute for named arguments, to make block connected and disconnected declarations more readable and the argument list easier to change in the future.\r\n\r\nThe field types are the same as the argument types that would be used otherwise. `const uint256& hash` could be replaced by `uint256 hash`, and  `const uint256* prev_hash` could be `std::optional<uint256>`, and `const CBlock*` could be `shared_ptr<CBlock>`, but the various block connected and disconnected method implementations don't benefit from getting copies instead of references, or optional instead of pointers, or smart pointers instead of plain pointers, so I'm opting for the cheapest and simplest passing style in each case.",
      "commit_id" : "2acbc24a0ebcb2dc9f73f5a18964e796507e8ab5",
      "created_at" : "2022-02-08T16:45:22Z",
      "diff_hunk" : "@@ -67,6 +68,20 @@ class FoundBlock\n     mutable bool found = false;\n };\n \n+//! Block data sent with blockConnected, blockDisconnected notifications.\n+struct BlockInfo {\n+    const uint256& hash;\n+    const uint256* prev_hash = nullptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801842132",
      "id" : 801842132,
      "in_reply_to_id" : 801627743,
      "line" : 83,
      "node_id" : "PRRC_kwDOABII584vyyPU",
      "original_commit_id" : "dc4675ddaca8d0d1d40847191cb21ccd116a6a3c",
      "original_line" : 83,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/interfaces/chain.h",
      "position" : 43,
      "pull_request_review_id" : 876331979,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801842132/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-09T01:10:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801842132",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801912127"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801912127"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801653113\r\n\r\n> [ae26ae5](https://github.com/bitcoin/bitcoin/commit/ae26ae5d3a1d32ce212d66477b71a5ac03354338): you're using `context()` here, but `src/interfaces/chain.h` suggests that should only be done in a test. Does this need a TODO? Is this resolved in one of the followup PRs?\r\n\r\nGood catch. Now removed this in the last commit and added comment about it being temporary",
      "commit_id" : "2acbc24a0ebcb2dc9f73f5a18964e796507e8ab5",
      "created_at" : "2022-02-08T17:56:52Z",
      "diff_hunk" : "@@ -345,9 +350,9 @@ void BaseIndex::Interrupt()\n     m_interrupt();\n }\n \n-bool BaseIndex::Start(CChainState& active_chainstate)\n+bool BaseIndex::Start()\n {\n-    m_chainstate = &active_chainstate;\n+    m_chainstate = &m_chain->context()->chainman->ActiveChainstate();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801912127",
      "id" : 801912127,
      "in_reply_to_id" : 801653113,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584vzDU_",
      "original_commit_id" : "ae26ae5d3a1d32ce212d66477b71a5ac03354338",
      "original_line" : 355,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 876331979,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801912127/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-09T01:10:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801912127",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801912871"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801912871"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801675097\r\n\r\n> [515a1db](https://github.com/bitcoin/bitcoin/commit/515a1dbce29078a1e90dc3f97bf25b309face9bb): this might warrant a TODO (or note in the commit message) that this `CBlockIndex` is going away in a later commit.\r\n\r\nGood suggestion, added comments to clarify",
      "commit_id" : "2acbc24a0ebcb2dc9f73f5a18964e796507e8ab5",
      "created_at" : "2022-02-08T17:57:40Z",
      "diff_hunk" : "@@ -209,22 +210,23 @@ size_t BlockFilterIndex::WriteFilterToDisk(FlatFilePos& pos, const BlockFilter&\n     return data_size;\n }\n \n-bool BlockFilterIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n+bool BlockFilterIndex::CustomAppend(const interfaces::BlockInfo& block)\n {\n     CBlockUndo block_undo;\n     uint256 prev_header;\n \n-    if (pindex->nHeight > 0) {\n+    if (block.height > 0) {\n+        const CBlockIndex* pindex = WITH_LOCK(cs_main, return m_chainstate->m_blockman.LookupBlockIndex(block.hash));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801912871",
      "id" : 801912871,
      "in_reply_to_id" : 801675097,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584vzDgn",
      "original_commit_id" : "515a1dbce29078a1e90dc3f97bf25b309face9bb",
      "original_line" : 219,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.cpp",
      "position" : null,
      "pull_request_review_id" : 876331979,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801912871/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-09T01:10:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801912871",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801913300"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801913300"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801691396\r\n\r\n> [15398b1](https://github.com/bitcoin/bitcoin/commit/15398b1677362f4d98ffc786f1ae9976ad595ea8): comment above needs update\r\n\r\nGood catch, updated",
      "commit_id" : "2acbc24a0ebcb2dc9f73f5a18964e796507e8ab5",
      "created_at" : "2022-02-08T17:58:12Z",
      "diff_hunk" : "@@ -28,7 +30,7 @@ struct IndexSummary {\n  * CValidationInterface and ensures blocks are indexed sequentially according\n  * to their position in the active chain.\n  */\n-class BaseIndex : public CValidationInterface",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801913300",
      "id" : 801913300,
      "in_reply_to_id" : 801691396,
      "line" : 27,
      "node_id" : "PRRC_kwDOABII584vzDnU",
      "original_commit_id" : "15398b1677362f4d98ffc786f1ae9976ad595ea8",
      "original_line" : 27,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/index/base.h",
      "position" : 30,
      "pull_request_review_id" : 876331979,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801913300/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-09T01:10:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801913300",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801913814"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801913814"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801711644\r\n\r\n> [15398b1](https://github.com/bitcoin/bitcoin/commit/15398b1677362f4d98ffc786f1ae9976ad595ea8) nit: \"and reindex\" (I haven't checked if re-index nukes all the indexes, or if it leaves them alone until the previous best block is reached again)\r\n\r\nRephrased the comment to avoid the word sync. This isn't referring to IBD or reindexing globally. It's just referring to notifications from the attachChain / ThreadSync code that runs when the index is loaded. For example if we added an RPC method to start and stop indexes. `chain_tip` would be false for the blocks read after the index was first started, until the sync thread caught up. This would be independent of whether node itself was syncing to the network.",
      "commit_id" : "2acbc24a0ebcb2dc9f73f5a18964e796507e8ab5",
      "created_at" : "2022-02-08T17:58:47Z",
      "diff_hunk" : "@@ -81,6 +81,8 @@ struct BlockInfo {\n     unsigned undo_pos = 0;\n     const CBlock* data = nullptr;\n     const CBlockUndo* undo_data = nullptr;\n+    //! Block is from the tip of the chain (always true except during initial sync)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r801913814",
      "id" : 801913814,
      "in_reply_to_id" : 801711644,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584vzDvW",
      "original_commit_id" : "15398b1677362f4d98ffc786f1ae9976ad595ea8",
      "original_line" : 84,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/interfaces/chain.h",
      "position" : null,
      "pull_request_review_id" : 876331979,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801913814/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-09T01:10:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801913814",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for the review!",
      "created_at" : "2022-02-09T01:10:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1033225564",
      "id" : 1033225564,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII5849lcVc",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1033225564/reactions"
      },
      "updated_at" : "2022-02-09T01:10:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1033225564",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Updated d27072d58207b2648d8f1bf273389aee86db3001 -> 2acbc24a0ebcb2dc9f73f5a18964e796507e8ab5 ([`pr/indexy.5`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.5) -> [`pr/indexy.6`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.6), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/indexy.5..pr/indexy.6)) to fix ubsan error https://cirrus-ci.com/task/5606579763412992?logs=ci#L4848",
      "created_at" : "2022-02-09T03:33:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1033309727",
      "id" : 1033309727,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII5849lw4f",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1033309727/reactions"
      },
      "updated_at" : "2022-02-09T03:33:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1033309727",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r802668917"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/802668917"
         }
      },
      "author_association" : "MEMBER",
      "body" : "11310351345e844ae22f9bc00bed00eff7197500 : this constraint of `BLOCK_HAVE_DATA | BLOCK_HAVE_UNDO` makes sense in the context of indexes, because an index is updated after a block is connected, at which point it will always have undo data. But if we ever need it in other places, it seems a bit odd. Maybe add a comment? Alternatively maybe we should just add `nStatus` or bools for the individual flags we care about? ",
      "commit_id" : "2acbc24a0ebcb2dc9f73f5a18964e796507e8ab5",
      "created_at" : "2022-02-09T13:37:52Z",
      "diff_hunk" : "@@ -0,0 +1,24 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chain.h>\n+#include <interfaces/chain.h>\n+#include <uint256.h>\n+\n+namespace node {\n+interfaces::BlockInfo MakeBlockInfo(const CBlockIndex* index, const CBlock* data)\n+{\n+    interfaces::BlockInfo info{index ? *index->phashBlock : uint256::ZERO};\n+    if (index) {\n+        info.prev_hash = index->pprev ? index->pprev->phashBlock : nullptr;\n+        info.height = index->nHeight;\n+        LOCK(::cs_main);\n+        info.file_number = index->nStatus & (BLOCK_HAVE_DATA | BLOCK_HAVE_UNDO) ? index->nFile : -1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r802668917",
      "id" : 802668917,
      "line" : 22,
      "node_id" : "PRRC_kwDOABII584v18F1",
      "original_commit_id" : "11310351345e844ae22f9bc00bed00eff7197500",
      "original_line" : 17,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/node/chain.cpp",
      "position" : 17,
      "pull_request_review_id" : 877470452,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/802668917/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-09T14:19:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/802668917",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r802678422"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/802678422"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ade3f4306bba6e40197d645774097c78a5e0681a: this is a nice addition, e.g. `block->hash` is more readable than before when `block` would be a hash.",
      "commit_id" : "2acbc24a0ebcb2dc9f73f5a18964e796507e8ab5",
      "created_at" : "2022-02-09T13:48:02Z",
      "diff_hunk" : "@@ -38,6 +38,12 @@ namespace interfaces {\n class Handler;\n class Wallet;\n \n+//! Hash/height pair to help track and identify blocks.\n+struct BlockKey {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r802678422",
      "id" : 802678422,
      "line" : 42,
      "node_id" : "PRRC_kwDOABII584v1-aW",
      "original_commit_id" : "ade3f4306bba6e40197d645774097c78a5e0681a",
      "original_line" : 42,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/interfaces/chain.h",
      "position" : 5,
      "pull_request_review_id" : 877470452,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/802678422/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-09T14:19:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/802678422",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803070756"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803070756"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> [1131035](https://github.com/bitcoin/bitcoin/commit/11310351345e844ae22f9bc00bed00eff7197500) : this constraint of `BLOCK_HAVE_DATA | BLOCK_HAVE_UNDO` makes sense in the context of indexes, because an index is updated after a block is connected, at which point it will always have undo data. But if we ever need it in other places, it seems a bit odd. Maybe add a comment? Alternatively maybe we should just add `nStatus` or bools for the individual flags we care about?\r\n\r\nI guess I'll drop this. I assumed one wouldn't be present without the other, and was basing it on the thing [`CDiskBlockIndex` is doing](https://github.com/bitcoin/bitcoin/blob/5e8e0b3d7f6055e326bda61e60712b530e8920f0/src/chain.h#L392). Most intermediate code which uses this is deleted in the end anyway.",
      "commit_id" : "9acc7fc39d89e31ea6b46c9fda4c539b82cced8c",
      "created_at" : "2022-02-09T20:41:57Z",
      "diff_hunk" : "@@ -0,0 +1,24 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chain.h>\n+#include <interfaces/chain.h>\n+#include <uint256.h>\n+\n+namespace node {\n+interfaces::BlockInfo MakeBlockInfo(const CBlockIndex* index, const CBlock* data)\n+{\n+    interfaces::BlockInfo info{index ? *index->phashBlock : uint256::ZERO};\n+    if (index) {\n+        info.prev_hash = index->pprev ? index->pprev->phashBlock : nullptr;\n+        info.height = index->nHeight;\n+        LOCK(::cs_main);\n+        info.file_number = index->nStatus & (BLOCK_HAVE_DATA | BLOCK_HAVE_UNDO) ? index->nFile : -1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803070756",
      "id" : 803070756,
      "in_reply_to_id" : 802668917,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584v3eMk",
      "original_commit_id" : "11310351345e844ae22f9bc00bed00eff7197500",
      "original_line" : 17,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/node/chain.cpp",
      "position" : null,
      "pull_request_review_id" : 878029336,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803070756/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-09T21:05:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803070756",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I did review with `--color-moved=dimmed_zebra`, though without `dimmed_zebra` it's slightly more clear and a bigger monitor helps too.\r\n\r\nIt helped to notice that `Init()` is only called from `Start()`. The first four lines that set `locator` are just moved.\r\n\r\nThe two lines after that, which obtain the lock and set `active_chain` are turned into a new function `checkBlocks()` which is called from another new function `attachChain()`.  The end of the original `Init()` function comes back in that the only way `attachChain` can return null is with a prune violation. The middle part is more complicated.\r\n\r\nOne job of `Init()` was to set `m_best_block_index` and `m_synced`. That task has been moved to `blockConnected()`, which is called once by `attachChain()`. That part is a bit hard to follow, though it does look right. Part of the problem is that you need to understand the original logic. \r\n\r\nOnce those two are set, it continue on to find a prune violation. That part is a clear move to `checkBlocks`.\r\n\r\nYou might be able to introduce `checkBlocks()` in a commit before this. If wouldn't make things simpler, but the diff would be more focussed on the boiler plate changes.\r\n\r\n> I wonder if there is something specific which is confusing about this commit, or if you just don't like the boilerplate it adds?\r\n\r\nI'm probably fine with the end result; we'll see when I get to later commits, but I'm not worried about that. It's indeed the change itself that's a bit confusing.\r\n\r\n2504811223597b211aa52b86a6386f4c02286d50: although I can follow along fine, it might make sense to split out the `IgnoreBlockConnected` and `IgnoreChainStateFlushed` helpers first (instead of \"framing\" it as a rename)",
      "created_at" : "2022-02-10T10:38:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1034759315",
      "id" : 1034759315,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII5849rSyT",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1034759315/reactions"
      },
      "updated_at" : "2022-02-10T12:16:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1034759315",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803628739"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803628739"
         }
      },
      "author_association" : "MEMBER",
      "body" : "2504811223597b211aa52b86a6386f4c02286d50 : IIUC this makes it so the `Handler` that's in `m_handler` (before its moved) is destroyed when this function is done. Why is it insufficient to just call `m_handler->disconnect()`  and have it be destroyed along with `BaseIndex`?\r\n\r\nI guess that's what \"because ... disconnect code may need to lock the mutex\" refers to, but it's not super clear to me why this is.\r\n\r\nRelated to the next d148f9e2abc05c83b60f1d92bcd7884174fa9ae3 where you assert that `m_handler` really needs to be gone by the time destructor on `BaseIndex` is called.",
      "commit_id" : "9acc7fc39d89e31ea6b46c9fda4c539b82cced8c",
      "created_at" : "2022-02-10T12:36:29Z",
      "diff_hunk" : "@@ -367,11 +390,15 @@ bool BaseIndex::Start()\n \n void BaseIndex::Stop()\n {\n-    UnregisterValidationInterface(this);\n+    Interrupt();\n \n     if (m_thread_sync.joinable()) {\n         m_thread_sync.join();\n     }\n+\n+    // Call handler destructor after releasing m_mutex, because notification\n+    // threads and disconnect code may need to lock the mutex.\n+    auto handler = WITH_LOCK(m_mutex, return std::move(m_handler));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803628739",
      "id" : 803628739,
      "line" : 296,
      "node_id" : "PRRC_kwDOABII584v5mbD",
      "original_commit_id" : "2504811223597b211aa52b86a6386f4c02286d50",
      "original_line" : 401,
      "original_position" : 177,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 177,
      "pull_request_review_id" : 878775522,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803628739/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-10T13:59:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803628739",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803639220"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803639220"
         }
      },
      "author_association" : "MEMBER",
      "body" : "0cefaaab906e3de84a4e2c5a15e27e56255e17ac: I guess you can now defer this until after `commit()`?",
      "commit_id" : "9acc7fc39d89e31ea6b46c9fda4c539b82cced8c",
      "created_at" : "2022-02-10T12:49:25Z",
      "diff_hunk" : "@@ -254,7 +254,7 @@ bool BaseIndex::Rewind(const CBlockIndex* current_tip, const CBlockIndex* new_ti\n     // In case we reorg beyond the pruned depth, ReadBlockFromDisk would\n     // throw and lead to a graceful shutdown\n     m_best_block_index = new_tip;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803639220",
      "id" : 803639220,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584v5o-0",
      "original_commit_id" : "0cefaaab906e3de84a4e2c5a15e27e56255e17ac",
      "original_line" : 256,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 54,
      "pull_request_review_id" : 878775522,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803639220/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-10T13:59:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803639220",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803655628"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803655628"
         }
      },
      "author_association" : "MEMBER",
      "body" : "d6ebc941f641d68eabe4c3243eb6769dd2d13cf5: this refactor of `CustomRewind ` from iterating over blocks to `CustomRemove` which just takes a single block might be worth doing in a separate commit.",
      "commit_id" : "9acc7fc39d89e31ea6b46c9fda4c539b82cced8c",
      "created_at" : "2022-02-10T13:07:09Z",
      "diff_hunk" : "@@ -263,39 +263,21 @@ static bool CopyHeightIndexToHashIndex(CDBIterator& db_it, CDBBatch& batch,\n     return true;\n }\n \n-bool CoinStatsIndex::CustomRewind(const interfaces::BlockKey& current_tip, const interfaces::BlockKey& new_tip)\n+bool CoinStatsIndex::CustomRemove(const interfaces::BlockInfo& block)\n {\n     CDBBatch batch(*m_db);\n     std::unique_ptr<CDBIterator> db_it(m_db->NewIterator());\n \n     // During a reorg, we need to copy all hash digests for blocks that are\n     // getting disconnected from the height index to the hash index so we can\n     // still find them when the height index entries are overwritten.\n-    if (!CopyHeightIndexToHashIndex(*db_it, batch, m_name, new_tip.height, current_tip.height)) {\n+    if (!CopyHeightIndexToHashIndex(*db_it, batch, m_name, block.height - 1, block.height)) {\n         return false;\n     }\n \n     if (!m_db->WriteBatch(batch)) return false;\n \n-    {\n-        LOCK(cs_main);\n-        CBlockIndex* iter_tip{m_chainstate->m_blockman.LookupBlockIndex(current_tip.hash)};\n-        CBlockIndex* new_tip_index{m_chainstate->m_blockman.LookupBlockIndex(new_tip.hash)};\n-        const auto& consensus_params{Params().GetConsensus()};\n-\n-        do {\n-            CBlock block;\n-\n-            if (!ReadBlockFromDisk(block, iter_tip, consensus_params)) {\n-                return error(\"%s: Failed to read block %s from disk\",\n-                             __func__, iter_tip->GetBlockHash().ToString());\n-            }\n-\n-            ReverseBlock(block, iter_tip);\n-\n-            iter_tip = iter_tip->GetAncestor(iter_tip->nHeight - 1);\n-        } while (new_tip_index != iter_tip);\n-    }\n+    ReverseBlock(block);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803655628",
      "id" : 803655628,
      "line" : 271,
      "node_id" : "PRRC_kwDOABII584v5s_M",
      "original_commit_id" : "d6ebc941f641d68eabe4c3243eb6769dd2d13cf5",
      "original_line" : 280,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 39,
      "pull_request_review_id" : 878775522,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803655628/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-10T13:59:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803655628",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803672787"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803672787"
         }
      },
      "author_association" : "MEMBER",
      "body" : "b8be01a7ef20672fd5faf4f6b82cf5d3fa2a717b : Why this extra condition?",
      "commit_id" : "9acc7fc39d89e31ea6b46c9fda4c539b82cced8c",
      "created_at" : "2022-02-10T13:27:25Z",
      "diff_hunk" : "@@ -75,17 +76,28 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n     if (!block.data || m_index.IgnoreBlockConnected(block)) return;\n \n     const CBlockIndex* best_block_index = m_index.m_best_block_index.load();\n-    if (best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n+    if (block.chain_tip && best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803672787",
      "id" : 803672787,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584v5xLT",
      "original_commit_id" : "b8be01a7ef20672fd5faf4f6b82cf5d3fa2a717b",
      "original_line" : 79,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 13,
      "pull_request_review_id" : 878775522,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803672787/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-10T13:59:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803672787",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803675866"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803675866"
         }
      },
      "author_association" : "MEMBER",
      "body" : "b8be01a7ef20672fd5faf4f6b82cf5d3fa2a717b  This seems new...",
      "commit_id" : "9acc7fc39d89e31ea6b46c9fda4c539b82cced8c",
      "created_at" : "2022-02-10T13:31:03Z",
      "diff_hunk" : "@@ -75,17 +76,28 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n     if (!block.data || m_index.IgnoreBlockConnected(block)) return;\n \n     const CBlockIndex* best_block_index = m_index.m_best_block_index.load();\n-    if (best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n+    if (block.chain_tip && best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n         FatalError(\"%s: Failed to rewind index %s to a previous chain tip\",\n                    __func__, m_index.GetName());\n         return;\n     }\n \n-    if (!m_index.CustomAppend(block)) {\n+    interfaces::BlockInfo block_info = node::MakeBlockInfo(pindex, block.data);\n+    CBlockUndo block_undo;\n+    if (m_options.connect_undo_data && pindex->nHeight > 0) {\n+        if (!node::UndoReadFromDisk(block_undo, pindex)) {\n+            FatalError(\"%s: Failed to read block %s undo data from disk\",\n+                       __func__, pindex->GetBlockHash().ToString());\n+            return m_index.Interrupt();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803675866",
      "id" : 803675866,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584v5x7a",
      "original_commit_id" : "b8be01a7ef20672fd5faf4f6b82cf5d3fa2a717b",
      "original_line" : 91,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 26,
      "pull_request_review_id" : 878775522,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803675866/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-10T13:59:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803675866",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803678322"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803678322"
         }
      },
      "author_association" : "MEMBER",
      "body" : "b8be01a7ef20672fd5faf4f6b82cf5d3fa2a717b : this also seems new. Maybe belongs in the next commit?",
      "commit_id" : "9acc7fc39d89e31ea6b46c9fda4c539b82cced8c",
      "created_at" : "2022-02-10T13:33:56Z",
      "diff_hunk" : "@@ -75,17 +76,28 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n     if (!block.data || m_index.IgnoreBlockConnected(block)) return;\n \n     const CBlockIndex* best_block_index = m_index.m_best_block_index.load();\n-    if (best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n+    if (block.chain_tip && best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n         FatalError(\"%s: Failed to rewind index %s to a previous chain tip\",\n                    __func__, m_index.GetName());\n         return;\n     }\n \n-    if (!m_index.CustomAppend(block)) {\n+    interfaces::BlockInfo block_info = node::MakeBlockInfo(pindex, block.data);\n+    CBlockUndo block_undo;\n+    if (m_options.connect_undo_data && pindex->nHeight > 0) {\n+        if (!node::UndoReadFromDisk(block_undo, pindex)) {\n+            FatalError(\"%s: Failed to read block %s undo data from disk\",\n+                       __func__, pindex->GetBlockHash().ToString());\n+            return m_index.Interrupt();\n+        }\n+        block_info.undo_data = &block_undo;\n+    }\n+    if (!m_index.CustomAppend(block_info)) {\n         FatalError(\"%s: Failed to write block %s to index\",\n                    __func__, pindex->GetBlockHash().ToString());\n-        return;\n-    } else {\n+        return m_index.Interrupt();\n+    }\n+    if (m_index.m_synced) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803678322",
      "id" : 803678322,
      "line" : 148,
      "node_id" : "PRRC_kwDOABII584v5yhy",
      "original_commit_id" : "b8be01a7ef20672fd5faf4f6b82cf5d3fa2a717b",
      "original_line" : 100,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 37,
      "pull_request_review_id" : 878775522,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803678322/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-10T13:59:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803678322",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803700112"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803700112"
         }
      },
      "author_association" : "MEMBER",
      "body" : "e359c2666cfd205c2ea84c241bccf565670365c0: I'm a bit puzzled about what `chainStateFlushed` is for in the context of indexing. Right now it doesn't do much other than call `Commit()`. But we weren't calling it here before.\r\n\r\nThe commit title says \"... to chainStateFlushed\" but in reality that function is untouched and only `blockConnected` is changed.",
      "commit_id" : "9acc7fc39d89e31ea6b46c9fda4c539b82cced8c",
      "created_at" : "2022-02-10T13:57:07Z",
      "diff_hunk" : "@@ -195,10 +197,10 @@ void BaseIndex::ThreadSync()\n                 LOCK(cs_main);\n                 const CBlockIndex* pindex_next = NextSyncBlock(pindex, m_chainstate->m_chain);\n                 if (!pindex_next) {\n-                    m_best_block_index = pindex;\n-                    m_synced = true;\n-                    // No need to handle errors in Commit. See rationale above.\n-                    Commit(GetLocator(*m_chain, pindex->GetBlockHash()));\n+                    assert(pindex);\n+                    notifications->blockConnected(node::MakeBlockInfo(pindex));\n+                    assert(m_synced);\n+                    notifications->chainStateFlushed(GetLocator(*m_chain, pindex->GetBlockHash()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803700112",
      "id" : 803700112,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584v532Q",
      "original_commit_id" : "e359c2666cfd205c2ea84c241bccf565670365c0",
      "original_line" : 203,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 24,
      "pull_request_review_id" : 878775522,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803700112/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-10T13:59:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803700112",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803815653"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803815653"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803628739\r\n\r\n> [2504811](https://github.com/bitcoin/bitcoin/commit/2504811223597b211aa52b86a6386f4c02286d50) : IIUC this makes it so the `Handler` that's in `m_handler` (before its moved) is destroyed when this function is done. Why is it insufficient to just call `m_handler->disconnect()` and have it be destroyed along with `BaseIndex`?\r\n> \r\n> I guess that's what \"because ... disconnect code may need to lock the mutex\" refers to, but it's not super clear to me why this is.\r\n\r\nThanks, wrote a more descriptive comment. The disconnect code waits for the last notification to be processed, so if the last notification need to lock m_mutex for any reason there would be a deadlock if this code wasn't releasing it.",
      "commit_id" : "3c9fa85865c3d766b367e6f2842928112d362fc1",
      "created_at" : "2022-02-10T15:45:40Z",
      "diff_hunk" : "@@ -367,11 +390,15 @@ bool BaseIndex::Start()\n \n void BaseIndex::Stop()\n {\n-    UnregisterValidationInterface(this);\n+    Interrupt();\n \n     if (m_thread_sync.joinable()) {\n         m_thread_sync.join();\n     }\n+\n+    // Call handler destructor after releasing m_mutex, because notification\n+    // threads and disconnect code may need to lock the mutex.\n+    auto handler = WITH_LOCK(m_mutex, return std::move(m_handler));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803815653",
      "id" : 803815653,
      "in_reply_to_id" : 803628739,
      "line" : 296,
      "node_id" : "PRRC_kwDOABII584v6UDl",
      "original_commit_id" : "2504811223597b211aa52b86a6386f4c02286d50",
      "original_line" : 296,
      "original_position" : 177,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 540,
      "pull_request_review_id" : 879038361,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803815653/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-11T01:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803815653",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803815987"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803815987"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803639220\r\n\r\n> [0cefaaa](https://github.com/bitcoin/bitcoin/commit/0cefaaab906e3de84a4e2c5a15e27e56255e17ac): I guess you can now defer this until after `commit()`?\r\n\r\nI guess you're suggesting this code could commit first and update `m_best_block_index` later. I think this may be true currently, but I don't think it's necessarily safe to assume that other indexing code (particularly in `CustomInit` methods) doesn't care about the `m_best_block_index` value or won't depend on it in the future.\r\n\r\nAnyway, the indexing commit code is pretty low quality--it's bad about creating multiple batches, and sharing state inappropriately, and not being atomic--but I'm changing it as little as possible because it's mostly orthogonal to this PR. I do think the PR should make it a little easier to improve committing in the future since at least now it's passing the locator explicitly and it changes the base Commit method to call the custom Commit method instead of the other way around, so the control flow is simpler.",
      "commit_id" : "3c9fa85865c3d766b367e6f2842928112d362fc1",
      "created_at" : "2022-02-10T15:45:58Z",
      "diff_hunk" : "@@ -254,7 +254,7 @@ bool BaseIndex::Rewind(const CBlockIndex* current_tip, const CBlockIndex* new_ti\n     // In case we reorg beyond the pruned depth, ReadBlockFromDisk would\n     // throw and lead to a graceful shutdown\n     m_best_block_index = new_tip;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803815987",
      "id" : 803815987,
      "in_reply_to_id" : 803639220,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584v6UIz",
      "original_commit_id" : "0cefaaab906e3de84a4e2c5a15e27e56255e17ac",
      "original_line" : 256,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 879038361,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803815987/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-11T01:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803815987",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803816180"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803816180"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803700112\r\n\r\n> [e359c26](https://github.com/bitcoin/bitcoin/commit/e359c2666cfd205c2ea84c241bccf565670365c0): I'm a bit puzzled about what `chainStateFlushed` is for in the context of indexing.\r\n\r\nIt just calls Commit() to update the best block locator on disk and flush whatever custom state the index may want to save in CustomCommit().\r\n\r\n> Right now it doesn't do much other than call `Commit()`. But we weren't calling it here before.\r\n\r\nIn commit e359c2666cfd205c2ea84c241bccf565670365c0, previous line 201 `Commit(...);` is changing to `notifications->chainStateFlushed(...);` so there should be preserving behavior\r\n\r\n> The commit title says \"... to chainStateFlushed\" but in reality that function is untouched and only `blockConnected` is changed.\r\n\r\nI'm happy to change commit subject and I made some tweaks, but it would help to have more specific suggestions to know what to change. The format of these commits subject lines generally is \"index: Remove [part of indexing code that doesn't belong in indexing]\" or \"index: Move [part of indexing code out of the code that will be moved to the node later]\", so if I rename this subject line I might need to rename the other \"index: Move\" subject lines too. \r\n\r\nIt is often hard to describe changes commits are making in just a few words. The subject lines here are trying to describe the *goal* of each commit, and the commit bodies are trying to itemize the actual changes. A lot of the changes in different commits are pretty similar to each other, so the subject lines are also trying focus on what makes  commits distinct from each other.",
      "commit_id" : "3c9fa85865c3d766b367e6f2842928112d362fc1",
      "created_at" : "2022-02-10T15:46:08Z",
      "diff_hunk" : "@@ -195,10 +197,10 @@ void BaseIndex::ThreadSync()\n                 LOCK(cs_main);\n                 const CBlockIndex* pindex_next = NextSyncBlock(pindex, m_chainstate->m_chain);\n                 if (!pindex_next) {\n-                    m_best_block_index = pindex;\n-                    m_synced = true;\n-                    // No need to handle errors in Commit. See rationale above.\n-                    Commit(GetLocator(*m_chain, pindex->GetBlockHash()));\n+                    assert(pindex);\n+                    notifications->blockConnected(node::MakeBlockInfo(pindex));\n+                    assert(m_synced);\n+                    notifications->chainStateFlushed(GetLocator(*m_chain, pindex->GetBlockHash()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803816180",
      "id" : 803816180,
      "in_reply_to_id" : 803700112,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584v6UL0",
      "original_commit_id" : "e359c2666cfd205c2ea84c241bccf565670365c0",
      "original_line" : 203,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 879038361,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803816180/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-11T01:16:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803816180",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803816320"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803816320"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803672787\r\n\r\n> [b8be01a](https://github.com/bitcoin/bitcoin/commit/b8be01a7ef20672fd5faf4f6b82cf5d3fa2a717b) : Why this extra condition?\r\n\r\nGood catch. This change makes more sense in the earlier commit adding this code, so I moved it. (It wasn't needed before this commit just because IgnoreBlockConnected was always returning true in this case before this commit.)",
      "commit_id" : "3c9fa85865c3d766b367e6f2842928112d362fc1",
      "created_at" : "2022-02-10T15:46:16Z",
      "diff_hunk" : "@@ -75,17 +76,28 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n     if (!block.data || m_index.IgnoreBlockConnected(block)) return;\n \n     const CBlockIndex* best_block_index = m_index.m_best_block_index.load();\n-    if (best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n+    if (block.chain_tip && best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803816320",
      "id" : 803816320,
      "in_reply_to_id" : 803672787,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584v6UOA",
      "original_commit_id" : "b8be01a7ef20672fd5faf4f6b82cf5d3fa2a717b",
      "original_line" : 79,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 879038361,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803816320/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-11T01:16:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803816320",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803816498"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803816498"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803675866\r\n\r\n> [b8be01a](https://github.com/bitcoin/bitcoin/commit/b8be01a7ef20672fd5faf4f6b82cf5d3fa2a717b) This seems new...\r\n\r\nThis is not actually new, it's moved from BlockFilterIndex::CustomAppend and CoinStatsIndex::CustomAppend below. The different UndoReadFromDisk calls are being consolidated here",
      "commit_id" : "3c9fa85865c3d766b367e6f2842928112d362fc1",
      "created_at" : "2022-02-10T15:46:25Z",
      "diff_hunk" : "@@ -75,17 +76,28 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n     if (!block.data || m_index.IgnoreBlockConnected(block)) return;\n \n     const CBlockIndex* best_block_index = m_index.m_best_block_index.load();\n-    if (best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n+    if (block.chain_tip && best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n         FatalError(\"%s: Failed to rewind index %s to a previous chain tip\",\n                    __func__, m_index.GetName());\n         return;\n     }\n \n-    if (!m_index.CustomAppend(block)) {\n+    interfaces::BlockInfo block_info = node::MakeBlockInfo(pindex, block.data);\n+    CBlockUndo block_undo;\n+    if (m_options.connect_undo_data && pindex->nHeight > 0) {\n+        if (!node::UndoReadFromDisk(block_undo, pindex)) {\n+            FatalError(\"%s: Failed to read block %s undo data from disk\",\n+                       __func__, pindex->GetBlockHash().ToString());\n+            return m_index.Interrupt();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803816498",
      "id" : 803816498,
      "in_reply_to_id" : 803675866,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584v6UQy",
      "original_commit_id" : "b8be01a7ef20672fd5faf4f6b82cf5d3fa2a717b",
      "original_line" : 91,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 879038361,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803816498/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-11T01:16:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803816498",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803816718"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803816718"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803655628\r\n\r\n> [d6ebc94](https://github.com/bitcoin/bitcoin/commit/d6ebc941f641d68eabe4c3243eb6769dd2d13cf5): this refactor of `CustomRewind ` from iterating over blocks to `CustomRemove` which just takes a single block might be worth doing in a separate commit.\r\n\r\n~Good suggestion, split this commit~",
      "commit_id" : "7ae0a4639d25e31eb1d9bd1e01d93cadc3e90a6c",
      "created_at" : "2022-02-10T15:46:38Z",
      "diff_hunk" : "@@ -263,39 +263,21 @@ static bool CopyHeightIndexToHashIndex(CDBIterator& db_it, CDBBatch& batch,\n     return true;\n }\n \n-bool CoinStatsIndex::CustomRewind(const interfaces::BlockKey& current_tip, const interfaces::BlockKey& new_tip)\n+bool CoinStatsIndex::CustomRemove(const interfaces::BlockInfo& block)\n {\n     CDBBatch batch(*m_db);\n     std::unique_ptr<CDBIterator> db_it(m_db->NewIterator());\n \n     // During a reorg, we need to copy all hash digests for blocks that are\n     // getting disconnected from the height index to the hash index so we can\n     // still find them when the height index entries are overwritten.\n-    if (!CopyHeightIndexToHashIndex(*db_it, batch, m_name, new_tip.height, current_tip.height)) {\n+    if (!CopyHeightIndexToHashIndex(*db_it, batch, m_name, block.height - 1, block.height)) {\n         return false;\n     }\n \n     if (!m_db->WriteBatch(batch)) return false;\n \n-    {\n-        LOCK(cs_main);\n-        CBlockIndex* iter_tip{m_chainstate->m_blockman.LookupBlockIndex(current_tip.hash)};\n-        CBlockIndex* new_tip_index{m_chainstate->m_blockman.LookupBlockIndex(new_tip.hash)};\n-        const auto& consensus_params{Params().GetConsensus()};\n-\n-        do {\n-            CBlock block;\n-\n-            if (!ReadBlockFromDisk(block, iter_tip, consensus_params)) {\n-                return error(\"%s: Failed to read block %s from disk\",\n-                             __func__, iter_tip->GetBlockHash().ToString());\n-            }\n-\n-            ReverseBlock(block, iter_tip);\n-\n-            iter_tip = iter_tip->GetAncestor(iter_tip->nHeight - 1);\n-        } while (new_tip_index != iter_tip);\n-    }\n+    ReverseBlock(block);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803816718",
      "id" : 803816718,
      "in_reply_to_id" : 803655628,
      "line" : 271,
      "node_id" : "PRRC_kwDOABII584v6UUO",
      "original_commit_id" : "d6ebc941f641d68eabe4c3243eb6769dd2d13cf5",
      "original_line" : 271,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 140,
      "pull_request_review_id" : 879038361,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803816718/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-15T05:33:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803816718",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803837847"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803837847"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803678322\r\n\r\n> [b8be01a](https://github.com/bitcoin/bitcoin/commit/b8be01a7ef20672fd5faf4f6b82cf5d3fa2a717b) : this also seems new. Maybe belongs in the next commit?\r\n\r\nThis `if (m_synced)` condition just preserves existing behavior. Now that `ThreadSync` is calling `blockConnected`, `m_synced` is no longer always true at this point. For some reason I don't know (but don't want to change) `ThreadSync` code didn't previously update `m_best_block_index` while it was reading and connecting blocks, and I didn't want to change that. This behavior might have been intended for performance reasons, or error handling reasons, or maybe so RPC indexing status would only report best block of indexing data that had actually been flushed to disk. But in any case nothing should be changing here.",
      "commit_id" : "3c9fa85865c3d766b367e6f2842928112d362fc1",
      "created_at" : "2022-02-10T16:06:11Z",
      "diff_hunk" : "@@ -75,17 +76,28 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n     if (!block.data || m_index.IgnoreBlockConnected(block)) return;\n \n     const CBlockIndex* best_block_index = m_index.m_best_block_index.load();\n-    if (best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n+    if (block.chain_tip && best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n         FatalError(\"%s: Failed to rewind index %s to a previous chain tip\",\n                    __func__, m_index.GetName());\n         return;\n     }\n \n-    if (!m_index.CustomAppend(block)) {\n+    interfaces::BlockInfo block_info = node::MakeBlockInfo(pindex, block.data);\n+    CBlockUndo block_undo;\n+    if (m_options.connect_undo_data && pindex->nHeight > 0) {\n+        if (!node::UndoReadFromDisk(block_undo, pindex)) {\n+            FatalError(\"%s: Failed to read block %s undo data from disk\",\n+                       __func__, pindex->GetBlockHash().ToString());\n+            return m_index.Interrupt();\n+        }\n+        block_info.undo_data = &block_undo;\n+    }\n+    if (!m_index.CustomAppend(block_info)) {\n         FatalError(\"%s: Failed to write block %s to index\",\n                    __func__, pindex->GetBlockHash().ToString());\n-        return;\n-    } else {\n+        return m_index.Interrupt();\n+    }\n+    if (m_index.m_synced) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803837847",
      "id" : 803837847,
      "in_reply_to_id" : 803678322,
      "line" : 148,
      "node_id" : "PRRC_kwDOABII584v6ZeX",
      "original_commit_id" : "b8be01a7ef20672fd5faf4f6b82cf5d3fa2a717b",
      "original_line" : 148,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 283,
      "pull_request_review_id" : 879038361,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803837847/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-11T01:16:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/803837847",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r804287560"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/804287560"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803678322\r\n\r\n> [b8be01a](https://github.com/bitcoin/bitcoin/commit/b8be01a7ef20672fd5faf4f6b82cf5d3fa2a717b) : this also seems new. Maybe belongs in the next commit?\r\n\r\nMaybe I should add a comment here like \"Don't update m_best_block_index between flushes if not synced. Unclear why best block is not updated in this case, but this has been longstanding behavior since syncing was introduced in #13033 so care should be taken if changing this.\"",
      "commit_id" : "3c9fa85865c3d766b367e6f2842928112d362fc1",
      "created_at" : "2022-02-11T01:27:43Z",
      "diff_hunk" : "@@ -75,17 +76,28 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n     if (!block.data || m_index.IgnoreBlockConnected(block)) return;\n \n     const CBlockIndex* best_block_index = m_index.m_best_block_index.load();\n-    if (best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n+    if (block.chain_tip && best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n         FatalError(\"%s: Failed to rewind index %s to a previous chain tip\",\n                    __func__, m_index.GetName());\n         return;\n     }\n \n-    if (!m_index.CustomAppend(block)) {\n+    interfaces::BlockInfo block_info = node::MakeBlockInfo(pindex, block.data);\n+    CBlockUndo block_undo;\n+    if (m_options.connect_undo_data && pindex->nHeight > 0) {\n+        if (!node::UndoReadFromDisk(block_undo, pindex)) {\n+            FatalError(\"%s: Failed to read block %s undo data from disk\",\n+                       __func__, pindex->GetBlockHash().ToString());\n+            return m_index.Interrupt();\n+        }\n+        block_info.undo_data = &block_undo;\n+    }\n+    if (!m_index.CustomAppend(block_info)) {\n         FatalError(\"%s: Failed to write block %s to index\",\n                    __func__, pindex->GetBlockHash().ToString());\n-        return;\n-    } else {\n+        return m_index.Interrupt();\n+    }\n+    if (m_index.m_synced) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r804287560",
      "id" : 804287560,
      "in_reply_to_id" : 803678322,
      "line" : 148,
      "node_id" : "PRRC_kwDOABII584v8HRI",
      "original_commit_id" : "b8be01a7ef20672fd5faf4f6b82cf5d3fa2a717b",
      "original_line" : 148,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 283,
      "pull_request_review_id" : 879698638,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/804287560/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-11T01:27:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/804287560",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK, will start reviewing soon",
      "created_at" : "2022-02-13T12:53:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1038093095",
      "id" : 1038093095,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII58494Asn",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1038093095/reactions"
      },
      "updated_at" : "2022-02-13T12:53:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1038093095",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r805348610"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/805348610"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803628739\r\n\r\n> Thanks, wrote a more descriptive comment.\r\n\r\nActually fixed now. I messed up the last push and did not include this change.",
      "commit_id" : "7ae0a4639d25e31eb1d9bd1e01d93cadc3e90a6c",
      "created_at" : "2022-02-13T15:10:58Z",
      "diff_hunk" : "@@ -367,11 +390,15 @@ bool BaseIndex::Start()\n \n void BaseIndex::Stop()\n {\n-    UnregisterValidationInterface(this);\n+    Interrupt();\n \n     if (m_thread_sync.joinable()) {\n         m_thread_sync.join();\n     }\n+\n+    // Call handler destructor after releasing m_mutex, because notification\n+    // threads and disconnect code may need to lock the mutex.\n+    auto handler = WITH_LOCK(m_mutex, return std::move(m_handler));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r805348610",
      "id" : 805348610,
      "in_reply_to_id" : 803628739,
      "line" : 303,
      "node_id" : "PRRC_kwDOABII584wAKUC",
      "original_commit_id" : "2504811223597b211aa52b86a6386f4c02286d50",
      "original_line" : 303,
      "original_position" : 177,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 547,
      "pull_request_review_id" : 880993870,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/805348610/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-15T05:51:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/805348610",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r805349847"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/805349847"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803678322\r\n\r\n> Maybe I should add a comment\r\n\r\nAdded now\r\n\r\n",
      "commit_id" : "7ae0a4639d25e31eb1d9bd1e01d93cadc3e90a6c",
      "created_at" : "2022-02-13T15:20:33Z",
      "diff_hunk" : "@@ -75,17 +76,28 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n     if (!block.data || m_index.IgnoreBlockConnected(block)) return;\n \n     const CBlockIndex* best_block_index = m_index.m_best_block_index.load();\n-    if (best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n+    if (block.chain_tip && best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n         FatalError(\"%s: Failed to rewind index %s to a previous chain tip\",\n                    __func__, m_index.GetName());\n         return;\n     }\n \n-    if (!m_index.CustomAppend(block)) {\n+    interfaces::BlockInfo block_info = node::MakeBlockInfo(pindex, block.data);\n+    CBlockUndo block_undo;\n+    if (m_options.connect_undo_data && pindex->nHeight > 0) {\n+        if (!node::UndoReadFromDisk(block_undo, pindex)) {\n+            FatalError(\"%s: Failed to read block %s undo data from disk\",\n+                       __func__, pindex->GetBlockHash().ToString());\n+            return m_index.Interrupt();\n+        }\n+        block_info.undo_data = &block_undo;\n+    }\n+    if (!m_index.CustomAppend(block_info)) {\n         FatalError(\"%s: Failed to write block %s to index\",\n                    __func__, pindex->GetBlockHash().ToString());\n-        return;\n-    } else {\n+        return m_index.Interrupt();\n+    }\n+    if (m_index.m_synced) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r805349847",
      "id" : 805349847,
      "in_reply_to_id" : 803678322,
      "line" : 152,
      "node_id" : "PRRC_kwDOABII584wAKnX",
      "original_commit_id" : "b8be01a7ef20672fd5faf4f6b82cf5d3fa2a717b",
      "original_line" : 152,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 287,
      "pull_request_review_id" : 880993870,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/805349847/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-15T05:51:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/805349847",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r806464030"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/806464030"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: [#24230 (comment)](https://github.com/bitcoin/bitcoin/pull/24230#discussion_r803655628)\r\n\r\n > [d6ebc94](https://github.com/bitcoin/bitcoin/commit/d6ebc941f641d68eabe4c3243eb6769dd2d13cf5): this refactor of `CustomRewind ` from iterating over blocks to `CustomRemove` which just takes a single block might be worth doing in a separate commit.\r\n\r\nI tried this but couldn't actually figure out how how to do it in a good way. I updated the commit description and I want the commit to reflect fact that block read and block undo read is moving from custom indexes up to the BaseIndex::Rewind. If I add the loop in base class without removing it from the custom indexes, it's less clear that code is just moving.",
      "commit_id" : "7ae0a4639d25e31eb1d9bd1e01d93cadc3e90a6c",
      "created_at" : "2022-02-15T05:46:12Z",
      "diff_hunk" : "@@ -263,39 +263,21 @@ static bool CopyHeightIndexToHashIndex(CDBIterator& db_it, CDBBatch& batch,\n     return true;\n }\n \n-bool CoinStatsIndex::CustomRewind(const interfaces::BlockKey& current_tip, const interfaces::BlockKey& new_tip)\n+bool CoinStatsIndex::CustomRemove(const interfaces::BlockInfo& block)\n {\n     CDBBatch batch(*m_db);\n     std::unique_ptr<CDBIterator> db_it(m_db->NewIterator());\n \n     // During a reorg, we need to copy all hash digests for blocks that are\n     // getting disconnected from the height index to the hash index so we can\n     // still find them when the height index entries are overwritten.\n-    if (!CopyHeightIndexToHashIndex(*db_it, batch, m_name, new_tip.height, current_tip.height)) {\n+    if (!CopyHeightIndexToHashIndex(*db_it, batch, m_name, block.height - 1, block.height)) {\n         return false;\n     }\n \n     if (!m_db->WriteBatch(batch)) return false;\n \n-    {\n-        LOCK(cs_main);\n-        CBlockIndex* iter_tip{m_chainstate->m_blockman.LookupBlockIndex(current_tip.hash)};\n-        CBlockIndex* new_tip_index{m_chainstate->m_blockman.LookupBlockIndex(new_tip.hash)};\n-        const auto& consensus_params{Params().GetConsensus()};\n-\n-        do {\n-            CBlock block;\n-\n-            if (!ReadBlockFromDisk(block, iter_tip, consensus_params)) {\n-                return error(\"%s: Failed to read block %s from disk\",\n-                             __func__, iter_tip->GetBlockHash().ToString());\n-            }\n-\n-            ReverseBlock(block, iter_tip);\n-\n-            iter_tip = iter_tip->GetAncestor(iter_tip->nHeight - 1);\n-        } while (new_tip_index != iter_tip);\n-    }\n+    ReverseBlock(block);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r806464030",
      "id" : 806464030,
      "in_reply_to_id" : 803655628,
      "line" : 271,
      "node_id" : "PRRC_kwDOABII584wEaoe",
      "original_commit_id" : "d6ebc941f641d68eabe4c3243eb6769dd2d13cf5",
      "original_line" : 271,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 140,
      "pull_request_review_id" : 880993870,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/806464030/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-15T05:51:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/806464030",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r806939378"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/806939378"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "commit dc4675ddaca8d0d1d40847191cb21ccd116a6a3c:\r\nLooks like `undo_pos` is never being used.",
      "commit_id" : "7ae0a4639d25e31eb1d9bd1e01d93cadc3e90a6c",
      "created_at" : "2022-02-15T15:12:03Z",
      "diff_hunk" : "@@ -67,6 +68,20 @@ class FoundBlock\n     mutable bool found = false;\n };\n \n+//! Block data sent with blockConnected, blockDisconnected notifications.\n+struct BlockInfo {\n+    const uint256& hash;\n+    const uint256* prev_hash = nullptr;\n+    int height = -1;\n+    int file_number = -1;\n+    unsigned data_pos = 0;\n+    unsigned undo_pos = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r806939378",
      "id" : 806939378,
      "line" : 87,
      "node_id" : "PRRC_kwDOABII584wGOry",
      "original_commit_id" : "dc4675ddaca8d0d1d40847191cb21ccd116a6a3c",
      "original_line" : 78,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/interfaces/chain.h",
      "position" : 19,
      "pull_request_review_id" : 883137628,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/806939378/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-15T22:55:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/806939378",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r806961991"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/806961991"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "f631a1b16ac2f58f47942c7cf51fbe8445694f65: \r\nI think that this might be a slight change in behavior: If `m_best_block_index` is nullptr here (which is possible if we get an  interrupt early in init), this will segfault now. Though the old behavior (that a locator to the tip was returned) was not ideal either, see #24117. ",
      "commit_id" : "7ae0a4639d25e31eb1d9bd1e01d93cadc3e90a6c",
      "created_at" : "2022-02-15T15:26:27Z",
      "diff_hunk" : "@@ -211,19 +220,16 @@ void BaseIndex::ThreadSync()\n bool BaseIndex::Commit()\n {\n     CDBBatch batch(GetDB());\n-    if (!CommitInternal(batch) || !GetDB().WriteBatch(batch)) {\n+    bool success = CustomCommit(batch);\n+    if (success) {\n+        GetDB().WriteBestBlock(batch, GetLocator(*m_chain, m_best_block_index.load()->GetBlockHash()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r806961991",
      "id" : 806961991,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584wGUNH",
      "original_commit_id" : "f631a1b16ac2f58f47942c7cf51fbe8445694f65",
      "original_line" : 225,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 23,
      "pull_request_review_id" : 883137628,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/806961991/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-15T22:55:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/806961991",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-02-15T19:57:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1040731190",
      "id" : 1040731190,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII584-CEw2",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1040731190/reactions"
      },
      "updated_at" : "2022-02-15T19:57:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1040731190",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807318089"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807318089"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "3450df4d01608bd29f443aab3df1eed45108b3b2: I think this incremental processing will mean that in case of a deeper reorg, intermediate blocks are processed twice in `CopyHeightIndexToHashIndex` now, as new_tip and current_tip. Also, there willl be some extra calls to `ReadBlockFromDisk` also for txindex now (which doesn't implement `CustomRemove` logic). But this seems fine to me.",
      "commit_id" : "7ae0a4639d25e31eb1d9bd1e01d93cadc3e90a6c",
      "created_at" : "2022-02-15T21:10:44Z",
      "diff_hunk" : "@@ -244,8 +245,28 @@ bool BaseIndex::Rewind(const CBlockIndex* current_tip, const CBlockIndex* new_ti\n     assert(current_tip == m_best_block_index);\n     assert(current_tip->GetAncestor(new_tip->nHeight) == new_tip);\n \n-    if (!CustomRewind({current_tip->GetBlockHash(), current_tip->nHeight}, {new_tip->GetBlockHash(), new_tip->nHeight})) {\n-        return false;\n+    const Consensus::Params& consensus_params = Params().GetConsensus();\n+    CBlock block;\n+    CBlockUndo block_undo;\n+\n+    for (const CBlockIndex* iter_tip = current_tip; iter_tip != new_tip; iter_tip = iter_tip->pprev) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807318089",
      "id" : 807318089,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584wHrJJ",
      "original_commit_id" : "3450df4d01608bd29f443aab3df1eed45108b3b2",
      "original_line" : 252,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 18,
      "pull_request_review_id" : 883137628,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807318089/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-15T22:55:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807318089",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807321009"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807321009"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "3450df4d01608bd29f443aab3df1eed45108b3b2: The comment above could be adjusted, CustomRemove now rewinds just one block.",
      "commit_id" : "7ae0a4639d25e31eb1d9bd1e01d93cadc3e90a6c",
      "created_at" : "2022-02-15T21:14:57Z",
      "diff_hunk" : "@@ -118,7 +118,7 @@ class BaseIndex\n \n     /// Rewind index to an earlier chain tip during a chain reorg. The tip must\n     /// be an ancestor of the current best block.\n-    [[nodiscard]] virtual bool CustomRewind(const interfaces::BlockKey& current_tip, const interfaces::BlockKey& new_tip) { return true; }\n+    [[nodiscard]] virtual bool CustomRemove(const interfaces::BlockInfo& block) { return true; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807321009",
      "id" : 807321009,
      "line" : 103,
      "node_id" : "PRRC_kwDOABII584wHr2x",
      "original_commit_id" : "3450df4d01608bd29f443aab3df1eed45108b3b2",
      "original_line" : 121,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/index/base.h",
      "position" : 14,
      "pull_request_review_id" : 883137628,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807321009/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-15T22:55:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807321009",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807331690"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807331690"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "My impression is that in the old code, the ThreadSync the strategy was to update `m_best_block_index` exactly before calling `Commit()` (and using `pindex` instead of `m_best_block_index` for everything else). So updating it after each `WriteBlock` call was just unnecessary.",
      "commit_id" : "7ae0a4639d25e31eb1d9bd1e01d93cadc3e90a6c",
      "created_at" : "2022-02-15T21:30:25Z",
      "diff_hunk" : "@@ -75,17 +76,28 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n     if (!block.data || m_index.IgnoreBlockConnected(block)) return;\n \n     const CBlockIndex* best_block_index = m_index.m_best_block_index.load();\n-    if (best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n+    if (block.chain_tip && best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n         FatalError(\"%s: Failed to rewind index %s to a previous chain tip\",\n                    __func__, m_index.GetName());\n         return;\n     }\n \n-    if (!m_index.CustomAppend(block)) {\n+    interfaces::BlockInfo block_info = node::MakeBlockInfo(pindex, block.data);\n+    CBlockUndo block_undo;\n+    if (m_options.connect_undo_data && pindex->nHeight > 0) {\n+        if (!node::UndoReadFromDisk(block_undo, pindex)) {\n+            FatalError(\"%s: Failed to read block %s undo data from disk\",\n+                       __func__, pindex->GetBlockHash().ToString());\n+            return m_index.Interrupt();\n+        }\n+        block_info.undo_data = &block_undo;\n+    }\n+    if (!m_index.CustomAppend(block_info)) {\n         FatalError(\"%s: Failed to write block %s to index\",\n                    __func__, pindex->GetBlockHash().ToString());\n-        return;\n-    } else {\n+        return m_index.Interrupt();\n+    }\n+    if (m_index.m_synced) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807331690",
      "id" : 807331690,
      "in_reply_to_id" : 803678322,
      "line" : 152,
      "node_id" : "PRRC_kwDOABII584wHudq",
      "original_commit_id" : "b8be01a7ef20672fd5faf4f6b82cf5d3fa2a717b",
      "original_line" : 152,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 287,
      "pull_request_review_id" : 883137628,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807331690/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-15T22:55:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807331690",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807335711"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807335711"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "36a9a550debc7324954765e60aefc33ab1456e5c: This should probably be conditional on `!m_index.m_synced`, otherwise there would be additional log messages after the index is synced (after most new blocks, since `SYNC_LOG_INTERVAL=30s`).",
      "commit_id" : "7ae0a4639d25e31eb1d9bd1e01d93cadc3e90a6c",
      "created_at" : "2022-02-15T21:36:06Z",
      "diff_hunk" : "@@ -92,6 +94,12 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n         }\n         block_info.undo_data = &block_undo;\n     }\n+    int64_t current_time = GetTime();\n+    if (m_last_log_time + SYNC_LOG_INTERVAL < current_time) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807335711",
      "id" : 807335711,
      "line" : 138,
      "node_id" : "PRRC_kwDOABII584wHvcf",
      "original_commit_id" : "36a9a550debc7324954765e60aefc33ab1456e5c",
      "original_line" : 98,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 14,
      "pull_request_review_id" : 883137628,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807335711/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-15T22:55:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807335711",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807356962"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807356962"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "f56a851e11321ede9c5bcb43cd067c17f9efab39: Adding the condition `if (m_synced)` seems unnecessary at this point, `IgnoreChainStateFlushed` returns right at the beginning if not synced.",
      "commit_id" : "7ae0a4639d25e31eb1d9bd1e01d93cadc3e90a6c",
      "created_at" : "2022-02-15T22:06:56Z",
      "diff_hunk" : "@@ -351,10 +360,12 @@ bool BaseIndex::IgnoreChainStateFlushed(const CBlockLocator& locator)\n     // event, log a warning and let the queue clear.\n     const CBlockIndex* best_block_index = m_best_block_index.load();\n     if (best_block_index->GetAncestor(locator_tip_index->nHeight) != locator_tip_index) {\n-        LogPrintf(\"%s: WARNING: Locator contains block (hash=%s) not on known best \" /* Continued */\n-                  \"chain (tip=%s); not writing index locator\\n\",\n-                  __func__, locator_tip_hash.ToString(),\n-                  best_block_index->GetBlockHash().ToString());\n+        if (m_synced) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807356962",
      "id" : 807356962,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584wH0oi",
      "original_commit_id" : "f56a851e11321ede9c5bcb43cd067c17f9efab39",
      "original_line" : 363,
      "original_position" : 170,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 170,
      "pull_request_review_id" : 883137628,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807356962/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-15T22:55:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807356962",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807384378"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807384378"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "f56a851e11321ede9c5bcb43cd067c17f9efab39: why the additional `!block.chain_tip` condition? I'd assume if we happen to experience a reorg during initial sync and disconnect the tip, `block.chain_tip=true` and we don't return, but we wouldn't want to process this.\r\nPossibly related: If, at this commit, I am in the middle of syncing an index and at the same time call `invalidateblock` for the tip, my node coredumps with \"`leveldb/db/db_iter.cc:65: virtual leveldb::Slice leveldb::{anonymous}::DBIter::key() const: Assertion `valid_' failed.`\"",
      "commit_id" : "7ae0a4639d25e31eb1d9bd1e01d93cadc3e90a6c",
      "created_at" : "2022-02-15T22:51:10Z",
      "diff_hunk" : "@@ -125,6 +139,25 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n \n void BaseIndexNotifications::blockDisconnected(const interfaces::BlockInfo& block)\n {\n+    // During initial sync, ignore validation interface notifications, only\n+    // process notifications from sync thread.\n+    if (!m_index.m_synced && !block.chain_tip) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807384378",
      "id" : 807384378,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584wH7U6",
      "original_commit_id" : "f56a851e11321ede9c5bcb43cd067c17f9efab39",
      "original_line" : 144,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 42,
      "pull_request_review_id" : 883137628,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807384378/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-15T22:55:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807384378",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807538892"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807538892"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r806939378\r\n\r\n> commit [dc4675d](https://github.com/bitcoin/bitcoin/commit/dc4675ddaca8d0d1d40847191cb21ccd116a6a3c): Looks like `undo_pos` is never being used.\r\n\r\nGreat catch! Removed",
      "commit_id" : "72c29827f8adbc988be26c2002a8feedf9adc15a",
      "created_at" : "2022-02-16T04:55:41Z",
      "diff_hunk" : "@@ -67,6 +68,20 @@ class FoundBlock\n     mutable bool found = false;\n };\n \n+//! Block data sent with blockConnected, blockDisconnected notifications.\n+struct BlockInfo {\n+    const uint256& hash;\n+    const uint256* prev_hash = nullptr;\n+    int height = -1;\n+    int file_number = -1;\n+    unsigned data_pos = 0;\n+    unsigned undo_pos = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807538892",
      "id" : 807538892,
      "in_reply_to_id" : 806939378,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584wIhDM",
      "original_commit_id" : "dc4675ddaca8d0d1d40847191cb21ccd116a6a3c",
      "original_line" : 78,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/interfaces/chain.h",
      "position" : null,
      "pull_request_review_id" : 883961380,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807538892/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-16T23:33:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807538892",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807539156"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807539156"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r806961991\r\n\r\n> [f631a1b](https://github.com/bitcoin/bitcoin/commit/f631a1b16ac2f58f47942c7cf51fbe8445694f65): I think that this might be a slight change in behavior: If `m_best_block_index` is nullptr here (which is possible if we get an interrupt early in init), this will segfault now. Though the old behavior (that a locator to the tip was returned) was not ideal either, see #24117.\r\n\r\nAbsolutely. Rebasing on your fix from #24117, I believe this should be fixed here as well.\r\n",
      "commit_id" : "72c29827f8adbc988be26c2002a8feedf9adc15a",
      "created_at" : "2022-02-16T04:56:22Z",
      "diff_hunk" : "@@ -211,19 +220,16 @@ void BaseIndex::ThreadSync()\n bool BaseIndex::Commit()\n {\n     CDBBatch batch(GetDB());\n-    if (!CommitInternal(batch) || !GetDB().WriteBatch(batch)) {\n+    bool success = CustomCommit(batch);\n+    if (success) {\n+        GetDB().WriteBestBlock(batch, GetLocator(*m_chain, m_best_block_index.load()->GetBlockHash()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807539156",
      "id" : 807539156,
      "in_reply_to_id" : 806961991,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584wIhHU",
      "original_commit_id" : "f631a1b16ac2f58f47942c7cf51fbe8445694f65",
      "original_line" : 225,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 883961380,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807539156/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-16T23:33:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807539156",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807539516"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807539516"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807318089\r\n\r\n> [3450df4](https://github.com/bitcoin/bitcoin/commit/3450df4d01608bd29f443aab3df1eed45108b3b2): I think this incremental processing will mean that in case of a deeper reorg, intermediate blocks are processed twice in `CopyHeightIndexToHashIndex` now, as new_tip and current_tip. \r\n\r\nYes, exactly. I fixed commit message to describe this instead of saying \"This commit does not change behavior in any way\"\r\n\r\n> Also, there willl be some extra calls to `ReadBlockFromDisk` also for txindex now (which doesn't implement `CustomRemove` logic). But this seems fine to me.\r\n\r\nOh, this part was not intentional. Changed to remove these block reads. They are wasteful for BlockFilterIndex as well as TxIndex",
      "commit_id" : "72c29827f8adbc988be26c2002a8feedf9adc15a",
      "created_at" : "2022-02-16T04:57:19Z",
      "diff_hunk" : "@@ -244,8 +245,28 @@ bool BaseIndex::Rewind(const CBlockIndex* current_tip, const CBlockIndex* new_ti\n     assert(current_tip == m_best_block_index);\n     assert(current_tip->GetAncestor(new_tip->nHeight) == new_tip);\n \n-    if (!CustomRewind({current_tip->GetBlockHash(), current_tip->nHeight}, {new_tip->GetBlockHash(), new_tip->nHeight})) {\n-        return false;\n+    const Consensus::Params& consensus_params = Params().GetConsensus();\n+    CBlock block;\n+    CBlockUndo block_undo;\n+\n+    for (const CBlockIndex* iter_tip = current_tip; iter_tip != new_tip; iter_tip = iter_tip->pprev) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807539516",
      "id" : 807539516,
      "in_reply_to_id" : 807318089,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584wIhM8",
      "original_commit_id" : "3450df4d01608bd29f443aab3df1eed45108b3b2",
      "original_line" : 252,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 883961380,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807539516/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-16T23:33:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807539516",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807539753"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807539753"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807321009\r\n\r\n\r\n> 3450df4d01608bd29f443aab3df1eed45108b3b2: The comment above could be adjusted, CustomRemove now rewinds just one block.\r\n\r\nThanks, now noted in comment\r\n\r\n",
      "commit_id" : "72c29827f8adbc988be26c2002a8feedf9adc15a",
      "created_at" : "2022-02-16T04:58:06Z",
      "diff_hunk" : "@@ -118,7 +118,7 @@ class BaseIndex\n \n     /// Rewind index to an earlier chain tip during a chain reorg. The tip must\n     /// be an ancestor of the current best block.\n-    [[nodiscard]] virtual bool CustomRewind(const interfaces::BlockKey& current_tip, const interfaces::BlockKey& new_tip) { return true; }\n+    [[nodiscard]] virtual bool CustomRemove(const interfaces::BlockInfo& block) { return true; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807539753",
      "id" : 807539753,
      "in_reply_to_id" : 807321009,
      "line" : 102,
      "node_id" : "PRRC_kwDOABII584wIhQp",
      "original_commit_id" : "3450df4d01608bd29f443aab3df1eed45108b3b2",
      "original_line" : 102,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/index/base.h",
      "position" : 99,
      "pull_request_review_id" : 883961380,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807539753/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-16T23:33:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807539753",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807540234"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807540234"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r805349847\r\n\r\n> My impression is that in the old code, the ThreadSync the strategy was to update `m_best_block_index` exactly before calling `Commit()` (and using `pindex` instead of `m_best_block_index` for everything else). So updating it after each `WriteBlock` call was just unnecessary.\r\n\r\nI don't think this implies it's unnecessary unless you are assuming `ChainStateFlushed` (which calls `Commit`) is always called immediately after `BlockConnected`, which I think may not always be the case (i.e. during IBD). I'd actually be more worried about removing the `m_best_block_index` assignment here than I would be about assigning it unconditionally. I'd be happy to review another PR which changes this (and happy to rebase this PR on top) but in general I would like to not change `m_best_block_index` semantics in this PR unless it really helps things and we can be very sure it's safe.",
      "commit_id" : "72c29827f8adbc988be26c2002a8feedf9adc15a",
      "created_at" : "2022-02-16T04:59:29Z",
      "diff_hunk" : "@@ -75,17 +76,28 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n     if (!block.data || m_index.IgnoreBlockConnected(block)) return;\n \n     const CBlockIndex* best_block_index = m_index.m_best_block_index.load();\n-    if (best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n+    if (block.chain_tip && best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n         FatalError(\"%s: Failed to rewind index %s to a previous chain tip\",\n                    __func__, m_index.GetName());\n         return;\n     }\n \n-    if (!m_index.CustomAppend(block)) {\n+    interfaces::BlockInfo block_info = node::MakeBlockInfo(pindex, block.data);\n+    CBlockUndo block_undo;\n+    if (m_options.connect_undo_data && pindex->nHeight > 0) {\n+        if (!node::UndoReadFromDisk(block_undo, pindex)) {\n+            FatalError(\"%s: Failed to read block %s undo data from disk\",\n+                       __func__, pindex->GetBlockHash().ToString());\n+            return m_index.Interrupt();\n+        }\n+        block_info.undo_data = &block_undo;\n+    }\n+    if (!m_index.CustomAppend(block_info)) {\n         FatalError(\"%s: Failed to write block %s to index\",\n                    __func__, pindex->GetBlockHash().ToString());\n-        return;\n-    } else {\n+        return m_index.Interrupt();\n+    }\n+    if (m_index.m_synced) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807540234",
      "id" : 807540234,
      "in_reply_to_id" : 803678322,
      "line" : 155,
      "node_id" : "PRRC_kwDOABII584wIhYK",
      "original_commit_id" : "b8be01a7ef20672fd5faf4f6b82cf5d3fa2a717b",
      "original_line" : 155,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 289,
      "pull_request_review_id" : 883961380,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807540234/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-16T23:33:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807540234",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807540622"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807540622"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807335711\r\n\r\n> [36a9a55](https://github.com/bitcoin/bitcoin/commit/36a9a550debc7324954765e60aefc33ab1456e5c): This should probably be conditional on `!m_index.m_synced`, otherwise there would be additional log messages after the index is synced (after most new blocks, since `SYNC_LOG_INTERVAL=30s`).\r\n\r\nYes, good catch. Added this",
      "commit_id" : "72c29827f8adbc988be26c2002a8feedf9adc15a",
      "created_at" : "2022-02-16T05:00:42Z",
      "diff_hunk" : "@@ -92,6 +94,12 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n         }\n         block_info.undo_data = &block_undo;\n     }\n+    int64_t current_time = GetTime();\n+    if (m_last_log_time + SYNC_LOG_INTERVAL < current_time) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807540622",
      "id" : 807540622,
      "in_reply_to_id" : 807335711,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584wIheO",
      "original_commit_id" : "36a9a550debc7324954765e60aefc33ab1456e5c",
      "original_line" : 98,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 883961380,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807540622/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-16T23:33:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807540622",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807540885"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807540885"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807384378\r\n\r\n> [f56a851](https://github.com/bitcoin/bitcoin/commit/f56a851e11321ede9c5bcb43cd067c17f9efab39): why the additional `!block.chain_tip` condition? \r\n\r\nOh no. This is just a bug. It should say `if (!m_index.m_synced && block.chain_tip)`. During sync notifications can come from two different sources;\r\n\r\n1 - The sync thread (with chain_tip = false)\r\n2 - The validation interface (with chain_tip = true)\r\n\r\nWe just want to ignore sync notifications from the validation interface like the comment above says.\r\n\r\n> I'd assume if we happen to experience a reorg during initial sync and disconnect the tip, `block.chain_tip=true` and we don't return, but we wouldn't want to process this.\r\n\r\nMost of the time we won't want to process this but sometimes we might if the reorg happens right at the end of the sync. We just want to process this whenever being called from the sync thread, and not process it when not called from the sync thread during sync. After sync, we always want to process it.\r\n\r\n>  Possibly related: If, at this commit, I am in the middle of syncing an index and at the same time call `invalidateblock` for the tip, my node coredumps with \"`leveldb/db/db_iter.cc:65: virtual leveldb::Slice leveldb::{anonymous}::DBIter::key() const: Assertion `valid_' failed.`\"\r\n\r\nInteresting, it does sound related. I would be curious to know if is fixed now. And maybe I could make this into a test. I'm curious if you made changes to somehow pause the sync to emulate a reorg happening at the same time?",
      "commit_id" : "72c29827f8adbc988be26c2002a8feedf9adc15a",
      "created_at" : "2022-02-16T05:01:25Z",
      "diff_hunk" : "@@ -125,6 +139,25 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n \n void BaseIndexNotifications::blockDisconnected(const interfaces::BlockInfo& block)\n {\n+    // During initial sync, ignore validation interface notifications, only\n+    // process notifications from sync thread.\n+    if (!m_index.m_synced && !block.chain_tip) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807540885",
      "id" : 807540885,
      "in_reply_to_id" : 807384378,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584wIhiV",
      "original_commit_id" : "f56a851e11321ede9c5bcb43cd067c17f9efab39",
      "original_line" : 144,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 883961380,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807540885/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-16T23:33:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807540885",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807541075"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807541075"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807356962\r\n\r\n> [f56a851](https://github.com/bitcoin/bitcoin/commit/f56a851e11321ede9c5bcb43cd067c17f9efab39): Adding the condition `if (m_synced)` seems unnecessary at this point, `IgnoreChainStateFlushed` returns right at the beginning if not synced.\r\n\r\nOh, this is actually correct, but the check above should have been removed. The syncing here get simpler after the \r\n\"Rewrite chain sync logic, remove racy init\" commit, but right now chainStateFlushed notification events from the validation interface (not the sync thread) can happen at random times while the sync thread is still syncing, so the check avoids printing in this case while still not committing anything.",
      "commit_id" : "72c29827f8adbc988be26c2002a8feedf9adc15a",
      "created_at" : "2022-02-16T05:01:57Z",
      "diff_hunk" : "@@ -351,10 +360,12 @@ bool BaseIndex::IgnoreChainStateFlushed(const CBlockLocator& locator)\n     // event, log a warning and let the queue clear.\n     const CBlockIndex* best_block_index = m_best_block_index.load();\n     if (best_block_index->GetAncestor(locator_tip_index->nHeight) != locator_tip_index) {\n-        LogPrintf(\"%s: WARNING: Locator contains block (hash=%s) not on known best \" /* Continued */\n-                  \"chain (tip=%s); not writing index locator\\n\",\n-                  __func__, locator_tip_hash.ToString(),\n-                  best_block_index->GetBlockHash().ToString());\n+        if (m_synced) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r807541075",
      "id" : 807541075,
      "in_reply_to_id" : 807356962,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584wIhlT",
      "original_commit_id" : "f56a851e11321ede9c5bcb43cd067c17f9efab39",
      "original_line" : 363,
      "original_position" : 170,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 883961380,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807541075/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-16T23:33:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/807541075",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r810294690"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/810294690"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I meant \"updating it after each WriteBlock _in the ThreadSync phase_\" is unnecessary. During the Sync phase, validation callbacks are ignored, and ThreadSync does the work - considering that the ThreadSync code in master makes sure that `m_best_block_index` is updated right before each possible `Commit()` call, and never used otherwise (pindex is used for that), I think that an earlier update of `m_best_block_index` after the [`WriteBlock`](https://github.com/bitcoin/bitcoin/blob/5d254a234d8c1569b0161264cc6d5d8d0ce0d864/src/index/base.cpp#L187) call within `ThreadSync` is just not necessary.\r\nSo I was just trying to explain why the longstanding behavior in master makes sense to me. I'm not suggesting to change anything here.",
      "commit_id" : "72c29827f8adbc988be26c2002a8feedf9adc15a",
      "created_at" : "2022-02-18T19:45:15Z",
      "diff_hunk" : "@@ -75,17 +76,28 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n     if (!block.data || m_index.IgnoreBlockConnected(block)) return;\n \n     const CBlockIndex* best_block_index = m_index.m_best_block_index.load();\n-    if (best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n+    if (block.chain_tip && best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n         FatalError(\"%s: Failed to rewind index %s to a previous chain tip\",\n                    __func__, m_index.GetName());\n         return;\n     }\n \n-    if (!m_index.CustomAppend(block)) {\n+    interfaces::BlockInfo block_info = node::MakeBlockInfo(pindex, block.data);\n+    CBlockUndo block_undo;\n+    if (m_options.connect_undo_data && pindex->nHeight > 0) {\n+        if (!node::UndoReadFromDisk(block_undo, pindex)) {\n+            FatalError(\"%s: Failed to read block %s undo data from disk\",\n+                       __func__, pindex->GetBlockHash().ToString());\n+            return m_index.Interrupt();\n+        }\n+        block_info.undo_data = &block_undo;\n+    }\n+    if (!m_index.CustomAppend(block_info)) {\n         FatalError(\"%s: Failed to write block %s to index\",\n                    __func__, pindex->GetBlockHash().ToString());\n-        return;\n-    } else {\n+        return m_index.Interrupt();\n+    }\n+    if (m_index.m_synced) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r810294690",
      "id" : 810294690,
      "in_reply_to_id" : 803678322,
      "line" : 155,
      "node_id" : "PRRC_kwDOABII584wTB2i",
      "original_commit_id" : "b8be01a7ef20672fd5faf4f6b82cf5d3fa2a717b",
      "original_line" : 155,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 289,
      "pull_request_review_id" : 887694486,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/810294690/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-18T19:45:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/810294690",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r810300757"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/810300757"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> Interesting, it does sound related. I would be curious to know if is fixed now. And maybe I could make this into a test. I'm curious if you made changes to somehow pause the sync to emulate a reorg happening at the same time?\r\n\r\nYes, I don't encounter this anymore now. What I did was manual testing on regtest (just adding a `std::this_thread::sleep_for` to `ThreadSync`, giving me the possibility to time my `invalidateblock`) - I don't know if it is possible to somehow make an automated test for this that is not racy.",
      "commit_id" : "72c29827f8adbc988be26c2002a8feedf9adc15a",
      "created_at" : "2022-02-18T19:54:28Z",
      "diff_hunk" : "@@ -125,6 +139,25 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n \n void BaseIndexNotifications::blockDisconnected(const interfaces::BlockInfo& block)\n {\n+    // During initial sync, ignore validation interface notifications, only\n+    // process notifications from sync thread.\n+    if (!m_index.m_synced && !block.chain_tip) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r810300757",
      "id" : 810300757,
      "in_reply_to_id" : 807384378,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584wTDVV",
      "original_commit_id" : "f56a851e11321ede9c5bcb43cd067c17f9efab39",
      "original_line" : 144,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 887702246,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/810300757/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-18T19:54:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/810300757",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r810328899"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/810328899"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ok. Current behavior in master (which should not be changed here) still does not make sense to me. I don't think it's wrong (though it could be wrong), I just mean it seems inconsistent and strange.\r\n",
      "commit_id" : "72c29827f8adbc988be26c2002a8feedf9adc15a",
      "created_at" : "2022-02-18T20:45:51Z",
      "diff_hunk" : "@@ -75,17 +76,28 @@ void BaseIndexNotifications::blockConnected(const interfaces::BlockInfo& block)\n     if (!block.data || m_index.IgnoreBlockConnected(block)) return;\n \n     const CBlockIndex* best_block_index = m_index.m_best_block_index.load();\n-    if (best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n+    if (block.chain_tip && best_block_index != pindex->pprev && !m_index.Rewind(best_block_index, pindex->pprev)) {\n         FatalError(\"%s: Failed to rewind index %s to a previous chain tip\",\n                    __func__, m_index.GetName());\n         return;\n     }\n \n-    if (!m_index.CustomAppend(block)) {\n+    interfaces::BlockInfo block_info = node::MakeBlockInfo(pindex, block.data);\n+    CBlockUndo block_undo;\n+    if (m_options.connect_undo_data && pindex->nHeight > 0) {\n+        if (!node::UndoReadFromDisk(block_undo, pindex)) {\n+            FatalError(\"%s: Failed to read block %s undo data from disk\",\n+                       __func__, pindex->GetBlockHash().ToString());\n+            return m_index.Interrupt();\n+        }\n+        block_info.undo_data = &block_undo;\n+    }\n+    if (!m_index.CustomAppend(block_info)) {\n         FatalError(\"%s: Failed to write block %s to index\",\n                    __func__, pindex->GetBlockHash().ToString());\n-        return;\n-    } else {\n+        return m_index.Interrupt();\n+    }\n+    if (m_index.m_synced) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r810328899",
      "id" : 810328899,
      "in_reply_to_id" : 803678322,
      "line" : 155,
      "node_id" : "PRRC_kwDOABII584wTKND",
      "original_commit_id" : "b8be01a7ef20672fd5faf4f6b82cf5d3fa2a717b",
      "original_line" : 155,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 289,
      "pull_request_review_id" : 887742060,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/810328899/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-18T20:45:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/810328899",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r811456743"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/811456743"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "fb164ac88e8e5f7b7bb448637a06da6ae299e578\r\nI think `getTip()` here and in `interfaces.cpp` could move to the next commit (\"Remove SyncWithValidationInterfaceQueue call\") where they are used.",
      "commit_id" : "72c29827f8adbc988be26c2002a8feedf9adc15a",
      "created_at" : "2022-02-21T22:23:30Z",
      "diff_hunk" : "@@ -134,6 +134,9 @@ class Chain\n     //! pruned), and contains transactions.\n     virtual bool haveBlockOnDisk(int height) = 0;\n \n+    //! Get tip information.\n+    virtual bool getTip(const FoundBlock& block={}) = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r811456743",
      "id" : 811456743,
      "line" : 138,
      "node_id" : "PRRC_kwDOABII584wXdjn",
      "original_commit_id" : "fb164ac88e8e5f7b7bb448637a06da6ae299e578",
      "original_line" : 138,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/interfaces/chain.h",
      "position" : 5,
      "pull_request_review_id" : 889137556,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/811456743/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-05T20:43:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/811456743",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r819115023"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/819115023"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "cec20142450117a40e64a77b8447e0f6294ec9e9: remove \"A\"",
      "commit_id" : "72c29827f8adbc988be26c2002a8feedf9adc15a",
      "created_at" : "2022-03-03T22:28:32Z",
      "diff_hunk" : "@@ -226,17 +226,17 @@ void BaseIndex::ThreadSync()\n     }\n }\n \n-bool BaseIndex::Commit()\n+bool BaseIndex::Commit(const CBlockLocator& locator)\n {\n     // Don't commit anything if we haven't indexed any block yet\n-    // (this could happen if init is interrupted).\n-    if (m_best_block_index == nullptr) {\n+    // (this could happen if init is interrupted).A",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r819115023",
      "id" : 819115023,
      "line" : 234,
      "node_id" : "PRRC_kwDOABII584w0rQP",
      "original_commit_id" : "cec20142450117a40e64a77b8447e0f6294ec9e9",
      "original_line" : 232,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 46,
      "pull_request_review_id" : 889137556,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/819115023/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-05T20:45:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/819115023",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r820139296"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/820139296"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "c1bdcdf3388792b7c17e576170167f0be883fa4a: The commit message (\"Move Commit and...\") doesn't describe what's being done here, maybe something like \"Move CustomInit out of Start and error handling code out of ThreadSync to notification handlers\"?",
      "commit_id" : "72c29827f8adbc988be26c2002a8feedf9adc15a",
      "created_at" : "2022-03-05T19:22:41Z",
      "diff_hunk" : "@@ -426,11 +442,8 @@ bool BaseIndex::Start()\n         LOCK(m_mutex);\n         m_notifications = std::move(notifications);\n         m_handler = std::move(handler);\n-    }\n-\n-    const CBlockIndex* index = m_best_block_index.load();\n-    if (!CustomInit(index ? std::make_optional(interfaces::BlockKey{index->GetBlockHash(), index->nHeight}) : std::nullopt)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r820139296",
      "id" : 820139296,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584w4lUg",
      "original_commit_id" : "c1bdcdf3388792b7c17e576170167f0be883fa4a",
      "original_line" : 432,
      "original_position" : 79,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 79,
      "pull_request_review_id" : 889137556,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/820139296/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-05T20:43:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/820139296",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r820141011"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/820141011"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "c1bdcdf3388792b7c17e576170167f0be883fa4a: why both an assert and a conditional? Or did you mean `m_init_result.value()` in the second line? Maybe also consider being explicit (`has_value()`) for the `std::optional<bool>` in the assert to avoid confusion.",
      "commit_id" : "72c29827f8adbc988be26c2002a8feedf9adc15a",
      "created_at" : "2022-03-05T19:40:29Z",
      "diff_hunk" : "@@ -426,11 +442,8 @@ bool BaseIndex::Start()\n         LOCK(m_mutex);\n         m_notifications = std::move(notifications);\n         m_handler = std::move(handler);\n-    }\n-\n-    const CBlockIndex* index = m_best_block_index.load();\n-    if (!CustomInit(index ? std::make_optional(interfaces::BlockKey{index->GetBlockHash(), index->nHeight}) : std::nullopt)) {\n-        return false;\n+        assert(m_notifications->m_init_result);\n+        if (!m_notifications->m_init_result) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r820141011",
      "id" : 820141011,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584w4lvT",
      "original_commit_id" : "c1bdcdf3388792b7c17e576170167f0be883fa4a",
      "original_line" : 446,
      "original_position" : 82,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 82,
      "pull_request_review_id" : 889137556,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/820141011/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-05T20:43:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/820141011",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-03-09T12:54:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1062892667",
      "id" : 1062892667,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII584_WnR7",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1062892667/reactions"
      },
      "updated_at" : "2022-03-09T12:54:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1062892667",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This pull seems related to areas I've been looking at, will review.",
      "created_at" : "2022-03-09T14:04:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1062953979",
      "id" : 1062953979,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII584_W2P7",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1062953979/reactions"
      },
      "updated_at" : "2022-03-09T14:04:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1062953979",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> I did some light testing for the final version, and one thing I noticed that the Index Sync now seems to block everything else and makes it impossible to abort gracefully: The wallet is not loaded (so that RPC calls are disabled), and also interrupting bitcoind with SIGINT would not work for me any more.\r\n\r\n@mzumsande I've been trying to reproduce this by modifying the syncchain method, but as far as I can tell, interrupt logic seems to be working as expected. Can you provide more specific steps to reproduce this? It also would help to see log output particularly near \"thread exit\" and \"Shutdown: In progress...\" lines.  If you can get gdb `thread apply all bt` output after sending SIGINT, that would provide a good picture, too.\r\n",
      "created_at" : "2022-03-11T03:59:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1064748312",
      "id" : 1064748312,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII584_dsUY",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1064748312/reactions"
      },
      "updated_at" : "2022-03-11T03:59:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1064748312",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r824373054"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/824373054"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r811456743\r\n\r\n> [fb164ac](https://github.com/bitcoin/bitcoin/commit/fb164ac88e8e5f7b7bb448637a06da6ae299e578) I think `getTip()` here and in `interfaces.cpp` could move to the next commit\r\n\r\nGood catch. Moved this.",
      "commit_id" : "4d387545bcc9ea7c158fd6278154c200c2cbec13",
      "created_at" : "2022-03-11T04:14:56Z",
      "diff_hunk" : "@@ -134,6 +134,9 @@ class Chain\n     //! pruned), and contains transactions.\n     virtual bool haveBlockOnDisk(int height) = 0;\n \n+    //! Get tip information.\n+    virtual bool getTip(const FoundBlock& block={}) = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r824373054",
      "id" : 824373054,
      "in_reply_to_id" : 811456743,
      "line" : 138,
      "node_id" : "PRRC_kwDOABII584xIu8-",
      "original_commit_id" : "fb164ac88e8e5f7b7bb448637a06da6ae299e578",
      "original_line" : 138,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/interfaces/chain.h",
      "position" : 64,
      "pull_request_review_id" : 906746169,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/824373054/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-11T04:57:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/824373054",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r824373325"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/824373325"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r819115023\r\n\r\n> cec20142450117a40e64a77b8447e0f6294ec9e9: remove \"A\"\r\n\r\nThanks, fixed this.",
      "commit_id" : "4d387545bcc9ea7c158fd6278154c200c2cbec13",
      "created_at" : "2022-03-11T04:15:46Z",
      "diff_hunk" : "@@ -226,17 +226,17 @@ void BaseIndex::ThreadSync()\n     }\n }\n \n-bool BaseIndex::Commit()\n+bool BaseIndex::Commit(const CBlockLocator& locator)\n {\n     // Don't commit anything if we haven't indexed any block yet\n-    // (this could happen if init is interrupted).\n-    if (m_best_block_index == nullptr) {\n+    // (this could happen if init is interrupted).A",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r824373325",
      "id" : 824373325,
      "in_reply_to_id" : 819115023,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584xIvBN",
      "original_commit_id" : "cec20142450117a40e64a77b8447e0f6294ec9e9",
      "original_line" : 232,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 906746169,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/824373325/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-11T04:57:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/824373325",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r824373760"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/824373760"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r820139296\r\n\r\n> [c1bdcdf](https://github.com/bitcoin/bitcoin/commit/c1bdcdf3388792b7c17e576170167f0be883fa4a): The commit message (\"Move Commit and...\") doesn't describe what's being done here, maybe something like \"Move CustomInit out of Start and error handling code out of ThreadSync to notification handlers\"?\r\n\r\nThanks, fixed this now.",
      "commit_id" : "4d387545bcc9ea7c158fd6278154c200c2cbec13",
      "created_at" : "2022-03-11T04:17:20Z",
      "diff_hunk" : "@@ -426,11 +442,8 @@ bool BaseIndex::Start()\n         LOCK(m_mutex);\n         m_notifications = std::move(notifications);\n         m_handler = std::move(handler);\n-    }\n-\n-    const CBlockIndex* index = m_best_block_index.load();\n-    if (!CustomInit(index ? std::make_optional(interfaces::BlockKey{index->GetBlockHash(), index->nHeight}) : std::nullopt)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r824373760",
      "id" : 824373760,
      "in_reply_to_id" : 820139296,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584xIvIA",
      "original_commit_id" : "c1bdcdf3388792b7c17e576170167f0be883fa4a",
      "original_line" : 432,
      "original_position" : 79,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 906746169,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/824373760/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-11T04:57:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/824373760",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r824373902"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/824373902"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/24230#discussion_r820141011\r\n\r\n> c1bdcdf3388792b7c17e576170167f0be883fa4a: why both an assert and a conditional? Or did you mean `m_init_result.value()` in the second line? Maybe also consider being explicit (`has_value()`) for the `std::optional<bool>` in the assert to avoid confusion.\r\n\r\nGood catch. I was intending to use * operator, but I followed your suggestion instead since that seems more readable.\r\n\r\nNote: bug here was wasn't actually present in the full PR. Bug was temporarily introduced here in commit c1bdcdf3388792b7c17e576170167f0be883fa4a, but fixed by later commit fb164ac88e8e5f7b7bb448637a06da6ae299e578",
      "commit_id" : "4d387545bcc9ea7c158fd6278154c200c2cbec13",
      "created_at" : "2022-03-11T04:17:45Z",
      "diff_hunk" : "@@ -426,11 +442,8 @@ bool BaseIndex::Start()\n         LOCK(m_mutex);\n         m_notifications = std::move(notifications);\n         m_handler = std::move(handler);\n-    }\n-\n-    const CBlockIndex* index = m_best_block_index.load();\n-    if (!CustomInit(index ? std::make_optional(interfaces::BlockKey{index->GetBlockHash(), index->nHeight}) : std::nullopt)) {\n-        return false;\n+        assert(m_notifications->m_init_result);\n+        if (!m_notifications->m_init_result) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#discussion_r824373902",
      "id" : 824373902,
      "in_reply_to_id" : 820141011,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584xIvKO",
      "original_commit_id" : "c1bdcdf3388792b7c17e576170167f0be883fa4a",
      "original_line" : 446,
      "original_position" : 82,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 906746169,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24230",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/824373902/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-11T04:57:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/824373902",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Updated 4d387545bcc9ea7c158fd6278154c200c2cbec13 -> 016304173ef6864e3c2f1104bd5ffe7595721ca6 ([`pr/indexy.11`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.11) -> [`pr/indexy.12`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.12), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/indexy.11..pr/indexy.12)) with lock fix for tsan error https://cirrus-ci.com/task/6456107408293888, and link fix for bitcoin-chainstate error https://cirrus-ci.com/task/4538559129452544\r\n",
      "created_at" : "2022-03-11T07:00:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1064830434",
      "id" : 1064830434,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII584_eAXi",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1064830434/reactions"
      },
      "updated_at" : "2022-03-11T07:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1064830434",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> @mzumsande I've been trying to reproduce this by modifying the syncchain method, but as far as I can tell, interrupt logic seems to be working as expected. Can you provide more specific steps to reproduce this? It also would help to see log output particularly near \"thread exit\" and \"Shutdown: In progress...\" lines. If you can get gdb `thread apply all bt` output after sending SIGINT, that would provide a good picture, too.\r\n\r\nI tried to reproduce this again, but couldn't anymore. I must have made some error during my tests the last time.\r\nI again tried to interrupt the index sync with SIGINT, SIGKILL and invalidateblock during sync, and everything worked fine. Sorry for the noise.",
      "created_at" : "2022-03-11T17:04:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1065308102",
      "id" : 1065308102,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII584_f0_G",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1065308102/reactions"
      },
      "updated_at" : "2022-03-11T17:04:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1065308102",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Sorry for the noise.\r\n\r\nNo, thank you for testing! This was a good exercise for me to try to reproduce. I could see there is a real underlying issue because index sync threads can be greedy in their use of cs_main, and because index sync threads start before wallets are loaded, and wallet loading does not seem to be interruptible, Ctrl-C could become less usable if wallets take longer to load.\r\n\r\nThis PR should be improving the issue, not making it worse, because it is locking cs_main strictly less than previously during index sync. But thread scheduling is not always straightforward, and it's possible even releasing a lock could lead to worse latency, so this is something good to look out for and test.",
      "created_at" : "2022-03-11T17:31:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1065330061",
      "id" : 1065330061,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII584_f6WN",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1065330061/reactions"
      },
      "updated_at" : "2022-03-11T17:31:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1065330061",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Aa^",
      "created_at" : "2022-03-13T23:28:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1066206744",
      "id" : 1066206744,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII584_jQYY",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1066206744/reactions"
      },
      "updated_at" : "2022-03-13T23:28:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1066206744",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/99647687?v=4",
         "events_url" : "https://api.github.com/users/maxim85200/events{/privacy}",
         "followers_url" : "https://api.github.com/users/maxim85200/followers",
         "following_url" : "https://api.github.com/users/maxim85200/following{/other_user}",
         "gists_url" : "https://api.github.com/users/maxim85200/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/maxim85200",
         "id" : 99647687,
         "login" : "maxim85200",
         "node_id" : "U_kgDOBfCAxw",
         "organizations_url" : "https://api.github.com/users/maxim85200/orgs",
         "received_events_url" : "https://api.github.com/users/maxim85200/received_events",
         "repos_url" : "https://api.github.com/users/maxim85200/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/maxim85200/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/maxim85200/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/maxim85200"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-03-17T07:37:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1070452186",
      "id" : 1070452186,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII584_zc3a",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1070452186/reactions"
      },
      "updated_at" : "2022-03-17T07:37:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1070452186",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased 016304173ef6864e3c2f1104bd5ffe7595721ca6 -> 23d07effca30157779d7d9d324f1ee1a41324e07 ([`pr/indexy.12`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.12) -> [`pr/indexy.13`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.13), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/indexy.12-rebase..pr/indexy.13)) due to conflict with #24515",
      "created_at" : "2022-03-18T13:08:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1072393295",
      "id" : 1072393295,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII584_62xP",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1072393295/reactions"
      },
      "updated_at" : "2022-03-18T13:08:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1072393295",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Updated 23d07effca30157779d7d9d324f1ee1a41324e07 -> d14e89f701b224977bef3ccde233d86271f7ed9b ([`pr/indexy.13`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.13) -> [`pr\r\n/indexy.14`](https://github.com/ryanofsky/bitcoin/commits/pr/indexy.14), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/indexy.13..pr/indexy.14)) to fix tsan race in coinstatsindex_unclean_shutdown test https://cirrus-ci.com/task/5516517512052736?logs=ci#L4877, and probably (couldn't reproduce these) fix msan and centos segfaults in the same test https://cirrus-ci.com/task/6642417418895360?logs=ci and https://cirrus-ci.com/task/4953567558631424?logs=ci\r\n",
      "created_at" : "2022-03-18T19:16:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1072729670",
      "id" : 1072729670,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII584_8I5G",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1072729670/reactions"
      },
      "updated_at" : "2022-03-18T19:16:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1072729670",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-04-25T19:23:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24230#issuecomment-1108950745",
      "id" : 1108950745,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24230",
      "node_id" : "IC_kwDOABII585CGT7Z",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1108950745/reactions"
      },
      "updated_at" : "2022-04-25T19:23:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1108950745",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   }
]
