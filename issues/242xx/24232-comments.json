[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#24676](https://github.com/bitcoin/bitcoin/pull/24676) ([WIP] [kernelheaders 1/n] Cleave LevelDB headers from our header tree by dongcarl)\n* [#24595](https://github.com/bitcoin/bitcoin/pull/24595) (deploymentstatus: move g_versionbitscache global to ChainstateManager by ajtowns)\n* [#24456](https://github.com/bitcoin/bitcoin/pull/24456) (blockman: Properly guard blockfile members by dongcarl)\n* [#24008](https://github.com/bitcoin/bitcoin/pull/24008) (assumeutxo: net_processing changes by jamesob)\n* [#22564](https://github.com/bitcoin/bitcoin/pull/22564) (refactor: Move mutable globals cleared in `::UnloadBlockIndex` to `BlockManager` by dongcarl)\n* [#20030](https://github.com/bitcoin/bitcoin/pull/20030) (validation: Remove useless call to mempool->clear() by MarcoFalke)\n* [#19888](https://github.com/bitcoin/bitcoin/pull/19888) (rpc, test: Improve getblockstats for unspendables by fjahr)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-02-02T03:54:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#issuecomment-1027550061",
      "id" : 1027550061,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24232",
      "node_id" : "IC_kwDOABII5849Pytt",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1027550061/reactions"
      },
      "updated_at" : "2022-03-29T20:57:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1027550061",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r797299227"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/797299227"
         }
      },
      "author_association" : "MEMBER",
      "body" : "any reason this is a reference. `memepool` at the call site is already a pointer to allow setting it to nullptr",
      "commit_id" : "08f4bf18b165464dea801b81cf857a9fd398e8e7",
      "created_at" : "2022-02-02T06:09:26Z",
      "diff_hunk" : "@@ -977,12 +1014,27 @@ class ChainstateManager\n     void Unload() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n     //! Clear (deconstruct) chainstate data.\n-    void Reset();\n+    void Reset() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n     //! Check to see if caches are out of balance and if so, call\n     //! ResizeCoinsCaches() as needed.\n     void MaybeRebalanceCaches() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! When starting up, search the datadir for a chainstate based on a UTXO\n+    //! snapshot that is in the process of being validated.\n+    bool DetectSnapshotChainstate(CTxMemPool& mempool) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r797299227",
      "id" : 797299227,
      "line" : 1025,
      "node_id" : "PRRC_kwDOABII584vhdIb",
      "original_commit_id" : "08f4bf18b165464dea801b81cf857a9fd398e8e7",
      "original_line" : 1025,
      "original_position" : 119,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 119,
      "pull_request_review_id" : 870119022,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/797299227/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-02T06:12:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/797299227",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r797299587"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/797299587"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Any reason this is a pointer? This can't be null, neither at the call site nor inside the function.",
      "commit_id" : "08f4bf18b165464dea801b81cf857a9fd398e8e7",
      "created_at" : "2022-02-02T06:10:27Z",
      "diff_hunk" : "@@ -977,12 +1014,27 @@ class ChainstateManager\n     void Unload() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n     //! Clear (deconstruct) chainstate data.\n-    void Reset();\n+    void Reset() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n     //! Check to see if caches are out of balance and if so, call\n     //! ResizeCoinsCaches() as needed.\n     void MaybeRebalanceCaches() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! When starting up, search the datadir for a chainstate based on a UTXO\n+    //! snapshot that is in the process of being validated.\n+    bool DetectSnapshotChainstate(CTxMemPool& mempool) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+\n+    //! If we completed background validation of the loaded snapshot during the\n+    //! last run but didn't for whatever reason shutdown properly, ensure that\n+    //! the background validation chainstate is marked accordingly.\n+    void CheckForUncleanShutdown() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+\n+    //! Complete validation of the active snapshot if `chainstate` is in the process of\n+    //! background validating and has reached the base block of the snapshot.\n+    bool MaybeCompleteSnapshotValidation(\n+        CChainState& chainstate,\n+        CBlockIndex* pindexNew) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r797299587",
      "id" : 797299587,
      "line" : 1036,
      "node_id" : "PRRC_kwDOABII584vhdOD",
      "original_commit_id" : "08f4bf18b165464dea801b81cf857a9fd398e8e7",
      "original_line" : 1036,
      "original_position" : 130,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 130,
      "pull_request_review_id" : 870119022,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/797299587/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-02T06:12:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/797299587",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r797299792"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/797299792"
         }
      },
      "author_association" : "MEMBER",
      "body" : "any reason to add the assert?",
      "commit_id" : "08f4bf18b165464dea801b81cf857a9fd398e8e7",
      "created_at" : "2022-02-02T06:11:10Z",
      "diff_hunk" : "@@ -28,10 +28,19 @@ std::optional<ChainstateLoadingError> LoadChainstate(bool fReset,\n     };\n \n     LOCK(cs_main);\n-    chainman.InitializeChainstate(mempool);\n     chainman.m_total_coinstip_cache = nCoinCacheUsage;\n     chainman.m_total_coinsdb_cache = nCoinDBCache;\n \n+    // Load a chain created from a UTXO snapshot, if any exist.\n+    chainman.DetectSnapshotChainstate(*Assert(mempool));\n+\n+    // If we're not using a snapshot or we haven't fully validated it yet,\n+    // create a validation chainstate.\n+    if (!chainman.IsSnapshotValidated()) {\n+        LogPrintf(\"Loading validation chainstate\\n\");\n+        chainman.InitializeChainstate(Assert(mempool));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r797299792",
      "id" : 797299792,
      "line" : 41,
      "node_id" : "PRRC_kwDOABII584vhdRQ",
      "original_commit_id" : "08f4bf18b165464dea801b81cf857a9fd398e8e7",
      "original_line" : 41,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : 15,
      "pull_request_review_id" : 870119022,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/797299792/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-02T06:12:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/797299792",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the quick feedback Mco. \r\n\r\nThe test failure was actually due to removing a commit that I'd forgotten the use for. Basically, because we're now calling MaybeRebalanceCaches in LoadChainstate, that prompts a FlushStateToDisk call before the block index is loaded, which trips some UB. \r\n\r\nThe bounds check in https://github.com/bitcoin/bitcoin/pull/24232/commits/d70b8de51e54061e9ef045366f4a7651678dd82a fixes this.",
      "created_at" : "2022-02-02T15:15:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#issuecomment-1028043521",
      "id" : 1028043521,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24232",
      "node_id" : "IC_kwDOABII5849RrMB",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1028043521/reactions"
      },
      "updated_at" : "2022-02-02T15:15:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1028043521",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r798657298"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/798657298"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Should probably de-activate the existing snapshot chainstate as in the `if (snapshot_invalid)` conditional.",
      "commit_id" : "7e2b212f9448a9b57df173a161686e33ac4c7d4e",
      "created_at" : "2022-02-03T15:04:45Z",
      "diff_hunk" : "@@ -4982,6 +4991,91 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+bool ChainstateManager::completeSnapshotValidation(CChainState& validation_chainstate)\n+{\n+    AssertLockHeld(cs_main);\n+    assert(&validation_chainstate == m_ibd_chainstate.get());\n+\n+    CCoinsViewDB& ibd_coins_db = validation_chainstate.CoinsDB();\n+    validation_chainstate.ForceFlushStateToDisk();\n+\n+    CCoinsStats ibd_stats{CoinStatsHashType::HASH_SERIALIZED};\n+    auto breakpoint_fnc = [] { /* TODO insert breakpoint here? */ };\n+\n+    if (!GetUTXOStats(&ibd_coins_db, WITH_LOCK(::cs_main, return std::ref(m_blockman)), ibd_stats, breakpoint_fnc)) {\n+        LogPrintf(\"[snapshot] failed to generate stats for validation coins db\\n\");\n+        return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r798657298",
      "id" : 798657298,
      "line" : 5007,
      "node_id" : "PRRC_kwDOABII584vmosS",
      "original_commit_id" : "7e2b212f9448a9b57df173a161686e33ac4c7d4e",
      "original_line" : 5007,
      "original_position" : 75,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 75,
      "pull_request_review_id" : 871973254,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/798657298/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-03T15:04:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/798657298",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r798657488"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/798657488"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Same as above. These failure modes also need tests.",
      "commit_id" : "9f89221913d8230b62cc3959fbb5ab4d220d91f6",
      "created_at" : "2022-02-03T15:04:55Z",
      "diff_hunk" : "@@ -4982,6 +4991,91 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+bool ChainstateManager::completeSnapshotValidation(CChainState& validation_chainstate)\n+{\n+    AssertLockHeld(cs_main);\n+    assert(&validation_chainstate == m_ibd_chainstate.get());\n+\n+    CCoinsViewDB& ibd_coins_db = validation_chainstate.CoinsDB();\n+    validation_chainstate.ForceFlushStateToDisk();\n+\n+    CCoinsStats ibd_stats{CoinStatsHashType::HASH_SERIALIZED};\n+    auto breakpoint_fnc = [] { /* TODO insert breakpoint here? */ };\n+\n+    if (!GetUTXOStats(&ibd_coins_db, WITH_LOCK(::cs_main, return std::ref(m_blockman)), ibd_stats, breakpoint_fnc)) {\n+        LogPrintf(\"[snapshot] failed to generate stats for validation coins db\\n\");\n+        return false;\n+    }\n+\n+    auto snapshot_blockhash = SnapshotBlockhash().value_or(uint256());\n+\n+    LogPrintf(\"[snapshot] tip: actual=%s expected=%s\\n\",\n+        validation_chainstate.m_chain.Tip()->ToString(),\n+        snapshot_blockhash.ToString());\n+\n+    uint256 expected_contents_hash;\n+    int curr_height = validation_chainstate.m_chain.Height();\n+\n+    bool snapshot_invalid{false};\n+    auto maybe_au_data = ExpectedAssumeutxo(curr_height, ::Params());\n+\n+    if (!maybe_au_data) {\n+        LogPrintf(\"[snapshot] assumeutxo data not found for height \" /* Continued */\n+            \"(%d) - refusing to validate snapshot\\n\", curr_height);\n+        return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r798657488",
      "id" : 798657488,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584vmovQ",
      "original_commit_id" : "7e2b212f9448a9b57df173a161686e33ac4c7d4e",
      "original_line" : 5025,
      "original_position" : 93,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 871973518,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/798657488/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-03T19:03:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/798657488",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r798664573"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/798664573"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We should either deactivate the snapshot chainstate or shutdown.",
      "commit_id" : "9f89221913d8230b62cc3959fbb5ab4d220d91f6",
      "created_at" : "2022-02-03T15:11:38Z",
      "diff_hunk" : "@@ -5045,3 +5167,148 @@ void ChainstateManager::MaybeRebalanceCaches()\n         }\n     }\n }\n+\n+constexpr int SNAPSHOT_NAME_LEN = 75; // \"chainstate_\" + 64 hex characters for blockhash.\n+\n+static bool IsPathSnapshotDatadir(const fs::path& datadir_path)\n+{\n+    return datadir_path.filename().string().length() == SNAPSHOT_NAME_LEN &&\n+        datadir_path.filename().string().substr(0,11) == \"chainstate_\";\n+}\n+\n+static uint256 PathToSnapshotHash(const fs::path& datadir_path)\n+{\n+    assert(IsPathSnapshotDatadir(datadir_path));\n+    return uint256S(datadir_path.filename().string().substr(11));\n+}\n+\n+static std::optional<fs::path> FindSnapshotChainstateDatadir()\n+{\n+    fs::path found;\n+\n+    for (fs::directory_iterator it(gArgs.GetDataDirNet()); it != fs::directory_iterator(); it++) {\n+        if (fs::is_directory(*it) && !fs::is_empty(*it) && IsPathSnapshotDatadir(it->path()))\n+        {\n+            if (found.empty()) {\n+                found = it->path();\n+                LogPrintf(\"[snapshot] found snapshot datadir %s\\n\", fs::PathToString(found));\n+            } else {\n+                LogPrintf(\"[snapshot] WARNING - detected multiple snapshot \" /* Continued */\n+                    \"datadirs (%s). This is not expected.\\n\", fs::PathToString(it->path()));\n+            }\n+        }\n+    }\n+    return found.empty() ? std::nullopt : std::make_optional(found);\n+}\n+\n+bool ChainstateManager::DetectSnapshotChainstate(CTxMemPool* mempool)\n+{\n+    std::optional<fs::path> path = FindSnapshotChainstateDatadir();\n+    if (!path) {\n+        return false;\n+    }\n+    LogPrintf(\"[snapshot] detected active snapshot chainstate (%s) - loading\\n\",\n+        fs::PathToString(*path));\n+    this->InitializeChainstate(mempool, /*snapshot_blockhash*/ PathToSnapshotHash(*path));\n+    return true;\n+}\n+\n+bool CChainState::teardownSnapshotDatadir()\n+{\n+    if (!m_from_snapshot_blockhash) {\n+        // Chainstate isn't based on a snapshot.\n+        return false;\n+    }\n+    std::optional<fs::path> snapshot_datadir = FindSnapshotChainstateDatadir();\n+\n+    if (!snapshot_datadir) {\n+        return false;\n+    }\n+\n+    uint256 datadir_hash = PathToSnapshotHash(*snapshot_datadir);\n+\n+    if (datadir_hash != *m_from_snapshot_blockhash) {\n+        LogPrintf(\"[snapshot] WARNING - unexpected blockhash for snapshot datadir (%s); expected %s\\n\",\n+            datadir_hash.ToString(), m_from_snapshot_blockhash->ToString());\n+        return false;\n+    }\n+\n+    LogPrintf(\"[snapshot] tearing down snapshot datadir %s\\n\", fs::PathToString(*snapshot_datadir));\n+    assert(fs::remove_all(*snapshot_datadir) > 0);\n+    return true;\n+}\n+\n+CBlockIndex* ChainstateManager::getSnapshotBaseBlock()\n+{\n+    auto blockhash_op = SnapshotBlockhash();\n+    if (!blockhash_op) return nullptr;\n+    return m_blockman.LookupBlockIndex(*blockhash_op);\n+}\n+\n+std::optional<int> ChainstateManager::getSnapshotHeight()\n+{\n+    CBlockIndex* base = getSnapshotBaseBlock();\n+    return base ? std::make_optional(base->nHeight) : std::nullopt;\n+}\n+\n+void ChainstateManager::validatedSnapshotShutdownCleanup(\n+    fs::path new_chainstate, fs::path old_chainstate)\n+{\n+    assert(fs::exists(new_chainstate));\n+    assert(fs::exists(old_chainstate));\n+\n+    LogPrintf(\"[snapshot] deleting background chainstate directory (now unnecessary) (%s)\\n\",\n+        fs::PathToString(old_chainstate));\n+\n+    // Instead of deleting the background chainstate directly, rename the old\n+    // chainstate to chainstate_bak, rename the new chainstate into place, and then\n+    // delete to avoid likelihood of corruption from mid-delete shutdown.\n+    fs::path tmp_old{old_chainstate};\n+    tmp_old += \"_bak\";\n+\n+    fs::rename(old_chainstate, tmp_old);\n+    fs::rename(new_chainstate, old_chainstate);\n+\n+    LogPrintf(\"[snapshot] moving snapshot chainstate (%s) to \" /* Continued */\n+        \"default chainstate directory (%s)\\n\",\n+        fs::PathToString(new_chainstate), fs::PathToString(old_chainstate));\n+\n+    assert(fs::remove_all(tmp_old) > 0);\n+    LogPrintf(\"[snapshot] deleted background chainstate directory (%s)\\n\",\n+        fs::PathToString(old_chainstate));\n+}\n+\n+void ChainstateManager::checkForUncleanShutdown()\n+{\n+    if (!(m_snapshot_chainstate && m_ibd_chainstate)) {\n+        return;\n+    }\n+    if (m_ibd_chainstate->m_chain.Height() != getSnapshotHeight()) {\n+        return;\n+    }\n+    LogPrintf(\"[snapshot] unclean shutdown detected - background validation chain needs to \" /* Continued */\n+        \"be checked against the loaded snapshot and cleaned up.\\n\");\n+    completeSnapshotValidation(*m_ibd_chainstate.get());\n+}\n+\n+bool ChainstateManager::maybeCompleteSnapshotValidation(\n+    CChainState& chainstate,\n+    CBlockIndex& pindexNew)\n+{\n+    int snapshot_height = getSnapshotHeight().value_or(-1);\n+\n+    // If this is the chainstate that's validating in the background, check to see if it's\n+    // time we compare the UTXO set hash to the base of our active snapshot.\n+    if (&chainstate != &this->ActiveChainstate()) {\n+        if (pindexNew.nHeight > getSnapshotHeight()) {\n+            // TODO jamesob: better handling?\n+            LogPrintf(\"[snapshot] something is wrong! validation chain \" /* Continued */\n+                \"should not have continued past the snapshot origin\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r798664573",
      "id" : 798664573,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584vmqd9",
      "original_commit_id" : "7e2b212f9448a9b57df173a161686e33ac4c7d4e",
      "original_line" : 5306,
      "original_position" : 349,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 871973518,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/798664573/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-03T19:03:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/798664573",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Okay, I've pushed a revision that addresses my previous comments and more comprehensively (that is to say: at all) tests the major failure modes. I had to parameterize the shutdown behavior during snapshot completion to get this to work within the unittests.\r\n\r\nPending CI pass, this should be ready for continued review. ",
      "created_at" : "2022-02-08T01:01:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#issuecomment-1032104129",
      "id" : 1032104129,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24232",
      "node_id" : "IC_kwDOABII5849hKjB",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1032104129/reactions"
      },
      "updated_at" : "2022-02-08T01:01:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1032104129",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Alright, CI is finally passing. I had to add https://github.com/bitcoin/bitcoin/pull/24232/commits/5d5dfaa7a647307f58acdd1909fc8f34c1787f82 because an existing unittest that advanced an IBD chain past the snapshot it generated started failing. This isn't something that should happen in practice, but was done to test an unrelated feature (`UpdateTip` behavior on a background chainstate).\r\n\r\n",
      "created_at" : "2022-02-08T23:36:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#issuecomment-1033170229",
      "id" : 1033170229,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24232",
      "node_id" : "IC_kwDOABII5849lO01",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1033170229/reactions"
      },
      "updated_at" : "2022-02-08T23:36:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1033170229",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-02-17T07:38:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#issuecomment-1042656098",
      "id" : 1042656098,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24232",
      "node_id" : "IC_kwDOABII584-Jati",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1042656098/reactions"
      },
      "updated_at" : "2022-02-17T07:38:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1042656098",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r820651995"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/820651995"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Looks like #24299 was merged, so you might have to inline the needed resets here (or create a helper function for it).",
      "commit_id" : "9f89221913d8230b62cc3959fbb5ab4d220d91f6",
      "created_at" : "2022-03-07T12:20:10Z",
      "diff_hunk" : "@@ -48,6 +60,33 @@ CreateAndActivateUTXOSnapshot(node::NodeContext& node, const fs::path root, F ma\n \n     malleation(auto_infile, metadata);\n \n+    if (reset_chainstate) {\n+        {\n+            // What follows is a hack to selectively reset chainstate data without\n+            // disturbing the existing BlockManager instance, which is needed to\n+            // recognize the headers chain previously generated by the chainstate we're\n+            // removing. Without those headers, we can't activate the snapshot below.\n+            LOCK(::cs_main);\n+            uint256 gen_hash = node.chainman->ActiveChainstate().m_chain[0]->GetBlockHash();\n+            node.chainman->Reset();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r820651995",
      "id" : 820651995,
      "line" : 71,
      "node_id" : "PRRC_kwDOABII584w6ifb",
      "original_commit_id" : "9f89221913d8230b62cc3959fbb5ab4d220d91f6",
      "original_line" : 71,
      "original_position" : 48,
      "original_start_line" : null,
      "path" : "src/test/util/chainstate.h",
      "position" : 48,
      "pull_request_review_id" : 901614980,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/820651995/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-07T12:20:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/820651995",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Alright, have rebased; basically I just took the old `ChainstateManager::Reset()` method and renamed it to `cleanup()`, and applied @jonatack -style changes (lock assertion/annotation vs. LOCK). ",
      "created_at" : "2022-03-07T17:00:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#issuecomment-1060910677",
      "id" : 1060910677,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24232",
      "node_id" : "IC_kwDOABII584_PDZV",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1060910677/reactions"
      },
      "updated_at" : "2022-03-07T17:00:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1060910677",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Planning to review soon.",
      "created_at" : "2022-03-10T19:02:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#issuecomment-1064393819",
      "id" : 1064393819,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24232",
      "node_id" : "IC_kwDOABII584_cVxb",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1064393819/reactions"
      },
      "updated_at" : "2022-03-10T19:02:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1064393819",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r832762880"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/832762880"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"init: add utxo snapshot detection\" (becdbd6da4c6d7c9c658ffc38b1c9da1c89571a1)\r\n\r\nLog message seems vague about what the result of this warning is. I think it would be clearer if log message said the directory would be ignored like \"[snapshot] WARNING: Multiple snapshot directories were not expected. Ignoring unexpected snapshot directory {it->path}.\"\r\n\r\nAlso, as long as the code is not capable of handling multiple snapshots it seems like a better design for this might just be to call the directory `<datadir>/chainstate_snapshot` instead of `<datadir>/chainstate_{blockhash}` so there would be no ambiguity. Blockhash could be dumped to a `<datadir>/chainstate_snapshot/block` text file, if the idea is that it should be human readable (or maybe a `chainstate_snapshot/snapshot.json` file to be more fancy.) \r\n\r\nIn any case, I don't know what happens to the ignored snapshot directories after the background download completes? Will it it finish validating one snapshot and then go onto validate the next snapshot next time bitcoind is restarted?",
      "commit_id" : "51d0dd34ecfb42d80707ec6cf788f0e63e30439f",
      "created_at" : "2022-03-23T01:37:51Z",
      "diff_hunk" : "@@ -5082,3 +5083,48 @@ void ChainstateManager::MaybeRebalanceCaches()\n         }\n     }\n }\n+\n+constexpr int SNAPSHOT_NAME_LEN = 75; // \"chainstate_\" + 64 hex characters for blockhash.\n+\n+static bool IsPathSnapshotDatadir(const fs::path& datadir_path)\n+{\n+    return fs::PathToString(datadir_path.filename()).length() == SNAPSHOT_NAME_LEN &&\n+        fs::PathToString(datadir_path.filename()).substr(0,11) == \"chainstate_\";\n+}\n+\n+static uint256 PathToSnapshotHash(const fs::path& datadir_path)\n+{\n+    assert(IsPathSnapshotDatadir(datadir_path));\n+    return uint256S(fs::PathToString(datadir_path.filename()).substr(11));\n+}\n+\n+static std::optional<fs::path> FindSnapshotChainstateDatadir()\n+{\n+    fs::path found;\n+\n+    for (fs::directory_iterator it(gArgs.GetDataDirNet()); it != fs::directory_iterator(); it++) {\n+        if (fs::is_directory(*it) && !fs::is_empty(*it) && IsPathSnapshotDatadir(it->path()))\n+        {\n+            if (found.empty()) {\n+                found = it->path();\n+                LogPrintf(\"[snapshot] found snapshot datadir %s\\n\", fs::PathToString(found));\n+            } else {\n+                LogPrintf(\"[snapshot] WARNING - detected multiple snapshot \" /* Continued */\n+                    \"datadirs (%s). This is not expected.\\n\", fs::PathToString(it->path()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r832762880",
      "id" : 832762880,
      "line" : 5270,
      "node_id" : "PRRC_kwDOABII584xovQA",
      "original_commit_id" : "becdbd6da4c6d7c9c658ffc38b1c9da1c89571a1",
      "original_line" : 5113,
      "original_position" : 39,
      "original_start_line" : 5112,
      "path" : "src/validation.cpp",
      "position" : 39,
      "pull_request_review_id" : 918071823,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/832762880/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 5269,
      "start_side" : "RIGHT",
      "updated_at" : "2022-03-23T03:22:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/832762880",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r832772895"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/832772895"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: tear down snapshot datadirs upon validation failure\" (fe09582ec34ff4d19bb2aa490ffd6ccca95e8480)\r\n\r\nTwo issues this line:\r\n\r\n- Should not put code intended to produce side effects in an assert because it will be skipped if asserts are disabled. I know the bitcoin project does not \"support\" building with asserts disabled, but I don't think it should go out of its way to be broken either. Also, people who used to reading conventional c++ code may skim past asserts not expecting to see real behavior hidden inside them. Would suggest `if (remove_all() <= 0) { LogPrint(\"Warning failed to remove {snapshot}\"); } ` since this is handling an error condition inside an error condition, and asserts should be used to check code correctness, not handle i/o errors anyway.\r\n\r\n- IMO, it is usually not appropriate to call `removal_all` in production code. One stray `mv` or mount `bind command` combined with this could result in deleting data that doesn't belong to us, and potentially very large data losses. Would be safer to use `leveldb::DestroyDB` on the database and `fs::remove` calls individually on any of our own files or directories.\r\n",
      "commit_id" : "51d0dd34ecfb42d80707ec6cf788f0e63e30439f",
      "created_at" : "2022-03-23T02:02:10Z",
      "diff_hunk" : "@@ -5128,3 +5130,28 @@ bool ChainstateManager::DetectSnapshotChainstate(CTxMemPool* mempool)\n     this->InitializeChainstate(mempool, /*snapshot_blockhash*/ PathToSnapshotHash(*path));\n     return true;\n }\n+\n+bool CChainState::TeardownSnapshotDatadir()\n+{\n+    if (!m_from_snapshot_blockhash) {\n+        // Chainstate isn't based on a snapshot.\n+        return false;\n+    }\n+    std::optional<fs::path> snapshot_datadir = FindSnapshotChainstateDatadir();\n+\n+    if (!snapshot_datadir) {\n+        return false;\n+    }\n+\n+    uint256 datadir_hash = PathToSnapshotHash(*snapshot_datadir);\n+\n+    if (datadir_hash != *m_from_snapshot_blockhash) {\n+        LogPrintf(\"[snapshot] WARNING - unexpected blockhash for snapshot datadir (%s); expected %s\\n\",\n+            datadir_hash.ToString(), m_from_snapshot_blockhash->ToString());\n+        return false;\n+    }\n+\n+    LogPrintf(\"[snapshot] tearing down snapshot datadir %s\\n\", fs::PathToString(*snapshot_datadir));\n+    assert(fs::remove_all(*snapshot_datadir) > 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r832772895",
      "id" : 832772895,
      "line" : 5310,
      "node_id" : "PRRC_kwDOABII584xoxsf",
      "original_commit_id" : "fe09582ec34ff4d19bb2aa490ffd6ccca95e8480",
      "original_line" : 5155,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 37,
      "pull_request_review_id" : 918071823,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/832772895/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-23T03:22:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/832772895",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r832775376"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/832775376"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: tear down snapshot datadirs upon validation failure\" (fe09582ec34ff4d19bb2aa490ffd6ccca95e8480)\r\n\r\nHere and other places, may be better to replace \"tear down\" with \"remove\". I'm not exactly sure what tearing down implies, but it sounds different than removing.",
      "commit_id" : "51d0dd34ecfb42d80707ec6cf788f0e63e30439f",
      "created_at" : "2022-03-23T02:08:18Z",
      "diff_hunk" : "@@ -5128,3 +5130,28 @@ bool ChainstateManager::DetectSnapshotChainstate(CTxMemPool* mempool)\n     this->InitializeChainstate(mempool, /*snapshot_blockhash*/ PathToSnapshotHash(*path));\n     return true;\n }\n+\n+bool CChainState::TeardownSnapshotDatadir()\n+{\n+    if (!m_from_snapshot_blockhash) {\n+        // Chainstate isn't based on a snapshot.\n+        return false;\n+    }\n+    std::optional<fs::path> snapshot_datadir = FindSnapshotChainstateDatadir();\n+\n+    if (!snapshot_datadir) {\n+        return false;\n+    }\n+\n+    uint256 datadir_hash = PathToSnapshotHash(*snapshot_datadir);\n+\n+    if (datadir_hash != *m_from_snapshot_blockhash) {\n+        LogPrintf(\"[snapshot] WARNING - unexpected blockhash for snapshot datadir (%s); expected %s\\n\",\n+            datadir_hash.ToString(), m_from_snapshot_blockhash->ToString());\n+        return false;\n+    }\n+\n+    LogPrintf(\"[snapshot] tearing down snapshot datadir %s\\n\", fs::PathToString(*snapshot_datadir));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r832775376",
      "id" : 832775376,
      "line" : 5309,
      "node_id" : "PRRC_kwDOABII584xoyTQ",
      "original_commit_id" : "fe09582ec34ff4d19bb2aa490ffd6ccca95e8480",
      "original_line" : 5154,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 36,
      "pull_request_review_id" : 918071823,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/832775376/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-23T03:22:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/832775376",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r832792541"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/832792541"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: tear down snapshot datadirs upon validation failure\" (fe09582ec34ff4d19bb2aa490ffd6ccca95e8480)\r\n\r\nReturn value is not checked here. It seems like right now this could say:\r\n\r\n```c++\r\nbool removed = snapshot_chainstate->TeardownSnapshotDatadir();\r\nassert(removed);\r\n```\r\n\r\nsince logically it should be impossible for any of the conditions where `TeardownSnapshotDatadir` returns false to trigger currently. However, this is pretty fragile, and if you're not planning to call `TeardownSnapshotDatadir` from other places in the future, I think it would be better to make `TeardownSnapshotDatadir` return `void` instead of `bool`, and turn the checks inside into `assert`s to make them function preconditions.\r\n\r\nI don't mean to nitpick but I think anyplace errors are not checked it increases chances that bugs will slip in and go undetected.",
      "commit_id" : "51d0dd34ecfb42d80707ec6cf788f0e63e30439f",
      "created_at" : "2022-03-23T02:34:48Z",
      "diff_hunk" : "@@ -4798,7 +4798,9 @@ bool ChainstateManager::ActivateSnapshot(\n         *snapshot_chainstate, coins_file, metadata);\n \n     if (!snapshot_ok) {\n-        WITH_LOCK(::cs_main, this->MaybeRebalanceCaches());\n+        LOCK(::cs_main);\n+        this->MaybeRebalanceCaches();\n+        snapshot_chainstate->TeardownSnapshotDatadir();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r832792541",
      "id" : 832792541,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584xo2fd",
      "original_commit_id" : "fe09582ec34ff4d19bb2aa490ffd6ccca95e8480",
      "original_line" : 4803,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 7,
      "pull_request_review_id" : 918071823,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/832792541/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-23T03:22:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/832792541",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r832800084"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/832800084"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"blockmanager: avoid undefined behavior during FlushBlockFile\" (1aeca9ae4d9938a9ae5a06dbe16d8b1cd40b9960)\r\n\r\nWould add `assert(m_blockfile_info.size() > m_last_blockfile)` to catch the related UB condition.",
      "commit_id" : "51d0dd34ecfb42d80707ec6cf788f0e63e30439f",
      "created_at" : "2022-03-23T02:51:24Z",
      "diff_hunk" : "@@ -551,6 +551,14 @@ void BlockManager::FlushUndoFile(int block_file, bool finalize)\n void BlockManager::FlushBlockFile(bool fFinalize, bool finalize_undo)\n {\n     LOCK(cs_LastBlockFile);\n+\n+    if (m_blockfile_info.size() < 1) {\n+        // Return if we haven't loaded any blockfiles yet. This happens during\n+        // chainstate init, when we call ChainstateManager::MaybeRebalanceCaches() (which\n+        // then calls FlushStateToDisk()), resulting in a call to this function before we\n+        // have populated `m_blockfile_info` via LoadBlockIndexDB().\n+        return;\n+    }\n     FlatFilePos block_pos_old(m_last_blockfile, m_blockfile_info[m_last_blockfile].nSize);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r832800084",
      "id" : 832800084,
      "line" : 562,
      "node_id" : "PRRC_kwDOABII584xo4VU",
      "original_commit_id" : "1aeca9ae4d9938a9ae5a06dbe16d8b1cd40b9960",
      "original_line" : 562,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 12,
      "pull_request_review_id" : 918071823,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/832800084/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-23T03:22:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/832800084",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r832804630"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/832804630"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add CChainState::m_stop_use and ChainMan::isUsable\" (c703836160f3eca8073c22a1531bb98ad9666999)\r\n\r\nWould `s/this chainstate/the background chainstate/`. Which chainstate is \"this chainstate\" was not immediately obvious.",
      "commit_id" : "51d0dd34ecfb42d80707ec6cf788f0e63e30439f",
      "created_at" : "2022-03-23T03:01:16Z",
      "diff_hunk" : "@@ -492,6 +492,12 @@ class CChainState\n     //! Manages the UTXO set, which is a reflection of the contents of `m_chain`.\n     std::unique_ptr<CoinsViews> m_coins_views;\n \n+    //! This toggle exists for use when doing background validation for UTXO\n+    //! snapshots. It is set once the background validation chain reaches the\n+    //! same height as the base of the snapshot, and signals that we should no\n+    //! longer connect blocks to this chainstate.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r832804630",
      "id" : 832804630,
      "line" : 499,
      "node_id" : "PRRC_kwDOABII584xo5cW",
      "original_commit_id" : "c703836160f3eca8073c22a1531bb98ad9666999",
      "original_line" : 498,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 7,
      "pull_request_review_id" : 918071823,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/832804630/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-23T03:22:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/832804630",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r832809804"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/832809804"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add CChainState::m_stop_use and ChainMan::isUsable\" (c703836160f3eca8073c22a1531bb98ad9666999)\r\n\r\nWould change \"This might be false, for, say\" to \"This will be false for\". IMO wishy washy comments are hard to understand and don't provide any real future proofing (A veritably false comment is still less confusing than a technically true but mostly misleading comment)",
      "commit_id" : "51d0dd34ecfb42d80707ec6cf788f0e63e30439f",
      "created_at" : "2022-03-23T03:15:32Z",
      "diff_hunk" : "@@ -866,6 +872,15 @@ class ChainstateManager\n     CBlockIndex* getSnapshotBaseBlock() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n     std::optional<int> getSnapshotHeight() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! Return true if a chainstate is considered usable.\n+    //!\n+    //! This might be false for, say, a background validation chainstate which has",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r832809804",
      "id" : 832809804,
      "line" : 901,
      "node_id" : "PRRC_kwDOABII584xo6tM",
      "original_commit_id" : "c703836160f3eca8073c22a1531bb98ad9666999",
      "original_line" : 877,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 19,
      "pull_request_review_id" : 918071823,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/832809804/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-23T03:22:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/832809804",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r834565387"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/834565387"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add ChainMan logic for completing UTXO snapshot validation\" (328aa05c28fe9e5fff5d90e9b23bbbb5f6da1846)\r\n\r\nI think it would simplify things and be less confusing to drop this checkForUncleanShutdown() method and just call `maybeCompleteSnapshotValidation()` here unconditionally.\r\n\r\nI think it overcomplicates things to think of this as special \"unclean\" case. I think if shutdown is requested, a node should stop what it is doing and shut down. If it was in the middle of doing work, and it has to pick up and redo some of that work on the restart, there is nothing \"unclean\" about that, it's just what you do when you are trying to write a robust and responsive application.",
      "commit_id" : "51d0dd34ecfb42d80707ec6cf788f0e63e30439f",
      "created_at" : "2022-03-24T17:36:10Z",
      "diff_hunk" : "@@ -137,6 +137,8 @@ std::optional<ChainstateLoadingError> LoadChainstate(bool fReset,\n         }\n     }\n \n+    chainman.checkForUncleanShutdown();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r834565387",
      "id" : 834565387,
      "line" : 140,
      "node_id" : "PRRC_kwDOABII584xvnUL",
      "original_commit_id" : "328aa05c28fe9e5fff5d90e9b23bbbb5f6da1846",
      "original_line" : 140,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : 4,
      "pull_request_review_id" : 920636521,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/834565387/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-25T15:45:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/834565387",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r834589002"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/834589002"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add ChainMan logic for completing UTXO snapshot validation\" (328aa05c28fe9e5fff5d90e9b23bbbb5f6da1846)\r\n\r\nI think this error should trigger more than logprints and a silent shutdown. Especially since after this a GUI user or systemd service script is likely to just bring the node up again and continue syncing like nothing happened. Probably would be best to call `AbortNode()` here to trigger a more noticeable error, and not just close the GUI with no indication of why it is closing.\r\n\r\nAlso text of this error doesn't seem to give an indication of what is causing it or how it should be dealt with. IIUC there are 3 possible causes for this error:\r\n\r\n1) Bitcoin sources were modified to include the hash of an invalid snapshot\r\n2) Bitcoin validation code is buggy\r\n3) Local data or memory corruption\r\n\r\nI'm assuming (3) is the most likely cause and the error message could reflect this. Maybe would suggest:\r\n\r\n> {PACKAGE_NAME} failed to validate the assumeutxo snapshot state. This indicates a hardware problem, or a bug in the software, or an bad software modification that allowed an invalid snapshot to be loaded. As a result of this, the node will shut down and delete any state that was built on the snapshot, resetting the chain height from {snapshot_tip_height} to {snapshot_base_height}. On the next restart, the node will resume syncing from {snapshot_base_height} not using any snapshot data.\r\n\r\nAlso to minimize potential damage, maybe help to debug or recover, and just avoid wiping traces of a bad thing that happened, i think it would probably be better to just rename the snapshot directory with an `-invalid` suffix instead of trying to delete it.",
      "commit_id" : "51d0dd34ecfb42d80707ec6cf788f0e63e30439f",
      "created_at" : "2022-03-24T18:04:25Z",
      "diff_hunk" : "@@ -5025,6 +5035,117 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+SnapshotCompletionResult ChainstateManager::maybeCompleteSnapshotValidation(\n+      CChainState& chainstate,\n+      CBlockIndex& index_new,\n+      std::function<void()> shutdown_fnc)\n+{\n+    AssertLockHeld(cs_main);\n+    if (&chainstate == &this->ActiveChainstate() ||\n+            !isUsable(m_snapshot_chainstate.get()) ||\n+            !isUsable(m_ibd_chainstate.get()) ||\n+            &chainstate != m_ibd_chainstate.get()) {\n+       // Nothing to do - this function only applies to the background\n+       // validation chainstate.\n+       return {false, {}};\n+    }\n+\n+    auto handleInvalidSnapshot = [&]() EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        LogPrintf(\"[snapshot] !!! the snapshot you've been working off of is invalid\\n\");\n+        LogPrintf(\"[snapshot] deleting snapshot and reverting to validated chain\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r834589002",
      "id" : 834589002,
      "line" : 5055,
      "node_id" : "PRRC_kwDOABII584xvtFK",
      "original_commit_id" : "328aa05c28fe9e5fff5d90e9b23bbbb5f6da1846",
      "original_line" : 5055,
      "original_position" : 54,
      "original_start_line" : 5054,
      "path" : "src/validation.cpp",
      "position" : 54,
      "pull_request_review_id" : 920636521,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/834589002/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 5054,
      "start_side" : "RIGHT",
      "updated_at" : "2022-03-25T15:45:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/834589002",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r834704890"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/834704890"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"test: add reset_chainstate parameter for snapshot unittests\" (9916bb825f6ef69f6c906dd4154309df07aa9d03)\r\n\r\nWould avoid `using` statement in header file because it's not limited to this file, but applies to any cpp file including it.",
      "commit_id" : "51d0dd34ecfb42d80707ec6cf788f0e63e30439f",
      "created_at" : "2022-03-24T20:35:37Z",
      "diff_hunk" : "@@ -10,22 +10,34 @@\n #include <node/context.h>\n #include <node/utxo_snapshot.h>\n #include <rpc/blockchain.h>\n+#include <test/util/setup_common.h>\n #include <validation.h>\n \n #include <univalue.h>\n \n #include <boost/test/unit_test.hpp>\n \n+using node::NodeContext;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r834704890",
      "id" : 834704890,
      "line" : 20,
      "node_id" : "PRRC_kwDOABII584xwJX6",
      "original_commit_id" : "9916bb825f6ef69f6c906dd4154309df07aa9d03",
      "original_line" : 20,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/test/util/chainstate.h",
      "position" : 11,
      "pull_request_review_id" : 920636521,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/834704890/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-25T15:45:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/834704890",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r834717368"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/834717368"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"test: add reset_chainstate parameter for snapshot unittests\" (9916bb825f6ef69f6c906dd4154309df07aa9d03)\r\n\r\nCan the comment say what in particular is hacky and what would make it less hacky? This just seems like it is unitiializing and reinitializing the chainstate, not doing anything too egregrious. Is the hacky aspect of this just that its is duplicating a lot of code. Would it be easy to deduplicate in a followup?",
      "commit_id" : "51d0dd34ecfb42d80707ec6cf788f0e63e30439f",
      "created_at" : "2022-03-24T20:52:16Z",
      "diff_hunk" : "@@ -48,6 +60,33 @@ CreateAndActivateUTXOSnapshot(node::NodeContext& node, const fs::path root, F ma\n \n     malleation(auto_infile, metadata);\n \n+    if (reset_chainstate) {\n+        {\n+            // What follows is a hack to selectively reset chainstate data without",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r834717368",
      "id" : 834717368,
      "line" : 65,
      "node_id" : "PRRC_kwDOABII584xwMa4",
      "original_commit_id" : "9916bb825f6ef69f6c906dd4154309df07aa9d03",
      "original_line" : 65,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/test/util/chainstate.h",
      "position" : 42,
      "pull_request_review_id" : 920636521,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/834717368/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-25T15:45:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/834717368",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r834871079"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/834871079"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: tear down snapshot datadirs upon validation failure\" (fe09582ec34ff4d19bb2aa490ffd6ccca95e8480)\r\n\r\nIt seems fragile that in order to remove a particular snapshot chainstate's data files, we have to call a function that iterates all snapshot chainstate directories, and hope that it returns the same directory, and then do extra checks below to ensure that it did actually return the same one.\r\n\r\nIt would be nice to introduce a `fs::path ChainstatePath(std::optional<uint256> from_snapshot_blockhash)` function and just say `fs::path snapshot_datadir = ChainstatePath(m_from_snapshot_blockhash)` here. (`ChainstatePath` would just do the inverse of `PathToSnapshotHash` and probably would be useful to call other places).\r\n\r\nEDIT: Or maybe this could just call the `StoragePath()` method added later to get the chainstate directory path from `*this`?",
      "commit_id" : "51d0dd34ecfb42d80707ec6cf788f0e63e30439f",
      "created_at" : "2022-03-25T01:08:03Z",
      "diff_hunk" : "@@ -5128,3 +5130,28 @@ bool ChainstateManager::DetectSnapshotChainstate(CTxMemPool* mempool)\n     this->InitializeChainstate(mempool, /*snapshot_blockhash*/ PathToSnapshotHash(*path));\n     return true;\n }\n+\n+bool CChainState::TeardownSnapshotDatadir()\n+{\n+    if (!m_from_snapshot_blockhash) {\n+        // Chainstate isn't based on a snapshot.\n+        return false;\n+    }\n+    std::optional<fs::path> snapshot_datadir = FindSnapshotChainstateDatadir();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r834871079",
      "id" : 834871079,
      "line" : 5295,
      "node_id" : "PRRC_kwDOABII584xwx8n",
      "original_commit_id" : "fe09582ec34ff4d19bb2aa490ffd6ccca95e8480",
      "original_line" : 5140,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 22,
      "pull_request_review_id" : 920636521,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/834871079/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-25T15:45:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/834871079",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r834895232"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/834895232"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add ChainMan logic for completing UTXO snapshot validation\" (328aa05c28fe9e5fff5d90e9b23bbbb5f6da1846)\r\n\r\nSnapshotBlockhash() not being nullopt seems like another thing that could be asserted above so this impossible value_or() case can go away",
      "commit_id" : "51d0dd34ecfb42d80707ec6cf788f0e63e30439f",
      "created_at" : "2022-03-25T01:55:52Z",
      "diff_hunk" : "@@ -5025,6 +5035,117 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+SnapshotCompletionResult ChainstateManager::maybeCompleteSnapshotValidation(\n+      CChainState& chainstate,\n+      CBlockIndex& index_new,\n+      std::function<void()> shutdown_fnc)\n+{\n+    AssertLockHeld(cs_main);\n+    if (&chainstate == &this->ActiveChainstate() ||\n+            !isUsable(m_snapshot_chainstate.get()) ||\n+            !isUsable(m_ibd_chainstate.get()) ||\n+            &chainstate != m_ibd_chainstate.get()) {\n+       // Nothing to do - this function only applies to the background\n+       // validation chainstate.\n+       return {false, {}};\n+    }\n+\n+    auto handleInvalidSnapshot = [&]() EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        LogPrintf(\"[snapshot] !!! the snapshot you've been working off of is invalid\\n\");\n+        LogPrintf(\"[snapshot] deleting snapshot and reverting to validated chain\\n\");\n+\n+        m_active_chainstate = m_ibd_chainstate.get();\n+        m_snapshot_chainstate->m_stop_use = true;\n+        assert(!isUsable(m_snapshot_chainstate.get()));\n+        m_snapshot_chainstate->teardownSnapshotDatadir();\n+\n+        LogPrintf(\"[snapshot] SHUTTING DOWN!\\n\");\n+        shutdown_fnc();\n+    };\n+\n+    int snapshot_height = *getSnapshotHeight();\n+\n+   if (index_new.nHeight > snapshot_height) {\n+      LogPrintf(\"[snapshot] something is wrong! validation chain \" /* Continued */\n+             \"should not have continued past the snapshot origin\\n\");\n+         handleInvalidSnapshot();\n+         return {false, SnapshotCompletionError::IBD_TOO_FAR};\n+     } else if (index_new.nHeight < snapshot_height) {\n+         // Background IBD not complete yet.\n+         return {false, {}};\n+     }\n+\n+    int curr_height = chainstate.m_chain.Height();\n+\n+    assert(snapshot_height == curr_height);\n+    assert(snapshot_height == index_new.nHeight);\n+    assert(&chainstate == m_ibd_chainstate.get());\n+    assert(isUsable(m_snapshot_chainstate.get()));\n+    assert(this->GetAll().size() == 2);\n+\n+    CCoinsViewDB& ibd_coins_db = chainstate.CoinsDB();\n+    chainstate.ForceFlushStateToDisk();\n+\n+    auto snapshot_blockhash = SnapshotBlockhash().value_or(uint256());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r834895232",
      "id" : 834895232,
      "line" : 5089,
      "node_id" : "PRRC_kwDOABII584xw32A",
      "original_commit_id" : "328aa05c28fe9e5fff5d90e9b23bbbb5f6da1846",
      "original_line" : 5089,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 88,
      "pull_request_review_id" : 920636521,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/834895232/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-25T15:45:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/834895232",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r834897447"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/834897447"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add ChainMan logic for completing UTXO snapshot validation\" (328aa05c28fe9e5fff5d90e9b23bbbb5f6da1846)\r\n\r\nHere and below I think it would be make code more readable to stop using the generic `chainstate` variable and instead use the unambiguous `m_ibd_chainstate` variable, since at this point point to the same chainstate.",
      "commit_id" : "51d0dd34ecfb42d80707ec6cf788f0e63e30439f",
      "created_at" : "2022-03-25T02:02:03Z",
      "diff_hunk" : "@@ -5025,6 +5035,117 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+SnapshotCompletionResult ChainstateManager::maybeCompleteSnapshotValidation(\n+      CChainState& chainstate,\n+      CBlockIndex& index_new,\n+      std::function<void()> shutdown_fnc)\n+{\n+    AssertLockHeld(cs_main);\n+    if (&chainstate == &this->ActiveChainstate() ||\n+            !isUsable(m_snapshot_chainstate.get()) ||\n+            !isUsable(m_ibd_chainstate.get()) ||\n+            &chainstate != m_ibd_chainstate.get()) {\n+       // Nothing to do - this function only applies to the background\n+       // validation chainstate.\n+       return {false, {}};\n+    }\n+\n+    auto handleInvalidSnapshot = [&]() EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        LogPrintf(\"[snapshot] !!! the snapshot you've been working off of is invalid\\n\");\n+        LogPrintf(\"[snapshot] deleting snapshot and reverting to validated chain\\n\");\n+\n+        m_active_chainstate = m_ibd_chainstate.get();\n+        m_snapshot_chainstate->m_stop_use = true;\n+        assert(!isUsable(m_snapshot_chainstate.get()));\n+        m_snapshot_chainstate->teardownSnapshotDatadir();\n+\n+        LogPrintf(\"[snapshot] SHUTTING DOWN!\\n\");\n+        shutdown_fnc();\n+    };\n+\n+    int snapshot_height = *getSnapshotHeight();\n+\n+   if (index_new.nHeight > snapshot_height) {\n+      LogPrintf(\"[snapshot] something is wrong! validation chain \" /* Continued */\n+             \"should not have continued past the snapshot origin\\n\");\n+         handleInvalidSnapshot();\n+         return {false, SnapshotCompletionError::IBD_TOO_FAR};\n+     } else if (index_new.nHeight < snapshot_height) {\n+         // Background IBD not complete yet.\n+         return {false, {}};\n+     }\n+\n+    int curr_height = chainstate.m_chain.Height();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r834897447",
      "id" : 834897447,
      "line" : 5078,
      "node_id" : "PRRC_kwDOABII584xw4Yn",
      "original_commit_id" : "328aa05c28fe9e5fff5d90e9b23bbbb5f6da1846",
      "original_line" : 5078,
      "original_position" : 77,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 77,
      "pull_request_review_id" : 920636521,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/834897447/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-25T15:45:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/834897447",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r834899579"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/834899579"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add ChainMan logic for completing UTXO snapshot validation\" (328aa05c28fe9e5fff5d90e9b23bbbb5f6da1846)\r\n\r\nThis seems like an error that actually needs to be checked for, not something that can asserted. If the snapshot blockhash comes from the directory name, an outside process renaming the directory could trigger this?",
      "commit_id" : "51d0dd34ecfb42d80707ec6cf788f0e63e30439f",
      "created_at" : "2022-03-25T02:08:25Z",
      "diff_hunk" : "@@ -5025,6 +5035,117 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+SnapshotCompletionResult ChainstateManager::maybeCompleteSnapshotValidation(\n+      CChainState& chainstate,\n+      CBlockIndex& index_new,\n+      std::function<void()> shutdown_fnc)\n+{\n+    AssertLockHeld(cs_main);\n+    if (&chainstate == &this->ActiveChainstate() ||\n+            !isUsable(m_snapshot_chainstate.get()) ||\n+            !isUsable(m_ibd_chainstate.get()) ||\n+            &chainstate != m_ibd_chainstate.get()) {\n+       // Nothing to do - this function only applies to the background\n+       // validation chainstate.\n+       return {false, {}};\n+    }\n+\n+    auto handleInvalidSnapshot = [&]() EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        LogPrintf(\"[snapshot] !!! the snapshot you've been working off of is invalid\\n\");\n+        LogPrintf(\"[snapshot] deleting snapshot and reverting to validated chain\\n\");\n+\n+        m_active_chainstate = m_ibd_chainstate.get();\n+        m_snapshot_chainstate->m_stop_use = true;\n+        assert(!isUsable(m_snapshot_chainstate.get()));\n+        m_snapshot_chainstate->teardownSnapshotDatadir();\n+\n+        LogPrintf(\"[snapshot] SHUTTING DOWN!\\n\");\n+        shutdown_fnc();\n+    };\n+\n+    int snapshot_height = *getSnapshotHeight();\n+\n+   if (index_new.nHeight > snapshot_height) {\n+      LogPrintf(\"[snapshot] something is wrong! validation chain \" /* Continued */\n+             \"should not have continued past the snapshot origin\\n\");\n+         handleInvalidSnapshot();\n+         return {false, SnapshotCompletionError::IBD_TOO_FAR};\n+     } else if (index_new.nHeight < snapshot_height) {\n+         // Background IBD not complete yet.\n+         return {false, {}};\n+     }\n+\n+    int curr_height = chainstate.m_chain.Height();\n+\n+    assert(snapshot_height == curr_height);\n+    assert(snapshot_height == index_new.nHeight);\n+    assert(&chainstate == m_ibd_chainstate.get());\n+    assert(isUsable(m_snapshot_chainstate.get()));\n+    assert(this->GetAll().size() == 2);\n+\n+    CCoinsViewDB& ibd_coins_db = chainstate.CoinsDB();\n+    chainstate.ForceFlushStateToDisk();\n+\n+    auto snapshot_blockhash = SnapshotBlockhash().value_or(uint256());\n+\n+    LogPrintf(\"[snapshot] tip: actual=%s expected=%s\\n\",\n+        chainstate.m_chain.Tip()->ToString(),\n+        snapshot_blockhash.ToString());\n+\n+    assert(index_new.GetBlockHash() == snapshot_blockhash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r834899579",
      "id" : 834899579,
      "line" : 5095,
      "node_id" : "PRRC_kwDOABII584xw457",
      "original_commit_id" : "328aa05c28fe9e5fff5d90e9b23bbbb5f6da1846",
      "original_line" : 5095,
      "original_position" : 94,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 94,
      "pull_request_review_id" : 920636521,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/834899579/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-25T15:45:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/834899579",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r834900729"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/834900729"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add ChainMan logic for completing UTXO snapshot validation\" (328aa05c28fe9e5fff5d90e9b23bbbb5f6da1846)\r\n\r\nWhy obfuscated?",
      "commit_id" : "51d0dd34ecfb42d80707ec6cf788f0e63e30439f",
      "created_at" : "2022-03-25T02:11:44Z",
      "diff_hunk" : "@@ -5025,6 +5035,117 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+SnapshotCompletionResult ChainstateManager::maybeCompleteSnapshotValidation(\n+      CChainState& chainstate,\n+      CBlockIndex& index_new,\n+      std::function<void()> shutdown_fnc)\n+{\n+    AssertLockHeld(cs_main);\n+    if (&chainstate == &this->ActiveChainstate() ||\n+            !isUsable(m_snapshot_chainstate.get()) ||\n+            !isUsable(m_ibd_chainstate.get()) ||\n+            &chainstate != m_ibd_chainstate.get()) {\n+       // Nothing to do - this function only applies to the background\n+       // validation chainstate.\n+       return {false, {}};\n+    }\n+\n+    auto handleInvalidSnapshot = [&]() EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        LogPrintf(\"[snapshot] !!! the snapshot you've been working off of is invalid\\n\");\n+        LogPrintf(\"[snapshot] deleting snapshot and reverting to validated chain\\n\");\n+\n+        m_active_chainstate = m_ibd_chainstate.get();\n+        m_snapshot_chainstate->m_stop_use = true;\n+        assert(!isUsable(m_snapshot_chainstate.get()));\n+        m_snapshot_chainstate->teardownSnapshotDatadir();\n+\n+        LogPrintf(\"[snapshot] SHUTTING DOWN!\\n\");\n+        shutdown_fnc();\n+    };\n+\n+    int snapshot_height = *getSnapshotHeight();\n+\n+   if (index_new.nHeight > snapshot_height) {\n+      LogPrintf(\"[snapshot] something is wrong! validation chain \" /* Continued */\n+             \"should not have continued past the snapshot origin\\n\");\n+         handleInvalidSnapshot();\n+         return {false, SnapshotCompletionError::IBD_TOO_FAR};\n+     } else if (index_new.nHeight < snapshot_height) {\n+         // Background IBD not complete yet.\n+         return {false, {}};\n+     }\n+\n+    int curr_height = chainstate.m_chain.Height();\n+\n+    assert(snapshot_height == curr_height);\n+    assert(snapshot_height == index_new.nHeight);\n+    assert(&chainstate == m_ibd_chainstate.get());\n+    assert(isUsable(m_snapshot_chainstate.get()));\n+    assert(this->GetAll().size() == 2);\n+\n+    CCoinsViewDB& ibd_coins_db = chainstate.CoinsDB();\n+    chainstate.ForceFlushStateToDisk();\n+\n+    auto snapshot_blockhash = SnapshotBlockhash().value_or(uint256());\n+\n+    LogPrintf(\"[snapshot] tip: actual=%s expected=%s\\n\",\n+        chainstate.m_chain.Tip()->ToString(),\n+        snapshot_blockhash.ToString());\n+\n+    assert(index_new.GetBlockHash() == snapshot_blockhash);\n+\n+    auto maybe_au_data = ExpectedAssumeutxo(curr_height, ::Params());\n+    if (!maybe_au_data) {\n+        LogPrintf(\"[snapshot] assumeutxo data not found for height \" /* Continued */\n+            \"(%d) - refusing to validate snapshot\\n\", curr_height);\n+        handleInvalidSnapshot();\n+        return {false, SnapshotCompletionError::MISSING_CHAINPARAMS};\n+    }\n+\n+    const AssumeutxoData& au_data = *maybe_au_data;\n+    CCoinsStats ibd_stats{CoinStatsHashType::HASH_SERIALIZED};\n+    auto breakpoint_fnc = [] { /* TODO insert breakpoint here? */ };\n+\n+    if (!GetUTXOStats(&ibd_coins_db, WITH_LOCK(::cs_main, return std::ref(m_blockman)), ibd_stats, breakpoint_fnc)) {\n+        LogPrintf(\"[snapshot] failed to generate stats for validation coins db\\n\");\n+        // While this isn't a proablem with the snapshot per se, this condition\n+        // prevents us from validating the snapshot, so we should shut down and let the\n+        // use handle the issue manually.\n+        handleInvalidSnapshot();\n+        return {false, SnapshotCompletionError::STATS_FAILED};\n+    }\n+\n+    // Compare the background validation chainstate's UTXO set hash against the hard-coded\n+    // assumeutxo hash we expect.\n+    //\n+    // TODO: For belt-and-suspenders, we could cache an obfuscated version of the UTXO set",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r834900729",
      "id" : 834900729,
      "line" : 5121,
      "node_id" : "PRRC_kwDOABII584xw5L5",
      "original_commit_id" : "328aa05c28fe9e5fff5d90e9b23bbbb5f6da1846",
      "original_line" : 5121,
      "original_position" : 120,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 120,
      "pull_request_review_id" : 920636521,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/834900729/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-25T15:45:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/834900729",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r834901932"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/834901932"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add ChainMan logic for completing UTXO snapshot validation\" (328aa05c28fe9e5fff5d90e9b23bbbb5f6da1846)\r\n\r\nI don't think I understand what this comment is saying. Is using the chainstate variable future-proofing for some upcoming change? What could it mean for the caller to \"act specifically based on this value\"?",
      "commit_id" : "51d0dd34ecfb42d80707ec6cf788f0e63e30439f",
      "created_at" : "2022-03-25T02:15:31Z",
      "diff_hunk" : "@@ -5025,6 +5035,117 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+SnapshotCompletionResult ChainstateManager::maybeCompleteSnapshotValidation(\n+      CChainState& chainstate,\n+      CBlockIndex& index_new,\n+      std::function<void()> shutdown_fnc)\n+{\n+    AssertLockHeld(cs_main);\n+    if (&chainstate == &this->ActiveChainstate() ||\n+            !isUsable(m_snapshot_chainstate.get()) ||\n+            !isUsable(m_ibd_chainstate.get()) ||\n+            &chainstate != m_ibd_chainstate.get()) {\n+       // Nothing to do - this function only applies to the background\n+       // validation chainstate.\n+       return {false, {}};\n+    }\n+\n+    auto handleInvalidSnapshot = [&]() EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        LogPrintf(\"[snapshot] !!! the snapshot you've been working off of is invalid\\n\");\n+        LogPrintf(\"[snapshot] deleting snapshot and reverting to validated chain\\n\");\n+\n+        m_active_chainstate = m_ibd_chainstate.get();\n+        m_snapshot_chainstate->m_stop_use = true;\n+        assert(!isUsable(m_snapshot_chainstate.get()));\n+        m_snapshot_chainstate->teardownSnapshotDatadir();\n+\n+        LogPrintf(\"[snapshot] SHUTTING DOWN!\\n\");\n+        shutdown_fnc();\n+    };\n+\n+    int snapshot_height = *getSnapshotHeight();\n+\n+   if (index_new.nHeight > snapshot_height) {\n+      LogPrintf(\"[snapshot] something is wrong! validation chain \" /* Continued */\n+             \"should not have continued past the snapshot origin\\n\");\n+         handleInvalidSnapshot();\n+         return {false, SnapshotCompletionError::IBD_TOO_FAR};\n+     } else if (index_new.nHeight < snapshot_height) {\n+         // Background IBD not complete yet.\n+         return {false, {}};\n+     }\n+\n+    int curr_height = chainstate.m_chain.Height();\n+\n+    assert(snapshot_height == curr_height);\n+    assert(snapshot_height == index_new.nHeight);\n+    assert(&chainstate == m_ibd_chainstate.get());\n+    assert(isUsable(m_snapshot_chainstate.get()));\n+    assert(this->GetAll().size() == 2);\n+\n+    CCoinsViewDB& ibd_coins_db = chainstate.CoinsDB();\n+    chainstate.ForceFlushStateToDisk();\n+\n+    auto snapshot_blockhash = SnapshotBlockhash().value_or(uint256());\n+\n+    LogPrintf(\"[snapshot] tip: actual=%s expected=%s\\n\",\n+        chainstate.m_chain.Tip()->ToString(),\n+        snapshot_blockhash.ToString());\n+\n+    assert(index_new.GetBlockHash() == snapshot_blockhash);\n+\n+    auto maybe_au_data = ExpectedAssumeutxo(curr_height, ::Params());\n+    if (!maybe_au_data) {\n+        LogPrintf(\"[snapshot] assumeutxo data not found for height \" /* Continued */\n+            \"(%d) - refusing to validate snapshot\\n\", curr_height);\n+        handleInvalidSnapshot();\n+        return {false, SnapshotCompletionError::MISSING_CHAINPARAMS};\n+    }\n+\n+    const AssumeutxoData& au_data = *maybe_au_data;\n+    CCoinsStats ibd_stats{CoinStatsHashType::HASH_SERIALIZED};\n+    auto breakpoint_fnc = [] { /* TODO insert breakpoint here? */ };\n+\n+    if (!GetUTXOStats(&ibd_coins_db, WITH_LOCK(::cs_main, return std::ref(m_blockman)), ibd_stats, breakpoint_fnc)) {\n+        LogPrintf(\"[snapshot] failed to generate stats for validation coins db\\n\");\n+        // While this isn't a proablem with the snapshot per se, this condition\n+        // prevents us from validating the snapshot, so we should shut down and let the\n+        // use handle the issue manually.\n+        handleInvalidSnapshot();\n+        return {false, SnapshotCompletionError::STATS_FAILED};\n+    }\n+\n+    // Compare the background validation chainstate's UTXO set hash against the hard-coded\n+    // assumeutxo hash we expect.\n+    //\n+    // TODO: For belt-and-suspenders, we could cache an obfuscated version of the UTXO set\n+    // hash for the snapshot when it's loaded in its chainstate's leveldb. We should then\n+    // reference that here for an additional check.\n+    if (AssumeutxoHash{ibd_stats.hashSerialized} != au_data.hash_serialized) {\n+        LogPrintf(\"[snapshot] hash mismatch: actual=%s, expected=%s\\n\",\n+            ibd_stats.hashSerialized.ToString(),\n+            au_data.hash_serialized.ToString());\n+        handleInvalidSnapshot();\n+        return {false, SnapshotCompletionError::HASH_MISMATCH};\n+    }\n+\n+    LogPrintf(\"[snapshot] snapshot beginning at %s has been fully validated\\n\",\n+        snapshot_blockhash.ToString());\n+\n+    m_snapshot_validated = true;\n+\n+    // m_ibd_chainstate is the same as chainstate, per the assertion above.\n+    // Modification happens to the argument (this symbol) to make it explicit that\n+    // the caller might act specifically based on this value being different.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r834901932",
      "id" : 834901932,
      "line" : 5139,
      "node_id" : "PRRC_kwDOABII584xw5es",
      "original_commit_id" : "328aa05c28fe9e5fff5d90e9b23bbbb5f6da1846",
      "original_line" : 5139,
      "original_position" : 138,
      "original_start_line" : 5137,
      "path" : "src/validation.cpp",
      "position" : 138,
      "pull_request_review_id" : 920636521,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/834901932/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 5137,
      "start_side" : "RIGHT",
      "updated_at" : "2022-03-25T15:45:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/834901932",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r834903115"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/834903115"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add ChainMan logic for completing UTXO snapshot validation\" (328aa05c28fe9e5fff5d90e9b23bbbb5f6da1846)\r\n\r\nThis isn't really specific to shutdown. Renaming a directory before deleting it is just good practice because renaming is atomic and deleting a directory isn't.",
      "commit_id" : "51d0dd34ecfb42d80707ec6cf788f0e63e30439f",
      "created_at" : "2022-03-25T02:19:04Z",
      "diff_hunk" : "@@ -5174,3 +5323,44 @@ std::optional<int> ChainstateManager::getSnapshotHeight()\n     CBlockIndex* base = getSnapshotBaseBlock();\n     return base ? std::make_optional(base->nHeight) : std::nullopt;\n }\n+\n+void ChainstateManager::validatedSnapshotShutdownCleanup(\n+    fs::path new_chainstate, fs::path old_chainstate)\n+{\n+    assert(fs::exists(new_chainstate));\n+    assert(fs::exists(old_chainstate));\n+\n+    LogPrintf(\"[snapshot] deleting background chainstate directory (now unnecessary) (%s)\\n\",\n+        fs::PathToString(old_chainstate));\n+\n+    // Instead of deleting the background chainstate directly, rename the old\n+    // chainstate to chainstate_bak, rename the new chainstate into place, and then\n+    // delete to avoid likelihood of corruption from mid-delete shutdown.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r834903115",
      "id" : 834903115,
      "line" : 5338,
      "node_id" : "PRRC_kwDOABII584xw5xL",
      "original_commit_id" : "328aa05c28fe9e5fff5d90e9b23bbbb5f6da1846",
      "original_line" : 5338,
      "original_position" : 211,
      "original_start_line" : 5336,
      "path" : "src/validation.cpp",
      "position" : 211,
      "pull_request_review_id" : 920636521,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/834903115/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 5336,
      "start_side" : "RIGHT",
      "updated_at" : "2022-03-25T15:45:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/834903115",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r835278526"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835278526"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"init: add utxo snapshot detection\" (becdbd6da4c6d7c9c658ffc38b1c9da1c89571a1)\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/24232/#discussion_r832762880\r\n\r\n> Also, as long as the code is not capable of handling multiple snapshots it seems like a better design for this might just be to call the directory `<datadir>/chainstate_snapshot` instead of `<datadir>/chainstate_{blockhash}` so there would be no ambiguity.\r\n\r\nI take back this part of my suggestion. I think current design of iterating all the chainstate directories is good, but the code should be improved to be more robust (in the future, not necessarily here). I think the best thing for bitcoin to do at startup would be to list all the `chainstate*` directories and use whichever one has the most work at its tip as the active chainstate. Then, if that active chainstate comes from a snapshot that needs to be validated, additionally load up the \"ibd\" chainstate and sync it up in the background to validate the starting snapshot.\r\n\r\nThis makes the right thing happen regardless of what directories are present. Snapshots will be used if they are useful, ignored if they are not, and if they are manually added or removed it causes no problems.",
      "commit_id" : "51d0dd34ecfb42d80707ec6cf788f0e63e30439f",
      "created_at" : "2022-03-25T13:38:55Z",
      "diff_hunk" : "@@ -5082,3 +5083,48 @@ void ChainstateManager::MaybeRebalanceCaches()\n         }\n     }\n }\n+\n+constexpr int SNAPSHOT_NAME_LEN = 75; // \"chainstate_\" + 64 hex characters for blockhash.\n+\n+static bool IsPathSnapshotDatadir(const fs::path& datadir_path)\n+{\n+    return fs::PathToString(datadir_path.filename()).length() == SNAPSHOT_NAME_LEN &&\n+        fs::PathToString(datadir_path.filename()).substr(0,11) == \"chainstate_\";\n+}\n+\n+static uint256 PathToSnapshotHash(const fs::path& datadir_path)\n+{\n+    assert(IsPathSnapshotDatadir(datadir_path));\n+    return uint256S(fs::PathToString(datadir_path.filename()).substr(11));\n+}\n+\n+static std::optional<fs::path> FindSnapshotChainstateDatadir()\n+{\n+    fs::path found;\n+\n+    for (fs::directory_iterator it(gArgs.GetDataDirNet()); it != fs::directory_iterator(); it++) {\n+        if (fs::is_directory(*it) && !fs::is_empty(*it) && IsPathSnapshotDatadir(it->path()))\n+        {\n+            if (found.empty()) {\n+                found = it->path();\n+                LogPrintf(\"[snapshot] found snapshot datadir %s\\n\", fs::PathToString(found));\n+            } else {\n+                LogPrintf(\"[snapshot] WARNING - detected multiple snapshot \" /* Continued */\n+                    \"datadirs (%s). This is not expected.\\n\", fs::PathToString(it->path()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r835278526",
      "id" : 835278526,
      "in_reply_to_id" : 832762880,
      "line" : 5270,
      "node_id" : "PRRC_kwDOABII584xyVa-",
      "original_commit_id" : "becdbd6da4c6d7c9c658ffc38b1c9da1c89571a1",
      "original_line" : 5113,
      "original_position" : 39,
      "original_start_line" : 5112,
      "path" : "src/validation.cpp",
      "position" : 39,
      "pull_request_review_id" : 920636521,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835278526/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 5269,
      "start_side" : "RIGHT",
      "updated_at" : "2022-03-25T15:45:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835278526",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r835355848"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835355848"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"add ChainstateManager.getSnapshot{Height,BaseBlock}()\" (d8f32839cfbc8cbfe194d190bdc19fb3c4d6e32a)\r\n\r\nWould rename `getSnapshotHeight` to `getSnapshotBaseHeight` for two reasons:\r\n\r\n- To be consistent with `getSnapshotBaseBlock`\r\n- To disambiguate. \"Snapshot\" could refer to snapshot chainstate rather than snapshot itself, and chainstate may have a height higher than the initial snapshot\r\n\r\nThis is a tangent, but I'm increasingly disliking the terms \"ibd chainstate\" and \"snapshot chainstate.\" If had a magic wand I would abolish them everywhere. I think ideally a chainstate would consist of a UTXO set, a tip pointer, and \"validated starting from\" block pointer and \"validated starting from\" UTXO hash. ChainstateManager would have a list of chainstates, and one of them would be active with rest inactive. Network code would download blocks to validate chainstates, prioritizing blocks for the active chainstate. ChainstateManager would connect the incoming blocks, and if the tip of any chainstate crossed the \"validated starting from\" block of a later chainstate, and UTXO hash matched, the later \"validated_starting_from\" pointer would moved back to the earlier one, and earlier chainstate (optionally) discarded.\r\nProbably having explicit tip and \"validated starting from\" pointers would also allow CBlockIndex validation flags to be simplified so more code doesn't need to care about assumeutxo. This could all be cleanup though. More important to get the existing code that's already merged functional and not change things at this point.",
      "commit_id" : "51d0dd34ecfb42d80707ec6cf788f0e63e30439f",
      "created_at" : "2022-03-25T15:02:41Z",
      "diff_hunk" : "@@ -862,6 +862,10 @@ class ChainstateManager\n         CBlockIndex** ppindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n     friend CChainState;\n \n+    // Returns nullptr if no snapshot ahs been loaded.\n+    CBlockIndex* getSnapshotBaseBlock() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+    std::optional<int> getSnapshotHeight() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r835355848",
      "id" : 835355848,
      "line" : 892,
      "node_id" : "PRRC_kwDOABII584xyoTI",
      "original_commit_id" : "d8f32839cfbc8cbfe194d190bdc19fb3c4d6e32a",
      "original_line" : 867,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 6,
      "pull_request_review_id" : 920636521,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835355848/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-25T15:45:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835355848",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r835375721"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835375721"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add ChainMan logic for completing UTXO snapshot validation\" (328aa05c28fe9e5fff5d90e9b23bbbb5f6da1846)\r\n\r\nI think I'd NACK the approach for trying to rename and delete things on shutdown. I don't see why it's not possible to rename and delete the snapshot when it is validated. I understand that maybe you want the pointers to be stable so can't delete the CChainstate object, but that doesn't seem like a reason why you can't close/destroy databases and rename directories.\r\n\r\nIf I'm missing something and it really is not possible to rename the chainstate directories while the node is running, the best time to rename them would be startup time, not shutdown time. Shutdown is the time to stop work, not begin it, and it's especially precarious if bitcoin is running on a constantly rebooting windows machine or as a systemd service, where the system may ask nicely for a shutdown but quickly run out of patience and kill the process.",
      "commit_id" : "51d0dd34ecfb42d80707ec6cf788f0e63e30439f",
      "created_at" : "2022-03-25T15:24:36Z",
      "diff_hunk" : "@@ -5051,6 +5172,34 @@ void ChainstateManager::Unload()\n     m_best_invalid = nullptr;\n }\n \n+void ChainstateManager::cleanup()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r835375721",
      "id" : 835375721,
      "line" : 5175,
      "node_id" : "PRRC_kwDOABII584xytJp",
      "original_commit_id" : "328aa05c28fe9e5fff5d90e9b23bbbb5f6da1846",
      "original_line" : 5175,
      "original_position" : 155,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 155,
      "pull_request_review_id" : 920636521,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835375721/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-25T15:50:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/835375721",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r843059138"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/843059138"
         }
      },
      "author_association" : "MEMBER",
      "body" : "At least one improvement of the log message could be to advice the node operator on what they should do, e.g deleting the oldest snapshot one or whatever could be appropriate.",
      "commit_id" : "51d0dd34ecfb42d80707ec6cf788f0e63e30439f",
      "created_at" : "2022-04-05T17:00:20Z",
      "diff_hunk" : "@@ -5082,3 +5083,48 @@ void ChainstateManager::MaybeRebalanceCaches()\n         }\n     }\n }\n+\n+constexpr int SNAPSHOT_NAME_LEN = 75; // \"chainstate_\" + 64 hex characters for blockhash.\n+\n+static bool IsPathSnapshotDatadir(const fs::path& datadir_path)\n+{\n+    return fs::PathToString(datadir_path.filename()).length() == SNAPSHOT_NAME_LEN &&\n+        fs::PathToString(datadir_path.filename()).substr(0,11) == \"chainstate_\";\n+}\n+\n+static uint256 PathToSnapshotHash(const fs::path& datadir_path)\n+{\n+    assert(IsPathSnapshotDatadir(datadir_path));\n+    return uint256S(fs::PathToString(datadir_path.filename()).substr(11));\n+}\n+\n+static std::optional<fs::path> FindSnapshotChainstateDatadir()\n+{\n+    fs::path found;\n+\n+    for (fs::directory_iterator it(gArgs.GetDataDirNet()); it != fs::directory_iterator(); it++) {\n+        if (fs::is_directory(*it) && !fs::is_empty(*it) && IsPathSnapshotDatadir(it->path()))\n+        {\n+            if (found.empty()) {\n+                found = it->path();\n+                LogPrintf(\"[snapshot] found snapshot datadir %s\\n\", fs::PathToString(found));\n+            } else {\n+                LogPrintf(\"[snapshot] WARNING - detected multiple snapshot \" /* Continued */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r843059138",
      "id" : 843059138,
      "line" : 5269,
      "node_id" : "PRRC_kwDOABII584yQA_C",
      "original_commit_id" : "becdbd6da4c6d7c9c658ffc38b1c9da1c89571a1",
      "original_line" : 5112,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 38,
      "pull_request_review_id" : 932225971,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/843059138/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-05T17:48:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/843059138",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r843077280"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/843077280"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Same comment, unclear what a node operator should do with an invalid, name-different snapshot datadir. ",
      "commit_id" : "51d0dd34ecfb42d80707ec6cf788f0e63e30439f",
      "created_at" : "2022-04-05T17:13:27Z",
      "diff_hunk" : "@@ -5128,3 +5130,28 @@ bool ChainstateManager::DetectSnapshotChainstate(CTxMemPool* mempool)\n     this->InitializeChainstate(mempool, /*snapshot_blockhash*/ PathToSnapshotHash(*path));\n     return true;\n }\n+\n+bool CChainState::TeardownSnapshotDatadir()\n+{\n+    if (!m_from_snapshot_blockhash) {\n+        // Chainstate isn't based on a snapshot.\n+        return false;\n+    }\n+    std::optional<fs::path> snapshot_datadir = FindSnapshotChainstateDatadir();\n+\n+    if (!snapshot_datadir) {\n+        return false;\n+    }\n+\n+    uint256 datadir_hash = PathToSnapshotHash(*snapshot_datadir);\n+\n+    if (datadir_hash != *m_from_snapshot_blockhash) {\n+        LogPrintf(\"[snapshot] WARNING - unexpected blockhash for snapshot datadir (%s); expected %s\\n\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r843077280",
      "id" : 843077280,
      "line" : 5304,
      "node_id" : "PRRC_kwDOABII584yQFag",
      "original_commit_id" : "fe09582ec34ff4d19bb2aa490ffd6ccca95e8480",
      "original_line" : 5149,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 31,
      "pull_request_review_id" : 932225971,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/843077280/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-05T17:48:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/843077280",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r843078255"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/843078255"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: s/ahs/has/g",
      "commit_id" : "51d0dd34ecfb42d80707ec6cf788f0e63e30439f",
      "created_at" : "2022-04-05T17:14:42Z",
      "diff_hunk" : "@@ -862,6 +862,10 @@ class ChainstateManager\n         CBlockIndex** ppindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n     friend CChainState;\n \n+    // Returns nullptr if no snapshot ahs been loaded.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r843078255",
      "id" : 843078255,
      "line" : 890,
      "node_id" : "PRRC_kwDOABII584yQFpv",
      "original_commit_id" : "d8f32839cfbc8cbfe194d190bdc19fb3c4d6e32a",
      "original_line" : 865,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 4,
      "pull_request_review_id" : 932225971,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/843078255/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-05T17:48:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/843078255",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-04-06T16:28:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#issuecomment-1090467334",
      "id" : 1090467334,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24232",
      "node_id" : "IC_kwDOABII585A_zYG",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1090467334/reactions"
      },
      "updated_at" : "2022-04-06T16:28:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1090467334",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r844980474"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/844980474"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n        this, NoMalleation, /*reset_chainstate=*/true));\r\n```\r\nAnywhere you are adding / touching named args, please use the [style from the developer docs](https://github.com/bitcoin/bitcoin/blob/master/doc/developer-notes.md#coding-style-c-named-arguments).",
      "commit_id" : "51d0dd34ecfb42d80707ec6cf788f0e63e30439f",
      "created_at" : "2022-04-07T10:34:10Z",
      "diff_hunk" : "@@ -90,7 +90,8 @@ BOOST_FIXTURE_TEST_CASE(chainstate_update_tip, TestChain100Setup)\n     // After adding some blocks to the tip, best block should have changed.\n     BOOST_CHECK(::g_best_block != curr_tip);\n \n-    BOOST_REQUIRE(CreateAndActivateUTXOSnapshot(m_node, m_path_root));\n+    BOOST_REQUIRE(CreateAndActivateUTXOSnapshot(\n+        this, NoMalleation, /* reset_chainstate */ true));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r844980474",
      "id" : 844980474,
      "line" : 94,
      "node_id" : "PRRC_kwDOABII584yXWD6",
      "original_commit_id" : "51d0dd34ecfb42d80707ec6cf788f0e63e30439f",
      "original_line" : 94,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstate_tests.cpp",
      "position" : 6,
      "pull_request_review_id" : 934846730,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/844980474/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-07T10:34:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/844980474",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r846258979"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/846258979"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: `maybeCompleteSnapshotValidation`",
      "commit_id" : "51d0dd34ecfb42d80707ec6cf788f0e63e30439f",
      "created_at" : "2022-04-08T15:41:14Z",
      "diff_hunk" : "@@ -2959,6 +2964,12 @@ bool CChainState::ActivateBestChain(BlockValidationState& state, std::shared_ptr\n \n         if (nStopAtHeight && pindexNewTip && pindexNewTip->nHeight >= nStopAtHeight) StartShutdown();\n \n+        // This will have been toggled in ABCStep -> ConnectTip -> completeSnapshotValidation,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r846258979",
      "id" : 846258979,
      "line" : 2967,
      "node_id" : "PRRC_kwDOABII584ycOMj",
      "original_commit_id" : "51d0dd34ecfb42d80707ec6cf788f0e63e30439f",
      "original_line" : 2967,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 23,
      "pull_request_review_id" : 936652174,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/846258979/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-08T17:05:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/846258979",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r846283199"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/846283199"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think the log print can be even more proactive, if the causes of this error is 1., the log print could invite the node operator to report the snapshot source to the project, e.g opening an issue. That would help to identify and correct wrongdoing in the snapshot distribution circuit.",
      "commit_id" : "51d0dd34ecfb42d80707ec6cf788f0e63e30439f",
      "created_at" : "2022-04-08T16:07:45Z",
      "diff_hunk" : "@@ -5025,6 +5035,117 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+SnapshotCompletionResult ChainstateManager::maybeCompleteSnapshotValidation(\n+      CChainState& chainstate,\n+      CBlockIndex& index_new,\n+      std::function<void()> shutdown_fnc)\n+{\n+    AssertLockHeld(cs_main);\n+    if (&chainstate == &this->ActiveChainstate() ||\n+            !isUsable(m_snapshot_chainstate.get()) ||\n+            !isUsable(m_ibd_chainstate.get()) ||\n+            &chainstate != m_ibd_chainstate.get()) {\n+       // Nothing to do - this function only applies to the background\n+       // validation chainstate.\n+       return {false, {}};\n+    }\n+\n+    auto handleInvalidSnapshot = [&]() EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        LogPrintf(\"[snapshot] !!! the snapshot you've been working off of is invalid\\n\");\n+        LogPrintf(\"[snapshot] deleting snapshot and reverting to validated chain\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r846283199",
      "id" : 846283199,
      "in_reply_to_id" : 834589002,
      "line" : 5055,
      "node_id" : "PRRC_kwDOABII584ycUG_",
      "original_commit_id" : "328aa05c28fe9e5fff5d90e9b23bbbb5f6da1846",
      "original_line" : 5055,
      "original_position" : 54,
      "original_start_line" : 5054,
      "path" : "src/validation.cpp",
      "position" : 54,
      "pull_request_review_id" : 936652174,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/846283199/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 5054,
      "start_side" : "RIGHT",
      "updated_at" : "2022-04-08T17:05:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/846283199",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r846291146"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/846291146"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Nice to add comments about error purposes.",
      "commit_id" : "51d0dd34ecfb42d80707ec6cf788f0e63e30439f",
      "created_at" : "2022-04-08T16:18:06Z",
      "diff_hunk" : "@@ -772,11 +773,24 @@ class CChainState\n      * Only used during snapshot activation (within ChainstateManager) if the loaded\n      * snapshot does not validate.\n      */\n-    bool TeardownSnapshotDatadir() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+    bool teardownSnapshotDatadir() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n     friend ChainstateManager;\n };\n \n+\n+enum class SnapshotCompletionError {\n+    IBD_TOO_FAR,\n+    MISSING_CHAINPARAMS,\n+    STATS_FAILED,\n+    HASH_MISMATCH,\n+};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r846291146",
      "id" : 846291146,
      "line" : 787,
      "node_id" : "PRRC_kwDOABII584ycWDK",
      "original_commit_id" : "328aa05c28fe9e5fff5d90e9b23bbbb5f6da1846",
      "original_line" : 787,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 24,
      "pull_request_review_id" : 936652174,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/846291146/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-08T17:05:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/846291146",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r846306235"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/846306235"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: s/proablem/problem/g and s/use/user/g",
      "commit_id" : "51d0dd34ecfb42d80707ec6cf788f0e63e30439f",
      "created_at" : "2022-04-08T16:38:49Z",
      "diff_hunk" : "@@ -5025,6 +5035,117 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+SnapshotCompletionResult ChainstateManager::maybeCompleteSnapshotValidation(\n+      CChainState& chainstate,\n+      CBlockIndex& index_new,\n+      std::function<void()> shutdown_fnc)\n+{\n+    AssertLockHeld(cs_main);\n+    if (&chainstate == &this->ActiveChainstate() ||\n+            !isUsable(m_snapshot_chainstate.get()) ||\n+            !isUsable(m_ibd_chainstate.get()) ||\n+            &chainstate != m_ibd_chainstate.get()) {\n+       // Nothing to do - this function only applies to the background\n+       // validation chainstate.\n+       return {false, {}};\n+    }\n+\n+    auto handleInvalidSnapshot = [&]() EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        LogPrintf(\"[snapshot] !!! the snapshot you've been working off of is invalid\\n\");\n+        LogPrintf(\"[snapshot] deleting snapshot and reverting to validated chain\\n\");\n+\n+        m_active_chainstate = m_ibd_chainstate.get();\n+        m_snapshot_chainstate->m_stop_use = true;\n+        assert(!isUsable(m_snapshot_chainstate.get()));\n+        m_snapshot_chainstate->teardownSnapshotDatadir();\n+\n+        LogPrintf(\"[snapshot] SHUTTING DOWN!\\n\");\n+        shutdown_fnc();\n+    };\n+\n+    int snapshot_height = *getSnapshotHeight();\n+\n+   if (index_new.nHeight > snapshot_height) {\n+      LogPrintf(\"[snapshot] something is wrong! validation chain \" /* Continued */\n+             \"should not have continued past the snapshot origin\\n\");\n+         handleInvalidSnapshot();\n+         return {false, SnapshotCompletionError::IBD_TOO_FAR};\n+     } else if (index_new.nHeight < snapshot_height) {\n+         // Background IBD not complete yet.\n+         return {false, {}};\n+     }\n+\n+    int curr_height = chainstate.m_chain.Height();\n+\n+    assert(snapshot_height == curr_height);\n+    assert(snapshot_height == index_new.nHeight);\n+    assert(&chainstate == m_ibd_chainstate.get());\n+    assert(isUsable(m_snapshot_chainstate.get()));\n+    assert(this->GetAll().size() == 2);\n+\n+    CCoinsViewDB& ibd_coins_db = chainstate.CoinsDB();\n+    chainstate.ForceFlushStateToDisk();\n+\n+    auto snapshot_blockhash = SnapshotBlockhash().value_or(uint256());\n+\n+    LogPrintf(\"[snapshot] tip: actual=%s expected=%s\\n\",\n+        chainstate.m_chain.Tip()->ToString(),\n+        snapshot_blockhash.ToString());\n+\n+    assert(index_new.GetBlockHash() == snapshot_blockhash);\n+\n+    auto maybe_au_data = ExpectedAssumeutxo(curr_height, ::Params());\n+    if (!maybe_au_data) {\n+        LogPrintf(\"[snapshot] assumeutxo data not found for height \" /* Continued */\n+            \"(%d) - refusing to validate snapshot\\n\", curr_height);\n+        handleInvalidSnapshot();\n+        return {false, SnapshotCompletionError::MISSING_CHAINPARAMS};\n+    }\n+\n+    const AssumeutxoData& au_data = *maybe_au_data;\n+    CCoinsStats ibd_stats{CoinStatsHashType::HASH_SERIALIZED};\n+    auto breakpoint_fnc = [] { /* TODO insert breakpoint here? */ };\n+\n+    if (!GetUTXOStats(&ibd_coins_db, WITH_LOCK(::cs_main, return std::ref(m_blockman)), ibd_stats, breakpoint_fnc)) {\n+        LogPrintf(\"[snapshot] failed to generate stats for validation coins db\\n\");\n+        // While this isn't a proablem with the snapshot per se, this condition\n+        // prevents us from validating the snapshot, so we should shut down and let the\n+        // use handle the issue manually.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r846306235",
      "id" : 846306235,
      "line" : 5113,
      "node_id" : "PRRC_kwDOABII584ycZu7",
      "original_commit_id" : "328aa05c28fe9e5fff5d90e9b23bbbb5f6da1846",
      "original_line" : 5113,
      "original_position" : 112,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 112,
      "pull_request_review_id" : 936652174,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/846306235/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-08T17:05:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/846306235",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r846320699"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/846320699"
         }
      },
      "author_association" : "MEMBER",
      "body" : "From reading `ChainstateManager` docs, there are two notions of IBD chainstates, the `ibd chainstate` and the `background ibd chainstate`. However, the `ibd chainstate` is only used here, after it has been fully validated and won't be used further as node operation is shutting down.\r\n\r\nSo what's the purpose of using the notion of an `ibd_chainstate`, couldn't `m_ibd_chainstate` be called `m_background_ibd_chainstate` ?",
      "commit_id" : "51d0dd34ecfb42d80707ec6cf788f0e63e30439f",
      "created_at" : "2022-04-08T16:58:57Z",
      "diff_hunk" : "@@ -5025,6 +5035,117 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+SnapshotCompletionResult ChainstateManager::maybeCompleteSnapshotValidation(\n+      CChainState& chainstate,\n+      CBlockIndex& index_new,\n+      std::function<void()> shutdown_fnc)\n+{\n+    AssertLockHeld(cs_main);\n+    if (&chainstate == &this->ActiveChainstate() ||\n+            !isUsable(m_snapshot_chainstate.get()) ||\n+            !isUsable(m_ibd_chainstate.get()) ||\n+            &chainstate != m_ibd_chainstate.get()) {\n+       // Nothing to do - this function only applies to the background\n+       // validation chainstate.\n+       return {false, {}};\n+    }\n+\n+    auto handleInvalidSnapshot = [&]() EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        LogPrintf(\"[snapshot] !!! the snapshot you've been working off of is invalid\\n\");\n+        LogPrintf(\"[snapshot] deleting snapshot and reverting to validated chain\\n\");\n+\n+        m_active_chainstate = m_ibd_chainstate.get();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r846320699",
      "id" : 846320699,
      "line" : 5057,
      "node_id" : "PRRC_kwDOABII584ycdQ7",
      "original_commit_id" : "328aa05c28fe9e5fff5d90e9b23bbbb5f6da1846",
      "original_line" : 5057,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 56,
      "pull_request_review_id" : 936652174,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/846320699/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-08T17:05:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/846320699",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r847503113"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/847503113"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> I think the best thing for bitcoin to do at startup would be to list all the chainstate* directories and use whichever one has the most work at its tip as the active chainstate.\r\n\r\nI agree this would be a nice feature, but the process of unpacking snapshots and loading them to the point of being able to evaluate \"most work\" entails some big changes, so I'll defer this one for later. \r\n\r\nI do like your suggestion of calling it `<datadir>/chainstate_snapshot` and will incorporate that.",
      "commit_id" : "51d0dd34ecfb42d80707ec6cf788f0e63e30439f",
      "created_at" : "2022-04-11T16:08:20Z",
      "diff_hunk" : "@@ -5082,3 +5083,48 @@ void ChainstateManager::MaybeRebalanceCaches()\n         }\n     }\n }\n+\n+constexpr int SNAPSHOT_NAME_LEN = 75; // \"chainstate_\" + 64 hex characters for blockhash.\n+\n+static bool IsPathSnapshotDatadir(const fs::path& datadir_path)\n+{\n+    return fs::PathToString(datadir_path.filename()).length() == SNAPSHOT_NAME_LEN &&\n+        fs::PathToString(datadir_path.filename()).substr(0,11) == \"chainstate_\";\n+}\n+\n+static uint256 PathToSnapshotHash(const fs::path& datadir_path)\n+{\n+    assert(IsPathSnapshotDatadir(datadir_path));\n+    return uint256S(fs::PathToString(datadir_path.filename()).substr(11));\n+}\n+\n+static std::optional<fs::path> FindSnapshotChainstateDatadir()\n+{\n+    fs::path found;\n+\n+    for (fs::directory_iterator it(gArgs.GetDataDirNet()); it != fs::directory_iterator(); it++) {\n+        if (fs::is_directory(*it) && !fs::is_empty(*it) && IsPathSnapshotDatadir(it->path()))\n+        {\n+            if (found.empty()) {\n+                found = it->path();\n+                LogPrintf(\"[snapshot] found snapshot datadir %s\\n\", fs::PathToString(found));\n+            } else {\n+                LogPrintf(\"[snapshot] WARNING - detected multiple snapshot \" /* Continued */\n+                    \"datadirs (%s). This is not expected.\\n\", fs::PathToString(it->path()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r847503113",
      "id" : 847503113,
      "in_reply_to_id" : 832762880,
      "line" : 5270,
      "node_id" : "PRRC_kwDOABII584yg98J",
      "original_commit_id" : "becdbd6da4c6d7c9c658ffc38b1c9da1c89571a1",
      "original_line" : 5113,
      "original_position" : 39,
      "original_start_line" : 5112,
      "path" : "src/validation.cpp",
      "position" : 39,
      "pull_request_review_id" : 938257241,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/847503113/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 5269,
      "start_side" : "RIGHT",
      "updated_at" : "2022-04-11T16:08:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/847503113",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r847697301"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/847697301"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good points, willfix.",
      "commit_id" : "51d0dd34ecfb42d80707ec6cf788f0e63e30439f",
      "created_at" : "2022-04-11T20:12:32Z",
      "diff_hunk" : "@@ -5051,6 +5172,34 @@ void ChainstateManager::Unload()\n     m_best_invalid = nullptr;\n }\n \n+void ChainstateManager::cleanup()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r847697301",
      "id" : 847697301,
      "in_reply_to_id" : 835375721,
      "line" : 5175,
      "node_id" : "PRRC_kwDOABII584yhtWV",
      "original_commit_id" : "328aa05c28fe9e5fff5d90e9b23bbbb5f6da1846",
      "original_line" : 5175,
      "original_position" : 155,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 155,
      "pull_request_review_id" : 938535930,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/847697301/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-11T20:12:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/847697301",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r847718311"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/847718311"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`m_ibd_chainstate` is the active if a snapshot is not being used, so calling it `m_background_...` wouldn't be appropriate.",
      "commit_id" : "51d0dd34ecfb42d80707ec6cf788f0e63e30439f",
      "created_at" : "2022-04-11T20:40:49Z",
      "diff_hunk" : "@@ -5025,6 +5035,117 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+SnapshotCompletionResult ChainstateManager::maybeCompleteSnapshotValidation(\n+      CChainState& chainstate,\n+      CBlockIndex& index_new,\n+      std::function<void()> shutdown_fnc)\n+{\n+    AssertLockHeld(cs_main);\n+    if (&chainstate == &this->ActiveChainstate() ||\n+            !isUsable(m_snapshot_chainstate.get()) ||\n+            !isUsable(m_ibd_chainstate.get()) ||\n+            &chainstate != m_ibd_chainstate.get()) {\n+       // Nothing to do - this function only applies to the background\n+       // validation chainstate.\n+       return {false, {}};\n+    }\n+\n+    auto handleInvalidSnapshot = [&]() EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        LogPrintf(\"[snapshot] !!! the snapshot you've been working off of is invalid\\n\");\n+        LogPrintf(\"[snapshot] deleting snapshot and reverting to validated chain\\n\");\n+\n+        m_active_chainstate = m_ibd_chainstate.get();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r847718311",
      "id" : 847718311,
      "in_reply_to_id" : 846320699,
      "line" : 5057,
      "node_id" : "PRRC_kwDOABII584yhyen",
      "original_commit_id" : "328aa05c28fe9e5fff5d90e9b23bbbb5f6da1846",
      "original_line" : 5057,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 56,
      "pull_request_review_id" : 938565564,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/847718311/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-11T20:40:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/847718311",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849849049"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849849049"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added, thanks.",
      "commit_id" : "d0c4295ba218f315b04bbaf1b523631243571610",
      "created_at" : "2022-04-13T20:03:45Z",
      "diff_hunk" : "@@ -551,6 +551,14 @@ void BlockManager::FlushUndoFile(int block_file, bool finalize)\n void BlockManager::FlushBlockFile(bool fFinalize, bool finalize_undo)\n {\n     LOCK(cs_LastBlockFile);\n+\n+    if (m_blockfile_info.size() < 1) {\n+        // Return if we haven't loaded any blockfiles yet. This happens during\n+        // chainstate init, when we call ChainstateManager::MaybeRebalanceCaches() (which\n+        // then calls FlushStateToDisk()), resulting in a call to this function before we\n+        // have populated `m_blockfile_info` via LoadBlockIndexDB().\n+        return;\n+    }\n     FlatFilePos block_pos_old(m_last_blockfile, m_blockfile_info[m_last_blockfile].nSize);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849849049",
      "id" : 849849049,
      "in_reply_to_id" : 832800084,
      "line" : 533,
      "node_id" : "PRRC_kwDOABII584yp6rZ",
      "original_commit_id" : "1aeca9ae4d9938a9ae5a06dbe16d8b1cd40b9960",
      "original_line" : 533,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 14,
      "pull_request_review_id" : 941494747,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849849049/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-13T22:41:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849849049",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849860945"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849860945"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yep, good idea. Done. I'm now just calling `maybeCompleteSnapshotValidation()` from within `LoadChainstate()` (during init). This dovetails with the broader change of doing background validation cleanup on initialization (instead of shutdown) which I'll describe in other comments. ",
      "commit_id" : "d0c4295ba218f315b04bbaf1b523631243571610",
      "created_at" : "2022-04-13T20:14:51Z",
      "diff_hunk" : "@@ -137,6 +137,8 @@ std::optional<ChainstateLoadingError> LoadChainstate(bool fReset,\n         }\n     }\n \n+    chainman.checkForUncleanShutdown();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849860945",
      "id" : 849860945,
      "in_reply_to_id" : 834565387,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584yp9lR",
      "original_commit_id" : "328aa05c28fe9e5fff5d90e9b23bbbb5f6da1846",
      "original_line" : 140,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : null,
      "pull_request_review_id" : 941494747,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849860945/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-13T22:41:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849860945",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849862245"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849862245"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done, thanks.",
      "commit_id" : "d0c4295ba218f315b04bbaf1b523631243571610",
      "created_at" : "2022-04-13T20:16:44Z",
      "diff_hunk" : "@@ -10,22 +10,34 @@\n #include <node/context.h>\n #include <node/utxo_snapshot.h>\n #include <rpc/blockchain.h>\n+#include <test/util/setup_common.h>\n #include <validation.h>\n \n #include <univalue.h>\n \n #include <boost/test/unit_test.hpp>\n \n+using node::NodeContext;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849862245",
      "id" : 849862245,
      "in_reply_to_id" : 834704890,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584yp95l",
      "original_commit_id" : "9916bb825f6ef69f6c906dd4154309df07aa9d03",
      "original_line" : 20,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/test/util/chainstate.h",
      "position" : null,
      "pull_request_review_id" : 941494747,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849862245/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-13T22:41:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849862245",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849863232"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849863232"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Removed the mention of hackiness. Perhaps this could live as a separate function if it was found to be useful elsewhere, but I think for now it's fine here. The code itself is sort of single-purpose; I don't think there's another case where we want to do such an unceremonious unload of all the chainstate data.",
      "commit_id" : "d0c4295ba218f315b04bbaf1b523631243571610",
      "created_at" : "2022-04-13T20:18:00Z",
      "diff_hunk" : "@@ -48,6 +60,33 @@ CreateAndActivateUTXOSnapshot(node::NodeContext& node, const fs::path root, F ma\n \n     malleation(auto_infile, metadata);\n \n+    if (reset_chainstate) {\n+        {\n+            // What follows is a hack to selectively reset chainstate data without",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849863232",
      "id" : 849863232,
      "in_reply_to_id" : 834717368,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584yp-JA",
      "original_commit_id" : "9916bb825f6ef69f6c906dd4154309df07aa9d03",
      "original_line" : 65,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/test/util/chainstate.h",
      "position" : null,
      "pull_request_review_id" : 941494747,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849863232/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-13T22:41:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849863232",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849939352"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849939352"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done, thanks.",
      "commit_id" : "d0c4295ba218f315b04bbaf1b523631243571610",
      "created_at" : "2022-04-13T22:14:26Z",
      "diff_hunk" : "@@ -90,7 +90,8 @@ BOOST_FIXTURE_TEST_CASE(chainstate_update_tip, TestChain100Setup)\n     // After adding some blocks to the tip, best block should have changed.\n     BOOST_CHECK(::g_best_block != curr_tip);\n \n-    BOOST_REQUIRE(CreateAndActivateUTXOSnapshot(m_node, m_path_root));\n+    BOOST_REQUIRE(CreateAndActivateUTXOSnapshot(\n+        this, NoMalleation, /* reset_chainstate */ true));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849939352",
      "id" : 849939352,
      "in_reply_to_id" : 844980474,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584yqQuY",
      "original_commit_id" : "51d0dd34ecfb42d80707ec6cf788f0e63e30439f",
      "original_line" : 94,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstate_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 941494747,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849939352/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-13T22:41:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849939352",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849942023"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849942023"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed, thanks.",
      "commit_id" : "d0c4295ba218f315b04bbaf1b523631243571610",
      "created_at" : "2022-04-13T22:19:35Z",
      "diff_hunk" : "@@ -2959,6 +2964,12 @@ bool CChainState::ActivateBestChain(BlockValidationState& state, std::shared_ptr\n \n         if (nStopAtHeight && pindexNewTip && pindexNewTip->nHeight >= nStopAtHeight) StartShutdown();\n \n+        // This will have been toggled in ABCStep -> ConnectTip -> completeSnapshotValidation,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849942023",
      "id" : 849942023,
      "in_reply_to_id" : 846258979,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584yqRYH",
      "original_commit_id" : "51d0dd34ecfb42d80707ec6cf788f0e63e30439f",
      "original_line" : 2967,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 941494747,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849942023/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-13T22:41:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849942023",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849942314"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849942314"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Now using `AbortNode()` as well as the nice log message you specify; I'm also including `PACKAGE_BUGREPORT` which lists the github issues URL. Thanks for the great suggestion.",
      "commit_id" : "d0c4295ba218f315b04bbaf1b523631243571610",
      "created_at" : "2022-04-13T22:20:15Z",
      "diff_hunk" : "@@ -5025,6 +5035,117 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+SnapshotCompletionResult ChainstateManager::maybeCompleteSnapshotValidation(\n+      CChainState& chainstate,\n+      CBlockIndex& index_new,\n+      std::function<void()> shutdown_fnc)\n+{\n+    AssertLockHeld(cs_main);\n+    if (&chainstate == &this->ActiveChainstate() ||\n+            !isUsable(m_snapshot_chainstate.get()) ||\n+            !isUsable(m_ibd_chainstate.get()) ||\n+            &chainstate != m_ibd_chainstate.get()) {\n+       // Nothing to do - this function only applies to the background\n+       // validation chainstate.\n+       return {false, {}};\n+    }\n+\n+    auto handleInvalidSnapshot = [&]() EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        LogPrintf(\"[snapshot] !!! the snapshot you've been working off of is invalid\\n\");\n+        LogPrintf(\"[snapshot] deleting snapshot and reverting to validated chain\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849942314",
      "id" : 849942314,
      "in_reply_to_id" : 834589002,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584yqRcq",
      "original_commit_id" : "328aa05c28fe9e5fff5d90e9b23bbbb5f6da1846",
      "original_line" : 5055,
      "original_position" : 54,
      "original_start_line" : 5054,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 941494747,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849942314/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-04-13T22:41:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849942314",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849942419"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849942419"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done, thanks.",
      "commit_id" : "d0c4295ba218f315b04bbaf1b523631243571610",
      "created_at" : "2022-04-13T22:20:28Z",
      "diff_hunk" : "@@ -5025,6 +5035,117 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+SnapshotCompletionResult ChainstateManager::maybeCompleteSnapshotValidation(\n+      CChainState& chainstate,\n+      CBlockIndex& index_new,\n+      std::function<void()> shutdown_fnc)\n+{\n+    AssertLockHeld(cs_main);\n+    if (&chainstate == &this->ActiveChainstate() ||\n+            !isUsable(m_snapshot_chainstate.get()) ||\n+            !isUsable(m_ibd_chainstate.get()) ||\n+            &chainstate != m_ibd_chainstate.get()) {\n+       // Nothing to do - this function only applies to the background\n+       // validation chainstate.\n+       return {false, {}};\n+    }\n+\n+    auto handleInvalidSnapshot = [&]() EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        LogPrintf(\"[snapshot] !!! the snapshot you've been working off of is invalid\\n\");\n+        LogPrintf(\"[snapshot] deleting snapshot and reverting to validated chain\\n\");\n+\n+        m_active_chainstate = m_ibd_chainstate.get();\n+        m_snapshot_chainstate->m_stop_use = true;\n+        assert(!isUsable(m_snapshot_chainstate.get()));\n+        m_snapshot_chainstate->teardownSnapshotDatadir();\n+\n+        LogPrintf(\"[snapshot] SHUTTING DOWN!\\n\");\n+        shutdown_fnc();\n+    };\n+\n+    int snapshot_height = *getSnapshotHeight();\n+\n+   if (index_new.nHeight > snapshot_height) {\n+      LogPrintf(\"[snapshot] something is wrong! validation chain \" /* Continued */\n+             \"should not have continued past the snapshot origin\\n\");\n+         handleInvalidSnapshot();\n+         return {false, SnapshotCompletionError::IBD_TOO_FAR};\n+     } else if (index_new.nHeight < snapshot_height) {\n+         // Background IBD not complete yet.\n+         return {false, {}};\n+     }\n+\n+    int curr_height = chainstate.m_chain.Height();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849942419",
      "id" : 849942419,
      "in_reply_to_id" : 834897447,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584yqReT",
      "original_commit_id" : "328aa05c28fe9e5fff5d90e9b23bbbb5f6da1846",
      "original_line" : 5078,
      "original_position" : 77,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 941494747,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849942419/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-13T22:41:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849942419",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849942512"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849942512"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "d0c4295ba218f315b04bbaf1b523631243571610",
      "created_at" : "2022-04-13T22:20:40Z",
      "diff_hunk" : "@@ -5025,6 +5035,117 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+SnapshotCompletionResult ChainstateManager::maybeCompleteSnapshotValidation(\n+      CChainState& chainstate,\n+      CBlockIndex& index_new,\n+      std::function<void()> shutdown_fnc)\n+{\n+    AssertLockHeld(cs_main);\n+    if (&chainstate == &this->ActiveChainstate() ||\n+            !isUsable(m_snapshot_chainstate.get()) ||\n+            !isUsable(m_ibd_chainstate.get()) ||\n+            &chainstate != m_ibd_chainstate.get()) {\n+       // Nothing to do - this function only applies to the background\n+       // validation chainstate.\n+       return {false, {}};\n+    }\n+\n+    auto handleInvalidSnapshot = [&]() EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        LogPrintf(\"[snapshot] !!! the snapshot you've been working off of is invalid\\n\");\n+        LogPrintf(\"[snapshot] deleting snapshot and reverting to validated chain\\n\");\n+\n+        m_active_chainstate = m_ibd_chainstate.get();\n+        m_snapshot_chainstate->m_stop_use = true;\n+        assert(!isUsable(m_snapshot_chainstate.get()));\n+        m_snapshot_chainstate->teardownSnapshotDatadir();\n+\n+        LogPrintf(\"[snapshot] SHUTTING DOWN!\\n\");\n+        shutdown_fnc();\n+    };\n+\n+    int snapshot_height = *getSnapshotHeight();\n+\n+   if (index_new.nHeight > snapshot_height) {\n+      LogPrintf(\"[snapshot] something is wrong! validation chain \" /* Continued */\n+             \"should not have continued past the snapshot origin\\n\");\n+         handleInvalidSnapshot();\n+         return {false, SnapshotCompletionError::IBD_TOO_FAR};\n+     } else if (index_new.nHeight < snapshot_height) {\n+         // Background IBD not complete yet.\n+         return {false, {}};\n+     }\n+\n+    int curr_height = chainstate.m_chain.Height();\n+\n+    assert(snapshot_height == curr_height);\n+    assert(snapshot_height == index_new.nHeight);\n+    assert(&chainstate == m_ibd_chainstate.get());\n+    assert(isUsable(m_snapshot_chainstate.get()));\n+    assert(this->GetAll().size() == 2);\n+\n+    CCoinsViewDB& ibd_coins_db = chainstate.CoinsDB();\n+    chainstate.ForceFlushStateToDisk();\n+\n+    auto snapshot_blockhash = SnapshotBlockhash().value_or(uint256());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849942512",
      "id" : 849942512,
      "in_reply_to_id" : 834895232,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584yqRfw",
      "original_commit_id" : "328aa05c28fe9e5fff5d90e9b23bbbb5f6da1846",
      "original_line" : 5089,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 941494747,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849942512/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-13T22:41:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849942512",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849942541"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849942541"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good point, done.",
      "commit_id" : "d0c4295ba218f315b04bbaf1b523631243571610",
      "created_at" : "2022-04-13T22:20:45Z",
      "diff_hunk" : "@@ -5025,6 +5035,117 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+SnapshotCompletionResult ChainstateManager::maybeCompleteSnapshotValidation(\n+      CChainState& chainstate,\n+      CBlockIndex& index_new,\n+      std::function<void()> shutdown_fnc)\n+{\n+    AssertLockHeld(cs_main);\n+    if (&chainstate == &this->ActiveChainstate() ||\n+            !isUsable(m_snapshot_chainstate.get()) ||\n+            !isUsable(m_ibd_chainstate.get()) ||\n+            &chainstate != m_ibd_chainstate.get()) {\n+       // Nothing to do - this function only applies to the background\n+       // validation chainstate.\n+       return {false, {}};\n+    }\n+\n+    auto handleInvalidSnapshot = [&]() EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        LogPrintf(\"[snapshot] !!! the snapshot you've been working off of is invalid\\n\");\n+        LogPrintf(\"[snapshot] deleting snapshot and reverting to validated chain\\n\");\n+\n+        m_active_chainstate = m_ibd_chainstate.get();\n+        m_snapshot_chainstate->m_stop_use = true;\n+        assert(!isUsable(m_snapshot_chainstate.get()));\n+        m_snapshot_chainstate->teardownSnapshotDatadir();\n+\n+        LogPrintf(\"[snapshot] SHUTTING DOWN!\\n\");\n+        shutdown_fnc();\n+    };\n+\n+    int snapshot_height = *getSnapshotHeight();\n+\n+   if (index_new.nHeight > snapshot_height) {\n+      LogPrintf(\"[snapshot] something is wrong! validation chain \" /* Continued */\n+             \"should not have continued past the snapshot origin\\n\");\n+         handleInvalidSnapshot();\n+         return {false, SnapshotCompletionError::IBD_TOO_FAR};\n+     } else if (index_new.nHeight < snapshot_height) {\n+         // Background IBD not complete yet.\n+         return {false, {}};\n+     }\n+\n+    int curr_height = chainstate.m_chain.Height();\n+\n+    assert(snapshot_height == curr_height);\n+    assert(snapshot_height == index_new.nHeight);\n+    assert(&chainstate == m_ibd_chainstate.get());\n+    assert(isUsable(m_snapshot_chainstate.get()));\n+    assert(this->GetAll().size() == 2);\n+\n+    CCoinsViewDB& ibd_coins_db = chainstate.CoinsDB();\n+    chainstate.ForceFlushStateToDisk();\n+\n+    auto snapshot_blockhash = SnapshotBlockhash().value_or(uint256());\n+\n+    LogPrintf(\"[snapshot] tip: actual=%s expected=%s\\n\",\n+        chainstate.m_chain.Tip()->ToString(),\n+        snapshot_blockhash.ToString());\n+\n+    assert(index_new.GetBlockHash() == snapshot_blockhash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849942541",
      "id" : 849942541,
      "in_reply_to_id" : 834899579,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584yqRgN",
      "original_commit_id" : "328aa05c28fe9e5fff5d90e9b23bbbb5f6da1846",
      "original_line" : 5095,
      "original_position" : 94,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 941494747,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849942541/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-13T22:41:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849942541",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849942588"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849942588"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done, thanks.",
      "commit_id" : "d0c4295ba218f315b04bbaf1b523631243571610",
      "created_at" : "2022-04-13T22:20:50Z",
      "diff_hunk" : "@@ -5025,6 +5035,117 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+SnapshotCompletionResult ChainstateManager::maybeCompleteSnapshotValidation(\n+      CChainState& chainstate,\n+      CBlockIndex& index_new,\n+      std::function<void()> shutdown_fnc)\n+{\n+    AssertLockHeld(cs_main);\n+    if (&chainstate == &this->ActiveChainstate() ||\n+            !isUsable(m_snapshot_chainstate.get()) ||\n+            !isUsable(m_ibd_chainstate.get()) ||\n+            &chainstate != m_ibd_chainstate.get()) {\n+       // Nothing to do - this function only applies to the background\n+       // validation chainstate.\n+       return {false, {}};\n+    }\n+\n+    auto handleInvalidSnapshot = [&]() EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        LogPrintf(\"[snapshot] !!! the snapshot you've been working off of is invalid\\n\");\n+        LogPrintf(\"[snapshot] deleting snapshot and reverting to validated chain\\n\");\n+\n+        m_active_chainstate = m_ibd_chainstate.get();\n+        m_snapshot_chainstate->m_stop_use = true;\n+        assert(!isUsable(m_snapshot_chainstate.get()));\n+        m_snapshot_chainstate->teardownSnapshotDatadir();\n+\n+        LogPrintf(\"[snapshot] SHUTTING DOWN!\\n\");\n+        shutdown_fnc();\n+    };\n+\n+    int snapshot_height = *getSnapshotHeight();\n+\n+   if (index_new.nHeight > snapshot_height) {\n+      LogPrintf(\"[snapshot] something is wrong! validation chain \" /* Continued */\n+             \"should not have continued past the snapshot origin\\n\");\n+         handleInvalidSnapshot();\n+         return {false, SnapshotCompletionError::IBD_TOO_FAR};\n+     } else if (index_new.nHeight < snapshot_height) {\n+         // Background IBD not complete yet.\n+         return {false, {}};\n+     }\n+\n+    int curr_height = chainstate.m_chain.Height();\n+\n+    assert(snapshot_height == curr_height);\n+    assert(snapshot_height == index_new.nHeight);\n+    assert(&chainstate == m_ibd_chainstate.get());\n+    assert(isUsable(m_snapshot_chainstate.get()));\n+    assert(this->GetAll().size() == 2);\n+\n+    CCoinsViewDB& ibd_coins_db = chainstate.CoinsDB();\n+    chainstate.ForceFlushStateToDisk();\n+\n+    auto snapshot_blockhash = SnapshotBlockhash().value_or(uint256());\n+\n+    LogPrintf(\"[snapshot] tip: actual=%s expected=%s\\n\",\n+        chainstate.m_chain.Tip()->ToString(),\n+        snapshot_blockhash.ToString());\n+\n+    assert(index_new.GetBlockHash() == snapshot_blockhash);\n+\n+    auto maybe_au_data = ExpectedAssumeutxo(curr_height, ::Params());\n+    if (!maybe_au_data) {\n+        LogPrintf(\"[snapshot] assumeutxo data not found for height \" /* Continued */\n+            \"(%d) - refusing to validate snapshot\\n\", curr_height);\n+        handleInvalidSnapshot();\n+        return {false, SnapshotCompletionError::MISSING_CHAINPARAMS};\n+    }\n+\n+    const AssumeutxoData& au_data = *maybe_au_data;\n+    CCoinsStats ibd_stats{CoinStatsHashType::HASH_SERIALIZED};\n+    auto breakpoint_fnc = [] { /* TODO insert breakpoint here? */ };\n+\n+    if (!GetUTXOStats(&ibd_coins_db, WITH_LOCK(::cs_main, return std::ref(m_blockman)), ibd_stats, breakpoint_fnc)) {\n+        LogPrintf(\"[snapshot] failed to generate stats for validation coins db\\n\");\n+        // While this isn't a proablem with the snapshot per se, this condition\n+        // prevents us from validating the snapshot, so we should shut down and let the\n+        // use handle the issue manually.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849942588",
      "id" : 849942588,
      "in_reply_to_id" : 846306235,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584yqRg8",
      "original_commit_id" : "328aa05c28fe9e5fff5d90e9b23bbbb5f6da1846",
      "original_line" : 5113,
      "original_position" : 112,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 941494747,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849942588/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-13T22:41:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849942588",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849942687"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849942687"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Removed.",
      "commit_id" : "d0c4295ba218f315b04bbaf1b523631243571610",
      "created_at" : "2022-04-13T22:21:02Z",
      "diff_hunk" : "@@ -5025,6 +5035,117 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+SnapshotCompletionResult ChainstateManager::maybeCompleteSnapshotValidation(\n+      CChainState& chainstate,\n+      CBlockIndex& index_new,\n+      std::function<void()> shutdown_fnc)\n+{\n+    AssertLockHeld(cs_main);\n+    if (&chainstate == &this->ActiveChainstate() ||\n+            !isUsable(m_snapshot_chainstate.get()) ||\n+            !isUsable(m_ibd_chainstate.get()) ||\n+            &chainstate != m_ibd_chainstate.get()) {\n+       // Nothing to do - this function only applies to the background\n+       // validation chainstate.\n+       return {false, {}};\n+    }\n+\n+    auto handleInvalidSnapshot = [&]() EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        LogPrintf(\"[snapshot] !!! the snapshot you've been working off of is invalid\\n\");\n+        LogPrintf(\"[snapshot] deleting snapshot and reverting to validated chain\\n\");\n+\n+        m_active_chainstate = m_ibd_chainstate.get();\n+        m_snapshot_chainstate->m_stop_use = true;\n+        assert(!isUsable(m_snapshot_chainstate.get()));\n+        m_snapshot_chainstate->teardownSnapshotDatadir();\n+\n+        LogPrintf(\"[snapshot] SHUTTING DOWN!\\n\");\n+        shutdown_fnc();\n+    };\n+\n+    int snapshot_height = *getSnapshotHeight();\n+\n+   if (index_new.nHeight > snapshot_height) {\n+      LogPrintf(\"[snapshot] something is wrong! validation chain \" /* Continued */\n+             \"should not have continued past the snapshot origin\\n\");\n+         handleInvalidSnapshot();\n+         return {false, SnapshotCompletionError::IBD_TOO_FAR};\n+     } else if (index_new.nHeight < snapshot_height) {\n+         // Background IBD not complete yet.\n+         return {false, {}};\n+     }\n+\n+    int curr_height = chainstate.m_chain.Height();\n+\n+    assert(snapshot_height == curr_height);\n+    assert(snapshot_height == index_new.nHeight);\n+    assert(&chainstate == m_ibd_chainstate.get());\n+    assert(isUsable(m_snapshot_chainstate.get()));\n+    assert(this->GetAll().size() == 2);\n+\n+    CCoinsViewDB& ibd_coins_db = chainstate.CoinsDB();\n+    chainstate.ForceFlushStateToDisk();\n+\n+    auto snapshot_blockhash = SnapshotBlockhash().value_or(uint256());\n+\n+    LogPrintf(\"[snapshot] tip: actual=%s expected=%s\\n\",\n+        chainstate.m_chain.Tip()->ToString(),\n+        snapshot_blockhash.ToString());\n+\n+    assert(index_new.GetBlockHash() == snapshot_blockhash);\n+\n+    auto maybe_au_data = ExpectedAssumeutxo(curr_height, ::Params());\n+    if (!maybe_au_data) {\n+        LogPrintf(\"[snapshot] assumeutxo data not found for height \" /* Continued */\n+            \"(%d) - refusing to validate snapshot\\n\", curr_height);\n+        handleInvalidSnapshot();\n+        return {false, SnapshotCompletionError::MISSING_CHAINPARAMS};\n+    }\n+\n+    const AssumeutxoData& au_data = *maybe_au_data;\n+    CCoinsStats ibd_stats{CoinStatsHashType::HASH_SERIALIZED};\n+    auto breakpoint_fnc = [] { /* TODO insert breakpoint here? */ };\n+\n+    if (!GetUTXOStats(&ibd_coins_db, WITH_LOCK(::cs_main, return std::ref(m_blockman)), ibd_stats, breakpoint_fnc)) {\n+        LogPrintf(\"[snapshot] failed to generate stats for validation coins db\\n\");\n+        // While this isn't a proablem with the snapshot per se, this condition\n+        // prevents us from validating the snapshot, so we should shut down and let the\n+        // use handle the issue manually.\n+        handleInvalidSnapshot();\n+        return {false, SnapshotCompletionError::STATS_FAILED};\n+    }\n+\n+    // Compare the background validation chainstate's UTXO set hash against the hard-coded\n+    // assumeutxo hash we expect.\n+    //\n+    // TODO: For belt-and-suspenders, we could cache an obfuscated version of the UTXO set",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849942687",
      "id" : 849942687,
      "in_reply_to_id" : 834900729,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584yqRif",
      "original_commit_id" : "328aa05c28fe9e5fff5d90e9b23bbbb5f6da1846",
      "original_line" : 5121,
      "original_position" : 120,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 941494747,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849942687/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-13T22:41:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849942687",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849942839"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849942839"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I must've been in a haze when I typed this - I have no idea what it means either. Removed.",
      "commit_id" : "d0c4295ba218f315b04bbaf1b523631243571610",
      "created_at" : "2022-04-13T22:21:22Z",
      "diff_hunk" : "@@ -5025,6 +5035,117 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+SnapshotCompletionResult ChainstateManager::maybeCompleteSnapshotValidation(\n+      CChainState& chainstate,\n+      CBlockIndex& index_new,\n+      std::function<void()> shutdown_fnc)\n+{\n+    AssertLockHeld(cs_main);\n+    if (&chainstate == &this->ActiveChainstate() ||\n+            !isUsable(m_snapshot_chainstate.get()) ||\n+            !isUsable(m_ibd_chainstate.get()) ||\n+            &chainstate != m_ibd_chainstate.get()) {\n+       // Nothing to do - this function only applies to the background\n+       // validation chainstate.\n+       return {false, {}};\n+    }\n+\n+    auto handleInvalidSnapshot = [&]() EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        LogPrintf(\"[snapshot] !!! the snapshot you've been working off of is invalid\\n\");\n+        LogPrintf(\"[snapshot] deleting snapshot and reverting to validated chain\\n\");\n+\n+        m_active_chainstate = m_ibd_chainstate.get();\n+        m_snapshot_chainstate->m_stop_use = true;\n+        assert(!isUsable(m_snapshot_chainstate.get()));\n+        m_snapshot_chainstate->teardownSnapshotDatadir();\n+\n+        LogPrintf(\"[snapshot] SHUTTING DOWN!\\n\");\n+        shutdown_fnc();\n+    };\n+\n+    int snapshot_height = *getSnapshotHeight();\n+\n+   if (index_new.nHeight > snapshot_height) {\n+      LogPrintf(\"[snapshot] something is wrong! validation chain \" /* Continued */\n+             \"should not have continued past the snapshot origin\\n\");\n+         handleInvalidSnapshot();\n+         return {false, SnapshotCompletionError::IBD_TOO_FAR};\n+     } else if (index_new.nHeight < snapshot_height) {\n+         // Background IBD not complete yet.\n+         return {false, {}};\n+     }\n+\n+    int curr_height = chainstate.m_chain.Height();\n+\n+    assert(snapshot_height == curr_height);\n+    assert(snapshot_height == index_new.nHeight);\n+    assert(&chainstate == m_ibd_chainstate.get());\n+    assert(isUsable(m_snapshot_chainstate.get()));\n+    assert(this->GetAll().size() == 2);\n+\n+    CCoinsViewDB& ibd_coins_db = chainstate.CoinsDB();\n+    chainstate.ForceFlushStateToDisk();\n+\n+    auto snapshot_blockhash = SnapshotBlockhash().value_or(uint256());\n+\n+    LogPrintf(\"[snapshot] tip: actual=%s expected=%s\\n\",\n+        chainstate.m_chain.Tip()->ToString(),\n+        snapshot_blockhash.ToString());\n+\n+    assert(index_new.GetBlockHash() == snapshot_blockhash);\n+\n+    auto maybe_au_data = ExpectedAssumeutxo(curr_height, ::Params());\n+    if (!maybe_au_data) {\n+        LogPrintf(\"[snapshot] assumeutxo data not found for height \" /* Continued */\n+            \"(%d) - refusing to validate snapshot\\n\", curr_height);\n+        handleInvalidSnapshot();\n+        return {false, SnapshotCompletionError::MISSING_CHAINPARAMS};\n+    }\n+\n+    const AssumeutxoData& au_data = *maybe_au_data;\n+    CCoinsStats ibd_stats{CoinStatsHashType::HASH_SERIALIZED};\n+    auto breakpoint_fnc = [] { /* TODO insert breakpoint here? */ };\n+\n+    if (!GetUTXOStats(&ibd_coins_db, WITH_LOCK(::cs_main, return std::ref(m_blockman)), ibd_stats, breakpoint_fnc)) {\n+        LogPrintf(\"[snapshot] failed to generate stats for validation coins db\\n\");\n+        // While this isn't a proablem with the snapshot per se, this condition\n+        // prevents us from validating the snapshot, so we should shut down and let the\n+        // use handle the issue manually.\n+        handleInvalidSnapshot();\n+        return {false, SnapshotCompletionError::STATS_FAILED};\n+    }\n+\n+    // Compare the background validation chainstate's UTXO set hash against the hard-coded\n+    // assumeutxo hash we expect.\n+    //\n+    // TODO: For belt-and-suspenders, we could cache an obfuscated version of the UTXO set\n+    // hash for the snapshot when it's loaded in its chainstate's leveldb. We should then\n+    // reference that here for an additional check.\n+    if (AssumeutxoHash{ibd_stats.hashSerialized} != au_data.hash_serialized) {\n+        LogPrintf(\"[snapshot] hash mismatch: actual=%s, expected=%s\\n\",\n+            ibd_stats.hashSerialized.ToString(),\n+            au_data.hash_serialized.ToString());\n+        handleInvalidSnapshot();\n+        return {false, SnapshotCompletionError::HASH_MISMATCH};\n+    }\n+\n+    LogPrintf(\"[snapshot] snapshot beginning at %s has been fully validated\\n\",\n+        snapshot_blockhash.ToString());\n+\n+    m_snapshot_validated = true;\n+\n+    // m_ibd_chainstate is the same as chainstate, per the assertion above.\n+    // Modification happens to the argument (this symbol) to make it explicit that\n+    // the caller might act specifically based on this value being different.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849942839",
      "id" : 849942839,
      "in_reply_to_id" : 834901932,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584yqRk3",
      "original_commit_id" : "328aa05c28fe9e5fff5d90e9b23bbbb5f6da1846",
      "original_line" : 5139,
      "original_position" : 138,
      "original_start_line" : 5137,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 941494747,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849942839/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-04-13T22:41:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849942839",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849943709"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849943709"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm now doing the \"cleanup\" (i.e. deletion of background chainstate data) on startup, and not shutdown. I'd like to experiment with doing deletion inline in a follow-up PR.",
      "commit_id" : "d0c4295ba218f315b04bbaf1b523631243571610",
      "created_at" : "2022-04-13T22:23:10Z",
      "diff_hunk" : "@@ -5051,6 +5172,34 @@ void ChainstateManager::Unload()\n     m_best_invalid = nullptr;\n }\n \n+void ChainstateManager::cleanup()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849943709",
      "id" : 849943709,
      "in_reply_to_id" : 835375721,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584yqRyd",
      "original_commit_id" : "328aa05c28fe9e5fff5d90e9b23bbbb5f6da1846",
      "original_line" : 5175,
      "original_position" : 155,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 941494747,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849943709/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-13T22:41:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849943709",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849945757"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849945757"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Both good points, both fixed. I'm now using `leveldb::DestroyDB()` to remove chainstate data.",
      "commit_id" : "d0c4295ba218f315b04bbaf1b523631243571610",
      "created_at" : "2022-04-13T22:27:20Z",
      "diff_hunk" : "@@ -5128,3 +5130,28 @@ bool ChainstateManager::DetectSnapshotChainstate(CTxMemPool* mempool)\n     this->InitializeChainstate(mempool, /*snapshot_blockhash*/ PathToSnapshotHash(*path));\n     return true;\n }\n+\n+bool CChainState::TeardownSnapshotDatadir()\n+{\n+    if (!m_from_snapshot_blockhash) {\n+        // Chainstate isn't based on a snapshot.\n+        return false;\n+    }\n+    std::optional<fs::path> snapshot_datadir = FindSnapshotChainstateDatadir();\n+\n+    if (!snapshot_datadir) {\n+        return false;\n+    }\n+\n+    uint256 datadir_hash = PathToSnapshotHash(*snapshot_datadir);\n+\n+    if (datadir_hash != *m_from_snapshot_blockhash) {\n+        LogPrintf(\"[snapshot] WARNING - unexpected blockhash for snapshot datadir (%s); expected %s\\n\",\n+            datadir_hash.ToString(), m_from_snapshot_blockhash->ToString());\n+        return false;\n+    }\n+\n+    LogPrintf(\"[snapshot] tearing down snapshot datadir %s\\n\", fs::PathToString(*snapshot_datadir));\n+    assert(fs::remove_all(*snapshot_datadir) > 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849945757",
      "id" : 849945757,
      "in_reply_to_id" : 832772895,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584yqSSd",
      "original_commit_id" : "fe09582ec34ff4d19bb2aa490ffd6ccca95e8480",
      "original_line" : 5155,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 941494747,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849945757/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-13T22:41:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849945757",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849945887"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849945887"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Removed comment",
      "commit_id" : "d0c4295ba218f315b04bbaf1b523631243571610",
      "created_at" : "2022-04-13T22:27:38Z",
      "diff_hunk" : "@@ -5174,3 +5323,44 @@ std::optional<int> ChainstateManager::getSnapshotHeight()\n     CBlockIndex* base = getSnapshotBaseBlock();\n     return base ? std::make_optional(base->nHeight) : std::nullopt;\n }\n+\n+void ChainstateManager::validatedSnapshotShutdownCleanup(\n+    fs::path new_chainstate, fs::path old_chainstate)\n+{\n+    assert(fs::exists(new_chainstate));\n+    assert(fs::exists(old_chainstate));\n+\n+    LogPrintf(\"[snapshot] deleting background chainstate directory (now unnecessary) (%s)\\n\",\n+        fs::PathToString(old_chainstate));\n+\n+    // Instead of deleting the background chainstate directly, rename the old\n+    // chainstate to chainstate_bak, rename the new chainstate into place, and then\n+    // delete to avoid likelihood of corruption from mid-delete shutdown.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849945887",
      "id" : 849945887,
      "in_reply_to_id" : 834903115,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584yqSUf",
      "original_commit_id" : "328aa05c28fe9e5fff5d90e9b23bbbb5f6da1846",
      "original_line" : 5338,
      "original_position" : 211,
      "original_start_line" : 5336,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 941494747,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849945887/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-04-13T22:41:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849945887",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849945970"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849945970"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed",
      "commit_id" : "d0c4295ba218f315b04bbaf1b523631243571610",
      "created_at" : "2022-04-13T22:27:49Z",
      "diff_hunk" : "@@ -492,6 +492,12 @@ class CChainState\n     //! Manages the UTXO set, which is a reflection of the contents of `m_chain`.\n     std::unique_ptr<CoinsViews> m_coins_views;\n \n+    //! This toggle exists for use when doing background validation for UTXO\n+    //! snapshots. It is set once the background validation chain reaches the\n+    //! same height as the base of the snapshot, and signals that we should no\n+    //! longer connect blocks to this chainstate.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849945970",
      "id" : 849945970,
      "in_reply_to_id" : 832804630,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584yqSVy",
      "original_commit_id" : "c703836160f3eca8073c22a1531bb98ad9666999",
      "original_line" : 498,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 941494747,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849945970/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-13T22:41:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849945970",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849946019"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849946019"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "d0c4295ba218f315b04bbaf1b523631243571610",
      "created_at" : "2022-04-13T22:27:54Z",
      "diff_hunk" : "@@ -772,11 +773,24 @@ class CChainState\n      * Only used during snapshot activation (within ChainstateManager) if the loaded\n      * snapshot does not validate.\n      */\n-    bool TeardownSnapshotDatadir() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+    bool teardownSnapshotDatadir() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n     friend ChainstateManager;\n };\n \n+\n+enum class SnapshotCompletionError {\n+    IBD_TOO_FAR,\n+    MISSING_CHAINPARAMS,\n+    STATS_FAILED,\n+    HASH_MISMATCH,\n+};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849946019",
      "id" : 849946019,
      "in_reply_to_id" : 846291146,
      "line" : 822,
      "node_id" : "PRRC_kwDOABII584yqSWj",
      "original_commit_id" : "328aa05c28fe9e5fff5d90e9b23bbbb5f6da1846",
      "original_line" : 822,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 117,
      "pull_request_review_id" : 941494747,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849946019/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-13T22:41:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849946019",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849946072"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849946072"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed, thanks",
      "commit_id" : "d0c4295ba218f315b04bbaf1b523631243571610",
      "created_at" : "2022-04-13T22:28:00Z",
      "diff_hunk" : "@@ -862,6 +862,10 @@ class ChainstateManager\n         CBlockIndex** ppindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n     friend CChainState;\n \n+    // Returns nullptr if no snapshot ahs been loaded.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849946072",
      "id" : 849946072,
      "in_reply_to_id" : 843078255,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584yqSXY",
      "original_commit_id" : "d8f32839cfbc8cbfe194d190bdc19fb3c4d6e32a",
      "original_line" : 865,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 941494747,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849946072/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-13T22:41:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849946072",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849947501"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849947501"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Renamed. Agree with your thoughts on the better design, and also agree that the path from here to there is not so long. I'd just prefer to wait until we actually need to revamp the design (e.g. multiple parallel background chainstates) to do all the code changes.",
      "commit_id" : "d0c4295ba218f315b04bbaf1b523631243571610",
      "created_at" : "2022-04-13T22:31:02Z",
      "diff_hunk" : "@@ -862,6 +862,10 @@ class ChainstateManager\n         CBlockIndex** ppindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n     friend CChainState;\n \n+    // Returns nullptr if no snapshot ahs been loaded.\n+    CBlockIndex* getSnapshotBaseBlock() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+    std::optional<int> getSnapshotHeight() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849947501",
      "id" : 849947501,
      "in_reply_to_id" : 835355848,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584yqStt",
      "original_commit_id" : "d8f32839cfbc8cbfe194d190bdc19fb3c4d6e32a",
      "original_line" : 867,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 941494747,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849947501/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-13T22:41:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849947501",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849947709"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849947709"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Wishywashy comment no more.",
      "commit_id" : "d0c4295ba218f315b04bbaf1b523631243571610",
      "created_at" : "2022-04-13T22:31:28Z",
      "diff_hunk" : "@@ -866,6 +872,15 @@ class ChainstateManager\n     CBlockIndex* getSnapshotBaseBlock() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n     std::optional<int> getSnapshotHeight() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! Return true if a chainstate is considered usable.\n+    //!\n+    //! This might be false for, say, a background validation chainstate which has",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r849947709",
      "id" : 849947709,
      "in_reply_to_id" : 832809804,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584yqSw9",
      "original_commit_id" : "c703836160f3eca8073c22a1531bb98ad9666999",
      "original_line" : 877,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 941494747,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849947709/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-13T22:41:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/849947709",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r854725086"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/854725086"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've changed the code to write the snapshot chainstate leveldb to `chainstate_snapshot`. A separate file within that directory called `base_blockhash` contains a serialized uint256 of what used to be in the directory name.",
      "commit_id" : "559b1ec7242f4636b03aa39b1ec1b629ff1414d7",
      "created_at" : "2022-04-21T02:30:16Z",
      "diff_hunk" : "@@ -5082,3 +5083,48 @@ void ChainstateManager::MaybeRebalanceCaches()\n         }\n     }\n }\n+\n+constexpr int SNAPSHOT_NAME_LEN = 75; // \"chainstate_\" + 64 hex characters for blockhash.\n+\n+static bool IsPathSnapshotDatadir(const fs::path& datadir_path)\n+{\n+    return fs::PathToString(datadir_path.filename()).length() == SNAPSHOT_NAME_LEN &&\n+        fs::PathToString(datadir_path.filename()).substr(0,11) == \"chainstate_\";\n+}\n+\n+static uint256 PathToSnapshotHash(const fs::path& datadir_path)\n+{\n+    assert(IsPathSnapshotDatadir(datadir_path));\n+    return uint256S(fs::PathToString(datadir_path.filename()).substr(11));\n+}\n+\n+static std::optional<fs::path> FindSnapshotChainstateDatadir()\n+{\n+    fs::path found;\n+\n+    for (fs::directory_iterator it(gArgs.GetDataDirNet()); it != fs::directory_iterator(); it++) {\n+        if (fs::is_directory(*it) && !fs::is_empty(*it) && IsPathSnapshotDatadir(it->path()))\n+        {\n+            if (found.empty()) {\n+                found = it->path();\n+                LogPrintf(\"[snapshot] found snapshot datadir %s\\n\", fs::PathToString(found));\n+            } else {\n+                LogPrintf(\"[snapshot] WARNING - detected multiple snapshot \" /* Continued */\n+                    \"datadirs (%s). This is not expected.\\n\", fs::PathToString(it->path()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r854725086",
      "id" : 854725086,
      "in_reply_to_id" : 832762880,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584y8hHe",
      "original_commit_id" : "becdbd6da4c6d7c9c658ffc38b1c9da1c89571a1",
      "original_line" : 5419,
      "original_position" : 39,
      "original_start_line" : 5112,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 947980724,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/854725086/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-04-21T02:30:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/854725086",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r854725915"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/854725915"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've simplified all this with the rename to `chainstate_snapshot`.",
      "commit_id" : "559b1ec7242f4636b03aa39b1ec1b629ff1414d7",
      "created_at" : "2022-04-21T02:32:30Z",
      "diff_hunk" : "@@ -5128,3 +5130,28 @@ bool ChainstateManager::DetectSnapshotChainstate(CTxMemPool* mempool)\n     this->InitializeChainstate(mempool, /*snapshot_blockhash*/ PathToSnapshotHash(*path));\n     return true;\n }\n+\n+bool CChainState::TeardownSnapshotDatadir()\n+{\n+    if (!m_from_snapshot_blockhash) {\n+        // Chainstate isn't based on a snapshot.\n+        return false;\n+    }\n+    std::optional<fs::path> snapshot_datadir = FindSnapshotChainstateDatadir();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r854725915",
      "id" : 854725915,
      "in_reply_to_id" : 834871079,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584y8hUb",
      "original_commit_id" : "fe09582ec34ff4d19bb2aa490ffd6ccca95e8480",
      "original_line" : 5140,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 947981710,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/854725915/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-21T02:32:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/854725915",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r855193716"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/855193716"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Perhaps it isn't actually necessary to hold `cs_main` throughout this if I set `m_stop_use` immediately, and then ensure all chainstate accesses are going through `isUsable()` checks...\r\n\r\nEdit: anyway, that's an optional optimization that can be looked at in a future PR.",
      "commit_id" : "559b1ec7242f4636b03aa39b1ec1b629ff1414d7",
      "created_at" : "2022-04-21T13:36:19Z",
      "diff_hunk" : "@@ -5230,6 +5256,136 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+// Currently, this function holds cs_main for its duration, which could be for\n+// multiple minutes due to the GetUTXOStats call. This hold is necessary\n+// because we need to avoid advancing the background validation chainstate\n+// farther than the snapshot base block - and this function is also invoked\n+// from within ConnectTip, i.e. from within ActivateBestChain, so cs_main is\n+// held anyway.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r855193716",
      "id" : 855193716,
      "line" : 5264,
      "node_id" : "PRRC_kwDOABII584y-Th0",
      "original_commit_id" : "2efe7c7ec82e7885e07140e1deb5b5e9d6869f1d",
      "original_line" : 5264,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 63,
      "pull_request_review_id" : 948636856,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/855193716/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-21T13:37:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/855193716",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r855354180"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/855354180"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"db: add StoragePath, Options to CDBWrapper/CCoinsViewDB\" (98fc81fbaaa02792b94264680cc0062ccfde9698)\r\n\r\nMinor: Might be a little nicer to combine two members these into a `std::optional<std::path>` member to avoid work when `StoragePath` is called, and to prevent possibility of class being in a confusing `m_is_memory && !m_path.empty()` state",
      "commit_id" : "559b1ec7242f4636b03aa39b1ec1b629ff1414d7",
      "created_at" : "2022-04-21T16:04:10Z",
      "diff_hunk" : "@@ -212,6 +217,12 @@ class CDBWrapper\n \n     std::vector<unsigned char> CreateObfuscateKey() const;\n \n+    //! path to filesystem storage\n+    const fs::path m_path;\n+\n+    //! whether or not the database resides in memory\n+    bool m_is_memory;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r855354180",
      "id" : 855354180,
      "line" : 224,
      "node_id" : "PRRC_kwDOABII584y-6tE",
      "original_commit_id" : "98fc81fbaaa02792b94264680cc0062ccfde9698",
      "original_line" : 224,
      "original_position" : 20,
      "original_start_line" : 220,
      "path" : "src/dbwrapper.h",
      "position" : 20,
      "pull_request_review_id" : 948865074,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/855354180/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 220,
      "start_side" : "RIGHT",
      "updated_at" : "2022-04-21T18:07:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/855354180",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r855365185"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/855365185"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add CChainState::destroyCoinsDB\" (f427976e6a3e024564fa824cc0578ee9b1285198)\r\n\r\nIs it necessary for this function to be passed a database path instead of getting the path from `this->CoinsDB->StoragePath()`? If so, would be helpful to add a comment saying when db_path might not the coinsdb path. If not, would be nice to eliminate the `db_path` argument to simplify and remove the possibility of bugs from passing the wrong path.",
      "commit_id" : "559b1ec7242f4636b03aa39b1ec1b629ff1414d7",
      "created_at" : "2022-04-21T16:16:26Z",
      "diff_hunk" : "@@ -5202,3 +5202,17 @@ void ChainstateManager::MaybeRebalanceCaches()\n         }\n     }\n }\n+\n+bool CChainState::destroyCoinsDB(const std::string& db_path)\n+{\n+    AssertLockHeld(::cs_main);\n+    LogPrintf(\"Destroying coins leveldb for %s\\n\", this->ToString());\n+    dbwrapper::Options options = Assert(m_coins_views)->m_dbview.Options();\n+    // We have to destruct leveldb::DB in order to release the db lock, otherwise\n+    // `DestroyDB` will fail. See `leveldb::~DBImpl()`.\n+    //\n+    // And this chainstate should no longer be considered usable anyway, so\n+    // teardown all coinsviews.\n+    m_coins_views.reset();\n+    return dbwrapper::DestroyDB(db_path, options).ok();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r855365185",
      "id" : 855365185,
      "line" : 5467,
      "node_id" : "PRRC_kwDOABII584y-9ZB",
      "original_commit_id" : "f427976e6a3e024564fa824cc0578ee9b1285198",
      "original_line" : 5217,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 16,
      "pull_request_review_id" : 948865074,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/855365185/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-21T18:07:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/855365185",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r855381780"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/855381780"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: rename snapshot chainstate dir\" (da4aaba0073108092f0dd0e02753eea253395c4e)\r\n\r\nJust IMO, but `snapshot_block_hash` might be a more descriptive name than `base_blockhash` for someone just looking at directory contents.",
      "commit_id" : "559b1ec7242f4636b03aa39b1ec1b629ff1414d7",
      "created_at" : "2022-04-21T16:35:31Z",
      "diff_hunk" : "@@ -4856,6 +4861,62 @@ const AssumeutxoData* ExpectedAssumeutxo(\n     return nullptr;\n }\n \n+//! The file in the snapshot chainstate dir which stores the base blockhash. This\n+//! is needed to reconstruct snapshot chainstates on init.\n+constexpr std::string_view SNAPSHOT_BLOCKHASH_FILENAME = \"base_blockhash\";",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r855381780",
      "id" : 855381780,
      "line" : 4888,
      "node_id" : "PRRC_kwDOABII584y_BcU",
      "original_commit_id" : "da4aaba0073108092f0dd0e02753eea253395c4e",
      "original_line" : 4866,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 34,
      "pull_request_review_id" : 948865074,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/855381780/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-21T18:07:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/855381780",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r855388880"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/855388880"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: remove snapshot datadirs upon validation failure\" (5e8879c402b23f8c3b71287a1f4393caa73dfcbd)\r\n\r\nThis function was added in previous commit and is moving this commit. Would be good to just add the function to the final location in previous commit (\"init: add utxo snapshot detection\", 94a484340be246e38ba40644f4e2ba1913d22240) and avoid the move.\r\n",
      "commit_id" : "559b1ec7242f4636b03aa39b1ec1b629ff1414d7",
      "created_at" : "2022-04-21T16:44:33Z",
      "diff_hunk" : "@@ -4917,6 +4917,17 @@ static std::optional<uint256> ReadSnapshotBaseBlockhash(fs::path datadir)\n     return base_blockhash;\n }\n \n+static std::optional<fs::path> FindSnapshotChainstateDatadir()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r855388880",
      "id" : 855388880,
      "line" : 4942,
      "node_id" : "PRRC_kwDOABII584y_DLQ",
      "original_commit_id" : "5e8879c402b23f8c3b71287a1f4393caa73dfcbd",
      "original_line" : 4920,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 4,
      "pull_request_review_id" : 948865074,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/855388880/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-21T18:07:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/855388880",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r855402238"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/855402238"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: remove snapshot datadirs upon validation failure\" (5e8879c402b23f8c3b71287a1f4393caa73dfcbd)\r\n\r\nMaybe this doesn't apply because our project uses assets in a nonstandard way, but I would only ever use C asserts to catch internal logic bugs which are supposed to be impossible. Would not use asserts to handle operating system errors, problems with I/O, or external libraries. \r\n\r\nSo I'd replace this assert and other `assert(removed)` in the function below to call AbortNode or throw runtime_error instead. Not sure if this required, though.",
      "commit_id" : "559b1ec7242f4636b03aa39b1ec1b629ff1414d7",
      "created_at" : "2022-04-21T17:00:19Z",
      "diff_hunk" : "@@ -4986,7 +4997,15 @@ bool ChainstateManager::ActivateSnapshot(\n         }\n     }\n     if (!snapshot_ok) {\n-        WITH_LOCK(::cs_main, this->MaybeRebalanceCaches());\n+        LOCK(::cs_main);\n+        this->MaybeRebalanceCaches();\n+\n+        // PopulateAndValidateSnapshot can return (in error) before the leveldb datadir\n+        // has been created, so only attempt removal if we got that far.\n+        if (auto snapshot_datadir = FindSnapshotChainstateDatadir()) {\n+            bool removed = snapshot_chainstate->removeSnapshotDatadir();\n+            assert(removed);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r855402238",
      "id" : 855402238,
      "line" : 5029,
      "node_id" : "PRRC_kwDOABII584y_Gb-",
      "original_commit_id" : "5e8879c402b23f8c3b71287a1f4393caa73dfcbd",
      "original_line" : 5007,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 30,
      "pull_request_review_id" : 948865074,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/855402238/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-21T18:07:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/855402238",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r855413625"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/855413625"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add CChainState::m_stop_use and ChainMan::isUsable\" (70455311b695e65b847031a90fa870ab50519b48)\r\n\r\nIt seems like a good thing to drop the `IsSnapshotValidated` call in this commit so the `GetAll()` method implementation is simpler and not tied to details of snapshot validation. But just to make sure new code is equivalent to previous code, is it true that `isUsable(m_ibd_chainstate)` implies `IsSnapshotValidated()`? Like if you added a `assert(!isUsable(m_ibd_chainstate) || IsSnapshotValidated())` here it would pass? Not suggesting to add this, just wondering.",
      "commit_id" : "559b1ec7242f4636b03aa39b1ec1b629ff1414d7",
      "created_at" : "2022-04-21T17:15:18Z",
      "diff_hunk" : "@@ -4814,12 +4814,8 @@ std::vector<CChainState*> ChainstateManager::GetAll()\n     LOCK(::cs_main);\n     std::vector<CChainState*> out;\n \n-    if (!IsSnapshotValidated() && m_ibd_chainstate) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r855413625",
      "id" : 855413625,
      "line" : 4812,
      "node_id" : "PRRC_kwDOABII584y_JN5",
      "original_commit_id" : "70455311b695e65b847031a90fa870ab50519b48",
      "original_line" : 4817,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 4,
      "pull_request_review_id" : 948865074,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/855413625/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-21T18:07:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/855413625",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r855415853"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/855415853"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add CChainState::m_stop_use and ChainMan::isUsable\" (70455311b695e65b847031a90fa870ab50519b48)\r\n\r\nIMO, this would be a little clearer as:\r\n\r\n```c++\r\n    if (!ibd_usable) {\r\n        // Snapshot must have been validated if ibd chain is out of use.\r\n        assert(snapshot_usable);\r\n        assert(m_snapshot_validated);\r\n    }\r\n```",
      "commit_id" : "559b1ec7242f4636b03aa39b1ec1b629ff1414d7",
      "created_at" : "2022-04-21T17:18:19Z",
      "diff_hunk" : "@@ -5263,17 +5259,27 @@ void ChainstateManager::Unload()\n void ChainstateManager::MaybeRebalanceCaches()\n {\n     AssertLockHeld(::cs_main);\n-    if (m_ibd_chainstate && !m_snapshot_chainstate) {\n+    bool ibd_usable = isUsable(m_ibd_chainstate.get());\n+    bool snapshot_usable = isUsable(m_snapshot_chainstate.get());\n+    assert(ibd_usable || snapshot_usable);\n+\n+    if (!ibd_usable && snapshot_usable) {\n+        // Snapshot must have been validated if snapshot chain is in use but ibd isn't.\n+        assert(m_snapshot_validated);\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r855415853",
      "id" : 855415853,
      "line" : 5425,
      "node_id" : "PRRC_kwDOABII584y_Jwt",
      "original_commit_id" : "70455311b695e65b847031a90fa870ab50519b48",
      "original_line" : 5269,
      "original_position" : 27,
      "original_start_line" : 5266,
      "path" : "src/validation.cpp",
      "position" : 27,
      "pull_request_review_id" : 948865074,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/855415853/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 5422,
      "start_side" : "RIGHT",
      "updated_at" : "2022-04-21T18:07:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/855415853",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r855423108"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/855423108"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add ChainMan logic for completing UTXO snapshot validation\" (2efe7c7ec82e7885e07140e1deb5b5e9d6869f1d)\r\n\r\nWould s/move/stop using/. The word \"move\" seems less clear here, and the actual useful details about the rename are logged later.",
      "commit_id" : "559b1ec7242f4636b03aa39b1ec1b629ff1414d7",
      "created_at" : "2022-04-21T17:27:46Z",
      "diff_hunk" : "@@ -5230,6 +5256,136 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+// Currently, this function holds cs_main for its duration, which could be for\n+// multiple minutes due to the GetUTXOStats call. This hold is necessary\n+// because we need to avoid advancing the background validation chainstate\n+// farther than the snapshot base block - and this function is also invoked\n+// from within ConnectTip, i.e. from within ActivateBestChain, so cs_main is\n+// held anyway.\n+//\n+// Eventually (TODO), we could somehow separate this function's runtime from\n+// maintenance of the active chain, but that will require giving each\n+// chainstate its own lock instead of using cs_main for everything.\n+SnapshotCompletionResult ChainstateManager::maybeCompleteSnapshotValidation(\n+      std::function<void(bilingual_str)> shutdown_fnc)\n+{\n+    AssertLockHeld(cs_main);\n+    if (m_ibd_chainstate.get() == &this->ActiveChainstate() ||\n+            !isUsable(m_snapshot_chainstate.get()) ||\n+            !isUsable(m_ibd_chainstate.get()) ||\n+            !m_ibd_chainstate->m_chain.Tip()) {\n+       // Nothing to do - this function only applies to the background\n+       // validation chainstate.\n+       return {false, {}};\n+    }\n+    assert(SnapshotBlockhash());\n+    uint256 snapshot_blockhash = *SnapshotBlockhash();\n+    CBlockIndex& index_new = *m_ibd_chainstate->m_chain.Tip();\n+\n+    if (index_new.GetBlockHash() != snapshot_blockhash) {\n+      LogPrintf(\"[snapshot] snapshot base blockhash does not match background chainstate tip - code error?\\n\");\n+       return {false, SnapshotCompletionError::BASE_BLOCKHASH_MISMATCH};\n+    }\n+\n+    int snapshot_tip_height = this->ActiveHeight();\n+    int snapshot_base_height = *getSnapshotBaseHeight();\n+\n+    auto handleInvalidSnapshot = [&]() EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        bilingual_str user_error = _(strprintf(\n+            \"%s failed to validate the -assumeutxo snapshot state. \"\n+            \"This indicates a hardware problem, or a bug in the software, or a \"\n+            \"bad software modification that allowed an invalid snapshot to be \"\n+            \"loaded. As a result of this, the node will shut down and move any \"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r855423108",
      "id" : 855423108,
      "line" : 5298,
      "node_id" : "PRRC_kwDOABII584y_LiE",
      "original_commit_id" : "2efe7c7ec82e7885e07140e1deb5b5e9d6869f1d",
      "original_line" : 5298,
      "original_position" : 97,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 97,
      "pull_request_review_id" : 948865074,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/855423108/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-21T18:07:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/855423108",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r855424313"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/855424313"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add ChainMan logic for completing UTXO snapshot validation\" (2efe7c7ec82e7885e07140e1deb5b5e9d6869f1d)\r\n\r\nI believe should log `.original`, not `.translated`",
      "commit_id" : "559b1ec7242f4636b03aa39b1ec1b629ff1414d7",
      "created_at" : "2022-04-21T17:29:22Z",
      "diff_hunk" : "@@ -5230,6 +5256,136 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+// Currently, this function holds cs_main for its duration, which could be for\n+// multiple minutes due to the GetUTXOStats call. This hold is necessary\n+// because we need to avoid advancing the background validation chainstate\n+// farther than the snapshot base block - and this function is also invoked\n+// from within ConnectTip, i.e. from within ActivateBestChain, so cs_main is\n+// held anyway.\n+//\n+// Eventually (TODO), we could somehow separate this function's runtime from\n+// maintenance of the active chain, but that will require giving each\n+// chainstate its own lock instead of using cs_main for everything.\n+SnapshotCompletionResult ChainstateManager::maybeCompleteSnapshotValidation(\n+      std::function<void(bilingual_str)> shutdown_fnc)\n+{\n+    AssertLockHeld(cs_main);\n+    if (m_ibd_chainstate.get() == &this->ActiveChainstate() ||\n+            !isUsable(m_snapshot_chainstate.get()) ||\n+            !isUsable(m_ibd_chainstate.get()) ||\n+            !m_ibd_chainstate->m_chain.Tip()) {\n+       // Nothing to do - this function only applies to the background\n+       // validation chainstate.\n+       return {false, {}};\n+    }\n+    assert(SnapshotBlockhash());\n+    uint256 snapshot_blockhash = *SnapshotBlockhash();\n+    CBlockIndex& index_new = *m_ibd_chainstate->m_chain.Tip();\n+\n+    if (index_new.GetBlockHash() != snapshot_blockhash) {\n+      LogPrintf(\"[snapshot] snapshot base blockhash does not match background chainstate tip - code error?\\n\");\n+       return {false, SnapshotCompletionError::BASE_BLOCKHASH_MISMATCH};\n+    }\n+\n+    int snapshot_tip_height = this->ActiveHeight();\n+    int snapshot_base_height = *getSnapshotBaseHeight();\n+\n+    auto handleInvalidSnapshot = [&]() EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        bilingual_str user_error = _(strprintf(\n+            \"%s failed to validate the -assumeutxo snapshot state. \"\n+            \"This indicates a hardware problem, or a bug in the software, or a \"\n+            \"bad software modification that allowed an invalid snapshot to be \"\n+            \"loaded. As a result of this, the node will shut down and move any \"\n+            \"state that was built on the snapshot, resetting the chain height \"\n+            \"from %d to %d. On the next \"\n+            \"restart, the node will resume syncing from %d \"\n+            \"without using any snapshot data. \"\n+            \"Please report this incident to %s, including how you obtained the snapshot.\",\n+            PACKAGE_NAME, snapshot_tip_height, snapshot_base_height, snapshot_base_height, PACKAGE_BUGREPORT\n+        ).c_str());\n+\n+        LogPrintf(\"[snapshot] !!! %s\\n\", user_error.translated);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r855424313",
      "id" : 855424313,
      "line" : 5307,
      "node_id" : "PRRC_kwDOABII584y_L05",
      "original_commit_id" : "2efe7c7ec82e7885e07140e1deb5b5e9d6869f1d",
      "original_line" : 5307,
      "original_position" : 106,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 106,
      "pull_request_review_id" : 948865074,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/855424313/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-21T18:07:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/855424313",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r855429335"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/855429335"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add ChainMan logic for completing UTXO snapshot validation\" (2efe7c7ec82e7885e07140e1deb5b5e9d6869f1d)\r\n\r\nCurious why the code doesn't just assert `index_new.nHeight <= snapshot_base_height`. Is it possible for chainstates  that would trigger this to even be loaded? If so, might make be better to check chainstate heights early when they are loaded than to handle it later as part of validation.",
      "commit_id" : "559b1ec7242f4636b03aa39b1ec1b629ff1414d7",
      "created_at" : "2022-04-21T17:35:30Z",
      "diff_hunk" : "@@ -5230,6 +5256,136 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+// Currently, this function holds cs_main for its duration, which could be for\n+// multiple minutes due to the GetUTXOStats call. This hold is necessary\n+// because we need to avoid advancing the background validation chainstate\n+// farther than the snapshot base block - and this function is also invoked\n+// from within ConnectTip, i.e. from within ActivateBestChain, so cs_main is\n+// held anyway.\n+//\n+// Eventually (TODO), we could somehow separate this function's runtime from\n+// maintenance of the active chain, but that will require giving each\n+// chainstate its own lock instead of using cs_main for everything.\n+SnapshotCompletionResult ChainstateManager::maybeCompleteSnapshotValidation(\n+      std::function<void(bilingual_str)> shutdown_fnc)\n+{\n+    AssertLockHeld(cs_main);\n+    if (m_ibd_chainstate.get() == &this->ActiveChainstate() ||\n+            !isUsable(m_snapshot_chainstate.get()) ||\n+            !isUsable(m_ibd_chainstate.get()) ||\n+            !m_ibd_chainstate->m_chain.Tip()) {\n+       // Nothing to do - this function only applies to the background\n+       // validation chainstate.\n+       return {false, {}};\n+    }\n+    assert(SnapshotBlockhash());\n+    uint256 snapshot_blockhash = *SnapshotBlockhash();\n+    CBlockIndex& index_new = *m_ibd_chainstate->m_chain.Tip();\n+\n+    if (index_new.GetBlockHash() != snapshot_blockhash) {\n+      LogPrintf(\"[snapshot] snapshot base blockhash does not match background chainstate tip - code error?\\n\");\n+       return {false, SnapshotCompletionError::BASE_BLOCKHASH_MISMATCH};\n+    }\n+\n+    int snapshot_tip_height = this->ActiveHeight();\n+    int snapshot_base_height = *getSnapshotBaseHeight();\n+\n+    auto handleInvalidSnapshot = [&]() EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        bilingual_str user_error = _(strprintf(\n+            \"%s failed to validate the -assumeutxo snapshot state. \"\n+            \"This indicates a hardware problem, or a bug in the software, or a \"\n+            \"bad software modification that allowed an invalid snapshot to be \"\n+            \"loaded. As a result of this, the node will shut down and move any \"\n+            \"state that was built on the snapshot, resetting the chain height \"\n+            \"from %d to %d. On the next \"\n+            \"restart, the node will resume syncing from %d \"\n+            \"without using any snapshot data. \"\n+            \"Please report this incident to %s, including how you obtained the snapshot.\",\n+            PACKAGE_NAME, snapshot_tip_height, snapshot_base_height, snapshot_base_height, PACKAGE_BUGREPORT\n+        ).c_str());\n+\n+        LogPrintf(\"[snapshot] !!! %s\\n\", user_error.translated);\n+        LogPrintf(\"[snapshot] deleting snapshot, reverting to validated chain, and stopping node\\n\");\n+\n+        m_active_chainstate = m_ibd_chainstate.get();\n+        m_snapshot_chainstate->m_stop_use = true;\n+        assert(!isUsable(m_snapshot_chainstate.get()));\n+\n+        m_snapshot_chainstate->invalidateSnapshotDatadir();\n+\n+        shutdown_fnc(user_error);\n+    };\n+\n+   if (index_new.nHeight > snapshot_base_height) {\n+      LogPrintf(\"[snapshot] something is wrong! validation chain \" /* Continued */\n+             \"should not have continued past the snapshot origin\\n\");\n+         handleInvalidSnapshot();\n+         return {false, SnapshotCompletionError::IBD_TOO_FAR};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r855429335",
      "id" : 855429335,
      "line" : 5323,
      "node_id" : "PRRC_kwDOABII584y_NDX",
      "original_commit_id" : "2efe7c7ec82e7885e07140e1deb5b5e9d6869f1d",
      "original_line" : 5323,
      "original_position" : 122,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 122,
      "pull_request_review_id" : 948865074,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/855429335/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-21T18:07:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/855429335",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r855445552"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/855445552"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add ChainMan logic for completing UTXO snapshot validation\" (2efe7c7ec82e7885e07140e1deb5b5e9d6869f1d)\r\n\r\nWould be good to log that the rename fails, if it fails. Not critical, but could avoid confusion figuring out what is happening from the logs if two snapshots fail to validate.",
      "commit_id" : "559b1ec7242f4636b03aa39b1ec1b629ff1414d7",
      "created_at" : "2022-04-21T17:52:27Z",
      "diff_hunk" : "@@ -5357,6 +5523,24 @@ bool CChainState::removeSnapshotDatadir()\n     return destroyed && !fs::exists(snapshot_datadir);\n }\n \n+void CChainState::invalidateSnapshotDatadir()\n+{\n+    AssertLockHeld(::cs_main);\n+    // Should never be called on a non-snapshot chainstate.\n+    assert(m_from_snapshot_blockhash);\n+    fs::path snapshot_datadir = *FindSnapshotChainstateDatadir();\n+    assert(fs::exists(snapshot_datadir));\n+\n+    // Coins views no longer usable.\n+    m_coins_views.reset();\n+\n+    auto invalid_path = snapshot_datadir + \"_INVALID\";\n+    std::string dbpath = fs::PathToString(snapshot_datadir);\n+    std::string target = fs::PathToString(invalid_path);\n+    LogPrintf(\"[snapshot] renaming snapshot datadir %s to %s\\n\", dbpath, target);\n+    fs::rename(snapshot_datadir, invalid_path);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r855445552",
      "id" : 855445552,
      "line" : 5541,
      "node_id" : "PRRC_kwDOABII584y_RAw",
      "original_commit_id" : "2efe7c7ec82e7885e07140e1deb5b5e9d6869f1d",
      "original_line" : 5541,
      "original_position" : 240,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 240,
      "pull_request_review_id" : 948865074,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/855445552/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-21T18:07:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/855445552",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r855452262"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/855452262"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add ChainMan logic for completing UTXO snapshot validation\" (2efe7c7ec82e7885e07140e1deb5b5e9d6869f1d)\r\n\r\nI'm suprised you can just rename directories while leveldb is still using them. If this works, I guess it's ok, but I think more ideally CChainstate objects would have `Destroy()` and `Rename(new_name)` methods and would do these operations in a safe way without ChainStateManager being involved at such a low level.",
      "commit_id" : "559b1ec7242f4636b03aa39b1ec1b629ff1414d7",
      "created_at" : "2022-04-21T18:01:22Z",
      "diff_hunk" : "@@ -5369,3 +5553,62 @@ std::optional<int> ChainstateManager::getSnapshotBaseHeight()\n     CBlockIndex* base = getSnapshotBaseBlock();\n     return base ? std::make_optional(base->nHeight) : std::nullopt;\n }\n+\n+void ChainstateManager::reset()\n+{\n+    m_ibd_chainstate.reset();\n+    m_snapshot_chainstate.reset();\n+    m_active_chainstate = nullptr;\n+    m_snapshot_validated = false;\n+}\n+\n+void ChainstateManager::validatedSnapshotCleanup()\n+{\n+    AssertLockHeld(::cs_main);\n+    auto get_storage_path = [](auto& chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) -> std::optional<fs::path> {\n+        if (!(chainstate && chainstate->HasCoinsViews())) {\n+            return {};\n+        }\n+        return chainstate->CoinsDB().StoragePath();\n+    };\n+    std::optional<fs::path> ibd_chainstate_path_maybe = get_storage_path(m_ibd_chainstate);\n+    std::optional<fs::path> snapshot_chainstate_path_maybe = get_storage_path(m_snapshot_chainstate);\n+    bool should_cleanup_snapshot = m_snapshot_chainstate && m_snapshot_validated;\n+\n+    if (!should_cleanup_snapshot) {\n+        // No need to clean up.\n+        return;\n+    }\n+    // If either path doesn't exist, that means at least one of the chainstates\n+    // is in-memory, in which case we can't do on-disk cleanup. You'd better be\n+    // in a unittest!\n+    if (!ibd_chainstate_path_maybe || !snapshot_chainstate_path_maybe) {\n+        LogPrintf(\"[snapshot] snapshot chainstate cleanup cannot happen with \" /* Continued */\n+                \"in-memory chainstates - you are testing, right?\\n\");\n+        return;\n+    }\n+\n+    auto snapshot_chainstate_path = *snapshot_chainstate_path_maybe;\n+    auto ibd_chainstate_path = *ibd_chainstate_path_maybe;\n+\n+    assert(fs::exists(snapshot_chainstate_path));\n+    assert(fs::exists(ibd_chainstate_path));\n+\n+    LogPrintf(\"[snapshot] deleting background chainstate directory (now unnecessary) (%s)\\n\",\n+        fs::PathToString(ibd_chainstate_path));\n+\n+    fs::path tmp_old{ibd_chainstate_path + \"_todelete\"};\n+\n+    fs::rename(ibd_chainstate_path, tmp_old);\n+    fs::rename(snapshot_chainstate_path, ibd_chainstate_path);\n+\n+    LogPrintf(\"[snapshot] moving snapshot chainstate (%s) to \" /* Continued */\n+        \"default chainstate directory (%s)\\n\",\n+        fs::PathToString(snapshot_chainstate_path), fs::PathToString(ibd_chainstate_path));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r855452262",
      "id" : 855452262,
      "line" : 5607,
      "node_id" : "PRRC_kwDOABII584y_Spm",
      "original_commit_id" : "2efe7c7ec82e7885e07140e1deb5b5e9d6869f1d",
      "original_line" : 5607,
      "original_position" : 301,
      "original_start_line" : 5600,
      "path" : "src/validation.cpp",
      "position" : 301,
      "pull_request_review_id" : 948865074,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/855452262/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 5600,
      "start_side" : "RIGHT",
      "updated_at" : "2022-04-21T18:07:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/855452262",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r858859350"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/858859350"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add ChainMan logic for completing UTXO snapshot validation\" (2efe7c7ec82e7885e07140e1deb5b5e9d6869f1d)\r\n\r\nWould it make sense to `assert(!chainman.IsSnapshotValidated())` here?\r\n\r\n",
      "commit_id" : "559b1ec7242f4636b03aa39b1ec1b629ff1414d7",
      "created_at" : "2022-04-26T15:26:59Z",
      "diff_hunk" : "@@ -34,12 +34,8 @@ std::optional<ChainstateLoadingError> LoadChainstate(bool fReset,\n     // Load a chain created from a UTXO snapshot, if any exist.\n     chainman.DetectSnapshotChainstate(mempool);\n \n-    // If we're not using a snapshot or we haven't fully validated it yet,\n-    // create a validation chainstate.\n-    if (!chainman.IsSnapshotValidated()) {\n-        LogPrintf(\"Loading validation chainstate\\n\");\n-        chainman.InitializeChainstate(mempool);\n-    }\n+    // Load the fully-validated chainstate.\n+    chainman.InitializeChainstate(mempool);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r858859350",
      "id" : 858859350,
      "line" : 38,
      "node_id" : "PRRC_kwDOABII584zMSdW",
      "original_commit_id" : "2efe7c7ec82e7885e07140e1deb5b5e9d6869f1d",
      "original_line" : 38,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : 11,
      "pull_request_review_id" : 953596131,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/858859350/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-26T18:04:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/858859350",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r858859925"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/858859925"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add ChainMan logic for completing UTXO snapshot validation\" (2efe7c7ec82e7885e07140e1deb5b5e9d6869f1d)\r\n\r\nStray comment?",
      "commit_id" : "559b1ec7242f4636b03aa39b1ec1b629ff1414d7",
      "created_at" : "2022-04-26T15:27:31Z",
      "diff_hunk" : "@@ -858,7 +893,10 @@ class ChainstateManager\n     CChainState* m_active_chainstate GUARDED_BY(::cs_main) {nullptr};\n \n     //! If true, the assumed-valid chainstate has been fully validated\n-    //! by the background validation chainstate.\n+    //! by the background validation chainstate. This will trigger shutdown\n+    //! logic.\n+    //!\n+    //! @sa validatedSnapshotCleanup()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r858859925",
      "id" : 858859925,
      "line" : 899,
      "node_id" : "PRRC_kwDOABII584zMSmV",
      "original_commit_id" : "2efe7c7ec82e7885e07140e1deb5b5e9d6869f1d",
      "original_line" : 899,
      "original_position" : 74,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 74,
      "pull_request_review_id" : 953596131,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/858859925/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-26T18:04:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/858859925",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r858957866"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/858957866"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add ChainMan logic for completing UTXO snapshot validation\" (2efe7c7ec82e7885e07140e1deb5b5e9d6869f1d)\r\n\r\nWas this check ever necessary to begin with when it was added in commit 94a484340be246e38ba40644f4e2ba1913d22240? It seems like IsSnapshotValidated would have always been false this whole time. Would probably be good to backport this change to the earlier commit.\r\n\r\n",
      "commit_id" : "559b1ec7242f4636b03aa39b1ec1b629ff1414d7",
      "created_at" : "2022-04-26T17:06:06Z",
      "diff_hunk" : "@@ -34,12 +34,8 @@ std::optional<ChainstateLoadingError> LoadChainstate(bool fReset,\n     // Load a chain created from a UTXO snapshot, if any exist.\n     chainman.DetectSnapshotChainstate(mempool);\n \n-    // If we're not using a snapshot or we haven't fully validated it yet,\n-    // create a validation chainstate.\n-    if (!chainman.IsSnapshotValidated()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r858957866",
      "id" : 858957866,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584zMqgq",
      "original_commit_id" : "2efe7c7ec82e7885e07140e1deb5b5e9d6869f1d",
      "original_line" : 39,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : 6,
      "pull_request_review_id" : 953596131,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/858957866/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-26T18:04:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/858957866",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r858966520"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/858966520"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add ChainMan logic for completing UTXO snapshot validation\" (2efe7c7ec82e7885e07140e1deb5b5e9d6869f1d)\r\n\r\nThis is a little hard to follow, and maybe it's the simplest approach, but I wonder if `LoadChainstate` could just handle snapshot validated case internally. Treating SNAPSHOT_VALIDATION_COMPLETE like an error code when it doesn't really indicate a problem, and using `continue` to break out of a switch statement inside of a while loop seem like messy complications that could be nice to avoid, if there's a more straightforward way.",
      "commit_id" : "559b1ec7242f4636b03aa39b1ec1b629ff1414d7",
      "created_at" : "2022-04-26T17:16:41Z",
      "diff_hunk" : "@@ -1474,6 +1474,13 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n                 break;\n             case ChainstateLoadingError::SHUTDOWN_PROBED:\n                 break;\n+            case ChainstateLoadingError::SNAPSHOT_VALIDATION_COMPLETE:\n+                // Retry LoadChainstate now that the fully-validated snapshot\n+                // chainstate datadir has been moved to the `chainstate` directory.\n+                continue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r858966520",
      "id" : 858966520,
      "line" : 1480,
      "node_id" : "PRRC_kwDOABII584zMsn4",
      "original_commit_id" : "2efe7c7ec82e7885e07140e1deb5b5e9d6869f1d",
      "original_line" : 1480,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 7,
      "pull_request_review_id" : 953596131,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/858966520/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-26T18:04:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/858966520",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r858987637"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/858987637"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add ChainMan logic for completing UTXO snapshot validation\" (2efe7c7ec82e7885e07140e1deb5b5e9d6869f1d)\r\n\r\nMaybe this is the simplest approach for now, but could you add a comment about what will cause this case to happen and what needs to be done to handle it. It seems like it would be an unusual for background validation to complete on startup. Would it basically only happen if the node was shut down after the background chainstate was validated but before it was deleted?\r\n\r\nAlso wondering why it is it even necessary to call maybeCompleteSnapshotValidation here when there is already a call in connectTip()\r\n\r\nAlso, is this approach as efficient as it could be, or is it doing unnecessary work like calling UnloadBlockIndex / LoadBlockIndex. SNAPSHOT_VALIDATION_COMPLETE causes LoadChainstate to be called again, but it's unclear which parts of LoadChainstate actually need to re-run\r\n\r\nI think it would be good to add a code comment to explain this case more and answer some of these questions.",
      "commit_id" : "559b1ec7242f4636b03aa39b1ec1b629ff1414d7",
      "created_at" : "2022-04-26T17:41:44Z",
      "diff_hunk" : "@@ -137,6 +133,20 @@ std::optional<ChainstateLoadingError> LoadChainstate(bool fReset,\n         }\n     }\n \n+    // If a snapshot chainstate was fully validated by a background chainstate during\n+    // the last run, detect it here and clean up the now-unneeded background\n+    // chainstate.\n+    auto snapshot_completion = chainman.maybeCompleteSnapshotValidation();\n+\n+    if (snapshot_completion.completed) {\n+        LogPrintf(\"[snapshot] cleaning up unneeded background chainstate, then reinitializing\\n\");\n+        chainman.validatedSnapshotCleanup();\n+        chainman.reset();\n+        return ChainstateLoadingError::SNAPSHOT_VALIDATION_COMPLETE;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r858987637",
      "id" : 858987637,
      "line" : 145,
      "node_id" : "PRRC_kwDOABII584zMxx1",
      "original_commit_id" : "2efe7c7ec82e7885e07140e1deb5b5e9d6869f1d",
      "original_line" : 145,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : 28,
      "pull_request_review_id" : 953596131,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/858987637/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-26T18:04:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/858987637",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r858989866"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/858989866"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add ChainMan logic for completing UTXO snapshot validation\" (2efe7c7ec82e7885e07140e1deb5b5e9d6869f1d)\r\n\r\nJust a suggestion, but maybe s/ABCStep/ActivateBestChainStep/ to help with grepping.",
      "commit_id" : "559b1ec7242f4636b03aa39b1ec1b629ff1414d7",
      "created_at" : "2022-04-26T17:44:13Z",
      "diff_hunk" : "@@ -2998,6 +3010,15 @@ bool CChainState::ActivateBestChain(BlockValidationState& state, std::shared_ptr\n                     assert(trace.pblock && trace.pindex);\n                     GetMainSignals().BlockConnected(trace.pblock, trace.pindex);\n                 }\n+\n+                // This will have been toggled in\n+                // ABCStep -> ConnectTip -> maybeCompleteSnapshotValidation,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r858989866",
      "id" : 858989866,
      "line" : 3015,
      "node_id" : "PRRC_kwDOABII584zMyUq",
      "original_commit_id" : "2efe7c7ec82e7885e07140e1deb5b5e9d6869f1d",
      "original_line" : 3015,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 32,
      "pull_request_review_id" : 953596131,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/858989866/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-26T18:04:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/858989866",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r860002662"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/860002662"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah, definitely agree. I'll take a look.",
      "commit_id" : "559b1ec7242f4636b03aa39b1ec1b629ff1414d7",
      "created_at" : "2022-04-27T16:27:54Z",
      "diff_hunk" : "@@ -1474,6 +1474,13 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n                 break;\n             case ChainstateLoadingError::SHUTDOWN_PROBED:\n                 break;\n+            case ChainstateLoadingError::SNAPSHOT_VALIDATION_COMPLETE:\n+                // Retry LoadChainstate now that the fully-validated snapshot\n+                // chainstate datadir has been moved to the `chainstate` directory.\n+                continue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r860002662",
      "id" : 860002662,
      "in_reply_to_id" : 858966520,
      "line" : 1480,
      "node_id" : "PRRC_kwDOABII584zQplm",
      "original_commit_id" : "2efe7c7ec82e7885e07140e1deb5b5e9d6869f1d",
      "original_line" : 1480,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 7,
      "pull_request_review_id" : 955195630,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/860002662/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-27T16:27:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/860002662",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r860023299"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/860023299"
         }
      },
      "author_association" : "MEMBER",
      "body" : "While I agree, there are a few users of `CDBWrapper` outside the scope of this PR (`BaseIndex::DB`, `CBlockTreeDB`) - they seem to construct with non-empty paths even when being used in memory, so making this change will involve a few out-of-scope modifications. I agree with you that this is the right way to go, and would be a nice follow-on.",
      "commit_id" : "559b1ec7242f4636b03aa39b1ec1b629ff1414d7",
      "created_at" : "2022-04-27T16:49:24Z",
      "diff_hunk" : "@@ -212,6 +217,12 @@ class CDBWrapper\n \n     std::vector<unsigned char> CreateObfuscateKey() const;\n \n+    //! path to filesystem storage\n+    const fs::path m_path;\n+\n+    //! whether or not the database resides in memory\n+    bool m_is_memory;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r860023299",
      "id" : 860023299,
      "in_reply_to_id" : 855354180,
      "line" : 224,
      "node_id" : "PRRC_kwDOABII584zQuoD",
      "original_commit_id" : "98fc81fbaaa02792b94264680cc0062ccfde9698",
      "original_line" : 224,
      "original_position" : 20,
      "original_start_line" : 220,
      "path" : "src/dbwrapper.h",
      "position" : 20,
      "pull_request_review_id" : 955224378,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/860023299/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 220,
      "start_side" : "RIGHT",
      "updated_at" : "2022-04-27T16:49:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/860023299",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r860100811"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/860100811"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm going to stick with `base_blockhash` just because it makes grepping for `{m_,}base_blockhash` easier, which is the equivalent data in `SnapshotMetadata`.",
      "commit_id" : "559b1ec7242f4636b03aa39b1ec1b629ff1414d7",
      "created_at" : "2022-04-27T17:57:36Z",
      "diff_hunk" : "@@ -4856,6 +4861,62 @@ const AssumeutxoData* ExpectedAssumeutxo(\n     return nullptr;\n }\n \n+//! The file in the snapshot chainstate dir which stores the base blockhash. This\n+//! is needed to reconstruct snapshot chainstates on init.\n+constexpr std::string_view SNAPSHOT_BLOCKHASH_FILENAME = \"base_blockhash\";",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r860100811",
      "id" : 860100811,
      "in_reply_to_id" : 855381780,
      "line" : 4888,
      "node_id" : "PRRC_kwDOABII584zRBjL",
      "original_commit_id" : "da4aaba0073108092f0dd0e02753eea253395c4e",
      "original_line" : 4866,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 34,
      "pull_request_review_id" : 955330342,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/860100811/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-27T17:57:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/860100811",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   }
]
