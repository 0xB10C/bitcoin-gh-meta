[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#24299](https://github.com/bitcoin/bitcoin/pull/24299) (validation, refactor: UnloadBlockIndex and ChainstateManager::Reset thread safety cleanups by jonatack)\n* [#24177](https://github.com/bitcoin/bitcoin/pull/24177) (validation, refactor: add missing thread safety lock assertions by jonatack)\n* [#24008](https://github.com/bitcoin/bitcoin/pull/24008) (assumeutxo: net_processing changes by jamesob)\n* [#20030](https://github.com/bitcoin/bitcoin/pull/20030) (validation: Remove useless call to mempool->clear() by MarcoFalke)\n* [#19888](https://github.com/bitcoin/bitcoin/pull/19888) (rpc, test: Improve getblockstats for unspendables by fjahr)\n* [#15606](https://github.com/bitcoin/bitcoin/pull/15606) (assumeutxo by jamesob)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-02-02T03:54:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#issuecomment-1027550061",
      "id" : 1027550061,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24232",
      "node_id" : "IC_kwDOABII5849Pytt",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1027550061/reactions"
      },
      "updated_at" : "2022-02-11T15:32:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1027550061",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r797299227"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/797299227"
         }
      },
      "author_association" : "MEMBER",
      "body" : "any reason this is a reference. `memepool` at the call site is already a pointer to allow setting it to nullptr",
      "commit_id" : "08f4bf18b165464dea801b81cf857a9fd398e8e7",
      "created_at" : "2022-02-02T06:09:26Z",
      "diff_hunk" : "@@ -977,12 +1014,27 @@ class ChainstateManager\n     void Unload() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n     //! Clear (deconstruct) chainstate data.\n-    void Reset();\n+    void Reset() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n     //! Check to see if caches are out of balance and if so, call\n     //! ResizeCoinsCaches() as needed.\n     void MaybeRebalanceCaches() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! When starting up, search the datadir for a chainstate based on a UTXO\n+    //! snapshot that is in the process of being validated.\n+    bool DetectSnapshotChainstate(CTxMemPool& mempool) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r797299227",
      "id" : 797299227,
      "line" : 1025,
      "node_id" : "PRRC_kwDOABII584vhdIb",
      "original_commit_id" : "08f4bf18b165464dea801b81cf857a9fd398e8e7",
      "original_line" : 1025,
      "original_position" : 119,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 119,
      "pull_request_review_id" : 870119022,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/797299227/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-02T06:12:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/797299227",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r797299587"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/797299587"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Any reason this is a pointer? This can't be null, neither at the call site nor inside the function.",
      "commit_id" : "08f4bf18b165464dea801b81cf857a9fd398e8e7",
      "created_at" : "2022-02-02T06:10:27Z",
      "diff_hunk" : "@@ -977,12 +1014,27 @@ class ChainstateManager\n     void Unload() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n     //! Clear (deconstruct) chainstate data.\n-    void Reset();\n+    void Reset() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n     //! Check to see if caches are out of balance and if so, call\n     //! ResizeCoinsCaches() as needed.\n     void MaybeRebalanceCaches() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! When starting up, search the datadir for a chainstate based on a UTXO\n+    //! snapshot that is in the process of being validated.\n+    bool DetectSnapshotChainstate(CTxMemPool& mempool) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+\n+    //! If we completed background validation of the loaded snapshot during the\n+    //! last run but didn't for whatever reason shutdown properly, ensure that\n+    //! the background validation chainstate is marked accordingly.\n+    void CheckForUncleanShutdown() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+\n+    //! Complete validation of the active snapshot if `chainstate` is in the process of\n+    //! background validating and has reached the base block of the snapshot.\n+    bool MaybeCompleteSnapshotValidation(\n+        CChainState& chainstate,\n+        CBlockIndex* pindexNew) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r797299587",
      "id" : 797299587,
      "line" : 1036,
      "node_id" : "PRRC_kwDOABII584vhdOD",
      "original_commit_id" : "08f4bf18b165464dea801b81cf857a9fd398e8e7",
      "original_line" : 1036,
      "original_position" : 130,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 130,
      "pull_request_review_id" : 870119022,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/797299587/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-02T06:12:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/797299587",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r797299792"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/797299792"
         }
      },
      "author_association" : "MEMBER",
      "body" : "any reason to add the assert?",
      "commit_id" : "08f4bf18b165464dea801b81cf857a9fd398e8e7",
      "created_at" : "2022-02-02T06:11:10Z",
      "diff_hunk" : "@@ -28,10 +28,19 @@ std::optional<ChainstateLoadingError> LoadChainstate(bool fReset,\n     };\n \n     LOCK(cs_main);\n-    chainman.InitializeChainstate(mempool);\n     chainman.m_total_coinstip_cache = nCoinCacheUsage;\n     chainman.m_total_coinsdb_cache = nCoinDBCache;\n \n+    // Load a chain created from a UTXO snapshot, if any exist.\n+    chainman.DetectSnapshotChainstate(*Assert(mempool));\n+\n+    // If we're not using a snapshot or we haven't fully validated it yet,\n+    // create a validation chainstate.\n+    if (!chainman.IsSnapshotValidated()) {\n+        LogPrintf(\"Loading validation chainstate\\n\");\n+        chainman.InitializeChainstate(Assert(mempool));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r797299792",
      "id" : 797299792,
      "line" : 41,
      "node_id" : "PRRC_kwDOABII584vhdRQ",
      "original_commit_id" : "08f4bf18b165464dea801b81cf857a9fd398e8e7",
      "original_line" : 41,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : 15,
      "pull_request_review_id" : 870119022,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/797299792/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-02T06:12:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/797299792",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the quick feedback Mco. \r\n\r\nThe test failure was actually due to removing a commit that I'd forgotten the use for. Basically, because we're now calling MaybeRebalanceCaches in LoadChainstate, that prompts a FlushStateToDisk call before the block index is loaded, which trips some UB. \r\n\r\nThe bounds check in https://github.com/bitcoin/bitcoin/pull/24232/commits/d70b8de51e54061e9ef045366f4a7651678dd82a fixes this.",
      "created_at" : "2022-02-02T15:15:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#issuecomment-1028043521",
      "id" : 1028043521,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24232",
      "node_id" : "IC_kwDOABII5849RrMB",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1028043521/reactions"
      },
      "updated_at" : "2022-02-02T15:15:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1028043521",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r798657298"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/798657298"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Should probably de-activate the existing snapshot chainstate as in the `if (snapshot_invalid)` conditional.",
      "commit_id" : "7e2b212f9448a9b57df173a161686e33ac4c7d4e",
      "created_at" : "2022-02-03T15:04:45Z",
      "diff_hunk" : "@@ -4982,6 +4991,91 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+bool ChainstateManager::completeSnapshotValidation(CChainState& validation_chainstate)\n+{\n+    AssertLockHeld(cs_main);\n+    assert(&validation_chainstate == m_ibd_chainstate.get());\n+\n+    CCoinsViewDB& ibd_coins_db = validation_chainstate.CoinsDB();\n+    validation_chainstate.ForceFlushStateToDisk();\n+\n+    CCoinsStats ibd_stats{CoinStatsHashType::HASH_SERIALIZED};\n+    auto breakpoint_fnc = [] { /* TODO insert breakpoint here? */ };\n+\n+    if (!GetUTXOStats(&ibd_coins_db, WITH_LOCK(::cs_main, return std::ref(m_blockman)), ibd_stats, breakpoint_fnc)) {\n+        LogPrintf(\"[snapshot] failed to generate stats for validation coins db\\n\");\n+        return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r798657298",
      "id" : 798657298,
      "line" : 5007,
      "node_id" : "PRRC_kwDOABII584vmosS",
      "original_commit_id" : "7e2b212f9448a9b57df173a161686e33ac4c7d4e",
      "original_line" : 5007,
      "original_position" : 75,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 75,
      "pull_request_review_id" : 871973254,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/798657298/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-03T15:04:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/798657298",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r798657488"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/798657488"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Same as above. These failure modes also need tests.",
      "commit_id" : "9f89221913d8230b62cc3959fbb5ab4d220d91f6",
      "created_at" : "2022-02-03T15:04:55Z",
      "diff_hunk" : "@@ -4982,6 +4991,91 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+bool ChainstateManager::completeSnapshotValidation(CChainState& validation_chainstate)\n+{\n+    AssertLockHeld(cs_main);\n+    assert(&validation_chainstate == m_ibd_chainstate.get());\n+\n+    CCoinsViewDB& ibd_coins_db = validation_chainstate.CoinsDB();\n+    validation_chainstate.ForceFlushStateToDisk();\n+\n+    CCoinsStats ibd_stats{CoinStatsHashType::HASH_SERIALIZED};\n+    auto breakpoint_fnc = [] { /* TODO insert breakpoint here? */ };\n+\n+    if (!GetUTXOStats(&ibd_coins_db, WITH_LOCK(::cs_main, return std::ref(m_blockman)), ibd_stats, breakpoint_fnc)) {\n+        LogPrintf(\"[snapshot] failed to generate stats for validation coins db\\n\");\n+        return false;\n+    }\n+\n+    auto snapshot_blockhash = SnapshotBlockhash().value_or(uint256());\n+\n+    LogPrintf(\"[snapshot] tip: actual=%s expected=%s\\n\",\n+        validation_chainstate.m_chain.Tip()->ToString(),\n+        snapshot_blockhash.ToString());\n+\n+    uint256 expected_contents_hash;\n+    int curr_height = validation_chainstate.m_chain.Height();\n+\n+    bool snapshot_invalid{false};\n+    auto maybe_au_data = ExpectedAssumeutxo(curr_height, ::Params());\n+\n+    if (!maybe_au_data) {\n+        LogPrintf(\"[snapshot] assumeutxo data not found for height \" /* Continued */\n+            \"(%d) - refusing to validate snapshot\\n\", curr_height);\n+        return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r798657488",
      "id" : 798657488,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584vmovQ",
      "original_commit_id" : "7e2b212f9448a9b57df173a161686e33ac4c7d4e",
      "original_line" : 5025,
      "original_position" : 93,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 871973518,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/798657488/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-03T19:03:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/798657488",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r798664573"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/798664573"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We should either deactivate the snapshot chainstate or shutdown.",
      "commit_id" : "9f89221913d8230b62cc3959fbb5ab4d220d91f6",
      "created_at" : "2022-02-03T15:11:38Z",
      "diff_hunk" : "@@ -5045,3 +5167,148 @@ void ChainstateManager::MaybeRebalanceCaches()\n         }\n     }\n }\n+\n+constexpr int SNAPSHOT_NAME_LEN = 75; // \"chainstate_\" + 64 hex characters for blockhash.\n+\n+static bool IsPathSnapshotDatadir(const fs::path& datadir_path)\n+{\n+    return datadir_path.filename().string().length() == SNAPSHOT_NAME_LEN &&\n+        datadir_path.filename().string().substr(0,11) == \"chainstate_\";\n+}\n+\n+static uint256 PathToSnapshotHash(const fs::path& datadir_path)\n+{\n+    assert(IsPathSnapshotDatadir(datadir_path));\n+    return uint256S(datadir_path.filename().string().substr(11));\n+}\n+\n+static std::optional<fs::path> FindSnapshotChainstateDatadir()\n+{\n+    fs::path found;\n+\n+    for (fs::directory_iterator it(gArgs.GetDataDirNet()); it != fs::directory_iterator(); it++) {\n+        if (fs::is_directory(*it) && !fs::is_empty(*it) && IsPathSnapshotDatadir(it->path()))\n+        {\n+            if (found.empty()) {\n+                found = it->path();\n+                LogPrintf(\"[snapshot] found snapshot datadir %s\\n\", fs::PathToString(found));\n+            } else {\n+                LogPrintf(\"[snapshot] WARNING - detected multiple snapshot \" /* Continued */\n+                    \"datadirs (%s). This is not expected.\\n\", fs::PathToString(it->path()));\n+            }\n+        }\n+    }\n+    return found.empty() ? std::nullopt : std::make_optional(found);\n+}\n+\n+bool ChainstateManager::DetectSnapshotChainstate(CTxMemPool* mempool)\n+{\n+    std::optional<fs::path> path = FindSnapshotChainstateDatadir();\n+    if (!path) {\n+        return false;\n+    }\n+    LogPrintf(\"[snapshot] detected active snapshot chainstate (%s) - loading\\n\",\n+        fs::PathToString(*path));\n+    this->InitializeChainstate(mempool, /*snapshot_blockhash*/ PathToSnapshotHash(*path));\n+    return true;\n+}\n+\n+bool CChainState::teardownSnapshotDatadir()\n+{\n+    if (!m_from_snapshot_blockhash) {\n+        // Chainstate isn't based on a snapshot.\n+        return false;\n+    }\n+    std::optional<fs::path> snapshot_datadir = FindSnapshotChainstateDatadir();\n+\n+    if (!snapshot_datadir) {\n+        return false;\n+    }\n+\n+    uint256 datadir_hash = PathToSnapshotHash(*snapshot_datadir);\n+\n+    if (datadir_hash != *m_from_snapshot_blockhash) {\n+        LogPrintf(\"[snapshot] WARNING - unexpected blockhash for snapshot datadir (%s); expected %s\\n\",\n+            datadir_hash.ToString(), m_from_snapshot_blockhash->ToString());\n+        return false;\n+    }\n+\n+    LogPrintf(\"[snapshot] tearing down snapshot datadir %s\\n\", fs::PathToString(*snapshot_datadir));\n+    assert(fs::remove_all(*snapshot_datadir) > 0);\n+    return true;\n+}\n+\n+CBlockIndex* ChainstateManager::getSnapshotBaseBlock()\n+{\n+    auto blockhash_op = SnapshotBlockhash();\n+    if (!blockhash_op) return nullptr;\n+    return m_blockman.LookupBlockIndex(*blockhash_op);\n+}\n+\n+std::optional<int> ChainstateManager::getSnapshotHeight()\n+{\n+    CBlockIndex* base = getSnapshotBaseBlock();\n+    return base ? std::make_optional(base->nHeight) : std::nullopt;\n+}\n+\n+void ChainstateManager::validatedSnapshotShutdownCleanup(\n+    fs::path new_chainstate, fs::path old_chainstate)\n+{\n+    assert(fs::exists(new_chainstate));\n+    assert(fs::exists(old_chainstate));\n+\n+    LogPrintf(\"[snapshot] deleting background chainstate directory (now unnecessary) (%s)\\n\",\n+        fs::PathToString(old_chainstate));\n+\n+    // Instead of deleting the background chainstate directly, rename the old\n+    // chainstate to chainstate_bak, rename the new chainstate into place, and then\n+    // delete to avoid likelihood of corruption from mid-delete shutdown.\n+    fs::path tmp_old{old_chainstate};\n+    tmp_old += \"_bak\";\n+\n+    fs::rename(old_chainstate, tmp_old);\n+    fs::rename(new_chainstate, old_chainstate);\n+\n+    LogPrintf(\"[snapshot] moving snapshot chainstate (%s) to \" /* Continued */\n+        \"default chainstate directory (%s)\\n\",\n+        fs::PathToString(new_chainstate), fs::PathToString(old_chainstate));\n+\n+    assert(fs::remove_all(tmp_old) > 0);\n+    LogPrintf(\"[snapshot] deleted background chainstate directory (%s)\\n\",\n+        fs::PathToString(old_chainstate));\n+}\n+\n+void ChainstateManager::checkForUncleanShutdown()\n+{\n+    if (!(m_snapshot_chainstate && m_ibd_chainstate)) {\n+        return;\n+    }\n+    if (m_ibd_chainstate->m_chain.Height() != getSnapshotHeight()) {\n+        return;\n+    }\n+    LogPrintf(\"[snapshot] unclean shutdown detected - background validation chain needs to \" /* Continued */\n+        \"be checked against the loaded snapshot and cleaned up.\\n\");\n+    completeSnapshotValidation(*m_ibd_chainstate.get());\n+}\n+\n+bool ChainstateManager::maybeCompleteSnapshotValidation(\n+    CChainState& chainstate,\n+    CBlockIndex& pindexNew)\n+{\n+    int snapshot_height = getSnapshotHeight().value_or(-1);\n+\n+    // If this is the chainstate that's validating in the background, check to see if it's\n+    // time we compare the UTXO set hash to the base of our active snapshot.\n+    if (&chainstate != &this->ActiveChainstate()) {\n+        if (pindexNew.nHeight > getSnapshotHeight()) {\n+            // TODO jamesob: better handling?\n+            LogPrintf(\"[snapshot] something is wrong! validation chain \" /* Continued */\n+                \"should not have continued past the snapshot origin\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r798664573",
      "id" : 798664573,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584vmqd9",
      "original_commit_id" : "7e2b212f9448a9b57df173a161686e33ac4c7d4e",
      "original_line" : 5306,
      "original_position" : 349,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 871973518,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/798664573/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-03T19:03:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/798664573",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Okay, I've pushed a revision that addresses my previous comments and more comprehensively (that is to say: at all) tests the major failure modes. I had to parameterize the shutdown behavior during snapshot completion to get this to work within the unittests.\r\n\r\nPending CI pass, this should be ready for continued review. ",
      "created_at" : "2022-02-08T01:01:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#issuecomment-1032104129",
      "id" : 1032104129,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24232",
      "node_id" : "IC_kwDOABII5849hKjB",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1032104129/reactions"
      },
      "updated_at" : "2022-02-08T01:01:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1032104129",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Alright, CI is finally passing. I had to add https://github.com/bitcoin/bitcoin/pull/24232/commits/5d5dfaa7a647307f58acdd1909fc8f34c1787f82 because an existing unittest that advanced an IBD chain past the snapshot it generated started failing. This isn't something that should happen in practice, but was done to test an unrelated feature (`UpdateTip` behavior on a background chainstate).\r\n\r\n",
      "created_at" : "2022-02-08T23:36:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#issuecomment-1033170229",
      "id" : 1033170229,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24232",
      "node_id" : "IC_kwDOABII5849lO01",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1033170229/reactions"
      },
      "updated_at" : "2022-02-08T23:36:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1033170229",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-02-17T07:38:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#issuecomment-1042656098",
      "id" : 1042656098,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24232",
      "node_id" : "IC_kwDOABII584-Jati",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1042656098/reactions"
      },
      "updated_at" : "2022-02-17T07:38:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1042656098",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r820651995"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/820651995"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Looks like #24299 was merged, so you might have to inline the needed resets here (or create a helper function for it).",
      "commit_id" : "9f89221913d8230b62cc3959fbb5ab4d220d91f6",
      "created_at" : "2022-03-07T12:20:10Z",
      "diff_hunk" : "@@ -48,6 +60,33 @@ CreateAndActivateUTXOSnapshot(node::NodeContext& node, const fs::path root, F ma\n \n     malleation(auto_infile, metadata);\n \n+    if (reset_chainstate) {\n+        {\n+            // What follows is a hack to selectively reset chainstate data without\n+            // disturbing the existing BlockManager instance, which is needed to\n+            // recognize the headers chain previously generated by the chainstate we're\n+            // removing. Without those headers, we can't activate the snapshot below.\n+            LOCK(::cs_main);\n+            uint256 gen_hash = node.chainman->ActiveChainstate().m_chain[0]->GetBlockHash();\n+            node.chainman->Reset();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24232#discussion_r820651995",
      "id" : 820651995,
      "line" : 71,
      "node_id" : "PRRC_kwDOABII584w6ifb",
      "original_commit_id" : "9f89221913d8230b62cc3959fbb5ab4d220d91f6",
      "original_line" : 71,
      "original_position" : 48,
      "original_start_line" : null,
      "path" : "src/test/util/chainstate.h",
      "position" : 48,
      "pull_request_review_id" : 901614980,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24232",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/820651995/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-07T12:20:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/820651995",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
