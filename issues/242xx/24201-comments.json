[
   {
      "author_association" : "NONE",
      "body" : "Part of the reason why I am using strncmp is because AddrMan (AddrManImpl) -> Unserialize might be called somewhere else, so I didn't want to touch it.\r\n\r\nI should probably re-work AddrManImpl to use a new exception class that wraps around std::ios_base::failure and only throw exception in the case of version mismatch... but I wanted to get feedback first.",
      "created_at" : "2022-01-29T13:42:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24201#issuecomment-1024914242",
      "id" : 1024914242,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24201",
      "node_id" : "IC_kwDOABII5849FvNC",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1024914242/reactions"
      },
      "updated_at" : "2022-01-29T13:42:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1024914242",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/11246316?v=4",
         "events_url" : "https://api.github.com/users/junderw/events{/privacy}",
         "followers_url" : "https://api.github.com/users/junderw/followers",
         "following_url" : "https://api.github.com/users/junderw/following{/other_user}",
         "gists_url" : "https://api.github.com/users/junderw/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/junderw",
         "id" : 11246316,
         "login" : "junderw",
         "node_id" : "MDQ6VXNlcjExMjQ2MzE2",
         "organizations_url" : "https://api.github.com/users/junderw/orgs",
         "received_events_url" : "https://api.github.com/users/junderw/received_events",
         "repos_url" : "https://api.github.com/users/junderw/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/junderw/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/junderw/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/junderw"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Yeah, I think it should be thrown directly where the version is read",
      "created_at" : "2022-01-29T13:51:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24201#issuecomment-1024915646",
      "id" : 1024915646,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24201",
      "node_id" : "IC_kwDOABII5849Fvi-",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1024915646/reactions"
      },
      "updated_at" : "2022-01-29T13:51:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1024915646",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Fixed.\r\n\r\nAlso, 2 jobs on the first commit's CI have been running for 10 hours... is this caused by my strncmp?",
      "created_at" : "2022-01-29T23:36:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24201#issuecomment-1025007352",
      "id" : 1025007352,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24201",
      "node_id" : "IC_kwDOABII5849GF74",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1025007352/reactions"
      },
      "updated_at" : "2022-01-29T23:36:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1025007352",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/11246316?v=4",
         "events_url" : "https://api.github.com/users/junderw/events{/privacy}",
         "followers_url" : "https://api.github.com/users/junderw/followers",
         "following_url" : "https://api.github.com/users/junderw/following{/other_user}",
         "gists_url" : "https://api.github.com/users/junderw/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/junderw",
         "id" : 11246316,
         "login" : "junderw",
         "node_id" : "MDQ6VXNlcjExMjQ2MzE2",
         "organizations_url" : "https://api.github.com/users/junderw/orgs",
         "received_events_url" : "https://api.github.com/users/junderw/received_events",
         "repos_url" : "https://api.github.com/users/junderw/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/junderw/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/junderw/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/junderw"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "On second look, I wonder if we should also `LogPrintf` the `e.what()` right before we `LogPrintf` `\"Creating new peers.dat...\"`?",
      "created_at" : "2022-01-30T23:18:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24201#issuecomment-1025256519",
      "id" : 1025256519,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24201",
      "node_id" : "IC_kwDOABII5849HCxH",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1025256519/reactions"
      },
      "updated_at" : "2022-01-30T23:18:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1025256519",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/11246316?v=4",
         "events_url" : "https://api.github.com/users/junderw/events{/privacy}",
         "followers_url" : "https://api.github.com/users/junderw/followers",
         "following_url" : "https://api.github.com/users/junderw/following{/other_user}",
         "gists_url" : "https://api.github.com/users/junderw/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/junderw",
         "id" : 11246316,
         "login" : "junderw",
         "node_id" : "MDQ6VXNlcjExMjQ2MzE2",
         "organizations_url" : "https://api.github.com/users/junderw/orgs",
         "received_events_url" : "https://api.github.com/users/junderw/received_events",
         "repos_url" : "https://api.github.com/users/junderw/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/junderw/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/junderw/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/junderw"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Squashed.",
      "created_at" : "2022-02-06T10:45:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24201#issuecomment-1030806066",
      "id" : 1030806066,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24201",
      "node_id" : "IC_kwDOABII5849cNoy",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1030806066/reactions"
      },
      "updated_at" : "2022-02-06T10:45:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1030806066",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/11246316?v=4",
         "events_url" : "https://api.github.com/users/junderw/events{/privacy}",
         "followers_url" : "https://api.github.com/users/junderw/followers",
         "following_url" : "https://api.github.com/users/junderw/following{/other_user}",
         "gists_url" : "https://api.github.com/users/junderw/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/junderw",
         "id" : 11246316,
         "login" : "junderw",
         "node_id" : "MDQ6VXNlcjExMjQ2MzE2",
         "organizations_url" : "https://api.github.com/users/junderw/orgs",
         "received_events_url" : "https://api.github.com/users/junderw/received_events",
         "repos_url" : "https://api.github.com/users/junderw/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/junderw/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/junderw/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/junderw"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24201#discussion_r800224750"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24201"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/800224750"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Would be nice to deduplicate the common code here somehow.\r\n\r\nMaybe just a single common catch of std::exception, with `if(DbNotFoundError) else if (InvalidAddrManVersionError) else return` then the common re-init logic?",
      "commit_id" : "2948297f4f1602afe38a05288f15d5ca962a20ae",
      "created_at" : "2022-02-06T19:45:23Z",
      "diff_hunk" : "@@ -196,6 +196,11 @@ std::optional<bilingual_str> LoadAddrman(const std::vector<bool>& asmap, const A\n         addrman = std::make_unique<AddrMan>(asmap, /* deterministic */ false, /* consistency_check_ratio */ check_addrman);\n         LogPrintf(\"Creating peers.dat because the file was not found (%s)\\n\", fs::quoted(fs::PathToString(path_addr)));\n         DumpPeerAddresses(args, *addrman);\n+    } catch (const InvalidAddrManVersionError&) {\n+        // Addrman can be in an inconsistent state after failure, reset it\n+        addrman = std::make_unique<AddrMan>(asmap, /* deterministic */ false, /* consistency_check_ratio */ check_addrman);\n+        LogPrintf(\"Creating new peers.dat because the file version was not compatible (%s)\\n\", fs::quoted(fs::PathToString(path_addr)));\n+        DumpPeerAddresses(args, *addrman);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24201#discussion_r800224750",
      "id" : 800224750,
      "line" : 203,
      "node_id" : "PRRC_kwDOABII584vsnXu",
      "original_commit_id" : "2948297f4f1602afe38a05288f15d5ca962a20ae",
      "original_line" : 203,
      "original_position" : 8,
      "original_start_line" : 200,
      "path" : "src/addrdb.cpp",
      "position" : 8,
      "pull_request_review_id" : 874077670,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24201",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/800224750/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 200,
      "start_side" : "RIGHT",
      "updated_at" : "2022-02-06T19:47:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/800224750",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24201#discussion_r800224966"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24201"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/800224966"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I wonder if the old file should be backed up first.",
      "commit_id" : "2948297f4f1602afe38a05288f15d5ca962a20ae",
      "created_at" : "2022-02-06T19:47:11Z",
      "diff_hunk" : "@@ -196,6 +196,11 @@ std::optional<bilingual_str> LoadAddrman(const std::vector<bool>& asmap, const A\n         addrman = std::make_unique<AddrMan>(asmap, /* deterministic */ false, /* consistency_check_ratio */ check_addrman);\n         LogPrintf(\"Creating peers.dat because the file was not found (%s)\\n\", fs::quoted(fs::PathToString(path_addr)));\n         DumpPeerAddresses(args, *addrman);\n+    } catch (const InvalidAddrManVersionError&) {\n+        // Addrman can be in an inconsistent state after failure, reset it\n+        addrman = std::make_unique<AddrMan>(asmap, /* deterministic */ false, /* consistency_check_ratio */ check_addrman);\n+        LogPrintf(\"Creating new peers.dat because the file version was not compatible (%s)\\n\", fs::quoted(fs::PathToString(path_addr)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24201#discussion_r800224966",
      "id" : 800224966,
      "line" : 202,
      "node_id" : "PRRC_kwDOABII584vsnbG",
      "original_commit_id" : "2948297f4f1602afe38a05288f15d5ca962a20ae",
      "original_line" : 202,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/addrdb.cpp",
      "position" : 7,
      "pull_request_review_id" : 874077670,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24201",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/800224966/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-06T19:47:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/800224966",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   }
]
