[
   {
      "author_association" : "MEMBER",
      "body" : "Noticed while reviewing #24178.",
      "created_at" : "2022-01-31T18:03:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24220#issuecomment-1026057278",
      "id" : 1026057278,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24220",
      "node_id" : "IC_kwDOABII5849KGQ-",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1026057278/reactions"
      },
      "updated_at" : "2022-01-31T18:03:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1026057278",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I recall that the reason IsIBD was written like this:\r\n\r\n```\r\nbool CChainState::IsInitialBlockDownload() const\r\n{\r\n    // Optimization: pre-test latch before taking the lock.\r\n    if (m_cached_finished_ibd.load(std::memory_order_relaxed))\r\n        return false;\r\n\r\n    LOCK(cs_main);\r\n```\r\n\r\nis so that in the common case -- which is that we've already latched to false -- that we can respond without ever acquiring cs_main inside this function.  See #8007\r\n\r\nMaybe there's a better refactor that could be done so that we can reduce locking contention on cs_main further, but this patch would have all the call sites grab the lock in order to even call IsIBD(), which would add more cs_main lock acquisitions in general -- and that seems counter to where we want to end up?\r\n\r\nIs the motivation for this patch to reduce the uses of cs_main as a recursive mutex, and thereby get to a better design?  If so that sounds like a good direction, but I think it'd be better if we avoided adding extra lock acquisitions (and holding cs_main longer) in order to get there.  For instance it seems like with this patch some of the validation callbacks will now be invoked while holding cs_main the whole time?  That seems undesirable.",
      "created_at" : "2022-01-31T18:59:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24220#issuecomment-1026104827",
      "id" : 1026104827,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24220",
      "node_id" : "IC_kwDOABII5849KR37",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1026104827/reactions"
      },
      "updated_at" : "2022-01-31T19:14:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1026104827",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Yes, the trade-off this pull makes is foregoing the optimization for a half dozen callers that don't already hold cs_main, in favor of avoiding re-taking the cs_main lock for the 18 callers that do already hold it, by moving the lock-taking to the half dozen callers (but just for the call itself, so essentially only the optimization is affected unless I am missing something). The main observation behind this change is that most of the callers already hold the lock.\r\n\r\nThanks for the link to #8007. It looks like the proportion of callers that hold the lock has changed since then.",
      "created_at" : "2022-01-31T19:09:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24220#issuecomment-1026112979",
      "id" : 1026112979,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24220",
      "node_id" : "IC_kwDOABII5849KT3T",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1026112979/reactions"
      },
      "updated_at" : "2022-01-31T19:28:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1026112979",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24220#discussion_r795986108"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24220"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/795986108"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I believe this change will cause the NotifyBlockTip() callbacks to be invoked while holding cs_main the whole time.",
      "commit_id" : "5159d2cb1d64bb735aa160e2c2e4f1faca76d296",
      "created_at" : "2022-01-31T19:15:46Z",
      "diff_hunk" : "@@ -3111,13 +3111,13 @@ bool CChainState::InvalidateBlock(BlockValidationState& state, CBlockIndex* pind\n         }\n \n         InvalidChainFound(to_mark_failed);\n-    }\n \n-    // Only notify about a new block tip if the active chain was modified.\n-    if (pindex_was_in_chain) {\n-        uiInterface.NotifyBlockTip(GetSynchronizationState(IsInitialBlockDownload()), to_mark_failed->pprev);\n+        // Only notify about a new block tip if the active chain was modified.\n+        if (pindex_was_in_chain) {\n+            uiInterface.NotifyBlockTip(GetSynchronizationState(IsInitialBlockDownload()), to_mark_failed->pprev);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24220#discussion_r795986108",
      "id" : 795986108,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584vcci8",
      "original_commit_id" : "595f34d7095128b722b86b8ebcf7b40becd9ff5e",
      "original_line" : 3117,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 868308272,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24220",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/795986108/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-31T19:15:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/795986108",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24220#discussion_r796001857"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24220"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/796001857"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks! Narrowed the lock to the IBD call: `uiInterface.NotifyBlockTip(GetSynchronizationState(WITH_LOCK(::cs_main, return IsInitialBlockDownload())), to_mark_failed->pprev);`",
      "commit_id" : "5159d2cb1d64bb735aa160e2c2e4f1faca76d296",
      "created_at" : "2022-01-31T19:35:47Z",
      "diff_hunk" : "@@ -3111,13 +3111,13 @@ bool CChainState::InvalidateBlock(BlockValidationState& state, CBlockIndex* pind\n         }\n \n         InvalidChainFound(to_mark_failed);\n-    }\n \n-    // Only notify about a new block tip if the active chain was modified.\n-    if (pindex_was_in_chain) {\n-        uiInterface.NotifyBlockTip(GetSynchronizationState(IsInitialBlockDownload()), to_mark_failed->pprev);\n+        // Only notify about a new block tip if the active chain was modified.\n+        if (pindex_was_in_chain) {\n+            uiInterface.NotifyBlockTip(GetSynchronizationState(IsInitialBlockDownload()), to_mark_failed->pprev);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24220#discussion_r796001857",
      "id" : 796001857,
      "in_reply_to_id" : 795986108,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584vcgZB",
      "original_commit_id" : "595f34d7095128b722b86b8ebcf7b40becd9ff5e",
      "original_line" : 3117,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 868331684,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24220",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/796001857/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-31T19:35:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/796001857",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> For instance it seems like with this patch some of the validation callbacks will now be invoked while holding cs_main the whole time? That seems undesirable.\r\n\r\nAgree with @sdaftuar; IsIBD() is called in a few performance-critical places and at the very least this change should be benchmarked before merge. I'm Concept NACK if this change is essentially just for refactoring's sake; if there's some overarching benefit it would be nice to hear that.",
      "created_at" : "2022-01-31T19:47:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24220#issuecomment-1026145631",
      "id" : 1026145631,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24220",
      "node_id" : "IC_kwDOABII5849Kb1f",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1026145631/reactions"
      },
      "updated_at" : "2022-01-31T19:47:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1026145631",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@jamesob I agree; potentially improving performance by not needlessly retaking the cs_main lock is the only point here.",
      "created_at" : "2022-01-31T19:55:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24220#issuecomment-1026151192",
      "id" : 1026151192,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24220",
      "node_id" : "IC_kwDOABII5849KdMY",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1026151192/reactions"
      },
      "updated_at" : "2022-01-31T20:25:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1026151192",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#24008](https://github.com/bitcoin/bitcoin/pull/24008) (assumeutxo: net_processing changes by jamesob)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-01-31T20:37:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24220#issuecomment-1026186381",
      "id" : 1026186381,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24220",
      "node_id" : "IC_kwDOABII5849KlyN",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1026186381/reactions"
      },
      "updated_at" : "2022-01-31T20:37:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1026186381",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   }
]
