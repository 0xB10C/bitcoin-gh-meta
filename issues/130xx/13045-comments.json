[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13045#discussion_r183207203"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13045"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183207203"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Nit: \"better better\" should be something else? :-)",
      "commit_id" : "b45a45672c29616782db6231f0e7d727c026fd35",
      "created_at" : "2018-04-21T11:03:13Z",
      "diff_hunk" : "@@ -2406,10 +2406,11 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n         if (pindex->nStatus & BLOCK_HAVE_DATA) // Nothing to do here\n             return true;\n \n-        if (pindex->nChainWork <= chainActive.Tip()->nChainWork || // We know something better\n+        if (pindex->nChainWork <= chainActive.Tip()->nChainWork || // We know same or better better",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13045#discussion_r183207203",
      "id" : 183207203,
      "original_commit_id" : "64025e11d565f16debc928247ee0f5b2f68eae7e",
      "original_position" : 5,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 114169961,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13045",
      "updated_at" : "2018-04-24T13:29:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183207203",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@practicalswift fixed",
      "created_at" : "2018-04-21T12:43:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13045#issuecomment-383292218",
      "id" : 383292218,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13045",
      "updated_at" : "2018-04-21T12:43:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/383292218",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "why not simply request the compact block rather than a full block?",
      "created_at" : "2018-04-21T22:16:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13045#issuecomment-383335960",
      "id" : 383335960,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13045",
      "updated_at" : "2018-04-21T22:16:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/383335960",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1530283?v=4",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Should mark the block as in flight if it wasn't already and we requested it. Probably should be checking if it's in flight from the same peer too (which would be required if you mark it, and should probably have been done either way).\n\n@promag because the mempool reconstruction will be useless so it'll be worse than a normal request.\n\nOn April 21, 2018 10:16:43 PM UTC, Rebroad <notifications@github.com> wrote:\n>why not simply request the compact block rather than a full block?\n>\n>-- \n>You are receiving this because you are subscribed to this thread.\n>Reply to this email directly or view it on GitHub:\n>https://github.com/bitcoin/bitcoin/pull/13045#issuecomment-383335960\n",
      "created_at" : "2018-04-21T22:55:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13045#issuecomment-383338354",
      "id" : 383338354,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13045",
      "updated_at" : "2018-04-21T22:55:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/383338354",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@TheBlueMatt Added the filter-by-sender and marking block as in flight.",
      "created_at" : "2018-04-23T14:09:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13045#issuecomment-383588477",
      "id" : 383588477,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13045",
      "updated_at" : "2018-04-23T14:09:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/383588477",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13045#discussion_r183544144"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13045"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183544144"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: how about unpacking `blockInFlightIt->second.first` to a local like `inFlightNodeId` or the like? It's used one other place in the file and is relatively inscrutable.",
      "commit_id" : "b45a45672c29616782db6231f0e7d727c026fd35",
      "created_at" : "2018-04-23T21:31:15Z",
      "diff_hunk" : "@@ -2406,11 +2406,15 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n         if (pindex->nStatus & BLOCK_HAVE_DATA) // Nothing to do here\n             return true;\n \n-        if (pindex->nChainWork <= chainActive.Tip()->nChainWork || // We know something better\n+        if (pindex->nChainWork <= chainActive.Tip()->nChainWork || // We know same or better\n                 pindex->nTx != 0) { // We had this block at some point, but pruned it\n-            if (fAlreadyInFlight) {\n-                // We requested this block for some reason, but our mempool will probably be useless\n+            if ((fAlreadyInFlight && blockInFlightIt->second.first == pfrom->GetId())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13045#discussion_r183544144",
      "id" : 183544144,
      "original_commit_id" : "a61ea427d59432c9d2e163fa4ccda026fb85a57d",
      "original_position" : 9,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 114563577,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13045",
      "updated_at" : "2018-04-24T13:29:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183544144",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5470?v=4",
         "events_url" : "https://api.github.com/users/Empact/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Empact/followers",
         "following_url" : "https://api.github.com/users/Empact/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Empact/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Empact",
         "id" : 5470,
         "login" : "Empact",
         "organizations_url" : "https://api.github.com/users/Empact/orgs",
         "received_events_url" : "https://api.github.com/users/Empact/received_events",
         "repos_url" : "https://api.github.com/users/Empact/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Empact/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Empact/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Empact"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13045#discussion_r183732526"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13045"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183732526"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I cached the \"from same peer\" logic instead since it's used twice.",
      "commit_id" : "b45a45672c29616782db6231f0e7d727c026fd35",
      "created_at" : "2018-04-24T13:38:31Z",
      "diff_hunk" : "@@ -2406,11 +2406,15 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n         if (pindex->nStatus & BLOCK_HAVE_DATA) // Nothing to do here\n             return true;\n \n-        if (pindex->nChainWork <= chainActive.Tip()->nChainWork || // We know something better\n+        if (pindex->nChainWork <= chainActive.Tip()->nChainWork || // We know same or better\n                 pindex->nTx != 0) { // We had this block at some point, but pruned it\n-            if (fAlreadyInFlight) {\n-                // We requested this block for some reason, but our mempool will probably be useless\n+            if ((fAlreadyInFlight && blockInFlightIt->second.first == pfrom->GetId())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13045#discussion_r183732526",
      "id" : 183732526,
      "in_reply_to_id" : 183544144,
      "original_commit_id" : "a61ea427d59432c9d2e163fa4ccda026fb85a57d",
      "original_position" : 9,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 114785420,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13045",
      "updated_at" : "2018-04-24T13:38:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183732526",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "would it be worth keeping the txs that went into the latest block to hand\nfor this situation so that compact blocks can be used? what if the previous\ncompact block received had only one transaction in it, whereas this\ncompeting block has many transactions? by requesting a full block we would\nbe favouring the empty block when it would be better for the network to\nfavour the full block. therefore I'd still argue it's better to request a\ncompact block so to not give empty blocks an unfair advantage.\n\nOn Sat, 21 Apr 2018, 23:56 Matt Corallo, <notifications@github.com> wrote:\n\n> because the mempool reconstruction will be useless so it'll be worse than\n> a normal request.\n>\n",
      "created_at" : "2018-04-25T14:50:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13045#issuecomment-384315155",
      "id" : 384315155,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13045",
      "updated_at" : "2018-04-25T14:50:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/384315155",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1530283?v=4",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@rebroad I think this goes a bit off-topic to incentives. As-is it would likely take a lot of work to support it, and I'd have no idea how to do it safely.",
      "created_at" : "2018-04-25T14:54:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13045#issuecomment-384316891",
      "id" : 384316891,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13045",
      "updated_at" : "2018-04-25T14:54:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/384316891",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13045#discussion_r184387279"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13045"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/184387279"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this will actually request the full block that *is* the known chaintip. Probably need to check it isn't in chainActive first. It already is being checked that it connects, so this is all that is likely needed.",
      "commit_id" : "b45a45672c29616782db6231f0e7d727c026fd35",
      "created_at" : "2018-04-26T13:25:20Z",
      "diff_hunk" : "@@ -2402,15 +2402,20 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n \n         std::map<uint256, std::pair<NodeId, std::list<QueuedBlock>::iterator> >::iterator blockInFlightIt = mapBlocksInFlight.find(pindex->GetBlockHash());\n         bool fAlreadyInFlight = blockInFlightIt != mapBlocksInFlight.end();\n+        bool in_flight_from_same_peer = fAlreadyInFlight ? blockInFlightIt->second.first == pfrom->GetId() : false;\n \n         if (pindex->nStatus & BLOCK_HAVE_DATA) // Nothing to do here\n             return true;\n \n-        if (pindex->nChainWork <= chainActive.Tip()->nChainWork || // We know something better\n+        if (pindex->nChainWork <= chainActive.Tip()->nChainWork || // We know same or better\n                 pindex->nTx != 0) { // We had this block at some point, but pruned it\n-            if (fAlreadyInFlight) {\n-                // We requested this block for some reason, but our mempool will probably be useless\n+            if ((fAlreadyInFlight && in_flight_from_same_peer)\n+                    || pindex->nChainWork == chainActive.Tip()->nChainWork) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13045#discussion_r184387279",
      "id" : 184387279,
      "original_commit_id" : "b45a45672c29616782db6231f0e7d727c026fd35",
      "original_position" : 15,
      "path" : "src/net_processing.cpp",
      "position" : 15,
      "pull_request_review_id" : 115572444,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13045",
      "updated_at" : "2018-04-26T13:35:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/184387279",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13045#discussion_r184396953"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13045"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/184396953"
         }
      },
      "author_association" : "MEMBER",
      "body" : "oh, maybe not. two lines or so above we have this check:\r\n```\r\nif (pindex->nStatus & BLOCK_HAVE_DATA) // Nothing to do here\r\n            return true;\r\n```",
      "commit_id" : "b45a45672c29616782db6231f0e7d727c026fd35",
      "created_at" : "2018-04-26T13:52:37Z",
      "diff_hunk" : "@@ -2402,15 +2402,20 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n \n         std::map<uint256, std::pair<NodeId, std::list<QueuedBlock>::iterator> >::iterator blockInFlightIt = mapBlocksInFlight.find(pindex->GetBlockHash());\n         bool fAlreadyInFlight = blockInFlightIt != mapBlocksInFlight.end();\n+        bool in_flight_from_same_peer = fAlreadyInFlight ? blockInFlightIt->second.first == pfrom->GetId() : false;\n \n         if (pindex->nStatus & BLOCK_HAVE_DATA) // Nothing to do here\n             return true;\n \n-        if (pindex->nChainWork <= chainActive.Tip()->nChainWork || // We know something better\n+        if (pindex->nChainWork <= chainActive.Tip()->nChainWork || // We know same or better\n                 pindex->nTx != 0) { // We had this block at some point, but pruned it\n-            if (fAlreadyInFlight) {\n-                // We requested this block for some reason, but our mempool will probably be useless\n+            if ((fAlreadyInFlight && in_flight_from_same_peer)\n+                    || pindex->nChainWork == chainActive.Tip()->nChainWork) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13045#discussion_r184396953",
      "id" : 184396953,
      "in_reply_to_id" : 184387279,
      "original_commit_id" : "b45a45672c29616782db6231f0e7d727c026fd35",
      "original_position" : 15,
      "path" : "src/net_processing.cpp",
      "position" : 15,
      "pull_request_review_id" : 115584204,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13045",
      "updated_at" : "2018-04-26T13:52:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/184396953",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   }
]
