[
   {
      "author_association" : "MEMBER",
      "body" : "Builds on top of #10740. Please review that first.",
      "created_at" : "2018-04-23T17:24:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13058#issuecomment-383655175",
      "id" : 383655175,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13058",
      "updated_at" : "2018-04-23T17:24:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/383655175",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13058#discussion_r183491698"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13058"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183491698"
         }
      },
      "author_association" : "MEMBER",
      "body" : "As mentioned in #13028, I think this does not have sufficient concurrency protection (maybe okay since edge case). AFAIK, callers calling `CWallet::Verify` as well as inside the call, there is no lock being held, thus, I think, it is possible that there could be a race in `loadwallet` and `createwallet` bypassing the filename check.",
      "commit_id" : "f8b7016b52e7aab34b3f9773401a33c8f60a389c",
      "created_at" : "2018-04-23T18:20:43Z",
      "diff_hunk" : "@@ -3963,6 +3969,55 @@ std::vector<std::string> CWallet::GetDestValues(const std::string& prefix) const\n     return values;\n }\n \n+bool CWallet::Verify(std::string wallet_file, bool salvage_wallet, std::string& error_string, std::string& warning_string)\n+{\n+    // Do some checking on wallet path. It should be either a:\n+    //\n+    // 1. Path where a directory can be created.\n+    // 2. Path to an existing directory.\n+    // 3. Path to a symlink to a directory.\n+    // 4. For backwards compatibility, the name of a data file in -walletdir.\n+    fs::path wallet_path = fs::absolute(wallet_file, GetWalletDir());\n+    fs::file_type path_type = fs::symlink_status(wallet_path).type();\n+    if (!(path_type == fs::file_not_found || path_type == fs::directory_file ||\n+          (path_type == fs::symlink_file && fs::is_directory(wallet_path)) ||\n+          (path_type == fs::regular_file && fs::path(wallet_file).filename() == wallet_file))) {\n+        error_string = strprintf(\n+            _(\"Invalid -wallet path '%s'. -wallet path should point to a directory where wallet.dat and \"\n+              \"database/log.?????????? files can be stored, a location where such a directory could be created, \"\n+              \"or (for backwards compatibility) the name of an existing data file in -walletdir (%s)\"),\n+            wallet_file, GetWalletDir());\n+        return false;\n+    }\n+\n+    // Make sure that the wallet path doesn't clash with an existing wallet path\n+    std::set<fs::path> wallet_paths;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13058#discussion_r183491698",
      "id" : 183491698,
      "original_commit_id" : "f8b7016b52e7aab34b3f9773401a33c8f60a389c",
      "original_position" : 81,
      "path" : "src/wallet/wallet.cpp",
      "position" : 81,
      "pull_request_review_id" : 114500317,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13058",
      "updated_at" : "2018-04-23T18:20:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183491698",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13058#discussion_r184878654"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13058"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/184878654"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Empty line.",
      "commit_id" : "f8b7016b52e7aab34b3f9773401a33c8f60a389c",
      "created_at" : "2018-04-29T10:41:37Z",
      "diff_hunk" : "@@ -2916,6 +2916,49 @@ UniValue loadwallet(const JSONRPCRequest& request)\n \n }\n \n+UniValue createwallet(const JSONRPCRequest& request)\n+{\n+    if (request.fHelp || request.params.size() != 1)\n+        throw std::runtime_error(\n+            \"createwallet \\\"filename\\\"\\n\"\n+            \"\\nCreates and loads a new wallet.\\n\"\n+            \"\\nArguments:\\n\"\n+            \"1. \\\"wallet_name\\\"    (string, required) The name for the new wallet.\\n\"\n+            \"\\nResult:\\n\"\n+            \"<walletname>     (string) The wallet name if created successfully.\\n\"\n+            \"\\nExamples:\\n\"\n+            + HelpExampleCli(\"createwallet\", \"\\\"test.dat\\\"\")\n+            + HelpExampleRpc(\"createwallet\", \"\\\"test.dat\\\"\")\n+        );\n+    std::string wallet_name = request.params[0].get_str();\n+    std::string error;\n+\n+    fs::path wallet_path = fs::absolute(wallet_name, GetWalletDir());\n+    if (fs::symlink_status(wallet_path).type() != fs::file_not_found) {\n+        throw JSONRPCError(RPC_WALLET_ERROR, \"Wallet \" + wallet_name + \" already exists.\");\n+    }\n+\n+    // Wallet::Verify will check if we're trying to create a wallet with a duplication name.\n+    std::string dummy_warning;\n+    if (!CWallet::Verify(wallet_name, false, error, dummy_warning)) {\n+        throw JSONRPCError(RPC_WALLET_ERROR, \"Wallet file verification failed: \" + error);\n+    }\n+\n+    CWallet * const wallet = CWallet::CreateWalletFromFile(wallet_name, fs::absolute(wallet_name, GetWalletDir()));\n+    if (!wallet) {\n+        throw JSONRPCError(RPC_WALLET_ERROR, \"Wallet creation failed.\");\n+    }\n+    AddWallet(wallet);\n+\n+    wallet->postInitProcess();\n+\n+    UniValue obj(UniValue::VSTR);\n+    obj = wallet_name;\n+\n+    return obj;\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13058#discussion_r184878654",
      "id" : 184878654,
      "original_commit_id" : "70277d29484e967b11a24d58485ce5262d1ddec8",
      "original_position" : 44,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : 86,
      "pull_request_review_id" : 116162168,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13058",
      "updated_at" : "2018-04-29T10:41:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/184878654",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "rebased",
      "created_at" : "2018-05-16T21:56:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13058#issuecomment-389678636",
      "id" : 389678636,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13058",
      "updated_at" : "2018-05-16T21:56:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/389678636",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   }
]
