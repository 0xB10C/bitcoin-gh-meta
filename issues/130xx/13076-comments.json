[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13076#discussion_r184197927"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13076"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/184197927"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Note I added the failure height here. Happy to remove, but I assume it could be helpful.",
      "commit_id" : "2c4bc0018bbf41c5f853ca24759a1ee4b0dd5a76",
      "created_at" : "2018-04-25T20:37:14Z",
      "diff_hunk" : "@@ -3767,16 +3767,13 @@ UniValue rescanblockchain(const JSONRPCRequest& request)\n         }\n     }\n \n-    CBlockIndex *stopBlock = pwallet->ScanForWalletTransactions(pindexStart, pindexStop, reserver, true);\n-    if (!stopBlock) {\n-        if (pwallet->IsAbortingRescan()) {\n-            throw JSONRPCError(RPC_MISC_ERROR, \"Rescan aborted.\");\n-        }\n-        // if we got a nullptr returned, ScanForWalletTransactions did rescan up to the requested stopindex\n+    const CBlockIndex* stopBlock = nullptr;\n+    if (pwallet->ScanForWalletTransactions(pindexStart, pindexStop, stopBlock, reserver, true)) {\n         stopBlock = pindexStop ? pindexStop : pChainTip;\n-    }\n-    else {\n-        throw JSONRPCError(RPC_MISC_ERROR, \"Rescan failed. Potentially corrupted data files.\");\n+    } else if (pwallet->IsAbortingRescan()) {\n+        throw JSONRPCError(RPC_MISC_ERROR, \"Rescan aborted.\");\n+    } else {\n+        throw JSONRPCError(RPC_MISC_ERROR, strprintf(\"Rescan failed. Potentially corrupted data files. Failed at height %i.\", stopBlock->nHeight));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13076#discussion_r184197927",
      "id" : 184197927,
      "original_commit_id" : "25a588ac2f66d658accf4dc9bc0f2710efab61ba",
      "original_position" : 19,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : 19,
      "pull_request_review_id" : 115344796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13076",
      "updated_at" : "2018-04-26T00:01:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/184197927",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5470?v=4",
         "events_url" : "https://api.github.com/users/Empact/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Empact/followers",
         "following_url" : "https://api.github.com/users/Empact/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Empact/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Empact",
         "id" : 5470,
         "login" : "Empact",
         "organizations_url" : "https://api.github.com/users/Empact/orgs",
         "received_events_url" : "https://api.github.com/users/Empact/received_events",
         "repos_url" : "https://api.github.com/users/Empact/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Empact/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Empact/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Empact"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13076#discussion_r184198224"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13076"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/184198224"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Note this did not previously fail when ScanForWalletTransactions failed, so this removes a silent failure.",
      "commit_id" : "2c4bc0018bbf41c5f853ca24759a1ee4b0dd5a76",
      "created_at" : "2018-04-25T20:38:19Z",
      "diff_hunk" : "@@ -4167,11 +4167,11 @@ CWallet* CWallet::CreateWalletFromFile(const std::string& name, const fs::path&\n         nStart = GetTimeMillis();\n         {\n             WalletRescanReserver reserver(walletInstance);\n-            if (!reserver.reserve()) {\n+            const CBlockIndex* stop_block = nullptr;\n+            if (!reserver.reserve() || !walletInstance->ScanForWalletTransactions(pindexRescan, nullptr, stop_block, reserver, true)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13076#discussion_r184198224",
      "id" : 184198224,
      "original_commit_id" : "25a588ac2f66d658accf4dc9bc0f2710efab61ba",
      "original_position" : 61,
      "path" : "src/wallet/wallet.cpp",
      "position" : 75,
      "pull_request_review_id" : 115345173,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13076",
      "updated_at" : "2018-04-26T00:01:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/184198224",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5470?v=4",
         "events_url" : "https://api.github.com/users/Empact/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Empact/followers",
         "following_url" : "https://api.github.com/users/Empact/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Empact/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Empact",
         "id" : 5470,
         "login" : "Empact",
         "organizations_url" : "https://api.github.com/users/Empact/orgs",
         "received_events_url" : "https://api.github.com/users/Empact/received_events",
         "repos_url" : "https://api.github.com/users/Empact/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Empact/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Empact/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Empact"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13076#discussion_r184207815"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13076"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/184207815"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Alternatively, this could be `(!pindex && !failed_block)`",
      "commit_id" : "2c4bc0018bbf41c5f853ca24759a1ee4b0dd5a76",
      "created_at" : "2018-04-25T21:14:19Z",
      "diff_hunk" : "@@ -1791,7 +1791,7 @@ CBlockIndex* CWallet::ScanForWalletTransactions(CBlockIndex* pindexStart, CBlock\n         }\n         ShowProgress(_(\"Rescanning...\"), 100); // hide progress dialog in GUI\n     }\n-    return ret;\n+    return (!fAbortRescan && !failed_block);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13076#discussion_r184207815",
      "id" : 184207815,
      "original_commit_id" : "821c955a15f21865d37fa84e68df99539ad1438a",
      "original_position" : 62,
      "path" : "src/wallet/wallet.cpp",
      "position" : 65,
      "pull_request_review_id" : 115357055,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13076",
      "updated_at" : "2018-04-26T00:01:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/184207815",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5470?v=4",
         "events_url" : "https://api.github.com/users/Empact/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Empact/followers",
         "following_url" : "https://api.github.com/users/Empact/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Empact/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Empact",
         "id" : 5470,
         "login" : "Empact",
         "organizations_url" : "https://api.github.com/users/Empact/orgs",
         "received_events_url" : "https://api.github.com/users/Empact/received_events",
         "repos_url" : "https://api.github.com/users/Empact/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Empact/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Empact/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Empact"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13076#discussion_r184241541"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13076"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/184241541"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think you might want to drop this line and just return true here, to fix the regression described here: https://github.com/bitcoin/bitcoin/pull/12275#issuecomment-360864576.",
      "commit_id" : "2c4bc0018bbf41c5f853ca24759a1ee4b0dd5a76",
      "created_at" : "2018-04-26T00:17:38Z",
      "diff_hunk" : "@@ -1763,14 +1764,14 @@ CBlockIndex* CWallet::ScanForWalletTransactions(CBlockIndex* pindexStart, CBlock\n                 if (pindex && !chainActive.Contains(pindex)) {\n                     // Abort scan if current block is no longer active, to prevent\n                     // marking transactions as coming from the wrong block.\n-                    ret = pindex;\n+                    failed_block = pindex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13076#discussion_r184241541",
      "id" : 184241541,
      "original_commit_id" : "2c4bc0018bbf41c5f853ca24759a1ee4b0dd5a76",
      "original_position" : 48,
      "path" : "src/wallet/wallet.cpp",
      "position" : 48,
      "pull_request_review_id" : 115396841,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13076",
      "updated_at" : "2018-04-26T00:17:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/184241541",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13076#discussion_r184296308"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13076"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/184296308"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not sure if in this PR, but would it make sense to just return an `enum` to better distinct between `fail`, `ok` and `user-aborted`?",
      "commit_id" : "2c4bc0018bbf41c5f853ca24759a1ee4b0dd5a76",
      "created_at" : "2018-04-26T07:43:41Z",
      "diff_hunk" : "@@ -1708,9 +1709,10 @@ int64_t CWallet::RescanFromTime(int64_t startTime, const WalletRescanReserver& r\n  * from or to us. If fUpdate is true, found transactions that already\n  * exist in the wallet will be updated.\n  *\n- * Returns null if scan was successful. Otherwise, if a complete rescan was not\n- * possible (due to pruning or corruption), returns pointer to the most recent\n- * block that could not be scanned.\n+ * Returns true if scan was successful. If a complete rescan was not\n+ * possible (due to pruning or corruption), returns false and sets failed_block\n+ * to the most recent block that could not be scanned. If the rescan was aborted\n+ * before it could complete, returns false and does not set failed_block.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13076#discussion_r184296308",
      "id" : 184296308,
      "original_commit_id" : "2c4bc0018bbf41c5f853ca24759a1ee4b0dd5a76",
      "original_position" : 20,
      "path" : "src/wallet/wallet.cpp",
      "position" : 20,
      "pull_request_review_id" : 115461321,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13076",
      "updated_at" : "2018-04-26T07:43:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/184296308",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   }
]
