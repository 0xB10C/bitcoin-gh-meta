[
   {
      "author_association" : "MEMBER",
      "body" : "Opening this to see if people think this is the right solution.",
      "created_at" : "2018-10-03T05:45:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14380#issuecomment-426518487",
      "id" : 426518487,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14380",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyNjUxODQ4Nw==",
      "updated_at" : "2018-10-03T05:45:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/426518487",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Very nice find!",
      "created_at" : "2018-10-03T07:57:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14380#issuecomment-426545512",
      "id" : 426545512,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14380",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyNjU0NTUxMg==",
      "updated_at" : "2018-10-03T07:57:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/426545512",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "The code wants to know the change signature size so it can figure out if it would have created change that was worthless to spend (because the spending will take more fees than the output is worth). \r\n\r\nAssuming the size is smallest plausible signature size would be conservative: it'll overvalue the change, at a risk of keeping change it could have eliminated.  I think doing that would be strictly superior to not using BnB at all, since preventing BnB will always keep change it should eliminate. \r\n\r\nSo, e.g. assuming any spend of an unknown type will take at least 32(txid)+4(vout)+4(sequence)+1(len)+64*0.25(signature) = 57 bytes would work. (don't assume my math is right. :) )",
      "created_at" : "2018-10-03T23:45:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14380#issuecomment-426839366",
      "id" : 426839366,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14380",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyNjgzOTM2Ng==",
      "updated_at" : "2018-10-03T23:57:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/426839366",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Hm yes I suppose you're right. Not running BnB is admitting defeat even if we actually end up being able to discard a larger value. I'll take a look at constructing something that makes a minimal segwit input weight.",
      "created_at" : "2018-10-03T23:52:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14380#issuecomment-426840639",
      "id" : 426840639,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14380",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyNjg0MDYzOQ==",
      "updated_at" : "2018-10-03T23:52:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/426840639",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--32850dd3fdea838b4049e64f46995ea2-->\n| Coverage  | Change ([pull 14380](https://drahtbot.github.io/reports/coverage/bitcoin/bitcoin/14380/total.coverage/index.html)) | Reference ([master](https://drahtbot.github.io/reports/coverage/bitcoin/bitcoin/master/total.coverage/index.html))   |\n|-----------|-------------------------|--------------------|\n| Lines     | -0.0083 %            | 87.0471 %        |\n| Functions | +0.0154 %            | 84.1130 %        |\n| Branches  | +0.0057 %            | 51.5403 %        |\n",
      "created_at" : "2018-10-04T05:47:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14380#issuecomment-426892864",
      "id" : 426892864,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14380",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyNjg5Mjg2NA==",
      "updated_at" : "2018-10-04T05:47:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/426892864",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14380#discussion_r222598779"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14380"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/222598779"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`change_spend_size` is `size_t` and thus cannot be `-1` :-)",
      "commit_id" : "268f4952d9c56d8056b9ef3a6995509591ef3153",
      "created_at" : "2018-10-04T09:29:57Z",
      "diff_hunk" : "@@ -2730,6 +2728,10 @@ bool CWallet::CreateTransaction(const std::vector<CRecipient>& vecSend, CTransac\n                     nValueIn = 0;\n                     setCoins.clear();\n                     coin_selection_params.change_spend_size = CalculateMaximumSignedInputSize(change_prototype_txout, this);\n+                    // If the wallet doesn't know how to sign change output, don't rely on it\n+                    if (coin_selection_params.change_spend_size == -1) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14380#discussion_r222598779",
      "id" : 222598779,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIyMjU5ODc3OQ==",
      "original_commit_id" : "268f4952d9c56d8056b9ef3a6995509591ef3153",
      "original_position" : 14,
      "path" : "src/wallet/wallet.cpp",
      "position" : 14,
      "pull_request_review_id" : 161521938,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14380",
      "updated_at" : "2018-10-04T09:38:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/222598779",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Isn't the problem that `coin_selection_params.change_spend_size` is set to `std::numeric_limits<size_t>::max() ` (`SIZE_MAX`) instead of the intended `-1` since `change_spend_size` is of type `size_t`? \r\n\r\n```\r\n[cling]$ size_t change_spend_size = -1;\r\n[cling]$ change_spend_size\r\n(unsigned long) 18446744073709551615\r\n[cling]$ (size_t)-1\r\n(unsigned long) 18446744073709551615\r\n[cling]$ #include <limits>\r\n[cling]$ std::numeric_limits<size_t>::max()\r\n(unsigned long) 18446744073709551615\r\n```\r\n\r\nThe definition of `change_spend_size`:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/b012bbe358311cc4a73300ccca41b64272250277/src/wallet/wallet.h#L573\r\n\r\n`CalculateMaximumSignedInputSize(Ã¢ÂÂ¦)` returns `-1` here:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/b012bbe358311cc4a73300ccca41b64272250277/src/wallet/wallet.cpp#L1510-L1520\r\n\r\nThe`change_spend_size` assignment is performed here:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/b012bbe358311cc4a73300ccca41b64272250277/src/wallet/wallet.cpp#L2725\r\n\r\nRelated open pull requests in need of review:\r\n* #14252 Ã¢ÂÂ build: Run functional tests and benchmarks under the undefined behaviour sanitizer (UBSan) (includes `-fsanitize=integer` which tackles unsigned integer wraparounds (non-UB!))\r\n* #14226 Ã¢ÂÂ mempool: Fix unintended unsigned integer wraparound in `CTxMemPool::UpdateAncestorsOf(bool add, Ã¢ÂÂ¦)` when `add` is `false`\r\n* #14224 Ã¢ÂÂ Document intentional and unintentional unsigned integer overflows (wraparounds) using annotations\r\n* #11551 Ã¢ÂÂ Fix unsigned integer wrap-around in `GetBlockProofEquivalentTime`\r\n* #11535 Ã¢ÂÂ Avoid unintentional unsigned integer wraparounds\r\n\r\nPlease help reviewing those :-)",
      "created_at" : "2018-10-04T09:42:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14380#issuecomment-426953724",
      "id" : 426953724,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14380",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyNjk1MzcyNA==",
      "updated_at" : "2018-10-04T11:33:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/426953724",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   }
]
