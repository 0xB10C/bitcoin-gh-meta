[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17579#discussion_r349952741"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17579"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/349952741"
         }
      },
      "author_association" : "MEMBER",
      "body" : "style-nit: Instead of returning an UniValue, I'd prefer to return a `CAmount`, so that (if needed) the function can also be called from unit tests easily.",
      "commit_id" : "915a40aaecd755209daa3d6ffbf50d59faf8bd4b",
      "created_at" : "2019-11-24T22:38:32Z",
      "diff_hunk" : "@@ -583,6 +583,57 @@ static UniValue signmessage(const JSONRPCRequest& request)\n     return EncodeBase64(vchSig.data(), vchSig.size());\n }\n \n+static UniValue GetReceived(interfaces::Chain::Lock& locked_chain, CWallet * const wallet, const UniValue& params, bool by_label) EXCLUSIVE_LOCKS_REQUIRED(wallet->cs_wallet)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17579#discussion_r349952741",
      "id" : 349952741,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0OTk1Mjc0MQ==",
      "original_commit_id" : "2377697e3660808890faf9c820791dfd38f26d20",
      "original_position" : 4,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : null,
      "pull_request_review_id" : 321991887,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17579",
      "updated_at" : "2019-11-25T23:11:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/349952741",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#16426](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16426.html) (Reverse cs_main, cs_wallet lock order and reduce cs_main locking by ariard)\n* [#14707](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/14707.html) ([RPC] Include coinbase transactions in receivedby RPCs by andrewtoth)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2019-11-24T23:53:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17579#issuecomment-557942635",
      "id" : 557942635,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17579",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1Nzk0MjYzNQ==",
      "updated_at" : "2019-11-24T23:53:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/557942635",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17579#discussion_r350471066"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17579"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/350471066"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "915a40aaecd755209daa3d6ffbf50d59faf8bd4b",
      "created_at" : "2019-11-25T23:12:04Z",
      "diff_hunk" : "@@ -583,6 +583,57 @@ static UniValue signmessage(const JSONRPCRequest& request)\n     return EncodeBase64(vchSig.data(), vchSig.size());\n }\n \n+static UniValue GetReceived(interfaces::Chain::Lock& locked_chain, CWallet * const wallet, const UniValue& params, bool by_label) EXCLUSIVE_LOCKS_REQUIRED(wallet->cs_wallet)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17579#discussion_r350471066",
      "id" : 350471066,
      "in_reply_to_id" : 349952741,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1MDQ3MTA2Ng==",
      "original_commit_id" : "2377697e3660808890faf9c820791dfd38f26d20",
      "original_position" : 4,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : null,
      "pull_request_review_id" : 322639265,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17579",
      "updated_at" : "2019-11-25T23:12:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/350471066",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17579#discussion_r351043470"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17579"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/351043470"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@MarcoFalke can you expand on how returning `CAmount` makes it easier to test? Is it due to not having `UniValue` as a dependency? In that case I should remove `UniValue` as a parameter as well.",
      "commit_id" : "915a40aaecd755209daa3d6ffbf50d59faf8bd4b",
      "created_at" : "2019-11-27T00:21:30Z",
      "diff_hunk" : "@@ -583,6 +583,57 @@ static UniValue signmessage(const JSONRPCRequest& request)\n     return EncodeBase64(vchSig.data(), vchSig.size());\n }\n \n+static UniValue GetReceived(interfaces::Chain::Lock& locked_chain, CWallet * const wallet, const UniValue& params, bool by_label) EXCLUSIVE_LOCKS_REQUIRED(wallet->cs_wallet)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17579#discussion_r351043470",
      "id" : 351043470,
      "in_reply_to_id" : 349952741,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1MTA0MzQ3MA==",
      "original_commit_id" : "2377697e3660808890faf9c820791dfd38f26d20",
      "original_position" : 4,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : null,
      "pull_request_review_id" : 323364360,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17579",
      "updated_at" : "2019-11-27T00:21:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/351043470",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17579#discussion_r352824275"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17579"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/352824275"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This uses the multiple address case, used by `getreceivedbylabel`, and the singular case used by `getreceivedbyaddress` is no longer needed.",
      "commit_id" : "915a40aaecd755209daa3d6ffbf50d59faf8bd4b",
      "created_at" : "2019-12-02T20:56:59Z",
      "diff_hunk" : "@@ -583,6 +583,57 @@ static UniValue signmessage(const JSONRPCRequest& request)\n     return EncodeBase64(vchSig.data(), vchSig.size());\n }\n \n+static CAmount GetReceived(interfaces::Chain::Lock& locked_chain, CWallet * const wallet, const UniValue& params, bool by_label) EXCLUSIVE_LOCKS_REQUIRED(wallet->cs_wallet)\n+{\n+    std::set<CTxDestination> addresses;\n+\n+    if (by_label) {\n+        // Get the set of pub keys assigned to label\n+        std::string label = LabelFromValue(params[0]);\n+        addresses = wallet->GetLabelAddresses(label);\n+    } else {\n+        // Get the address\n+        CTxDestination dest = DecodeDestination(params[0].get_str());\n+        if (!IsValidDestination(dest)) {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, \"Invalid Bitcoin address\");\n+        }\n+        CScript script_pub_key = GetScriptForDestination(dest);\n+        if (!wallet->IsMine(script_pub_key)) {\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"Address not found in wallet\");\n+        }\n+        addresses.insert(dest);\n+    }\n+\n+    // Minimum confirmations\n+    int min_depth = 1;\n+    if (!params[1].isNull())\n+        min_depth = params[1].get_int();\n+\n+    // Tally\n+    CAmount amount = 0;\n+    for (const std::pair<const uint256, CWalletTx>& wtx_pair : wallet->mapWallet) {\n+        const CWalletTx& wtx = wtx_pair.second;\n+        if (wtx.IsCoinBase() || !locked_chain.checkFinalTx(*wtx.tx)) {\n+            continue;\n+        }\n+\n+        int depth = wtx.GetDepthInMainChain();\n+        if (depth < min_depth) {\n+            continue;\n+        }\n+\n+        for (const CTxOut& txout : wtx.tx->vout) {\n+            CTxDestination address;\n+            if (ExtractDestination(txout.scriptPubKey, address) && wallet->IsMine(address) && addresses.count(address)) {\n+                amount += txout.nValue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17579#discussion_r352824275",
      "id" : 352824275,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1MjgyNDI3NQ==",
      "original_commit_id" : "915a40aaecd755209daa3d6ffbf50d59faf8bd4b",
      "original_position" : 46,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : 46,
      "pull_request_review_id" : 325737413,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17579",
      "updated_at" : "2019-12-02T20:56:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/352824275",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/237213?v=4",
         "events_url" : "https://api.github.com/users/andrewtoth/events{/privacy}",
         "followers_url" : "https://api.github.com/users/andrewtoth/followers",
         "following_url" : "https://api.github.com/users/andrewtoth/following{/other_user}",
         "gists_url" : "https://api.github.com/users/andrewtoth/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/andrewtoth",
         "id" : 237213,
         "login" : "andrewtoth",
         "node_id" : "MDQ6VXNlcjIzNzIxMw==",
         "organizations_url" : "https://api.github.com/users/andrewtoth/orgs",
         "received_events_url" : "https://api.github.com/users/andrewtoth/received_events",
         "repos_url" : "https://api.github.com/users/andrewtoth/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/andrewtoth/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/andrewtoth/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/andrewtoth"
      }
   }
]
