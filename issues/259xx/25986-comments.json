[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@kouloumos Thanks for the tip. I changed all tests to use MiniWallet methods in 10edc9c0d7b686808c040204103da01ed386a3c9.",
      "created_at" : "2022-09-03T08:25:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25986#issuecomment-1236074633",
      "id" : 1236074633,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25986",
      "node_id" : "IC_kwDOABII585JrQCJ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1236074633/reactions"
      },
      "updated_at" : "2022-09-03T08:25:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1236074633",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/94266259?v=4",
         "events_url" : "https://api.github.com/users/w0xlt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/w0xlt/followers",
         "following_url" : "https://api.github.com/users/w0xlt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/w0xlt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/w0xlt",
         "id" : 94266259,
         "login" : "w0xlt",
         "node_id" : "U_kgDOBZ5jkw",
         "organizations_url" : "https://api.github.com/users/w0xlt/orgs",
         "received_events_url" : "https://api.github.com/users/w0xlt/received_events",
         "repos_url" : "https://api.github.com/users/w0xlt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/w0xlt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/w0xlt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/w0xlt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25986#discussion_r962135171"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25986"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962135171"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Maybe this could become part of the MiniWallet methods as `create_self_transfer_chain` (see [`send_self_transfer_chain`](https://github.com/bitcoin/bitcoin/blob/ea67232cdb80c4bc3f16fcd823f6f811fd8903e1/test/functional/test_framework/wallet.py#L341)) to be also used at [`mempool_package_limits.py`](https://github.com/bitcoin/bitcoin/blob/ea67232cdb80c4bc3f16fcd823f6f811fd8903e1/test/functional/mempool_package_limits.py#L50-L530).\r\n\r\nSee also https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685084219 for `chain_length=25`\r\n",
      "commit_id" : "10edc9c0d7b686808c040204103da01ed386a3c9",
      "created_at" : "2022-09-03T10:28:56Z",
      "diff_hunk" : "@@ -48,33 +38,34 @@ def assert_testres_equal(self, package_hex, testres_expected):\n         shuffled_testres = [testres_expected[i] for i in shuffled_indeces]\n         assert_equal(shuffled_testres, self.nodes[0].testmempoolaccept(shuffled_package))\n \n+    def create_tx_chain(self, chain_length=25):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25986#discussion_r962135171",
      "id" : 962135171,
      "line" : 41,
      "node_id" : "PRRC_kwDOABII5845WQSD",
      "original_commit_id" : "10edc9c0d7b686808c040204103da01ed386a3c9",
      "original_line" : 41,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "test/functional/rpc_packages.py",
      "position" : 41,
      "pull_request_review_id" : 1095489108,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25986",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962135171/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-03T11:11:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962135171",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/18506343?v=4",
         "events_url" : "https://api.github.com/users/kouloumos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kouloumos/followers",
         "following_url" : "https://api.github.com/users/kouloumos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kouloumos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kouloumos",
         "id" : 18506343,
         "login" : "kouloumos",
         "node_id" : "MDQ6VXNlcjE4NTA2MzQz",
         "organizations_url" : "https://api.github.com/users/kouloumos/orgs",
         "received_events_url" : "https://api.github.com/users/kouloumos/received_events",
         "repos_url" : "https://api.github.com/users/kouloumos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kouloumos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kouloumos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kouloumos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25986#discussion_r962135359"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25986"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962135359"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "See https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685061119 about tuple. Also iirc we are mostly returning dictionaries in most of the other functions.",
      "commit_id" : "10edc9c0d7b686808c040204103da01ed386a3c9",
      "created_at" : "2022-09-03T10:31:16Z",
      "diff_hunk" : "@@ -48,33 +38,34 @@ def assert_testres_equal(self, package_hex, testres_expected):\n         shuffled_testres = [testres_expected[i] for i in shuffled_indeces]\n         assert_equal(shuffled_testres, self.nodes[0].testmempoolaccept(shuffled_package))\n \n+    def create_tx_chain(self, chain_length=25):\n+        chaintip_utxo = self.wallet.get_utxo()\n+        chain_hex = []\n+        chain_txns = []\n+\n+        for _ in range(chain_length):\n+            tx = self.wallet.create_self_transfer(utxo_to_spend=chaintip_utxo)\n+            chaintip_utxo = tx[\"new_utxo\"]\n+            chain_hex.append(tx[\"hex\"])\n+            chain_txns.append(tx[\"tx\"])\n+\n+        return (chain_hex, chain_txns)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25986#discussion_r962135359",
      "id" : 962135359,
      "line" : 52,
      "node_id" : "PRRC_kwDOABII5845WQU_",
      "original_commit_id" : "10edc9c0d7b686808c040204103da01ed386a3c9",
      "original_line" : 52,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "test/functional/rpc_packages.py",
      "position" : 52,
      "pull_request_review_id" : 1095489108,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25986",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962135359/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-03T11:11:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962135359",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/18506343?v=4",
         "events_url" : "https://api.github.com/users/kouloumos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kouloumos/followers",
         "following_url" : "https://api.github.com/users/kouloumos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kouloumos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kouloumos",
         "id" : 18506343,
         "login" : "kouloumos",
         "node_id" : "MDQ6VXNlcjE4NTA2MzQz",
         "organizations_url" : "https://api.github.com/users/kouloumos/orgs",
         "received_events_url" : "https://api.github.com/users/kouloumos/received_events",
         "repos_url" : "https://api.github.com/users/kouloumos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kouloumos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kouloumos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kouloumos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25986#discussion_r962135640"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25986"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962135640"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Since recently `rescan_utxos()` is called at the end of `generate`.\r\nhttps://github.com/bitcoin/bitcoin/blob/ea67232cdb80c4bc3f16fcd823f6f811fd8903e1/test/functional/test_framework/wallet.py#L171",
      "commit_id" : "10edc9c0d7b686808c040204103da01ed386a3c9",
      "created_at" : "2022-09-03T10:34:07Z",
      "diff_hunk" : "@@ -48,33 +38,34 @@ def assert_testres_equal(self, package_hex, testres_expected):\n         shuffled_testres = [testres_expected[i] for i in shuffled_indeces]\n         assert_equal(shuffled_testres, self.nodes[0].testmempoolaccept(shuffled_package))\n \n+    def create_tx_chain(self, chain_length=25):\n+        chaintip_utxo = self.wallet.get_utxo()\n+        chain_hex = []\n+        chain_txns = []\n+\n+        for _ in range(chain_length):\n+            tx = self.wallet.create_self_transfer(utxo_to_spend=chaintip_utxo)\n+            chaintip_utxo = tx[\"new_utxo\"]\n+            chain_hex.append(tx[\"hex\"])\n+            chain_txns.append(tx[\"tx\"])\n+\n+        return (chain_hex, chain_txns)\n+\n     def run_test(self):\n-        self.log.info(\"Generate blocks to create UTXOs\")\n-        node = self.nodes[0]\n-        self.privkeys = [node.get_deterministic_priv_key().key]\n-        self.address = node.get_deterministic_priv_key().address\n-        self.coins = []\n-        # The last 100 coinbase transactions are premature\n-        for b in self.generatetoaddress(node, 220, self.address)[:-100]:\n-            coinbase = node.getblock(blockhash=b, verbosity=2)[\"tx\"][0]\n-            self.coins.append({\n-                \"txid\": coinbase[\"txid\"],\n-                \"amount\": coinbase[\"vout\"][0][\"value\"],\n-                \"scriptPubKey\": coinbase[\"vout\"][0][\"scriptPubKey\"],\n-            })\n+        self.wallet = MiniWallet(self.nodes[0])\n \n+        self.generate(self.wallet, COINBASE_MATURITY + 100)  # blocks generated for inputs\n+        self.wallet.rescan_utxos()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25986#discussion_r962135640",
      "id" : 962135640,
      "line" : 58,
      "node_id" : "PRRC_kwDOABII5845WQZY",
      "original_commit_id" : "10edc9c0d7b686808c040204103da01ed386a3c9",
      "original_line" : 58,
      "original_position" : 71,
      "original_start_line" : null,
      "path" : "test/functional/rpc_packages.py",
      "position" : 71,
      "pull_request_review_id" : 1095489108,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25986",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962135640/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-03T11:11:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962135640",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/18506343?v=4",
         "events_url" : "https://api.github.com/users/kouloumos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kouloumos/followers",
         "following_url" : "https://api.github.com/users/kouloumos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kouloumos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kouloumos",
         "id" : 18506343,
         "login" : "kouloumos",
         "node_id" : "MDQ6VXNlcjE4NTA2MzQz",
         "organizations_url" : "https://api.github.com/users/kouloumos/orgs",
         "received_events_url" : "https://api.github.com/users/kouloumos/received_events",
         "repos_url" : "https://api.github.com/users/kouloumos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kouloumos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kouloumos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kouloumos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25986#discussion_r962136086"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25986"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962136086"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`create_self_transfer` returns the hex, so you could  avoid `tx.serialize().hex()` \r\n```suggestion\r\n            tx_hex = self.wallet.create_self_transfer(fee_rate=Decimal(\"0.0001\"))[\"hex]\r\n```",
      "commit_id" : "10edc9c0d7b686808c040204103da01ed386a3c9",
      "created_at" : "2022-09-03T10:38:45Z",
      "diff_hunk" : "@@ -48,33 +38,34 @@ def assert_testres_equal(self, package_hex, testres_expected):\n         shuffled_testres = [testres_expected[i] for i in shuffled_indeces]\n         assert_equal(shuffled_testres, self.nodes[0].testmempoolaccept(shuffled_package))\n \n+    def create_tx_chain(self, chain_length=25):\n+        chaintip_utxo = self.wallet.get_utxo()\n+        chain_hex = []\n+        chain_txns = []\n+\n+        for _ in range(chain_length):\n+            tx = self.wallet.create_self_transfer(utxo_to_spend=chaintip_utxo)\n+            chaintip_utxo = tx[\"new_utxo\"]\n+            chain_hex.append(tx[\"hex\"])\n+            chain_txns.append(tx[\"tx\"])\n+\n+        return (chain_hex, chain_txns)\n+\n     def run_test(self):\n-        self.log.info(\"Generate blocks to create UTXOs\")\n-        node = self.nodes[0]\n-        self.privkeys = [node.get_deterministic_priv_key().key]\n-        self.address = node.get_deterministic_priv_key().address\n-        self.coins = []\n-        # The last 100 coinbase transactions are premature\n-        for b in self.generatetoaddress(node, 220, self.address)[:-100]:\n-            coinbase = node.getblock(blockhash=b, verbosity=2)[\"tx\"][0]\n-            self.coins.append({\n-                \"txid\": coinbase[\"txid\"],\n-                \"amount\": coinbase[\"vout\"][0][\"value\"],\n-                \"scriptPubKey\": coinbase[\"vout\"][0][\"scriptPubKey\"],\n-            })\n+        self.wallet = MiniWallet(self.nodes[0])\n \n+        self.generate(self.wallet, COINBASE_MATURITY + 100)  # blocks generated for inputs\n+        self.wallet.rescan_utxos()\n+\n+        self.log.info(\"Create some transactions\")\n         # Create some transactions that can be reused throughout the test. Never submit these to mempool.\n         self.independent_txns_hex = []\n         self.independent_txns_testres = []\n         for _ in range(3):\n-            coin = self.coins.pop()\n-            rawtx = node.createrawtransaction([{\"txid\": coin[\"txid\"], \"vout\": 0}],\n-                {self.address : coin[\"amount\"] - Decimal(\"0.0001\")})\n-            signedtx = node.signrawtransactionwithkey(hexstring=rawtx, privkeys=self.privkeys)\n-            assert signedtx[\"complete\"]\n-            testres = node.testmempoolaccept([signedtx[\"hex\"]])\n+            tx = self.wallet.create_self_transfer(fee_rate=Decimal(\"0.0001\"))[\"tx\"]",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25986#discussion_r962136086",
      "id" : 962136086,
      "line" : 65,
      "node_id" : "PRRC_kwDOABII5845WQgW",
      "original_commit_id" : "10edc9c0d7b686808c040204103da01ed386a3c9",
      "original_line" : 65,
      "original_position" : 84,
      "original_start_line" : null,
      "path" : "test/functional/rpc_packages.py",
      "position" : 84,
      "pull_request_review_id" : 1095489108,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25986",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962136086/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-03T11:11:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962136086",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/18506343?v=4",
         "events_url" : "https://api.github.com/users/kouloumos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kouloumos/followers",
         "following_url" : "https://api.github.com/users/kouloumos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kouloumos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kouloumos",
         "id" : 18506343,
         "login" : "kouloumos",
         "node_id" : "MDQ6VXNlcjE4NTA2MzQz",
         "organizations_url" : "https://api.github.com/users/kouloumos/orgs",
         "received_events_url" : "https://api.github.com/users/kouloumos/received_events",
         "repos_url" : "https://api.github.com/users/kouloumos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kouloumos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kouloumos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kouloumos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25986#discussion_r962137464"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25986"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962137464"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Where is this used?",
      "commit_id" : "10edc9c0d7b686808c040204103da01ed386a3c9",
      "created_at" : "2022-09-03T10:52:37Z",
      "diff_hunk" : "@@ -91,52 +82,64 @@ def run_test(self):\n     def test_independent(self):\n         self.log.info(\"Test multiple independent transactions in a package\")\n         node = self.nodes[0]\n+\n         # For independent transactions, order doesn't matter.\n         self.assert_testres_equal(self.independent_txns_hex, self.independent_txns_testres)\n \n         self.log.info(\"Test an otherwise valid package with an extra garbage tx appended\")\n-        garbage_tx = node.createrawtransaction([{\"txid\": \"00\" * 32, \"vout\": 5}], {self.address: 1})\n-        tx = tx_from_hex(garbage_tx)\n+        garbage_utxo = {\"txid\": \"00\" * 32, \"vout\": 5, \"value\": 3, \"height\": 0}\n+        garbage_tx = self.wallet.create_self_transfer(utxo_to_spend=garbage_utxo)\n         # Only the txid and wtxids are returned because validation is incomplete for the independent txns.\n         # Package validation is atomic: if the node cannot find a UTXO for any single tx in the package,\n         # it terminates immediately to avoid unnecessary, expensive signature verification.\n-        package_bad = self.independent_txns_hex + [garbage_tx]\n-        testres_bad = self.independent_txns_testres_blank + [{\"txid\": tx.rehash(), \"wtxid\": tx.getwtxid(), \"allowed\": False, \"reject-reason\": \"missing-inputs\"}]\n+        package_bad = self.independent_txns_hex + [garbage_tx[\"hex\"]]\n+        testres_bad = self.independent_txns_testres_blank + [{\"txid\": garbage_tx[\"txid\"], \"wtxid\": garbage_tx[\"wtxid\"], \"allowed\": False, \"reject-reason\": \"missing-inputs\"}]\n         self.assert_testres_equal(package_bad, testres_bad)\n \n         self.log.info(\"Check testmempoolaccept tells us when some transactions completed validation successfully\")\n-        coin = self.coins.pop()\n-        tx_bad_sig_hex = node.createrawtransaction([{\"txid\": coin[\"txid\"], \"vout\": 0}],\n-                                           {self.address : coin[\"amount\"] - Decimal(\"0.0001\")})\n-        tx_bad_sig = tx_from_hex(tx_bad_sig_hex)\n+        # get an UTXO that requires signature to be spent\n+        deterministic_address = node.get_deterministic_priv_key().address\n+        blockhash = self.generatetoaddress(node, 1, deterministic_address)[0]\n+        coinbase = node.getblock(blockhash=blockhash, verbosity=2)[\"tx\"][0]\n+        coin = {\n+                \"txid\": coinbase[\"txid\"],\n+                \"value\": coinbase[\"vout\"][0][\"value\"],\n+                \"scriptPubKey\": coinbase[\"vout\"][0][\"scriptPubKey\"],\n+                \"vout\": 0,\n+                \"height\": 0\n+            }\n+        self.generate(node, COINBASE_MATURITY, sync_fun=self.no_op)\n+\n+        tx_bad_sig = self.wallet.create_self_transfer(utxo_to_spend=coin)['tx']\n+        tx_bad_sig.wit.vtxinwit = []\n+        tx_bad_sig_hex = tx_bad_sig.serialize().hex()\n         testres_bad_sig = node.testmempoolaccept(self.independent_txns_hex + [tx_bad_sig_hex])\n         # By the time the signature for the last transaction is checked, all the other transactions\n         # have been fully validated, which is why the node returns full validation results for all\n         # transactions here but empty results in other cases.\n         assert_equal(testres_bad_sig, self.independent_txns_testres + [{\n             \"txid\": tx_bad_sig.rehash(),\n-            \"wtxid\": tx_bad_sig.getwtxid(), \"allowed\": False,\n+            \"wtxid\": tx_bad_sig.getwtxid(),\n+            \"allowed\": False,\n             \"reject-reason\": \"mandatory-script-verify-flag-failed (Operation not valid with the current stack size)\"\n         }])\n \n         self.log.info(\"Check testmempoolaccept reports txns in packages that exceed max feerate\")\n-        coin = self.coins.pop()\n-        tx_high_fee_raw = node.createrawtransaction([{\"txid\": coin[\"txid\"], \"vout\": 0}],\n-                                           {self.address : coin[\"amount\"] - Decimal(\"0.999\")})\n-        tx_high_fee_signed = node.signrawtransactionwithkey(hexstring=tx_high_fee_raw, privkeys=self.privkeys)\n-        assert tx_high_fee_signed[\"complete\"]\n-        tx_high_fee = tx_from_hex(tx_high_fee_signed[\"hex\"])\n-        testres_high_fee = node.testmempoolaccept([tx_high_fee_signed[\"hex\"]])\n+        coin = self.wallet.get_utxo()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25986#discussion_r962137464",
      "id" : 962137464,
      "line" : 128,
      "node_id" : "PRRC_kwDOABII5845WQ14",
      "original_commit_id" : "10edc9c0d7b686808c040204103da01ed386a3c9",
      "original_line" : 128,
      "original_position" : 155,
      "original_start_line" : null,
      "path" : "test/functional/rpc_packages.py",
      "position" : 155,
      "pull_request_review_id" : 1095489108,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25986",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962137464/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-03T11:11:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962137464",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/18506343?v=4",
         "events_url" : "https://api.github.com/users/kouloumos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kouloumos/followers",
         "following_url" : "https://api.github.com/users/kouloumos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kouloumos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kouloumos",
         "id" : 18506343,
         "login" : "kouloumos",
         "node_id" : "MDQ6VXNlcjE4NTA2MzQz",
         "organizations_url" : "https://api.github.com/users/kouloumos/orgs",
         "received_events_url" : "https://api.github.com/users/kouloumos/received_events",
         "repos_url" : "https://api.github.com/users/kouloumos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kouloumos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kouloumos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kouloumos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25986#discussion_r962137598"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25986"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962137598"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: double #",
      "commit_id" : "10edc9c0d7b686808c040204103da01ed386a3c9",
      "created_at" : "2022-09-03T10:54:21Z",
      "diff_hunk" : "@@ -158,156 +161,115 @@ def test_chain(self):\n \n     def test_multiple_children(self):\n         node = self.nodes[0]\n-\n         self.log.info(\"Testmempoolaccept a package in which a transaction has two children within the package\")\n-        first_coin = self.coins.pop()\n-        value = (first_coin[\"amount\"] - Decimal(\"0.0002\")) / 2 # Deduct reasonable fee and make 2 outputs\n-        inputs = [{\"txid\": first_coin[\"txid\"], \"vout\": 0}]\n-        outputs = [{self.address : value}, {ADDRESS_BCRT1_P2WSH_OP_TRUE : value}]\n-        rawtx = node.createrawtransaction(inputs, outputs)\n \n-        parent_signed = node.signrawtransactionwithkey(hexstring=rawtx, privkeys=self.privkeys)\n-        assert parent_signed[\"complete\"]\n-        parent_tx = tx_from_hex(parent_signed[\"hex\"])\n-        parent_txid = parent_tx.rehash()\n-        assert node.testmempoolaccept([parent_signed[\"hex\"]])[0][\"allowed\"]\n-\n-        parent_locking_script_a = parent_tx.vout[0].scriptPubKey.hex()\n-        child_value = value - Decimal(\"0.0001\")\n+        parent_tx = self.wallet.create_self_transfer_multi(num_outputs=2)\n+        assert node.testmempoolaccept([parent_tx[\"hex\"]])[0][\"allowed\"]\n \n         # Child A\n-        (_, tx_child_a_hex, _, _) = make_chain(node, self.address, self.privkeys, parent_txid, child_value, 0, parent_locking_script_a)\n-        assert not node.testmempoolaccept([tx_child_a_hex])[0][\"allowed\"]\n+        child_a_tx = self.wallet.create_self_transfer(utxo_to_spend=parent_tx[\"new_utxos\"][0])\n+        assert not node.testmempoolaccept([child_a_tx[\"hex\"]])[0][\"allowed\"]\n \n-        # Child B\n-        rawtx_b = node.createrawtransaction([{\"txid\": parent_txid, \"vout\": 1}], {self.address : child_value})\n-        tx_child_b = tx_from_hex(rawtx_b)\n-        tx_child_b.wit.vtxinwit = [CTxInWitness()]\n-        tx_child_b.wit.vtxinwit[0].scriptWitness.stack = [CScript([OP_TRUE])]\n-        tx_child_b_hex = tx_child_b.serialize().hex()\n-        assert not node.testmempoolaccept([tx_child_b_hex])[0][\"allowed\"]\n+        # # Child B",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25986#discussion_r962137598",
      "id" : 962137598,
      "line" : 173,
      "node_id" : "PRRC_kwDOABII5845WQ3-",
      "original_commit_id" : "10edc9c0d7b686808c040204103da01ed386a3c9",
      "original_line" : 173,
      "original_position" : 212,
      "original_start_line" : null,
      "path" : "test/functional/rpc_packages.py",
      "position" : 212,
      "pull_request_review_id" : 1095489108,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25986",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962137598/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-03T11:11:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962137598",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/18506343?v=4",
         "events_url" : "https://api.github.com/users/kouloumos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kouloumos/followers",
         "following_url" : "https://api.github.com/users/kouloumos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kouloumos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kouloumos",
         "id" : 18506343,
         "login" : "kouloumos",
         "node_id" : "MDQ6VXNlcjE4NTA2MzQz",
         "organizations_url" : "https://api.github.com/users/kouloumos/orgs",
         "received_events_url" : "https://api.github.com/users/kouloumos/received_events",
         "repos_url" : "https://api.github.com/users/kouloumos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kouloumos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kouloumos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kouloumos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25986#discussion_r962137676"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25986"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962137676"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think this comment is still useful. \r\n\r\nSame for the rest of the comments that you deleted later in the code, just writing it here to avoid multiple comments.",
      "commit_id" : "10edc9c0d7b686808c040204103da01ed386a3c9",
      "created_at" : "2022-09-03T10:55:01Z",
      "diff_hunk" : "@@ -158,156 +161,115 @@ def test_chain(self):\n \n     def test_multiple_children(self):\n         node = self.nodes[0]\n-\n         self.log.info(\"Testmempoolaccept a package in which a transaction has two children within the package\")\n-        first_coin = self.coins.pop()\n-        value = (first_coin[\"amount\"] - Decimal(\"0.0002\")) / 2 # Deduct reasonable fee and make 2 outputs\n-        inputs = [{\"txid\": first_coin[\"txid\"], \"vout\": 0}]\n-        outputs = [{self.address : value}, {ADDRESS_BCRT1_P2WSH_OP_TRUE : value}]\n-        rawtx = node.createrawtransaction(inputs, outputs)\n \n-        parent_signed = node.signrawtransactionwithkey(hexstring=rawtx, privkeys=self.privkeys)\n-        assert parent_signed[\"complete\"]\n-        parent_tx = tx_from_hex(parent_signed[\"hex\"])\n-        parent_txid = parent_tx.rehash()\n-        assert node.testmempoolaccept([parent_signed[\"hex\"]])[0][\"allowed\"]\n-\n-        parent_locking_script_a = parent_tx.vout[0].scriptPubKey.hex()\n-        child_value = value - Decimal(\"0.0001\")\n+        parent_tx = self.wallet.create_self_transfer_multi(num_outputs=2)\n+        assert node.testmempoolaccept([parent_tx[\"hex\"]])[0][\"allowed\"]\n \n         # Child A\n-        (_, tx_child_a_hex, _, _) = make_chain(node, self.address, self.privkeys, parent_txid, child_value, 0, parent_locking_script_a)\n-        assert not node.testmempoolaccept([tx_child_a_hex])[0][\"allowed\"]\n+        child_a_tx = self.wallet.create_self_transfer(utxo_to_spend=parent_tx[\"new_utxos\"][0])\n+        assert not node.testmempoolaccept([child_a_tx[\"hex\"]])[0][\"allowed\"]\n \n-        # Child B\n-        rawtx_b = node.createrawtransaction([{\"txid\": parent_txid, \"vout\": 1}], {self.address : child_value})\n-        tx_child_b = tx_from_hex(rawtx_b)\n-        tx_child_b.wit.vtxinwit = [CTxInWitness()]\n-        tx_child_b.wit.vtxinwit[0].scriptWitness.stack = [CScript([OP_TRUE])]\n-        tx_child_b_hex = tx_child_b.serialize().hex()\n-        assert not node.testmempoolaccept([tx_child_b_hex])[0][\"allowed\"]\n+        # # Child B\n+        child_b_tx = self.wallet.create_self_transfer(utxo_to_spend=parent_tx[\"new_utxos\"][1])\n+        assert not node.testmempoolaccept([child_b_tx[\"hex\"]])[0][\"allowed\"]\n \n         self.log.info(\"Testmempoolaccept with entire package, should work with children in either order\")\n-        testres_multiple_ab = node.testmempoolaccept(rawtxs=[parent_signed[\"hex\"], tx_child_a_hex, tx_child_b_hex])\n-        testres_multiple_ba = node.testmempoolaccept(rawtxs=[parent_signed[\"hex\"], tx_child_b_hex, tx_child_a_hex])\n+        testres_multiple_ab = node.testmempoolaccept(rawtxs=[parent_tx[\"hex\"], child_a_tx[\"hex\"], child_b_tx[\"hex\"]])\n+        testres_multiple_ba = node.testmempoolaccept(rawtxs=[parent_tx[\"hex\"], child_a_tx[\"hex\"], child_b_tx[\"hex\"]])\n         assert all([testres[\"allowed\"] for testres in testres_multiple_ab + testres_multiple_ba])\n \n         testres_single = []\n         # Test accept and then submit each one individually, which should be identical to package testaccept\n-        for rawtx in [parent_signed[\"hex\"], tx_child_a_hex, tx_child_b_hex]:\n+        for rawtx in [parent_tx[\"hex\"], child_a_tx[\"hex\"], child_b_tx[\"hex\"]]:\n             testres = node.testmempoolaccept([rawtx])\n             testres_single.append(testres[0])\n             # Submit the transaction now so its child should have no problem validating\n             node.sendrawtransaction(rawtx)\n         assert_equal(testres_single, testres_multiple_ab)\n \n-\n     def test_multiple_parents(self):\n         node = self.nodes[0]\n-\n         self.log.info(\"Testmempoolaccept a package in which a transaction has multiple parents within the package\")\n+\n         for num_parents in [2, 10, 24]:\n             # Test a package with num_parents parents and 1 child transaction.\n+            parent_coins = []\n             package_hex = []\n-            parents_tx = []\n-            values = []\n-            parent_locking_scripts = []\n+\n             for _ in range(num_parents):\n-                parent_coin = self.coins.pop()\n-                value = parent_coin[\"amount\"]\n-                (tx, txhex, value, parent_locking_script) = make_chain(node, self.address, self.privkeys, parent_coin[\"txid\"], value)\n-                package_hex.append(txhex)\n-                parents_tx.append(tx)\n-                values.append(value)\n-                parent_locking_scripts.append(parent_locking_script)\n-            child_hex = create_child_with_parents(node, self.address, self.privkeys, parents_tx, values, parent_locking_scripts)\n-            # Package accept should work with the parents in any order (as long as parents come before child)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25986#discussion_r962137676",
      "id" : 962137676,
      "line" : 224,
      "node_id" : "PRRC_kwDOABII5845WQ5M",
      "original_commit_id" : "10edc9c0d7b686808c040204103da01ed386a3c9",
      "original_line" : 224,
      "original_position" : 256,
      "original_start_line" : null,
      "path" : "test/functional/rpc_packages.py",
      "position" : 256,
      "pull_request_review_id" : 1095489108,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25986",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962137676/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-03T11:11:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962137676",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/18506343?v=4",
         "events_url" : "https://api.github.com/users/kouloumos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kouloumos/followers",
         "following_url" : "https://api.github.com/users/kouloumos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kouloumos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kouloumos",
         "id" : 18506343,
         "login" : "kouloumos",
         "node_id" : "MDQ6VXNlcjE4NTA2MzQz",
         "organizations_url" : "https://api.github.com/users/kouloumos/orgs",
         "received_events_url" : "https://api.github.com/users/kouloumos/received_events",
         "repos_url" : "https://api.github.com/users/kouloumos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kouloumos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kouloumos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kouloumos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25986#discussion_r962138910"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25986"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962138910"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`create_self_transfer` already returns `wtxid`, maybe it makes sense for `create_self_transfer_multi` to also return it.",
      "commit_id" : "10edc9c0d7b686808c040204103da01ed386a3c9",
      "created_at" : "2022-09-03T11:07:56Z",
      "diff_hunk" : "@@ -330,31 +292,22 @@ def assert_equal_package_results(self, node, testmempoolaccept_result, submitpac\n     def test_submit_child_with_parents(self, num_parents, partial_submit):\n         node = self.nodes[0]\n         peer = node.add_p2p_connection(P2PTxInvStore())\n-        # Test a package with num_parents parents and 1 child transaction.\n-        package_hex = []\n+\n         package_txns = []\n-        values = []\n-        scripts = []\n         for _ in range(num_parents):\n-            parent_coin = self.coins.pop()\n-            value = parent_coin[\"amount\"]\n-            (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, parent_coin[\"txid\"], value)\n-            package_hex.append(txhex)\n-            package_txns.append(tx)\n-            values.append(value)\n-            scripts.append(spk)\n+            parent_tx = self.wallet.create_self_transfer(fee=DEFAULT_FEE)\n+            package_txns.append(parent_tx)\n             if partial_submit and random.choice([True, False]):\n-                node.sendrawtransaction(txhex)\n-        child_hex = create_child_with_parents(node, self.address, self.privkeys, package_txns, values, scripts)\n-        package_hex.append(child_hex)\n-        package_txns.append(tx_from_hex(child_hex))\n+                node.sendrawtransaction(parent_tx[\"hex\"])\n+        child_tx = self.wallet.create_self_transfer_multi(utxos_to_spend=[tx[\"new_utxo\"] for tx in package_txns], fee_per_output=10000) #DEFAULT_FEE\n+        package_txns.append(child_tx)\n \n-        testmempoolaccept_result = node.testmempoolaccept(rawtxs=package_hex)\n-        submitpackage_result = node.submitpackage(package=package_hex)\n+        testmempoolaccept_result = node.testmempoolaccept(rawtxs=[tx[\"hex\"] for tx in package_txns])\n+        submitpackage_result = node.submitpackage(package=[tx[\"hex\"] for tx in package_txns])\n \n         # Check that each result is present, with the correct size and fees\n-        for i in range(num_parents + 1):\n-            tx = package_txns[i]\n+        for package_tx in package_txns:\n+            tx = package_tx['tx']\n             wtxid = tx.getwtxid()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25986#discussion_r962138910",
      "id" : 962138910,
      "line" : 311,
      "node_id" : "PRRC_kwDOABII5845WRMe",
      "original_commit_id" : "10edc9c0d7b686808c040204103da01ed386a3c9",
      "original_line" : 311,
      "original_position" : 417,
      "original_start_line" : null,
      "path" : "test/functional/rpc_packages.py",
      "position" : 417,
      "pull_request_review_id" : 1095489108,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25986",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962138910/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-03T11:11:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962138910",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/18506343?v=4",
         "events_url" : "https://api.github.com/users/kouloumos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kouloumos/followers",
         "following_url" : "https://api.github.com/users/kouloumos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kouloumos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kouloumos",
         "id" : 18506343,
         "login" : "kouloumos",
         "node_id" : "MDQ6VXNlcjE4NTA2MzQz",
         "organizations_url" : "https://api.github.com/users/kouloumos/orgs",
         "received_events_url" : "https://api.github.com/users/kouloumos/received_events",
         "repos_url" : "https://api.github.com/users/kouloumos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kouloumos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kouloumos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kouloumos"
      }
   }
]
