[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.",
      "created_at" : "2022-08-29T23:11:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#issuecomment-1230961273",
      "id" : 1230961273,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25957",
      "node_id" : "IC_kwDOABII585JXvp5",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1230961273/reactions"
      },
      "updated_at" : "2022-09-03T17:10:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1230961273",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK\r\n\r\nLimiting the functionality to descriptor wallets is fine. We could add an argument to `loadwallet` that prevents a rescan, so a user can migrate (#19602) to a descriptor wallet and then rescan.\r\n\r\nIs there anything in @jamesob's #23549 you can reuse here?\r\n\r\nThe `rescanwallet` RPC help should mention that having `-blockfilterindex=1` dramatically speeds things up. It might also be good to have log message somewhere that it's using the block filter.\r\n\r\nI tried a rescan from genesis on a simple mainnet wallet. It was blazing fast (in comparison) and it found all transactions. It's  also slightly faster than the little helper script I wrote for [#23549](https://github.com/bitcoin/bitcoin/pull/23549#issuecomment-1149904391).\r\n\r\nBonus feature for a followup: fetch any matching pruned blocks.",
      "created_at" : "2022-08-31T12:12:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#issuecomment-1232855764",
      "id" : 1232855764,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25957",
      "node_id" : "IC_kwDOABII585Je-LU",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1232855764/reactions"
      },
      "updated_at" : "2022-08-31T12:38:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1232855764",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-09-01T21:15:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#issuecomment-1234790738",
      "id" : 1234790738,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25957",
      "node_id" : "IC_kwDOABII585JmWlS",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1234790738/reactions"
      },
      "updated_at" : "2022-09-01T21:15:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1234790738",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased on master, with a few changes and an extra commit (see below).\r\n\r\n@Sjors:\r\n\r\nThanks for your initial feedback, much appreciated!\r\n\r\n> Limiting the functionality to descriptor wallets is fine. We could add an argument to `loadwallet` that prevents a rescan, so a user can migrate (#19602) to a descriptor wallet and then rescan.\r\n\r\nAgree, I think this sounds like a useful follow-up idea.\r\n\r\n> Is there anything in @jamesob's #23549 you can reuse here?\r\n\r\nNot that I could see; on contrast to scanblocks, the filter set is created from wallet-internal source rather than external user input and also has to be updated continuously.\r\n\r\n> The `rescanwallet` RPC help should mention that having `-blockfilterindex=1` dramatically speeds things up. It might also be good to have log message somewhere that it's using the block filter.\r\n\r\nDone, added [an extra commit](https://github.com/bitcoin/bitcoin/pull/25957/commits/d0114e02cddd9bf1cc8760ebe95941f80609259b) that documents the speedup possibilty for all RPCs that work on descriptor wallet and (possibly) involve a rescan (`rescanblockchain`, `importdescriptors`, `restorewallet` and `loadwallet`; did I miss any?). Also extended the \"Rescan started from block...\" debug message, showing if the fast or slow variant is used.\r\n\r\n> \r\n> I tried a rescan from genesis on a simple mainnet wallet. It was blazing fast (in comparison) and it found all transactions. It's also slightly faster than the little helper script I wrote for [#23549](https://github.com/bitcoin/bitcoin/pull/23549#issuecomment-1149904391).\r\n\r\nð ð ð \r\n\r\n> \r\n> Bonus feature for a followup: fetch any matching pruned blocks.\r\n\r\nSounds like a charming idea ð \r\n\r\nNote that this PR is covered in the [PR review club for next wednesday](https://bitcoincore.reviews/25957), hosted by LarryRuane.",
      "created_at" : "2022-09-02T16:23:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#issuecomment-1235691177",
      "id" : 1235691177,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25957",
      "node_id" : "IC_kwDOABII585Jpyap",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1235691177/reactions"
      },
      "updated_at" : "2022-09-02T16:23:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1235691177",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r962466047"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962466047"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "d0114e02cddd9bf1cc8760ebe95941f80609259b nit\r\n```suggestion\r\n            auto desc_spkm = dynamic_cast<DescriptorScriptPubKeyMan*>(spkm);\r\n```",
      "commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "created_at" : "2022-09-05T04:27:22Z",
      "diff_hunk" : "@@ -260,6 +260,60 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)\n+    {\n+        // fast rescanning via block filters is only supported by descriptor wallets right now\n+        assert(!m_wallet.IsLegacy());\n+\n+        // create initial filter with scripts from both active and non-active ScriptPubKeyMans\n+        auto active_spkms = m_wallet.GetActiveScriptPubKeyMans();\n+        for (auto spkm : m_wallet.GetAllScriptPubKeyMans()) {\n+            auto* desc_spkm = dynamic_cast<DescriptorScriptPubKeyMan*>(spkm);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r962466047",
      "id" : 962466047,
      "line" : 275,
      "node_id" : "PRRC_kwDOABII5845XhD_",
      "original_commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "original_line" : 275,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 16,
      "pull_request_review_id" : 1095833132,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962466047/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-05T19:35:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962466047",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r962912290"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962912290"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: Some methods here are called `has...`, others `have...`. I'm not sure where the `have...` comes from, but it sounds weird. Could you change that to `hasBlockFilterIndex()` ?\r\n```suggestion\r\n    virtual bool hasBlockFilterIndex() = 0;\r\n```",
      "commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "created_at" : "2022-09-05T13:31:48Z",
      "diff_hunk" : "@@ -143,6 +144,13 @@ class Chain\n     //! or one of its ancestors.\n     virtual std::optional<int> findLocatorFork(const CBlockLocator& locator) = 0;\n \n+    //! Returns whether a block filter index is available.\n+    virtual bool haveBlockFilterIndex() = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r962912290",
      "id" : 962912290,
      "line" : 148,
      "node_id" : "PRRC_kwDOABII5845ZOAi",
      "original_commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "original_line" : 148,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/interfaces/chain.h",
      "position" : 13,
      "pull_request_review_id" : 1096463603,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962912290/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-05T15:23:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962912290",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r962921746"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962921746"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "There's a bit of an interface inconsistency here (and in `blockFilterMatchesAny `) in that so far most of the blockfilter functions don't assume the type to be basic but rather expect them to be passed. Have you considered this? One alternative could be add \"basic\" in the function name, which can then be refactored later if/when we have more filtertypes, but at least then it'll be more explicit? At first glance, I _think_ I'd prefer just passing the `FilterType::BASIC` to stay consistent but no strong view (yet).",
      "commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "created_at" : "2022-09-05T13:42:13Z",
      "diff_hunk" : "@@ -536,6 +537,20 @@ class ChainImpl : public Chain\n         }\n         return std::nullopt;\n     }\n+    bool haveBlockFilterIndex() override",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r962921746",
      "id" : 962921746,
      "line" : 540,
      "node_id" : "PRRC_kwDOABII5845ZQUS",
      "original_commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "original_line" : 540,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : 12,
      "pull_request_review_id" : 1096463603,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962921746/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-05T15:23:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962921746",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r962928271"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962928271"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is a lot of code duplication from `GetScriptPubKeys`. At first sight, I don't really see why this couldn't be an overloaded function or default parameter?",
      "commit_id" : "f9052af3988304a3903da085296552e60c184431",
      "created_at" : "2022-09-05T13:49:36Z",
      "diff_hunk" : "@@ -2652,6 +2652,18 @@ const std::unordered_set<CScript, SaltedSipHasher> DescriptorScriptPubKeyMan::Ge\n     return script_pub_keys;\n }\n \n+const std::vector<CScript> DescriptorScriptPubKeyMan::GetScriptPubKeysWithMinIndex(int32_t minimum_index) const\n+{\n+    LOCK(cs_desc_man);\n+    std::vector<CScript> script_pub_keys;\n+    script_pub_keys.reserve(m_map_script_pub_keys.size());\n+\n+    for (auto const& [script_pub_key, index] : m_map_script_pub_keys) {\n+        if (index >= minimum_index) script_pub_keys.emplace_back(script_pub_key);\n+    }\n+    return script_pub_keys;\n+}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r962928271",
      "id" : 962928271,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5845ZR6P",
      "original_commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "original_line" : 2665,
      "original_position" : 14,
      "original_start_line" : 2655,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 1096463603,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962928271/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-09-07T08:01:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962928271",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r962937400"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962937400"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: Maybe a brief docstring would be helpful here? The name is not immediately obvious imo.",
      "commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "created_at" : "2022-09-05T13:59:24Z",
      "diff_hunk" : "@@ -260,6 +260,60 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)\n+    {\n+        // fast rescanning via block filters is only supported by descriptor wallets right now\n+        assert(!m_wallet.IsLegacy());\n+\n+        // create initial filter with scripts from both active and non-active ScriptPubKeyMans\n+        auto active_spkms = m_wallet.GetActiveScriptPubKeyMans();\n+        for (auto spkm : m_wallet.GetAllScriptPubKeyMans()) {\n+            auto* desc_spkm = dynamic_cast<DescriptorScriptPubKeyMan*>(spkm);\n+            for (const auto& script_pub_key : desc_spkm->GetScriptPubKeys()) {\n+                m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\n+            }\n+            // save active ScriptPubKeyMans's end ranges for possible future filter updates\n+            if (active_spkms.find(spkm) != active_spkms.end()) {\n+                m_last_range_ends.emplace(desc_spkm, GetDescriptorSPKRangeEnd(*desc_spkm));\n+            }\n+        }\n+    }\n+\n+    void UpdateIfNeeded()\n+    {\n+        // repopulate filter with new scripts if top-up has happened since last iteration\n+        for (auto [desc_spkm, last_range_end] : m_last_range_ends) {\n+            int32_t current_range_end = GetDescriptorSPKRangeEnd(*desc_spkm);\n+            if (current_range_end > last_range_end) {\n+                for (const auto& script_pub_key : desc_spkm->GetScriptPubKeysWithMinIndex(last_range_end)) {\n+                    m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\n+                }\n+                m_last_range_ends.at(desc_spkm) = current_range_end;\n+            }\n+        }\n+    }\n+\n+    std::optional<bool> MatchesBlock(const uint256& block_hash) const\n+    {\n+        return m_wallet.chain().blockFilterMatchesAny(block_hash, m_filter_set);\n+    }\n+\n+private:\n+    const CWallet& m_wallet;\n+    std::map<const DescriptorScriptPubKeyMan*, int32_t> m_last_range_ends;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r962937400",
      "id" : 962937400,
      "line" : 307,
      "node_id" : "PRRC_kwDOABII5845ZUI4",
      "original_commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "original_line" : 307,
      "original_position" : 48,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 48,
      "pull_request_review_id" : 1096463603,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962937400/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-05T15:23:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962937400",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r962939320"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962939320"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: Do we need `SPK` in the name here? `GetDescriptorRangeEnd` seems to describe it accurately?",
      "commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "created_at" : "2022-09-05T14:01:25Z",
      "diff_hunk" : "@@ -260,6 +260,60 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)\n+    {\n+        // fast rescanning via block filters is only supported by descriptor wallets right now\n+        assert(!m_wallet.IsLegacy());\n+\n+        // create initial filter with scripts from both active and non-active ScriptPubKeyMans\n+        auto active_spkms = m_wallet.GetActiveScriptPubKeyMans();\n+        for (auto spkm : m_wallet.GetAllScriptPubKeyMans()) {\n+            auto* desc_spkm = dynamic_cast<DescriptorScriptPubKeyMan*>(spkm);\n+            for (const auto& script_pub_key : desc_spkm->GetScriptPubKeys()) {\n+                m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\n+            }\n+            // save active ScriptPubKeyMans's end ranges for possible future filter updates\n+            if (active_spkms.find(spkm) != active_spkms.end()) {\n+                m_last_range_ends.emplace(desc_spkm, GetDescriptorSPKRangeEnd(*desc_spkm));\n+            }\n+        }\n+    }\n+\n+    void UpdateIfNeeded()\n+    {\n+        // repopulate filter with new scripts if top-up has happened since last iteration\n+        for (auto [desc_spkm, last_range_end] : m_last_range_ends) {\n+            int32_t current_range_end = GetDescriptorSPKRangeEnd(*desc_spkm);\n+            if (current_range_end > last_range_end) {\n+                for (const auto& script_pub_key : desc_spkm->GetScriptPubKeysWithMinIndex(last_range_end)) {\n+                    m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\n+                }\n+                m_last_range_ends.at(desc_spkm) = current_range_end;\n+            }\n+        }\n+    }\n+\n+    std::optional<bool> MatchesBlock(const uint256& block_hash) const\n+    {\n+        return m_wallet.chain().blockFilterMatchesAny(block_hash, m_filter_set);\n+    }\n+\n+private:\n+    const CWallet& m_wallet;\n+    std::map<const DescriptorScriptPubKeyMan*, int32_t> m_last_range_ends;\n+    GCSFilter::ElementSet m_filter_set;\n+\n+    static int32_t GetDescriptorSPKRangeEnd(const DescriptorScriptPubKeyMan& desc_spkm)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r962939320",
      "id" : 962939320,
      "line" : 310,
      "node_id" : "PRRC_kwDOABII5845ZUm4",
      "original_commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "original_line" : 310,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 51,
      "pull_request_review_id" : 1096463603,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962939320/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-05T15:23:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962939320",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r963091332"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963091332"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "d0114e02cddd9bf1cc8760ebe95941f80609259b nit, here we construct a `CBlock` that isn't used if `skip_block` is true (we can use the block filter). I wonder if it would be worth the performance improvement to avoid the construction.\r\n```suggestion\r\n        std::unique_ptr<CBlock> block;\r\n        if (!skip_block) {\r\n            block = std::make_unique<CBlock>();\r\n            chain().findBlock(block_hash, FoundBlock().data(*block));\r\n        }\r\n```\r\nYou would also have to change 3 occurrences of `block.` to `block->` since it now would be a pointer.",
      "commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "created_at" : "2022-09-05T18:52:08Z",
      "diff_hunk" : "@@ -1775,9 +1833,21 @@ CWallet::ScanResult CWallet::ScanForWalletTransactions(const uint256& start_bloc\n             WalletLogPrintf(\"Still rescanning. At block %d. Progress=%f\\n\", block_height, progress_current);\n         }\n \n+        bool skip_block = false;\n+        if (fast_rescan_filter) {\n+            fast_rescan_filter->UpdateIfNeeded();\n+            auto match_result = fast_rescan_filter->MatchesBlock(block_hash);\n+            if (match_result.has_value() && !match_result.value()) {\n+                // Block is skipped, pretend that we found it successfully\n+                result.last_scanned_block = block_hash;\n+                result.last_scanned_height = block_height;\n+                skip_block = true;\n+            }\n+        }\n+\n         // Read block data\n         CBlock block;\n-        chain().findBlock(block_hash, FoundBlock().data(block));\n+        if (!skip_block) chain().findBlock(block_hash, FoundBlock().data(block));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r963091332",
      "id" : 963091332,
      "line" : 1850,
      "node_id" : "PRRC_kwDOABII5845Z5uE",
      "original_commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "original_line" : 1850,
      "original_position" : 93,
      "original_start_line" : 1849,
      "path" : "src/wallet/wallet.cpp",
      "position" : 93,
      "pull_request_review_id" : 1095833132,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963091332/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1849,
      "start_side" : "RIGHT",
      "updated_at" : "2022-09-05T19:35:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963091332",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r963094901"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963094901"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "d0114e02cddd9bf1cc8760ebe95941f80609259b Because of the `index >= minimum_index` guard (just below, line 2662), could this reserve many more entries than needed? I would probably let `std::vector` increase the capacity as needed.",
      "commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "created_at" : "2022-09-05T19:04:23Z",
      "diff_hunk" : "@@ -2652,6 +2652,18 @@ const std::unordered_set<CScript, SaltedSipHasher> DescriptorScriptPubKeyMan::Ge\n     return script_pub_keys;\n }\n \n+const std::vector<CScript> DescriptorScriptPubKeyMan::GetScriptPubKeysWithMinIndex(int32_t minimum_index) const\n+{\n+    LOCK(cs_desc_man);\n+    std::vector<CScript> script_pub_keys;\n+    script_pub_keys.reserve(m_map_script_pub_keys.size());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r963094901",
      "id" : 963094901,
      "line" : 2659,
      "node_id" : "PRRC_kwDOABII5845Z6l1",
      "original_commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "original_line" : 2659,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 8,
      "pull_request_review_id" : 1095833132,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963094901/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-05T19:35:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963094901",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r963767587"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963767587"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Agree that naming the method `has...` reads more fluent, considering that \"chain\" is singular. Done.",
      "commit_id" : "f9052af3988304a3903da085296552e60c184431",
      "created_at" : "2022-09-06T14:17:16Z",
      "diff_hunk" : "@@ -143,6 +144,13 @@ class Chain\n     //! or one of its ancestors.\n     virtual std::optional<int> findLocatorFork(const CBlockLocator& locator) = 0;\n \n+    //! Returns whether a block filter index is available.\n+    virtual bool haveBlockFilterIndex() = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r963767587",
      "id" : 963767587,
      "in_reply_to_id" : 962912290,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5845ce0j",
      "original_commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "original_line" : 148,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/interfaces/chain.h",
      "position" : null,
      "pull_request_review_id" : 1097679270,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963767587/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-06T14:17:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963767587",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r963767824"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963767824"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Good point. To be frank I was just lazy and assumed that there won't be any other block-filter types than \"basic\" for a long time anyways ð Fully agree though that passing the filter type is more consistent. Done for both methods.",
      "commit_id" : "f9052af3988304a3903da085296552e60c184431",
      "created_at" : "2022-09-06T14:17:28Z",
      "diff_hunk" : "@@ -536,6 +537,20 @@ class ChainImpl : public Chain\n         }\n         return std::nullopt;\n     }\n+    bool haveBlockFilterIndex() override",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r963767824",
      "id" : 963767824,
      "in_reply_to_id" : 962921746,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5845ce4Q",
      "original_commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "original_line" : 540,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : null,
      "pull_request_review_id" : 1097679686,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963767824/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-06T14:17:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963767824",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r963773560"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963773560"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks, done.",
      "commit_id" : "f9052af3988304a3903da085296552e60c184431",
      "created_at" : "2022-09-06T14:22:13Z",
      "diff_hunk" : "@@ -260,6 +260,60 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)\n+    {\n+        // fast rescanning via block filters is only supported by descriptor wallets right now\n+        assert(!m_wallet.IsLegacy());\n+\n+        // create initial filter with scripts from both active and non-active ScriptPubKeyMans\n+        auto active_spkms = m_wallet.GetActiveScriptPubKeyMans();\n+        for (auto spkm : m_wallet.GetAllScriptPubKeyMans()) {\n+            auto* desc_spkm = dynamic_cast<DescriptorScriptPubKeyMan*>(spkm);\n+            for (const auto& script_pub_key : desc_spkm->GetScriptPubKeys()) {\n+                m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\n+            }\n+            // save active ScriptPubKeyMans's end ranges for possible future filter updates\n+            if (active_spkms.find(spkm) != active_spkms.end()) {\n+                m_last_range_ends.emplace(desc_spkm, GetDescriptorSPKRangeEnd(*desc_spkm));\n+            }\n+        }\n+    }\n+\n+    void UpdateIfNeeded()\n+    {\n+        // repopulate filter with new scripts if top-up has happened since last iteration\n+        for (auto [desc_spkm, last_range_end] : m_last_range_ends) {\n+            int32_t current_range_end = GetDescriptorSPKRangeEnd(*desc_spkm);\n+            if (current_range_end > last_range_end) {\n+                for (const auto& script_pub_key : desc_spkm->GetScriptPubKeysWithMinIndex(last_range_end)) {\n+                    m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\n+                }\n+                m_last_range_ends.at(desc_spkm) = current_range_end;\n+            }\n+        }\n+    }\n+\n+    std::optional<bool> MatchesBlock(const uint256& block_hash) const\n+    {\n+        return m_wallet.chain().blockFilterMatchesAny(block_hash, m_filter_set);\n+    }\n+\n+private:\n+    const CWallet& m_wallet;\n+    std::map<const DescriptorScriptPubKeyMan*, int32_t> m_last_range_ends;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r963773560",
      "id" : 963773560,
      "in_reply_to_id" : 962937400,
      "line" : 313,
      "node_id" : "PRRC_kwDOABII5845cgR4",
      "original_commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "original_line" : 313,
      "original_position" : 48,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 54,
      "pull_request_review_id" : 1097688294,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963773560/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-06T14:22:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963773560",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r963774096"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963774096"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Agree that having the \"SPK\" in there is not really needed. Done.",
      "commit_id" : "f9052af3988304a3903da085296552e60c184431",
      "created_at" : "2022-09-06T14:22:36Z",
      "diff_hunk" : "@@ -260,6 +260,60 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)\n+    {\n+        // fast rescanning via block filters is only supported by descriptor wallets right now\n+        assert(!m_wallet.IsLegacy());\n+\n+        // create initial filter with scripts from both active and non-active ScriptPubKeyMans\n+        auto active_spkms = m_wallet.GetActiveScriptPubKeyMans();\n+        for (auto spkm : m_wallet.GetAllScriptPubKeyMans()) {\n+            auto* desc_spkm = dynamic_cast<DescriptorScriptPubKeyMan*>(spkm);\n+            for (const auto& script_pub_key : desc_spkm->GetScriptPubKeys()) {\n+                m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\n+            }\n+            // save active ScriptPubKeyMans's end ranges for possible future filter updates\n+            if (active_spkms.find(spkm) != active_spkms.end()) {\n+                m_last_range_ends.emplace(desc_spkm, GetDescriptorSPKRangeEnd(*desc_spkm));\n+            }\n+        }\n+    }\n+\n+    void UpdateIfNeeded()\n+    {\n+        // repopulate filter with new scripts if top-up has happened since last iteration\n+        for (auto [desc_spkm, last_range_end] : m_last_range_ends) {\n+            int32_t current_range_end = GetDescriptorSPKRangeEnd(*desc_spkm);\n+            if (current_range_end > last_range_end) {\n+                for (const auto& script_pub_key : desc_spkm->GetScriptPubKeysWithMinIndex(last_range_end)) {\n+                    m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\n+                }\n+                m_last_range_ends.at(desc_spkm) = current_range_end;\n+            }\n+        }\n+    }\n+\n+    std::optional<bool> MatchesBlock(const uint256& block_hash) const\n+    {\n+        return m_wallet.chain().blockFilterMatchesAny(block_hash, m_filter_set);\n+    }\n+\n+private:\n+    const CWallet& m_wallet;\n+    std::map<const DescriptorScriptPubKeyMan*, int32_t> m_last_range_ends;\n+    GCSFilter::ElementSet m_filter_set;\n+\n+    static int32_t GetDescriptorSPKRangeEnd(const DescriptorScriptPubKeyMan& desc_spkm)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r963774096",
      "id" : 963774096,
      "in_reply_to_id" : 962939320,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5845cgaQ",
      "original_commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "original_line" : 310,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1097689012,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963774096/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-06T14:22:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963774096",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r963775594"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963775594"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In an earlier version the method `GetScriptPubKeys` was indeed simply extended with a default parameter (`minimum_index = 0`). After the latest rebase however, this method is now part of the base class `ScriptPubKeyMan` interface:\r\nhttps://github.com/bitcoin/bitcoin/blob/5291933fedceb9df16eb9e4627b1d7386b53ba07/src/wallet/scriptpubkeyman.h#L246\r\nPassing a minimum index only makes sense for `DescriptorScriptPubKeyMan`s, that's why I refrained from imposing a new parameter; overloading the method _only_ for this class also seemed wrong to me, that's why I chose to use a more explicit naming. Happy to overload though if other's wish that too (maybe it's not as problematic as I think :)).",
      "commit_id" : "f9052af3988304a3903da085296552e60c184431",
      "created_at" : "2022-09-06T14:23:53Z",
      "diff_hunk" : "@@ -2652,6 +2652,18 @@ const std::unordered_set<CScript, SaltedSipHasher> DescriptorScriptPubKeyMan::Ge\n     return script_pub_keys;\n }\n \n+const std::vector<CScript> DescriptorScriptPubKeyMan::GetScriptPubKeysWithMinIndex(int32_t minimum_index) const\n+{\n+    LOCK(cs_desc_man);\n+    std::vector<CScript> script_pub_keys;\n+    script_pub_keys.reserve(m_map_script_pub_keys.size());\n+\n+    for (auto const& [script_pub_key, index] : m_map_script_pub_keys) {\n+        if (index >= minimum_index) script_pub_keys.emplace_back(script_pub_key);\n+    }\n+    return script_pub_keys;\n+}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r963775594",
      "id" : 963775594,
      "in_reply_to_id" : 962928271,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5845cgxq",
      "original_commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "original_line" : 2665,
      "original_position" : 14,
      "original_start_line" : 2655,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 1097691356,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963775594/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-09-06T14:23:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963775594",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r963775855"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963775855"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks, done.",
      "commit_id" : "f9052af3988304a3903da085296552e60c184431",
      "created_at" : "2022-09-06T14:24:08Z",
      "diff_hunk" : "@@ -260,6 +260,60 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)\n+    {\n+        // fast rescanning via block filters is only supported by descriptor wallets right now\n+        assert(!m_wallet.IsLegacy());\n+\n+        // create initial filter with scripts from both active and non-active ScriptPubKeyMans\n+        auto active_spkms = m_wallet.GetActiveScriptPubKeyMans();\n+        for (auto spkm : m_wallet.GetAllScriptPubKeyMans()) {\n+            auto* desc_spkm = dynamic_cast<DescriptorScriptPubKeyMan*>(spkm);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r963775855",
      "id" : 963775855,
      "in_reply_to_id" : 962466047,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5845cg1v",
      "original_commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "original_line" : 275,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1097691799,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963775855/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-06T14:24:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963775855",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r963779873"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963779873"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Good catch! We actually know how large the resulting vector should be (`m_map_script_pub_keys.size()` minus the passed minimum index); changed that accordingly and clamped to a minimum of zero to avoid potential integer underflow issues (if e.g. the caller would pass a minimum index higher than the current ~~end range~~ count of scriptPubKeys).",
      "commit_id" : "f9052af3988304a3903da085296552e60c184431",
      "created_at" : "2022-09-06T14:27:18Z",
      "diff_hunk" : "@@ -2652,6 +2652,18 @@ const std::unordered_set<CScript, SaltedSipHasher> DescriptorScriptPubKeyMan::Ge\n     return script_pub_keys;\n }\n \n+const std::vector<CScript> DescriptorScriptPubKeyMan::GetScriptPubKeysWithMinIndex(int32_t minimum_index) const\n+{\n+    LOCK(cs_desc_man);\n+    std::vector<CScript> script_pub_keys;\n+    script_pub_keys.reserve(m_map_script_pub_keys.size());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r963779873",
      "id" : 963779873,
      "in_reply_to_id" : 963094901,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5845ch0h",
      "original_commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "original_line" : 2659,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 1097697686,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963779873/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-06T14:47:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963779873",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r963785994"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963785994"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "After some consideration, I decided to keep as it is for now to keep the code simpler, as I think default-ctoring a `CBlock` is neglectible here compared to other operations (didn't do any benchmarking or look deeper into it though). Happy to follow-up here though, will keep this conversation open. (Maybe also a topic to discuss for PR review club tomorrow, in case there is some time at the end?).",
      "commit_id" : "f9052af3988304a3903da085296552e60c184431",
      "created_at" : "2022-09-06T14:32:14Z",
      "diff_hunk" : "@@ -1775,9 +1833,21 @@ CWallet::ScanResult CWallet::ScanForWalletTransactions(const uint256& start_bloc\n             WalletLogPrintf(\"Still rescanning. At block %d. Progress=%f\\n\", block_height, progress_current);\n         }\n \n+        bool skip_block = false;\n+        if (fast_rescan_filter) {\n+            fast_rescan_filter->UpdateIfNeeded();\n+            auto match_result = fast_rescan_filter->MatchesBlock(block_hash);\n+            if (match_result.has_value() && !match_result.value()) {\n+                // Block is skipped, pretend that we found it successfully\n+                result.last_scanned_block = block_hash;\n+                result.last_scanned_height = block_height;\n+                skip_block = true;\n+            }\n+        }\n+\n         // Read block data\n         CBlock block;\n-        chain().findBlock(block_hash, FoundBlock().data(block));\n+        if (!skip_block) chain().findBlock(block_hash, FoundBlock().data(block));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r963785994",
      "id" : 963785994,
      "in_reply_to_id" : 963091332,
      "line" : 1856,
      "node_id" : "PRRC_kwDOABII5845cjUK",
      "original_commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "original_line" : 1856,
      "original_position" : 93,
      "original_start_line" : 1849,
      "path" : "src/wallet/wallet.cpp",
      "position" : 99,
      "pull_request_review_id" : 1097706767,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963785994/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1855,
      "start_side" : "RIGHT",
      "updated_at" : "2022-09-06T14:32:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/963785994",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Force-pushed with most of the suggestions from @stickies-v and @LarryRuane. Thanks for your reviews, very good points!",
      "created_at" : "2022-09-06T14:35:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#issuecomment-1238241095",
      "id" : 1238241095,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25957",
      "node_id" : "IC_kwDOABII585Jzg9H",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1238241095/reactions"
      },
      "updated_at" : "2022-09-06T14:35:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1238241095",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Suggest renaming to \"turbo rescan\" for more review :-)",
      "created_at" : "2022-09-06T16:50:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#issuecomment-1238408812",
      "id" : 1238408812,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25957",
      "node_id" : "IC_kwDOABII585J0J5s",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 2,
         "rocket" : 0,
         "total_count" : 2,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1238408812/reactions"
      },
      "updated_at" : "2022-09-06T16:50:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1238408812",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Performance test report: With the master branch, and an empty wallet (which is the best case for this PR), on mainnet, the `rescanblockchain` time was 90 minutes. With this PR, it was 10 minutes. This ratio of 9x is pretty close to the last row in the table in the description. \r\n\r\nOn signet, the PR branch is actually slower; this is probably due to the fact that so many blocks are empty or nearly empty; the time needed to check the filter is greater than the time to check the block directly.\r\n\r\nBut of course, mainnet is what really matters.",
      "created_at" : "2022-09-06T19:01:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#issuecomment-1238538441",
      "id" : 1238538441,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25957",
      "node_id" : "IC_kwDOABII585J0pjJ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1238538441/reactions"
      },
      "updated_at" : "2022-09-06T19:01:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1238538441",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r964549852"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964549852"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't really see the issue with overloading a child class function, especially with an optional parameter? Definitely beats the code duplication in my view, but yeah would be nice to hear others' thoughts.",
      "commit_id" : "f9052af3988304a3903da085296552e60c184431",
      "created_at" : "2022-09-07T08:34:05Z",
      "diff_hunk" : "@@ -2652,6 +2652,18 @@ const std::unordered_set<CScript, SaltedSipHasher> DescriptorScriptPubKeyMan::Ge\n     return script_pub_keys;\n }\n \n+const std::vector<CScript> DescriptorScriptPubKeyMan::GetScriptPubKeysWithMinIndex(int32_t minimum_index) const\n+{\n+    LOCK(cs_desc_man);\n+    std::vector<CScript> script_pub_keys;\n+    script_pub_keys.reserve(m_map_script_pub_keys.size());\n+\n+    for (auto const& [script_pub_key, index] : m_map_script_pub_keys) {\n+        if (index >= minimum_index) script_pub_keys.emplace_back(script_pub_key);\n+    }\n+    return script_pub_keys;\n+}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r964549852",
      "id" : 964549852,
      "in_reply_to_id" : 962928271,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5845fdzc",
      "original_commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "original_line" : 2665,
      "original_position" : 14,
      "original_start_line" : 2655,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 1098757006,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964549852/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-09-07T08:34:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964549852",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r964582588"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964582588"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If the method of the child class has a different number of parameters than the method of the base class, the override doesn't work. E.g., the following doesn't compile:\r\n```c++\r\nclass Base {\r\npublic:\r\n    virtual int get_foobar() const { return 1; }\r\n};\r\n\r\nclass Inherited : public Base {\r\n    int get_foobar(int param = 0) const override { return 2; }\r\n};\r\n```\r\n```\r\n$ clang++ -c /tmp/override.cpp\r\n/tmp/override.cpp:7:45: error: non-virtual member function marked 'override' hides virtual member function\r\n        int get_foobar(int param = 0) const override { return 2; }\r\n                                            ^\r\n/tmp/override.cpp:3:25: note: hidden overloaded virtual function 'Base::get_foobar' declared here: different number of parameters (0 vs 1)\r\n            virtual int get_foobar() const { return 1; }\r\n                        ^\r\n```\r\n\r\nThe only way to avoid code deduplication would be to also introduce the `minimum_index` parameter to the `GetScriptPubKeys` method of the base class interface, but that seemed excessive to me, considering that we would only evaluate that parameter in DescriptorScriptPubKeyMans.",
      "commit_id" : "f9052af3988304a3903da085296552e60c184431",
      "created_at" : "2022-09-07T09:04:05Z",
      "diff_hunk" : "@@ -2652,6 +2652,18 @@ const std::unordered_set<CScript, SaltedSipHasher> DescriptorScriptPubKeyMan::Ge\n     return script_pub_keys;\n }\n \n+const std::vector<CScript> DescriptorScriptPubKeyMan::GetScriptPubKeysWithMinIndex(int32_t minimum_index) const\n+{\n+    LOCK(cs_desc_man);\n+    std::vector<CScript> script_pub_keys;\n+    script_pub_keys.reserve(m_map_script_pub_keys.size());\n+\n+    for (auto const& [script_pub_key, index] : m_map_script_pub_keys) {\n+        if (index >= minimum_index) script_pub_keys.emplace_back(script_pub_key);\n+    }\n+    return script_pub_keys;\n+}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r964582588",
      "id" : 964582588,
      "in_reply_to_id" : 962928271,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5845fly8",
      "original_commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "original_line" : 2665,
      "original_position" : 14,
      "original_start_line" : 2655,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 1098803994,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964582588/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-09-07T09:04:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964582588",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r964632557"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964632557"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "There's no need to `override` it, I'm just talking about overloading it for `DescriptorScriptPubKeyMan`. For example, I think the below could work (not sure if the vector return type was required, just kept it to an unordered_set here for minimal diff):\r\n\r\n<details>\r\n\r\n```diff\r\ndiff --git a/src/wallet/scriptpubkeyman.cpp b/src/wallet/scriptpubkeyman.cpp\r\nindex f7d7f99b8..4c42ef8e0 100644\r\n--- a/src/wallet/scriptpubkeyman.cpp\r\n+++ b/src/wallet/scriptpubkeyman.cpp\r\n@@ -2642,24 +2642,17 @@ const WalletDescriptor DescriptorScriptPubKeyMan::GetWalletDescriptor() const\r\n \r\n const std::unordered_set<CScript, SaltedSipHasher> DescriptorScriptPubKeyMan::GetScriptPubKeys() const\r\n {\r\n-    LOCK(cs_desc_man);\r\n-    std::unordered_set<CScript, SaltedSipHasher> script_pub_keys;\r\n-    script_pub_keys.reserve(m_map_script_pub_keys.size());\r\n-\r\n-    for (auto const& script_pub_key: m_map_script_pub_keys) {\r\n-        script_pub_keys.insert(script_pub_key.first);\r\n-    }\r\n-    return script_pub_keys;\r\n+    return GetScriptPubKeys(0);\r\n }\r\n \r\n-const std::vector<CScript> DescriptorScriptPubKeyMan::GetScriptPubKeysWithMinIndex(int32_t minimum_index) const\r\n+const std::unordered_set<CScript, SaltedSipHasher> DescriptorScriptPubKeyMan::GetScriptPubKeys(int32_t minimum_index) const\r\n {\r\n     LOCK(cs_desc_man);\r\n-    std::vector<CScript> script_pub_keys;\r\n+    std::unordered_set<CScript, SaltedSipHasher> script_pub_keys;\r\n     script_pub_keys.reserve(std::max<size_t>(m_map_script_pub_keys.size() - minimum_index, 0));\r\n \r\n     for (auto const& [script_pub_key, index] : m_map_script_pub_keys) {\r\n-        if (index >= minimum_index) script_pub_keys.emplace_back(script_pub_key);\r\n+        if (index >= minimum_index) script_pub_keys.insert(script_pub_key);\r\n     }\r\n     return script_pub_keys;\r\n }\r\ndiff --git a/src/wallet/scriptpubkeyman.h b/src/wallet/scriptpubkeyman.h\r\nindex ac44de0e4..4ff7fdb15 100644\r\n--- a/src/wallet/scriptpubkeyman.h\r\n+++ b/src/wallet/scriptpubkeyman.h\r\n@@ -643,7 +643,7 @@ public:\r\n \r\n     const WalletDescriptor GetWalletDescriptor() const EXCLUSIVE_LOCKS_REQUIRED(cs_desc_man);\r\n     const std::unordered_set<CScript, SaltedSipHasher> GetScriptPubKeys() const override;\r\n-    const std::vector<CScript> GetScriptPubKeysWithMinIndex(int32_t minimum_index) const;\r\n+    const std::unordered_set<CScript, SaltedSipHasher> GetScriptPubKeys(int32_t minimum_index) const;\r\n \r\n     bool GetDescriptorString(std::string& out, const bool priv) const;\r\n \r\ndiff --git a/src/wallet/wallet.cpp b/src/wallet/wallet.cpp\r\nindex d79d9e76f..d327ab021 100644\r\n--- a/src/wallet/wallet.cpp\r\n+++ b/src/wallet/wallet.cpp\r\n@@ -289,7 +289,7 @@ public:\r\n         for (auto [desc_spkm, last_range_end] : m_last_range_ends) {\r\n             int32_t current_range_end = GetDescriptorRangeEnd(*desc_spkm);\r\n             if (current_range_end > last_range_end) {\r\n-                for (const auto& script_pub_key : desc_spkm->GetScriptPubKeysWithMinIndex(last_range_end)) {\r\n+                for (const auto& script_pub_key : desc_spkm->GetScriptPubKeys(last_range_end)) {\r\n                     m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\r\n                 }\r\n                 m_last_range_ends.at(desc_spkm) = current_range_end;\r\n```\r\n\r\n</details>",
      "commit_id" : "f9052af3988304a3903da085296552e60c184431",
      "created_at" : "2022-09-07T09:51:10Z",
      "diff_hunk" : "@@ -2652,6 +2652,18 @@ const std::unordered_set<CScript, SaltedSipHasher> DescriptorScriptPubKeyMan::Ge\n     return script_pub_keys;\n }\n \n+const std::vector<CScript> DescriptorScriptPubKeyMan::GetScriptPubKeysWithMinIndex(int32_t minimum_index) const\n+{\n+    LOCK(cs_desc_man);\n+    std::vector<CScript> script_pub_keys;\n+    script_pub_keys.reserve(m_map_script_pub_keys.size());\n+\n+    for (auto const& [script_pub_key, index] : m_map_script_pub_keys) {\n+        if (index >= minimum_index) script_pub_keys.emplace_back(script_pub_key);\n+    }\n+    return script_pub_keys;\n+}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r964632557",
      "id" : 964632557,
      "in_reply_to_id" : 962928271,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5845fx_t",
      "original_commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "original_line" : 2665,
      "original_position" : 14,
      "original_start_line" : 2655,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 1098875073,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964632557/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-09-07T09:51:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964632557",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r964649158"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964649158"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ah, now I fully understand what you mean, looks good at a first glance and should work. Somehow I missed the simple idea of just calling the overloaded method with from the one that is overrided (i.e. `GetScriptPubKeys(0)`) and was too focused on solving it with default parameter. Returning a `std::unordered_set` rather than `std::vector` should also be fine for our purposes. Will try that out in a bit ð ",
      "commit_id" : "f9052af3988304a3903da085296552e60c184431",
      "created_at" : "2022-09-07T10:07:46Z",
      "diff_hunk" : "@@ -2652,6 +2652,18 @@ const std::unordered_set<CScript, SaltedSipHasher> DescriptorScriptPubKeyMan::Ge\n     return script_pub_keys;\n }\n \n+const std::vector<CScript> DescriptorScriptPubKeyMan::GetScriptPubKeysWithMinIndex(int32_t minimum_index) const\n+{\n+    LOCK(cs_desc_man);\n+    std::vector<CScript> script_pub_keys;\n+    script_pub_keys.reserve(m_map_script_pub_keys.size());\n+\n+    for (auto const& [script_pub_key, index] : m_map_script_pub_keys) {\n+        if (index >= minimum_index) script_pub_keys.emplace_back(script_pub_key);\n+    }\n+    return script_pub_keys;\n+}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r964649158",
      "id" : 964649158,
      "in_reply_to_id" : 962928271,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5845f2DG",
      "original_commit_id" : "d0114e02cddd9bf1cc8760ebe95941f80609259b",
      "original_line" : 2665,
      "original_position" : 14,
      "original_start_line" : 2655,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 1098899253,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964649158/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-09-07T10:07:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964649158",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Force-pushed again with the following changes:\r\n* took @stickies-v's suggestion to overload `DescriptorScriptPubKeyMan::GetScriptPubKeys(...)` in order to deduplicate code (https://github.com/bitcoin/bitcoin/pull/25957#discussion_r964632557)\r\n* removed the adaption (earlier first commit) of `wallet_import_rescan.py`: as @LarryRuane found out, this test only works for legacy wallets (it uses RPCs like `importprivkey`, `importaddress` etc.) and hence is at this stage not useful for testing this PR\r\n* added a new test `wallet_fast_rescan.py` which tests the top-up detection by repeatedly creating txs sending to the address of each wallet descriptor's range end, and then comparing the found wallet txs after slow and fast rescan each",
      "created_at" : "2022-09-08T16:56:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#issuecomment-1240976766",
      "id" : 1240976766,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25957",
      "node_id" : "IC_kwDOABII585J981-",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1240976766/reactions"
      },
      "updated_at" : "2022-09-08T16:56:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1240976766",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r966553271"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/966553271"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not sure it makes sense to talk about rescans on `loadwallet`. It can happen, but hopefully shouldn't be very often.",
      "commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "created_at" : "2022-09-09T01:51:01Z",
      "diff_hunk" : "@@ -198,7 +198,9 @@ static RPCHelpMan loadwallet()\n     return RPCHelpMan{\"loadwallet\",\n                 \"\\nLoads a wallet from a wallet file or directory.\"\n                 \"\\nNote that all wallet command-line options used when starting bitcoind will be\"\n-                \"\\napplied to the new wallet.\\n\",\n+                \"\\napplied to the new wallet.\"\n+                \"\\nThe rescan is significantly faster if a descriptor wallet is loaded\"\n+                \"\\nand block filters are available (bitcoind option \\\"-blockfilterindex=1\\\").\\n\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r966553271",
      "id" : 966553271,
      "line" : 203,
      "node_id" : "PRRC_kwDOABII5845nG63",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 203,
      "original_position" : 7,
      "original_start_line" : 202,
      "path" : "src/wallet/rpc/wallet.cpp",
      "position" : 7,
      "pull_request_review_id" : 1101601457,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/966553271/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 202,
      "start_side" : "RIGHT",
      "updated_at" : "2022-09-09T01:58:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/966553271",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r966553892"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/966553892"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    const std::unordered_set<CScript, SaltedSipHasher> GetScriptPubKeys(int32_t minimum_index = 0) const;\r\n```",
      "commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "created_at" : "2022-09-09T01:52:50Z",
      "diff_hunk" : "@@ -643,6 +643,7 @@ class DescriptorScriptPubKeyMan : public ScriptPubKeyMan\n \n     const WalletDescriptor GetWalletDescriptor() const EXCLUSIVE_LOCKS_REQUIRED(cs_desc_man);\n     const std::unordered_set<CScript, SaltedSipHasher> GetScriptPubKeys() const override;\n+    const std::unordered_set<CScript, SaltedSipHasher> GetScriptPubKeys(int32_t minimum_index) const;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r966553892",
      "id" : 966553892,
      "line" : 646,
      "node_id" : "PRRC_kwDOABII5845nHEk",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 646,
      "original_position" : 4,
      "original_start_line" : 645,
      "path" : "src/wallet/scriptpubkeyman.h",
      "position" : 4,
      "pull_request_review_id" : 1101601457,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/966553892/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 645,
      "start_side" : "RIGHT",
      "updated_at" : "2022-09-09T01:58:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/966553892",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r966554589"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/966554589"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n```",
      "commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "created_at" : "2022-09-09T01:54:46Z",
      "diff_hunk" : "@@ -1775,9 +1839,21 @@ CWallet::ScanResult CWallet::ScanForWalletTransactions(const uint256& start_bloc\n             WalletLogPrintf(\"Still rescanning. At block %d. Progress=%f\\n\", block_height, progress_current);\n         }\n \n+        bool skip_block = false;\n+        if (fast_rescan_filter) {\n+            fast_rescan_filter->UpdateIfNeeded();\n+            auto match_result = fast_rescan_filter->MatchesBlock(block_hash);\n+            if (match_result.has_value() && !match_result.value()) {\n+                // Block is skipped, pretend that we found it successfully",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r966554589",
      "id" : 966554589,
      "line" : 1847,
      "node_id" : "PRRC_kwDOABII5845nHPd",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 1847,
      "original_position" : 89,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 89,
      "pull_request_review_id" : 1101601457,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/966554589/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-09T01:58:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/966554589",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : ">We could add an argument to loadwallet that prevents a rescan, so a user can migrate (#19602) to a descriptor wallet and then rescan.\r\n\r\nFeels like a footgun. Would rather a param that migrates without \"loading\". But I suspect extending this to support legacy wallets (outside the scope of this PR) wouldn't be very hard either.",
      "created_at" : "2022-09-09T01:58:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#issuecomment-1241412647",
      "id" : 1241412647,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25957",
      "node_id" : "IC_kwDOABII585J_nQn",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1241412647/reactions"
      },
      "updated_at" : "2022-09-09T01:58:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1241412647",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968587412"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968587412"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "What about using `desc_spkm->m_max_cached_index` directly in the caller side instead?",
      "commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "created_at" : "2022-09-12T15:51:11Z",
      "diff_hunk" : "@@ -260,6 +260,66 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)\n+    {\n+        // fast rescanning via block filters is only supported by descriptor wallets right now\n+        assert(!m_wallet.IsLegacy());\n+\n+        // create initial filter with scripts from both active and non-active ScriptPubKeyMans\n+        auto active_spkms = m_wallet.GetActiveScriptPubKeyMans();\n+        for (auto spkm : m_wallet.GetAllScriptPubKeyMans()) {\n+            auto desc_spkm = dynamic_cast<DescriptorScriptPubKeyMan*>(spkm);\n+            for (const auto& script_pub_key : desc_spkm->GetScriptPubKeys()) {\n+                m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\n+            }\n+            // save active ScriptPubKeyMans's end ranges for possible future filter updates\n+            if (active_spkms.find(spkm) != active_spkms.end()) {\n+                m_last_range_ends.emplace(desc_spkm, GetDescriptorRangeEnd(*desc_spkm));\n+            }\n+        }\n+    }\n+\n+    void UpdateIfNeeded()\n+    {\n+        // repopulate filter with new scripts if top-up has happened since last iteration\n+        for (auto [desc_spkm, last_range_end] : m_last_range_ends) {\n+            int32_t current_range_end = GetDescriptorRangeEnd(*desc_spkm);\n+            if (current_range_end > last_range_end) {\n+                for (const auto& script_pub_key : desc_spkm->GetScriptPubKeys(last_range_end)) {\n+                    m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\n+                }\n+                m_last_range_ends.at(desc_spkm) = current_range_end;\n+            }\n+        }\n+    }\n+\n+    std::optional<bool> MatchesBlock(const uint256& block_hash) const\n+    {\n+        return m_wallet.chain().blockFilterMatchesAny(BlockFilterType::BASIC, block_hash, m_filter_set);\n+    }\n+\n+private:\n+    const CWallet& m_wallet;\n+    /** Map for keeping track of each active descriptor's last seen end range.\n+      * This information is used to detect whether new addresses were derived\n+      * (that is, if the current end range is larger than the saved end range)\n+      * after processing a block and hence a filter set update is needed to\n+      * take possible keypool top-ups into account.\n+      */\n+    std::map<const DescriptorScriptPubKeyMan*, int32_t> m_last_range_ends;\n+    GCSFilter::ElementSet m_filter_set;\n+\n+    static int32_t GetDescriptorRangeEnd(const DescriptorScriptPubKeyMan& desc_spkm)\n+    {\n+        LOCK(desc_spkm.cs_desc_man);\n+        return desc_spkm.GetWalletDescriptor().range_end;\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968587412",
      "id" : 968587412,
      "line" : 320,
      "node_id" : "PRRC_kwDOABII5845u3iU",
      "original_commit_id" : "1daead3b4adb5a54b8999bdd1cece9cccf152499",
      "original_line" : 320,
      "original_position" : 61,
      "original_start_line" : 316,
      "path" : "src/wallet/wallet.cpp",
      "position" : 61,
      "pull_request_review_id" : 1104388445,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968587412/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 316,
      "start_side" : "RIGHT",
      "updated_at" : "2022-09-12T16:21:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968587412",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968631594"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968631594"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think you also need to include blockfilter.h here.",
      "commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "created_at" : "2022-09-12T16:33:40Z",
      "diff_hunk" : "@@ -8,6 +8,7 @@\n #include <chainparams.h>\n #include <deploymentstatus.h>\n #include <external_signer.h>\n+#include <index/blockfilterindex.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968631594",
      "id" : 968631594,
      "line" : 11,
      "node_id" : "PRRC_kwDOABII5845vCUq",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 11,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : 4,
      "pull_request_review_id" : 1104453139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968631594/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-12T22:13:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968631594",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968875953"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968875953"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't think that pointers are a good design choice for map keys. Would rather use the spkm id:\r\n```suggestion\r\n    std::map<uint256, int32_t> m_last_range_ends;\r\n```",
      "commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "created_at" : "2022-09-12T19:54:20Z",
      "diff_hunk" : "@@ -260,6 +260,66 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)\n+    {\n+        // fast rescanning via block filters is only supported by descriptor wallets right now\n+        assert(!m_wallet.IsLegacy());\n+\n+        // create initial filter with scripts from both active and non-active ScriptPubKeyMans\n+        auto active_spkms = m_wallet.GetActiveScriptPubKeyMans();\n+        for (auto spkm : m_wallet.GetAllScriptPubKeyMans()) {\n+            auto desc_spkm = dynamic_cast<DescriptorScriptPubKeyMan*>(spkm);\n+            for (const auto& script_pub_key : desc_spkm->GetScriptPubKeys()) {\n+                m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\n+            }\n+            // save active ScriptPubKeyMans's end ranges for possible future filter updates\n+            if (active_spkms.find(spkm) != active_spkms.end()) {\n+                m_last_range_ends.emplace(desc_spkm, GetDescriptorRangeEnd(*desc_spkm));\n+            }\n+        }\n+    }\n+\n+    void UpdateIfNeeded()\n+    {\n+        // repopulate filter with new scripts if top-up has happened since last iteration\n+        for (auto [desc_spkm, last_range_end] : m_last_range_ends) {\n+            int32_t current_range_end = GetDescriptorRangeEnd(*desc_spkm);\n+            if (current_range_end > last_range_end) {\n+                for (const auto& script_pub_key : desc_spkm->GetScriptPubKeys(last_range_end)) {\n+                    m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\n+                }\n+                m_last_range_ends.at(desc_spkm) = current_range_end;\n+            }\n+        }\n+    }\n+\n+    std::optional<bool> MatchesBlock(const uint256& block_hash) const\n+    {\n+        return m_wallet.chain().blockFilterMatchesAny(BlockFilterType::BASIC, block_hash, m_filter_set);\n+    }\n+\n+private:\n+    const CWallet& m_wallet;\n+    /** Map for keeping track of each active descriptor's last seen end range.\n+      * This information is used to detect whether new addresses were derived\n+      * (that is, if the current end range is larger than the saved end range)\n+      * after processing a block and hence a filter set update is needed to\n+      * take possible keypool top-ups into account.\n+      */\n+    std::map<const DescriptorScriptPubKeyMan*, int32_t> m_last_range_ends;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968875953",
      "id" : 968875953,
      "line" : 313,
      "node_id" : "PRRC_kwDOABII5845v9-x",
      "original_commit_id" : "1daead3b4adb5a54b8999bdd1cece9cccf152499",
      "original_line" : 313,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 54,
      "pull_request_review_id" : 1104755402,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968875953/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-12T19:54:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968875953",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968930318"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968930318"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: structure\r\n```suggestion\r\n            // save each active ScriptPubKeyMans's range end for possible future filter updates\r\n```",
      "commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "created_at" : "2022-09-12T21:05:10Z",
      "diff_hunk" : "@@ -260,6 +260,66 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)\n+    {\n+        // fast rescanning via block filters is only supported by descriptor wallets right now\n+        assert(!m_wallet.IsLegacy());\n+\n+        // create initial filter with scripts from both active and non-active ScriptPubKeyMans\n+        auto active_spkms = m_wallet.GetActiveScriptPubKeyMans();\n+        for (auto spkm : m_wallet.GetAllScriptPubKeyMans()) {\n+            auto desc_spkm = dynamic_cast<DescriptorScriptPubKeyMan*>(spkm);\n+            for (const auto& script_pub_key : desc_spkm->GetScriptPubKeys()) {\n+                m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\n+            }\n+            // save active ScriptPubKeyMans's end ranges for possible future filter updates",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968930318",
      "id" : 968930318,
      "line" : 279,
      "node_id" : "PRRC_kwDOABII5845wLQO",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 279,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 20,
      "pull_request_review_id" : 1104453139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968930318/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-12T22:13:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968930318",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968944391"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968944391"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: {} list initialization (in a few other places too)\r\n```suggestion\r\n        auto active_spkms{m_wallet.GetActiveScriptPubKeyMans()};\r\n```",
      "commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "created_at" : "2022-09-12T21:22:54Z",
      "diff_hunk" : "@@ -260,6 +260,66 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)\n+    {\n+        // fast rescanning via block filters is only supported by descriptor wallets right now\n+        assert(!m_wallet.IsLegacy());\n+\n+        // create initial filter with scripts from both active and non-active ScriptPubKeyMans\n+        auto active_spkms = m_wallet.GetActiveScriptPubKeyMans();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968944391",
      "id" : 968944391,
      "line" : 273,
      "node_id" : "PRRC_kwDOABII5845wOsH",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 273,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 14,
      "pull_request_review_id" : 1104453139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968944391/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-12T22:13:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968944391",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968951824"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968951824"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "You could put this into its own function, e.g. `FastWalletRescanFilter::AddScriptPubKeys(DescriptorScriptPubKeyMan* desc_spkm, int32_t last_range_end = 0)`, so you can avoid the duplication in `UpdateIfNeeded()`? I think it'd be a bit more readable too (not that it's bad now)",
      "commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "created_at" : "2022-09-12T21:32:01Z",
      "diff_hunk" : "@@ -260,6 +260,66 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)\n+    {\n+        // fast rescanning via block filters is only supported by descriptor wallets right now\n+        assert(!m_wallet.IsLegacy());\n+\n+        // create initial filter with scripts from both active and non-active ScriptPubKeyMans\n+        auto active_spkms = m_wallet.GetActiveScriptPubKeyMans();\n+        for (auto spkm : m_wallet.GetAllScriptPubKeyMans()) {\n+            auto desc_spkm = dynamic_cast<DescriptorScriptPubKeyMan*>(spkm);\n+            for (const auto& script_pub_key : desc_spkm->GetScriptPubKeys()) {\n+                m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\n+            }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968951824",
      "id" : 968951824,
      "line" : 278,
      "node_id" : "PRRC_kwDOABII5845wQgQ",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 278,
      "original_position" : 19,
      "original_start_line" : 276,
      "path" : "src/wallet/wallet.cpp",
      "position" : 19,
      "pull_request_review_id" : 1104453139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968951824/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 276,
      "start_side" : "RIGHT",
      "updated_at" : "2022-09-12T22:13:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968951824",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968956532"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968956532"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm not very familiar with the wallet rescanning process, but I wonder if we should also check if there are any new spkms? If so, and if you would then want to track `active_spkms` as an internal member, you could extend `FastWalletRescanFilter::AddScriptPubKeys` from my other comment and have it update `m_last_range_ends` too for more deduplication.",
      "commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "created_at" : "2022-09-12T21:39:19Z",
      "diff_hunk" : "@@ -260,6 +260,66 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)\n+    {\n+        // fast rescanning via block filters is only supported by descriptor wallets right now\n+        assert(!m_wallet.IsLegacy());\n+\n+        // create initial filter with scripts from both active and non-active ScriptPubKeyMans\n+        auto active_spkms = m_wallet.GetActiveScriptPubKeyMans();\n+        for (auto spkm : m_wallet.GetAllScriptPubKeyMans()) {\n+            auto desc_spkm = dynamic_cast<DescriptorScriptPubKeyMan*>(spkm);\n+            for (const auto& script_pub_key : desc_spkm->GetScriptPubKeys()) {\n+                m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\n+            }\n+            // save active ScriptPubKeyMans's end ranges for possible future filter updates\n+            if (active_spkms.find(spkm) != active_spkms.end()) {\n+                m_last_range_ends.emplace(desc_spkm, GetDescriptorRangeEnd(*desc_spkm));\n+            }\n+        }\n+    }\n+\n+    void UpdateIfNeeded()\n+    {\n+        // repopulate filter with new scripts if top-up has happened since last iteration\n+        for (auto [desc_spkm, last_range_end] : m_last_range_ends) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968956532",
      "id" : 968956532,
      "line" : 289,
      "node_id" : "PRRC_kwDOABII5845wRp0",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 289,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 30,
      "pull_request_review_id" : 1104453139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968956532/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-12T22:13:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968956532",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968961724"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968961724"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Should include blockfilter.h",
      "commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "created_at" : "2022-09-12T21:47:16Z",
      "diff_hunk" : "@@ -1748,7 +1808,11 @@ CWallet::ScanResult CWallet::ScanForWalletTransactions(const uint256& start_bloc\n     uint256 block_hash = start_block;\n     ScanResult result;\n \n-    WalletLogPrintf(\"Rescan started from block %s...\\n\", start_block.ToString());\n+    std::unique_ptr<FastWalletRescanFilter> fast_rescan_filter;\n+    if (!IsLegacy() && chain().hasBlockFilterIndex(BlockFilterType::BASIC)) fast_rescan_filter.reset(new FastWalletRescanFilter(*this));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968961724",
      "id" : 968961724,
      "line" : 1812,
      "node_id" : "PRRC_kwDOABII5845wS68",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 1812,
      "original_position" : 73,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 73,
      "pull_request_review_id" : 1104453139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968961724/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-12T22:13:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968961724",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968963378"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968963378"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n            if (match_result.value_or(false)) {\r\n```",
      "commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "created_at" : "2022-09-12T21:50:02Z",
      "diff_hunk" : "@@ -1775,9 +1839,21 @@ CWallet::ScanResult CWallet::ScanForWalletTransactions(const uint256& start_bloc\n             WalletLogPrintf(\"Still rescanning. At block %d. Progress=%f\\n\", block_height, progress_current);\n         }\n \n+        bool skip_block = false;\n+        if (fast_rescan_filter) {\n+            fast_rescan_filter->UpdateIfNeeded();\n+            auto match_result = fast_rescan_filter->MatchesBlock(block_hash);\n+            if (match_result.has_value() && !match_result.value()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968963378",
      "id" : 968963378,
      "line" : 1846,
      "node_id" : "PRRC_kwDOABII5845wTUy",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 1846,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 88,
      "pull_request_review_id" : 1104453139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968963378/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-12T22:13:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968963378",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968964566"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968964566"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm quite confused by this comment, so +1 on removing or clarifying. \"Block does not match filter, mark it as scanned so ...\"",
      "commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "created_at" : "2022-09-12T21:52:12Z",
      "diff_hunk" : "@@ -1775,9 +1839,21 @@ CWallet::ScanResult CWallet::ScanForWalletTransactions(const uint256& start_bloc\n             WalletLogPrintf(\"Still rescanning. At block %d. Progress=%f\\n\", block_height, progress_current);\n         }\n \n+        bool skip_block = false;\n+        if (fast_rescan_filter) {\n+            fast_rescan_filter->UpdateIfNeeded();\n+            auto match_result = fast_rescan_filter->MatchesBlock(block_hash);\n+            if (match_result.has_value() && !match_result.value()) {\n+                // Block is skipped, pretend that we found it successfully",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968964566",
      "id" : 968964566,
      "in_reply_to_id" : 966554589,
      "line" : 1847,
      "node_id" : "PRRC_kwDOABII5845wTnW",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 1847,
      "original_position" : 89,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 89,
      "pull_request_review_id" : 1104453139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968964566/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-12T22:13:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968964566",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968972271"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968972271"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "What do you think about putting this in a separate function that returns `bool skip_block`? `CWallet::ScanForWalletTransactions()` is already quite bloated, I think we should try not to add to it?",
      "commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "created_at" : "2022-09-12T22:03:41Z",
      "diff_hunk" : "@@ -1775,9 +1839,21 @@ CWallet::ScanResult CWallet::ScanForWalletTransactions(const uint256& start_bloc\n             WalletLogPrintf(\"Still rescanning. At block %d. Progress=%f\\n\", block_height, progress_current);\n         }\n \n+        bool skip_block = false;\n+        if (fast_rescan_filter) {\n+            fast_rescan_filter->UpdateIfNeeded();\n+            auto match_result = fast_rescan_filter->MatchesBlock(block_hash);\n+            if (match_result.has_value() && !match_result.value()) {\n+                // Block is skipped, pretend that we found it successfully\n+                result.last_scanned_block = block_hash;\n+                result.last_scanned_height = block_height;\n+                skip_block = true;\n+            }\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968972271",
      "id" : 968972271,
      "line" : 1852,
      "node_id" : "PRRC_kwDOABII5845wVfv",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 1852,
      "original_position" : 94,
      "original_start_line" : 1842,
      "path" : "src/wallet/wallet.cpp",
      "position" : 94,
      "pull_request_review_id" : 1104453139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968972271/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1842,
      "start_side" : "RIGHT",
      "updated_at" : "2022-09-12T22:13:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968972271",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968977557"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968977557"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: PEP484\r\n```suggestion\r\n    def get_wallet_txids(self, node: TestNode, wallet_name: str) -> List[str]:\r\n```",
      "commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "created_at" : "2022-09-12T22:10:57Z",
      "diff_hunk" : "@@ -0,0 +1,73 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test that fast rescan using block filters for descriptor wallets detects\n+   top-ups correctly and finds the same transactions than the slow variant.\"\"\"\n+import os\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+from test_framework.wallet import MiniWallet\n+\n+\n+KEYPOOL_SIZE = 100   # smaller than default size to speed-up test\n+NUM_DESCRIPTORS = 8  # number of descriptors on a fresh wallet created by default\n+NUM_BLOCKS = 6       # number of blocks to mine\n+\n+\n+class WalletFastRescanTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+        self.extra_args = [[f'-keypool={KEYPOOL_SIZE}', '-blockfilterindex=1']]\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+        self.skip_if_no_sqlite()\n+\n+    def get_wallet_txids(self, node, wallet_name):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r968977557",
      "id" : 968977557,
      "line" : 28,
      "node_id" : "PRRC_kwDOABII5845wWyV",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 28,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/wallet_fast_rescan.py",
      "position" : 28,
      "pull_request_review_id" : 1104453139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968977557/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-12T22:13:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/968977557",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969026772"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969026772"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Not needed. Every import command checks if a rescan is being performed prior execution (it's the `WalletRescanReserver` purpose).",
      "commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "created_at" : "2022-09-13T00:03:14Z",
      "diff_hunk" : "@@ -260,6 +260,66 @@ std::shared_ptr<CWallet> LoadWalletInternal(WalletContext& context, const std::s\n         return nullptr;\n     }\n }\n+\n+class FastWalletRescanFilter\n+{\n+public:\n+    FastWalletRescanFilter(const CWallet& wallet) : m_wallet(wallet)\n+    {\n+        // fast rescanning via block filters is only supported by descriptor wallets right now\n+        assert(!m_wallet.IsLegacy());\n+\n+        // create initial filter with scripts from both active and non-active ScriptPubKeyMans\n+        auto active_spkms = m_wallet.GetActiveScriptPubKeyMans();\n+        for (auto spkm : m_wallet.GetAllScriptPubKeyMans()) {\n+            auto desc_spkm = dynamic_cast<DescriptorScriptPubKeyMan*>(spkm);\n+            for (const auto& script_pub_key : desc_spkm->GetScriptPubKeys()) {\n+                m_filter_set.emplace(script_pub_key.begin(), script_pub_key.end());\n+            }\n+            // save active ScriptPubKeyMans's end ranges for possible future filter updates\n+            if (active_spkms.find(spkm) != active_spkms.end()) {\n+                m_last_range_ends.emplace(desc_spkm, GetDescriptorRangeEnd(*desc_spkm));\n+            }\n+        }\n+    }\n+\n+    void UpdateIfNeeded()\n+    {\n+        // repopulate filter with new scripts if top-up has happened since last iteration\n+        for (auto [desc_spkm, last_range_end] : m_last_range_ends) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25957#discussion_r969026772",
      "id" : 969026772,
      "in_reply_to_id" : 968956532,
      "line" : 289,
      "node_id" : "PRRC_kwDOABII5845wizU",
      "original_commit_id" : "137347fad5b0c532f58d049ddee8a33ebf89dbf5",
      "original_line" : 289,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 30,
      "pull_request_review_id" : 1104961889,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25957",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969026772/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-13T00:03:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/969026772",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   }
]
