[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#26238](https://github.com/bitcoin/bitcoin/pull/26238) (clang-tidy: fixup named argument comments by fanquake)\n* [#25991](https://github.com/bitcoin/bitcoin/pull/25991) (Wallet: Add foreign_outputs metadata to support CoinJoin transactions by luke-jr)\n* [#25934](https://github.com/bitcoin/bitcoin/pull/25934) (wallet, rpc: add `label` to `listsinceblock` by brunoerg)\n* [#25620](https://github.com/bitcoin/bitcoin/pull/25620) (wallet: Introduce AddressBookManager by furszy)\n* [#25344](https://github.com/bitcoin/bitcoin/pull/25344) (New `outputs` argument for `bumpfee`/`psbtbumpfee` by rodentrabies)\n* [#23319](https://github.com/bitcoin/bitcoin/pull/23319) (rpc: Return fee and prevout (utxos) to getrawtransaction by dougEfresh)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-09-01T21:23:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25979#issuecomment-1234798212",
      "id" : 1234798212,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25979",
      "node_id" : "IC_kwDOABII585JmYaE",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1234798212/reactions"
      },
      "updated_at" : "2022-10-19T15:08:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1234798212",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Interesting pull request although I haven't tested it yet. \r\n\r\nDoes this also fix https://github.com/bitcoin/bitcoin/issues/20935 and https://github.com/bitcoin/bitcoin/issues/20795 ?\r\n\r\n > How Change Detection Currently Works?\r\nThe wallet walks-through the transaction outputs, extracts the script\r\ndestination and verify the following two points:\r\n\r\n> If the destination doesn't exist in the address book, then the script\r\nis a \"change address\".\r\n\r\n> If the destination exists in the address book, but it doesn't have a\r\nlabel, then the script is a \"change address\".\r\n\r\nI was assuming change address had different derivation path. Is that false?",
      "created_at" : "2022-09-02T02:31:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25979#issuecomment-1234999269",
      "id" : 1234999269,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25979",
      "node_id" : "IC_kwDOABII585JnJfl",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1234999269/reactions"
      },
      "updated_at" : "2022-09-02T02:31:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1234999269",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/94559964?v=4",
         "events_url" : "https://api.github.com/users/1440000bytes/events{/privacy}",
         "followers_url" : "https://api.github.com/users/1440000bytes/followers",
         "following_url" : "https://api.github.com/users/1440000bytes/following{/other_user}",
         "gists_url" : "https://api.github.com/users/1440000bytes/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/1440000bytes",
         "id" : 94559964,
         "login" : "1440000bytes",
         "node_id" : "U_kgDOBaLe3A",
         "organizations_url" : "https://api.github.com/users/1440000bytes/orgs",
         "received_events_url" : "https://api.github.com/users/1440000bytes/received_events",
         "repos_url" : "https://api.github.com/users/1440000bytes/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/1440000bytes/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/1440000bytes/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/1440000bytes"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Does this also fix #20935 and #20795 ?\r\n\r\nYes for the change outputs detection part. It will allow us to properly detect each individual output as change or not, independently on what is stored in the address book entry (making the process deterministic across instances, and not dependent on a data structure that the user can freely modify).\r\n\r\nAs an edge case example; with this, users could even receive coins on an internal address and the new mechanism will properly detect it as an external reception, not a change output (the transaction inputs aren't from the wallet, so no coins are returning to it). Still, this behavior is obviously not encouraged, nor should be easy to do in the wallet, as it breaks the whole idea of internal/external derivation paths.\r\n\r\nPlus, would recommend you to check [#25685](https://github.com/bitcoin/bitcoin/pull/25685) as well. The first commit there fixes a misleading wallet behavior where even if you set `add_inputs=false` (telling the wallet to disallow automatic coin selection), the wallet will still fetch coins internally and use them in the Coin Selection process (if you don't pre-set inputs manually).\r\n\r\n\r\n> > How Change Detection Currently Works?\r\n> > The wallet walks-through the transaction outputs, extracts the script\r\n> > destination and verify the following two points:\r\n> \r\n> > If the destination doesn't exist in the address book, then the script\r\n> > is a \"change address\".\r\n> \r\n> > If the destination exists in the address book, but it doesn't have a\r\n> > label, then the script is a \"change address\".\r\n> \r\n> I was assuming change address had different derivation path. Is that false?\r\n\r\nNot entirely, the assumption is most of the time correct. It breaks on pre-split legacy wallets, where we don't have an internal derivation path. In those wallet versions we (1) only use an external path to derive public and change addresses, or if we go further back in time, (2) we use a raw pool of keys with no derivation paths at all. (Thus why the initial change detection process was implemented using the address book).",
      "created_at" : "2022-09-02T16:09:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25979#issuecomment-1235677701",
      "id" : 1235677701,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25979",
      "node_id" : "IC_kwDOABII585JpvIF",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1235677701/reactions"
      },
      "updated_at" : "2022-09-03T12:34:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1235677701",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK\r\n",
      "created_at" : "2022-09-03T05:41:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25979#issuecomment-1236054202",
      "id" : 1236054202,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25979",
      "node_id" : "IC_kwDOABII585JrLC6",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1236054202/reactions"
      },
      "updated_at" : "2022-09-03T05:41:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1236054202",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/94559964?v=4",
         "events_url" : "https://api.github.com/users/1440000bytes/events{/privacy}",
         "followers_url" : "https://api.github.com/users/1440000bytes/followers",
         "following_url" : "https://api.github.com/users/1440000bytes/following{/other_user}",
         "gists_url" : "https://api.github.com/users/1440000bytes/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/1440000bytes",
         "id" : 94559964,
         "login" : "1440000bytes",
         "node_id" : "U_kgDOBaLe3A",
         "organizations_url" : "https://api.github.com/users/1440000bytes/orgs",
         "received_events_url" : "https://api.github.com/users/1440000bytes/received_events",
         "repos_url" : "https://api.github.com/users/1440000bytes/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/1440000bytes/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/1440000bytes/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/1440000bytes"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "While I like the idea this is going for, I don't think it is sufficient. It relies on `m_internal_spk_managers` which only contains the currently active SPKMs. If a user were to remove a SPKM from being active, all of the addresses that were produced by that would no longer be detected as change. This is especially problematic with #25907 which rotates all of the currently active descriptors.\r\n\r\nIn general, I'm not sure that we can determine which output is change without storing additional metadata. What has been suggested before is to explicitly store an \"IsChange\" value in address book entries, with a \"smart\" fallback like what this PR does.",
      "created_at" : "2022-10-31T19:53:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25979#issuecomment-1297598739",
      "id" : 1297598739,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25979",
      "node_id" : "IC_kwDOABII585NV8kT",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1297598739/reactions"
      },
      "updated_at" : "2022-10-31T19:53:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1297598739",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   }
]
