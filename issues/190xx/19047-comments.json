[
   {
      "author_association" : "MEMBER",
      "body" : "What do you mean? The potential deadlock should still be detected, and then either `std::abort`, or `std::logic_error`, or the sanitizer abort will kill the process with a non-zero exit code.",
      "created_at" : "2020-05-22T10:52:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/19047#issuecomment-632629242",
      "id" : 632629242,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19047",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMjYyOTI0Mg==",
      "updated_at" : "2020-05-22T10:52:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/632629242",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@MarcoFalke \r\n> What do you mean? The potential deadlock should still be detected, and then either `std::abort`, or `std::logic_error`, or the sanitizer abort will kill the process with a non-zero exit code.\r\n\r\nI suggest to use both tools to detect a potential deadlock, each tool in its own test:\r\n- the `-DDEBUG_LOCKORDER` flag in the \"[bionic]  [no depends, only system libs, sanitizers: address/leak (ASan + LSan) + undefined (UBSan) + integer]\" CI test (the current state)\r\n\r\n_and_\r\n- the ThreadSanitizer in the \"[bionic]  [no depends, only system libs, sanitizers: thread (TSan), no wallet]\" CI test (the subject to change) that is possible by dropping the `-DDEBUG_LOCKORDER` flag",
      "created_at" : "2020-05-22T11:01:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/19047#issuecomment-632632896",
      "id" : 632632896,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19047",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMjYzMjg5Ng==",
      "updated_at" : "2020-05-22T11:03:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/632632896",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "And the scope of the ThreadSanitizer is wider than that of our instrumented mutexes.",
      "created_at" : "2020-05-22T11:08:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/19047#issuecomment-632635860",
      "id" : 632635860,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19047",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMjYzNTg2MA==",
      "updated_at" : "2020-05-22T11:08:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/632635860",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "So are you saying that `DEBUG_LOCKORDER` with tsan might result in a false negative?",
      "created_at" : "2020-05-22T11:11:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/19047#issuecomment-632636667",
      "id" : 632636667,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19047",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMjYzNjY2Nw==",
      "updated_at" : "2020-05-22T11:11:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/632636667",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> So are you saying that `DEBUG_LOCKORDER` with tsan might result in a false negative?\r\n\r\nNo :)\r\n\r\nI only say that we do not test for potential deadlocks by means of the ThreadSanitizer. Always the `DEBUG_LOCKORDER` facilities are used only (on Travis CI).",
      "created_at" : "2020-05-22T11:14:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/19047#issuecomment-632637924",
      "id" : 632637924,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19047",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMjYzNzkyNA==",
      "updated_at" : "2020-05-22T11:14:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/632637924",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> So are you saying that `DEBUG_LOCKORDER` with tsan might result in a false negative?\r\n\r\nTo be exact, when binaries are built with the `--with-sanitizers=thread CPPFLAGS=-DDEBUG_LOCKORDER` `configure` options the `DEBUG_LOCKORDER` code prevents the ThreadSanitizer from rising a warning. If the `DEBUG_LOCKORDER` code fails to detect a lock order inversion, the ThreadSanitizer should emit a warning.",
      "created_at" : "2020-05-22T11:28:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/19047#issuecomment-632643782",
      "id" : 632643782,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19047",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMjY0Mzc4Mg==",
      "updated_at" : "2020-05-22T11:28:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/632643782",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> If the DEBUG_LOCKORDER code fails to detect a lock order inversion, the ThreadSanitizer should emit a warning.\r\n\r\nIt should emit the warning, unless I am missing something and there are false negatives.",
      "created_at" : "2020-05-22T11:54:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/19047#issuecomment-632653535",
      "id" : 632653535,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19047",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMjY1MzUzNQ==",
      "updated_at" : "2020-05-22T11:54:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/632653535",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@MarcoFalke \r\n```\r\n$ ./configure --with-sanitizers=thread && make clean && make\r\n$ ./src/test/test_bitcoin --run_test=sync_tests\r\nRunning 1 test case...\r\n...\r\n*** No errors detected\r\nThreadSanitizer: reported 2 warnings\r\n```\r\nvs\r\n```\r\n\r\n$ ./configure --with-sanitizers=thread CPPFLAGS=-DDEBUG_LOCKORDER && make clean && make\r\n$ ./src/test/test_bitcoin --run_test=sync_tests\r\nRunning 1 test case...\r\n\r\n*** No errors detected\r\n```\r\n\r\nPlease note no warnings from the ThreadSanitizer in the latter case.",
      "created_at" : "2020-05-22T12:19:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/19047#issuecomment-632663594",
      "id" : 632663594,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19047",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMjY2MzU5NA==",
      "updated_at" : "2020-05-22T12:19:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/632663594",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "The sync tests are causing a potential deadlock on purpose. As far as I can see everything works as expected.",
      "created_at" : "2020-05-22T12:24:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/19047#issuecomment-632665252",
      "id" : 632665252,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19047",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMjY2NTI1Mg==",
      "updated_at" : "2020-05-22T12:24:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/632665252",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> The sync tests are causing a potential deadlock on purpose. As far as I can see everything works as expected.\r\n\r\nOf course! But it shows that `CPPFLAGS=-DDEBUG_LOCKORDER` suppresses the ThreadSanitizer warnings.",
      "created_at" : "2020-05-22T12:28:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/19047#issuecomment-632666525",
      "id" : 632666525,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19047",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMjY2NjUyNQ==",
      "updated_at" : "2020-05-22T12:28:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/632666525",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   }
]
