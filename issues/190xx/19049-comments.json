[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I tried to debug this but it is very awkward because the mutexes are unnamed:\r\n\r\n M134059 (0x7b6400004cc8) => M133094 (0x56527c390c60)\r\n\r\nIs there some way we can provide tsan with better names than M134059 and M133094 for mutexes? Or alternately is it possible to find out from gdb if 0x7b6400004cc8 and  0x56527c390c60 correspond to symbols?\r\n\r\nM134059 seems like it is the cs_wallets mutex since it is locked in wallet.cpp:4004\r\n\r\nM133094 could be anything because second stack trace is useless and just shows some lock being acquired in some HandleLoadWallet callback. The HandleLoadWallet callback in the test is mining a new block, so maybe the mutex in question is cs_main or mempool.cs. But I don't see a case where cs_wallets would ever be locked while holding cs_main or cs_mempool. I do see cs_wallets is locked while holding cs_wallet in CreateWalletFromFile. So maybe M133094 is cs_wallet? cs_wallet is temporarily unlocked in HandleLoadWallet so I guess that technically could cause a deadlock if some other future nonexistent thread was added.\r\n\r\nI guess feedback would here would be that I don't think tsan is doing anything useful for this test and should probably be suppressed. Also it would be good if it could display less confusing mutex names.",
      "created_at" : "2020-05-26T21:04:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/19049#issuecomment-634278293",
      "id" : 634278293,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19049",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzNDI3ODI5Mw==",
      "updated_at" : "2020-05-26T21:04:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/634278293",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Is there some way we can provide tsan with better names than M134059 and M133094 for mutexes?\r\n\r\nLooking at the [clang source code](https://github.com/llvm/llvm-project/blob/f74f5f2/compiler-rt/lib/tsan/rtl/tsan_report.cpp#L233) - I think not :(\r\n\r\n> Or alternately is it possible to find out from gdb if 0x7b6400004cc8 and 0x56527c390c60 correspond to symbols?\r\n\r\n`(gdb) info symbol 0x7b6400004cc8` should be able to give some useful information, but for me it just prints `No symbol matches 0x7fffffffd1b0` even though I have `AnnotatedMixin<std::__1::mutex>` object at that address. If you have a suspect you can inspect its address and see if it matches the address printed in the clang diagnostic.",
      "created_at" : "2020-06-02T18:45:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/19049#issuecomment-637737941",
      "id" : 637737941,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19049",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzNzczNzk0MQ==",
      "updated_at" : "2020-06-02T18:45:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/637737941",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Looking at the [clang source code](https://github.com/llvm/llvm-project/blob/f74f5f2/compiler-rt/lib/tsan/rtl/tsan_report.cpp#L233) - I think not :(\r\n\r\nVery interesting, thanks for looking into this!",
      "created_at" : "2020-06-02T19:01:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/19049#issuecomment-637746136",
      "id" : 637746136,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19049",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzNzc0NjEzNg==",
      "updated_at" : "2020-06-02T19:01:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/637746136",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "The issue shouldn't be in any of our annotated mutexes right? Otherwise `--enable-debug` would detect the issue. Thus, at least one of the mutexes must be a mutex in bdb (or some other library).?",
      "created_at" : "2020-06-02T19:16:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/19049#issuecomment-637753389",
      "id" : 637753389,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19049",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzNzc1MzM4OQ==",
      "updated_at" : "2020-06-02T19:16:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/637753389",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
