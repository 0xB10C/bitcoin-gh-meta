[
   {
      "author_association" : "MEMBER",
      "body" : "This is the final PR in the #18876 series of PRs.\r\n\r\nNote that there are a couple of differences from @jimpo's original PR:\r\n\r\n1. I didn't include the `BlockUntilSyncedToCurrentChain()` call from within `PrepareBlockFilterRequest()` (https://github.com/bitcoin/bitcoin/pull/16442/files#diff-eff7adeaec73a769788bb78858815c91R2068). I wanted to avoid having the message handler thread blocked on the scheduler thread, which is what services the validation interface queue callbacks. If the scheduler thread is doing some heavy work (eg flushing large wallet state to disk) then the message handler thread could be blocked for a long time, during which we don't process or respond to messages from any peers. In such a case, I'd prefer simply to not provide the cfilter or cfheader to the requesting client, since they can just rerequest it after a short delay.\r\n\r\n2. I've removed the logic that prevents `-peerblockfilters` being set if the index isn't synced (https://github.com/bitcoin/bitcoin/pull/16442/files#diff-c865a8939105e6350a50af02766291b7R1791). That code was added in response to review comments that the service bit shouldn't be set dynamically (https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-555256244 and https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-555994220), but it doesn't address my concern, which is that a node on the network will change its service bits. Those service bits are cached by peers on the network and gossiped in `addr` messages, so it's best for them to be as constant as possible. As well as that, it's a pain for the node operator to have to stop-start the node multiple times to enable this feature. The downside of always signaling `NODE_COMPACT_FILTERS` is that clients might request cfilters or cfheaders before our index is ready and we won't be able to respond. There's no `notfound` equivalent message in BIP 157 to communicate that to the peer, so we just drop their request. I think this is acceptable because:\r\n\r\n    - it's a small window after startup\r\n    - clients should be robust to not receiving responses to individual requests.\r\n\r\nOf course, both of those decisions are up for debate. If there's a consensus that my changes aren't desirable, I'll happily revert them.",
      "created_at" : "2020-05-26T16:45:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19070#issuecomment-634142901",
      "id" : 634142901,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19070",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzNDE0MjkwMQ==",
      "updated_at" : "2020-05-26T16:45:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/634142901",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   }
]
