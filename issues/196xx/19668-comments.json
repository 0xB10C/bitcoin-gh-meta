[
   {
      "author_association" : "MEMBER",
      "body" : "Friendly ping @ajtowns @vasild ",
      "created_at" : "2020-08-05T12:44:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19668#issuecomment-669171329",
      "id" : 669171329,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19668",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2OTE3MTMyOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-05T12:44:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/669171329",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19668#discussion_r465738894"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/465738894"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It seems a layer-violation to import the validation lock cs_main into the net.h header to annotate this function. Also, this approach doesn't seem like it scales, since it has to be done for each mutex that is held during a call to `ForEachNode`.",
      "commit_id" : "3f00515e92e7b6aed97c126592ad94b8a52a0e18",
      "created_at" : "2020-08-05T13:47:31Z",
      "diff_hunk" : "@@ -208,8 +210,18 @@ class CConnman\n \n     void PushMessage(CNode* pnode, CSerializedNetMsg&& msg);\n \n-    template<typename Callable>\n-    void ForEachNode(Callable&& func)\n+    template <typename Callable>\n+    void ForEachNodeUnlocked(Callable&& func) EXCLUSIVE_LOCKS_REQUIRED(!::cs_main)\n+    {\n+        LOCK(cs_vNodes);\n+        for (auto&& node : vNodes) {\n+            if (NodeFullyConnected(node))\n+                func(node);\n+        }\n+    };\n+\n+    template <typename Callable>\n+    void ForEachNode(Callable&& func) EXCLUSIVE_LOCKS_REQUIRED(::cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19668#discussion_r465738894",
      "id" : 465738894,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTczODg5NA==",
      "original_commit_id" : "5d64c6b18f158986e757e1d1f8e06b9a5ff22b48",
      "original_line" : 224,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 461680445,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19668",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-05T14:33:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/465738894",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Updated fa9157916514903cd7b526375597b1de0d8df8f0 -> 3f00515e92e7b6aed97c126592ad94b8a52a0e18 ([pr19668.01](https://github.com/hebasto/bitcoin/commits/pr19668.01) -> [pr19668.02](https://github.com/hebasto/bitcoin/commits/pr19668.02), [diff](https://github.com/hebasto/bitcoin/compare/pr19668.01..pr19668.02)).\r\n\r\nThis is an alternative approach without issues [mentioned](https://github.com/bitcoin/bitcoin/pull/19668#discussion_r465738894) by @MarcoFalke:\r\n> It seems a layer-violation to import the validation lock cs_main into the net.h header to annotate this function. Also, this approach doesn't seem like it scales, since it has to be done for each mutex that is held during a call to `ForEachNode`.\r\n\r\n",
      "created_at" : "2020-08-05T14:38:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19668#issuecomment-669231930",
      "id" : 669231930,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19668",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2OTIzMTkzMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-05T14:43:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/669231930",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@MarcoFalke \r\n> weak Concept ACK. Will review some more later\r\n\r\nUpdated motivation in the OP.",
      "created_at" : "2020-08-05T14:42:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19668#issuecomment-669233841",
      "id" : 669233841,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19668",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2OTIzMzg0MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-05T14:42:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/669233841",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19668#discussion_r465779202"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19668"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/465779202"
         }
      },
      "author_association" : "MEMBER",
      "body" : "[Updated](https://github.com/bitcoin/bitcoin/pull/19668#issuecomment-669231930).",
      "commit_id" : "3f00515e92e7b6aed97c126592ad94b8a52a0e18",
      "created_at" : "2020-08-05T14:43:17Z",
      "diff_hunk" : "@@ -208,8 +210,18 @@ class CConnman\n \n     void PushMessage(CNode* pnode, CSerializedNetMsg&& msg);\n \n-    template<typename Callable>\n-    void ForEachNode(Callable&& func)\n+    template <typename Callable>\n+    void ForEachNodeUnlocked(Callable&& func) EXCLUSIVE_LOCKS_REQUIRED(!::cs_main)\n+    {\n+        LOCK(cs_vNodes);\n+        for (auto&& node : vNodes) {\n+            if (NodeFullyConnected(node))\n+                func(node);\n+        }\n+    };\n+\n+    template <typename Callable>\n+    void ForEachNode(Callable&& func) EXCLUSIVE_LOCKS_REQUIRED(::cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19668#discussion_r465779202",
      "id" : 465779202,
      "in_reply_to_id" : 465738894,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTc3OTIwMg==",
      "original_commit_id" : "5d64c6b18f158986e757e1d1f8e06b9a5ff22b48",
      "original_line" : 224,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 461734281,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19668",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-05T14:43:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/465779202",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   }
]
