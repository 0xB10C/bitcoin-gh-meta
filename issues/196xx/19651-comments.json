[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Could we change `BerkeleyBatch::WriteKey` to return an enum describing the error? that will be inconsistent with the current API though.\r\nbut it will allow us to print a good error for the user, as he should probably know he already have that descriptor ",
      "created_at" : "2020-08-03T12:09:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#issuecomment-667987452",
      "id" : 667987452,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19651",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2Nzk4NzQ1Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-03T12:09:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/667987452",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2167860?v=4",
         "events_url" : "https://api.github.com/users/elichai/events{/privacy}",
         "followers_url" : "https://api.github.com/users/elichai/followers",
         "following_url" : "https://api.github.com/users/elichai/following{/other_user}",
         "gists_url" : "https://api.github.com/users/elichai/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/elichai",
         "id" : 2167860,
         "login" : "elichai",
         "node_id" : "MDQ6VXNlcjIxNjc4NjA=",
         "organizations_url" : "https://api.github.com/users/elichai/orgs",
         "received_events_url" : "https://api.github.com/users/elichai/received_events",
         "repos_url" : "https://api.github.com/users/elichai/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/elichai/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/elichai/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/elichai"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I think we should go with option 2: To update the existing spkman. The keys should either already exist or are being imported at that time. I don't think it's good to add keys in memory and not write them to disk as this could potentially result in lost keys.",
      "created_at" : "2020-08-03T16:07:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#issuecomment-668107138",
      "id" : 668107138,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19651",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2ODEwNzEzOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-03T16:07:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/668107138",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Could we change `BerkeleyBatch::WriteKey` to return an enum describing the error? that will be inconsistent with the current API though.\r\n> but it will allow us to print a good error for the user, as he should probably know he already have that descriptor\r\n\r\n@elichai I believe it's better to process the command rather than just show better error message, because it allows to modify some meta data: for example descriptor's range. However I added a trivial commit to make error message less misleading.\r\n\r\n> I think we should go with option 2: To update the existing spkman. The keys should either already exist or are being imported at that time. I don't think it's good to add keys in memory and not write them to disk as this could potentially result in lost keys.\r\n\r\n@achow101 Indeed, this aligns with my intuition as well. I changed the implementation and it looks cleaner to me. Hope I got the update semantics correct for the `DescriptorScriptPubKeyMan`. Could you please check?\r\n\r\n\r\n\r\n",
      "created_at" : "2020-08-06T08:45:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#issuecomment-669798234",
      "id" : 669798234,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19651",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2OTc5ODIzNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-06T08:45:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/669798234",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #19833 (wallet: Avoid locking cs_wallet recursively by promag)\n* #19602 (wallet: Migrate legacy wallets to descriptor wallets by achow101)\n* #19136 (wallet: add parent_desc to getaddressinfo by achow101)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-08-06T13:36:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#issuecomment-669930910",
      "id" : 669930910,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19651",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2OTkzMDkxMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-29T19:19:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/669930910",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r466555962"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466555962"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We also need to check that new range_end >= old range_end.",
      "commit_id" : "2bc7a7c5c4cd8201a903700aff9f85f1b506ebe8",
      "created_at" : "2020-08-06T17:03:17Z",
      "diff_hunk" : "@@ -2254,3 +2254,22 @@ const std::vector<CScript> DescriptorScriptPubKeyMan::GetScriptPubKeys() const\n     }\n     return script_pub_keys;\n }\n+\n+void DescriptorScriptPubKeyMan::UpdateDescriptor(WalletDescriptor& descriptor)\n+{\n+    LOCK(cs_desc_man);\n+    if (!HasWalletDescriptor(descriptor)) {\n+        throw std::runtime_error(std::string(__func__) + \": can only update matching descriptor\");\n+    }\n+    if (descriptor.range_start > m_wallet_descriptor.range_start) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r466555962",
      "id" : 466555962,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU1NTk2Mg==",
      "original_commit_id" : "d95d9b706007ba83c6c355f4fdabcd16d0bbfdb3",
      "original_line" : 2264,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 462706376,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-30T10:23:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466555962",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> The commit adding the test should be after or be the same commit as the one adding the fix. This way all commits pass tests.\r\n> \r\n> It would be nice if the tests checked the update behavior (e.g. new ranges, changed active-ness, etc.) but we can do that in a followup.\r\n\r\n@achow101 I squashed the test and the fix commits into one and extracted new function `CanUpdateToWalletDescriptor` to avoid code duplication. I also added some tests to verify various update scenarios: label change, range change, next_index, internal flag change, descriptor activation. A minor change were required in `DescriptorScriptPubKeyMan::SetCache` to make the tests pass.\r\n\r\nPlease note, descriptor deactivation is not working right now so there is no test for it. I'm currently working on it and will do as a separate PR.",
      "created_at" : "2020-08-17T11:19:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#issuecomment-674822483",
      "id" : 674822483,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19651",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3NDgyMjQ4Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-17T11:19:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/674822483",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-08-18T13:00:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#issuecomment-675464019",
      "id" : 675464019,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19651",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3NTQ2NDAxOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-18T13:00:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/675464019",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased and removed 51ea4c6ad808f881d26ff99da620e09d9549163e as it was already added to master",
      "created_at" : "2020-08-19T10:52:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#issuecomment-676137952",
      "id" : 676137952,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19651",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3NjEzNzk1Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-19T10:52:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/676137952",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r474787294"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/474787294"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why? Usually being unable to `ExpandFromCache` is a bad thing as it means the cache is not the size we are expecting.",
      "commit_id" : "2bc7a7c5c4cd8201a903700aff9f85f1b506ebe8",
      "created_at" : "2020-08-21T15:58:55Z",
      "diff_hunk" : "@@ -2183,7 +2183,7 @@ void DescriptorScriptPubKeyMan::SetCache(const DescriptorCache& cache)\n         FlatSigningProvider out_keys;\n         std::vector<CScript> scripts_temp;\n         if (!m_wallet_descriptor.descriptor->ExpandFromCache(i, m_wallet_descriptor.cache, scripts_temp, out_keys)) {\n-            throw std::runtime_error(\"Error: Unable to expand wallet descriptor from cache\");\n+            continue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r474787294",
      "id" : 474787294,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc4NzI5NA==",
      "original_commit_id" : "c82033b415aaa58641cd5349a6036782b738479b",
      "original_line" : 2186,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 472609180,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-30T10:23:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/474787294",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r474788781"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/474788781"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What if a descriptor adds private keys that weren't there before?",
      "commit_id" : "2bc7a7c5c4cd8201a903700aff9f85f1b506ebe8",
      "created_at" : "2020-08-21T16:01:52Z",
      "diff_hunk" : "@@ -2254,3 +2254,41 @@ const std::vector<CScript> DescriptorScriptPubKeyMan::GetScriptPubKeys() const\n     }\n     return script_pub_keys;\n }\n+\n+void DescriptorScriptPubKeyMan::UpdateWalletDescriptor(WalletDescriptor& descriptor)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r474788781",
      "id" : 474788781,
      "line" : 2264,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc4ODc4MQ==",
      "original_commit_id" : "a2d7106a5b179414e186dbdc9befcc7c7a6ff255",
      "original_line" : 2262,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 18,
      "pull_request_review_id" : 472609180,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-30T10:23:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/474788781",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r474790348"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/474790348"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why? I don't think it is necessarily wrong for a `ScriptPubKeyMan` to serve both internal and external addresses. We do this in the legacy wallet. Also, it seems like this should break the legacy wallet.",
      "commit_id" : "2bc7a7c5c4cd8201a903700aff9f85f1b506ebe8",
      "created_at" : "2020-08-21T16:04:59Z",
      "diff_hunk" : "@@ -4478,10 +4478,15 @@ void CWallet::LoadActiveScriptPubKeyMan(uint256 id, OutputType type, bool intern\n {\n     WalletLogPrintf(\"Setting spkMan to active: id = %s, type = %d, internal = %d\\n\", id.ToString(), static_cast<int>(type), static_cast<int>(internal));\n     auto& spk_mans = internal ? m_internal_spk_managers : m_external_spk_managers;\n+    auto& spk_mans_other = internal ? m_external_spk_managers : m_internal_spk_managers;\n     auto spk_man = m_spk_managers.at(id).get();\n     spk_man->SetInternal(internal);\n     spk_mans[type] = spk_man;\n \n+    if (spk_mans_other[type] == spk_man) {\n+        spk_mans_other[type] = nullptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r474790348",
      "id" : 474790348,
      "line" : 4491,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc5MDM0OA==",
      "original_commit_id" : "b34664c1f480f0e75e8e2da9eb59128e0c4b734c",
      "original_line" : 4491,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 16,
      "pull_request_review_id" : 472609180,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-30T10:23:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/474790348",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r475058943"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475058943"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I thought about it and concluded that shouldn't be possible. Here is how I reasoned about it.\r\n1) If private keys are disabled in the wallet we don't have to worry at all, afaik it's not possible to change the flag on existing wallet. \r\n2) Now, if keys are enabled and we add new keys I believe the descriptor would be a new one and won't match any existing descriptor. We find a matching descriptor to be updated by using `HasWalletDescriptor`. So it's only possible to update a wallet descriptor if and only if spring representation of the descriptor matches. I would say we can only update a meta-data of a descriptor: range, next_index, active, internal flags and so on. And if there are new private keys in the new descriptor that should lead to a different string representation with corresponding new public keys.\r\n\r\nI'm new to the codebase, so might miss something. Let me know.",
      "commit_id" : "2bc7a7c5c4cd8201a903700aff9f85f1b506ebe8",
      "created_at" : "2020-08-22T07:32:35Z",
      "diff_hunk" : "@@ -2254,3 +2254,41 @@ const std::vector<CScript> DescriptorScriptPubKeyMan::GetScriptPubKeys() const\n     }\n     return script_pub_keys;\n }\n+\n+void DescriptorScriptPubKeyMan::UpdateWalletDescriptor(WalletDescriptor& descriptor)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r475058943",
      "id" : 475058943,
      "in_reply_to_id" : 474788781,
      "line" : 2264,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA1ODk0Mw==",
      "original_commit_id" : "a2d7106a5b179414e186dbdc9befcc7c7a6ff255",
      "original_line" : 2262,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 18,
      "pull_request_review_id" : 472905008,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-30T10:23:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475058943",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r475059774"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475059774"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Otherwise we are not able to reuse cache when we extend the range for a descriptor. The test will fail at test/functional/wallet_importdescriptors.py:240. We will try to reuse existing cache and apply it to the new range of a bigger size.\r\n\r\nI can't see any downsides to just skipping over missing parts in provided cache. The blanks will be filled with `TopUp()` ad hoc.\r\n\r\nIf you have a strong feeling about this, we can skip cache reuse whatsoever when we update descriptor and expand from the descriptor itself and not from cache.",
      "commit_id" : "2bc7a7c5c4cd8201a903700aff9f85f1b506ebe8",
      "created_at" : "2020-08-22T07:42:42Z",
      "diff_hunk" : "@@ -2183,7 +2183,7 @@ void DescriptorScriptPubKeyMan::SetCache(const DescriptorCache& cache)\n         FlatSigningProvider out_keys;\n         std::vector<CScript> scripts_temp;\n         if (!m_wallet_descriptor.descriptor->ExpandFromCache(i, m_wallet_descriptor.cache, scripts_temp, out_keys)) {\n-            throw std::runtime_error(\"Error: Unable to expand wallet descriptor from cache\");\n+            continue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r475059774",
      "id" : 475059774,
      "in_reply_to_id" : 474787294,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA1OTc3NA==",
      "original_commit_id" : "c82033b415aaa58641cd5349a6036782b738479b",
      "original_line" : 2186,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 472905574,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-30T10:23:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475059774",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r475065518"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475065518"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Two reasons:\r\n1) If we don't do that, than semantics of `importdescriptors` changes. What I'm trying to achieve with this pull request is to make the command idempotent and allow for updates. In case when we don't remove specified SPK from previous map in the wallet (`m_internal_spk_managers`/`m_external_spk_managers`) than it's not really possible for a user to change `internal` flag. When she would try to do so, we would just register same descriptor in the second map. And it's not what I would expect.\r\n\r\n2) This is required to keep consistency when we move descriptor from internal to external and vice versa. `DescriptorScriptPubKeyMan` has `m_internal` flag. It begs for some bugs if this flag is inconsistent with the descriptor placements in the wallet. For example it will affects `KeypoolCountExternalKeys()` and as a consequence the reporting of internal/external key pool sizes.\r\n\r\nWhile this indeed goes against how legacy wallet operates it looks like it doesn't break it. The reason being is that legacy wallet is configured by `SetupLegacyScriptPubKeyMan` and don't use `LoadActiveScriptPubKeyMan`. I tried to verify by using a wallet from 0.16.3 and calling `getnewaddress` and `getrawchagneaddress` and both worked returning a key from the same `hdseedid`. Anyway, let me think how I can improve it. I'm also open from your suggestions.\r\n\r\nP.S. I also looked at the possibility of removing `m_internal` but that doesn't seems possible due to the public interface of SPK. My motivation was to completely illuminate possible inconsistency between wallet and SPK in terms of `internal` flag. Do you think this is an idea worth exploring? ",
      "commit_id" : "2bc7a7c5c4cd8201a903700aff9f85f1b506ebe8",
      "created_at" : "2020-08-22T08:54:08Z",
      "diff_hunk" : "@@ -4478,10 +4478,15 @@ void CWallet::LoadActiveScriptPubKeyMan(uint256 id, OutputType type, bool intern\n {\n     WalletLogPrintf(\"Setting spkMan to active: id = %s, type = %d, internal = %d\\n\", id.ToString(), static_cast<int>(type), static_cast<int>(internal));\n     auto& spk_mans = internal ? m_internal_spk_managers : m_external_spk_managers;\n+    auto& spk_mans_other = internal ? m_external_spk_managers : m_internal_spk_managers;\n     auto spk_man = m_spk_managers.at(id).get();\n     spk_man->SetInternal(internal);\n     spk_mans[type] = spk_man;\n \n+    if (spk_mans_other[type] == spk_man) {\n+        spk_mans_other[type] = nullptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r475065518",
      "id" : 475065518,
      "in_reply_to_id" : 474790348,
      "line" : 4491,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTA2NTUxOA==",
      "original_commit_id" : "b34664c1f480f0e75e8e2da9eb59128e0c4b734c",
      "original_line" : 4491,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 16,
      "pull_request_review_id" : 472909325,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-30T10:23:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475065518",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r475108102"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475108102"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I believe this is unsafe when the wallet is encrypted and the descriptor uses hardened derivation. Such `DescriptorScriptPubKeyMan`s are entirely reliant on the cache when the wallet is locked and I think there should be an expectation that updating a such a descriptor should make the specified range available, i.e. the cache is filled.\r\n\r\nI think it's fine to regenerate the cache from scratch when updating a descriptor like this. It would be better if just the missing entries could be added, but that might be harder to do.",
      "commit_id" : "2bc7a7c5c4cd8201a903700aff9f85f1b506ebe8",
      "created_at" : "2020-08-22T16:44:34Z",
      "diff_hunk" : "@@ -2183,7 +2183,7 @@ void DescriptorScriptPubKeyMan::SetCache(const DescriptorCache& cache)\n         FlatSigningProvider out_keys;\n         std::vector<CScript> scripts_temp;\n         if (!m_wallet_descriptor.descriptor->ExpandFromCache(i, m_wallet_descriptor.cache, scripts_temp, out_keys)) {\n-            throw std::runtime_error(\"Error: Unable to expand wallet descriptor from cache\");\n+            continue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r475108102",
      "id" : 475108102,
      "in_reply_to_id" : 474787294,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwODEwMg==",
      "original_commit_id" : "c82033b415aaa58641cd5349a6036782b738479b",
      "original_line" : 2186,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 472937631,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-30T10:23:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475108102",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r475108211"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475108211"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The only current possibility for new private keys is a multisig descriptor. It should be possible to import a multisig descriptor that has only some of the private keys, then update the descriptor with more of the private keys in the multisig.",
      "commit_id" : "2bc7a7c5c4cd8201a903700aff9f85f1b506ebe8",
      "created_at" : "2020-08-22T16:45:41Z",
      "diff_hunk" : "@@ -2254,3 +2254,41 @@ const std::vector<CScript> DescriptorScriptPubKeyMan::GetScriptPubKeys() const\n     }\n     return script_pub_keys;\n }\n+\n+void DescriptorScriptPubKeyMan::UpdateWalletDescriptor(WalletDescriptor& descriptor)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r475108211",
      "id" : 475108211,
      "in_reply_to_id" : 474788781,
      "line" : 2264,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwODIxMQ==",
      "original_commit_id" : "a2d7106a5b179414e186dbdc9befcc7c7a6ff255",
      "original_line" : 2262,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 18,
      "pull_request_review_id" : 472937691,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-30T10:23:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475108211",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r475109376"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475109376"
         }
      },
      "author_association" : "MEMBER",
      "body" : "While legacy wallets do use `SetupLegacyScriptPubKeyMan`, they also have `externalspk` and `internalspk` entries which are handled by `LoadActiveScriptPubKeyMan`. So it should break legacy wallets, and I'm not sure why it doesn't. \r\n\r\nI would prefer that the changing of the activeness and internalness is handled by another function which should also have a comment about why it should remain separate from `LoadActiveScriptPubKeyMan`. As it is now, I think it makes the loading code more fragile and difficult to understand.",
      "commit_id" : "2bc7a7c5c4cd8201a903700aff9f85f1b506ebe8",
      "created_at" : "2020-08-22T16:57:42Z",
      "diff_hunk" : "@@ -4478,10 +4478,15 @@ void CWallet::LoadActiveScriptPubKeyMan(uint256 id, OutputType type, bool intern\n {\n     WalletLogPrintf(\"Setting spkMan to active: id = %s, type = %d, internal = %d\\n\", id.ToString(), static_cast<int>(type), static_cast<int>(internal));\n     auto& spk_mans = internal ? m_internal_spk_managers : m_external_spk_managers;\n+    auto& spk_mans_other = internal ? m_external_spk_managers : m_internal_spk_managers;\n     auto spk_man = m_spk_managers.at(id).get();\n     spk_man->SetInternal(internal);\n     spk_mans[type] = spk_man;\n \n+    if (spk_mans_other[type] == spk_man) {\n+        spk_mans_other[type] = nullptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r475109376",
      "id" : 475109376,
      "in_reply_to_id" : 474790348,
      "line" : 4491,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwOTM3Ng==",
      "original_commit_id" : "b34664c1f480f0e75e8e2da9eb59128e0c4b734c",
      "original_line" : 4491,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 16,
      "pull_request_review_id" : 472938332,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-30T10:23:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475109376",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r478335849"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478335849"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done. The cache is now regenerated on import.",
      "commit_id" : "2bc7a7c5c4cd8201a903700aff9f85f1b506ebe8",
      "created_at" : "2020-08-27T11:07:11Z",
      "diff_hunk" : "@@ -2183,7 +2183,7 @@ void DescriptorScriptPubKeyMan::SetCache(const DescriptorCache& cache)\n         FlatSigningProvider out_keys;\n         std::vector<CScript> scripts_temp;\n         if (!m_wallet_descriptor.descriptor->ExpandFromCache(i, m_wallet_descriptor.cache, scripts_temp, out_keys)) {\n-            throw std::runtime_error(\"Error: Unable to expand wallet descriptor from cache\");\n+            continue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r478335849",
      "id" : 478335849,
      "in_reply_to_id" : 474787294,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODMzNTg0OQ==",
      "original_commit_id" : "c82033b415aaa58641cd5349a6036782b738479b",
      "original_line" : 2186,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 476612307,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-30T10:23:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478335849",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r478336183"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478336183"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks. Changed the code to properly handle this case and added a test for it as well.",
      "commit_id" : "2bc7a7c5c4cd8201a903700aff9f85f1b506ebe8",
      "created_at" : "2020-08-27T11:07:50Z",
      "diff_hunk" : "@@ -2254,3 +2254,41 @@ const std::vector<CScript> DescriptorScriptPubKeyMan::GetScriptPubKeys() const\n     }\n     return script_pub_keys;\n }\n+\n+void DescriptorScriptPubKeyMan::UpdateWalletDescriptor(WalletDescriptor& descriptor)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r478336183",
      "id" : 478336183,
      "in_reply_to_id" : 474788781,
      "line" : 2264,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODMzNjE4Mw==",
      "original_commit_id" : "a2d7106a5b179414e186dbdc9befcc7c7a6ff255",
      "original_line" : 2262,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 18,
      "pull_request_review_id" : 476612716,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-30T10:23:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478336183",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r478339994"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478339994"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I analyzed the code and couldn't find any uses of `LoadActiveScriptPubKeyMan` for legacy wallets. The function is only called when 1) we create new wallet, 2) call `importdescriptors` command or 3) when loading a wallet from disk. But if I'm not mistaken there is no active SPKs on disk for legacy wallets. That makes me believe this function is only relevant for descriptor wallets. So I put a guard at the top to throw an exception when we call it for legacy wallet. And all wallet functional tests pass on my laptop for now. I'm happy to reproduce any scenario in which this code should break legacy wallet.\r\n\r\n",
      "commit_id" : "2bc7a7c5c4cd8201a903700aff9f85f1b506ebe8",
      "created_at" : "2020-08-27T11:15:55Z",
      "diff_hunk" : "@@ -4478,10 +4478,15 @@ void CWallet::LoadActiveScriptPubKeyMan(uint256 id, OutputType type, bool intern\n {\n     WalletLogPrintf(\"Setting spkMan to active: id = %s, type = %d, internal = %d\\n\", id.ToString(), static_cast<int>(type), static_cast<int>(internal));\n     auto& spk_mans = internal ? m_internal_spk_managers : m_external_spk_managers;\n+    auto& spk_mans_other = internal ? m_external_spk_managers : m_internal_spk_managers;\n     auto spk_man = m_spk_managers.at(id).get();\n     spk_man->SetInternal(internal);\n     spk_mans[type] = spk_man;\n \n+    if (spk_mans_other[type] == spk_man) {\n+        spk_mans_other[type] = nullptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r478339994",
      "id" : 478339994,
      "in_reply_to_id" : 474790348,
      "line" : 4491,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODMzOTk5NA==",
      "original_commit_id" : "b34664c1f480f0e75e8e2da9eb59128e0c4b734c",
      "original_line" : 4491,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 16,
      "pull_request_review_id" : 476617732,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-30T10:23:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478339994",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Added `wallet: deactivate descriptor` commit from #19774",
      "created_at" : "2020-08-27T11:17:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#issuecomment-681885443",
      "id" : 681885443,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19651",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4MTg4NTQ0Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-27T11:17:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/681885443",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r478519589"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478519589"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Hmm, `SetupLegacyScriptPubKeyMan` adds the `LegacySPKM` to the maps that track internal/external, but doesn't write them to disk. I thought it wrote them to disk and now I'm wondering whether not doing so is a bug. But since it doesn't, that's why this works.",
      "commit_id" : "2bc7a7c5c4cd8201a903700aff9f85f1b506ebe8",
      "created_at" : "2020-08-27T15:47:02Z",
      "diff_hunk" : "@@ -4478,10 +4478,15 @@ void CWallet::LoadActiveScriptPubKeyMan(uint256 id, OutputType type, bool intern\n {\n     WalletLogPrintf(\"Setting spkMan to active: id = %s, type = %d, internal = %d\\n\", id.ToString(), static_cast<int>(type), static_cast<int>(internal));\n     auto& spk_mans = internal ? m_internal_spk_managers : m_external_spk_managers;\n+    auto& spk_mans_other = internal ? m_external_spk_managers : m_internal_spk_managers;\n     auto spk_man = m_spk_managers.at(id).get();\n     spk_man->SetInternal(internal);\n     spk_mans[type] = spk_man;\n \n+    if (spk_mans_other[type] == spk_man) {\n+        spk_mans_other[type] = nullptr;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r478519589",
      "id" : 478519589,
      "in_reply_to_id" : 474790348,
      "line" : 4491,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODUxOTU4OQ==",
      "original_commit_id" : "b34664c1f480f0e75e8e2da9eb59128e0c4b734c",
      "original_line" : 4491,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 16,
      "pull_request_review_id" : 476854803,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-30T10:23:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478519589",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r478559557"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478559557"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think it would be better to have this inside of `AddDescriptorKeyWithDB`. Additionally, it needs to check `m_map_crypted_keys` otherwise this won't work when the wallet is encrypted.",
      "commit_id" : "2bc7a7c5c4cd8201a903700aff9f85f1b506ebe8",
      "created_at" : "2020-08-27T16:50:51Z",
      "diff_hunk" : "@@ -1836,6 +1836,10 @@ void DescriptorScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n void DescriptorScriptPubKeyMan::AddDescriptorKey(const CKey& key, const CPubKey &pubkey)\n {\n     LOCK(cs_desc_man);\n+    if (m_map_keys.find(pubkey.GetID()) != m_map_keys.end()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r478559557",
      "id" : 478559557,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU1OTU1Nw==",
      "original_commit_id" : "745c2a860fc05bc181bc50edbcb2f2a69a21b896",
      "original_line" : 1839,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 476907069,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-30T10:23:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478559557",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r478561752"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478561752"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think using `[]` for access here could be problematic if the `type` isn't already in the map (I think that can happen). I would prefer using `find` here and then if it works, checking that the returned object is not `nullptr`.",
      "commit_id" : "2bc7a7c5c4cd8201a903700aff9f85f1b506ebe8",
      "created_at" : "2020-08-27T16:54:44Z",
      "diff_hunk" : "@@ -4494,6 +4494,22 @@ void CWallet::LoadActiveScriptPubKeyMan(uint256 id, OutputType type, bool intern\n     NotifyCanGetAddressesChanged();\n }\n \n+void CWallet::DeactivateScriptPubKeyMan(uint256 id, OutputType type, bool internal)\n+{\n+    auto& spk_mans = internal ? m_internal_spk_managers : m_external_spk_managers;\n+    if (spk_mans[type] && spk_mans[type]->GetID() == id) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r478561752",
      "id" : 478561752,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU2MTc1Mg==",
      "original_commit_id" : "39e1c5a6c28e86ed7e831f096581ec8ed70ade7e",
      "original_line" : 4500,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 476909988,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-30T10:23:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478561752",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r479037965"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479037965"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm not a cpp expert, but the docs say in case when there is no such key a default value will be inserted. \r\n> std::map<Key,T,Compare,Allocator>::operator[]\r\n> Returns a reference to the value that is mapped to a key equivalent to key, performing an insertion if such key does not already exist.\r\n\r\nSo I believe it's safe in this particular case.\r\n\r\nI still prefer `spk_mans[type]` over `spk_mans.find(type) != spk_mans.end() && spk_mans[type] != nullptr` but if that's going against the norms for the project I can change to whatever is considered standard way.\r\n",
      "commit_id" : "2bc7a7c5c4cd8201a903700aff9f85f1b506ebe8",
      "created_at" : "2020-08-28T09:43:41Z",
      "diff_hunk" : "@@ -4494,6 +4494,22 @@ void CWallet::LoadActiveScriptPubKeyMan(uint256 id, OutputType type, bool intern\n     NotifyCanGetAddressesChanged();\n }\n \n+void CWallet::DeactivateScriptPubKeyMan(uint256 id, OutputType type, bool internal)\n+{\n+    auto& spk_mans = internal ? m_internal_spk_managers : m_external_spk_managers;\n+    if (spk_mans[type] && spk_mans[type]->GetID() == id) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r479037965",
      "id" : 479037965,
      "in_reply_to_id" : 478561752,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTAzNzk2NQ==",
      "original_commit_id" : "39e1c5a6c28e86ed7e831f096581ec8ed70ade7e",
      "original_line" : 4500,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 477592807,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-30T10:23:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479037965",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r479043727"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479043727"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "2bc7a7c5c4cd8201a903700aff9f85f1b506ebe8",
      "created_at" : "2020-08-28T09:48:33Z",
      "diff_hunk" : "@@ -1836,6 +1836,10 @@ void DescriptorScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n void DescriptorScriptPubKeyMan::AddDescriptorKey(const CKey& key, const CPubKey &pubkey)\n {\n     LOCK(cs_desc_man);\n+    if (m_map_keys.find(pubkey.GetID()) != m_map_keys.end()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r479043727",
      "id" : 479043727,
      "in_reply_to_id" : 478559557,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTA0MzcyNw==",
      "original_commit_id" : "745c2a860fc05bc181bc50edbcb2f2a69a21b896",
      "original_line" : 1839,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 477595886,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-30T10:23:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479043727",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r479393567"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479393567"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Right, but the point is that we don't want a default value inserted.\r\n\r\nIt might be easier to just use `GetScriptPubKeyMan` here.",
      "commit_id" : "2bc7a7c5c4cd8201a903700aff9f85f1b506ebe8",
      "created_at" : "2020-08-28T15:56:31Z",
      "diff_hunk" : "@@ -4494,6 +4494,22 @@ void CWallet::LoadActiveScriptPubKeyMan(uint256 id, OutputType type, bool intern\n     NotifyCanGetAddressesChanged();\n }\n \n+void CWallet::DeactivateScriptPubKeyMan(uint256 id, OutputType type, bool internal)\n+{\n+    auto& spk_mans = internal ? m_internal_spk_managers : m_external_spk_managers;\n+    if (spk_mans[type] && spk_mans[type]->GetID() == id) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r479393567",
      "id" : 479393567,
      "in_reply_to_id" : 478561752,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM5MzU2Nw==",
      "original_commit_id" : "39e1c5a6c28e86ed7e831f096581ec8ed70ade7e",
      "original_line" : 4500,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 477844400,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-30T10:23:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479393567",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r479751284"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479751284"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "2bc7a7c5c4cd8201a903700aff9f85f1b506ebe8",
      "created_at" : "2020-08-30T10:23:50Z",
      "diff_hunk" : "@@ -4494,6 +4494,22 @@ void CWallet::LoadActiveScriptPubKeyMan(uint256 id, OutputType type, bool intern\n     NotifyCanGetAddressesChanged();\n }\n \n+void CWallet::DeactivateScriptPubKeyMan(uint256 id, OutputType type, bool internal)\n+{\n+    auto& spk_mans = internal ? m_internal_spk_managers : m_external_spk_managers;\n+    if (spk_mans[type] && spk_mans[type]->GetID() == id) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#discussion_r479751284",
      "id" : 479751284,
      "in_reply_to_id" : 478561752,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTc1MTI4NA==",
      "original_commit_id" : "39e1c5a6c28e86ed7e831f096581ec8ed70ade7e",
      "original_line" : 4500,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 478190533,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19651",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-30T10:23:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479751284",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@achow101 thanks for your time and review. I pushed changes as fixup commits for easier incremental review, when you believe the code is ready to be merged I'll squash them into original commits.",
      "created_at" : "2020-08-30T10:27:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19651#issuecomment-683403173",
      "id" : 683403173,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19651",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4MzQwMzE3Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-30T10:27:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/683403173",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   }
]
