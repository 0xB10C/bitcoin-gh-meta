[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "This PR was suggested by @hebasto https://github.com/bitcoin/bitcoin/pull/16981#issuecomment-669658597 (thank you!)",
      "created_at" : "2020-08-10T03:50:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19690#issuecomment-671150925",
      "id" : 671150925,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19690",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3MTE1MDkyNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-10T03:50:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/671150925",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19690#discussion_r467746632"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19690"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/467746632"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit, join with above line.",
      "commit_id" : "ab412ec3071dd056bad362aa78c88d02d5a46c3b",
      "created_at" : "2020-08-10T08:09:41Z",
      "diff_hunk" : "@@ -832,12 +832,21 @@ class CBufferedFile\n \n     //! search for a given byte in the stream, and remain positioned on it\n     void FindByte(char ch) {\n+        // start is the index into vchBuf[] at which to start searching\n+        size_t start = nReadPos % vchBuf.size();\n         while (true) {\n             if (nReadPos == nSrcPos)\n                 Fill();\n-            if (vchBuf[nReadPos % vchBuf.size()] == ch)\n-                break;\n-            nReadPos++;\n+            size_t n = vchBuf.size() - start;\n+            if (n > nSrcPos - nReadPos)\n+                n = nSrcPos - nReadPos;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19690#discussion_r467746632",
      "id" : 467746632,
      "line" : 842,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc0NjYzMg==",
      "original_commit_id" : "ab412ec3071dd056bad362aa78c88d02d5a46c3b",
      "original_line" : 842,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/streams.h",
      "position" : 14,
      "pull_request_review_id" : 464028727,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19690",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-10T08:15:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/467746632",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@LarryRuane \r\n> ... improving its CPU runtime by a factor of about 25 in typical use.\r\n\r\nHow was it measured?\r\n\r\n",
      "created_at" : "2020-08-10T11:10:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19690#issuecomment-671293857",
      "id" : 671293857,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19690",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3MTI5Mzg1Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-10T11:10:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/671293857",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Any idea *why* this is so much faster? As far as I know, there is no faster algorithm to look for the first occurrence of a single byte in a memory array than a linear iteration over it. I'd expect `std::find` of a byte to simply unroll into a loop.",
      "created_at" : "2020-08-10T11:38:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19690#issuecomment-671305132",
      "id" : 671305132,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19690",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3MTMwNTEzMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-10T11:38:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/671305132",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> How was it measured?\r\n\r\nI ran:\r\n```\r\ntime src/test/test_bitcoin --run_test=streams_tests/streams_findbyte\r\n```\r\nwith master (1m20s) and with master + PR (3s).\r\n\r\n> Any idea _why_ this is so much faster? \r\n\r\nI think you're correct that there's no faster way than a loop with runtime proportional to the number of bytes to scan, but I assume `std::find()` on a char vector is highly optimized, probably using `memchr()` or `memcmp()`, which are implemented in assembly language. Also, the master version does a few things each byte (testing `nReadPos == nSrcPos`, remainder calculation (`%`), incrementing `nReadPos`) that the PR does once for each large run of bytes.\r\n\r\nI just noticed that the repetition count on the test is set to a large number (50000000) and I meant to reduce it for the commit (3 seconds is too long to add to the unit test suite). I'll reduce that number in force push in a minute. This test doesn't really need to be in this PR (`FindByte()`'s functionality is tested very well in another test), but it helps reviewers verify the performance improvement.",
      "created_at" : "2020-08-10T14:38:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19690#issuecomment-671395708",
      "id" : 671395708,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19690",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3MTM5NTcwOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-10T14:38:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/671395708",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Force-push ([diff](https://github.com/bitcoin/bitcoin/compare/ab412ec3071dd056bad362aa78c88d02d5a46c3b..a31aa3255499ba8878ba98e4ac5a22a408c68da0)) small fix to the test, so it doesn't take 3 seconds to run.",
      "created_at" : "2020-08-10T14:46:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19690#issuecomment-671400344",
      "id" : 671400344,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19690",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3MTQwMDM0NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-10T14:46:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/671400344",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> but I assume std::find() on a char vector is highly optimized, probably using memchr() or memcmp(), which are implemented in assembly language\r\n\r\nThat's true, it's possible to optimize that with assembly language (definitely with specific instruction sets).\r\n\r\nit still surprises me because you'd expect the I/O, to read the data from disk, to dominate greatly in the block importing. Not looking for a character already in memory! It just seems out of proportion.\r\n",
      "created_at" : "2020-08-10T16:43:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19690#issuecomment-671464582",
      "id" : 671464582,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19690",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3MTQ2NDU4Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-10T16:43:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/671464582",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   }
]
