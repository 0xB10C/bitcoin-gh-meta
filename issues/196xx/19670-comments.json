[
   {
      "author_association" : "MEMBER",
      "body" : "This should fix #19500, but I need to figure out how to test this...",
      "created_at" : "2020-08-05T19:00:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19670#issuecomment-669408329",
      "id" : 669408329,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19670",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2OTQwODMyOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-05T19:00:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/669408329",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r465993080"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/465993080"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@gmaxwell I should get rid of this `n.nLastBlockTime > 0` right?  So that we'll always protect up to 8 non-tx-relay peers, even if they haven't managed to be first to send us a block.  But perhaps I should only protect them if `fRelevantServices` is true, so that non-full nodes do not get protected here?",
      "commit_id" : "e5af0d1b656c35a7b0be45b46509867265bae691",
      "created_at" : "2020-08-05T20:45:11Z",
      "diff_hunk" : "@@ -903,12 +918,31 @@ bool CConnman::AttemptToEvictConnection()\n     // Protect 4 nodes that most recently sent us transactions.\n     // An attacker cannot manipulate this metric without performing useful work.\n     EraseLastKElements(vEvictionCandidates, CompareNodeTXTime, 4);\n+    // Protect up to 8 non-tx-relay peers that have sent us blocks.\n+    std::sort(vEvictionCandidates.begin(), vEvictionCandidates.end(), CompareNodeBlockRelayOnlyTime);\n+    size_t erase_size = std::min(size_t(8), vEvictionCandidates.size());\n+    std::remove_if(vEvictionCandidates.end() - erase_size, vEvictionCandidates.end(), [](NodeEvictionCandidate const &n) { return !n.fRelayTxes && n.nLastBlockTime > 0; });",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r465993080",
      "id" : 465993080,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk5MzA4MA==",
      "original_commit_id" : "ce35ffee1a937696ff65a38bfa9fd67032505ec8",
      "original_line" : 924,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 462010253,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-06T01:01:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/465993080",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r466007029"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466007029"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think requring fRelevantServices makes sense.  I think it's not import to require that they sent a block-- helping them stay connected so long as they (claim they) could might help keep them around long enough to successfully do so.",
      "commit_id" : "e5af0d1b656c35a7b0be45b46509867265bae691",
      "created_at" : "2020-08-05T21:12:38Z",
      "diff_hunk" : "@@ -903,12 +918,31 @@ bool CConnman::AttemptToEvictConnection()\n     // Protect 4 nodes that most recently sent us transactions.\n     // An attacker cannot manipulate this metric without performing useful work.\n     EraseLastKElements(vEvictionCandidates, CompareNodeTXTime, 4);\n+    // Protect up to 8 non-tx-relay peers that have sent us blocks.\n+    std::sort(vEvictionCandidates.begin(), vEvictionCandidates.end(), CompareNodeBlockRelayOnlyTime);\n+    size_t erase_size = std::min(size_t(8), vEvictionCandidates.size());\n+    std::remove_if(vEvictionCandidates.end() - erase_size, vEvictionCandidates.end(), [](NodeEvictionCandidate const &n) { return !n.fRelayTxes && n.nLastBlockTime > 0; });",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r466007029",
      "id" : 466007029,
      "in_reply_to_id" : 465993080,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjAwNzAyOQ==",
      "original_commit_id" : "ce35ffee1a937696ff65a38bfa9fd67032505ec8",
      "original_line" : 924,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 462027702,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-06T01:01:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466007029",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r466085368"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466085368"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed, thanks.",
      "commit_id" : "e5af0d1b656c35a7b0be45b46509867265bae691",
      "created_at" : "2020-08-06T01:01:38Z",
      "diff_hunk" : "@@ -903,12 +918,31 @@ bool CConnman::AttemptToEvictConnection()\n     // Protect 4 nodes that most recently sent us transactions.\n     // An attacker cannot manipulate this metric without performing useful work.\n     EraseLastKElements(vEvictionCandidates, CompareNodeTXTime, 4);\n+    // Protect up to 8 non-tx-relay peers that have sent us blocks.\n+    std::sort(vEvictionCandidates.begin(), vEvictionCandidates.end(), CompareNodeBlockRelayOnlyTime);\n+    size_t erase_size = std::min(size_t(8), vEvictionCandidates.size());\n+    std::remove_if(vEvictionCandidates.end() - erase_size, vEvictionCandidates.end(), [](NodeEvictionCandidate const &n) { return !n.fRelayTxes && n.nLastBlockTime > 0; });",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r466085368",
      "id" : 466085368,
      "in_reply_to_id" : 465993080,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA4NTM2OA==",
      "original_commit_id" : "ce35ffee1a937696ff65a38bfa9fd67032505ec8",
      "original_line" : 924,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 462118990,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-06T01:01:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466085368",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK (modulo proper testing of course :))",
      "created_at" : "2020-08-06T08:49:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19670#issuecomment-669800157",
      "id" : 669800157,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19670",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2OTgwMDE1Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-06T08:49:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/669800157",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r466313982"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466313982"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If this PR was built on top of #19316, you could test directly for block-relay-only peers. I think that'd be a cleaner implementation.",
      "commit_id" : "e5af0d1b656c35a7b0be45b46509867265bae691",
      "created_at" : "2020-08-06T10:20:37Z",
      "diff_hunk" : "@@ -845,6 +852,14 @@ static bool CompareNodeTXTime(const NodeEvictionCandidate &a, const NodeEviction\n     return a.nTimeConnected > b.nTimeConnected;\n }\n \n+// Pick out the potential block-relay only peers, and sort them by last block time.\n+static bool CompareNodeBlockRelayOnlyTime(const NodeEvictionCandidate &a, const NodeEvictionCandidate &b)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r466313982",
      "id" : 466313982,
      "line" : 856,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMxMzk4Mg==",
      "original_commit_id" : "e5af0d1b656c35a7b0be45b46509867265bae691",
      "original_line" : 856,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 26,
      "pull_request_review_id" : 462391972,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-06T10:23:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466313982",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.",
      "created_at" : "2020-08-06T10:21:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19670#issuecomment-669844501",
      "id" : 669844501,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19670",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2OTg0NDUwMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-06T10:21:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/669844501",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   }
]
