[
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2020-07-30T15:43:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19628#issuecomment-666471177",
      "id" : 666471177,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19628",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2NjQ3MTE3Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-30T15:43:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/666471177",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "[Filtered code coverage report](https://people.freebsd.org/~vd/pr19628_daa1d8b11_coverage/) (files not modified by this PR are omitted and not modified lines in files that are otherwise modified are dimmed).\r\n\r\n[List of modified and not covered lines](https://people.freebsd.org/~vd/pr19628_daa1d8b11_coverage/modified_and_not_covered.html).",
      "created_at" : "2020-07-30T16:01:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19628#issuecomment-666487671",
      "id" : 666487671,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19628",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2NjQ4NzY3MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-30T16:01:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/666487671",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #19643 (Add `-netinfo` peer connections dashboard by jonatack)\n* #19415 (net: Make DNS lookup mockable, add fuzzing harness by practicalswift)\n* #19326 (Simplify hash.h interface using Spans by sipa)\n* #18722 (addrman: improve performance by using more suitable containers by vasild)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-07-30T20:25:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19628#issuecomment-666670421",
      "id" : 666670421,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19628",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2NjY3MDQyMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-02T20:20:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/666670421",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19628#discussion_r463949087"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19628"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/463949087"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Are you sure the use of `prevector` is warranted here? Measurements would be nice.\r\n\r\nGenerally I think we should try stick with to the standard containers unless we have clear quantitative evidence showing that they are unsuitable for the scenario being considered. Reviewers, static analysers and compilers tend to be better at analysing use of the standard containers :)\r\n\r\nFWIW: \r\n\r\n```\r\n$ git grep -l prevector -- \"*.cpp\" \"*.h\" \":(exclude)src/bench/\" \":(exclude)src/test/\"\r\nsrc/hash.h\r\nsrc/memusage.h\r\nsrc/prevector.h\r\nsrc/script/script.h\r\nsrc/serialize.h\r\n```",
      "commit_id" : "daa1d8b114e5ed3c631a634e02ba0da392db6e8e",
      "created_at" : "2020-08-01T10:36:13Z",
      "diff_hunk" : "@@ -49,18 +51,50 @@ enum Network\n     NET_MAX,\n };\n \n+/// If an IPv6 address begins with this, then we treat the rest of it as IPv4 address.\n+static constexpr uint8_t IPv4_IN_IPv6_PREFIX[12] = {\n+    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF\n+};\n+\n+/// If an IPv6 address begins with this, then we treat the rest of it as TORv2 address.\n+static constexpr uint8_t TORv2_IN_IPv6_PREFIX[6] = {\n+    0xFD, 0x87, 0xD8, 0x7E, 0xEB, 0x43\n+};\n+\n+/// If an IPv6 address begins with this, then we treat the rest of it as an internal address.\n+static constexpr uint8_t INTERNAL_IN_IPv6_PREFIX[6] = {\n+    0xFD, 0x6B, 0x88, 0xC0, 0x87, 0x24 // 0xFD + sha256(\"bitcoin\")[0:5].\n+};\n+\n+/// Size of IPv4 address (in bytes).\n+static constexpr size_t ADDR_IPv4_SIZE = 4;\n+\n+/// Size of IPv6 address (in bytes).\n+static constexpr size_t ADDR_IPv6_SIZE = 16;\n+\n+/// Size of TORv2 address (in bytes).\n+static constexpr size_t ADDR_TORv2_SIZE = 10;\n+\n+/// Size of \"internal\" (NET_INTERNAL) address (in bytes).\n+static constexpr size_t ADDR_INTERNAL_SIZE = 10;\n+\n /**\n  * Network address.\n  */\n class CNetAddr\n {\n     protected:\n+        /**\n+         * Raw representation of the network address.\n+         * In network byte order (big endian) for IPv4 and IPv6.\n+         */\n+        prevector<ADDR_IPv6_SIZE, uint8_t> m_addr{ADDR_IPv6_SIZE, 0x0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19628#discussion_r463949087",
      "id" : 463949087,
      "line" : 91,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzk0OTA4Nw==",
      "original_commit_id" : "daa1d8b114e5ed3c631a634e02ba0da392db6e8e",
      "original_line" : 91,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/netaddress.h",
      "position" : 51,
      "pull_request_review_id" : 459569784,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19628",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T11:37:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/463949087",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19628#discussion_r463984610"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19628"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/463984610"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I suggested this, so let me back it up.\r\n\r\nCurrently an address in CAddrMan consumes 256 bytes (cost in mapInfo and mapAddr together, plus allocation overhead).\r\n\r\nThis PR as-is raises that to 288 bytes, for addresses that take up to 16 bytes (which is all of them, for now).\r\n\r\nUsing an `std::vector<uint8_t>` instead would change that to 352 bytes per address, or an extra 64 on top. It would also increase memory fragmentation and (slightly) increase CPU usage because of two malloc's per address.\r\n\r\nFTR, my node has 69691 addresses in CAddrMan.",
      "commit_id" : "daa1d8b114e5ed3c631a634e02ba0da392db6e8e",
      "created_at" : "2020-08-01T17:52:19Z",
      "diff_hunk" : "@@ -49,18 +51,50 @@ enum Network\n     NET_MAX,\n };\n \n+/// If an IPv6 address begins with this, then we treat the rest of it as IPv4 address.\n+static constexpr uint8_t IPv4_IN_IPv6_PREFIX[12] = {\n+    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF\n+};\n+\n+/// If an IPv6 address begins with this, then we treat the rest of it as TORv2 address.\n+static constexpr uint8_t TORv2_IN_IPv6_PREFIX[6] = {\n+    0xFD, 0x87, 0xD8, 0x7E, 0xEB, 0x43\n+};\n+\n+/// If an IPv6 address begins with this, then we treat the rest of it as an internal address.\n+static constexpr uint8_t INTERNAL_IN_IPv6_PREFIX[6] = {\n+    0xFD, 0x6B, 0x88, 0xC0, 0x87, 0x24 // 0xFD + sha256(\"bitcoin\")[0:5].\n+};\n+\n+/// Size of IPv4 address (in bytes).\n+static constexpr size_t ADDR_IPv4_SIZE = 4;\n+\n+/// Size of IPv6 address (in bytes).\n+static constexpr size_t ADDR_IPv6_SIZE = 16;\n+\n+/// Size of TORv2 address (in bytes).\n+static constexpr size_t ADDR_TORv2_SIZE = 10;\n+\n+/// Size of \"internal\" (NET_INTERNAL) address (in bytes).\n+static constexpr size_t ADDR_INTERNAL_SIZE = 10;\n+\n /**\n  * Network address.\n  */\n class CNetAddr\n {\n     protected:\n+        /**\n+         * Raw representation of the network address.\n+         * In network byte order (big endian) for IPv4 and IPv6.\n+         */\n+        prevector<ADDR_IPv6_SIZE, uint8_t> m_addr{ADDR_IPv6_SIZE, 0x0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19628#discussion_r463984610",
      "id" : 463984610,
      "in_reply_to_id" : 463949087,
      "line" : 91,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzk4NDYxMA==",
      "original_commit_id" : "daa1d8b114e5ed3c631a634e02ba0da392db6e8e",
      "original_line" : 91,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/netaddress.h",
      "position" : 51,
      "pull_request_review_id" : 459593442,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19628",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-01T17:52:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/463984610",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19628#discussion_r464117640"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19628"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/464117640"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@sipa Thanks for quantifying! That answers my question :)",
      "commit_id" : "daa1d8b114e5ed3c631a634e02ba0da392db6e8e",
      "created_at" : "2020-08-02T20:01:00Z",
      "diff_hunk" : "@@ -49,18 +51,50 @@ enum Network\n     NET_MAX,\n };\n \n+/// If an IPv6 address begins with this, then we treat the rest of it as IPv4 address.\n+static constexpr uint8_t IPv4_IN_IPv6_PREFIX[12] = {\n+    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF\n+};\n+\n+/// If an IPv6 address begins with this, then we treat the rest of it as TORv2 address.\n+static constexpr uint8_t TORv2_IN_IPv6_PREFIX[6] = {\n+    0xFD, 0x87, 0xD8, 0x7E, 0xEB, 0x43\n+};\n+\n+/// If an IPv6 address begins with this, then we treat the rest of it as an internal address.\n+static constexpr uint8_t INTERNAL_IN_IPv6_PREFIX[6] = {\n+    0xFD, 0x6B, 0x88, 0xC0, 0x87, 0x24 // 0xFD + sha256(\"bitcoin\")[0:5].\n+};\n+\n+/// Size of IPv4 address (in bytes).\n+static constexpr size_t ADDR_IPv4_SIZE = 4;\n+\n+/// Size of IPv6 address (in bytes).\n+static constexpr size_t ADDR_IPv6_SIZE = 16;\n+\n+/// Size of TORv2 address (in bytes).\n+static constexpr size_t ADDR_TORv2_SIZE = 10;\n+\n+/// Size of \"internal\" (NET_INTERNAL) address (in bytes).\n+static constexpr size_t ADDR_INTERNAL_SIZE = 10;\n+\n /**\n  * Network address.\n  */\n class CNetAddr\n {\n     protected:\n+        /**\n+         * Raw representation of the network address.\n+         * In network byte order (big endian) for IPv4 and IPv6.\n+         */\n+        prevector<ADDR_IPv6_SIZE, uint8_t> m_addr{ADDR_IPv6_SIZE, 0x0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19628#discussion_r464117640",
      "id" : 464117640,
      "in_reply_to_id" : 463949087,
      "line" : 91,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDExNzY0MA==",
      "original_commit_id" : "daa1d8b114e5ed3c631a634e02ba0da392db6e8e",
      "original_line" : 91,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/netaddress.h",
      "position" : 51,
      "pull_request_review_id" : 459674809,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19628",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-02T20:01:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/464117640",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19628#discussion_r464154824"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19628"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/464154824"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Slightly more modern:\r\n\r\n```c++\r\nreturn std::all_of(m_addr.begin(), m_addr.end(), [](uint8_t b) { return b == 0; });\r\n```\r\n",
      "commit_id" : "daa1d8b114e5ed3c631a634e02ba0da392db6e8e",
      "created_at" : "2020-08-03T01:42:35Z",
      "diff_hunk" : "@@ -85,151 +70,161 @@ bool CNetAddr::SetInternal(const std::string &name)\n     m_net = NET_INTERNAL;\n     unsigned char hash[32] = {};\n     CSHA256().Write((const unsigned char*)name.data(), name.size()).Finalize(hash);\n-    memcpy(ip, g_internal_prefix, sizeof(g_internal_prefix));\n-    memcpy(ip + sizeof(g_internal_prefix), hash, sizeof(ip) - sizeof(g_internal_prefix));\n+    m_addr.assign(hash, hash + ADDR_INTERNAL_SIZE);\n     return true;\n }\n \n /**\n- * Try to make this a dummy address that maps the specified onion address into\n- * IPv6 using OnionCat's range and encoding. Such dummy addresses have a prefix\n- * of fd87:d87e:eb43::/48 and are guaranteed to not be publicly routable as they\n- * fall under RFC4193's fc00::/7 subnet allocated to unique-local addresses.\n+ * Parse a TORv2 address and set this object to it.\n  *\n  * @returns Whether or not the operation was successful.\n  *\n- * @see CNetAddr::IsTor(), CNetAddr::IsRFC4193()\n+ * @see CNetAddr::IsTor()\n  */\n bool CNetAddr::SetSpecial(const std::string &strName)\n {\n     if (strName.size()>6 && strName.substr(strName.size() - 6, 6) == \".onion\") {\n         std::vector<unsigned char> vchAddr = DecodeBase32(strName.substr(0, strName.size() - 6).c_str());\n-        if (vchAddr.size() != 16-sizeof(pchOnionCat))\n+        if (vchAddr.size() != ADDR_TORv2_SIZE)\n             return false;\n         m_net = NET_ONION;\n-        memcpy(ip, pchOnionCat, sizeof(pchOnionCat));\n-        for (unsigned int i=0; i<16-sizeof(pchOnionCat); i++)\n-            ip[i + sizeof(pchOnionCat)] = vchAddr[i];\n+        m_addr.assign(vchAddr.begin(), vchAddr.end());\n         return true;\n     }\n     return false;\n }\n \n CNetAddr::CNetAddr(const struct in_addr& ipv4Addr)\n {\n-    SetRaw(NET_IPV4, (const uint8_t*)&ipv4Addr);\n+    m_net = NET_IPV4;\n+    const uint8_t* ptr = reinterpret_cast<const uint8_t*>(&ipv4Addr);\n+    m_addr.assign(ptr, ptr + ADDR_IPv4_SIZE);\n }\n \n CNetAddr::CNetAddr(const struct in6_addr& ipv6Addr, const uint32_t scope)\n {\n-    SetRaw(NET_IPV6, (const uint8_t*)&ipv6Addr);\n+    assert(sizeof(ipv6Addr) == ADDR_IPv6_SIZE);\n+    SetLegacyIPv6(*reinterpret_cast<const uint8_t (*)[ADDR_IPv6_SIZE]>(&ipv6Addr));\n     scopeId = scope;\n }\n \n-unsigned int CNetAddr::GetByte(int n) const\n-{\n-    return ip[15-n];\n-}\n-\n bool CNetAddr::IsBindAny() const\n {\n-    const int cmplen = IsIPv4() ? 4 : 16;\n-    for (int i = 0; i < cmplen; ++i) {\n-        if (GetByte(i)) return false;\n+    if (!IsIPv4() && !IsIPv6()) {\n+        return false;\n+    }\n+    for (uint8_t b : m_addr) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19628#discussion_r464154824",
      "id" : 464154824,
      "line" : 116,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDE1NDgyNA==",
      "original_commit_id" : "daa1d8b114e5ed3c631a634e02ba0da392db6e8e",
      "original_line" : 116,
      "original_position" : 142,
      "original_start_line" : null,
      "path" : "src/netaddress.cpp",
      "position" : 142,
      "pull_request_review_id" : 459705383,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19628",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-03T01:57:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/464154824",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19628#discussion_r464156291"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19628"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/464156291"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not something you introduced, but this only works because those addresses have the same byte representation in every byte order.\r\n",
      "commit_id" : "daa1d8b114e5ed3c631a634e02ba0da392db6e8e",
      "created_at" : "2020-08-03T01:50:28Z",
      "diff_hunk" : "@@ -287,17 +283,12 @@ bool CNetAddr::IsValid() const\n     if (IsInternal())\n         return false;\n \n-    if (IsIPv4())\n-    {\n-        // INADDR_NONE\n-        uint32_t ipNone = INADDR_NONE;\n-        if (memcmp(ip+12, &ipNone, 4) == 0)\n-            return false;\n-\n-        // 0\n-        ipNone = 0;\n-        if (memcmp(ip+12, &ipNone, 4) == 0)\n-            return false;\n+    if (IsIPv4()) {\n+        for (uint32_t a : {(uint32_t)INADDR_ANY, (uint32_t)INADDR_NONE}) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19628#discussion_r464156291",
      "id" : 464156291,
      "line" : 287,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDE1NjI5MQ==",
      "original_commit_id" : "daa1d8b114e5ed3c631a634e02ba0da392db6e8e",
      "original_line" : 287,
      "original_position" : 329,
      "original_start_line" : null,
      "path" : "src/netaddress.cpp",
      "position" : 329,
      "pull_request_review_id" : 459705383,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19628",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-03T01:57:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/464156291",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19628#discussion_r464156525"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19628"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/464156525"
         }
      },
      "author_association" : "MEMBER",
      "body" : "More modern:\r\n\r\n```c++\r\nreturn std::tie(a.m_net, a.m_addr) < std::tie(b.m_net, b.m_addr);\r\n```\r\n",
      "commit_id" : "daa1d8b114e5ed3c631a634e02ba0da392db6e8e",
      "created_at" : "2020-08-03T01:51:43Z",
      "diff_hunk" : "@@ -369,12 +360,12 @@ std::string CNetAddr::ToString() const\n \n bool operator==(const CNetAddr& a, const CNetAddr& b)\n {\n-    return a.m_net == b.m_net && memcmp(a.ip, b.ip, 16) == 0;\n+    return a.m_net == b.m_net && a.m_addr == b.m_addr;\n }\n \n bool operator<(const CNetAddr& a, const CNetAddr& b)\n {\n-    return a.m_net < b.m_net || (a.m_net == b.m_net && memcmp(a.ip, b.ip, 16) < 0);\n+    return a.m_net < b.m_net || (a.m_net == b.m_net && a.m_addr < b.m_addr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19628#discussion_r464156525",
      "id" : 464156525,
      "line" : 368,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDE1NjUyNQ==",
      "original_commit_id" : "daa1d8b114e5ed3c631a634e02ba0da392db6e8e",
      "original_line" : 368,
      "original_position" : 390,
      "original_start_line" : null,
      "path" : "src/netaddress.cpp",
      "position" : 390,
      "pull_request_review_id" : 459705383,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19628",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-03T01:57:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/464156525",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19628#discussion_r464157430"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19628"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/464157430"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Nit: uppercase v in global constants (here and further).",
      "commit_id" : "daa1d8b114e5ed3c631a634e02ba0da392db6e8e",
      "created_at" : "2020-08-03T01:56:08Z",
      "diff_hunk" : "@@ -49,18 +51,50 @@ enum Network\n     NET_MAX,\n };\n \n+/// If an IPv6 address begins with this, then we treat the rest of it as IPv4 address.\n+static constexpr uint8_t IPv4_IN_IPv6_PREFIX[12] = {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19628#discussion_r464157430",
      "id" : 464157430,
      "line" : 55,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDE1NzQzMA==",
      "original_commit_id" : "daa1d8b114e5ed3c631a634e02ba0da392db6e8e",
      "original_line" : 55,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/netaddress.h",
      "position" : 15,
      "pull_request_review_id" : 459705383,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19628",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-03T01:57:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/464157430",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-08-03T16:25:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19628#issuecomment-668116023",
      "id" : 668116023,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19628",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2ODExNjAyMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-03T16:25:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/668116023",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19628#discussion_r465544086"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19628"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/465544086"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for the question and the elaborate explanation! Indeed smaller size and avoiding an extra heap allocation is better. FWIW I moved `m_addr` definition before `m_net` to save 8 bytes from the size of `CNetAddr` (32 vs 40 bytes on x64).",
      "commit_id" : "daa1d8b114e5ed3c631a634e02ba0da392db6e8e",
      "created_at" : "2020-08-05T07:58:28Z",
      "diff_hunk" : "@@ -49,18 +51,50 @@ enum Network\n     NET_MAX,\n };\n \n+/// If an IPv6 address begins with this, then we treat the rest of it as IPv4 address.\n+static constexpr uint8_t IPv4_IN_IPv6_PREFIX[12] = {\n+    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF\n+};\n+\n+/// If an IPv6 address begins with this, then we treat the rest of it as TORv2 address.\n+static constexpr uint8_t TORv2_IN_IPv6_PREFIX[6] = {\n+    0xFD, 0x87, 0xD8, 0x7E, 0xEB, 0x43\n+};\n+\n+/// If an IPv6 address begins with this, then we treat the rest of it as an internal address.\n+static constexpr uint8_t INTERNAL_IN_IPv6_PREFIX[6] = {\n+    0xFD, 0x6B, 0x88, 0xC0, 0x87, 0x24 // 0xFD + sha256(\"bitcoin\")[0:5].\n+};\n+\n+/// Size of IPv4 address (in bytes).\n+static constexpr size_t ADDR_IPv4_SIZE = 4;\n+\n+/// Size of IPv6 address (in bytes).\n+static constexpr size_t ADDR_IPv6_SIZE = 16;\n+\n+/// Size of TORv2 address (in bytes).\n+static constexpr size_t ADDR_TORv2_SIZE = 10;\n+\n+/// Size of \"internal\" (NET_INTERNAL) address (in bytes).\n+static constexpr size_t ADDR_INTERNAL_SIZE = 10;\n+\n /**\n  * Network address.\n  */\n class CNetAddr\n {\n     protected:\n+        /**\n+         * Raw representation of the network address.\n+         * In network byte order (big endian) for IPv4 and IPv6.\n+         */\n+        prevector<ADDR_IPv6_SIZE, uint8_t> m_addr{ADDR_IPv6_SIZE, 0x0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19628#discussion_r465544086",
      "id" : 465544086,
      "in_reply_to_id" : 463949087,
      "line" : 91,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTU0NDA4Ng==",
      "original_commit_id" : "daa1d8b114e5ed3c631a634e02ba0da392db6e8e",
      "original_line" : 91,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/netaddress.h",
      "position" : 51,
      "pull_request_review_id" : 461427646,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19628",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-05T07:58:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/465544086",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19628#discussion_r465567494"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19628"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/465567494"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Right! Even though the values of those constants is never going to change (I hope!), does the following look better?\r\n\r\n```cpp\r\nfor (uint32_t a : {htonl(INADDR_ANY), htonl(INADDR_NONE)}) {\r\n```",
      "commit_id" : "daa1d8b114e5ed3c631a634e02ba0da392db6e8e",
      "created_at" : "2020-08-05T08:39:19Z",
      "diff_hunk" : "@@ -287,17 +283,12 @@ bool CNetAddr::IsValid() const\n     if (IsInternal())\n         return false;\n \n-    if (IsIPv4())\n-    {\n-        // INADDR_NONE\n-        uint32_t ipNone = INADDR_NONE;\n-        if (memcmp(ip+12, &ipNone, 4) == 0)\n-            return false;\n-\n-        // 0\n-        ipNone = 0;\n-        if (memcmp(ip+12, &ipNone, 4) == 0)\n-            return false;\n+    if (IsIPv4()) {\n+        for (uint32_t a : {(uint32_t)INADDR_ANY, (uint32_t)INADDR_NONE}) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19628#discussion_r465567494",
      "id" : 465567494,
      "in_reply_to_id" : 464156291,
      "line" : 287,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTU2NzQ5NA==",
      "original_commit_id" : "daa1d8b114e5ed3c631a634e02ba0da392db6e8e",
      "original_line" : 287,
      "original_position" : 329,
      "original_start_line" : null,
      "path" : "src/netaddress.cpp",
      "position" : 329,
      "pull_request_review_id" : 461457580,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19628",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-05T08:39:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/465567494",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   }
]
