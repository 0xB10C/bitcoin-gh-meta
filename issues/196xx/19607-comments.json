[
   {
      "author_association" : "MEMBER",
      "body" : "Thank you @MarcoFalke @promag @jonatack @dongcarl @ariard @theuni @fjahr @hebasto @troygiorshev for reviewing the prerequisite PRs! This is the first PR in the cs_main_split sequence where we start getting benefit by reducing cs_main scope in net processing. It also introduces the new structure and locking model, so it's the PR that requires the most conceptual/approach review in the sequence. If this gets merged, then it's a long procession of PRs to slowly move data into the new `Peer` object.",
      "created_at" : "2020-07-28T09:24:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-664914956",
      "id" : 664914956,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19607",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2NDkxNDk1Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-28T09:24:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/664914956",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r461660871"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/461660871"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    const NodeId m_id;\r\n```\r\n\r\nin commit d60a16bb3f58fcb9422c277256b3c3a31cab3b2f\r\n\r\nAny reason to not make this const? Having this mutable would violate the assumption that the id is unique per peer.",
      "commit_id" : "3fa130da3ad7960f9ece4d34ff6e108b64b6f957",
      "created_at" : "2020-07-28T15:12:42Z",
      "diff_hunk" : "@@ -468,6 +468,44 @@ static CNodeState *State(NodeId pnode) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     return &it->second;\n }\n \n+/**\n+ * Data stucture for an individual peer. This struct is not protected by\n+ * cs_main since it does not contain validation-critical data.\n+ *\n+ * Memory is owned by shared pointers and this object is destructed when\n+ * the refcount drops to zero (in FinalizeNode()).\n+ *\n+ * TODO: move most members from CNodeState to this structure.\n+ * TODO: move remaining application-layer data members from CNode to this structure.\n+ */\n+struct Peer {\n+    /** Same id as the CNode object for this peer */\n+    NodeId m_id;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r461660871",
      "id" : 461660871,
      "line" : 474,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTY2MDg3MQ==",
      "original_commit_id" : "d60a16bb3f58fcb9422c277256b3c3a31cab3b2f",
      "original_line" : 483,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 45,
      "pull_request_review_id" : 456737279,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-28T15:47:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/461660871",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r461661767"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/461661767"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit in commit d60a16bb3f58fcb9422c277256b3c3a31cab3b2f\r\n```suggestion\r\n * the refcount drops to zero.\r\n```\r\n\r\nFinalizeNode only decreases the refcount by one. It can still be larger than one (as long as someone is holding a PeerRef, e.g. `getpeerinfo` or similar)",
      "commit_id" : "3fa130da3ad7960f9ece4d34ff6e108b64b6f957",
      "created_at" : "2020-07-28T15:13:51Z",
      "diff_hunk" : "@@ -468,6 +468,44 @@ static CNodeState *State(NodeId pnode) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     return &it->second;\n }\n \n+/**\n+ * Data stucture for an individual peer. This struct is not protected by\n+ * cs_main since it does not contain validation-critical data.\n+ *\n+ * Memory is owned by shared pointers and this object is destructed when\n+ * the refcount drops to zero (in FinalizeNode()).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r461661767",
      "id" : 461661767,
      "line" : 467,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTY2MTc2Nw==",
      "original_commit_id" : "d60a16bb3f58fcb9422c277256b3c3a31cab3b2f",
      "original_line" : 476,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 38,
      "pull_request_review_id" : 456737279,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-28T15:47:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/461661767",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r461664437"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/461664437"
         }
      },
      "author_association" : "MEMBER",
      "body" : "\r\nnit in same commit:\r\n\r\nCan be written with one less line ;)\r\n\r\n```suggestion\r\n    if (it != g_peer_map.end()) return it->second;\r\n    return {}; // ( or return nullptr; )\r\n```",
      "commit_id" : "3fa130da3ad7960f9ece4d34ff6e108b64b6f957",
      "created_at" : "2020-07-28T15:17:32Z",
      "diff_hunk" : "@@ -468,6 +468,44 @@ static CNodeState *State(NodeId pnode) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     return &it->second;\n }\n \n+/**\n+ * Data stucture for an individual peer. This struct is not protected by\n+ * cs_main since it does not contain validation-critical data.\n+ *\n+ * Memory is owned by shared pointers and this object is destructed when\n+ * the refcount drops to zero (in FinalizeNode()).\n+ *\n+ * TODO: move most members from CNodeState to this structure.\n+ * TODO: move remaining application-layer data members from CNode to this structure.\n+ */\n+struct Peer {\n+    /** Same id as the CNode object for this peer */\n+    NodeId m_id;\n+\n+    Peer(NodeId id) : m_id(id) {}\n+};\n+\n+using PeerRef = std::shared_ptr<Peer>;\n+\n+/**\n+ * Map of all Peer objects, keyed by peer id. This map is protected\n+ * by the global g_peer_mutex. Once a shared pointer reference is\n+ * taken, the lock may be released. Individual fields are protected by\n+ * their own locks.\n+ */\n+Mutex g_peer_mutex;\n+static std::map<NodeId, PeerRef> g_peer_map GUARDED_BY(g_peer_mutex);\n+\n+/** Get a shared pointer to the Peer object.\n+ *  May return nullptr if the Peer object can't be found. */\n+static PeerRef GetPeer(NodeId id) {\n+    PeerRef ret;\n+    LOCK(g_peer_mutex);\n+    auto it = g_peer_map.find(id);\n+    if (it != g_peer_map.end()) ret = it->second;\n+    return ret;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r461664437",
      "id" : 461664437,
      "line" : 504,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTY2NDQzNw==",
      "original_commit_id" : "d60a16bb3f58fcb9422c277256b3c3a31cab3b2f",
      "original_line" : 506,
      "original_position" : 39,
      "original_start_line" : 505,
      "path" : "src/net_processing.cpp",
      "position" : 75,
      "pull_request_review_id" : 456737279,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : 503,
      "start_side" : "RIGHT",
      "updated_at" : "2020-07-28T15:47:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/461664437",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r461695156"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/461695156"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This may be a rare case where a ternary makes things clearer.\r\n```suggestion\r\n    return (it != g_peer_map.end()) ? it->second : nullptr;\r\n```",
      "commit_id" : "3fa130da3ad7960f9ece4d34ff6e108b64b6f957",
      "created_at" : "2020-07-28T16:00:34Z",
      "diff_hunk" : "@@ -468,6 +468,44 @@ static CNodeState *State(NodeId pnode) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     return &it->second;\n }\n \n+/**\n+ * Data stucture for an individual peer. This struct is not protected by\n+ * cs_main since it does not contain validation-critical data.\n+ *\n+ * Memory is owned by shared pointers and this object is destructed when\n+ * the refcount drops to zero (in FinalizeNode()).\n+ *\n+ * TODO: move most members from CNodeState to this structure.\n+ * TODO: move remaining application-layer data members from CNode to this structure.\n+ */\n+struct Peer {\n+    /** Same id as the CNode object for this peer */\n+    NodeId m_id;\n+\n+    Peer(NodeId id) : m_id(id) {}\n+};\n+\n+using PeerRef = std::shared_ptr<Peer>;\n+\n+/**\n+ * Map of all Peer objects, keyed by peer id. This map is protected\n+ * by the global g_peer_mutex. Once a shared pointer reference is\n+ * taken, the lock may be released. Individual fields are protected by\n+ * their own locks.\n+ */\n+Mutex g_peer_mutex;\n+static std::map<NodeId, PeerRef> g_peer_map GUARDED_BY(g_peer_mutex);\n+\n+/** Get a shared pointer to the Peer object.\n+ *  May return nullptr if the Peer object can't be found. */\n+static PeerRef GetPeer(NodeId id) {\n+    PeerRef ret;\n+    LOCK(g_peer_mutex);\n+    auto it = g_peer_map.find(id);\n+    if (it != g_peer_map.end()) ret = it->second;\n+    return ret;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r461695156",
      "id" : 461695156,
      "in_reply_to_id" : 461664437,
      "line" : 504,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTY5NTE1Ng==",
      "original_commit_id" : "d60a16bb3f58fcb9422c277256b3c3a31cab3b2f",
      "original_line" : 506,
      "original_position" : 39,
      "original_start_line" : 505,
      "path" : "src/net_processing.cpp",
      "position" : 75,
      "pull_request_review_id" : 456782646,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : 503,
      "start_side" : "RIGHT",
      "updated_at" : "2020-07-28T16:00:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/461695156",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #18261 (Erlay: bandwidth-efficient transaction relay protocol by naumenkogs)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-07-28T17:04:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-665160859",
      "id" : 665160859,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19607",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2NTE2MDg1OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-28T17:04:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/665160859",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r461860798"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/461860798"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "ACK on the removal of the unused `CNodeState.name`, however it's kinda hidden here and makes the misbehaving moves in 53a2978b5ea27852f7bfab337ccec83feee4e72e harder to follow.  Maybe it should be done in its own commit?",
      "commit_id" : "3fa130da3ad7960f9ece4d34ff6e108b64b6f957",
      "created_at" : "2020-07-28T20:33:02Z",
      "diff_hunk" : "@@ -270,12 +270,6 @@ struct CNodeState {\n     const CService address;\n     //! Whether we have a fully established connection.\n     bool fCurrentlyConnected;\n-    //! Accumulated misbehaviour score for this peer.\n-    int nMisbehavior;\n-    //! Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission).\n-    bool m_should_discourage;\n-    //! String name of this peer (debugging/logging purposes).\n-    const std::string name;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r461860798",
      "id" : 461860798,
      "line" : 278,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg2MDc5OA==",
      "original_commit_id" : "3fa130da3ad7960f9ece4d34ff6e108b64b6f957",
      "original_line" : 278,
      "original_position" : 9,
      "original_start_line" : 277,
      "path" : "src/net_processing.cpp",
      "position" : 9,
      "pull_request_review_id" : 456989502,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "LEFT",
      "start_line" : 277,
      "start_side" : "LEFT",
      "updated_at" : "2020-07-28T21:00:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/461860798",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r461862887"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/461862887"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: `GetPeer` is already in the codebase as `CService::GetPeer`.  Suggest `GetPeerRef` instead",
      "commit_id" : "3fa130da3ad7960f9ece4d34ff6e108b64b6f957",
      "created_at" : "2020-07-28T20:37:00Z",
      "diff_hunk" : "@@ -468,6 +459,51 @@ static CNodeState *State(NodeId pnode) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     return &it->second;\n }\n \n+/**\n+ * Data stucture for an individual peer. This struct is not protected by\n+ * cs_main since it does not contain validation-critical data.\n+ *\n+ * Memory is owned by shared pointers and this object is destructed when\n+ * the refcount drops to zero (in FinalizeNode()).\n+ *\n+ * TODO: move most members from CNodeState to this structure.\n+ * TODO: move remaining application-layer data members from CNode to this structure.\n+ */\n+struct Peer {\n+    /** Same id as the CNode object for this peer */\n+    NodeId m_id;\n+\n+    /** Protects misbehavior data members */\n+    Mutex m_misbehavior_mutex;\n+    /** Accumulated misbehavior score for this peer */\n+    int m_misbehavior_score GUARDED_BY(m_misbehavior_mutex) {0};\n+    /** Whether this peer should be disconnected and banned (unless it has the noban permission) */\n+    bool m_should_discourage GUARDED_BY(m_misbehavior_mutex) {false};\n+\n+    Peer(NodeId id) : m_id(id) {}\n+};\n+\n+using PeerRef = std::shared_ptr<Peer>;\n+\n+/**\n+ * Map of all Peer objects, keyed by peer id. This map is protected\n+ * by the global g_peer_mutex. Once a shared pointer reference is\n+ * taken, the lock may be released. Individual fields are protected by\n+ * their own locks.\n+ */\n+Mutex g_peer_mutex;\n+static std::map<NodeId, PeerRef> g_peer_map GUARDED_BY(g_peer_mutex);\n+\n+/** Get a shared pointer to the Peer object.\n+ *  May return nullptr if the Peer object can't be found. */\n+static PeerRef GetPeer(NodeId id) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r461862887",
      "id" : 461862887,
      "line" : 499,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg2Mjg4Nw==",
      "original_commit_id" : "3fa130da3ad7960f9ece4d34ff6e108b64b6f957",
      "original_line" : 499,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 70,
      "pull_request_review_id" : 456989502,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-29T00:18:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/461862887",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r461871291"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/461871291"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "s/stucture/structure/",
      "commit_id" : "3fa130da3ad7960f9ece4d34ff6e108b64b6f957",
      "created_at" : "2020-07-28T20:52:05Z",
      "diff_hunk" : "@@ -468,6 +459,51 @@ static CNodeState *State(NodeId pnode) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     return &it->second;\n }\n \n+/**\n+ * Data stucture for an individual peer. This struct is not protected by",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r461871291",
      "id" : 461871291,
      "line" : 463,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg3MTI5MQ==",
      "original_commit_id" : "3fa130da3ad7960f9ece4d34ff6e108b64b6f957",
      "original_line" : 463,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 34,
      "pull_request_review_id" : 456989502,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-28T21:00:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/461871291",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462032894"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462032894"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in commit d60a16b\r\n\r\nIs there any reason to make this a global? This map gets populated in `PeerLogicValidation::InitializeNode`, which is called by connman. `PeerLogicValidation` keeps a pointer to this connman, so it would seem natural to me that it also keeps track of the peer map, e.g. in a (private) member.",
      "commit_id" : "3fa130da3ad7960f9ece4d34ff6e108b64b6f957",
      "created_at" : "2020-07-29T04:36:54Z",
      "diff_hunk" : "@@ -468,6 +468,44 @@ static CNodeState *State(NodeId pnode) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     return &it->second;\n }\n \n+/**\n+ * Data stucture for an individual peer. This struct is not protected by\n+ * cs_main since it does not contain validation-critical data.\n+ *\n+ * Memory is owned by shared pointers and this object is destructed when\n+ * the refcount drops to zero (in FinalizeNode()).\n+ *\n+ * TODO: move most members from CNodeState to this structure.\n+ * TODO: move remaining application-layer data members from CNode to this structure.\n+ */\n+struct Peer {\n+    /** Same id as the CNode object for this peer */\n+    NodeId m_id;\n+\n+    Peer(NodeId id) : m_id(id) {}\n+};\n+\n+using PeerRef = std::shared_ptr<Peer>;\n+\n+/**\n+ * Map of all Peer objects, keyed by peer id. This map is protected\n+ * by the global g_peer_mutex. Once a shared pointer reference is\n+ * taken, the lock may be released. Individual fields are protected by\n+ * their own locks.\n+ */\n+Mutex g_peer_mutex;\n+static std::map<NodeId, PeerRef> g_peer_map GUARDED_BY(g_peer_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462032894",
      "id" : 462032894,
      "line" : 495,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAzMjg5NA==",
      "original_commit_id" : "d60a16bb3f58fcb9422c277256b3c3a31cab3b2f",
      "original_line" : 497,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 66,
      "pull_request_review_id" : 457188186,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-29T04:36:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462032894",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462108444"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462108444"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This was mostly just following the convention of net_processing having its data stored in globals. I've had a look at what would be involved in moving `g_peer_map` and `GetPeer()` to be members of `PeerLogicValidation`. The main problem is that in future commits I want to be able to call `GetPeer()` from functions all across net_processing, and many of those aren't member functions of PLV. That means I'd need to either pass a reference to PLV down to those functions, or make them members of PLV.\r\n\r\nDoing that (and moving more of the state currently stored as globals into PLV) seems like a reasonable thing to do, but feels a bit separate from the immediate goal of moving data into `Peer` so I'm inclined to leave it for later. What do you think?",
      "commit_id" : "3fa130da3ad7960f9ece4d34ff6e108b64b6f957",
      "created_at" : "2020-07-29T07:54:07Z",
      "diff_hunk" : "@@ -468,6 +468,44 @@ static CNodeState *State(NodeId pnode) EXCLUSIVE_LOCKS_REQUIRED(cs_main) {\n     return &it->second;\n }\n \n+/**\n+ * Data stucture for an individual peer. This struct is not protected by\n+ * cs_main since it does not contain validation-critical data.\n+ *\n+ * Memory is owned by shared pointers and this object is destructed when\n+ * the refcount drops to zero (in FinalizeNode()).\n+ *\n+ * TODO: move most members from CNodeState to this structure.\n+ * TODO: move remaining application-layer data members from CNode to this structure.\n+ */\n+struct Peer {\n+    /** Same id as the CNode object for this peer */\n+    NodeId m_id;\n+\n+    Peer(NodeId id) : m_id(id) {}\n+};\n+\n+using PeerRef = std::shared_ptr<Peer>;\n+\n+/**\n+ * Map of all Peer objects, keyed by peer id. This map is protected\n+ * by the global g_peer_mutex. Once a shared pointer reference is\n+ * taken, the lock may be released. Individual fields are protected by\n+ * their own locks.\n+ */\n+Mutex g_peer_mutex;\n+static std::map<NodeId, PeerRef> g_peer_map GUARDED_BY(g_peer_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462108444",
      "id" : 462108444,
      "in_reply_to_id" : 462032894,
      "line" : 495,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjEwODQ0NA==",
      "original_commit_id" : "d60a16bb3f58fcb9422c277256b3c3a31cab3b2f",
      "original_line" : 497,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 66,
      "pull_request_review_id" : 457278769,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19607",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-29T07:54:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/462108444",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   }
]
