[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Added a trivial commit which de-duplicates some duplicated `for`-loops.",
      "created_at" : "2020-07-31T18:42:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19630#issuecomment-667294602",
      "id" : 667294602,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19630",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2NzI5NDYwMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-31T18:42:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/667294602",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19630#discussion_r466549930"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19630"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466549930"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Any idea why these numbers changed but not the associated time period?",
      "commit_id" : "6963cecbf87452663d3b25fe3b4c90f57fde1b11",
      "created_at" : "2020-08-06T16:52:42Z",
      "diff_hunk" : "@@ -138,9 +138,9 @@ class CBlockPolicyEstimator\n \n     /** Decay of .962 is a half-life of 18 blocks or about 3 hours */\n     static constexpr double SHORT_DECAY = .962;\n-    /** Decay of .998 is a half-life of 144 blocks or about 1 day */\n+    /** Decay of .9952 is a half-life of 144 blocks or about 1 day */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19630#discussion_r466549930",
      "id" : 466549930,
      "line" : 141,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU0OTkzMA==",
      "original_commit_id" : "7f61299da7330f2ebb991acecc12a30da16106ef",
      "original_line" : 141,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/policy/fees.h",
      "position" : 5,
      "pull_request_review_id" : 462698497,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19630",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-06T17:24:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466549930",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19630#discussion_r466551042"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19630"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466551042"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I personally prefer the old formulation here, with multiple lines instead of the multiple-ary `=`",
      "commit_id" : "6963cecbf87452663d3b25fe3b4c90f57fde1b11",
      "created_at" : "2020-08-06T16:54:32Z",
      "diff_hunk" : "@@ -172,68 +166,59 @@ void TxConfirmStats::resizeInMemoryCounters(size_t newbuckets) {\n void TxConfirmStats::ClearCurrent(unsigned int nBlockHeight)\n {\n     for (unsigned int j = 0; j < buckets.size(); j++) {\n-        oldUnconfTxs[j] += unconfTxs[nBlockHeight%unconfTxs.size()][j];\n+        oldUnconfTxs[j] += unconfTxs[nBlockHeight % unconfTxs.size()][j];\n         unconfTxs[nBlockHeight%unconfTxs.size()][j] = 0;\n     }\n }\n \n \n-void TxConfirmStats::Record(int blocksToConfirm, double val)\n+void TxConfirmStats::Record(int blocksToConfirm, double feerate)\n {\n     // blocksToConfirm is 1-based\n     if (blocksToConfirm < 1)\n         return;\n-    int periodsToConfirm = (blocksToConfirm + scale - 1)/scale;\n-    unsigned int bucketindex = bucketMap.lower_bound(val)->second;\n+    int periodsToConfirm = (blocksToConfirm + scale - 1) / scale;\n+    unsigned int bucketindex = bucketMap.lower_bound(feerate)->second;\n     for (size_t i = periodsToConfirm; i <= confAvg.size(); i++) {\n         confAvg[i - 1][bucketindex]++;\n     }\n     txCtAvg[bucketindex]++;\n-    avg[bucketindex] += val;\n+    feerate_avg[bucketindex] += feerate;\n }\n \n void TxConfirmStats::UpdateMovingAverages()\n {\n+    assert(confAvg.size() == failAvg.size());\n     for (unsigned int j = 0; j < buckets.size(); j++) {\n-        for (unsigned int i = 0; i < confAvg.size(); i++)\n-            confAvg[i][j] = confAvg[i][j] * decay;\n-        for (unsigned int i = 0; i < failAvg.size(); i++)\n-            failAvg[i][j] = failAvg[i][j] * decay;\n-        avg[j] = avg[j] * decay;\n-        txCtAvg[j] = txCtAvg[j] * decay;\n+        for (unsigned int i = 0; i < confAvg.size(); i++) {\n+            confAvg[i][j] *= decay;\n+            failAvg[i][j] *= decay;\n+        }\n+        feerate_avg[j] *= decay;\n+        txCtAvg[j] *= decay;\n     }\n }\n \n // returns -1 on error conditions\n double TxConfirmStats::EstimateMedianVal(int confTarget, double sufficientTxVal,\n-                                         double successBreakPoint, bool requireGreater,\n-                                         unsigned int nBlockHeight, EstimationResult *result) const\n+                                         double successBreakPoint, unsigned int nBlockHeight,\n+                                         EstimationResult *result) const\n {\n     // Counters for a bucket (or range of buckets)\n     double nConf = 0; // Number of tx's confirmed within the confTarget\n     double totalNum = 0; // Total number of tx's that were ever confirmed\n     int extraNum = 0;  // Number of tx's still in mempool for confTarget or longer\n     double failNum = 0; // Number of tx's that were never confirmed but removed from the mempool after confTarget\n-    int periodTarget = (confTarget + scale - 1)/scale;\n-\n+    int periodTarget = (confTarget + scale - 1) / scale;\n     int maxbucketindex = buckets.size() - 1;\n \n-    // requireGreater means we are looking for the lowest feerate such that all higher\n-    // values pass, so we start at maxbucketindex (highest feerate) and look at successively\n-    // smaller buckets until we reach failure.  Otherwise, we are looking for the highest\n-    // feerate such that all lower values fail, and we go in the opposite direction.\n-    unsigned int startbucket = requireGreater ? maxbucketindex : 0;\n-    int step = requireGreater ? -1 : 1;\n-\n     // We'll combine buckets until we have enough samples.\n     // The near and far variables will define the range we've combined\n     // The best variables are the last range we saw which still had a high\n     // enough confirmation rate to count as success.\n     // The cur variables are the current range we're counting.\n-    unsigned int curNearBucket = startbucket;\n-    unsigned int bestNearBucket = startbucket;\n-    unsigned int curFarBucket = startbucket;\n-    unsigned int bestFarBucket = startbucket;\n+    unsigned int curNearBucket, bestNearBucket, curFarBucket, bestFarBucket;\n+    curNearBucket = bestNearBucket = curFarBucket = bestFarBucket = maxbucketindex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19630#discussion_r466551042",
      "id" : 466551042,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU1MTA0Mg==",
      "original_commit_id" : "7f61299da7330f2ebb991acecc12a30da16106ef",
      "original_line" : 221,
      "original_position" : 131,
      "original_start_line" : null,
      "path" : "src/policy/fees.cpp",
      "position" : null,
      "pull_request_review_id" : 462699925,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19630",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-06T17:24:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466551042",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19630#discussion_r466552665"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19630"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466552665"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Nice catch that the `requireGreater` argument is unused",
      "commit_id" : "6963cecbf87452663d3b25fe3b4c90f57fde1b11",
      "created_at" : "2020-08-06T16:57:18Z",
      "diff_hunk" : "@@ -172,68 +166,59 @@ void TxConfirmStats::resizeInMemoryCounters(size_t newbuckets) {\n void TxConfirmStats::ClearCurrent(unsigned int nBlockHeight)\n {\n     for (unsigned int j = 0; j < buckets.size(); j++) {\n-        oldUnconfTxs[j] += unconfTxs[nBlockHeight%unconfTxs.size()][j];\n+        oldUnconfTxs[j] += unconfTxs[nBlockHeight % unconfTxs.size()][j];\n         unconfTxs[nBlockHeight%unconfTxs.size()][j] = 0;\n     }\n }\n \n \n-void TxConfirmStats::Record(int blocksToConfirm, double val)\n+void TxConfirmStats::Record(int blocksToConfirm, double feerate)\n {\n     // blocksToConfirm is 1-based\n     if (blocksToConfirm < 1)\n         return;\n-    int periodsToConfirm = (blocksToConfirm + scale - 1)/scale;\n-    unsigned int bucketindex = bucketMap.lower_bound(val)->second;\n+    int periodsToConfirm = (blocksToConfirm + scale - 1) / scale;\n+    unsigned int bucketindex = bucketMap.lower_bound(feerate)->second;\n     for (size_t i = periodsToConfirm; i <= confAvg.size(); i++) {\n         confAvg[i - 1][bucketindex]++;\n     }\n     txCtAvg[bucketindex]++;\n-    avg[bucketindex] += val;\n+    feerate_avg[bucketindex] += feerate;\n }\n \n void TxConfirmStats::UpdateMovingAverages()\n {\n+    assert(confAvg.size() == failAvg.size());\n     for (unsigned int j = 0; j < buckets.size(); j++) {\n-        for (unsigned int i = 0; i < confAvg.size(); i++)\n-            confAvg[i][j] = confAvg[i][j] * decay;\n-        for (unsigned int i = 0; i < failAvg.size(); i++)\n-            failAvg[i][j] = failAvg[i][j] * decay;\n-        avg[j] = avg[j] * decay;\n-        txCtAvg[j] = txCtAvg[j] * decay;\n+        for (unsigned int i = 0; i < confAvg.size(); i++) {\n+            confAvg[i][j] *= decay;\n+            failAvg[i][j] *= decay;\n+        }\n+        feerate_avg[j] *= decay;\n+        txCtAvg[j] *= decay;\n     }\n }\n \n // returns -1 on error conditions\n double TxConfirmStats::EstimateMedianVal(int confTarget, double sufficientTxVal,\n-                                         double successBreakPoint, bool requireGreater,\n-                                         unsigned int nBlockHeight, EstimationResult *result) const\n+                                         double successBreakPoint, unsigned int nBlockHeight,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19630#discussion_r466552665",
      "id" : 466552665,
      "line" : 204,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU1MjY2NQ==",
      "original_commit_id" : "7f61299da7330f2ebb991acecc12a30da16106ef",
      "original_line" : 204,
      "original_position" : 101,
      "original_start_line" : null,
      "path" : "src/policy/fees.cpp",
      "position" : 101,
      "pull_request_review_id" : 462702023,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19630",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-06T17:24:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466552665",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19630#discussion_r466553077"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19630"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466553077"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe use `--bucket`, pre-in/decrement iis the standard in this project.",
      "commit_id" : "6963cecbf87452663d3b25fe3b4c90f57fde1b11",
      "created_at" : "2020-08-06T16:58:02Z",
      "diff_hunk" : "@@ -242,8 +227,8 @@ double TxConfirmStats::EstimateMedianVal(int confTarget, double sufficientTxVal,\n     EstimatorBucket passBucket;\n     EstimatorBucket failBucket;\n \n-    // Start counting from highest(default) or lowest feerate transactions\n-    for (int bucket = startbucket; bucket >= 0 && bucket <= maxbucketindex; bucket += step) {\n+    // Start counting from highest feerate transactions\n+    for (int bucket = maxbucketindex; bucket >= 0; bucket--) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19630#discussion_r466553077",
      "id" : 466553077,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU1MzA3Nw==",
      "original_commit_id" : "7f61299da7330f2ebb991acecc12a30da16106ef",
      "original_line" : 231,
      "original_position" : 142,
      "original_start_line" : null,
      "path" : "src/policy/fees.cpp",
      "position" : null,
      "pull_request_review_id" : 462702572,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19630",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-06T17:24:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466553077",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19630#discussion_r466553413"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19630"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466553413"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah, the comment was wrong and I think morcos fixed the value but forgot about the comment. The comment change happened in this commit https://github.com/bitcoin/bitcoin/commit/b649e0395464a659f4b3485ec71d28dc95ba48bd , and the variable it refers to no longer exists. ",
      "commit_id" : "6963cecbf87452663d3b25fe3b4c90f57fde1b11",
      "created_at" : "2020-08-06T16:58:36Z",
      "diff_hunk" : "@@ -138,9 +138,9 @@ class CBlockPolicyEstimator\n \n     /** Decay of .962 is a half-life of 18 blocks or about 3 hours */\n     static constexpr double SHORT_DECAY = .962;\n-    /** Decay of .998 is a half-life of 144 blocks or about 1 day */\n+    /** Decay of .9952 is a half-life of 144 blocks or about 1 day */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19630#discussion_r466553413",
      "id" : 466553413,
      "in_reply_to_id" : 466549930,
      "line" : 141,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU1MzQxMw==",
      "original_commit_id" : "7f61299da7330f2ebb991acecc12a30da16106ef",
      "original_line" : 141,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/policy/fees.h",
      "position" : 5,
      "pull_request_review_id" : 462703004,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19630",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-06T17:24:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466553413",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19630#discussion_r466553933"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19630"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466553933"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ok",
      "commit_id" : "6963cecbf87452663d3b25fe3b4c90f57fde1b11",
      "created_at" : "2020-08-06T16:59:32Z",
      "diff_hunk" : "@@ -242,8 +227,8 @@ double TxConfirmStats::EstimateMedianVal(int confTarget, double sufficientTxVal,\n     EstimatorBucket passBucket;\n     EstimatorBucket failBucket;\n \n-    // Start counting from highest(default) or lowest feerate transactions\n-    for (int bucket = startbucket; bucket >= 0 && bucket <= maxbucketindex; bucket += step) {\n+    // Start counting from highest feerate transactions\n+    for (int bucket = maxbucketindex; bucket >= 0; bucket--) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19630#discussion_r466553933",
      "id" : 466553933,
      "in_reply_to_id" : 466553077,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU1MzkzMw==",
      "original_commit_id" : "7f61299da7330f2ebb991acecc12a30da16106ef",
      "original_line" : 231,
      "original_position" : 142,
      "original_start_line" : null,
      "path" : "src/policy/fees.cpp",
      "position" : null,
      "pull_request_review_id" : 462703664,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19630",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-06T17:24:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466553933",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19630#discussion_r466556072"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19630"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466556072"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Changed",
      "commit_id" : "6963cecbf87452663d3b25fe3b4c90f57fde1b11",
      "created_at" : "2020-08-06T17:03:28Z",
      "diff_hunk" : "@@ -172,68 +166,59 @@ void TxConfirmStats::resizeInMemoryCounters(size_t newbuckets) {\n void TxConfirmStats::ClearCurrent(unsigned int nBlockHeight)\n {\n     for (unsigned int j = 0; j < buckets.size(); j++) {\n-        oldUnconfTxs[j] += unconfTxs[nBlockHeight%unconfTxs.size()][j];\n+        oldUnconfTxs[j] += unconfTxs[nBlockHeight % unconfTxs.size()][j];\n         unconfTxs[nBlockHeight%unconfTxs.size()][j] = 0;\n     }\n }\n \n \n-void TxConfirmStats::Record(int blocksToConfirm, double val)\n+void TxConfirmStats::Record(int blocksToConfirm, double feerate)\n {\n     // blocksToConfirm is 1-based\n     if (blocksToConfirm < 1)\n         return;\n-    int periodsToConfirm = (blocksToConfirm + scale - 1)/scale;\n-    unsigned int bucketindex = bucketMap.lower_bound(val)->second;\n+    int periodsToConfirm = (blocksToConfirm + scale - 1) / scale;\n+    unsigned int bucketindex = bucketMap.lower_bound(feerate)->second;\n     for (size_t i = periodsToConfirm; i <= confAvg.size(); i++) {\n         confAvg[i - 1][bucketindex]++;\n     }\n     txCtAvg[bucketindex]++;\n-    avg[bucketindex] += val;\n+    feerate_avg[bucketindex] += feerate;\n }\n \n void TxConfirmStats::UpdateMovingAverages()\n {\n+    assert(confAvg.size() == failAvg.size());\n     for (unsigned int j = 0; j < buckets.size(); j++) {\n-        for (unsigned int i = 0; i < confAvg.size(); i++)\n-            confAvg[i][j] = confAvg[i][j] * decay;\n-        for (unsigned int i = 0; i < failAvg.size(); i++)\n-            failAvg[i][j] = failAvg[i][j] * decay;\n-        avg[j] = avg[j] * decay;\n-        txCtAvg[j] = txCtAvg[j] * decay;\n+        for (unsigned int i = 0; i < confAvg.size(); i++) {\n+            confAvg[i][j] *= decay;\n+            failAvg[i][j] *= decay;\n+        }\n+        feerate_avg[j] *= decay;\n+        txCtAvg[j] *= decay;\n     }\n }\n \n // returns -1 on error conditions\n double TxConfirmStats::EstimateMedianVal(int confTarget, double sufficientTxVal,\n-                                         double successBreakPoint, bool requireGreater,\n-                                         unsigned int nBlockHeight, EstimationResult *result) const\n+                                         double successBreakPoint, unsigned int nBlockHeight,\n+                                         EstimationResult *result) const\n {\n     // Counters for a bucket (or range of buckets)\n     double nConf = 0; // Number of tx's confirmed within the confTarget\n     double totalNum = 0; // Total number of tx's that were ever confirmed\n     int extraNum = 0;  // Number of tx's still in mempool for confTarget or longer\n     double failNum = 0; // Number of tx's that were never confirmed but removed from the mempool after confTarget\n-    int periodTarget = (confTarget + scale - 1)/scale;\n-\n+    int periodTarget = (confTarget + scale - 1) / scale;\n     int maxbucketindex = buckets.size() - 1;\n \n-    // requireGreater means we are looking for the lowest feerate such that all higher\n-    // values pass, so we start at maxbucketindex (highest feerate) and look at successively\n-    // smaller buckets until we reach failure.  Otherwise, we are looking for the highest\n-    // feerate such that all lower values fail, and we go in the opposite direction.\n-    unsigned int startbucket = requireGreater ? maxbucketindex : 0;\n-    int step = requireGreater ? -1 : 1;\n-\n     // We'll combine buckets until we have enough samples.\n     // The near and far variables will define the range we've combined\n     // The best variables are the last range we saw which still had a high\n     // enough confirmation rate to count as success.\n     // The cur variables are the current range we're counting.\n-    unsigned int curNearBucket = startbucket;\n-    unsigned int bestNearBucket = startbucket;\n-    unsigned int curFarBucket = startbucket;\n-    unsigned int bestFarBucket = startbucket;\n+    unsigned int curNearBucket, bestNearBucket, curFarBucket, bestFarBucket;\n+    curNearBucket = bestNearBucket = curFarBucket = bestFarBucket = maxbucketindex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19630#discussion_r466556072",
      "id" : 466556072,
      "in_reply_to_id" : 466551042,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU1NjA3Mg==",
      "original_commit_id" : "7f61299da7330f2ebb991acecc12a30da16106ef",
      "original_line" : 221,
      "original_position" : 131,
      "original_start_line" : null,
      "path" : "src/policy/fees.cpp",
      "position" : null,
      "pull_request_review_id" : 462706523,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19630",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-06T17:24:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466556072",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19630#discussion_r466557764"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19630"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466557764"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oh I see, the bucket size was changed, thanks.",
      "commit_id" : "6963cecbf87452663d3b25fe3b4c90f57fde1b11",
      "created_at" : "2020-08-06T17:06:30Z",
      "diff_hunk" : "@@ -138,9 +138,9 @@ class CBlockPolicyEstimator\n \n     /** Decay of .962 is a half-life of 18 blocks or about 3 hours */\n     static constexpr double SHORT_DECAY = .962;\n-    /** Decay of .998 is a half-life of 144 blocks or about 1 day */\n+    /** Decay of .9952 is a half-life of 144 blocks or about 1 day */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19630#discussion_r466557764",
      "id" : 466557764,
      "in_reply_to_id" : 466549930,
      "line" : 141,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU1Nzc2NA==",
      "original_commit_id" : "7f61299da7330f2ebb991acecc12a30da16106ef",
      "original_line" : 141,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/policy/fees.h",
      "position" : 5,
      "pull_request_review_id" : 462708709,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19630",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-08-06T17:24:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466557764",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Code review ACK besides some minor nits",
      "created_at" : "2020-08-06T17:07:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19630#issuecomment-670057638",
      "id" : 670057638,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19630",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3MDA1NzYzOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-06T17:07:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/670057638",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Amended after review (the unnecessary variables declaration move and the pre-decrement).",
      "created_at" : "2020-08-06T17:15:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19630#issuecomment-670062373",
      "id" : 670062373,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19630",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3MDA2MjM3Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-06T17:15:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/670062373",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "FYI it looks the last usage of requireGreater=false went away in b2322e0fc6def0baf8581bbd2f4135e61c47d142",
      "created_at" : "2020-08-06T17:20:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19630#issuecomment-670065158",
      "id" : 670065158,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19630",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3MDA2NTE1OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-06T17:20:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/670065158",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   }
]
