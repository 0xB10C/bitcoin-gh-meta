[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16577#discussion_r312697097"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16577"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312697097"
         }
      },
      "author_association" : "MEMBER",
      "body" : "NACK this hunk, it only changes formatting.",
      "commit_id" : "269efa10d116ddeb8aca779d690f8a3f34041aff",
      "created_at" : "2019-08-10T09:26:34Z",
      "diff_hunk" : "@@ -734,17 +734,21 @@ class CBufferedFile\n             return false;\n         size_t nBytes = fread((void*)&vchBuf[pos], 1, readNow, src);\n         if (nBytes == 0) {\n-            throw std::ios_base::failure(feof(src) ? \"CBufferedFile::Fill: end of file\" : \"CBufferedFile::Fill: fread failed\");\n-        } else {\n-            nSrcPos += nBytes;\n-            return true;\n+            throw std::ios_base::failure(feof(src) ?",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16577#discussion_r312697097",
      "id" : 312697097,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMjY5NzA5Nw==",
      "original_commit_id" : "b1aee230574a7eb72ca5101458fc9ef4a957d626",
      "original_position" : 8,
      "path" : "src/streams.h",
      "position" : null,
      "pull_request_review_id" : 273418979,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16577",
      "updated_at" : "2019-08-12T05:58:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312697097",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16577#discussion_r312697122"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16577"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312697122"
         }
      },
      "author_association" : "MEMBER",
      "body" : "NACK this hunk, only splits the line in 2 lines.",
      "commit_id" : "269efa10d116ddeb8aca779d690f8a3f34041aff",
      "created_at" : "2019-08-10T09:27:36Z",
      "diff_hunk" : "@@ -734,17 +734,21 @@ class CBufferedFile\n             return false;\n         size_t nBytes = fread((void*)&vchBuf[pos], 1, readNow, src);\n         if (nBytes == 0) {\n-            throw std::ios_base::failure(feof(src) ? \"CBufferedFile::Fill: end of file\" : \"CBufferedFile::Fill: fread failed\");\n-        } else {\n-            nSrcPos += nBytes;\n-            return true;\n+            throw std::ios_base::failure(feof(src) ?\n+                \"CBufferedFile::Fill: end of file\" :\n+                \"CBufferedFile::Fill: fread failed\");\n         }\n+        nSrcPos += nBytes;\n+        return true;\n     }\n \n public:\n     CBufferedFile(FILE *fileIn, uint64_t nBufSize, uint64_t nRewindIn, int nTypeIn, int nVersionIn) :\n-        nType(nTypeIn), nVersion(nVersionIn), nSrcPos(0), nReadPos(0), nReadLimit(std::numeric_limits<uint64_t>::max()), nRewind(nRewindIn), vchBuf(nBufSize, 0)\n+        nType(nTypeIn), nVersion(nVersionIn), nSrcPos(0), nReadPos(0),\n+        nReadLimit(std::numeric_limits<uint64_t>::max()), nRewind(nRewindIn), vchBuf(nBufSize, 0)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16577#discussion_r312697122",
      "id" : 312697122,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMjY5NzEyMg==",
      "original_commit_id" : "b1aee230574a7eb72ca5101458fc9ef4a957d626",
      "original_position" : 20,
      "path" : "src/streams.h",
      "position" : null,
      "pull_request_review_id" : 273418979,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16577",
      "updated_at" : "2019-08-12T05:58:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312697122",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16577#discussion_r312697302"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16577"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312697302"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'd keep `else`s.",
      "commit_id" : "269efa10d116ddeb8aca779d690f8a3f34041aff",
      "created_at" : "2019-08-10T09:35:07Z",
      "diff_hunk" : "@@ -802,16 +804,19 @@ class CBufferedFile\n \n     //! rewind to a given reading position\n     bool SetPos(uint64_t nPos) {\n-        nReadPos = nPos;\n-        if (nReadPos + nRewind < nSrcPos) {\n-            nReadPos = nSrcPos - nRewind;\n+        size_t bufsize = vchBuf.size();\n+        if (nSrcPos > bufsize && nPos < nSrcPos - bufsize) {\n+            // rewinding too far, rewind as far as possible\n+            nReadPos = nSrcPos - bufsize;\n             return false;\n-        } else if (nReadPos > nSrcPos) {\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16577#discussion_r312697302",
      "id" : 312697302,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMjY5NzMwMg==",
      "original_commit_id" : "b1aee230574a7eb72ca5101458fc9ef4a957d626",
      "original_position" : 49,
      "path" : "src/streams.h",
      "position" : null,
      "pull_request_review_id" : 273418979,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16577",
      "updated_at" : "2019-08-12T05:58:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312697302",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16577#discussion_r312697551"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16577"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312697551"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this is wrong, `vchBuf.size()` if constant and the actual read position is obtained from `nReadPos % vchBuf.size()` - it's a ring buffer.",
      "commit_id" : "269efa10d116ddeb8aca779d690f8a3f34041aff",
      "created_at" : "2019-08-10T09:44:54Z",
      "diff_hunk" : "@@ -802,16 +804,19 @@ class CBufferedFile\n \n     //! rewind to a given reading position\n     bool SetPos(uint64_t nPos) {\n-        nReadPos = nPos;\n-        if (nReadPos + nRewind < nSrcPos) {\n-            nReadPos = nSrcPos - nRewind;\n+        size_t bufsize = vchBuf.size();\n+        if (nSrcPos > bufsize && nPos < nSrcPos - bufsize) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16577#discussion_r312697551",
      "id" : 312697551,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMjY5NzU1MQ==",
      "original_commit_id" : "b1aee230574a7eb72ca5101458fc9ef4a957d626",
      "original_position" : 44,
      "path" : "src/streams.h",
      "position" : null,
      "pull_request_review_id" : 273418979,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16577",
      "updated_at" : "2019-08-12T05:58:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312697551",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16577#discussion_r312790825"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16577"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312790825"
         }
      },
      "author_association" : "NONE",
      "body" : "I checked this carefully, and I'm pretty sure it's right, please check again. I did simplify it slightly (without changing the logic) in the second commit; it's now like this:\r\n```\r\nif (nPos + bufsize < nSrcPos) {\r\n```\r\nThis says that the distance from the new (requested) read position, `nPos`, to the source pointer, `nSrcPos` must be no greater than `bufsize`. If `nPos` is further back than that, it will be pointing to bytes from a _later_ write pass across the buffer and will get data that's too new. Maybe a small example will help. Suppose the file consists of `a b c d e f g ...` and the buffer is 5 bytes. After reading `g` (total of 7 bytes) from the file into the ring buffer, the buffer looks like this:\r\n```\r\n[ f g c d e ]\r\n      ^\r\n      nSrcPos = 7\r\n```\r\nThe `nReadPos` (file read position) can be in the range 2 through 7 and we will get correct data. If `nReadPos` is _less_ than 2, let's say it's 1, then reading at that position should return `b` but will instead will return `g`, which is incorrect (`g` is too new). The smallest `nReadPos` can be is 2, which is 7 - 5 (`nSrcPos` - `bufsize`).\r\n\r\nThe existing `SetPos()` is wrong, `nRewind` has nothing to do with this. That variable is only needed during filling, and prevents `nSrcPos` from getting too far ahead of `nReadPos`, because if that happens, then `nReadPos` can't back up. So, in this little example,  if `nRewind` is 2, then `Fill()` will not let `nSrcPos` to get more than 5 (buffer size - rewind size) ahead of `nReadPos`. But, again, `nRewind` has no relevance to `SetPos()`.",
      "commit_id" : "269efa10d116ddeb8aca779d690f8a3f34041aff",
      "created_at" : "2019-08-12T06:32:32Z",
      "diff_hunk" : "@@ -802,16 +804,19 @@ class CBufferedFile\n \n     //! rewind to a given reading position\n     bool SetPos(uint64_t nPos) {\n-        nReadPos = nPos;\n-        if (nReadPos + nRewind < nSrcPos) {\n-            nReadPos = nSrcPos - nRewind;\n+        size_t bufsize = vchBuf.size();\n+        if (nSrcPos > bufsize && nPos < nSrcPos - bufsize) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16577#discussion_r312790825",
      "id" : 312790825,
      "in_reply_to_id" : 312697551,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMjc5MDgyNQ==",
      "original_commit_id" : "b1aee230574a7eb72ca5101458fc9ef4a957d626",
      "original_position" : 44,
      "path" : "src/streams.h",
      "position" : null,
      "pull_request_review_id" : 273523795,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16577",
      "updated_at" : "2019-08-12T06:32:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312790825",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "The second commit also adds a randomized test. It's pretty common for the kind of code under scrutiny here (the `CBufferedFile` object) to have subtle off-by-one and boundary condition bugs. A functional unit test like the one in the first commit is good, but it's hard to be sure the test covers all possible strange conditions. A random test will try many weird things that no person would ever think of. \r\n\r\nI ran this random test several million iterations, which makes me extremely confident that the code under test is correct. Of course, whether the test code itself is correct is very crucial! So please review the test code, thanks.",
      "created_at" : "2019-08-12T06:39:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16577#issuecomment-520312788",
      "id" : 520312788,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16577",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyMDMxMjc4OA==",
      "updated_at" : "2019-08-12T06:39:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/520312788",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@LarryRuane I haven't looked at your changes yet but wanted to mention that you might want to check using `contrib/devtools/test_deterministic_coverage.sh` that the unit test is line coverage deterministic after this change.\r\n\r\nLine coverage determinism is a necessary condition for meaningful line coverage measuring :-)",
      "created_at" : "2019-08-12T12:11:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16577#issuecomment-520399374",
      "id" : 520399374,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16577",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyMDM5OTM3NA==",
      "updated_at" : "2019-08-12T12:11:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/520399374",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   }
]
