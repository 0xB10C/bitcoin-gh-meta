[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#25003](https://github.com/bitcoin/bitcoin/pull/25003) (tracing: fix `coin_selection:aps_create_tx_internal` calling logic by theStack)\n* [#24539](https://github.com/bitcoin/bitcoin/pull/24539) (Add a \"tx output spender\" index by sstone)\n* [#24410](https://github.com/bitcoin/bitcoin/pull/24410) ([kernel 2a/n] Split hashing/index `GetUTXOStats` codepaths, decouple from `coinstatsindex` by dongcarl)\n* [#24148](https://github.com/bitcoin/bitcoin/pull/24148) (Miniscript support in Output Descriptors by darosior)\n* [#23475](https://github.com/bitcoin/bitcoin/pull/23475) (wallet: add config to prioritize a solution that doesn't create change in coin selection by brunoerg)\n* [#23417](https://github.com/bitcoin/bitcoin/pull/23417) (wallet, spkm: Move key management from DescriptorScriptPubKeyMan to wallet level KeyManager by achow101)\n* [#22838](https://github.com/bitcoin/bitcoin/pull/22838) (descriptors: Be able to specify change and receiving in a single descriptor string by achow101)\n* [#22693](https://github.com/bitcoin/bitcoin/pull/22693) (RPC/Wallet: Add \"use_txids\" to output of getaddressinfo by luke-jr)\n* [#22341](https://github.com/bitcoin/bitcoin/pull/22341) (rpc: add getxpub by Sjors)\n* [#21928](https://github.com/bitcoin/bitcoin/pull/21928) (wallet: allow toggling external_signer flag by Sjors)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-04-17T04:48:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24897#issuecomment-1100803007",
      "id" : 1100803007,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24897",
      "node_id" : "IC_kwDOABII585BnOu_",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1100803007/reactions"
      },
      "updated_at" : "2022-05-22T13:13:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1100803007",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2022-04-18T01:54:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24897#issuecomment-1101019295",
      "id" : 1101019295,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24897",
      "node_id" : "IC_kwDOABII585BoDif",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1101019295/reactions"
      },
      "updated_at" : "2022-04-18T01:54:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1101019295",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/94559964?v=4",
         "events_url" : "https://api.github.com/users/1440000bytes/events{/privacy}",
         "followers_url" : "https://api.github.com/users/1440000bytes/followers",
         "following_url" : "https://api.github.com/users/1440000bytes/following{/other_user}",
         "gists_url" : "https://api.github.com/users/1440000bytes/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/1440000bytes",
         "id" : 94559964,
         "login" : "1440000bytes",
         "node_id" : "U_kgDOBaLe3A",
         "organizations_url" : "https://api.github.com/users/1440000bytes/orgs",
         "received_events_url" : "https://api.github.com/users/1440000bytes/received_events",
         "repos_url" : "https://api.github.com/users/1440000bytes/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/1440000bytes/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/1440000bytes/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/1440000bytes"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24897#discussion_r852141704"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24897"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852141704"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm just trying to understand the protocol better. This function is called \"create tweaked pubkey\" but what seems more significant about it to me is that it also provides the recipient with the private key they need to spend from the silent payment output. Is that correct?",
      "commit_id" : "b97fee2f445d396fdb62d4468c214320745519be",
      "created_at" : "2022-04-18T14:08:03Z",
      "diff_hunk" : "@@ -0,0 +1,115 @@\n+#include \"silentpayment.h\"\n+\n+#include <key_io.h>\n+#include <secp256k1.h>\n+#include <secp256k1_ecdh.h>\n+#include <secp256k1_extrakeys.h>\n+\n+namespace silentpayment {\n+\n+secp256k1_pubkey Sender::CreateTweakedPubkey(\n+    const secp256k1_context* ctx,\n+    const secp256k1_xonly_pubkey recipient_public_key,\n+    const unsigned char sender_secret_key[32])\n+{\n+    unsigned char shared_secret[32];\n+\n+    secp256k1_pubkey output_pubkey;\n+\n+    int return_val;\n+\n+    return_val = secp256k1_ecdh_xonly(ctx, shared_secret, &recipient_public_key, sender_secret_key, NULL, NULL);\n+    assert(return_val);\n+\n+    return_val = secp256k1_ec_seckey_verify(secp256k1_context_no_precomp, shared_secret);\n+    assert(return_val);\n+\n+    return_val = secp256k1_xonly_pubkey_tweak_add(ctx, &output_pubkey, &recipient_public_key, shared_secret);\n+    assert(return_val);\n+\n+    return output_pubkey;\n+}\n+\n+XOnlyPubKey Sender::CreateSilentPaymentAddress(\n+    const CKey& sender_secret_key,\n+    const XOnlyPubKey& _recipient_public_key)\n+{\n+    int return_val;\n+\n+    secp256k1_context* ctx = secp256k1_context_create(SECP256K1_CONTEXT_SIGN | SECP256K1_CONTEXT_VERIFY);\n+\n+    secp256k1_xonly_pubkey recipient_public_key;\n+    return_val = secp256k1_xonly_pubkey_parse(ctx, &recipient_public_key, _recipient_public_key.data());\n+    assert(return_val);\n+\n+    secp256k1_pubkey sender_output_pubkey;\n+    sender_output_pubkey = CreateTweakedPubkey(ctx, recipient_public_key, sender_secret_key.data());\n+\n+    // Test the key\n+    size_t len;\n+    unsigned char sender_serialized_output_pubkey[33];\n+    len = sizeof(sender_serialized_output_pubkey);\n+    return_val = secp256k1_ec_pubkey_serialize(ctx, sender_serialized_output_pubkey, &len, &sender_output_pubkey, SECP256K1_EC_COMPRESSED);\n+    assert(return_val);\n+\n+    CPubKey pubKey = CPubKey(sender_serialized_output_pubkey);\n+\n+    assert(pubKey.IsFullyValid());\n+\n+    XOnlyPubKey xOnlyPubKey = XOnlyPubKey(pubKey);\n+\n+    return xOnlyPubKey;\n+}\n+\n+void Recipient::CreateTweakedPubkey(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24897#discussion_r852141704",
      "id" : 852141704,
      "line" : 64,
      "node_id" : "PRRC_kwDOABII584yyqaI",
      "original_commit_id" : "b97fee2f445d396fdb62d4468c214320745519be",
      "original_line" : 64,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/wallet/silentpayment.cpp",
      "position" : 64,
      "pull_request_review_id" : 944439250,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24897",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852141704/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-18T14:08:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852141704",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2084648?v=4",
         "events_url" : "https://api.github.com/users/pinheadmz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pinheadmz/followers",
         "following_url" : "https://api.github.com/users/pinheadmz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pinheadmz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pinheadmz",
         "id" : 2084648,
         "login" : "pinheadmz",
         "node_id" : "MDQ6VXNlcjIwODQ2NDg=",
         "organizations_url" : "https://api.github.com/users/pinheadmz/orgs",
         "received_events_url" : "https://api.github.com/users/pinheadmz/received_events",
         "repos_url" : "https://api.github.com/users/pinheadmz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pinheadmz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pinheadmz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pinheadmz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24897#discussion_r852184789"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24897"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852184789"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes. I defined this name when using another approach, but that's the idea.\r\n\r\n`secp256k1_keypair_xonly_tweak_add` returns both the tweaked private and public keys in the `recipient_keypair` parameter. So the recipient can spend the output.",
      "commit_id" : "b97fee2f445d396fdb62d4468c214320745519be",
      "created_at" : "2022-04-18T15:10:11Z",
      "diff_hunk" : "@@ -0,0 +1,115 @@\n+#include \"silentpayment.h\"\n+\n+#include <key_io.h>\n+#include <secp256k1.h>\n+#include <secp256k1_ecdh.h>\n+#include <secp256k1_extrakeys.h>\n+\n+namespace silentpayment {\n+\n+secp256k1_pubkey Sender::CreateTweakedPubkey(\n+    const secp256k1_context* ctx,\n+    const secp256k1_xonly_pubkey recipient_public_key,\n+    const unsigned char sender_secret_key[32])\n+{\n+    unsigned char shared_secret[32];\n+\n+    secp256k1_pubkey output_pubkey;\n+\n+    int return_val;\n+\n+    return_val = secp256k1_ecdh_xonly(ctx, shared_secret, &recipient_public_key, sender_secret_key, NULL, NULL);\n+    assert(return_val);\n+\n+    return_val = secp256k1_ec_seckey_verify(secp256k1_context_no_precomp, shared_secret);\n+    assert(return_val);\n+\n+    return_val = secp256k1_xonly_pubkey_tweak_add(ctx, &output_pubkey, &recipient_public_key, shared_secret);\n+    assert(return_val);\n+\n+    return output_pubkey;\n+}\n+\n+XOnlyPubKey Sender::CreateSilentPaymentAddress(\n+    const CKey& sender_secret_key,\n+    const XOnlyPubKey& _recipient_public_key)\n+{\n+    int return_val;\n+\n+    secp256k1_context* ctx = secp256k1_context_create(SECP256K1_CONTEXT_SIGN | SECP256K1_CONTEXT_VERIFY);\n+\n+    secp256k1_xonly_pubkey recipient_public_key;\n+    return_val = secp256k1_xonly_pubkey_parse(ctx, &recipient_public_key, _recipient_public_key.data());\n+    assert(return_val);\n+\n+    secp256k1_pubkey sender_output_pubkey;\n+    sender_output_pubkey = CreateTweakedPubkey(ctx, recipient_public_key, sender_secret_key.data());\n+\n+    // Test the key\n+    size_t len;\n+    unsigned char sender_serialized_output_pubkey[33];\n+    len = sizeof(sender_serialized_output_pubkey);\n+    return_val = secp256k1_ec_pubkey_serialize(ctx, sender_serialized_output_pubkey, &len, &sender_output_pubkey, SECP256K1_EC_COMPRESSED);\n+    assert(return_val);\n+\n+    CPubKey pubKey = CPubKey(sender_serialized_output_pubkey);\n+\n+    assert(pubKey.IsFullyValid());\n+\n+    XOnlyPubKey xOnlyPubKey = XOnlyPubKey(pubKey);\n+\n+    return xOnlyPubKey;\n+}\n+\n+void Recipient::CreateTweakedPubkey(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24897#discussion_r852184789",
      "id" : 852184789,
      "in_reply_to_id" : 852141704,
      "line" : 64,
      "node_id" : "PRRC_kwDOABII584yy07V",
      "original_commit_id" : "b97fee2f445d396fdb62d4468c214320745519be",
      "original_line" : 64,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/wallet/silentpayment.cpp",
      "position" : 64,
      "pull_request_review_id" : 944500372,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24897",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852184789/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-18T15:11:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852184789",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/94266259?v=4",
         "events_url" : "https://api.github.com/users/w0xlt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/w0xlt/followers",
         "following_url" : "https://api.github.com/users/w0xlt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/w0xlt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/w0xlt",
         "id" : 94266259,
         "login" : "w0xlt",
         "node_id" : "U_kgDOBZ5jkw",
         "organizations_url" : "https://api.github.com/users/w0xlt/orgs",
         "received_events_url" : "https://api.github.com/users/w0xlt/received_events",
         "repos_url" : "https://api.github.com/users/w0xlt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/w0xlt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/w0xlt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/w0xlt"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-04-18T17:21:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24897#issuecomment-1101583051",
      "id" : 1101583051,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24897",
      "node_id" : "IC_kwDOABII585BqNLL",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1101583051/reactions"
      },
      "updated_at" : "2022-04-18T17:21:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1101583051",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Need some way to avoid users trying to send a silent payment to a wallet that doesn't support it... am I missing something?",
      "created_at" : "2022-04-19T19:06:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24897#issuecomment-1102990584",
      "id" : 1102990584,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24897",
      "node_id" : "IC_kwDOABII585Bvkz4",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1102990584/reactions"
      },
      "updated_at" : "2022-04-19T19:06:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1102990584",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@luke-jr Yes, it will need to be further discussed if this concept proves to be valid.\r\n\r\nIn this PR, all descriptor wallets support silent transactions as the `SILENT_PAYMENT` flag can be enabled or disabled at any time. The `rescanblockchain` RPC can be used to retrieve previous silent payments.\r\n\r\nAs only Taproot addresses can be used for silent payments and only descriptor wallets support Taproot, this may suffice, but it certainly needs further discussion.",
      "created_at" : "2022-04-20T07:12:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24897#issuecomment-1103548839",
      "id" : 1103548839,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24897",
      "node_id" : "IC_kwDOABII585BxtGn",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1103548839/reactions"
      },
      "updated_at" : "2022-04-20T07:26:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1103548839",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/94266259?v=4",
         "events_url" : "https://api.github.com/users/w0xlt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/w0xlt/followers",
         "following_url" : "https://api.github.com/users/w0xlt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/w0xlt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/w0xlt",
         "id" : 94266259,
         "login" : "w0xlt",
         "node_id" : "U_kgDOBZ5jkw",
         "organizations_url" : "https://api.github.com/users/w0xlt/orgs",
         "received_events_url" : "https://api.github.com/users/w0xlt/received_events",
         "repos_url" : "https://api.github.com/users/w0xlt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/w0xlt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/w0xlt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/w0xlt"
      }
   },
   {
      "author_association" : "NONE",
      "body" : ">Need some way to avoid users trying to send a silent payment to a wallet that doesn't support it\r\n\r\n@luke-jr When the recipient publishes their silent payment address, it needs to be clear that it is not a regular taproot address. The address format should be distinct. The tweaked silent payment address that is generated by the sender and is ultimately committed on-chain should be indistinguishable from a regular taproot output.\r\n\r\n>only Taproot addresses can be used for silent payments\r\n\r\n@w0xlt Note that nothing about the silent payment scheme is exclusive to taproot, but regardless I do think it's good to limit the specifications to creating taproot outputs only as it encourages taproot use and means transactions without taproot outputs (albeit hopefully rare in the eventual future) don't need to be scanned.",
      "created_at" : "2022-04-20T08:45:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24897#issuecomment-1103635123",
      "id" : 1103635123,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24897",
      "node_id" : "IC_kwDOABII585ByCKz",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1103635123/reactions"
      },
      "updated_at" : "2022-04-20T08:45:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1103635123",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/9066803?v=4",
         "events_url" : "https://api.github.com/users/RubenSomsen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/RubenSomsen/followers",
         "following_url" : "https://api.github.com/users/RubenSomsen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/RubenSomsen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/RubenSomsen",
         "id" : 9066803,
         "login" : "RubenSomsen",
         "node_id" : "MDQ6VXNlcjkwNjY4MDM=",
         "organizations_url" : "https://api.github.com/users/RubenSomsen/orgs",
         "received_events_url" : "https://api.github.com/users/RubenSomsen/received_events",
         "repos_url" : "https://api.github.com/users/RubenSomsen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/RubenSomsen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/RubenSomsen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/RubenSomsen"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : ">When the recipient publishes their silent payment address, it needs to be clear that it is not a regular taproot address. The address format should be distinct. \r\n\r\nBut I don't see that in this current spec/code?",
      "created_at" : "2022-04-20T18:00:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24897#issuecomment-1104252903",
      "id" : 1104252903,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24897",
      "node_id" : "IC_kwDOABII585B0Y_n",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1104252903/reactions"
      },
      "updated_at" : "2022-04-20T18:00:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1104252903",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-04-26T18:42:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24897#issuecomment-1110131074",
      "id" : 1110131074,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24897",
      "node_id" : "IC_kwDOABII585CK0GC",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1110131074/reactions"
      },
      "updated_at" : "2022-04-26T18:42:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1110131074",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Need some way to avoid users trying to send a silent payment to a wallet that doesn't support it... am I missing something?\r\n\r\nit's worse than that, AFAIU the address needs to support it not just the wallet -- E.g., what if the Tr key is a NUMS point?\r\n\r\nWorth making a new address type / format so that you never mix the two.",
      "created_at" : "2022-04-28T04:32:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24897#issuecomment-1111735167",
      "id" : 1111735167,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24897",
      "node_id" : "IC_kwDOABII585CQ7t_",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1111735167/reactions"
      },
      "updated_at" : "2022-04-28T04:32:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1111735167",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@luke-jr @JeremyRubin  Thanks for the comments. The current version deliberately does not implement a new address/descriptor format. This requires a separate discussion and changes in wallet behavior. And it doesn't make sense to start a discussion about it before the scheme proves itself valid in a viable time.\r\n\r\nCurrently the main focus is to validate the scheme and verify that the performance is viable.",
      "created_at" : "2022-05-16T18:54:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24897#issuecomment-1128022340",
      "id" : 1128022340,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24897",
      "node_id" : "IC_kwDOABII585DPEFE",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1128022340/reactions"
      },
      "updated_at" : "2022-05-16T18:54:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1128022340",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/94266259?v=4",
         "events_url" : "https://api.github.com/users/w0xlt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/w0xlt/followers",
         "following_url" : "https://api.github.com/users/w0xlt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/w0xlt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/w0xlt",
         "id" : 94266259,
         "login" : "w0xlt",
         "node_id" : "U_kgDOBZ5jkw",
         "organizations_url" : "https://api.github.com/users/w0xlt/orgs",
         "received_events_url" : "https://api.github.com/users/w0xlt/received_events",
         "repos_url" : "https://api.github.com/users/w0xlt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/w0xlt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/w0xlt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/w0xlt"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I created a short and simple tutorial on how to make silent payments on signet.\r\nhttps://gist.github.com/w0xlt/72390ded95dd797594f80baba5d2e6ee",
      "created_at" : "2022-05-16T18:55:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24897#issuecomment-1128022502",
      "id" : 1128022502,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24897",
      "node_id" : "IC_kwDOABII585DPEHm",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1128022502/reactions"
      },
      "updated_at" : "2022-05-16T18:57:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1128022502",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/94266259?v=4",
         "events_url" : "https://api.github.com/users/w0xlt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/w0xlt/followers",
         "following_url" : "https://api.github.com/users/w0xlt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/w0xlt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/w0xlt",
         "id" : 94266259,
         "login" : "w0xlt",
         "node_id" : "U_kgDOBZ5jkw",
         "organizations_url" : "https://api.github.com/users/w0xlt/orgs",
         "received_events_url" : "https://api.github.com/users/w0xlt/received_events",
         "repos_url" : "https://api.github.com/users/w0xlt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/w0xlt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/w0xlt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/w0xlt"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-05-17T12:06:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24897#issuecomment-1128785938",
      "id" : 1128785938,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24897",
      "node_id" : "IC_kwDOABII585DR-gS",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1128785938/reactions"
      },
      "updated_at" : "2022-05-17T12:06:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1128785938",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@w0xlt I am sorry if this is documented somewhere, but how do you determine which input carries the public key for ECDH?",
      "created_at" : "2022-05-23T16:47:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24897#issuecomment-1134907552",
      "id" : 1134907552,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24897",
      "node_id" : "IC_kwDOABII585DpVCg",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1134907552/reactions"
      },
      "updated_at" : "2022-05-23T16:47:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1134907552",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/42201?v=4",
         "events_url" : "https://api.github.com/users/prusnak/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prusnak/followers",
         "following_url" : "https://api.github.com/users/prusnak/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prusnak/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prusnak",
         "id" : 42201,
         "login" : "prusnak",
         "node_id" : "MDQ6VXNlcjQyMjAx",
         "organizations_url" : "https://api.github.com/users/prusnak/orgs",
         "received_events_url" : "https://api.github.com/users/prusnak/received_events",
         "repos_url" : "https://api.github.com/users/prusnak/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prusnak/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prusnak/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prusnak"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@prusnak It s not well documented as well as being discussed.\r\n\r\nIn the current implementation, for simplicity, [only the first input is used.](https://github.com/w0xlt/bitcoin/blob/8f616acf868bbc75b31bf5170c40fd9957c08e91/src/wallet/spend.cpp#L665)\r\n\r\nThere is a suggestion by @RubenSomsen  to use a hash of all inputs. This would make silent payments compatible with coinjoins.\r\n\r\nThis is a possibility of change if the current version proves viable, since there shouldn't be much difference in performance between the two versions.\r\n\r\nI posted some estimates [here](https://gist.github.com/RubenSomsen/c43b79517e7cb701ebf77eec6dbb46b8?permalink_comment_id=4172737#gistcomment-4172737).",
      "created_at" : "2022-05-23T23:36:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24897#issuecomment-1135241506",
      "id" : 1135241506,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24897",
      "node_id" : "IC_kwDOABII585Dqmki",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1135241506/reactions"
      },
      "updated_at" : "2022-05-23T23:43:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1135241506",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/94266259?v=4",
         "events_url" : "https://api.github.com/users/w0xlt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/w0xlt/followers",
         "following_url" : "https://api.github.com/users/w0xlt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/w0xlt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/w0xlt",
         "id" : 94266259,
         "login" : "w0xlt",
         "node_id" : "U_kgDOBZ5jkw",
         "organizations_url" : "https://api.github.com/users/w0xlt/orgs",
         "received_events_url" : "https://api.github.com/users/w0xlt/received_events",
         "repos_url" : "https://api.github.com/users/w0xlt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/w0xlt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/w0xlt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/w0xlt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24897#discussion_r880324746"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24897"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/880324746"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`warning:` comparison of integer expressions of different signedness: âstd::vector<unsigned char>::size_typeâ {aka âlong unsigned intâ} and âintâ [-Wsign-compare]",
      "commit_id" : "8f616acf868bbc75b31bf5170c40fd9957c08e91",
      "created_at" : "2022-05-24T10:15:12Z",
      "diff_hunk" : "@@ -0,0 +1,196 @@\n+#include <index/silentpaymentindex.h>\n+\n+#include <chainparams.h>\n+#include <coins.h>\n+#include <index/disktxpos.h>\n+#include <node/blockstorage.h>\n+#include <pubkey.h>\n+#include <undo.h>\n+#include <util/system.h>\n+#include <validation.h>\n+\n+using node::ReadBlockFromDisk;\n+using node::UndoReadFromDisk;\n+\n+constexpr uint8_t DB_SILENTPAYMENTINDEX{'s'};\n+\n+std::unique_ptr<SilentPaymentIndex> g_silentpaymentindex;\n+\n+/** Access to the silent payment index database (indexes/silentpaymentindex/) */\n+class SilentPaymentIndex::DB : public BaseIndex::DB\n+{\n+public:\n+    explicit DB(size_t n_cache_size, bool f_memory = false, bool f_wipe = false);\n+\n+    bool WriteSilentPayments(const std::vector<std::pair<uint256, uint256>>& items);\n+};\n+\n+SilentPaymentIndex::DB::DB(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    BaseIndex::DB(gArgs.GetDataDirNet() / \"indexes\" / \"silentpaymentindex\", n_cache_size, f_memory, f_wipe)\n+{}\n+\n+bool SilentPaymentIndex::DB::WriteSilentPayments(const std::vector<std::pair<uint256, uint256>>& items)\n+{\n+    CDBBatch batch(*this);\n+    for (const auto& tuple : items) {\n+        batch.Write(std::make_pair(DB_SILENTPAYMENTINDEX, tuple.first), tuple.second);\n+    }\n+    return WriteBatch(batch);\n+}\n+\n+SilentPaymentIndex::SilentPaymentIndex(size_t n_cache_size, bool f_memory, bool f_wipe)\n+    : m_db(std::make_unique<SilentPaymentIndex::DB>(n_cache_size, f_memory, f_wipe))\n+{}\n+\n+SilentPaymentIndex::~SilentPaymentIndex() {}\n+\n+bool SilentPaymentIndex::ExtractPubkeyFromInput(const Coin& prevCoin, const CTxIn& txin,  XOnlyPubKey& senderPubKey)\n+{\n+    // scriptPubKey being spent by this input\n+    CScript scriptPubKey = prevCoin.out.scriptPubKey;\n+\n+    if (scriptPubKey.IsPayToWitnessScriptHash()) {\n+        return false;\n+    }\n+\n+    // Vector of parsed pubkeys and hashes\n+    std::vector<std::vector<unsigned char>> solutions;\n+\n+    TxoutType whichType = Solver(scriptPubKey, solutions);\n+\n+    if (whichType == TxoutType::NONSTANDARD ||\n+    whichType == TxoutType::MULTISIG ||\n+    whichType == TxoutType::WITNESS_UNKNOWN ) {\n+        return false;\n+    }\n+\n+    const CScript scriptSig = txin.scriptSig;\n+    const CScriptWitness scriptWitness = txin.scriptWitness;\n+\n+    assert(senderPubKey.IsNull());\n+\n+    // TODO: Condition not tested\n+    if (whichType == TxoutType::PUBKEY) {\n+\n+        CPubKey pubkey = CPubKey(solutions[0]);\n+        assert(pubkey.IsFullyValid());\n+        senderPubKey = XOnlyPubKey(pubkey);\n+    }\n+\n+    else if (whichType == TxoutType::PUBKEYHASH) {\n+\n+        int sigSize = static_cast<int>(scriptSig[0]);\n+        int pubKeySize = static_cast<int>(scriptSig[sigSize + 1]);\n+        auto serializedPubKey = std::vector<unsigned char>(scriptSig.begin() + sigSize + 2, scriptSig.end());\n+        assert(serializedPubKey.size() == pubKeySize);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24897#discussion_r880324746",
      "id" : 880324746,
      "line" : 85,
      "node_id" : "PRRC_kwDOABII5840eLCK",
      "original_commit_id" : "8f616acf868bbc75b31bf5170c40fd9957c08e91",
      "original_line" : 85,
      "original_position" : 85,
      "original_start_line" : null,
      "path" : "src/index/silentpaymentindex.cpp",
      "position" : 85,
      "pull_request_review_id" : 982957038,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24897",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/880324746/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-24T10:15:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/880324746",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/94559964?v=4",
         "events_url" : "https://api.github.com/users/1440000bytes/events{/privacy}",
         "followers_url" : "https://api.github.com/users/1440000bytes/followers",
         "following_url" : "https://api.github.com/users/1440000bytes/following{/other_user}",
         "gists_url" : "https://api.github.com/users/1440000bytes/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/1440000bytes",
         "id" : 94559964,
         "login" : "1440000bytes",
         "node_id" : "U_kgDOBaLe3A",
         "organizations_url" : "https://api.github.com/users/1440000bytes/orgs",
         "received_events_url" : "https://api.github.com/users/1440000bytes/received_events",
         "repos_url" : "https://api.github.com/users/1440000bytes/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/1440000bytes/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/1440000bytes/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/1440000bytes"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-05-24T13:39:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24897#issuecomment-1135937189",
      "id" : 1135937189,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24897",
      "node_id" : "IC_kwDOABII585DtQal",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1135937189/reactions"
      },
      "updated_at" : "2022-05-24T13:39:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1135937189",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Huge Concept ACK.. \r\n\r\nThis is amazing.. ð¥ð¥ð¥ð¥",
      "created_at" : "2022-05-24T17:07:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24897#issuecomment-1136199154",
      "id" : 1136199154,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24897",
      "node_id" : "IC_kwDOABII585DuQXy",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1136199154/reactions"
      },
      "updated_at" : "2022-05-24T17:07:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1136199154",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/36541669?v=4",
         "events_url" : "https://api.github.com/users/rajarshimaitra/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rajarshimaitra/followers",
         "following_url" : "https://api.github.com/users/rajarshimaitra/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rajarshimaitra/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rajarshimaitra",
         "id" : 36541669,
         "login" : "rajarshimaitra",
         "node_id" : "MDQ6VXNlcjM2NTQxNjY5",
         "organizations_url" : "https://api.github.com/users/rajarshimaitra/orgs",
         "received_events_url" : "https://api.github.com/users/rajarshimaitra/received_events",
         "repos_url" : "https://api.github.com/users/rajarshimaitra/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rajarshimaitra/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rajarshimaitra/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rajarshimaitra"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "I followed the tutorial and it worked great on signet",
      "created_at" : "2022-05-26T00:12:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24897#issuecomment-1138004570",
      "id" : 1138004570,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24897",
      "node_id" : "IC_kwDOABII585D1JJa",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1138004570/reactions"
      },
      "updated_at" : "2022-05-26T00:12:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1138004570",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/207713?v=4",
         "events_url" : "https://api.github.com/users/a5an0/events{/privacy}",
         "followers_url" : "https://api.github.com/users/a5an0/followers",
         "following_url" : "https://api.github.com/users/a5an0/following{/other_user}",
         "gists_url" : "https://api.github.com/users/a5an0/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/a5an0",
         "id" : 207713,
         "login" : "a5an0",
         "node_id" : "MDQ6VXNlcjIwNzcxMw==",
         "organizations_url" : "https://api.github.com/users/a5an0/orgs",
         "received_events_url" : "https://api.github.com/users/a5an0/received_events",
         "repos_url" : "https://api.github.com/users/a5an0/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/a5an0/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/a5an0/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/a5an0"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2022-05-26T09:54:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24897#issuecomment-1138361638",
      "id" : 1138361638,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24897",
      "node_id" : "IC_kwDOABII585D2gUm",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1138361638/reactions"
      },
      "updated_at" : "2022-05-26T09:54:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1138361638",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4500994?v=4",
         "events_url" : "https://api.github.com/users/kristapsk/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kristapsk/followers",
         "following_url" : "https://api.github.com/users/kristapsk/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kristapsk/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kristapsk",
         "id" : 4500994,
         "login" : "kristapsk",
         "node_id" : "MDQ6VXNlcjQ1MDA5OTQ=",
         "organizations_url" : "https://api.github.com/users/kristapsk/orgs",
         "received_events_url" : "https://api.github.com/users/kristapsk/received_events",
         "repos_url" : "https://api.github.com/users/kristapsk/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kristapsk/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kristapsk/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kristapsk"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24897#discussion_r882514222"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24897"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/882514222"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Linter error:\r\n```\r\nPlease use bracket syntax includes (\"#include <foo.h>\") instead of quote syntax includes:\r\nsrc/wallet/silentpayment.cpp:#include \"silentpayment.h\"\r\n^---- failure generated from lint-includes.py\r\n```",
      "commit_id" : "8f616acf868bbc75b31bf5170c40fd9957c08e91",
      "created_at" : "2022-05-26T10:01:30Z",
      "diff_hunk" : "@@ -0,0 +1,115 @@\n+#include \"silentpayment.h\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24897#discussion_r882514222",
      "id" : 882514222,
      "line" : 1,
      "node_id" : "PRRC_kwDOABII5840mhku",
      "original_commit_id" : "8f616acf868bbc75b31bf5170c40fd9957c08e91",
      "original_line" : 1,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/wallet/silentpayment.cpp",
      "position" : 1,
      "pull_request_review_id" : 985996807,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24897",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/882514222/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-26T11:06:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/882514222",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4500994?v=4",
         "events_url" : "https://api.github.com/users/kristapsk/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kristapsk/followers",
         "following_url" : "https://api.github.com/users/kristapsk/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kristapsk/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kristapsk",
         "id" : 4500994,
         "login" : "kristapsk",
         "node_id" : "MDQ6VXNlcjQ1MDA5OTQ=",
         "organizations_url" : "https://api.github.com/users/kristapsk/orgs",
         "received_events_url" : "https://api.github.com/users/kristapsk/received_events",
         "repos_url" : "https://api.github.com/users/kristapsk/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kristapsk/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kristapsk/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kristapsk"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24897#discussion_r882515225"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24897"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/882515225"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Linter error:\r\n```\r\nAssertions should not have side effects:\r\nsrc/wallet/wallet.cpp:    assert( ++pos == coins.end() );\r\n```",
      "commit_id" : "8f616acf868bbc75b31bf5170c40fd9957c08e91",
      "created_at" : "2022-05-26T10:02:57Z",
      "diff_hunk" : "@@ -1108,41 +1224,158 @@ bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef& ptx, const SyncTxS\n         if (fExisted && !fUpdate) return false;\n         if (fExisted || IsMine(tx) || IsFromMe(tx))\n         {\n-            /* Check if any keys in the wallet keypool that were supposed to be unused\n-             * have appeared in a new transaction. If so, remove those keys from the keypool.\n-             * This can happen when restoring an old wallet backup that does not contain\n-             * the mostly recently created transactions from newer versions of the wallet.\n-             */\n-\n-            // loop though all outputs\n-            for (const CTxOut& txout: tx.vout) {\n-                for (const auto& spk_man : GetScriptPubKeyMans(txout.scriptPubKey)) {\n-                    for (auto &dest : spk_man->MarkUnusedAddresses(txout.scriptPubKey)) {\n-                        // If internal flag is not defined try to infer it from the ScriptPubKeyMan\n-                        if (!dest.internal.has_value()) {\n-                            dest.internal = IsInternalScriptPubKeyMan(spk_man);\n-                        }\n+            return HandleNewTxBelongingToMe(tx, state, rescanning_old_block);\n+        }\n+        else if (IsWalletFlagSet(WALLET_FLAG_SILENT_PAYMENT) && VerifySilentPayment(tx, rawTrKeys))\n+        {\n+            return AddSilentScriptKeyMan(tx, state, rescanning_old_block, rawTrKeys);\n+        }\n+    }\n+    return false;\n+}\n+\n+bool CWallet::ExtractPubkeyFromInput(const CTxIn& txin, XOnlyPubKey& senderPubKey)\n+{\n+    // Find the UTXO being spent in UTXO Set to learn the transaction type\n+    std::map<COutPoint, Coin> coins;\n+    coins[txin.prevout];\n+    chain().findCoins(coins);\n \n-                        // skip if can't determine whether it's a receiving address or not\n-                        if (!dest.internal.has_value()) continue;\n+    auto pos = coins.find(txin.prevout);\n \n-                        // If this is a receiving address and it's not in the address book yet\n-                        // (e.g. it wasn't generated on this node or we're restoring from backup)\n-                        // add it to the address book for proper transaction accounting\n-                        if (!*dest.internal && !FindAddressBookEntry(dest.dest, /* allow_change= */ false)) {\n-                            SetAddressBook(dest.dest, \"\", \"receive\");\n-                        }\n-                    }\n-                }\n-            }\n+    Coin coin = pos->second;\n \n-            // Block disconnection override an abandoned tx as unconfirmed\n-            // which means user may have to call abandontransaction again\n-            TxState tx_state = std::visit([](auto&& s) -> TxState { return s; }, state);\n-            return AddToWallet(MakeTransactionRef(tx), tx_state, /*update_wtx=*/nullptr, /*fFlushOnClose=*/false, rescanning_old_block);\n+    // TODO: can more than one txin.prevout be in the mempool (RBF) ?\n+    assert( ++pos == coins.end() );",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24897#discussion_r882515225",
      "id" : 882515225,
      "line" : 1249,
      "node_id" : "PRRC_kwDOABII5840mh0Z",
      "original_commit_id" : "8f616acf868bbc75b31bf5170c40fd9957c08e91",
      "original_line" : 1249,
      "original_position" : 205,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 205,
      "pull_request_review_id" : 985996807,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24897",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/882515225/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-26T11:06:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/882515225",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4500994?v=4",
         "events_url" : "https://api.github.com/users/kristapsk/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kristapsk/followers",
         "following_url" : "https://api.github.com/users/kristapsk/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kristapsk/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kristapsk",
         "id" : 4500994,
         "login" : "kristapsk",
         "node_id" : "MDQ6VXNlcjQ1MDA5OTQ=",
         "organizations_url" : "https://api.github.com/users/kristapsk/orgs",
         "received_events_url" : "https://api.github.com/users/kristapsk/received_events",
         "repos_url" : "https://api.github.com/users/kristapsk/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kristapsk/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kristapsk/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kristapsk"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24897#discussion_r882518081"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24897"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/882518081"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n#ifndef BITCOIN_WALLET_SILENTPAYMENT_H\r\n#define BITCOIN_WALLET_SILENTPAYMENT_H\r\n```\r\n\r\nLinter does not like the name of include guard define:\r\n```\r\nsrc/wallet/silentpayment.h seems to be missing the expected include guard:\r\n  #ifndef BITCOIN_WALLET_SILENTPAYMENT_H\r\n  #define BITCOIN_WALLET_SILENTPAYMENT_H\r\n  ...\r\n  #endif // BITCOIN_WALLET_SILENTPAYMENT_H\r\n```",
      "commit_id" : "8f616acf868bbc75b31bf5170c40fd9957c08e91",
      "created_at" : "2022-05-26T10:06:58Z",
      "diff_hunk" : "@@ -0,0 +1,38 @@\n+#ifndef BITCOIN_SILENT_PAYMENT_H\n+#define BITCOIN_SILENT_PAYMENT_H",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24897#discussion_r882518081",
      "id" : 882518081,
      "line" : 2,
      "node_id" : "PRRC_kwDOABII5840mihB",
      "original_commit_id" : "8f616acf868bbc75b31bf5170c40fd9957c08e91",
      "original_line" : 2,
      "original_position" : 2,
      "original_start_line" : 1,
      "path" : "src/wallet/silentpayment.h",
      "position" : 2,
      "pull_request_review_id" : 985996807,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24897",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/882518081/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1,
      "start_side" : "RIGHT",
      "updated_at" : "2022-05-26T11:06:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/882518081",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4500994?v=4",
         "events_url" : "https://api.github.com/users/kristapsk/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kristapsk/followers",
         "following_url" : "https://api.github.com/users/kristapsk/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kristapsk/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kristapsk",
         "id" : 4500994,
         "login" : "kristapsk",
         "node_id" : "MDQ6VXNlcjQ1MDA5OTQ=",
         "organizations_url" : "https://api.github.com/users/kristapsk/orgs",
         "received_events_url" : "https://api.github.com/users/kristapsk/received_events",
         "repos_url" : "https://api.github.com/users/kristapsk/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kristapsk/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kristapsk/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kristapsk"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24897#discussion_r882521869"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24897"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/882521869"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```\r\nrpc/blockchain.cpp: In function âbool {anonymous}::CheckSilentPayment(uint256&, const CScript&, std::vector<std::tuple<FlatSigningProvider, CScript> >&, node::NodeContext&, std::vector<uint256>&, std::vector<XOnlyPubKey>&, std::map<CScript, std::__cxx11::basic_string<char> >&)â:\r\nrpc/blockchain.cpp:1936:18: warning: unused variable âactive_chainstateâ [-Wunused-variable]\r\n 1936 |     CChainState& active_chainstate = chainman.ActiveChainstate();\r\n      |                  ^~~~~~~~~~~~~~~~~\r\n```",
      "commit_id" : "8f616acf868bbc75b31bf5170c40fd9957c08e91",
      "created_at" : "2022-05-26T10:12:18Z",
      "diff_hunk" : "@@ -1910,9 +1915,113 @@ static RPCHelpMan getblockstats()\n }\n \n namespace {\n-//! Search for a given set of pubkey scripts\n-bool FindScriptPubKey(std::atomic<int>& scan_progress, const std::atomic<bool>& should_abort, int64_t& count, CCoinsViewCursor* cursor, const std::set<CScript>& needles, std::map<COutPoint, Coin>& out_results, std::function<void()>& interruption_point)\n+\n+bool CheckSilentPayment(\n+    uint256& txhash,\n+    const CScript& outScriptPubKey,\n+    std::vector<std::tuple<FlatSigningProvider, CScript>>& providers,\n+    NodeContext& node,\n+    std::vector<uint256>& verified_txs,\n+    std::vector<XOnlyPubKey>& silPubKeys,\n+    std::map<CScript, std::string>& silDesc)\n {\n+\n+    bool f_silentpaymentindex_ready = g_silentpaymentindex ? g_silentpaymentindex->BlockUntilSyncedToCurrentChain() : false;\n+    if (!f_silentpaymentindex_ready) {\n+        throw JSONRPCError(RPC_VERIFY_ERROR, \"The silent payment index is either disabled or not yet synced.\");\n+    }\n+\n+    ChainstateManager& chainman = EnsureChainman(node);\n+    LOCK(cs_main);\n+    CChainState& active_chainstate = chainman.ActiveChainstate();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24897#discussion_r882521869",
      "id" : 882521869,
      "line" : 1936,
      "node_id" : "PRRC_kwDOABII5840mjcN",
      "original_commit_id" : "8f616acf868bbc75b31bf5170c40fd9957c08e91",
      "original_line" : 1936,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 63,
      "pull_request_review_id" : 985996807,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24897",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/882521869/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-26T11:06:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/882521869",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4500994?v=4",
         "events_url" : "https://api.github.com/users/kristapsk/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kristapsk/followers",
         "following_url" : "https://api.github.com/users/kristapsk/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kristapsk/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kristapsk",
         "id" : 4500994,
         "login" : "kristapsk",
         "node_id" : "MDQ6VXNlcjQ1MDA5OTQ=",
         "organizations_url" : "https://api.github.com/users/kristapsk/orgs",
         "received_events_url" : "https://api.github.com/users/kristapsk/received_events",
         "repos_url" : "https://api.github.com/users/kristapsk/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kristapsk/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kristapsk/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kristapsk"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24897#discussion_r882526990"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24897"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/882526990"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```\r\nIn file included from wallet/wallet.cpp:44:\r\nwallet/wallet.cpp: In member function âbool wallet::CWallet::ExtractPubkeyFromInput(const CTxIn&, XOnlyPubKey&)â:\r\nwallet/wallet.cpp:1292:40: warning: comparison of integer expressions of different signedness: âstd::vector<unsigned char>::size_typeâ {aka âlong unsigned intâ} and âintâ [-Wsign-compare]\r\n 1292 |         assert(serializedPubKey.size() == pubKeySize);\r\n      |                ~~~~~~~~~~~~~~~~~~~~~~~~^~~~~~~~~~~~~\r\n```",
      "commit_id" : "8f616acf868bbc75b31bf5170c40fd9957c08e91",
      "created_at" : "2022-05-26T10:19:45Z",
      "diff_hunk" : "@@ -1108,41 +1224,158 @@ bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef& ptx, const SyncTxS\n         if (fExisted && !fUpdate) return false;\n         if (fExisted || IsMine(tx) || IsFromMe(tx))\n         {\n-            /* Check if any keys in the wallet keypool that were supposed to be unused\n-             * have appeared in a new transaction. If so, remove those keys from the keypool.\n-             * This can happen when restoring an old wallet backup that does not contain\n-             * the mostly recently created transactions from newer versions of the wallet.\n-             */\n-\n-            // loop though all outputs\n-            for (const CTxOut& txout: tx.vout) {\n-                for (const auto& spk_man : GetScriptPubKeyMans(txout.scriptPubKey)) {\n-                    for (auto &dest : spk_man->MarkUnusedAddresses(txout.scriptPubKey)) {\n-                        // If internal flag is not defined try to infer it from the ScriptPubKeyMan\n-                        if (!dest.internal.has_value()) {\n-                            dest.internal = IsInternalScriptPubKeyMan(spk_man);\n-                        }\n+            return HandleNewTxBelongingToMe(tx, state, rescanning_old_block);\n+        }\n+        else if (IsWalletFlagSet(WALLET_FLAG_SILENT_PAYMENT) && VerifySilentPayment(tx, rawTrKeys))\n+        {\n+            return AddSilentScriptKeyMan(tx, state, rescanning_old_block, rawTrKeys);\n+        }\n+    }\n+    return false;\n+}\n+\n+bool CWallet::ExtractPubkeyFromInput(const CTxIn& txin, XOnlyPubKey& senderPubKey)\n+{\n+    // Find the UTXO being spent in UTXO Set to learn the transaction type\n+    std::map<COutPoint, Coin> coins;\n+    coins[txin.prevout];\n+    chain().findCoins(coins);\n \n-                        // skip if can't determine whether it's a receiving address or not\n-                        if (!dest.internal.has_value()) continue;\n+    auto pos = coins.find(txin.prevout);\n \n-                        // If this is a receiving address and it's not in the address book yet\n-                        // (e.g. it wasn't generated on this node or we're restoring from backup)\n-                        // add it to the address book for proper transaction accounting\n-                        if (!*dest.internal && !FindAddressBookEntry(dest.dest, /* allow_change= */ false)) {\n-                            SetAddressBook(dest.dest, \"\", \"receive\");\n-                        }\n-                    }\n-                }\n-            }\n+    Coin coin = pos->second;\n \n-            // Block disconnection override an abandoned tx as unconfirmed\n-            // which means user may have to call abandontransaction again\n-            TxState tx_state = std::visit([](auto&& s) -> TxState { return s; }, state);\n-            return AddToWallet(MakeTransactionRef(tx), tx_state, /*update_wtx=*/nullptr, /*fFlushOnClose=*/false, rescanning_old_block);\n+    // TODO: can more than one txin.prevout be in the mempool (RBF) ?\n+    assert( ++pos == coins.end() );\n+\n+    if (coin.out.IsNull()) {\n+        return false;\n+    }\n+\n+    // scriptPubKey being spent by this input\n+    CScript scriptPubKey = coin.out.scriptPubKey;\n+\n+    if (scriptPubKey.IsPayToWitnessScriptHash()) {\n+        return false;\n+    }\n+\n+    // Vector of parsed pubkeys and hashes\n+    std::vector<std::vector<unsigned char>> solutions;\n+\n+    TxoutType whichType = Solver(scriptPubKey, solutions);\n+\n+    if (whichType == TxoutType::NONSTANDARD ||\n+    whichType == TxoutType::MULTISIG ||\n+    whichType == TxoutType::WITNESS_UNKNOWN ) {\n+        return false;\n+    }\n+\n+    const CScript scriptSig = txin.scriptSig;\n+    const CScriptWitness scriptWitness = txin.scriptWitness;\n+\n+    assert(senderPubKey.IsNull());\n+\n+    // TODO: Condition not tested\n+    if (whichType == TxoutType::PUBKEY) {\n+\n+        CPubKey pubkey = CPubKey(solutions[0]);\n+        assert(pubkey.IsFullyValid());\n+        senderPubKey = XOnlyPubKey(pubkey);\n+\n+    }\n+\n+    else if (whichType == TxoutType::PUBKEYHASH) {\n+\n+        int sigSize = static_cast<int>(scriptSig[0]);\n+        int pubKeySize = static_cast<int>(scriptSig[sigSize + 1]);\n+        auto serializedPubKey = std::vector<unsigned char>(scriptSig.begin() + sigSize + 2, scriptSig.end());\n+        assert(serializedPubKey.size() == pubKeySize);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24897#discussion_r882526990",
      "id" : 882526990,
      "line" : 1292,
      "node_id" : "PRRC_kwDOABII5840mksO",
      "original_commit_id" : "8f616acf868bbc75b31bf5170c40fd9957c08e91",
      "original_line" : 1292,
      "original_position" : 248,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 248,
      "pull_request_review_id" : 985996807,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24897",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/882526990/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-26T11:06:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/882526990",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4500994?v=4",
         "events_url" : "https://api.github.com/users/kristapsk/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kristapsk/followers",
         "following_url" : "https://api.github.com/users/kristapsk/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kristapsk/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kristapsk",
         "id" : 4500994,
         "login" : "kristapsk",
         "node_id" : "MDQ6VXNlcjQ1MDA5OTQ=",
         "organizations_url" : "https://api.github.com/users/kristapsk/orgs",
         "received_events_url" : "https://api.github.com/users/kristapsk/received_events",
         "repos_url" : "https://api.github.com/users/kristapsk/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kristapsk/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kristapsk/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kristapsk"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24897#discussion_r882527414"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24897"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/882527414"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```\r\nwallet/silentpayment.cpp: In static member function âstatic void silentpayment::Recipient::CreateTweakedKeyPair(const secp256k1_context*, secp256k1_xonly_pubkey, secp256k1_keypair&)â:\r\nwallet/silentpayment.cpp:72:22: warning: unused variable âoutput_pubkeyâ [-Wunused-variable]\r\n   72 |     secp256k1_pubkey output_pubkey;\r\n      |                      ^~~~~~~~~~~~~\r\n```",
      "commit_id" : "8f616acf868bbc75b31bf5170c40fd9957c08e91",
      "created_at" : "2022-05-26T10:20:23Z",
      "diff_hunk" : "@@ -0,0 +1,115 @@\n+#include \"silentpayment.h\"\n+\n+#include <key_io.h>\n+#include <secp256k1.h>\n+#include <secp256k1_ecdh.h>\n+#include <secp256k1_extrakeys.h>\n+\n+namespace silentpayment {\n+\n+secp256k1_pubkey Sender::CreateTweakedPubkey(\n+    const secp256k1_context* ctx,\n+    const secp256k1_xonly_pubkey recipient_public_key,\n+    const unsigned char sender_secret_key[32])\n+{\n+    unsigned char shared_secret[32];\n+\n+    secp256k1_pubkey output_pubkey;\n+\n+    int return_val;\n+\n+    return_val = secp256k1_ecdh_xonly(ctx, shared_secret, &recipient_public_key, sender_secret_key, NULL, NULL);\n+    assert(return_val);\n+\n+    return_val = secp256k1_ec_seckey_verify(secp256k1_context_no_precomp, shared_secret);\n+    assert(return_val);\n+\n+    return_val = secp256k1_xonly_pubkey_tweak_add(ctx, &output_pubkey, &recipient_public_key, shared_secret);\n+    assert(return_val);\n+\n+    return output_pubkey;\n+}\n+\n+XOnlyPubKey Sender::CreateSilentPaymentAddress(\n+    const CKey& sender_secret_key,\n+    const XOnlyPubKey& _recipient_public_key)\n+{\n+    int return_val;\n+\n+    secp256k1_context* ctx = secp256k1_context_create(SECP256K1_CONTEXT_SIGN | SECP256K1_CONTEXT_VERIFY);\n+\n+    secp256k1_xonly_pubkey recipient_public_key;\n+    return_val = secp256k1_xonly_pubkey_parse(ctx, &recipient_public_key, _recipient_public_key.data());\n+    assert(return_val);\n+\n+    secp256k1_pubkey sender_output_pubkey;\n+    sender_output_pubkey = CreateTweakedPubkey(ctx, recipient_public_key, sender_secret_key.begin());\n+\n+    // Test the key\n+    size_t len;\n+    unsigned char sender_serialized_output_pubkey[33];\n+    len = sizeof(sender_serialized_output_pubkey);\n+    return_val = secp256k1_ec_pubkey_serialize(ctx, sender_serialized_output_pubkey, &len, &sender_output_pubkey, SECP256K1_EC_COMPRESSED);\n+    assert(return_val);\n+\n+    CPubKey pubKey = CPubKey(sender_serialized_output_pubkey);\n+\n+    assert(pubKey.IsFullyValid());\n+\n+    XOnlyPubKey xOnlyPubKey = XOnlyPubKey(pubKey);\n+\n+    return xOnlyPubKey;\n+}\n+\n+void Recipient::CreateTweakedKeyPair(\n+    const secp256k1_context* ctx,\n+    const secp256k1_xonly_pubkey sender_public_key,\n+    secp256k1_keypair& recipient_keypair)\n+{\n+    unsigned char recipient_secret_key[32];\n+    unsigned char shared_secret[32];\n+\n+    secp256k1_pubkey output_pubkey;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24897#discussion_r882527414",
      "id" : 882527414,
      "line" : 72,
      "node_id" : "PRRC_kwDOABII5840mky2",
      "original_commit_id" : "8f616acf868bbc75b31bf5170c40fd9957c08e91",
      "original_line" : 72,
      "original_position" : 72,
      "original_start_line" : null,
      "path" : "src/wallet/silentpayment.cpp",
      "position" : 72,
      "pull_request_review_id" : 985996807,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24897",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/882527414/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-26T11:06:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/882527414",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4500994?v=4",
         "events_url" : "https://api.github.com/users/kristapsk/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kristapsk/followers",
         "following_url" : "https://api.github.com/users/kristapsk/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kristapsk/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kristapsk",
         "id" : 4500994,
         "login" : "kristapsk",
         "node_id" : "MDQ6VXNlcjQ1MDA5OTQ=",
         "organizations_url" : "https://api.github.com/users/kristapsk/orgs",
         "received_events_url" : "https://api.github.com/users/kristapsk/received_events",
         "repos_url" : "https://api.github.com/users/kristapsk/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kristapsk/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kristapsk/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kristapsk"
      }
   }
]
