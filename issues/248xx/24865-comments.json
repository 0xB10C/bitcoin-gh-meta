[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24865#discussion_r851517641"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24865"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/851517641"
         }
      },
      "author_association" : "NONE",
      "body" : "```suggestion\r\nfrom test_framework.blocktools import create_coinbase\r\n```",
      "commit_id" : "35432901b42c27e0ee0abe2a32a4d13e10ab14cc",
      "created_at" : "2022-04-15T21:13:32Z",
      "diff_hunk" : "@@ -0,0 +1,161 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+\"\"\"Test wallet import on pruned node.\"\"\"\n+import os\n+\n+from test_framework.util import (\n+    assert_raises_rpc_error,\n+)\n+\n+from test_framework.blocktools import (create_coinbase)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24865#discussion_r851517641",
      "id" : 851517641,
      "line" : 13,
      "node_id" : "PRRC_kwDOABII584ywSDJ",
      "original_commit_id" : "35432901b42c27e0ee0abe2a32a4d13e10ab14cc",
      "original_line" : 13,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "test/functional/wallet_pruning.py",
      "position" : 13,
      "pull_request_review_id" : 943745563,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24865",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/851517641/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-15T21:15:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/851517641",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/17150045?v=4",
         "events_url" : "https://api.github.com/users/vincenzopalazzo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vincenzopalazzo/followers",
         "following_url" : "https://api.github.com/users/vincenzopalazzo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vincenzopalazzo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vincenzopalazzo",
         "id" : 17150045,
         "login" : "vincenzopalazzo",
         "node_id" : "MDQ6VXNlcjE3MTUwMDQ1",
         "organizations_url" : "https://api.github.com/users/vincenzopalazzo/orgs",
         "received_events_url" : "https://api.github.com/users/vincenzopalazzo/received_events",
         "repos_url" : "https://api.github.com/users/vincenzopalazzo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vincenzopalazzo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vincenzopalazzo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vincenzopalazzo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24865#discussion_r851517958"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24865"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/851517958"
         }
      },
      "author_association" : "NONE",
      "body" : "```suggestion\r\n\r\n\r\nclass WalletPruningTest(BitcoinTestFramework):\r\n```\r\n\r\nUsualy in python there are two spaces between class and the last import declaration",
      "commit_id" : "35432901b42c27e0ee0abe2a32a4d13e10ab14cc",
      "created_at" : "2022-04-15T21:14:13Z",
      "diff_hunk" : "@@ -0,0 +1,161 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+\"\"\"Test wallet import on pruned node.\"\"\"\n+import os\n+\n+from test_framework.util import (\n+    assert_raises_rpc_error,\n+)\n+\n+from test_framework.blocktools import (create_coinbase)\n+from test_framework.messages import CBlock\n+from test_framework.script import (\n+    CScript,\n+    OP_NOP,\n+    OP_RETURN,\n+)\n+from test_framework.wallet_util import (\n+    get_key,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+\n+class WalletPruningTest(BitcoinTestFramework):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24865#discussion_r851517958",
      "id" : 851517958,
      "line" : 25,
      "node_id" : "PRRC_kwDOABII584ywSIG",
      "original_commit_id" : "35432901b42c27e0ee0abe2a32a4d13e10ab14cc",
      "original_line" : 25,
      "original_position" : 25,
      "original_start_line" : 24,
      "path" : "test/functional/wallet_pruning.py",
      "position" : 25,
      "pull_request_review_id" : 943745563,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24865",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/851517958/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 24,
      "start_side" : "RIGHT",
      "updated_at" : "2022-04-15T21:15:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/851517958",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/17150045?v=4",
         "events_url" : "https://api.github.com/users/vincenzopalazzo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vincenzopalazzo/followers",
         "following_url" : "https://api.github.com/users/vincenzopalazzo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vincenzopalazzo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vincenzopalazzo",
         "id" : 17150045,
         "login" : "vincenzopalazzo",
         "node_id" : "MDQ6VXNlcjE3MTUwMDQ1",
         "organizations_url" : "https://api.github.com/users/vincenzopalazzo/orgs",
         "received_events_url" : "https://api.github.com/users/vincenzopalazzo/received_events",
         "repos_url" : "https://api.github.com/users/vincenzopalazzo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vincenzopalazzo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vincenzopalazzo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vincenzopalazzo"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.",
      "created_at" : "2022-04-16T06:33:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24865#issuecomment-1100586603",
      "id" : 1100586603,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24865",
      "node_id" : "IC_kwDOABII585BmZ5r",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1100586603/reactions"
      },
      "updated_at" : "2022-04-27T10:38:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1100586603",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24865#discussion_r885807339"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24865"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/885807339"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If we're reusing helper functions, perhaps we should extract them to a single place in a follow-up PR.",
      "commit_id" : "46b7f731b1e98b0836c5b97cd99c0887d6173a17",
      "created_at" : "2022-05-31T15:47:11Z",
      "diff_hunk" : "@@ -0,0 +1,157 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+\"\"\"Test wallet import on pruned node.\"\"\"\n+import os\n+\n+from test_framework.util import assert_raises_rpc_error\n+from test_framework.blocktools import create_coinbase\n+from test_framework.messages import CBlock\n+from test_framework.script import (\n+    CScript,\n+    OP_NOP,\n+    OP_RETURN,\n+)\n+from test_framework.wallet_util import get_key\n+from test_framework.test_framework import BitcoinTestFramework\n+\n+\n+class WalletPruningTest(BitcoinTestFramework):\n+    nTime = 0\n+    def mine_large_blocks(self, node, n):\n+        # Taken from test/functional/feature_pruning.py",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24865#discussion_r885807339",
      "id" : 885807339,
      "line" : 24,
      "node_id" : "PRRC_kwDOABII5840zFjr",
      "original_commit_id" : "46b7f731b1e98b0836c5b97cd99c0887d6173a17",
      "original_line" : 24,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "test/functional/wallet_pruning.py",
      "position" : 24,
      "pull_request_review_id" : 990700101,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24865",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/885807339/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-31T16:00:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/885807339",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24865#discussion_r885820729"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24865"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/885820729"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This looks good to me, but perhaps it would be more comprehensive to learn the birthheight or first transaction's height from the wallet, and check/assert here that the corresponding block has been pruned.",
      "commit_id" : "46b7f731b1e98b0836c5b97cd99c0887d6173a17",
      "created_at" : "2022-05-31T15:59:51Z",
      "diff_hunk" : "@@ -0,0 +1,157 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+\"\"\"Test wallet import on pruned node.\"\"\"\n+import os\n+\n+from test_framework.util import assert_raises_rpc_error\n+from test_framework.blocktools import create_coinbase\n+from test_framework.messages import CBlock\n+from test_framework.script import (\n+    CScript,\n+    OP_NOP,\n+    OP_RETURN,\n+)\n+from test_framework.wallet_util import get_key\n+from test_framework.test_framework import BitcoinTestFramework\n+\n+\n+class WalletPruningTest(BitcoinTestFramework):\n+    nTime = 0\n+    def mine_large_blocks(self, node, n):\n+        # Taken from test/functional/feature_pruning.py\n+\n+        # Make a large scriptPubKey for the coinbase transaction. This is OP_RETURN\n+        # followed by 950k of OP_NOP. This would be non-standard in a non-coinbase\n+        # transaction but is consensus valid.\n+\n+        # Get the block parameters for the first block\n+        big_script = CScript([OP_RETURN] + [OP_NOP] * 950000)\n+        best_block = node.getblock(node.getbestblockhash())\n+        height = int(best_block[\"height\"]) + 1\n+        self.nTime = max(self.nTime, int(best_block[\"time\"])) + 1\n+        previousblockhash = int(best_block[\"hash\"], 16)\n+\n+        for _ in range(n):\n+            # Build the coinbase transaction (with large scriptPubKey)\n+            coinbase_tx = create_coinbase(height)\n+            coinbase_tx.vin[0].nSequence = 2 ** 32 - 1\n+            coinbase_tx.vout[0].scriptPubKey = big_script\n+            coinbase_tx.rehash()\n+\n+            # Build the block\n+            block = CBlock()\n+            block.nVersion = best_block[\"version\"]\n+            block.hashPrevBlock = previousblockhash\n+            block.nTime = self.nTime\n+            block.nBits = int('207fffff', 16)\n+            block.nNonce = 0\n+            block.vtx = [coinbase_tx]\n+            block.hashMerkleRoot = block.calc_merkle_root()\n+            block.solve()\n+\n+            # Submit to the node\n+            node.submitblock(block.serialize().hex())\n+\n+            previousblockhash = block.sha256\n+            height += 1\n+\n+            # Simulate 10 minutes of work time per block\n+            # Important for matching a timestamp with a block +- some window\n+            self.nTime += 600\n+            for n in self.nodes:\n+                n.setmocktime(self.nTime) # Update nodes' time to accept future blocks\n+\n+\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 2\n+        self.extra_args = [\n+            [], # node dedicated to mining\n+            ['-prune=550'], # node dedicated to testing pruning\n+        ]\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+        self.connect_nodes(0, 1)\n+        self.sync_all(self.nodes)\n+\n+    def create_big_chain(self):\n+        self.log.info(\"Generating a long chain of blocks...\")\n+        # Generate 288 light blocks, the minimum required to stay on disk with prune enabled\n+        self.generate(self.nodes[0], 288, sync_fun=lambda: self.sync_all(self.nodes))\n+\n+        # Generate large blocks to make sure we have enough to test chain pruning\n+        self.mine_large_blocks(self.nodes[0], 610)\n+        self.sync_all(self.nodes)\n+\n+    def wallet_import_pruned_test(self):\n+        self.log.info(\"Make sure we can import wallet when pruned and required blocks are still available\")\n+\n+        wname = \"wallet_pruned.dat\"\n+\n+        # export wallet\n+        self.nodes[1].dumpwallet(os.path.join(self.nodes[1].datadir, wname))\n+        # import wallet\n+        self.nodes[1].importwallet(os.path.join(self.nodes[1].datadir, wname))\n+\n+        timestamp = self.nodes[1].getblock(self.nodes[1].getbestblockhash())['mediantime']\n+\n+        # Test importmulti\n+        key = get_key(self.nodes[1])\n+        self.nodes[1].importmulti([{\"scriptPubKey\": {\"address\": key.p2pkh_addr},\n+                               \"timestamp\": 'now'}])\n+\n+        self.nodes[1].importmulti([{\"scriptPubKey\": {\"address\": key.p2pkh_addr},\n+                               \"timestamp\": timestamp}])\n+\n+        # mine some blocks, pruning should not have removed the block\n+        self.mine_large_blocks(self.nodes[0], 5)\n+        self.sync_all(self.nodes)\n+\n+        # import wallet, should still work\n+        self.nodes[1].importwallet(os.path.join(self.nodes[1].datadir, wname))\n+\n+        # test with importmulti\n+        self.nodes[1].importmulti([{\"scriptPubKey\": {\"address\": key.p2pkh_addr},\n+                               \"timestamp\": timestamp}])\n+\n+        self.log.info(\"Wallet successfully imported on pruned node\")\n+\n+    def wallet_import_pruned_missing_blocks(self):\n+        self.log.info(\"Make sure we cannot import wallet when pruned and required blocks are not available\")\n+\n+        wname = \"wallet_pruned_missing_blocks.dat\"\n+        # export wallet\n+        self.nodes[1].dumpwallet(os.path.join(self.nodes[1].datadir, wname))\n+\n+        # mine large blocks, blocks will be pruned automatically\n+        self.mine_large_blocks(self.nodes[0], 150)\n+        self.sync_all(self.nodes)\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24865#discussion_r885820729",
      "id" : 885820729,
      "line" : 136,
      "node_id" : "PRRC_kwDOABII5840zI05",
      "original_commit_id" : "46b7f731b1e98b0836c5b97cd99c0887d6173a17",
      "original_line" : 136,
      "original_position" : 136,
      "original_start_line" : null,
      "path" : "test/functional/wallet_pruning.py",
      "position" : 136,
      "pull_request_review_id" : 990700101,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24865",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/885820729/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-31T16:00:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/885820729",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24865#discussion_r901998188"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24865"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/901998188"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 46b7f731b1e98b0836c5b97cd99c0887d6173a17 \"rpc: Enable wallet import on pruned nodes and add test\"\r\n\r\nWe don't want to do this for `importmulti`. `importmulti` can have some imports succeed, and others fail. Just because one import has an out of range timestamp does not mean the entire import should fail the RPC. This check would result in a JSONRPCError which is not what we expect from `importmulti` - rather there should be an error per import that has a too old timestamp.\r\n\r\nFurthermore, we already handle the pruned node case. If the rescan reports a time that is more recent than the timestamp for a given import, we will give an error for that import with more details about what happened, maybe why it happened, and how the user can resolve it.",
      "commit_id" : "46b7f731b1e98b0836c5b97cd99c0887d6173a17",
      "created_at" : "2022-06-20T21:06:17Z",
      "diff_hunk" : "@@ -1383,6 +1388,8 @@ RPCHelpMan importmulti()\n                 nLowestTimestamp = timestamp;\n             }\n         }\n+\n+        EnsureBlockDataFromTime(pwallet->chain(), nLowestTimestamp);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24865#discussion_r901998188",
      "id" : 901998188,
      "line" : 1392,
      "node_id" : "PRRC_kwDOABII5841w2Zs",
      "original_commit_id" : "46b7f731b1e98b0836c5b97cd99c0887d6173a17",
      "original_line" : 1392,
      "original_position" : 78,
      "original_start_line" : null,
      "path" : "src/wallet/rpc/backup.cpp",
      "position" : 78,
      "pull_request_review_id" : 1012746916,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24865",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/901998188/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-20T21:09:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/901998188",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24865#discussion_r919171723"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24865"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919171723"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Do you actually need this? The only difference in behaviour that I see from the default https://github.com/bitcoin/bitcoin/blob/1d89fc695a3aeb3e3dcadf371b7667572b38c836/test/functional/test_framework/test_framework.py#L387\r\nis the `0 -> 1` instead of `1 -> 0` nodes' connection which seems to make no difference for the test.\r\n\r\n",
      "commit_id" : "45435bc688387db2fdf0550f48881a8cf60cbe0f",
      "created_at" : "2022-07-12T16:22:59Z",
      "diff_hunk" : "@@ -0,0 +1,117 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+\"\"\"Test wallet import on pruned node.\"\"\"\n+import os\n+\n+from test_framework.util import assert_raises_rpc_error\n+from test_framework.blocktools import create_large_block\n+from test_framework.test_framework import BitcoinTestFramework\n+\n+\n+class WalletPruningTest(BitcoinTestFramework):\n+    nTime = 0\n+    def mine_large_blocks(self, node, n):\n+        # Get the block parameters for the first block\n+        best_block = node.getblock(node.getbestblockhash())\n+        height = int(best_block[\"height\"]) + 1\n+        self.nTime = max(self.nTime, int(best_block[\"time\"])) + 1\n+        previousblockhash = int(best_block[\"hash\"], 16)\n+\n+        for _ in range(n):\n+            block = create_large_block(hashprev=previousblockhash, height=height, ntime=self.nTime)\n+            block.solve()\n+\n+            # Submit to the node\n+            node.submitblock(block.serialize().hex())\n+\n+            previousblockhash = block.sha256\n+            height += 1\n+\n+            # Simulate 10 minutes of work time per block\n+            # Important for matching a timestamp with a block +- some window\n+            self.nTime += 600\n+            for n in self.nodes:\n+                n.setmocktime(self.nTime) # Update nodes' time to accept future blocks\n+\n+\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 2\n+        self.extra_args = [\n+            [], # node dedicated to mining\n+            ['-prune=550'], # node dedicated to testing pruning\n+        ]\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+        self.connect_nodes(0, 1)\n+        self.sync_all(self.nodes)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24865#discussion_r919171723",
      "id" : 919171723,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5842yXKL",
      "original_commit_id" : "b45e54bf513c6e33686f4212200f1615dbac8ee4",
      "original_line" : 54,
      "original_position" : 54,
      "original_start_line" : 51,
      "path" : "test/functional/wallet_pruning.py",
      "position" : null,
      "pull_request_review_id" : 1036108749,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24865",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919171723/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-07-13T14:21:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919171723",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/18506343?v=4",
         "events_url" : "https://api.github.com/users/kouloumos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kouloumos/followers",
         "following_url" : "https://api.github.com/users/kouloumos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kouloumos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kouloumos",
         "id" : 18506343,
         "login" : "kouloumos",
         "node_id" : "MDQ6VXNlcjE4NTA2MzQz",
         "organizations_url" : "https://api.github.com/users/kouloumos/orgs",
         "received_events_url" : "https://api.github.com/users/kouloumos/received_events",
         "repos_url" : "https://api.github.com/users/kouloumos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kouloumos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kouloumos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kouloumos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24865#discussion_r919177252"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24865"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919177252"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think that if `sync_fun` is not defined you will still have the desired behaviour here",
      "commit_id" : "45435bc688387db2fdf0550f48881a8cf60cbe0f",
      "created_at" : "2022-07-12T16:28:33Z",
      "diff_hunk" : "@@ -0,0 +1,117 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+\"\"\"Test wallet import on pruned node.\"\"\"\n+import os\n+\n+from test_framework.util import assert_raises_rpc_error\n+from test_framework.blocktools import create_large_block\n+from test_framework.test_framework import BitcoinTestFramework\n+\n+\n+class WalletPruningTest(BitcoinTestFramework):\n+    nTime = 0\n+    def mine_large_blocks(self, node, n):\n+        # Get the block parameters for the first block\n+        best_block = node.getblock(node.getbestblockhash())\n+        height = int(best_block[\"height\"]) + 1\n+        self.nTime = max(self.nTime, int(best_block[\"time\"])) + 1\n+        previousblockhash = int(best_block[\"hash\"], 16)\n+\n+        for _ in range(n):\n+            block = create_large_block(hashprev=previousblockhash, height=height, ntime=self.nTime)\n+            block.solve()\n+\n+            # Submit to the node\n+            node.submitblock(block.serialize().hex())\n+\n+            previousblockhash = block.sha256\n+            height += 1\n+\n+            # Simulate 10 minutes of work time per block\n+            # Important for matching a timestamp with a block +- some window\n+            self.nTime += 600\n+            for n in self.nodes:\n+                n.setmocktime(self.nTime) # Update nodes' time to accept future blocks\n+\n+\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 2\n+        self.extra_args = [\n+            [], # node dedicated to mining\n+            ['-prune=550'], # node dedicated to testing pruning\n+        ]\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+        self.connect_nodes(0, 1)\n+        self.sync_all(self.nodes)\n+\n+    def create_big_chain(self):\n+        self.log.info(\"Generating a long chain of blocks...\")\n+        # Generate 288 light blocks, the minimum required to stay on disk with prune enabled\n+        self.generate(self.nodes[0], 288, sync_fun=lambda: self.sync_all(self.nodes))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24865#discussion_r919177252",
      "id" : 919177252,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5842yYgk",
      "original_commit_id" : "b45e54bf513c6e33686f4212200f1615dbac8ee4",
      "original_line" : 59,
      "original_position" : 59,
      "original_start_line" : null,
      "path" : "test/functional/wallet_pruning.py",
      "position" : null,
      "pull_request_review_id" : 1036108749,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24865",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919177252/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-13T14:21:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919177252",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/18506343?v=4",
         "events_url" : "https://api.github.com/users/kouloumos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kouloumos/followers",
         "following_url" : "https://api.github.com/users/kouloumos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kouloumos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kouloumos",
         "id" : 18506343,
         "login" : "kouloumos",
         "node_id" : "MDQ6VXNlcjE4NTA2MzQz",
         "organizations_url" : "https://api.github.com/users/kouloumos/orgs",
         "received_events_url" : "https://api.github.com/users/kouloumos/received_events",
         "repos_url" : "https://api.github.com/users/kouloumos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kouloumos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kouloumos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kouloumos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24865#discussion_r919177455"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24865"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919177455"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`self.nodes` is the default if `nodes=None`\r\nhttps://github.com/bitcoin/bitcoin/blob/1d89fc695a3aeb3e3dcadf371b7667572b38c836/test/functional/test_framework/test_framework.py#L674",
      "commit_id" : "45435bc688387db2fdf0550f48881a8cf60cbe0f",
      "created_at" : "2022-07-12T16:28:47Z",
      "diff_hunk" : "@@ -0,0 +1,117 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+\"\"\"Test wallet import on pruned node.\"\"\"\n+import os\n+\n+from test_framework.util import assert_raises_rpc_error\n+from test_framework.blocktools import create_large_block\n+from test_framework.test_framework import BitcoinTestFramework\n+\n+\n+class WalletPruningTest(BitcoinTestFramework):\n+    nTime = 0\n+    def mine_large_blocks(self, node, n):\n+        # Get the block parameters for the first block\n+        best_block = node.getblock(node.getbestblockhash())\n+        height = int(best_block[\"height\"]) + 1\n+        self.nTime = max(self.nTime, int(best_block[\"time\"])) + 1\n+        previousblockhash = int(best_block[\"hash\"], 16)\n+\n+        for _ in range(n):\n+            block = create_large_block(hashprev=previousblockhash, height=height, ntime=self.nTime)\n+            block.solve()\n+\n+            # Submit to the node\n+            node.submitblock(block.serialize().hex())\n+\n+            previousblockhash = block.sha256\n+            height += 1\n+\n+            # Simulate 10 minutes of work time per block\n+            # Important for matching a timestamp with a block +- some window\n+            self.nTime += 600\n+            for n in self.nodes:\n+                n.setmocktime(self.nTime) # Update nodes' time to accept future blocks\n+\n+\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 2\n+        self.extra_args = [\n+            [], # node dedicated to mining\n+            ['-prune=550'], # node dedicated to testing pruning\n+        ]\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+        self.connect_nodes(0, 1)\n+        self.sync_all(self.nodes)\n+\n+    def create_big_chain(self):\n+        self.log.info(\"Generating a long chain of blocks...\")\n+        # Generate 288 light blocks, the minimum required to stay on disk with prune enabled\n+        self.generate(self.nodes[0], 288, sync_fun=lambda: self.sync_all(self.nodes))\n+\n+        # Generate large blocks to make sure we have enough to test chain pruning\n+        self.mine_large_blocks(self.nodes[0], 610)\n+        self.sync_all(self.nodes)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24865#discussion_r919177455",
      "id" : 919177455,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5842yYjv",
      "original_commit_id" : "b45e54bf513c6e33686f4212200f1615dbac8ee4",
      "original_line" : 63,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "test/functional/wallet_pruning.py",
      "position" : null,
      "pull_request_review_id" : 1036108749,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24865",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919177455/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-13T14:21:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919177455",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/18506343?v=4",
         "events_url" : "https://api.github.com/users/kouloumos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kouloumos/followers",
         "following_url" : "https://api.github.com/users/kouloumos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kouloumos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kouloumos",
         "id" : 18506343,
         "login" : "kouloumos",
         "node_id" : "MDQ6VXNlcjE4NTA2MzQz",
         "organizations_url" : "https://api.github.com/users/kouloumos/orgs",
         "received_events_url" : "https://api.github.com/users/kouloumos/received_events",
         "repos_url" : "https://api.github.com/users/kouloumos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kouloumos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kouloumos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kouloumos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24865#discussion_r919187882"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24865"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919187882"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: for how it is used in this test, I think that `sync_all` could be part of the `mine_large_blocks` method",
      "commit_id" : "45435bc688387db2fdf0550f48881a8cf60cbe0f",
      "created_at" : "2022-07-12T16:39:13Z",
      "diff_hunk" : "@@ -0,0 +1,117 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+\"\"\"Test wallet import on pruned node.\"\"\"\n+import os\n+\n+from test_framework.util import assert_raises_rpc_error\n+from test_framework.blocktools import create_large_block\n+from test_framework.test_framework import BitcoinTestFramework\n+\n+\n+class WalletPruningTest(BitcoinTestFramework):\n+    nTime = 0\n+    def mine_large_blocks(self, node, n):\n+        # Get the block parameters for the first block\n+        best_block = node.getblock(node.getbestblockhash())\n+        height = int(best_block[\"height\"]) + 1\n+        self.nTime = max(self.nTime, int(best_block[\"time\"])) + 1\n+        previousblockhash = int(best_block[\"hash\"], 16)\n+\n+        for _ in range(n):\n+            block = create_large_block(hashprev=previousblockhash, height=height, ntime=self.nTime)\n+            block.solve()\n+\n+            # Submit to the node\n+            node.submitblock(block.serialize().hex())\n+\n+            previousblockhash = block.sha256\n+            height += 1\n+\n+            # Simulate 10 minutes of work time per block\n+            # Important for matching a timestamp with a block +- some window\n+            self.nTime += 600\n+            for n in self.nodes:\n+                n.setmocktime(self.nTime) # Update nodes' time to accept future blocks\n+\n+\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 2\n+        self.extra_args = [\n+            [], # node dedicated to mining\n+            ['-prune=550'], # node dedicated to testing pruning\n+        ]\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+        self.connect_nodes(0, 1)\n+        self.sync_all(self.nodes)\n+\n+    def create_big_chain(self):\n+        self.log.info(\"Generating a long chain of blocks...\")\n+        # Generate 288 light blocks, the minimum required to stay on disk with prune enabled\n+        self.generate(self.nodes[0], 288, sync_fun=lambda: self.sync_all(self.nodes))\n+\n+        # Generate large blocks to make sure we have enough to test chain pruning\n+        self.mine_large_blocks(self.nodes[0], 610)\n+        self.sync_all(self.nodes)\n+\n+    def wallet_import_pruned_test(self):\n+        self.log.info(\"Make sure we can import wallet when pruned and required blocks are still available\")\n+\n+        wname = \"wallet_pruned.dat\"\n+\n+        # export wallet\n+        self.nodes[1].dumpwallet(os.path.join(self.nodes[1].datadir, wname))\n+        # import wallet\n+        self.nodes[1].importwallet(os.path.join(self.nodes[1].datadir, wname))\n+\n+        # mine some blocks, pruning should not have removed the block\n+        self.mine_large_blocks(self.nodes[0], 5)\n+        self.sync_all(self.nodes)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24865#discussion_r919187882",
      "id" : 919187882,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5842ybGq",
      "original_commit_id" : "b45e54bf513c6e33686f4212200f1615dbac8ee4",
      "original_line" : 77,
      "original_position" : 77,
      "original_start_line" : null,
      "path" : "test/functional/wallet_pruning.py",
      "position" : null,
      "pull_request_review_id" : 1036108749,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24865",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919187882/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-13T14:21:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919187882",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/18506343?v=4",
         "events_url" : "https://api.github.com/users/kouloumos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kouloumos/followers",
         "following_url" : "https://api.github.com/users/kouloumos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kouloumos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kouloumos",
         "id" : 18506343,
         "login" : "kouloumos",
         "node_id" : "MDQ6VXNlcjE4NTA2MzQz",
         "organizations_url" : "https://api.github.com/users/kouloumos/orgs",
         "received_events_url" : "https://api.github.com/users/kouloumos/received_events",
         "repos_url" : "https://api.github.com/users/kouloumos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kouloumos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kouloumos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kouloumos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24865#discussion_r919834580"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24865"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919834580"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Maybe it would be better to include a `test` prefix as in most tests?\r\ne.g `test_wallet_import_on_pruned_node{_with_missing_blocks}`",
      "commit_id" : "45435bc688387db2fdf0550f48881a8cf60cbe0f",
      "created_at" : "2022-07-13T09:04:41Z",
      "diff_hunk" : "@@ -0,0 +1,117 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+\"\"\"Test wallet import on pruned node.\"\"\"\n+import os\n+\n+from test_framework.util import assert_raises_rpc_error\n+from test_framework.blocktools import create_large_block\n+from test_framework.test_framework import BitcoinTestFramework\n+\n+\n+class WalletPruningTest(BitcoinTestFramework):\n+    nTime = 0\n+    def mine_large_blocks(self, node, n):\n+        # Get the block parameters for the first block\n+        best_block = node.getblock(node.getbestblockhash())\n+        height = int(best_block[\"height\"]) + 1\n+        self.nTime = max(self.nTime, int(best_block[\"time\"])) + 1\n+        previousblockhash = int(best_block[\"hash\"], 16)\n+\n+        for _ in range(n):\n+            block = create_large_block(hashprev=previousblockhash, height=height, ntime=self.nTime)\n+            block.solve()\n+\n+            # Submit to the node\n+            node.submitblock(block.serialize().hex())\n+\n+            previousblockhash = block.sha256\n+            height += 1\n+\n+            # Simulate 10 minutes of work time per block\n+            # Important for matching a timestamp with a block +- some window\n+            self.nTime += 600\n+            for n in self.nodes:\n+                n.setmocktime(self.nTime) # Update nodes' time to accept future blocks\n+\n+\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 2\n+        self.extra_args = [\n+            [], # node dedicated to mining\n+            ['-prune=550'], # node dedicated to testing pruning\n+        ]\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+        self.connect_nodes(0, 1)\n+        self.sync_all(self.nodes)\n+\n+    def create_big_chain(self):\n+        self.log.info(\"Generating a long chain of blocks...\")\n+        # Generate 288 light blocks, the minimum required to stay on disk with prune enabled\n+        self.generate(self.nodes[0], 288, sync_fun=lambda: self.sync_all(self.nodes))\n+\n+        # Generate large blocks to make sure we have enough to test chain pruning\n+        self.mine_large_blocks(self.nodes[0], 610)\n+        self.sync_all(self.nodes)\n+\n+    def wallet_import_pruned_test(self):\n+        self.log.info(\"Make sure we can import wallet when pruned and required blocks are still available\")\n+\n+        wname = \"wallet_pruned.dat\"\n+\n+        # export wallet\n+        self.nodes[1].dumpwallet(os.path.join(self.nodes[1].datadir, wname))\n+        # import wallet\n+        self.nodes[1].importwallet(os.path.join(self.nodes[1].datadir, wname))\n+\n+        # mine some blocks, pruning should not have removed the block\n+        self.mine_large_blocks(self.nodes[0], 5)\n+        self.sync_all(self.nodes)\n+\n+        # import wallet, should still work\n+        self.nodes[1].importwallet(os.path.join(self.nodes[1].datadir, wname))\n+        self.log.info(\"Wallet successfully imported on pruned node\")\n+\n+    def wallet_import_pruned_missing_blocks(self):\n+        self.log.info(\"Make sure we cannot import wallet when pruned and required blocks are not available\")\n+\n+        wname = \"wallet_pruned_missing_blocks.dat\"\n+        # export wallet\n+        self.nodes[1].dumpwallet(os.path.join(self.nodes[1].datadir, wname))\n+\n+        # get birthheight of wallet\n+        with open(os.path.join(self.nodes[1].datadir, wname), 'r', encoding=\"utf8\") as f:\n+            for line in f:\n+                if line.startswith('# * Best block at time of backup'):\n+                    wallet_birthheight = int(line.split(' ')[9])\n+                    break\n+\n+        # mine large blocks, blocks will be pruned automatically\n+        self.mine_large_blocks(self.nodes[0], 650)\n+        self.sync_all(self.nodes)\n+\n+        assert_raises_rpc_error(-1, \"Block not available (pruned data)\", self.nodes[1].getblock, self.nodes[1].getblockhash(wallet_birthheight))\n+\n+        # make sure wallet cannot be imported because of missing blocks\n+        assert_raises_rpc_error(-4, \"Pruned blocks required to import keys\", self.nodes[1].importwallet, os.path.join(self.nodes[1].datadir, wname))\n+\n+    def run_test(self):\n+        self.log.info(\"Warning! This test requires ~1.5GB of disk space\")\n+\n+        self.create_big_chain()\n+\n+        self.wallet_import_pruned_test()\n+        self.wallet_import_pruned_missing_blocks()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24865#discussion_r919834580",
      "id" : 919834580,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584204_U",
      "original_commit_id" : "b45e54bf513c6e33686f4212200f1615dbac8ee4",
      "original_line" : 112,
      "original_position" : 112,
      "original_start_line" : 111,
      "path" : "test/functional/wallet_pruning.py",
      "position" : null,
      "pull_request_review_id" : 1036108749,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24865",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919834580/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-07-13T14:21:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919834580",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/18506343?v=4",
         "events_url" : "https://api.github.com/users/kouloumos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kouloumos/followers",
         "following_url" : "https://api.github.com/users/kouloumos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kouloumos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kouloumos",
         "id" : 18506343,
         "login" : "kouloumos",
         "node_id" : "MDQ6VXNlcjE4NTA2MzQz",
         "organizations_url" : "https://api.github.com/users/kouloumos/orgs",
         "received_events_url" : "https://api.github.com/users/kouloumos/received_events",
         "repos_url" : "https://api.github.com/users/kouloumos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kouloumos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kouloumos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kouloumos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24865#discussion_r919893941"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24865"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919893941"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think that this test is not testing what you are expecting it to test, or its scope is just not clear to me.\r\n\r\nEven if I revert your changes to `backup.cpp` (`git checkout 9fb2a2bc6768ab03fcada9155d52a16ce6f6a0cc -- src/wallet/rpc/backup.cpp`) this test passes. My understanding is that this never reaches the prune state because no blocks are pruned until we are above PruneAfterHeight\r\nhttps://github.com/bitcoin/bitcoin/blob/1d89fc695a3aeb3e3dcadf371b7667572b38c836/src/chainparams.cpp#L429\r\nThe logic in `feature_pruning.py` also helped me to understand this behaviour.",
      "commit_id" : "45435bc688387db2fdf0550f48881a8cf60cbe0f",
      "created_at" : "2022-07-13T10:06:20Z",
      "diff_hunk" : "@@ -0,0 +1,117 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+\"\"\"Test wallet import on pruned node.\"\"\"\n+import os\n+\n+from test_framework.util import assert_raises_rpc_error\n+from test_framework.blocktools import create_large_block\n+from test_framework.test_framework import BitcoinTestFramework\n+\n+\n+class WalletPruningTest(BitcoinTestFramework):\n+    nTime = 0\n+    def mine_large_blocks(self, node, n):\n+        # Get the block parameters for the first block\n+        best_block = node.getblock(node.getbestblockhash())\n+        height = int(best_block[\"height\"]) + 1\n+        self.nTime = max(self.nTime, int(best_block[\"time\"])) + 1\n+        previousblockhash = int(best_block[\"hash\"], 16)\n+\n+        for _ in range(n):\n+            block = create_large_block(hashprev=previousblockhash, height=height, ntime=self.nTime)\n+            block.solve()\n+\n+            # Submit to the node\n+            node.submitblock(block.serialize().hex())\n+\n+            previousblockhash = block.sha256\n+            height += 1\n+\n+            # Simulate 10 minutes of work time per block\n+            # Important for matching a timestamp with a block +- some window\n+            self.nTime += 600\n+            for n in self.nodes:\n+                n.setmocktime(self.nTime) # Update nodes' time to accept future blocks\n+\n+\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 2\n+        self.extra_args = [\n+            [], # node dedicated to mining\n+            ['-prune=550'], # node dedicated to testing pruning\n+        ]\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+        self.connect_nodes(0, 1)\n+        self.sync_all(self.nodes)\n+\n+    def create_big_chain(self):\n+        self.log.info(\"Generating a long chain of blocks...\")\n+        # Generate 288 light blocks, the minimum required to stay on disk with prune enabled\n+        self.generate(self.nodes[0], 288, sync_fun=lambda: self.sync_all(self.nodes))\n+\n+        # Generate large blocks to make sure we have enough to test chain pruning\n+        self.mine_large_blocks(self.nodes[0], 610)\n+        self.sync_all(self.nodes)\n+\n+    def wallet_import_pruned_test(self):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24865#discussion_r919893941",
      "id" : 919893941,
      "line" : null,
      "node_id" : "PRRC_kwDOABII58421He1",
      "original_commit_id" : "b45e54bf513c6e33686f4212200f1615dbac8ee4",
      "original_line" : 65,
      "original_position" : 65,
      "original_start_line" : null,
      "path" : "test/functional/wallet_pruning.py",
      "position" : null,
      "pull_request_review_id" : 1036108749,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24865",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919893941/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-13T14:21:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/919893941",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/18506343?v=4",
         "events_url" : "https://api.github.com/users/kouloumos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kouloumos/followers",
         "following_url" : "https://api.github.com/users/kouloumos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kouloumos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kouloumos",
         "id" : 18506343,
         "login" : "kouloumos",
         "node_id" : "MDQ6VXNlcjE4NTA2MzQz",
         "organizations_url" : "https://api.github.com/users/kouloumos/orgs",
         "received_events_url" : "https://api.github.com/users/kouloumos/received_events",
         "repos_url" : "https://api.github.com/users/kouloumos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kouloumos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kouloumos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kouloumos"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thank you for your thorough review @kouloumos !\r\nI believe I have addressed all of your comments.",
      "created_at" : "2022-07-20T07:25:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24865#issuecomment-1189924780",
      "id" : 1189924780,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24865",
      "node_id" : "IC_kwDOABII585G7M-s",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1189924780/reactions"
      },
      "updated_at" : "2022-07-20T07:25:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1189924780",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24865#discussion_r960435782"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24865"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/960435782"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think that at this point we have the required `height` for which we need blocks. Could this change to a more descriptive error message stating that required weight? And maybe \"[...]. Use RPC call getblockchaininfo to determine your pruned height\" as [here](https://github.com/bitcoin/bitcoin/blob/15692e2641592394bdd4da0a7c2d371de8e576dd/src/wallet/rpc/transactions.cpp#L898)?",
      "commit_id" : "45435bc688387db2fdf0550f48881a8cf60cbe0f",
      "created_at" : "2022-09-01T09:37:00Z",
      "diff_hunk" : "@@ -93,6 +93,20 @@ static void RescanWallet(CWallet& wallet, const WalletRescanReserver& reserver,\n     }\n }\n \n+static void EnsureBlockDataFromTime(interfaces::Chain& chain, int64_t timestamp)\n+{\n+    if (!chain.havePruned())\n+        return;\n+\n+    int height{0};\n+    const bool found{chain.findFirstBlockWithTimeAndHeight(timestamp - TIMESTAMP_WINDOW, 0, FoundBlock().height(height))};\n+    const std::optional<int> chainHeight{chain.getHeight()};\n+\n+    if (found && chainHeight && !chain.hasBlocks(chain.getBlockHash(chainHeight.value()), height)) {\n+        throw JSONRPCError(RPC_WALLET_ERROR, \"Pruned blocks required to import keys\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24865#discussion_r960435782",
      "id" : 960435782,
      "line" : 106,
      "node_id" : "PRRC_kwDOABII5845PxZG",
      "original_commit_id" : "45435bc688387db2fdf0550f48881a8cf60cbe0f",
      "original_line" : 106,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/wallet/rpc/backup.cpp",
      "position" : 14,
      "pull_request_review_id" : 1093078818,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24865",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/960435782/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-01T09:37:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/960435782",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/18506343?v=4",
         "events_url" : "https://api.github.com/users/kouloumos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kouloumos/followers",
         "following_url" : "https://api.github.com/users/kouloumos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kouloumos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kouloumos",
         "id" : 18506343,
         "login" : "kouloumos",
         "node_id" : "MDQ6VXNlcjE4NTA2MzQz",
         "organizations_url" : "https://api.github.com/users/kouloumos/orgs",
         "received_events_url" : "https://api.github.com/users/kouloumos/received_events",
         "repos_url" : "https://api.github.com/users/kouloumos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kouloumos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kouloumos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kouloumos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24865#discussion_r962737491"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24865"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962737491"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "thanks, added it",
      "commit_id" : "ea532ba1d44b218db3d8ea5ee6195160c586a49f",
      "created_at" : "2022-09-05T10:11:51Z",
      "diff_hunk" : "@@ -93,6 +93,20 @@ static void RescanWallet(CWallet& wallet, const WalletRescanReserver& reserver,\n     }\n }\n \n+static void EnsureBlockDataFromTime(interfaces::Chain& chain, int64_t timestamp)\n+{\n+    if (!chain.havePruned())\n+        return;\n+\n+    int height{0};\n+    const bool found{chain.findFirstBlockWithTimeAndHeight(timestamp - TIMESTAMP_WINDOW, 0, FoundBlock().height(height))};\n+    const std::optional<int> chainHeight{chain.getHeight()};\n+\n+    if (found && chainHeight && !chain.hasBlocks(chain.getBlockHash(chainHeight.value()), height)) {\n+        throw JSONRPCError(RPC_WALLET_ERROR, \"Pruned blocks required to import keys\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24865#discussion_r962737491",
      "id" : 962737491,
      "in_reply_to_id" : 960435782,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5845YjVT",
      "original_commit_id" : "45435bc688387db2fdf0550f48881a8cf60cbe0f",
      "original_line" : 106,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/wallet/rpc/backup.cpp",
      "position" : null,
      "pull_request_review_id" : 1096213340,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24865",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962737491/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-05T10:11:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/962737491",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   }
]
