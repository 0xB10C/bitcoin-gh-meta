[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "An easy way to reproduce this issue is to:\r\n1. setup a new temp node data directory containing only the `blocks` directory that contains only one 516 byte long file, blk00000.dat\r\n    1. the blk00000.dat file contains\r\n        1. the 8 byte serialization header for the genesis block\r\n        1. the genesis block (blockhash 000000000019d6689c085ae165831e934ff763ae46a2a6c172b3f1b60a8ce26f)\r\n        1. the 8 byte serialization header for block at height 2\r\n        1. the block at height 2 (blockhash 000000006a625f06636b8bb6ac7b960a8d03705d1ace08b1a19da3fdcc99ddbd)\r\n\r\n    in other words:\r\n\r\n    ```\r\n    $ cd /tmp/btc && find .\r\n    .\r\n    ./blocks\r\n    ./blocks/blk00000.dat\r\n    $ sha256sum blocks/blk00000.dat\r\n    713be71e35a2bc25481cc66b465da1e439df1c2570d065fa0aecc11eaecbea94  blocks/blk00000.dat\r\n    $ xxd -g 4 blocks/blk00000.dat\r\n    00000000: f9beb4d9 1d010000 01000000 00000000  ................\r\n    00000010: 00000000 00000000 00000000 00000000  ................\r\n    00000020: 00000000 00000000 00000000 3ba3edfd  ............;...\r\n    00000030: 7a7b12b2 7ac72c3e 67768f61 7fc81bc3  z{..z.,>gv.a....\r\n    00000040: 888a5132 3a9fb8aa 4b1e5e4a 29ab5f49  ..Q2:...K.^J)._I\r\n    00000050: ffff001d 1dac2b7c 01010000 00010000  ......+|........\r\n    00000060: 00000000 00000000 00000000 00000000  ................\r\n    00000070: 00000000 00000000 00000000 0000ffff  ................\r\n    00000080: ffff4d04 ffff001d 01044554 68652054  ..M.......EThe T\r\n    00000090: 696d6573 2030332f 4a616e2f 32303039  imes 03/Jan/2009\r\n    000000a0: 20436861 6e63656c 6c6f7220 6f6e2062   Chancellor on b\r\n    000000b0: 72696e6b 206f6620 7365636f 6e642062  rink of second b\r\n    000000c0: 61696c6f 75742066 6f722062 616e6b73  ailout for banks\r\n    000000d0: ffffffff 0100f205 2a010000 00434104  ........*....CA.\r\n    000000e0: 678afdb0 fe554827 1967f1a6 7130b710  g....UH'.g..q0..\r\n    000000f0: 5cd6a828 e03909a6 7962e0ea 1f61deb6  \\..(.9..yb...a..\r\n    00000100: 49f6bc3f 4cef38c4 f35504e5 1ec112de  I..?L.8..U......\r\n    00000110: 5c384df7 ba0b8d57 8a4c702b 6bf11d5f  \\8M....W.Lp+k.._\r\n    00000120: ac000000 00f9beb4 d9d70000 00010000  ................\r\n    00000130: 004860eb 18bf1b16 20e37e94 90fc8a42  .H`..... .~....B\r\n    00000140: 7514416f d75159ab 86688e9a 83000000  u.Ao.QY..h......\r\n    00000150: 00d5fdcc 541e25de 1c7a5add edf24858  ....T.%..zZ...HX\r\n    00000160: b8bb665c 9f36ef74 4ee42c31 6022c90f  ..f\\.6.tN.,1`\"..\r\n    00000170: 9bb0bc66 49ffff00 1d08d2bd 61010100  ...fI.......a...\r\n    00000180: 00000100 00000000 00000000 00000000  ................\r\n    00000190: 00000000 00000000 00000000 00000000  ................\r\n    000001a0: 000000ff ffffff07 04ffff00 1d010bff  ................\r\n    000001b0: ffffff01 00f2052a 01000000 43410472  .......*....CA.r\r\n    000001c0: 11a824f5 5b505228 e4c3d519 4c1fcfaa  ..$.[PR(....L...\r\n    000001d0: 15a456ab df37f9b9 d97a4040 afc073de  ..V..7...z@@..s.\r\n    000001e0: e6c89064 984f0338 5237d921 67c13e23  ...d.O.8R7.!g.>#\r\n    000001f0: 6446b417 ab79a0fc ae412ae3 316b77ac  dF...y...A*.1kw.\r\n    00000200: 00000000                             ....\r\n    ```\r\n\r\n\r\n1. start the node with the command line similar to: `bitcoin-qt -debug -datadir=/tmp/btc -reindex`\r\n1. wait for header synchronization to finish and you see this in the debug log:\r\n`UpdatedBlockTip: new block hash=00000000839a8e6886ab5951d76f411475428afc90947ee320161bbf18eb6048`\r\n1. shutdown the node\r\n\r\n\r\n\r\nWe setup like this in order to hit the case where an \"Out of order block\" is found during reindexing and it is left disconnected since it's ancestor block at height 1 (blockhash 00000000839a8e6886ab5951d76f411475428afc90947ee320161bbf18eb6048) is not present in the blk00000.dat file for the reindexing process to attach.\r\n\r\nNow, if we examine the blk00000.dat file, we can see that the corruption has occured at offset 0x125 through 0x12c. The serialization header and data for block at height 1 follow at offset 0x12d:\r\n\r\n```\r\n$ xxd -g 4 -l 524 blocks/blk00000.dat\r\n00000000: f9beb4d9 1d010000 01000000 00000000  ................\r\n00000010: 00000000 00000000 00000000 00000000  ................\r\n00000020: 00000000 00000000 00000000 3ba3edfd  ............;...\r\n00000030: 7a7b12b2 7ac72c3e 67768f61 7fc81bc3  z{..z.,>gv.a....\r\n00000040: 888a5132 3a9fb8aa 4b1e5e4a 29ab5f49  ..Q2:...K.^J)._I\r\n00000050: ffff001d 1dac2b7c 01010000 00010000  ......+|........\r\n00000060: 00000000 00000000 00000000 00000000  ................\r\n00000070: 00000000 00000000 00000000 0000ffff  ................\r\n00000080: ffff4d04 ffff001d 01044554 68652054  ..M.......EThe T\r\n00000090: 696d6573 2030332f 4a616e2f 32303039  imes 03/Jan/2009\r\n000000a0: 20436861 6e63656c 6c6f7220 6f6e2062   Chancellor on b\r\n000000b0: 72696e6b 206f6620 7365636f 6e642062  rink of second b\r\n000000c0: 61696c6f 75742066 6f722062 616e6b73  ailout for banks\r\n000000d0: ffffffff 0100f205 2a010000 00434104  ........*....CA.\r\n000000e0: 678afdb0 fe554827 1967f1a6 7130b710  g....UH'.g..q0..\r\n000000f0: 5cd6a828 e03909a6 7962e0ea 1f61deb6  \\..(.9..yb...a..\r\n00000100: 49f6bc3f 4cef38c4 f35504e5 1ec112de  I..?L.8..U......\r\n00000110: 5c384df7 ba0b8d57 8a4c702b 6bf11d5f  \\8M....W.Lp+k.._\r\n00000120: ac000000 00f9beb4 d9d70000 00f9beb4  ................      <----- offset 0x125 through 0x12c demonstrate the incorrect offset calculated by the reindexing process. those bytes are from the original data that was already in the file and were erroneously not overwritten due to the bad offset.\r\n00000130: d9d70000 00010000 006fe28c 0ab6f1b3  .........o......\r\n00000140: 72c1a6a2 46ae63f7 4f931e83 65e15a08  r...F.c.O...e.Z.\r\n00000150: 9c68d619 00000000 00982051 fd1e4ba7  .h........ Q..K.\r\n00000160: 44bbbe68 0e1fee14 677ba1a3 c3540bf7  D..h....g{...T..\r\n00000170: b1cdb606 e857233e 0e61bc66 49ffff00  .....W#>.a.fI...\r\n00000180: 1d01e362 99010100 00000100 00000000  ...b............\r\n00000190: 00000000 00000000 00000000 00000000  ................\r\n000001a0: 00000000 00000000 000000ff ffffff07  ................\r\n000001b0: 04ffff00 1d0104ff ffffff01 00f2052a  ...............*\r\n000001c0: 01000000 43410496 b538e853 519c726a  ....CA...8.SQ.rj\r\n000001d0: 2c91e61e c11600ae 1390813a 627c66fb  ,..........:b|f.\r\n000001e0: 8be7947b e63c52da 75893795 15d4e0a6  ...{.<R.u.7.....\r\n000001f0: 04f81417 81e62294 721166bf 621e73a8  ......\".r.f.b.s.\r\n00000200: 2cbf2342 c858eeac 00000000           ,.#B.X......\r\n```\r\n1. If we now restart the node with the same command line as before, `bitcoin-qt -debug -datadir=/tmp/btc -reindex` we will soon see a message in the debug.log like:\r\n`LoadExternalBlockFile: Deserialize or I/O error - ReadCompactSize(): size too large: iostream error`",
      "created_at" : "2022-04-15T02:16:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#issuecomment-1099788622",
      "id" : 1099788622,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24858",
      "node_id" : "IC_kwDOABII585BjXFO",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1099788622/reactions"
      },
      "updated_at" : "2022-04-15T02:21:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1099788622",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "ØªØºÙØ± Ø§ÙÙÙÙØ§Øª",
      "created_at" : "2022-04-15T04:57:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#issuecomment-1099849383",
      "id" : 1099849383,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24858",
      "node_id" : "IC_kwDOABII585Bjl6n",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1099849383/reactions"
      },
      "updated_at" : "2022-04-15T04:57:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1099849383",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/101409499?v=4",
         "events_url" : "https://api.github.com/users/samahanas/events{/privacy}",
         "followers_url" : "https://api.github.com/users/samahanas/followers",
         "following_url" : "https://api.github.com/users/samahanas/following{/other_user}",
         "gists_url" : "https://api.github.com/users/samahanas/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/samahanas",
         "id" : 101409499,
         "login" : "samahanas",
         "node_id" : "U_kgDOBgti2w",
         "organizations_url" : "https://api.github.com/users/samahanas/orgs",
         "received_events_url" : "https://api.github.com/users/samahanas/received_events",
         "repos_url" : "https://api.github.com/users/samahanas/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/samahanas/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/samahanas/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/samahanas"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Attached here is the blk00000.dat file with sha256sum of\r\n`713be71e35a2bc25481cc66b465da1e439df1c2570d065fa0aecc11eaecbea94` used by my easy reproduction comment above https://github.com/bitcoin/bitcoin/pull/24858#issuecomment-1099788622. \r\n\r\nSimply remove the \".txt\" file extension that I had to add in order to upload it here.\r\n\r\n[blk00000.dat.txt](https://github.com/bitcoin/bitcoin/files/8495215/blk00000.dat.txt)\r\n",
      "created_at" : "2022-04-15T09:39:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#issuecomment-1100000135",
      "id" : 1100000135,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24858",
      "node_id" : "IC_kwDOABII585BkKuH",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1100000135/reactions"
      },
      "updated_at" : "2022-04-15T09:39:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1100000135",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "noting for historical purposes that this updates a fix made by https://github.com/bitcoin/bitcoin/pull/5864 @theuni",
      "created_at" : "2022-04-18T12:54:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#issuecomment-1101385689",
      "id" : 1101385689,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24858",
      "node_id" : "IC_kwDOABII585Bpc_Z",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1101385689/reactions"
      },
      "updated_at" : "2022-04-18T12:54:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1101385689",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK, will review this week.",
      "created_at" : "2022-04-18T15:26:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#issuecomment-1101497557",
      "id" : 1101497557,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24858",
      "node_id" : "IC_kwDOABII585Bp4TV",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1101497557/reactions"
      },
      "updated_at" : "2022-04-18T15:26:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1101497557",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r852467662"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852467662"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think an alternative fix would be to have two distinct calls to `FindBlockPos` in `BlockManager::SaveBlockToDisk` conditional on whether `dbp == nullptr` (not adding 8 to nAddSize parameter if that is the case). Maybe that would be a little bit clearer than adding and substracting 8.\r\n\r\nIn general, such a high percentage of code in  `FindBlockPos()` is conditional on `fKnown` or `!fKnown` that I wonder whether it would make sense to refactor this into two separate functions (not here, but as a possible follow-up).",
      "commit_id" : "2da96174b95831c374b2452657c431254fea8e53",
      "created_at" : "2022-04-18T22:54:06Z",
      "diff_hunk" : "@@ -611,7 +611,12 @@ bool BlockManager::FindBlockPos(FlatFilePos& pos, unsigned int nAddSize, unsigne\n \n     m_blockfile_info[nFile].AddBlock(nHeight, nTime);\n     if (fKnown) {\n-        m_blockfile_info[nFile].nSize = std::max(pos.nPos + nAddSize, m_blockfile_info[nFile].nSize);\n+        // pos.nPos points at the offset of the block data in the blk file. that already accounts for\n+        // the serialization header present in the file (the 4 magic message start bytes + the 4 length bytes = 8 bytes).\n+        // nAddSize already has 8 added to it too. we subtract 8 to avoid over accounting for the serialization\n+        // header. such over accounting was a long standing bug that added undesirable 8 byte gaps into blk data files following\n+        // a -reindex operation. for more info, see https://github.com/bitcoin/bitcoin/issues/21379\n+        m_blockfile_info[nFile].nSize = std::max(pos.nPos + nAddSize - 8, m_blockfile_info[nFile].nSize);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r852467662",
      "id" : 852467662,
      "line" : 619,
      "node_id" : "PRRC_kwDOABII584yz5_O",
      "original_commit_id" : "2da96174b95831c374b2452657c431254fea8e53",
      "original_line" : 619,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 10,
      "pull_request_review_id" : 944897633,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852467662/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-18T23:12:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852467662",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r852467981"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852467981"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: remove 2011- , it's new",
      "commit_id" : "2da96174b95831c374b2452657c431254fea8e53",
      "created_at" : "2022-04-18T22:54:54Z",
      "diff_hunk" : "@@ -0,0 +1,40 @@\n+// Copyright (c) 2011-2022 The Bitcoin Core developers",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r852467981",
      "id" : 852467981,
      "line" : 1,
      "node_id" : "PRRC_kwDOABII584yz6EN",
      "original_commit_id" : "2da96174b95831c374b2452657c431254fea8e53",
      "original_line" : 1,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/test/blockmanager_tests.cpp",
      "position" : 1,
      "pull_request_review_id" : 944897633,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852467981/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-18T23:11:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852467981",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r852471681"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852471681"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I wonder whether it might be better to keep this an unconditional log, so that there is a higher chance of getting reports such as the one in #21379.\r\nI think the expectation is that it shouldn't be possible to get this warning (unless there is actual disk corruption) after this PR, unless you have an existing datadir that is already slightly corrupted by past reindexes.",
      "commit_id" : "2da96174b95831c374b2452657c431254fea8e53",
      "created_at" : "2022-04-18T23:04:19Z",
      "diff_hunk" : "@@ -4356,7 +4356,18 @@ void CChainState::LoadExternalBlockFile(FILE* fileIn, FlatFilePos* dbp)\n                     }\n                 }\n             } catch (const std::exception& e) {\n-                LogPrintf(\"%s: Deserialize or I/O error - %s\\n\", __func__, e.what());\n+                // historical bugs added extra data to the block files that does not deserialize cleanly.\n+                // commonly this data is between readable blocks, but it does not really matter. such data is not fatal to the import process.\n+                // the code that reads the block files deals with invalid data by simply ignoring it.\n+                // it continues to search for the next {4 byte magic message start bytes + 4 byte length + block} that does deserialize cleanly\n+                // and passes all of the other block validation checks dealing with POW and the merkle root, etc...\n+                // we merely note with this informational log message when unexpected data is encountered.\n+                // we could also be experiencing a storage system read error, or a read of a previous bad write. these are possible, but\n+                // less likely scenarios. we don't have enough information to tell a difference here.\n+                // the reindex process is not the place to attempt to clean and/or compact the block files. if so desired, a studious node operator\n+                // may use knowledge of the fact that the block files are not entirely pristine in order to prepare a set of pristine, and\n+                // perhaps ordered, block files for later reindexing.\n+                LogPrint(BCLog::REINDEX, \"%s: unexpected data at file offset 0x%x - %s. continuing\\n\", __func__, (nRewind - 1), e.what());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r852471681",
      "id" : 852471681,
      "line" : 4370,
      "node_id" : "PRRC_kwDOABII584yz6-B",
      "original_commit_id" : "2da96174b95831c374b2452657c431254fea8e53",
      "original_line" : 4370,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 16,
      "pull_request_review_id" : 944897633,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852471681/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-18T23:11:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852471681",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r852491726"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852491726"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for the review!\r\n\r\nI resonate with what you said about not subtracting 8 within `BlockManager::FindBlockPos` for code clarity. Subtracting 8 was just the first simplest fix that I thought of.\r\n\r\nBuilding off of your idea, instead of making two different calls, we could get the same effect by doing something like the following in `BlockManager::SaveBlockToDisk`:\r\n\r\n```\r\n    const auto position_known = dbp != nullptr;\r\n    const auto additional_size = nBlockSize + (position_known ? 0 : 8);\r\n    if (!FindBlockPos(blockPos, additional_size, nHeight, active_chain, block.GetBlockTime(), position_known)) {\r\n```",
      "commit_id" : "2da96174b95831c374b2452657c431254fea8e53",
      "created_at" : "2022-04-18T23:57:25Z",
      "diff_hunk" : "@@ -611,7 +611,12 @@ bool BlockManager::FindBlockPos(FlatFilePos& pos, unsigned int nAddSize, unsigne\n \n     m_blockfile_info[nFile].AddBlock(nHeight, nTime);\n     if (fKnown) {\n-        m_blockfile_info[nFile].nSize = std::max(pos.nPos + nAddSize, m_blockfile_info[nFile].nSize);\n+        // pos.nPos points at the offset of the block data in the blk file. that already accounts for\n+        // the serialization header present in the file (the 4 magic message start bytes + the 4 length bytes = 8 bytes).\n+        // nAddSize already has 8 added to it too. we subtract 8 to avoid over accounting for the serialization\n+        // header. such over accounting was a long standing bug that added undesirable 8 byte gaps into blk data files following\n+        // a -reindex operation. for more info, see https://github.com/bitcoin/bitcoin/issues/21379\n+        m_blockfile_info[nFile].nSize = std::max(pos.nPos + nAddSize - 8, m_blockfile_info[nFile].nSize);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r852491726",
      "id" : 852491726,
      "in_reply_to_id" : 852467662,
      "line" : 619,
      "node_id" : "PRRC_kwDOABII584yz_3O",
      "original_commit_id" : "2da96174b95831c374b2452657c431254fea8e53",
      "original_line" : 619,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 10,
      "pull_request_review_id" : 944926396,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852491726/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-18T23:57:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852491726",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r852492114"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852492114"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "ok, i will update when i update the commit along with updates from the other comments",
      "commit_id" : "2da96174b95831c374b2452657c431254fea8e53",
      "created_at" : "2022-04-18T23:58:28Z",
      "diff_hunk" : "@@ -0,0 +1,40 @@\n+// Copyright (c) 2011-2022 The Bitcoin Core developers",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r852492114",
      "id" : 852492114,
      "in_reply_to_id" : 852467981,
      "line" : 1,
      "node_id" : "PRRC_kwDOABII584yz_9S",
      "original_commit_id" : "2da96174b95831c374b2452657c431254fea8e53",
      "original_line" : 1,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/test/blockmanager_tests.cpp",
      "position" : 1,
      "pull_request_review_id" : 944926830,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852492114/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-18T23:58:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852492114",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r852496122"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852496122"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I did consider keeping this log message unconditional. I think we'd get a fair number of false positive reports if we leave this scary log message as it was. This bug has been around for about 7 years, and maybe more if you count the bugs that the last fix tried to handle. So, there are probably a lot of blk files that have been _recoverably_ corrupted (i.e. corrupted in a way that is still processable). To me, it's more of a notification for a concerned node operator that really cares about having a clean set of blk files. The new message gives the exact offset to go look, and maybe edit the file, if you really want to. But, The existing message doesn't really do much to help the operator. It kind of just scares them, even though the processing goes on. Maybe there is a balance that we need to hit. But, I'm not sure what that looks like besides this right now.",
      "commit_id" : "66b8d3c23d999651c79ac03e7558d4248a200ba1",
      "created_at" : "2022-04-19T00:10:35Z",
      "diff_hunk" : "@@ -4356,7 +4356,18 @@ void CChainState::LoadExternalBlockFile(FILE* fileIn, FlatFilePos* dbp)\n                     }\n                 }\n             } catch (const std::exception& e) {\n-                LogPrintf(\"%s: Deserialize or I/O error - %s\\n\", __func__, e.what());\n+                // historical bugs added extra data to the block files that does not deserialize cleanly.\n+                // commonly this data is between readable blocks, but it does not really matter. such data is not fatal to the import process.\n+                // the code that reads the block files deals with invalid data by simply ignoring it.\n+                // it continues to search for the next {4 byte magic message start bytes + 4 byte length + block} that does deserialize cleanly\n+                // and passes all of the other block validation checks dealing with POW and the merkle root, etc...\n+                // we merely note with this informational log message when unexpected data is encountered.\n+                // we could also be experiencing a storage system read error, or a read of a previous bad write. these are possible, but\n+                // less likely scenarios. we don't have enough information to tell a difference here.\n+                // the reindex process is not the place to attempt to clean and/or compact the block files. if so desired, a studious node operator\n+                // may use knowledge of the fact that the block files are not entirely pristine in order to prepare a set of pristine, and\n+                // perhaps ordered, block files for later reindexing.\n+                LogPrint(BCLog::REINDEX, \"%s: unexpected data at file offset 0x%x - %s. continuing\\n\", __func__, (nRewind - 1), e.what());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r852496122",
      "id" : 852496122,
      "in_reply_to_id" : 852471681,
      "line" : 4370,
      "node_id" : "PRRC_kwDOABII584y0A76",
      "original_commit_id" : "2da96174b95831c374b2452657c431254fea8e53",
      "original_line" : 4370,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 16,
      "pull_request_review_id" : 944931964,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852496122/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-19T00:10:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852496122",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r852532300"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852532300"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "made updates for this in 66b8d3c23d999651c79ac03e7558d4248a200ba1",
      "commit_id" : "66b8d3c23d999651c79ac03e7558d4248a200ba1",
      "created_at" : "2022-04-19T01:58:10Z",
      "diff_hunk" : "@@ -611,7 +611,12 @@ bool BlockManager::FindBlockPos(FlatFilePos& pos, unsigned int nAddSize, unsigne\n \n     m_blockfile_info[nFile].AddBlock(nHeight, nTime);\n     if (fKnown) {\n-        m_blockfile_info[nFile].nSize = std::max(pos.nPos + nAddSize, m_blockfile_info[nFile].nSize);\n+        // pos.nPos points at the offset of the block data in the blk file. that already accounts for\n+        // the serialization header present in the file (the 4 magic message start bytes + the 4 length bytes = 8 bytes).\n+        // nAddSize already has 8 added to it too. we subtract 8 to avoid over accounting for the serialization\n+        // header. such over accounting was a long standing bug that added undesirable 8 byte gaps into blk data files following\n+        // a -reindex operation. for more info, see https://github.com/bitcoin/bitcoin/issues/21379\n+        m_blockfile_info[nFile].nSize = std::max(pos.nPos + nAddSize - 8, m_blockfile_info[nFile].nSize);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24858#discussion_r852532300",
      "id" : 852532300,
      "in_reply_to_id" : 852467662,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584y0JxM",
      "original_commit_id" : "2da96174b95831c374b2452657c431254fea8e53",
      "original_line" : 619,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 944976204,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24858",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852532300/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-19T01:58:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852532300",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6440430?v=4",
         "events_url" : "https://api.github.com/users/mruddy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mruddy/followers",
         "following_url" : "https://api.github.com/users/mruddy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mruddy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mruddy",
         "id" : 6440430,
         "login" : "mruddy",
         "node_id" : "MDQ6VXNlcjY0NDA0MzA=",
         "organizations_url" : "https://api.github.com/users/mruddy/orgs",
         "received_events_url" : "https://api.github.com/users/mruddy/received_events",
         "repos_url" : "https://api.github.com/users/mruddy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mruddy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mruddy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mruddy"
      }
   }
]
