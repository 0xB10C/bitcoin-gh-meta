[
   {
      "body" : "Doesn't exploiting this require you to have the private key in question yourself...?",
      "created_at" : "2013-01-14T17:16:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/2178#issuecomment-12228733",
      "id" : 12228733,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2178",
      "updated_at" : "2013-01-14T17:16:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/12228733",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "body" : "No. \r\nAnyone that can connect to you can check if you're the owner of a wallet address. Even if all the outputs of the address in question have been spent, there is a modification of the disclosed attack that can be used to check if you owned that address, as long as you keep the keypair in your wallet.\r\nMaybe my post was not clear enough.",
      "created_at" : "2013-01-14T17:30:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/2178#issuecomment-12229440",
      "id" : 12229440,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2178",
      "updated_at" : "2013-01-14T17:30:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/12229440",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1752347?v=3",
         "events_url" : "https://api.github.com/users/SergioDemianLerner/events{/privacy}",
         "followers_url" : "https://api.github.com/users/SergioDemianLerner/followers",
         "following_url" : "https://api.github.com/users/SergioDemianLerner/following{/other_user}",
         "gists_url" : "https://api.github.com/users/SergioDemianLerner/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/SergioDemianLerner",
         "id" : 1752347,
         "login" : "SergioDemianLerner",
         "organizations_url" : "https://api.github.com/users/SergioDemianLerner/orgs",
         "received_events_url" : "https://api.github.com/users/SergioDemianLerner/received_events",
         "repos_url" : "https://api.github.com/users/SergioDemianLerner/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/SergioDemianLerner/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/SergioDemianLerner/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/SergioDemianLerner"
      }
   },
   {
      "body" : "Thanks Sergio, I was about to start working on a patch for this.  Is that the only place in the receive-a-tx-from-the-network callchain where network behavior is different for \"my\" transactions than other-people's transactions?\r\n",
      "created_at" : "2013-01-14T17:46:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/2178#issuecomment-12230181",
      "id" : 12230181,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2178",
      "updated_at" : "2013-01-14T17:46:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/12230181",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "body" : "Is far as I can see, that's the only place IsFromMe() is used in the whole main.cpp file.\r\n\r\nI don't understand how own transactions are handled in SendMessages() (see comment \"always trickle our own transactions\"). Maybe there could be a problem there. I don't know.\r\n\r\nNevertheless it could be possible to achieve the same attack via a timing attack using SyncWithWallets() as an oracle.\r\nIt is called just after tx.AcceptToMemoryPool(). An attacker could try to measure how much time  SyncWithWallets() takes by sending a \"ping\" right after a transaction.\r\n\r\nI really don't know if this last attack is practical.  \r\n\r\nBut SyncWithWallets() does a lot of things that could take measurable time:\r\n1- Loops over all user wallets ( SyncWithWallets())\r\n2- Loops over mapWallet (CWallet::OrderedTxItems())\r\n3- Loops over CAccountingEntry entries..(CWallet::AddToWallet())\r\n4 -Loops over all transaction outputs.(CWallet::AddToWallet())\r\n5- Loops over all transaction inputs (WalletUpdateSpent())\r\n\r\nThere are too many cases to analyze one by one for me now, and two loops that the attacker could control the number of executions. It would be a good idea to measure the time SyncWithWallets()  takes per previn/prevout/waller/etc.\r\nIf the measurements show that it can take over 10 msec  then we could have an attack vector.\r\n\r\nIt would be better to detach SyncWithWallets() and execute the method in a different thread in order to prevent to attack more or less \"by design\". \r\nNevertheless, the attacker could still try to measure the responsiveness of the peer and detect background processing even if  SyncWithWallets() runs in another thread. But IMHO trying to protect oneself from this last attack would be a bit paranoic, \r\n\r\n\r\n",
      "created_at" : "2013-01-14T18:40:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/2178#issuecomment-12232870",
      "id" : 12232870,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2178",
      "updated_at" : "2013-01-14T18:42:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/12232870",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1752347?v=3",
         "events_url" : "https://api.github.com/users/SergioDemianLerner/events{/privacy}",
         "followers_url" : "https://api.github.com/users/SergioDemianLerner/followers",
         "following_url" : "https://api.github.com/users/SergioDemianLerner/following{/other_user}",
         "gists_url" : "https://api.github.com/users/SergioDemianLerner/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/SergioDemianLerner",
         "id" : 1752347,
         "login" : "SergioDemianLerner",
         "organizations_url" : "https://api.github.com/users/SergioDemianLerner/orgs",
         "received_events_url" : "https://api.github.com/users/SergioDemianLerner/received_events",
         "repos_url" : "https://api.github.com/users/SergioDemianLerner/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/SergioDemianLerner/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/SergioDemianLerner/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/SergioDemianLerner"
      }
   },
   {
      "body" : " This source code looks interesting... it could be the source of another DoS vuln...\r\n\r\nbool CWallet::AddToWallet(const CWalletTx& wtxIn)\r\n{\r\n ... something ... \r\n#ifndef QT_GUI\r\n        // If default receiving address gets used, replace it with a new one\r\n        CScript scriptDefaultKey;\r\n        scriptDefaultKey.SetDestination(vchDefaultKey.GetID());\r\n        BOOST_FOREACH(const CTxOut& txout, wtx.vout)\r\n        {\r\n            if (txout.scriptPubKey == scriptDefaultKey)\r\n            {\r\n                CPubKey newDefaultKey;\r\n                if (GetKeyFromPool(newDefaultKey, false))\r\n                {\r\n                    SetDefaultKey(newDefaultKey);\r\n                    SetAddressBookName(vchDefaultKey.GetID(), \"\");\r\n                }\r\n            }\r\n        }\r\n#endif\r\n\r\nThe code extracts (and probably generates) a new key from the key pool each time we get a txout with certain script. An attacker could construct a transaction with thousands of outputs similar to scriptDefaultKey, sending 1 satoshi to each one, and force the client app to generate 1000 new keypairs. \r\n(Note that scriptDefaultKey is not updated in the inner loop)\r\n\r\nIt would also bloats the size of the user wallet files and provides still another timing attack (this time much more easy) to discover which is the user's default public key.\r\n\r\nSo Jackpot!  4 attacks in one!\r\nMemory exhaustion, CPU exhaustion,  hard disk space exhaustion, and loss of anonymity. \r\n",
      "created_at" : "2013-01-14T19:20:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/2178#issuecomment-12234760",
      "id" : 12234760,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2178",
      "updated_at" : "2013-01-14T20:42:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/12234760",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1752347?v=3",
         "events_url" : "https://api.github.com/users/SergioDemianLerner/events{/privacy}",
         "followers_url" : "https://api.github.com/users/SergioDemianLerner/followers",
         "following_url" : "https://api.github.com/users/SergioDemianLerner/following{/other_user}",
         "gists_url" : "https://api.github.com/users/SergioDemianLerner/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/SergioDemianLerner",
         "id" : 1752347,
         "login" : "SergioDemianLerner",
         "organizations_url" : "https://api.github.com/users/SergioDemianLerner/orgs",
         "received_events_url" : "https://api.github.com/users/SergioDemianLerner/received_events",
         "repos_url" : "https://api.github.com/users/SergioDemianLerner/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/SergioDemianLerner/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/SergioDemianLerner/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/SergioDemianLerner"
      }
   },
   {
      "body" : "No.\r\n\r\nThere is no way for the attacker to know what your default key is, unless you tell them. They cannot find it by sending transactions to random addresses, there are 2**160 addresses.\r\n\r\nIf you do tell them, then yes, they can make you generate a new default key by sending bitcoins to that address. The new default key will be random, and so IT is not guessable unless you tell them.\r\n",
      "created_at" : "2013-01-14T19:26:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/2178#issuecomment-12235022",
      "id" : 12235022,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2178",
      "updated_at" : "2013-01-14T19:26:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/12235022",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "body" : "Pardon. What exactly is the \"default key\" ? \r\nIf you used that key once, then an attacker can try all possible existent keys in the blockchain until he hits your default key.",
      "created_at" : "2013-01-14T20:31:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/2178#issuecomment-12238131",
      "id" : 12238131,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2178",
      "updated_at" : "2013-01-14T20:35:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/12238131",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1752347?v=3",
         "events_url" : "https://api.github.com/users/SergioDemianLerner/events{/privacy}",
         "followers_url" : "https://api.github.com/users/SergioDemianLerner/followers",
         "following_url" : "https://api.github.com/users/SergioDemianLerner/following{/other_user}",
         "gists_url" : "https://api.github.com/users/SergioDemianLerner/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/SergioDemianLerner",
         "id" : 1752347,
         "login" : "SergioDemianLerner",
         "organizations_url" : "https://api.github.com/users/SergioDemianLerner/orgs",
         "received_events_url" : "https://api.github.com/users/SergioDemianLerner/received_events",
         "repos_url" : "https://api.github.com/users/SergioDemianLerner/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/SergioDemianLerner/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/SergioDemianLerner/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/SergioDemianLerner"
      }
   },
   {
      "body" : "There are around 1M unique addresses in the block chain. They can all be tested against \"if (txout.scriptPubKey == scriptDefaultKey)\" very quickly.",
      "created_at" : "2013-01-14T20:37:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/2178#issuecomment-12238413",
      "id" : 12238413,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2178",
      "updated_at" : "2013-01-14T20:37:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/12238413",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1752347?v=3",
         "events_url" : "https://api.github.com/users/SergioDemianLerner/events{/privacy}",
         "followers_url" : "https://api.github.com/users/SergioDemianLerner/followers",
         "following_url" : "https://api.github.com/users/SergioDemianLerner/following{/other_user}",
         "gists_url" : "https://api.github.com/users/SergioDemianLerner/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/SergioDemianLerner",
         "id" : 1752347,
         "login" : "SergioDemianLerner",
         "organizations_url" : "https://api.github.com/users/SergioDemianLerner/orgs",
         "received_events_url" : "https://api.github.com/users/SergioDemianLerner/received_events",
         "repos_url" : "https://api.github.com/users/SergioDemianLerner/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/SergioDemianLerner/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/SergioDemianLerner/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/SergioDemianLerner"
      }
   },
   {
      "body" : "And per the code you showed above, the default address is changed as soon as a transaction is received to it. So, typically, there will not be any transaction to a default address.",
      "created_at" : "2013-01-14T20:38:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/2178#issuecomment-12238484",
      "id" : 12238484,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2178",
      "updated_at" : "2013-01-14T20:38:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/12238484",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "The point is that scriptDefaultKey is not updated in the inner loop even if is changing. So the same address can be stored in 10K prevouts, and tested at the same time, amplifying an time deviation 10K times.\r\nA 1 msec deviation will result in a 10 seconds delay.\r\n\r\n",
      "created_at" : "2013-01-14T20:40:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/2178#issuecomment-12238582",
      "id" : 12238582,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2178",
      "updated_at" : "2013-01-14T20:40:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/12238582",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1752347?v=3",
         "events_url" : "https://api.github.com/users/SergioDemianLerner/events{/privacy}",
         "followers_url" : "https://api.github.com/users/SergioDemianLerner/followers",
         "following_url" : "https://api.github.com/users/SergioDemianLerner/following{/other_user}",
         "gists_url" : "https://api.github.com/users/SergioDemianLerner/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/SergioDemianLerner",
         "id" : 1752347,
         "login" : "SergioDemianLerner",
         "organizations_url" : "https://api.github.com/users/SergioDemianLerner/orgs",
         "received_events_url" : "https://api.github.com/users/SergioDemianLerner/received_events",
         "repos_url" : "https://api.github.com/users/SergioDemianLerner/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/SergioDemianLerner/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/SergioDemianLerner/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/SergioDemianLerner"
      }
   },
   {
      "body" : "Good code:\r\nBOOST_FOREACH(const CTxOut& txout, wtx.vout)\r\n{\r\nif (txout.scriptPubKey == scriptDefaultKey)\r\n{\r\nCPubKey newDefaultKey;\r\nif (GetKeyFromPool(newDefaultKey, false))\r\n{\r\nSetDefaultKey(newDefaultKey);\r\nSetAddressBookName(vchDefaultKey.GetID(), \"\");\r\nscriptDefaultKey.SetDestination(vchDefaultKey.GetID());  <--- this line must be added?\r\n}\r\n}\r\n}",
      "created_at" : "2013-01-14T20:42:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/2178#issuecomment-12238658",
      "id" : 12238658,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2178",
      "updated_at" : "2013-01-14T20:42:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/12238658",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1752347?v=3",
         "events_url" : "https://api.github.com/users/SergioDemianLerner/events{/privacy}",
         "followers_url" : "https://api.github.com/users/SergioDemianLerner/followers",
         "following_url" : "https://api.github.com/users/SergioDemianLerner/following{/other_user}",
         "gists_url" : "https://api.github.com/users/SergioDemianLerner/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/SergioDemianLerner",
         "id" : 1752347,
         "login" : "SergioDemianLerner",
         "organizations_url" : "https://api.github.com/users/SergioDemianLerner/orgs",
         "received_events_url" : "https://api.github.com/users/SergioDemianLerner/received_events",
         "repos_url" : "https://api.github.com/users/SergioDemianLerner/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/SergioDemianLerner/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/SergioDemianLerner/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/SergioDemianLerner"
      }
   },
   {
      "body" : "Now I see. Yes, you're right @SergioDemianLerner. That line would prevent the amplication. It's still something that's hard to exploit nonetheless, IMHO.",
      "created_at" : "2013-01-14T20:43:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/2178#issuecomment-12238705",
      "id" : 12238705,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2178",
      "updated_at" : "2013-01-14T20:43:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/12238705",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Adding that line is a good idea.\r\n\r\nTwo things on the top of my TODO list right now:\r\n\r\n1) Fix the IsMine() check in the penny-flooding-check code\r\n\r\n2) Do not add dust-spam transactions from other people to the wallet (avoids all sorts of wallet-bloating attacks).\r\n\r\n(2) needs some thought, though, and may make SatoshiDice customers unhappy.\r\n",
      "created_at" : "2013-01-14T20:47:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/2178#issuecomment-12238880",
      "id" : 12238880,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2178",
      "updated_at" : "2013-01-14T20:47:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/12238880",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "body" : "@gavinandresen about 2): WHAT? and let those fill up everyone's UTXO sets forever?",
      "created_at" : "2013-01-14T20:49:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/2178#issuecomment-12238955",
      "id" : 12238955,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2178",
      "updated_at" : "2013-01-14T20:49:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/12238955",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "@sipa The UTXO bloat can be addressed by only including them when confirmed. The penny flood breaking things can be addressed by excluding the dust in the primary coin selection but then adding them back into transactions with change as a post-processing step. ... but the incentivize the latter we need a different priority rule.",
      "created_at" : "2013-01-14T20:51:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/2178#issuecomment-12239032",
      "id" : 12239032,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2178",
      "updated_at" : "2013-01-14T20:51:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/12239032",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "@gmaxwell Excluding them from the coin selection process is very different from not adding them to the wallet.",
      "created_at" : "2013-01-14T20:56:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/2178#issuecomment-12239243",
      "id" : 12239243,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2178",
      "updated_at" : "2013-01-14T20:56:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/12239243",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "(regarding the exploitness of the previous vuln)\r\nIt takes only 24 days, sending transactions a full 50 kbytes/sec bandwidth to test for 1M addresses (with amplification 50x) in order to discover a single default key. If generating a new keypair takes 2 msec, 50x amplification requires the attacker to be able to remotely detect an additional 100 msec from a normal round-trip delay of a message, which seems possible..\r\nSo this attack is much worse than the timing attack I published a couple of days ago (14 minutes vs 24 days)\r\n\r\nNevertheless, if we monitor all the output transactions of a peer, then we probably don't need to test for the 1M existent addresses but for only each new address we watch going out of the peer, then the attack becomes completely realistic.\r\n\r\nFor each new address we see, it takes only 35 milliseconds to check if it was the default key that was used!",
      "created_at" : "2013-01-14T21:17:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/2178#issuecomment-12240222",
      "id" : 12240222,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2178",
      "updated_at" : "2013-01-14T21:17:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/12240222",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1752347?v=3",
         "events_url" : "https://api.github.com/users/SergioDemianLerner/events{/privacy}",
         "followers_url" : "https://api.github.com/users/SergioDemianLerner/followers",
         "following_url" : "https://api.github.com/users/SergioDemianLerner/following{/other_user}",
         "gists_url" : "https://api.github.com/users/SergioDemianLerner/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/SergioDemianLerner",
         "id" : 1752347,
         "login" : "SergioDemianLerner",
         "organizations_url" : "https://api.github.com/users/SergioDemianLerner/orgs",
         "received_events_url" : "https://api.github.com/users/SergioDemianLerner/received_events",
         "repos_url" : "https://api.github.com/users/SergioDemianLerner/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/SergioDemianLerner/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/SergioDemianLerner/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/SergioDemianLerner"
      }
   },
   {
      "body" : "@SergioDemianLerner : the default key is generated randomly (because keypool keys are generated randomly).\r\n\r\nIf there are ever bitcoins sent to it (thereby revealing it in the blockchain), then it is changed. That is what this code does.\r\n\r\nSo, again, unless you tell the attacker what your default key is, there is no vulnerability. You would have to send 2**159 transactions on average to guess a default key.\r\n",
      "created_at" : "2013-01-14T21:32:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/2178#issuecomment-12240900",
      "id" : 12240900,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2178",
      "updated_at" : "2013-01-14T21:32:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/12240900",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "body" : "Ok. Thanks Gavin. I didn't know that.\r\nIn  CWallet::CommitTransaction() first AddToWallet() is called and then wtxNew.AcceptToMemoryPool() is called, so there should be not even a window of time for an attack.\r\n\r\nSorry!\r\n",
      "created_at" : "2013-01-14T21:38:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/2178#issuecomment-12241181",
      "id" : 12241181,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2178",
      "updated_at" : "2013-01-14T21:38:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/12241181",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1752347?v=3",
         "events_url" : "https://api.github.com/users/SergioDemianLerner/events{/privacy}",
         "followers_url" : "https://api.github.com/users/SergioDemianLerner/followers",
         "following_url" : "https://api.github.com/users/SergioDemianLerner/following{/other_user}",
         "gists_url" : "https://api.github.com/users/SergioDemianLerner/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/SergioDemianLerner",
         "id" : 1752347,
         "login" : "SergioDemianLerner",
         "organizations_url" : "https://api.github.com/users/SergioDemianLerner/orgs",
         "received_events_url" : "https://api.github.com/users/SergioDemianLerner/received_events",
         "repos_url" : "https://api.github.com/users/SergioDemianLerner/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/SergioDemianLerner/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/SergioDemianLerner/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/SergioDemianLerner"
      }
   },
   {
      "body" : "Aside: Does anyone even use this default key, or can it be deprecated? I\nremoved the functionality in bitcoin-qt because users were annoyed and\nconfused that adresses were automatically being created.",
      "created_at" : "2013-01-15T09:57:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/2178#issuecomment-12259926",
      "id" : 12259926,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2178",
      "updated_at" : "2013-01-15T09:57:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/12259926",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "I went back to the source code to see if  SyncWithWallets() could be used as an oracle for transactions with IsMine()=true.\r\nI found that the only two timing differences from a transaction sent to me over another not sent to me are:\r\n\r\n1. wtx.WriteToDisk() in CWallet::AddToWallet()\r\n\r\nI haven't measured how much it takes to write to the WalletDB a 1 Mbyte tx, but its seems that the BerkleyDB has now the DB_TXN_WRITE_NOSYNC flag set, so it won't try to sync.\r\n(a 1 Mbyte sync takes 50 msec aproximately in my computer, which can be detected from a peer). \r\n\r\nNevertheless, if the wallet becomes constantly modified, then the backup thread  (BackupWallet) that runs every 100 msec, may lock the DB for a noticeable time (say more than 100 msec), and so this could theoretically be detected from a peer. Can anyone research on this? My understanding of the WallletDB -> CDB interface is very limited.\r\n\r\n2. BOOST_FOREACH(const CTxOut& txout, wtx.vout) in CWallet::AddToWallet()\r\n\r\nAgain, I have not tested this loop performance, but I don't think that 1M empty Txouts[] can make this loop last for more than 1 msec.\r\n\r\nSo my last word is that SyncWithWallets() seems safe.",
      "created_at" : "2013-01-24T18:05:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/2178#issuecomment-12664421",
      "id" : 12664421,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2178",
      "updated_at" : "2013-01-24T21:54:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/12664421",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1752347?v=3",
         "events_url" : "https://api.github.com/users/SergioDemianLerner/events{/privacy}",
         "followers_url" : "https://api.github.com/users/SergioDemianLerner/followers",
         "following_url" : "https://api.github.com/users/SergioDemianLerner/following{/other_user}",
         "gists_url" : "https://api.github.com/users/SergioDemianLerner/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/SergioDemianLerner",
         "id" : 1752347,
         "login" : "SergioDemianLerner",
         "organizations_url" : "https://api.github.com/users/SergioDemianLerner/orgs",
         "received_events_url" : "https://api.github.com/users/SergioDemianLerner/received_events",
         "repos_url" : "https://api.github.com/users/SergioDemianLerner/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/SergioDemianLerner/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/SergioDemianLerner/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/SergioDemianLerner"
      }
   },
   {
      "body" : "This can be closed, as the patch got merged.",
      "created_at" : "2013-01-28T15:03:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/2178#issuecomment-12785561",
      "id" : 12785561,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2178",
      "updated_at" : "2013-01-28T15:03:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/12785561",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   }
]
