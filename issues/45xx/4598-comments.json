[
   {
      "body" : "ACK, good catches!\r\n",
      "created_at" : "2014-07-28T17:55:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4598#issuecomment-50373673",
      "id" : 50373673,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4598",
      "updated_at" : "2014-07-28T17:55:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/50373673",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "body" : "Untested ACK",
      "created_at" : "2014-07-28T18:46:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4598#issuecomment-50380763",
      "id" : 50380763,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4598",
      "updated_at" : "2014-07-28T18:46:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/50380763",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "unrelated, but I just got several segmentation faults. It turned out that the code below caused the problem.\r\nThe scenario was delta=1 and history.size()=0.\r\nIf I read the code correctly, this results in -1 index access in the last line.\r\nMaybe we can fix that in this pull request, so I dont have to submit another 'Fix feeestimate'.\r\n(EDIT: I guess for history to be empty, the file fee_estimates.dat has to exist, but with no entries.)\r\n\r\n        BOOST_FOREACH(const CTxMemPoolEntry& entry, entries)\r\n        {\r\n            // How many blocks did it take for miners to include this transaction?\r\n            int delta = nBlockHeight - entry.GetHeight();\r\n            if (delta <= 0)\r\n            {\r\n                // Re-org made us lose height, this should only happen if we happen\r\n                // to re-org on a difficulty transition point: very rare!\r\n                continue;\r\n            }\r\n            if ((delta-1) >= (int)history.size())\r\n                delta = history.size(); // Last bucket is catch-all\r\n            entriesByConfirmations[delta-1].push_back(&entry); <=========== segfault\r\n        }",
      "created_at" : "2014-07-29T02:18:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4598#issuecomment-50427118",
      "id" : 50427118,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4598",
      "updated_at" : "2014-07-29T02:45:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/50427118",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2814559?v=3",
         "events_url" : "https://api.github.com/users/cozz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/cozz/followers",
         "following_url" : "https://api.github.com/users/cozz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/cozz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/cozz",
         "id" : 2814559,
         "login" : "cozz",
         "organizations_url" : "https://api.github.com/users/cozz/orgs",
         "received_events_url" : "https://api.github.com/users/cozz/received_events",
         "repos_url" : "https://api.github.com/users/cozz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/cozz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/cozz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/cozz"
      }
   },
   {
      "body" : "I'd be happy to update the PR, but not sure what the right solution is. I could change the line that seg faulted to: \r\n\r\n    if (delta > 0)\r\n        entriesByConfirmations.at(delta-1).push_back(&entry);\r\n\r\nAnd I *think* that there isn't anywhere else that would throw an exception, but it seems like the code is not really designed for a history of 0 size.  \r\n\r\nWas this the result of reading a corrupted data file?  It would make sense to sanity check the data file on read as well.",
      "created_at" : "2014-07-29T04:10:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4598#issuecomment-50432607",
      "id" : 50432607,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4598",
      "updated_at" : "2014-07-29T04:10:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/50432607",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "body" : "@cozz : the mystery is how history.size() could ever become zero. Looking at the code, I agree with @morcos -- your estimates.dat file must have been corrupted somehow.\r\n\r\nThere are already sanity checks in CBlockAverage::Read; adding a sanity check in CMinerPolicyEstimator::Read() like:\r\n```\r\n    filein >> numEntries;\r\n    if (numEntries <= 0 || numEntries > ...uh, some large value...)\r\n         throw runtime_error(\"Corrupt estimates file.\");\r\n```\r\n... and maybe an assert(history.size() > 0) in the right spot(s) would be best fix.\r\n",
      "created_at" : "2014-07-29T14:31:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4598#issuecomment-50483560",
      "id" : 50483560,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4598",
      "updated_at" : "2014-07-29T14:31:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/50483560",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "body" : "The problem is gone after deleting fee_estimates.dat. I assume I was using an old incompatible fee_estimates.dat. So lets not bother much, your suggested sanity checks/asserts sound good to me.",
      "created_at" : "2014-07-29T15:59:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4598#issuecomment-50497100",
      "id" : 50497100,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4598",
      "updated_at" : "2014-07-29T15:59:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/50497100",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2814559?v=3",
         "events_url" : "https://api.github.com/users/cozz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/cozz/followers",
         "following_url" : "https://api.github.com/users/cozz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/cozz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/cozz",
         "id" : 2814559,
         "login" : "cozz",
         "organizations_url" : "https://api.github.com/users/cozz/orgs",
         "received_events_url" : "https://api.github.com/users/cozz/received_events",
         "repos_url" : "https://api.github.com/users/cozz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/cozz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/cozz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/cozz"
      }
   },
   {
      "body" : "I just added another commit to sanity check the reading of the file.  I read fee_estimates.dat into a temporary history vector first, because otherwise the sanity checking could have failed in reading the individual CBlockAverage's and still left an inconsistent state, so I didn't want to replace the state we were initialized with unless we knew processing the whole file succeeded.",
      "created_at" : "2014-07-29T18:14:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4598#issuecomment-50515960",
      "id" : 50515960,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4598",
      "updated_at" : "2014-07-29T18:14:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/50515960",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "body" : "Automatic sanity-testing: PASSED, see http://jenkins.bluematt.me/pull-tester/p4598_e59441f0863d20c6f205c4854a37507267183863/ for binaries and test log.\nThis test script verifies pulls every time they are updated. It, however, dies sometimes and fails to test properly.  If you are waiting on a test, please check timestamps to verify that the test.log is moving at http://jenkins.bluematt.me/pull-tester/current/\nContact BlueMatt on freenode if something looks broken.",
      "created_at" : "2014-07-29T18:25:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4598#issuecomment-50517486",
      "id" : 50517486,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4598",
      "updated_at" : "2014-07-29T18:25:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/50517486",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2110907?v=3",
         "events_url" : "https://api.github.com/users/BitcoinPullTester/events{/privacy}",
         "followers_url" : "https://api.github.com/users/BitcoinPullTester/followers",
         "following_url" : "https://api.github.com/users/BitcoinPullTester/following{/other_user}",
         "gists_url" : "https://api.github.com/users/BitcoinPullTester/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/BitcoinPullTester",
         "id" : 2110907,
         "login" : "BitcoinPullTester",
         "organizations_url" : "https://api.github.com/users/BitcoinPullTester/orgs",
         "received_events_url" : "https://api.github.com/users/BitcoinPullTester/received_events",
         "repos_url" : "https://api.github.com/users/BitcoinPullTester/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/BitcoinPullTester/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/BitcoinPullTester/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/BitcoinPullTester"
      }
   },
   {
      "body" : "Thanks a lot for this, it seems to have solved quite some crashes that people were experiencing, especially on testnet.\r\n",
      "created_at" : "2014-08-06T07:55:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4598#issuecomment-51304130",
      "id" : 51304130,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4598",
      "updated_at" : "2014-08-06T07:55:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/51304130",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   }
]
