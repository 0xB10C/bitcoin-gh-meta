[
   {
      "body" : "Sounds like a good idea to add an optional extra level of checking.\r\n\r\nBut would the result of this be to disable *all* current checks by default in gitian builds?\r\n",
      "created_at" : "2014-07-23T13:48:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/4576#issuecomment-49875469",
      "id" : 49875469,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4576",
      "updated_at" : "2014-07-23T13:48:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/49875469",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "I guess it's a compromise. If there is a situation where we'd rather crash and risk having it being triggerable by peers, assert() (or some equivalent that does not depend on -checks) would be fine.",
      "created_at" : "2014-07-23T14:12:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/4576#issuecomment-49878869",
      "id" : 49878869,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4576",
      "updated_at" : "2014-07-23T14:12:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/49878869",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "I really don't feel good about disabling all checks by default. A lot of corruption problems in the database, for example, come to light as exceptions. I think a base level of consistency checks in a program in which a sane state is so important like bitcoin should always be there.",
      "created_at" : "2014-07-23T14:15:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/4576#issuecomment-49879214",
      "id" : 49879214,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4576",
      "updated_at" : "2014-07-23T14:15:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/49879214",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Exceptions remain exceptions. They're about dealing with exceptions runtime conditions, but about incorrect assumptions the source code makes (which is what assertions are about).",
      "created_at" : "2014-07-23T14:18:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/4576#issuecomment-49879610",
      "id" : 49879610,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4576",
      "updated_at" : "2014-07-23T14:18:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/49879610",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Oh, just to be clear: this whole issue is just about things that are currently assertions.\r\n\r\nI think there should be more of those, but they having them enabled in production systems can be a risk to the network.",
      "created_at" : "2014-07-23T14:18:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/4576#issuecomment-49879712",
      "id" : 49879712,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4576",
      "updated_at" : "2014-07-23T14:19:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/49879712",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "I'm also talking about assertions. A quick search of issues shows that problems (usually with the database) regularly are detected by assertions, not exceptions:\r\n\r\n#2821 Assertion mempool transaction missing input\r\n#2631 First time running, assertion failed (assertion in leveldb)\r\n#4097 Assertion failed in table/table_builder.cc:97 (assertion in leveldb)\r\n#3495 EXCEPTION: St9bad_alloc; assertion \"pindex->pprev == view.GetBestBlock()\" failed \r\n#4066 failed on open 64bit version \r\n\r\nIf the current assertion checks are disabled by default the client would keep running with corrupted state, which may be harmful to the network or the user.\r\n",
      "created_at" : "2014-07-23T14:26:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/4576#issuecomment-49880835",
      "id" : 49880835,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4576",
      "updated_at" : "2014-07-23T14:26:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/49880835",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Related observations on assert, from working on other projects:\r\n* assert() tends to be a major sledgehammer, because it ends the program.\r\n* Programmers often make mistakes and add an assert for a runtime condition (such as out-of-disk-space).  We have even seen this in bitcoin.\r\n* assert() should only ever be used for \"should never happen\" type conditions, where a crash or undefined behavior results should the assert otherwise be absent\r\n\r\nObservations on checks:\r\n* Yes.  Yes.  Goal should be to turn on as much inexpensive runtime checks as possible, always.\r\n* Related goal, make checks as inexpensive as possible, so as to not punish the user (and therefore encourage the user to want to turn off the checks).\r\n* Can use the compiler's branch prediction hints (likely/unlikely macros)\r\n* Related, make debugging/diagnostic dumps easy for the user to trigger\r\n\r\nCheap runtime checks are good.  Asserts are bad.\r\n",
      "created_at" : "2014-07-23T14:28:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/4576#issuecomment-49881112",
      "id" : 49881112,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4576",
      "updated_at" : "2014-07-23T14:28:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/49881112",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "body" : "> Related, make debugging/diagnostic dumps easy for the user to trigger\r\n\r\nGood idea, but only after the wallet is split off (or disabled). Currently there is the risk of private key data in memory (or even in registers) and it's not safe to send dumps around. See also #2551.\r\n",
      "created_at" : "2014-07-23T14:35:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/4576#issuecomment-49882040",
      "id" : 49882040,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4576",
      "updated_at" : "2014-07-23T14:35:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/49882040",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Well, leveldb is separate in any case. I don't suggest changing their assertion behavior.\r\n\r\nI'm very aware of the reasons why asserts exist, and why turning them off is bad. What I'm saying is that in production environments, it may be better to not risk blowing up the process due to an overeager check, as that automatically means a huge risk to the network if that assert is triggerable by a network condition. If it's based on a relayable message, it may even wipe out the network entirely.\r\n\r\nWhat I want is more of these checks, more as a way for the programmer to say \"this is what I assume here\", more than \"if this doesn't hold here, we're in BIG trouble\". It makes the code clearer, and simultaneously verifies that such assumptions hold. But only in cases where we're not at risk of hurting the network by dying.\r\n\r\nI don't have a good answer for what to do when things are clearly blowing up. Perhaps the checks that we are *really* sure about indicate irrecoverably bad state and *really* sure cannot be triggered by the network can remain asserts, but I'd rather see them turned off in production if that means we can have more checks in the code.",
      "created_at" : "2014-07-23T14:37:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/4576#issuecomment-49882336",
      "id" : 49882336,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4576",
      "updated_at" : "2014-07-23T14:37:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/49882336",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "What about - for example - asserts that check bounds? A DoS is bad, but disabling them may result in exploitable behaviour much worse than a DoS.\r\n\r\nSo, whereas I agree with adding an extra level of expensive checks that is only enabled in debug builds, I don't agree with making all current assertions/checks optional.\r\n",
      "created_at" : "2014-07-23T14:42:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/4576#issuecomment-49883083",
      "id" : 49883083,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4576",
      "updated_at" : "2014-07-23T14:42:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/49883083",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Fair enough. I guess we can have two levels, optional and mandatory checks.\r\n\r\nEncourage people to fill their code with optional checks, and maybe after a few releases, some optional ones can turn into mandatory ones.",
      "created_at" : "2014-07-23T14:43:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/4576#issuecomment-49883271",
      "id" : 49883271,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4576",
      "updated_at" : "2014-07-23T14:43:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/49883271",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Asserts are bad, in part, because people never bother to build with -DNDEBUG (the not-default).  You do not want a path that is rarely built.  Compile-time conditionals, in general, suck.\r\n\r\nYou always want to _compile_ as much code as possible.  Disable at runtime if its expensive or painful, but always compile.  Code that is not always compiled bitrots rapidly.\r\n",
      "created_at" : "2014-07-23T14:56:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/4576#issuecomment-49885234",
      "id" : 49885234,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4576",
      "updated_at" : "2014-07-23T14:56:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/49885234",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "body" : "@jgarzik Oh yes there is a danger in making 'release builds' and 'debug builds' diverge too much. I've seen that in game development. Everyone will test with the debug build, and then problems appear in the release build which no one has tested before the actual release :-) Also having a build that intentionally strips sanity checks makes troubleshooting harder. So yes, run-time instead of compile-time disabling is preferable where possible.\r\n\r\nSo for critical checks we should have an 'assert' that ignores NDEBUG.\r\n\r\n",
      "created_at" : "2014-07-23T15:13:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/4576#issuecomment-49887906",
      "id" : 49887906,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4576",
      "updated_at" : "2014-07-23T15:13:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/49887906",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   }
]
