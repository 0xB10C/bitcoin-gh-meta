[
   {
      "author_association" : "MEMBER",
      "body" : "Nice! This has been on my list for a long time. Thanks for doing it!\r\n\r\nÃ°ÂÂÂ concept ACK ",
      "created_at" : "2019-04-19T20:33:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15858#issuecomment-485007223",
      "id" : 485007223,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15858",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4NTAwNzIyMw==",
      "updated_at" : "2019-04-19T20:33:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/485007223",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This is an impressive improvement in speed!\r\nACK fad26ed5fa5bf9fc0cf60e84a135e7d03c934000\r\n\r\na test here:\r\n```\r\nALL                                   | Ã¢ÂÂ Passed  | 1788 s (accumulated)\r\nRuntime: 472 s\r\n```\r\n```\r\nALL                                   | Ã¢ÂÂ Passed  | 1516 s (accumulated)\r\nRuntime: 388 s\r\n```",
      "created_at" : "2019-04-20T12:20:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15858#issuecomment-485107509",
      "id" : 485107509,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15858",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4NTEwNzUwOQ==",
      "updated_at" : "2019-04-20T12:20:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/485107509",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15858#discussion_r277184364"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/277184364"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Could assert error \"insufficient fee\"?",
      "commit_id" : "fad26ed5fa5bf9fc0cf60e84a135e7d03c934000",
      "created_at" : "2019-04-21T23:02:05Z",
      "diff_hunk" : "@@ -390,15 +390,63 @@ def sync_blocks(rpc_connections, *, wait=1, timeout=60):\n         time.sleep(wait)\n     raise AssertionError(\"Block sync timed out:{}\".format(\"\".join(\"\\n  {!r}\".format(b) for b in best_hash)))\n \n-def sync_mempools(rpc_connections, *, wait=1, timeout=60, flush_scheduler=True):\n+def sync_mempools(rpc_connections, *, wait=1, timeout=60, use_rpc_sync=False, flush_scheduler=True):\n     \"\"\"\n     Wait until everybody has the same transactions in their memory\n     pools\n     \"\"\"\n+\n+    class TxInfo:\n+        def __init__(self, *, raw, ancestors):\n+            self.raw = raw\n+            self.ancestors = ancestors\n+\n+    def topo_send(txs, rpc, pool_add):\n+        for i in txs:\n+            topo_send(txs[i].ancestors, rpc, pool_add)\n+            if i not in pool_add:\n+                try:\n+                    assert_equal(i, rpc.sendrawtransaction(txs[i].raw))\n+                    pool_add.add(i)\n+                    # Note that conflicted txs (due to RBF) are not removed\n+                    # from the pool\n+                except JSONRPCException:\n+                    # This transaction violates policy (e.g. RBF policy). The\n+                    # mempools should still converge when the high-fee\n+                    # replacement is synced in a later call\n+                    pass",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15858#discussion_r277184364",
      "id" : 277184364,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NzE4NDM2NA==",
      "original_commit_id" : "fad26ed5fa5bf9fc0cf60e84a135e7d03c934000",
      "original_position" : 29,
      "path" : "test/functional/test_framework/util.py",
      "position" : 29,
      "pull_request_review_id" : 228929644,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15858",
      "updated_at" : "2019-04-21T23:28:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/277184364",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15858#discussion_r277184430"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/277184430"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Could skip when `i_remove == i_target`?",
      "commit_id" : "fad26ed5fa5bf9fc0cf60e84a135e7d03c934000",
      "created_at" : "2019-04-21T23:04:49Z",
      "diff_hunk" : "@@ -390,15 +390,63 @@ def sync_blocks(rpc_connections, *, wait=1, timeout=60):\n         time.sleep(wait)\n     raise AssertionError(\"Block sync timed out:{}\".format(\"\".join(\"\\n  {!r}\".format(b) for b in best_hash)))\n \n-def sync_mempools(rpc_connections, *, wait=1, timeout=60, flush_scheduler=True):\n+def sync_mempools(rpc_connections, *, wait=1, timeout=60, use_rpc_sync=False, flush_scheduler=True):\n     \"\"\"\n     Wait until everybody has the same transactions in their memory\n     pools\n     \"\"\"\n+\n+    class TxInfo:\n+        def __init__(self, *, raw, ancestors):\n+            self.raw = raw\n+            self.ancestors = ancestors\n+\n+    def topo_send(txs, rpc, pool_add):\n+        for i in txs:\n+            topo_send(txs[i].ancestors, rpc, pool_add)\n+            if i not in pool_add:\n+                try:\n+                    assert_equal(i, rpc.sendrawtransaction(txs[i].raw))\n+                    pool_add.add(i)\n+                    # Note that conflicted txs (due to RBF) are not removed\n+                    # from the pool\n+                except JSONRPCException:\n+                    # This transaction violates policy (e.g. RBF policy). The\n+                    # mempools should still converge when the high-fee\n+                    # replacement is synced in a later call\n+                    pass\n+\n     stop_time = time.time() + timeout\n     while time.time() <= stop_time:\n         pool = [set(r.getrawmempool()) for r in rpc_connections]\n-        if pool.count(pool[0]) == len(rpc_connections):\n+        sync_done = pool.count(pool[0]) == len(rpc_connections)\n+        if use_rpc_sync and not sync_done:\n+            for i_remote, rpc_remote in enumerate(rpc_connections):\n+                pool_remote = {\n+                    txid: TxInfo(raw=rpc_remote.getrawtransaction(txid), ancestors=info['depends'])\n+                    for txid, info in rpc_remote.getrawmempool(verbose=True).items()\n+                }\n+                # Create \"recursive pools\" for ancestors\n+                for tx in pool_remote:\n+                    pool_remote[tx].ancestors = {a: pool_remote[a] for a in pool_remote[tx].ancestors}\n+\n+                # Push this pool to all targets\n+                for i_target, rpc_target in enumerate(rpc_connections):\n+                    missing_txids = pool[i_remote].difference(pool[i_target])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15858#discussion_r277184430",
      "id" : 277184430,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NzE4NDQzMA==",
      "original_commit_id" : "fad26ed5fa5bf9fc0cf60e84a135e7d03c934000",
      "original_position" : 48,
      "path" : "test/functional/test_framework/util.py",
      "position" : 48,
      "pull_request_review_id" : 228929644,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15858",
      "updated_at" : "2019-04-21T23:28:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/277184430",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15858#discussion_r277184625"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/277184625"
         }
      },
      "author_association" : "MEMBER",
      "body" : "A brief description of the following algorithm would be handy.",
      "commit_id" : "fad26ed5fa5bf9fc0cf60e84a135e7d03c934000",
      "created_at" : "2019-04-21T23:14:46Z",
      "diff_hunk" : "@@ -390,15 +390,63 @@ def sync_blocks(rpc_connections, *, wait=1, timeout=60):\n         time.sleep(wait)\n     raise AssertionError(\"Block sync timed out:{}\".format(\"\".join(\"\\n  {!r}\".format(b) for b in best_hash)))\n \n-def sync_mempools(rpc_connections, *, wait=1, timeout=60, flush_scheduler=True):\n+def sync_mempools(rpc_connections, *, wait=1, timeout=60, use_rpc_sync=False, flush_scheduler=True):\n     \"\"\"\n     Wait until everybody has the same transactions in their memory\n     pools\n     \"\"\"\n+\n+    class TxInfo:\n+        def __init__(self, *, raw, ancestors):\n+            self.raw = raw\n+            self.ancestors = ancestors\n+\n+    def topo_send(txs, rpc, pool_add):\n+        for i in txs:\n+            topo_send(txs[i].ancestors, rpc, pool_add)\n+            if i not in pool_add:\n+                try:\n+                    assert_equal(i, rpc.sendrawtransaction(txs[i].raw))\n+                    pool_add.add(i)\n+                    # Note that conflicted txs (due to RBF) are not removed\n+                    # from the pool\n+                except JSONRPCException:\n+                    # This transaction violates policy (e.g. RBF policy). The\n+                    # mempools should still converge when the high-fee\n+                    # replacement is synced in a later call\n+                    pass\n+\n     stop_time = time.time() + timeout\n     while time.time() <= stop_time:\n         pool = [set(r.getrawmempool()) for r in rpc_connections]\n-        if pool.count(pool[0]) == len(rpc_connections):\n+        sync_done = pool.count(pool[0]) == len(rpc_connections)\n+        if use_rpc_sync and not sync_done:\n+            for i_remote, rpc_remote in enumerate(rpc_connections):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15858#discussion_r277184625",
      "id" : 277184625,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NzE4NDYyNQ==",
      "original_commit_id" : "fad26ed5fa5bf9fc0cf60e84a135e7d03c934000",
      "original_position" : 37,
      "path" : "test/functional/test_framework/util.py",
      "position" : 37,
      "pull_request_review_id" : 228929644,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15858",
      "updated_at" : "2019-04-21T23:28:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/277184625",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15858#discussion_r277243663"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/277243663"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Adding code documentation in the docstring here would be great, detailling `use_rpc_sync` purpose and use.",
      "commit_id" : "fad26ed5fa5bf9fc0cf60e84a135e7d03c934000",
      "created_at" : "2019-04-22T09:04:38Z",
      "diff_hunk" : "@@ -390,15 +390,63 @@ def sync_blocks(rpc_connections, *, wait=1, timeout=60):\n         time.sleep(wait)\n     raise AssertionError(\"Block sync timed out:{}\".format(\"\".join(\"\\n  {!r}\".format(b) for b in best_hash)))\n \n-def sync_mempools(rpc_connections, *, wait=1, timeout=60, flush_scheduler=True):\n+def sync_mempools(rpc_connections, *, wait=1, timeout=60, use_rpc_sync=False, flush_scheduler=True):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15858#discussion_r277243663",
      "id" : 277243663,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NzI0MzY2Mw==",
      "original_commit_id" : "fad26ed5fa5bf9fc0cf60e84a135e7d03c934000",
      "original_position" : 5,
      "path" : "test/functional/test_framework/util.py",
      "position" : 5,
      "pull_request_review_id" : 229002026,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15858",
      "updated_at" : "2019-04-22T09:12:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/277243663",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15858#discussion_r277243742"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15858"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/277243742"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes -- code docs here would be helpful.",
      "commit_id" : "fad26ed5fa5bf9fc0cf60e84a135e7d03c934000",
      "created_at" : "2019-04-22T09:05:05Z",
      "diff_hunk" : "@@ -390,15 +390,63 @@ def sync_blocks(rpc_connections, *, wait=1, timeout=60):\n         time.sleep(wait)\n     raise AssertionError(\"Block sync timed out:{}\".format(\"\".join(\"\\n  {!r}\".format(b) for b in best_hash)))\n \n-def sync_mempools(rpc_connections, *, wait=1, timeout=60, flush_scheduler=True):\n+def sync_mempools(rpc_connections, *, wait=1, timeout=60, use_rpc_sync=False, flush_scheduler=True):\n     \"\"\"\n     Wait until everybody has the same transactions in their memory\n     pools\n     \"\"\"\n+\n+    class TxInfo:\n+        def __init__(self, *, raw, ancestors):\n+            self.raw = raw\n+            self.ancestors = ancestors\n+\n+    def topo_send(txs, rpc, pool_add):\n+        for i in txs:\n+            topo_send(txs[i].ancestors, rpc, pool_add)\n+            if i not in pool_add:\n+                try:\n+                    assert_equal(i, rpc.sendrawtransaction(txs[i].raw))\n+                    pool_add.add(i)\n+                    # Note that conflicted txs (due to RBF) are not removed\n+                    # from the pool\n+                except JSONRPCException:\n+                    # This transaction violates policy (e.g. RBF policy). The\n+                    # mempools should still converge when the high-fee\n+                    # replacement is synced in a later call\n+                    pass\n+\n     stop_time = time.time() + timeout\n     while time.time() <= stop_time:\n         pool = [set(r.getrawmempool()) for r in rpc_connections]\n-        if pool.count(pool[0]) == len(rpc_connections):\n+        sync_done = pool.count(pool[0]) == len(rpc_connections)\n+        if use_rpc_sync and not sync_done:\n+            for i_remote, rpc_remote in enumerate(rpc_connections):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15858#discussion_r277243742",
      "id" : 277243742,
      "in_reply_to_id" : 277184625,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NzI0Mzc0Mg==",
      "original_commit_id" : "fad26ed5fa5bf9fc0cf60e84a135e7d03c934000",
      "original_position" : 37,
      "path" : "test/functional/test_framework/util.py",
      "position" : 37,
      "pull_request_review_id" : 229002026,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15858",
      "updated_at" : "2019-04-22T09:17:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/277243742",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   }
]
