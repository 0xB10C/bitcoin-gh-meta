[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#25375](https://github.com/bitcoin/bitcoin/pull/25375) (rpc: add minconf/maxconf options to sendall and fund transaction calls by ishaanam)\n* [#25273](https://github.com/bitcoin/bitcoin/pull/25273) (wallet: Pass through transaction locktime and preset input sequences and scripts to CreateTransaction by achow101)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2022-12-20T20:51:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26732#issuecomment-1360216493",
      "id" : 1360216493,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26732",
      "node_id" : "IC_kwDOABII585RE0Gt",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1360216493/reactions"
      },
      "updated_at" : "2022-12-22T01:30:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1360216493",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "To be clear, this is if you make a replacement manually, not with `bumpfee`. `bumpfee` avoids this problem by setting a minimum confirmations in the coin control object. IIRC BIP 125 disallows adding new unconfirmed inputs too.",
      "created_at" : "2022-12-20T22:44:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26732#issuecomment-1360409588",
      "id" : 1360409588,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26732",
      "node_id" : "IC_kwDOABII585RFjP0",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1360409588/reactions"
      },
      "updated_at" : "2022-12-20T22:44:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1360409588",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> To be clear, this is if you make a replacement manually, not with `bumpfee`. `bumpfee` avoids this problem by setting a minimum confirmations in the coin control object.\r\n\r\nYes, could happen if you manually pre-select an input from an unconfirmed transaction and provides it to any RPC command that creates or fund a transaction (e.g. `send()`). Not an issue for `bumpfee` as it skips unconfirmed UTXOs.\r\n\r\n> IIRC BIP 125 disallows adding new unconfirmed inputs too.\r\n\r\nYou mean, grouping inputs from different unconfirmed transactions into a single replacement tx?\r\n(in other words, a single tx that replaces many unconfirmed txes).\r\n\r\nSo far, what the test proves is that the wallet, during the transaction creation process, can automatically select outputs from the unconfirmed transaction that is being replaced to use them as inputs. Which shouldn't happen as those coins will no longer exist once the tx gets replaced.",
      "created_at" : "2022-12-21T14:23:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26732#issuecomment-1361375464",
      "id" : 1361375464,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26732",
      "node_id" : "IC_kwDOABII585RJPDo",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1361375464/reactions"
      },
      "updated_at" : "2022-12-21T14:24:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1361375464",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> You mean, grouping inputs from different unconfirmed transactions into a single replacement tx?\r\n> (in other words, a single tx that replaces many unconfirmed txes).\r\n\r\nUnconfirmed inputs that were in the original transactions being replaced are fine. It's adding new unconfirmed inputs that is not allowed.",
      "created_at" : "2022-12-21T16:06:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26732#issuecomment-1361581365",
      "id" : 1361581365,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26732",
      "node_id" : "IC_kwDOABII585RKBU1",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1361581365/reactions"
      },
      "updated_at" : "2022-12-21T16:06:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1361581365",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> > You mean, grouping inputs from different unconfirmed transactions into a single replacement tx?\r\n> > (in other words, a single tx that replaces many unconfirmed txes).\r\n> \r\n> Unconfirmed inputs that were in the original transactions being replaced are fine. It's adding new unconfirmed inputs that is not allowed.\r\n\r\nGood to know. Thanks, it's BIP125 rule 2.\r\n\r\nThe wallet can create invalid transactions due not be contemplating that neither.\r\nSame as with the other case, could happen on any of the \"send*\" and \"fund*\" RPC commands, when the user preselects an output that is being used as input for another unconfirmed transaction.\r\n\r\nSo, added test coverage and internal checks for it as well.\r\n\r\nSummary:\r\nNow this PR adds support and test coverage for two different scenarios where the wallet creates invalid transactions.\r\n\r\n1) If is creating a replacement tx; in the available coins fetching process, the wallet need to skip the outputs that corresponds to the transaction being replaced (those coins are no longer going to exist once it's replaced, there by they are not \"available\").\r\n\r\n2) Prevent adding new unconfirmed outputs to the transaction being created/funded If any preset input was already spent by a mempool transaction. (BIP125 rule 2).",
      "created_at" : "2022-12-22T14:15:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26732#issuecomment-1362890022",
      "id" : 1362890022,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26732",
      "node_id" : "IC_kwDOABII585RPA0m",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1362890022/reactions"
      },
      "updated_at" : "2022-12-22T14:23:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1362890022",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   }
]
