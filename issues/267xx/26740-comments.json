[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [furszy](https://github.com/bitcoin/bitcoin/pull/26740#pullrequestreview-1322868280), [ryanofsky](https://github.com/bitcoin/bitcoin/pull/26740#pullrequestreview-1472079713) |\n| Stale ACK | [aureleoules](https://github.com/bitcoin/bitcoin/pull/26740#pullrequestreview-1233852602) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#26836](https://github.com/bitcoin/bitcoin/pull/26836) (wallet: finish addressbook encapsulation and simplify addressbook migration by furszy)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2022-12-21T22:55:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26740#issuecomment-1362197378",
      "id" : 1362197378,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26740",
      "node_id" : "IC_kwDOABII585RMXuC",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1362197378/reactions"
      },
      "updated_at" : "2023-06-09T13:41:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1362197378",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26740#discussion_r1218240443"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218240443"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm a bit confused what this comparison is doing.",
      "commit_id" : "52634dba1cba8928b8767d05c8e30b5fd3da45e4",
      "created_at" : "2023-06-05T15:24:33Z",
      "diff_hunk" : "@@ -3847,6 +3847,11 @@ bool CWallet::MigrateToSQLite(bilingual_str& error)\n     m_database->Close();\n     fs::remove(db_path);\n \n+    if (db_path.filename() == GetName()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26740#discussion_r1218240443",
      "id" : 1218240443,
      "line" : 3850,
      "node_id" : "PRRC_kwDOABII585InN-7",
      "original_commit_id" : "52634dba1cba8928b8767d05c8e30b5fd3da45e4",
      "original_line" : 3850,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 4,
      "pull_request_review_id" : 1462819834,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218240443/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-05T15:24:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218240443",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26740#discussion_r1218246518"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218246518"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If you load a wallet from an external path (not the wallet directory), the wallet name is set to the external path.",
      "commit_id" : "52634dba1cba8928b8767d05c8e30b5fd3da45e4",
      "created_at" : "2023-06-05T15:29:27Z",
      "diff_hunk" : "@@ -3847,6 +3847,11 @@ bool CWallet::MigrateToSQLite(bilingual_str& error)\n     m_database->Close();\n     fs::remove(db_path);\n \n+    if (db_path.filename() == GetName()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26740#discussion_r1218246518",
      "id" : 1218246518,
      "in_reply_to_id" : 1218240443,
      "line" : 3850,
      "node_id" : "PRRC_kwDOABII585InPd2",
      "original_commit_id" : "52634dba1cba8928b8767d05c8e30b5fd3da45e4",
      "original_line" : 3850,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 4,
      "pull_request_review_id" : 1462829911,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218246518/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-05T15:29:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218246518",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26740#discussion_r1218262658"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218262658"
         }
      },
      "author_association" : "MEMBER",
      "body" : "So this applies to wallets outside the datadir, but not to the original default wallet sitting in the root of the data dir (instead of /wallets)?",
      "commit_id" : "52634dba1cba8928b8767d05c8e30b5fd3da45e4",
      "created_at" : "2023-06-05T15:42:04Z",
      "diff_hunk" : "@@ -3847,6 +3847,11 @@ bool CWallet::MigrateToSQLite(bilingual_str& error)\n     m_database->Close();\n     fs::remove(db_path);\n \n+    if (db_path.filename() == GetName()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26740#discussion_r1218262658",
      "id" : 1218262658,
      "in_reply_to_id" : 1218240443,
      "line" : 3850,
      "node_id" : "PRRC_kwDOABII585InTaC",
      "original_commit_id" : "52634dba1cba8928b8767d05c8e30b5fd3da45e4",
      "original_line" : 3850,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 4,
      "pull_request_review_id" : 1462857386,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218262658/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-05T15:42:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218262658",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26740#discussion_r1218275412"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218275412"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Check https://github.com/bitcoin/bitcoin/pull/26740#pullrequestreview-1252729613.\r\n\r\nIIRC (because passed some time since I tested this), you can have several wallets inside the datadir root, and trying to migrate them cause the error when the old `wallet.dat` is there, because the process is not using the wallet name, it's using the db path and appending the \"wallet.dat\" name at the end.",
      "commit_id" : "52634dba1cba8928b8767d05c8e30b5fd3da45e4",
      "created_at" : "2023-06-05T15:52:48Z",
      "diff_hunk" : "@@ -3847,6 +3847,11 @@ bool CWallet::MigrateToSQLite(bilingual_str& error)\n     m_database->Close();\n     fs::remove(db_path);\n \n+    if (db_path.filename() == GetName()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26740#discussion_r1218275412",
      "id" : 1218275412,
      "in_reply_to_id" : 1218240443,
      "line" : 3850,
      "node_id" : "PRRC_kwDOABII585InWhU",
      "original_commit_id" : "52634dba1cba8928b8767d05c8e30b5fd3da45e4",
      "original_line" : 3850,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 4,
      "pull_request_review_id" : 1462877631,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218275412/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-08T12:38:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218275412",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26740#discussion_r1222919617"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1222919617"
         }
      },
      "author_association" : "MEMBER",
      "body" : "For wallets that are not in a wallet dir, the db's filename will be the name of the wallet itself.",
      "commit_id" : "52634dba1cba8928b8767d05c8e30b5fd3da45e4",
      "created_at" : "2023-06-08T11:38:43Z",
      "diff_hunk" : "@@ -3847,6 +3847,11 @@ bool CWallet::MigrateToSQLite(bilingual_str& error)\n     m_database->Close();\n     fs::remove(db_path);\n \n+    if (db_path.filename() == GetName()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26740#discussion_r1222919617",
      "id" : 1222919617,
      "in_reply_to_id" : 1218240443,
      "line" : 3850,
      "node_id" : "PRRC_kwDOABII585I5EXB",
      "original_commit_id" : "52634dba1cba8928b8767d05c8e30b5fd3da45e4",
      "original_line" : 3850,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 4,
      "pull_request_review_id" : 1469716618,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1222919617/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-08T11:38:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1222919617",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26740#discussion_r1224311864"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1224311864"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"wallet: Be able to migrate wallets that are not in a wallet dir\" (e22a3a471bf6696cb9ac96f3f348030cb07aa8b2)\r\n\r\nThis logic seems unnecessarily confusing. I think there is no benefit to writing:\r\n\r\n```c++\r\nfs::path db_dir = db_path.parent_path();\r\nif (db_path.filename() == GetName()) {\r\n    db_dir = db_path\r\n}\r\n```\r\n\r\nInstead of simply:\r\n\r\n```c++\r\nconst fs::path db_dir = GetName();\r\n```\r\n\r\nIt also looks like `db_dir` variable is used only once, so you could probably get rid of it and just write `GetName()` directly below.",
      "commit_id" : "52634dba1cba8928b8767d05c8e30b5fd3da45e4",
      "created_at" : "2023-06-09T13:29:23Z",
      "diff_hunk" : "@@ -3847,6 +3847,11 @@ bool CWallet::MigrateToSQLite(bilingual_str& error)\n     m_database->Close();\n     fs::remove(db_path);\n \n+    if (db_path.filename() == GetName()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26740#discussion_r1224311864",
      "id" : 1224311864,
      "in_reply_to_id" : 1218240443,
      "line" : 3850,
      "node_id" : "PRRC_kwDOABII585I-YQ4",
      "original_commit_id" : "52634dba1cba8928b8767d05c8e30b5fd3da45e4",
      "original_line" : 3850,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 4,
      "pull_request_review_id" : 1472079713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1224311864/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-09T13:40:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1224311864",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26740#discussion_r1224323997"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1224323997"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"test: Add test for migrating default wallet and plain file wallet\" (52634dba1cba8928b8767d05c8e30b5fd3da45e4)\r\n\r\nMaybe say \"legacy top level wallet\" instead of \"default wallet\". Default wallet isn't really a concept that exists after  #15454",
      "commit_id" : "52634dba1cba8928b8767d05c8e30b5fd3da45e4",
      "created_at" : "2023-06-09T13:39:13Z",
      "diff_hunk" : "@@ -470,6 +471,40 @@ def test_unloaded_by_path(self):\n \n         assert_equal(bals, wallet.getbalances())\n \n+    def test_default_wallet(self):\n+        self.log.info(\"Test migration of the default wallet\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26740#discussion_r1224323997",
      "id" : 1224323997,
      "line" : 475,
      "node_id" : "PRRC_kwDOABII585I-bOd",
      "original_commit_id" : "52634dba1cba8928b8767d05c8e30b5fd3da45e4",
      "original_line" : 475,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "test/functional/wallet_migration.py",
      "position" : 13,
      "pull_request_review_id" : 1472079713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1224323997/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-09T13:40:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1224323997",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26740#discussion_r1226982269"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1226982269"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It can't use `GetName()` directly since that is just the name of the wallet, not the path to where we want it to be stored as `db_dir` is in this case. With external wallets, this would be the path to the wallet, but with wallet files in the base walletdir, `GetName()` would be the just the name of the file, not the path to it.\r\n\r\nFor example, a typical path for a wallet is `~/.bitcoin/wallets/mywallet/wallet.dat`. However we allow wallet files in the base walletdir, so `~/.bitcoin/wallets/mywallet` is also allowed. In both cases, the name of the wallet is `mywallet`, even though the paths to the database are different. Since `MakeDatabase` takes the path to the directory that will contain the `wallet.dat` file, we need to get the path to the parent dir for the first case. For the second case, we want to migrate into the subdir structure, so we need to use the same path as the file itself. This code detects the latter case by checking whether the filename (the last component of the path) matches the name of the wallet.",
      "commit_id" : "a1e653828bc59351b2a0dd5a70f519e6b61199bc",
      "created_at" : "2023-06-12T17:10:05Z",
      "diff_hunk" : "@@ -3847,6 +3847,11 @@ bool CWallet::MigrateToSQLite(bilingual_str& error)\n     m_database->Close();\n     fs::remove(db_path);\n \n+    if (db_path.filename() == GetName()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26740#discussion_r1226982269",
      "id" : 1226982269,
      "in_reply_to_id" : 1218240443,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JIkN9",
      "original_commit_id" : "52634dba1cba8928b8767d05c8e30b5fd3da45e4",
      "original_line" : 3850,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1475420879,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1226982269/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-12T17:20:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1226982269",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26740#discussion_r1226982417"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1226982417"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Will do if I need to push again.",
      "commit_id" : "a1e653828bc59351b2a0dd5a70f519e6b61199bc",
      "created_at" : "2023-06-12T17:10:13Z",
      "diff_hunk" : "@@ -470,6 +471,40 @@ def test_unloaded_by_path(self):\n \n         assert_equal(bals, wallet.getbalances())\n \n+    def test_default_wallet(self):\n+        self.log.info(\"Test migration of the default wallet\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26740#discussion_r1226982417",
      "id" : 1226982417,
      "in_reply_to_id" : 1224323997,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JIkQR",
      "original_commit_id" : "52634dba1cba8928b8767d05c8e30b5fd3da45e4",
      "original_line" : 475,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "test/functional/wallet_migration.py",
      "position" : null,
      "pull_request_review_id" : 1475421128,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1226982417/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-12T17:10:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1226982417",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26740#discussion_r1227076942"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227076942"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Sorry, I overlooked that in my suggestion. But I think this function can do the same thing as [`MakeWalletDatabase`](https://github.com/bitcoin/bitcoin/blob/c92fd638860c5b4477851fb3790bc8068f808d3e/src/wallet/wallet.cpp#L2892), [`VerifyWallets`](https://github.com/bitcoin/bitcoin/blob/c92fd638860c5b4477851fb3790bc8068f808d3e/src/wallet/load.cpp#L79), [`RestoreWallet`](https://github.com/bitcoin/bitcoin/blob/c92fd638860c5b4477851fb3790bc8068f808d3e/src/wallet/wallet.cpp#L446), [`MigrateLegacyToDescriptor`](https://github.com/bitcoin/bitcoin/blob/c92fd638860c5b4477851fb3790bc8068f808d3e/src/wallet/wallet.cpp#L4261), and [`ExecuteWalletToolFunc`](https://github.com/bitcoin/bitcoin/blob/c92fd638860c5b4477851fb3790bc8068f808d3e/src/wallet/wallettool.cpp#L139) and derive the wallet path from the wallet name in the normal way. The following change seems to work:\r\n\r\n```diff\r\n--- a/src/wallet/wallet.cpp\r\n+++ b/src/wallet/wallet.cpp\r\n@@ -3843,21 +3843,18 @@ bool CWallet::MigrateToSQLite(bilingual_str& error)\r\n \r\n     // Close this database and delete the file\r\n     fs::path db_path = fs::PathFromString(m_database->Filename());\r\n-    fs::path db_dir = db_path.parent_path();\r\n     m_database->Close();\r\n     fs::remove(db_path);\r\n \r\n-    if (db_path.filename() == GetName()) {\r\n-        // For wallet files that aren't in a wallet dir, we will want to make a wallet dir that has the same name\r\n-        db_dir = db_path;\r\n-    }\r\n+    // Turn wallet name into an absolute path that can be passed to passed to MakeDatabase.\r\n+    const fs::path wallet_path = fsbridge::AbsPathJoin(GetWalletDir(), fs::PathFromString(m_name));\r\n \r\n     // Make new DB\r\n     DatabaseOptions opts;\r\n     opts.require_create = true;\r\n     opts.require_format = DatabaseFormat::SQLITE;\r\n     DatabaseStatus db_status;\r\n-    std::unique_ptr<WalletDatabase> new_db = MakeDatabase(db_dir, opts, db_status, error);\r\n+    std::unique_ptr<WalletDatabase> new_db = MakeDatabase(wallet_path, opts, db_status, error);\r\n     assert(new_db); // This is to prevent doing anything further with this wallet. The original file was deleted, but a backup exists.\r\n     m_database.reset();\r\n     m_database = std::move(new_db);\r\n```\r\n\r\n\r\n\r\n\r\n",
      "commit_id" : "a1e653828bc59351b2a0dd5a70f519e6b61199bc",
      "created_at" : "2023-06-12T18:25:10Z",
      "diff_hunk" : "@@ -3847,6 +3847,11 @@ bool CWallet::MigrateToSQLite(bilingual_str& error)\n     m_database->Close();\n     fs::remove(db_path);\n \n+    if (db_path.filename() == GetName()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26740#discussion_r1227076942",
      "id" : 1227076942,
      "in_reply_to_id" : 1218240443,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JI7VO",
      "original_commit_id" : "52634dba1cba8928b8767d05c8e30b5fd3da45e4",
      "original_line" : 3850,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1475554798,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227076942/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-12T18:25:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227076942",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26740#discussion_r1227130800"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227130800"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done as suggested",
      "commit_id" : "a1e653828bc59351b2a0dd5a70f519e6b61199bc",
      "created_at" : "2023-06-12T19:13:44Z",
      "diff_hunk" : "@@ -3847,6 +3847,11 @@ bool CWallet::MigrateToSQLite(bilingual_str& error)\n     m_database->Close();\n     fs::remove(db_path);\n \n+    if (db_path.filename() == GetName()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26740#discussion_r1227130800",
      "id" : 1227130800,
      "in_reply_to_id" : 1218240443,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JJIew",
      "original_commit_id" : "52634dba1cba8928b8767d05c8e30b5fd3da45e4",
      "original_line" : 3850,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1475641862,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227130800/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-12T19:13:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1227130800",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   }
]
