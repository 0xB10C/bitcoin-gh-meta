[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#17023](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/17023.html) (doc: warn that ranged multi() descriptors are not BIP67 compatible by Sjors)\n* [#16889](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16889.html) (Add some general std::vector utility functions by sipa)\n* [#16800](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16800.html) (Basic Miniscript support in output descriptors by sipa)\n* [#15590](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15590.html) (Descriptor: add GetAddressType() and IsSegWit() by Sjors)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2019-10-04T20:56:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17056#issuecomment-538556995",
      "id" : 538556995,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17056",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUzODU1Njk5NQ==",
      "updated_at" : "2019-10-04T20:56:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/538556995",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17056#discussion_r331737954"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17056"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/331737954"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Also const?",
      "commit_id" : "a6dd441cb2d8325dd968897776e7f8389cda359c",
      "created_at" : "2019-10-05T08:03:43Z",
      "diff_hunk" : "@@ -593,15 +593,23 @@ class ComboDescriptor final : public DescriptorImpl\n     ComboDescriptor(std::unique_ptr<PubkeyProvider> prov) : DescriptorImpl(Singleton(std::move(prov)), {}, \"combo\") {}\n };\n \n-/** A parsed multi(...) descriptor. */\n+/** A parsed multi(...) or sortedmulti(...) descriptor */\n class MultisigDescriptor final : public DescriptorImpl\n {\n     const int m_threshold;\n+    bool m_sorted;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17056#discussion_r331737954",
      "id" : 331737954,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMzMTczNzk1NA==",
      "original_commit_id" : "d5a925be31b185c54440391b0e24f1b6af10083f",
      "original_position" : 9,
      "path" : "src/script/descriptor.cpp",
      "position" : 9,
      "pull_request_review_id" : 297781258,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17056",
      "updated_at" : "2019-10-06T15:19:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/331737954",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17056#discussion_r331738173"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17056"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/331738173"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Swap operands?",
      "commit_id" : "a6dd441cb2d8325dd968897776e7f8389cda359c",
      "created_at" : "2019-10-05T08:11:49Z",
      "diff_hunk" : "@@ -827,7 +836,10 @@ std::unique_ptr<DescriptorImpl> ParseScript(Span<const char>& sp, ParseScriptCon\n         error = \"Cannot have combo in non-top level\";\n         return nullptr;\n     }\n-    if (Func(\"multi\", expr)) {\n+    if (Func(\"sortedmulti\", expr)) {\n+        sorted_multi = true;\n+    }\n+    if (Func(\"multi\", expr) || sorted_multi) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17056#discussion_r331738173",
      "id" : 331738173,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMzMTczODE3Mw==",
      "original_commit_id" : "d5a925be31b185c54440391b0e24f1b6af10083f",
      "original_position" : 43,
      "path" : "src/script/descriptor.cpp",
      "position" : 43,
      "pull_request_review_id" : 297781258,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17056",
      "updated_at" : "2019-10-06T15:19:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/331738173",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK\r\n\r\n@peter-conalgo does this match the BIP67 implementation in ColdCard? (assuming compressed public keys). E.g. https://github.com/Coldcard/firmware/blob/master/testing/test_multisig.py#L232-L255 and https://github.com/Coldcard/firmware/blob/master/shared/multisig.py#L412-L414",
      "created_at" : "2019-10-05T11:33:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17056#issuecomment-538641923",
      "id" : 538641923,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17056",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUzODY0MTkyMw==",
      "updated_at" : "2019-10-05T11:33:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/538641923",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17056#discussion_r331778543"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17056"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/331778543"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This just returns `false` without failing the test.  In fact all these addresses are incorrect; you either have to run the node in mainnet (like `feature_config_args`), or replace the test vectors for regtest. I manually verified with a mainnet node that the vectors do pass.",
      "commit_id" : "a6dd441cb2d8325dd968897776e7f8389cda359c",
      "created_at" : "2019-10-06T09:07:43Z",
      "diff_hunk" : "@@ -72,6 +75,14 @@ def run_test(self):\n             assert_equal(legacy_addr, node0.addmultisigaddress(2, keys, '', 'bech32')['address'])\n             assert_equal(legacy_addr, node0.addmultisigaddress(2, keys, '', 'p2sh-segwit')['address'])\n \n+        self.log.info('Testing sortedmulti descriptors with BIP 67 test vectors')\n+        with open(os.path.join(os.path.dirname(os.path.realpath(__file__)), 'data/rpc_bip67.json'), encoding='utf-8') as f:\n+            vectors = json.load(f)\n+\n+        for t in vectors:\n+            key_str = ','.join(t['keys'])\n+            self.nodes[0].deriveaddresses(descsum_create('sh(sortedmulti(2,' + key_str + '))'))[0] == t['address']",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17056#discussion_r331778543",
      "id" : 331778543,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMzMTc3ODU0Mw==",
      "original_commit_id" : "4bb67aad0a3d86ade5b15136e0d812f17b208798",
      "original_position" : 27,
      "path" : "test/functional/rpc_createmultisig.py",
      "position" : null,
      "pull_request_review_id" : 297827296,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17056",
      "updated_at" : "2019-10-06T15:19:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/331778543",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17056#discussion_r331794878"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17056"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/331794878"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Whoops. Fixed. Changed the addresses to regtest ones. You can check they still map to the same scriptPubKey using `getaddressinfo` and `decodescript`.",
      "commit_id" : "a6dd441cb2d8325dd968897776e7f8389cda359c",
      "created_at" : "2019-10-06T15:19:51Z",
      "diff_hunk" : "@@ -72,6 +75,14 @@ def run_test(self):\n             assert_equal(legacy_addr, node0.addmultisigaddress(2, keys, '', 'bech32')['address'])\n             assert_equal(legacy_addr, node0.addmultisigaddress(2, keys, '', 'p2sh-segwit')['address'])\n \n+        self.log.info('Testing sortedmulti descriptors with BIP 67 test vectors')\n+        with open(os.path.join(os.path.dirname(os.path.realpath(__file__)), 'data/rpc_bip67.json'), encoding='utf-8') as f:\n+            vectors = json.load(f)\n+\n+        for t in vectors:\n+            key_str = ','.join(t['keys'])\n+            self.nodes[0].deriveaddresses(descsum_create('sh(sortedmulti(2,' + key_str + '))'))[0] == t['address']",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17056#discussion_r331794878",
      "id" : 331794878,
      "in_reply_to_id" : 331778543,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMzMTc5NDg3OA==",
      "original_commit_id" : "4bb67aad0a3d86ade5b15136e0d812f17b208798",
      "original_position" : 27,
      "path" : "test/functional/rpc_createmultisig.py",
      "position" : null,
      "pull_request_review_id" : 297844431,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17056",
      "updated_at" : "2019-10-06T15:19:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/331794878",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   }
]
