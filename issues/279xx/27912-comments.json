[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#27213](https://github.com/bitcoin/bitcoin/pull/27213) (p2p: Diversify automatic outbound connections with respect to networks by amitiuttarwar)\n* [#26938](https://github.com/bitcoin/bitcoin/pull/26938) ([WIP] p2p: asmap, avoid inbound connections from a specific AS by brunoerg)\n* [#26114](https://github.com/bitcoin/bitcoin/pull/26114) (net: Make AddrFetch connections to fixed seeds by mzumsande)\n* [#25572](https://github.com/bitcoin/bitcoin/pull/25572) (refactor: Introduce EvictionManager and use it for the inbound eviction logic by dergoegge)\n* [#25268](https://github.com/bitcoin/bitcoin/pull/25268) (refactor: Introduce EvictionManager by dergoegge)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-06-19T10:26:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27912#issuecomment-1596928845",
      "id" : 1596928845,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27912",
      "node_id" : "IC_kwDOABII585fLzNN",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1596928845/reactions"
      },
      "updated_at" : "2023-06-19T13:53:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1596928845",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27912#discussion_r1233973528"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27912"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233973528"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think `m_disconnect_mutex` already prevents this from happening",
      "commit_id" : "1d28dfb751c882d2e1c6474a817cd686310d83f8",
      "created_at" : "2023-06-19T12:15:21Z",
      "diff_hunk" : "@@ -1122,32 +1122,36 @@ void CConnman::DisconnectNodes()\n \n         // Disconnect unused nodes\n         std::vector<CNode*> nodes_copy = m_nodes;\n-        for (CNode* pnode : nodes_copy)\n         {\n-            if (pnode->fDisconnect)\n-            {\n-                // remove from m_nodes\n-                m_nodes.erase(remove(m_nodes.begin(), m_nodes.end(), pnode), m_nodes.end());\n+            LOCK(m_disconnect_mutex);\n+            for (CNode* pnode : nodes_copy) {\n+                if (pnode->fDisconnect) {\n+                    // remove from m_nodes\n+                    m_nodes.erase(remove(m_nodes.begin(), m_nodes.end(), pnode), m_nodes.end());\n \n-                // release outbound grant (if any)\n-                pnode->grantOutbound.Release();\n+                    // release outbound grant (if any)\n+                    pnode->grantOutbound.Release();\n \n-                // close socket and cleanup\n-                pnode->CloseSocketDisconnect();\n+                    // close socket and cleanup\n+                    pnode->CloseSocketDisconnect();\n \n-                // hold in disconnected pool until all refs are released\n-                pnode->Release();\n-                m_nodes_disconnected.push_back(pnode);\n+                    // hold in disconnected pool until all refs are released\n+                    pnode->Release();\n+                    m_nodes_disconnected.push_back(pnode);\n+                }\n             }\n         }\n     }\n     {\n+        LOCK(m_disconnect_mutex);\n         // Delete disconnected nodes\n         std::list<CNode*> nodes_disconnected_copy = m_nodes_disconnected;\n         for (CNode* pnode : nodes_disconnected_copy)\n         {\n             // Destroy the object only after other threads have stopped using it.\n-            if (pnode->GetRefCount() <= 0) {\n+            // Prevent two threads trying to delete the same node: set nRefCount to -1 first",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27912#discussion_r1233973528",
      "id" : 1233973528,
      "line" : 1152,
      "node_id" : "PRRC_kwDOABII585JjPEY",
      "original_commit_id" : "1d28dfb751c882d2e1c6474a817cd686310d83f8",
      "original_line" : 1152,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 44,
      "pull_request_review_id" : 1486091302,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27912",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233973528/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-19T12:15:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1233973528",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27912#discussion_r1234060495"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27912"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1234060495"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hmm you may be right, I might have gone too far with that. What I was trying to protect against was checking the number of references in one instruction, and permitting another thread to increase the `refCount` in the meantime before we remove the node in the subsequent lines. But, it looks like we don't have any functions which would increase the `refCount` during normal operation (only incremented on new connections), so probably unnecessary here.\r\n\r\nIf I'm honest, I kind of prefer this belt-and-suspenders way myself, but would be easily persuaded that it's superfluous or worse than current behaviour (useless extra locking).\r\n\r\nI felt a bit nevous about nesting `m_disconnect_mutex` inside of `m_nodes_mutex`, but it seemed like it was slightly preferable to just locking `m_nodes_mutex` for the whole of `DisconnectNodes()` as that's used in many other operations. I don't think there is any way `StopNodes()` and `DisconnectNodes()` can lock each other here though. Would you agree?",
      "commit_id" : "1d28dfb751c882d2e1c6474a817cd686310d83f8",
      "created_at" : "2023-06-19T13:22:43Z",
      "diff_hunk" : "@@ -1122,32 +1122,36 @@ void CConnman::DisconnectNodes()\n \n         // Disconnect unused nodes\n         std::vector<CNode*> nodes_copy = m_nodes;\n-        for (CNode* pnode : nodes_copy)\n         {\n-            if (pnode->fDisconnect)\n-            {\n-                // remove from m_nodes\n-                m_nodes.erase(remove(m_nodes.begin(), m_nodes.end(), pnode), m_nodes.end());\n+            LOCK(m_disconnect_mutex);\n+            for (CNode* pnode : nodes_copy) {\n+                if (pnode->fDisconnect) {\n+                    // remove from m_nodes\n+                    m_nodes.erase(remove(m_nodes.begin(), m_nodes.end(), pnode), m_nodes.end());\n \n-                // release outbound grant (if any)\n-                pnode->grantOutbound.Release();\n+                    // release outbound grant (if any)\n+                    pnode->grantOutbound.Release();\n \n-                // close socket and cleanup\n-                pnode->CloseSocketDisconnect();\n+                    // close socket and cleanup\n+                    pnode->CloseSocketDisconnect();\n \n-                // hold in disconnected pool until all refs are released\n-                pnode->Release();\n-                m_nodes_disconnected.push_back(pnode);\n+                    // hold in disconnected pool until all refs are released\n+                    pnode->Release();\n+                    m_nodes_disconnected.push_back(pnode);\n+                }\n             }\n         }\n     }\n     {\n+        LOCK(m_disconnect_mutex);\n         // Delete disconnected nodes\n         std::list<CNode*> nodes_disconnected_copy = m_nodes_disconnected;\n         for (CNode* pnode : nodes_disconnected_copy)\n         {\n             // Destroy the object only after other threads have stopped using it.\n-            if (pnode->GetRefCount() <= 0) {\n+            // Prevent two threads trying to delete the same node: set nRefCount to -1 first",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27912#discussion_r1234060495",
      "id" : 1234060495,
      "in_reply_to_id" : 1233973528,
      "line" : 1152,
      "node_id" : "PRRC_kwDOABII585JjkTP",
      "original_commit_id" : "1d28dfb751c882d2e1c6474a817cd686310d83f8",
      "original_line" : 1152,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 44,
      "pull_request_review_id" : 1486230879,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27912",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1234060495/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-19T13:22:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1234060495",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27912#discussion_r1234096330"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27912"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1234096330"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The CNode reference counting is a total nightmare and we should (and have in the past: https://github.com/bitcoin/bitcoin/pull/10738/) try to get rid of it at some point.\r\n\r\n> permitting another thread to increase the refCount in the meantime before we remove the node in the subsequent lines.\r\n\r\nThis is actually possible with and without your patch and the way we protect against this is by not calling `CNode::AddRef` after nodes where moved to the disconnection queue.\r\n\r\n```c++\r\nif (pnode->nRefCount.compare_exchange_strong(expectedRefCount, -1)) {\r\n    // Theoretically, nothing stops a different thread from calling `AddRef()` while we are here\r\n    m_nodes_disconnected.remove(pnode);\r\n    DeleteNode(pnode);\r\n}\r\n```\r\n\r\n>  But, it looks like we don't have any functions which would increase the refCount during normal operation (only incremented on new connections), so probably unnecessary here.\r\n\r\nOur RAII helper [`NodesSnapshot`](https://github.com/bitcoin/bitcoin/blob/7f0b79ea132d22ad5212c1d3ff4325715ca5ac12/src/net.h#L1189) does call `AddRef` during normal operation (e.g. before processing messages) but `NodesSnapshot` doesn't take a snapshot of `m_nodes_disconnected` so it's fine.\r\n\r\n> I don't think there is any way StopNodes() and DisconnectNodes() can lock each other here though. \r\n\r\nAgreed, as long as you always lock in the same order (which afaict you do).",
      "commit_id" : "1d28dfb751c882d2e1c6474a817cd686310d83f8",
      "created_at" : "2023-06-19T13:50:14Z",
      "diff_hunk" : "@@ -1122,32 +1122,36 @@ void CConnman::DisconnectNodes()\n \n         // Disconnect unused nodes\n         std::vector<CNode*> nodes_copy = m_nodes;\n-        for (CNode* pnode : nodes_copy)\n         {\n-            if (pnode->fDisconnect)\n-            {\n-                // remove from m_nodes\n-                m_nodes.erase(remove(m_nodes.begin(), m_nodes.end(), pnode), m_nodes.end());\n+            LOCK(m_disconnect_mutex);\n+            for (CNode* pnode : nodes_copy) {\n+                if (pnode->fDisconnect) {\n+                    // remove from m_nodes\n+                    m_nodes.erase(remove(m_nodes.begin(), m_nodes.end(), pnode), m_nodes.end());\n \n-                // release outbound grant (if any)\n-                pnode->grantOutbound.Release();\n+                    // release outbound grant (if any)\n+                    pnode->grantOutbound.Release();\n \n-                // close socket and cleanup\n-                pnode->CloseSocketDisconnect();\n+                    // close socket and cleanup\n+                    pnode->CloseSocketDisconnect();\n \n-                // hold in disconnected pool until all refs are released\n-                pnode->Release();\n-                m_nodes_disconnected.push_back(pnode);\n+                    // hold in disconnected pool until all refs are released\n+                    pnode->Release();\n+                    m_nodes_disconnected.push_back(pnode);\n+                }\n             }\n         }\n     }\n     {\n+        LOCK(m_disconnect_mutex);\n         // Delete disconnected nodes\n         std::list<CNode*> nodes_disconnected_copy = m_nodes_disconnected;\n         for (CNode* pnode : nodes_disconnected_copy)\n         {\n             // Destroy the object only after other threads have stopped using it.\n-            if (pnode->GetRefCount() <= 0) {\n+            // Prevent two threads trying to delete the same node: set nRefCount to -1 first",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27912#discussion_r1234096330",
      "id" : 1234096330,
      "in_reply_to_id" : 1233973528,
      "line" : 1152,
      "node_id" : "PRRC_kwDOABII585JjtDK",
      "original_commit_id" : "1d28dfb751c882d2e1c6474a817cd686310d83f8",
      "original_line" : 1152,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 44,
      "pull_request_review_id" : 1486285896,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27912",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1234096330/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-19T13:50:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1234096330",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27912#discussion_r1234104223"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27912"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1234104223"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Is it better to lock `m_disconnect_mutex` for the duration of the `node_copy` loop or to move it right before `m_nodes_disconnected`? Not sure about the performance hit of repeatedly locking+unlocking in the latter case",
      "commit_id" : "1d28dfb751c882d2e1c6474a817cd686310d83f8",
      "created_at" : "2023-06-19T13:56:29Z",
      "diff_hunk" : "@@ -1122,32 +1122,36 @@ void CConnman::DisconnectNodes()\n \n         // Disconnect unused nodes\n         std::vector<CNode*> nodes_copy = m_nodes;\n-        for (CNode* pnode : nodes_copy)\n         {\n-            if (pnode->fDisconnect)\n-            {\n-                // remove from m_nodes\n-                m_nodes.erase(remove(m_nodes.begin(), m_nodes.end(), pnode), m_nodes.end());\n+            LOCK(m_disconnect_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27912#discussion_r1234104223",
      "id" : 1234104223,
      "line" : 1126,
      "node_id" : "PRRC_kwDOABII585Jju-f",
      "original_commit_id" : "2d33e62f6260e9bdde76a31df3b6ffbd20d17db6",
      "original_line" : 1126,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 10,
      "pull_request_review_id" : 1486297426,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27912",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1234104223/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-19T15:00:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1234104223",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27912#discussion_r1234117290"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27912"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1234117290"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`nPrevNodeCount` needs a mutex now since it's called from `ThreadI2PSocketHandler` also",
      "commit_id" : "1d28dfb751c882d2e1c6474a817cd686310d83f8",
      "created_at" : "2023-06-19T14:07:40Z",
      "diff_hunk" : "@@ -1158,16 +1162,18 @@ void CConnman::DisconnectNodes()\n void CConnman::NotifyNumConnectionsChanged()\n {\n     size_t nodes_size;\n+    bool should_notify{false};\n     {\n         LOCK(m_nodes_mutex);\n         nodes_size = m_nodes.size();\n-    }\n-    if(nodes_size != nPrevNodeCount) {\n-        nPrevNodeCount = nodes_size;\n-        if (m_client_interface) {\n-            m_client_interface->NotifyNumConnectionsChanged(nodes_size);\n+        if(nodes_size != nPrevNodeCount) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27912#discussion_r1234117290",
      "id" : 1234117290,
      "line" : 1169,
      "node_id" : "PRRC_kwDOABII585JjyKq",
      "original_commit_id" : "2d33e62f6260e9bdde76a31df3b6ffbd20d17db6",
      "original_line" : 1169,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 63,
      "pull_request_review_id" : 1486297426,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27912",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1234117290/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-19T15:00:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1234117290",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27912#discussion_r1234125273"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27912"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1234125273"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Not familiar with the GUI code, but could this call to `m_client_interface->NotifyNumConnectionsChanged` race?",
      "commit_id" : "1d28dfb751c882d2e1c6474a817cd686310d83f8",
      "created_at" : "2023-06-19T14:14:15Z",
      "diff_hunk" : "@@ -1158,16 +1162,18 @@ void CConnman::DisconnectNodes()\n void CConnman::NotifyNumConnectionsChanged()\n {\n     size_t nodes_size;\n+    bool should_notify{false};\n     {\n         LOCK(m_nodes_mutex);\n         nodes_size = m_nodes.size();\n-    }\n-    if(nodes_size != nPrevNodeCount) {\n-        nPrevNodeCount = nodes_size;\n-        if (m_client_interface) {\n-            m_client_interface->NotifyNumConnectionsChanged(nodes_size);\n+        if(nodes_size != nPrevNodeCount) {\n+            nPrevNodeCount = nodes_size;\n+            should_notify = true;\n         }\n     }\n+    if (should_notify && m_client_interface) {\n+        m_client_interface->NotifyNumConnectionsChanged(nodes_size);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27912#discussion_r1234125273",
      "id" : 1234125273,
      "line" : 1175,
      "node_id" : "PRRC_kwDOABII585Jj0HZ",
      "original_commit_id" : "2d33e62f6260e9bdde76a31df3b6ffbd20d17db6",
      "original_line" : 1175,
      "original_position" : 69,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 69,
      "pull_request_review_id" : 1486297426,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27912",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1234125273/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-19T15:00:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1234125273",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27912#discussion_r1234141403"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27912"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1234141403"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I agree with @dergoegge. Don't think `StopNodes()` can race with `DisconnectNodes()` since `StopThreads()` is called first",
      "commit_id" : "1d28dfb751c882d2e1c6474a817cd686310d83f8",
      "created_at" : "2023-06-19T14:28:02Z",
      "diff_hunk" : "@@ -1122,32 +1122,36 @@ void CConnman::DisconnectNodes()\n \n         // Disconnect unused nodes\n         std::vector<CNode*> nodes_copy = m_nodes;\n-        for (CNode* pnode : nodes_copy)\n         {\n-            if (pnode->fDisconnect)\n-            {\n-                // remove from m_nodes\n-                m_nodes.erase(remove(m_nodes.begin(), m_nodes.end(), pnode), m_nodes.end());\n+            LOCK(m_disconnect_mutex);\n+            for (CNode* pnode : nodes_copy) {\n+                if (pnode->fDisconnect) {\n+                    // remove from m_nodes\n+                    m_nodes.erase(remove(m_nodes.begin(), m_nodes.end(), pnode), m_nodes.end());\n \n-                // release outbound grant (if any)\n-                pnode->grantOutbound.Release();\n+                    // release outbound grant (if any)\n+                    pnode->grantOutbound.Release();\n \n-                // close socket and cleanup\n-                pnode->CloseSocketDisconnect();\n+                    // close socket and cleanup\n+                    pnode->CloseSocketDisconnect();\n \n-                // hold in disconnected pool until all refs are released\n-                pnode->Release();\n-                m_nodes_disconnected.push_back(pnode);\n+                    // hold in disconnected pool until all refs are released\n+                    pnode->Release();\n+                    m_nodes_disconnected.push_back(pnode);\n+                }\n             }\n         }\n     }\n     {\n+        LOCK(m_disconnect_mutex);\n         // Delete disconnected nodes\n         std::list<CNode*> nodes_disconnected_copy = m_nodes_disconnected;\n         for (CNode* pnode : nodes_disconnected_copy)\n         {\n             // Destroy the object only after other threads have stopped using it.\n-            if (pnode->GetRefCount() <= 0) {\n+            // Prevent two threads trying to delete the same node: set nRefCount to -1 first",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27912#discussion_r1234141403",
      "id" : 1234141403,
      "in_reply_to_id" : 1233973528,
      "line" : 1152,
      "node_id" : "PRRC_kwDOABII585Jj4Db",
      "original_commit_id" : "1d28dfb751c882d2e1c6474a817cd686310d83f8",
      "original_line" : 1152,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 44,
      "pull_request_review_id" : 1486297426,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27912",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1234141403/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-19T15:00:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1234141403",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27912#discussion_r1234142286"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27912"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1234142286"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't think `NotifyNumConnectionsChanged` is necessary here, but I could understand the consistency argument",
      "commit_id" : "1d28dfb751c882d2e1c6474a817cd686310d83f8",
      "created_at" : "2023-06-19T14:28:50Z",
      "diff_hunk" : "@@ -1390,6 +1396,18 @@ void CConnman::ThreadSocketHandler()\n     }\n }\n \n+void CConnman::ThreadI2PSocketHandler()\n+{\n+    AssertLockNotHeld(m_total_bytes_sent_mutex);\n+\n+    SetSyscallSandboxPolicy(SyscallSandboxPolicy::NET);\n+    while (!interruptNet) {\n+        DisconnectNodes();\n+        NotifyNumConnectionsChanged();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27912#discussion_r1234142286",
      "id" : 1234142286,
      "line" : 1406,
      "node_id" : "PRRC_kwDOABII585Jj4RO",
      "original_commit_id" : "2d33e62f6260e9bdde76a31df3b6ffbd20d17db6",
      "original_line" : 1406,
      "original_position" : 85,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 85,
      "pull_request_review_id" : 1486297426,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27912",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1234142286/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-19T15:00:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1234142286",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27912#discussion_r1234143155"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27912"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1234143155"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "github won't let me comment on untouched lines, but minor nit: `threadI2PAcceptIncoming` could be renamed to `threadI2PSocketHandler`?",
      "commit_id" : "1d28dfb751c882d2e1c6474a817cd686310d83f8",
      "created_at" : "2023-06-19T14:29:32Z",
      "diff_hunk" : "@@ -1390,6 +1396,18 @@ void CConnman::ThreadSocketHandler()\n     }\n }\n \n+void CConnman::ThreadI2PSocketHandler()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27912#discussion_r1234143155",
      "id" : 1234143155,
      "line" : 1399,
      "node_id" : "PRRC_kwDOABII585Jj4ez",
      "original_commit_id" : "2d33e62f6260e9bdde76a31df3b6ffbd20d17db6",
      "original_line" : 1399,
      "original_position" : 78,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 78,
      "pull_request_review_id" : 1486297426,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27912",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1234143155/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-19T15:00:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1234143155",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27912#discussion_r1234174606"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27912"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1234174606"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Setting `advertising_listen_addr` to false each time at the top of the function causes each I2P connection to log an `AddLocal(...)` line. I think this could be used to perform a disk-fill attack (my debug.log grew several MB in several minutes) . Prior to this patch, it was set once before the `while(!interrupt)` so it wouldn't trigger every time on a new connection",
      "commit_id" : "1d28dfb751c882d2e1c6474a817cd686310d83f8",
      "created_at" : "2023-06-19T14:56:08Z",
      "diff_hunk" : "@@ -2089,34 +2107,31 @@ void CConnman::ThreadI2PAcceptIncoming()\n     bool advertising_listen_addr = false;\n     i2p::Connection conn;\n \n-    while (!interruptNet) {\n-\n-        if (!m_i2p_sam_session->Listen(conn)) {\n-            if (advertising_listen_addr && conn.me.IsValid()) {\n-                RemoveLocal(conn.me);\n-                advertising_listen_addr = false;\n-            }\n-\n-            interruptNet.sleep_for(err_wait);\n-            if (err_wait < err_wait_cap) {\n-                err_wait *= 2;\n-            }\n-\n-            continue;\n+    if (!m_i2p_sam_session->Listen(conn)) {\n+        if (advertising_listen_addr && conn.me.IsValid()) {\n+            RemoveLocal(conn.me);\n+            advertising_listen_addr = false;\n         }\n \n-        if (!advertising_listen_addr) {\n-            AddLocal(conn.me, LOCAL_MANUAL);\n-            advertising_listen_addr = true;\n+        interruptNet.sleep_for(err_wait);\n+        if (err_wait < err_wait_cap) {\n+            err_wait *= 2;\n         }\n \n-        if (!m_i2p_sam_session->Accept(conn)) {\n-            continue;\n-        }\n+        return;\n+    }\n+\n+    if (!advertising_listen_addr) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27912#discussion_r1234174606",
      "id" : 1234174606,
      "line" : 2124,
      "node_id" : "PRRC_kwDOABII585JkAKO",
      "original_commit_id" : "2d33e62f6260e9bdde76a31df3b6ffbd20d17db6",
      "original_line" : 2124,
      "original_position" : 140,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 140,
      "pull_request_review_id" : 1486297426,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27912",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1234174606/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-19T15:00:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1234174606",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27912#discussion_r1235105278"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27912"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1235105278"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I am also not familiar with the GUI code, but IIUC I don't think this should race as the lines above lock the mutex and update `nPrevNodeCount` inside it, so even if two threads called this function, t1 would lock first and update the `nPrevNodeCount``, and when it unlocked (and notified) t2 would find that `nodes_size()` was equal to `nPrevNodeCount` and so would exit without calling `NotifyNumConnectionsChanged`.\r\n\r\nBut this should still send a notification per connection count change on either thread.\r\n\r\nThat said, it's easy enough to move this block inside the `m_nodes_mutex` block to be safer, and I may do just that..\r\n\r\nCould change the function to:\r\n\r\n```cpp\r\nvoid CConnman::NotifyNumConnectionsChanged()\r\n{\r\n    size_t nodes_size;\r\n    bool should_notify{false};\r\n    {\r\n        LOCK(m_nodes_mutex);\r\n        nodes_size = m_nodes.size();\r\n        if(nodes_size != nPrevNodeCount) {\r\n            nPrevNodeCount = nodes_size;\r\n            should_notify = true;\r\n        }\r\n        if (should_notify && m_client_interface) {\r\n            m_client_interface->NotifyNumConnectionsChanged(nodes_size);\r\n        }\r\n    }\r\n}\r\n```",
      "commit_id" : "1d28dfb751c882d2e1c6474a817cd686310d83f8",
      "created_at" : "2023-06-20T11:05:57Z",
      "diff_hunk" : "@@ -1158,16 +1162,18 @@ void CConnman::DisconnectNodes()\n void CConnman::NotifyNumConnectionsChanged()\n {\n     size_t nodes_size;\n+    bool should_notify{false};\n     {\n         LOCK(m_nodes_mutex);\n         nodes_size = m_nodes.size();\n-    }\n-    if(nodes_size != nPrevNodeCount) {\n-        nPrevNodeCount = nodes_size;\n-        if (m_client_interface) {\n-            m_client_interface->NotifyNumConnectionsChanged(nodes_size);\n+        if(nodes_size != nPrevNodeCount) {\n+            nPrevNodeCount = nodes_size;\n+            should_notify = true;\n         }\n     }\n+    if (should_notify && m_client_interface) {\n+        m_client_interface->NotifyNumConnectionsChanged(nodes_size);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27912#discussion_r1235105278",
      "id" : 1235105278,
      "in_reply_to_id" : 1234125273,
      "line" : 1175,
      "node_id" : "PRRC_kwDOABII585JnjX-",
      "original_commit_id" : "2d33e62f6260e9bdde76a31df3b6ffbd20d17db6",
      "original_line" : 1175,
      "original_position" : 69,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 69,
      "pull_request_review_id" : 1487890956,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27912",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1235105278/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-20T11:05:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1235105278",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27912#discussion_r1235123227"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27912"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1235123227"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "ignore this, I was confused by github's indentation",
      "commit_id" : "1d28dfb751c882d2e1c6474a817cd686310d83f8",
      "created_at" : "2023-06-20T11:23:21Z",
      "diff_hunk" : "@@ -1158,16 +1162,18 @@ void CConnman::DisconnectNodes()\n void CConnman::NotifyNumConnectionsChanged()\n {\n     size_t nodes_size;\n+    bool should_notify{false};\n     {\n         LOCK(m_nodes_mutex);\n         nodes_size = m_nodes.size();\n-    }\n-    if(nodes_size != nPrevNodeCount) {\n-        nPrevNodeCount = nodes_size;\n-        if (m_client_interface) {\n-            m_client_interface->NotifyNumConnectionsChanged(nodes_size);\n+        if(nodes_size != nPrevNodeCount) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27912#discussion_r1235123227",
      "id" : 1235123227,
      "in_reply_to_id" : 1234117290,
      "line" : 1169,
      "node_id" : "PRRC_kwDOABII585Jnnwb",
      "original_commit_id" : "2d33e62f6260e9bdde76a31df3b6ffbd20d17db6",
      "original_line" : 1169,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 63,
      "pull_request_review_id" : 1487920764,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27912",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1235123227/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-20T11:23:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1235123227",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27912#discussion_r1235143245"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27912"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1235143245"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think it's possible that:\r\n- t1 locks `m_nodes_mutex`, checks `nodes_size` and updates `nPrevNodeCount` & `should_notify`\r\n- t1 unlocks the mutex and something else gets scheduled by the CPU\r\n- the connection count is updated again\r\n- t2 locks `m_nodes_mutex` and sets `should_notify`\r\n- t2 unlocks the mutex and calls `NotifyNumConnectionsChanged`\r\n- t1 gets scheduled and calls `NotifyNumConnectionsChanged`\r\n\r\nMy concern here was whether it's ok if `NotifyNumConnectionsChanged` is called simultaneously from 2 threads? I think it'd be good to have `nPrevNodeCount` to have a `GUARDED_BY(m_nodes_mutex)` annotation",
      "commit_id" : "1d28dfb751c882d2e1c6474a817cd686310d83f8",
      "created_at" : "2023-06-20T11:42:29Z",
      "diff_hunk" : "@@ -1158,16 +1162,18 @@ void CConnman::DisconnectNodes()\n void CConnman::NotifyNumConnectionsChanged()\n {\n     size_t nodes_size;\n+    bool should_notify{false};\n     {\n         LOCK(m_nodes_mutex);\n         nodes_size = m_nodes.size();\n-    }\n-    if(nodes_size != nPrevNodeCount) {\n-        nPrevNodeCount = nodes_size;\n-        if (m_client_interface) {\n-            m_client_interface->NotifyNumConnectionsChanged(nodes_size);\n+        if(nodes_size != nPrevNodeCount) {\n+            nPrevNodeCount = nodes_size;\n+            should_notify = true;\n         }\n     }\n+    if (should_notify && m_client_interface) {\n+        m_client_interface->NotifyNumConnectionsChanged(nodes_size);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27912#discussion_r1235143245",
      "id" : 1235143245,
      "in_reply_to_id" : 1234125273,
      "line" : 1175,
      "node_id" : "PRRC_kwDOABII585JnspN",
      "original_commit_id" : "2d33e62f6260e9bdde76a31df3b6ffbd20d17db6",
      "original_line" : 1175,
      "original_position" : 69,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 69,
      "pull_request_review_id" : 1487952389,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27912",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1235143245/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-20T11:43:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1235143245",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27912#discussion_r1235173474"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27912"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1235173474"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think that's as currently implemented (perhap GitHub diff throwing you again)?\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/2d33e62f6260e9bdde76a31df3b6ffbd20d17db6/src/net.cpp#L1125-L1143",
      "commit_id" : "21dae9698aa11fcaf1f59943d963369cc0d04771",
      "created_at" : "2023-06-20T12:10:53Z",
      "diff_hunk" : "@@ -1122,32 +1122,36 @@ void CConnman::DisconnectNodes()\n \n         // Disconnect unused nodes\n         std::vector<CNode*> nodes_copy = m_nodes;\n-        for (CNode* pnode : nodes_copy)\n         {\n-            if (pnode->fDisconnect)\n-            {\n-                // remove from m_nodes\n-                m_nodes.erase(remove(m_nodes.begin(), m_nodes.end(), pnode), m_nodes.end());\n+            LOCK(m_disconnect_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27912#discussion_r1235173474",
      "id" : 1235173474,
      "in_reply_to_id" : 1234104223,
      "line" : 1126,
      "node_id" : "PRRC_kwDOABII585Jn0Bi",
      "original_commit_id" : "2d33e62f6260e9bdde76a31df3b6ffbd20d17db6",
      "original_line" : 1126,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 10,
      "pull_request_review_id" : 1488000560,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27912",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1235173474/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-20T12:10:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1235173474",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks @Crypt-iQ for the review. I pushed 21dae96 which includes most of the suggested changes:\r\n\r\n* `NotifyNumConnectionsChanged` now inside `m_nodes_mutex` block\r\n* moved `advertising_listen_addr` to a class member on `CConnman` initialised to `false`\r\n* Took the suggestion to rename the thread while touching\r\n* guarded `nPrevNodeCount` with `m_nodes_mutex`",
      "created_at" : "2023-06-20T12:18:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27912#issuecomment-1598666154",
      "id" : 1598666154,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27912",
      "node_id" : "IC_kwDOABII585fSbWq",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1598666154/reactions"
      },
      "updated_at" : "2023-06-20T12:18:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1598666154",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27912#discussion_r1236582023"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27912"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1236582023"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I meant like _rightttt_ before `m_nodes_disconnect.push_back(pnode)`. But don't think it matters so feel free to ignore",
      "commit_id" : "21dae9698aa11fcaf1f59943d963369cc0d04771",
      "created_at" : "2023-06-21T08:11:43Z",
      "diff_hunk" : "@@ -1122,32 +1122,36 @@ void CConnman::DisconnectNodes()\n \n         // Disconnect unused nodes\n         std::vector<CNode*> nodes_copy = m_nodes;\n-        for (CNode* pnode : nodes_copy)\n         {\n-            if (pnode->fDisconnect)\n-            {\n-                // remove from m_nodes\n-                m_nodes.erase(remove(m_nodes.begin(), m_nodes.end(), pnode), m_nodes.end());\n+            LOCK(m_disconnect_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27912#discussion_r1236582023",
      "id" : 1236582023,
      "in_reply_to_id" : 1234104223,
      "line" : 1126,
      "node_id" : "PRRC_kwDOABII585JtL6H",
      "original_commit_id" : "2d33e62f6260e9bdde76a31df3b6ffbd20d17db6",
      "original_line" : 1126,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 10,
      "pull_request_review_id" : 1490076603,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27912",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1236582023/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-21T08:11:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1236582023",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   }
]
