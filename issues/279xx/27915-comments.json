[
   {
      "author_association" : "MEMBER",
      "body" : "Does it also happen the other way around?\r\n\r\nNothing in that PR should change the key material, so the cache of derived keys should be the same too. I'll investigate and add an explicit test for this case.\r\n\r\nOne place to look at would be the descriptor identifier, which is a hash of the string. We don't touch the descriptor itself during upgrade, let alone during downgrade, but perhaps we accidentally broke how the identifier is calculated.",
      "created_at" : "2023-06-20T07:13:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27915#issuecomment-1598236499",
      "id" : 1598236499,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27915",
      "node_id" : "IC_kwDOABII585fQydT",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1598236499/reactions"
      },
      "updated_at" : "2023-06-20T07:18:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1598236499",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Does it also happen the other way around?\r\n\r\nNo, wallets created in 25.2 are loaded without problems in master for me.",
      "created_at" : "2023-06-20T14:31:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27915#issuecomment-1598909877",
      "id" : 1598909877,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27915",
      "node_id" : "IC_kwDOABII585fTW21",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1598909877/reactions"
      },
      "updated_at" : "2023-06-20T14:31:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1598909877",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@Sjors, the issue is indeed on the descriptor's ID. The calculation differs between master and 25.2.\r\n\r\nCan check it by applying this into the v25.2 branch and follow @mzumsande steps:\r\n```diff\r\ndiff --git a/src/wallet/walletdb.cpp b/src/wallet/walletdb.cpp\r\n--- a/src/wallet/walletdb.cpp\t(revision 8996da626d68784aaaccd96d3459c805b578f759)\r\n+++ b/src/wallet/walletdb.cpp\t(date 1687271655072)\r\n@@ -651,6 +651,9 @@\r\n                 wss.m_descriptor_caches[id] = DescriptorCache();\r\n             }\r\n             pwallet->LoadDescriptorScriptPubKeyMan(id, desc);\r\n+            const auto* spkm = pwallet->GetDescriptorScriptPubKeyMan(desc);\r\n+            assert(id == spkm->GetID());\r\n         } else if (strType == DBKeys::WALLETDESCRIPTORCACHE) {\r\n             bool parent = true;\r\n             uint256 desc_id;\r\n```\r\n\r\nIt happens because the spkm writes the descriptor record after topping up the wallet.\r\n\r\nThe `BIP32PubkeyProvider::ToString` in v25.2 uses apostrophe (because it has no notion of the `h`) while in master the string is formatted with the `h` .\r\n\r\nBecause we cannot change the past, to stay compatible, we need to always use the apostrophe version for the spkm ID.\r\nHappy to hear yours thoughts before moving forward with the fix PR.",
      "created_at" : "2023-06-20T14:56:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27915#issuecomment-1598958676",
      "id" : 1598958676,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27915",
      "node_id" : "IC_kwDOABII585fTixU",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1598958676/reactions"
      },
      "updated_at" : "2023-06-20T14:56:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1598958676",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Can someone clarify what version(s) we are talking about here. 25.2 doesn't exist. There is currently \"master\", 25.x, 25.0, 24.x, 24.1. etc",
      "created_at" : "2023-06-20T15:47:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27915#issuecomment-1599055655",
      "id" : 1599055655,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27915",
      "node_id" : "IC_kwDOABII585fT6cn",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1599055655/reactions"
      },
      "updated_at" : "2023-06-20T15:47:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1599055655",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Sorry, I meant v25.0rc2",
      "created_at" : "2023-06-20T15:48:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27915#issuecomment-1599056468",
      "id" : 1599056468,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27915",
      "node_id" : "IC_kwDOABII585fT6pU",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1599056468/reactions"
      },
      "updated_at" : "2023-06-20T15:48:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1599056468",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@mzumsande give #27920 a try please. It fixes the issue for me.\r\nStill, while in a first glance looks ok, will think more about it.",
      "created_at" : "2023-06-20T15:53:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27915#issuecomment-1599067318",
      "id" : 1599067318,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27915",
      "node_id" : "IC_kwDOABII585fT9S2",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1599067318/reactions"
      },
      "updated_at" : "2023-06-20T15:53:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1599067318",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   }
]
