{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "MEMBER",
   "body" : "I've been using this branch for some time, for working Valgrind CI jobs on aarch64. Benefits include:\r\n* Valgrind CI jobs work across x86_64 & aarch64.\r\n* Can use latest (hopefully less buggy) Valgrind, rather than whatever the distro happens to package.\r\n* No need to \"bless\" a specific compiler, (current discussion includes switching from Clang to GCC as a workaround).\r\n* Valgrind from source runs significantly faster compared to the system package. i.e, when fuzzing under valgrind:\r\n\r\nMaster:\r\n```bash\r\nasmap_direct with args\r\nDone 646 runs in 155 second(s)\r\n....\r\naddrman_deserialize with args\r\nDone 2944 runs in 2875 second(s)\r\n```\r\n\r\nvs running this branch:\r\n```bash\r\nasmap_direct with args\r\nDone 646 runs in 23 second(s)\r\n...\r\naddrman_deserialize with args\r\nDone 2944 runs in 413 second(s)\r\n```\r\n\r\nThis is also being seen in the qa-assets repo: https://github.com/bitcoin-core/qa-assets/pull/136#issuecomment-1611072317.\r\n\r\nFor example, the `tx_pool_standard` target under Valgrind [currently takes > 10 hours](https://cirrus-ci.com/task/5211294249254912?logs=ci#L5334) to complete:\r\n```bash\r\nRun tx_pool_standard with args ['valgrind', '--quiet', '--error-exitcode=1', '/tmp/cirrus-build/bitcoin-core/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/test/fuzz/fuzz', '-runs=1', PosixPath('/tmp/cirrus-build/bitcoin-core/ci/scratch/qa-assets/fuzz_seed_corpus/tx_pool_standard')]INFO: Running with entropic power schedule (0xFF, 100).\r\nINFO: Seed: 242510469\r\nINFO: Loaded 1 modules   (248538 inline 8-bit counters): 248538 [0x27fd278, 0x2839d52), \r\nINFO: Loaded 1 PC tables (248538 PCs): 248538 [0x2839d58,0x2c04af8), \r\nINFO:     3775 files found in /tmp/cirrus-build/bitcoin-core/ci/scratch/qa-assets/fuzz_seed_corpus/tx_pool_standard\r\nINFO: -max_len is not provided; libFuzzer will not generate inputs larger than 1048576 bytes\r\nINFO: seed corpus: files: 3775 min: 1b max: 2090089b total: 88593805b rss: 321Mb\r\n#16\tpulse  cov: 4536 ft: 4537 corp: 1/1b exec/s: 5 rss: 323Mb\r\n#32\tpulse  cov: 4538 ft: 4544 corp: 4/10b exec/s: 6 rss: 323Mb\r\n#64\tpulse  cov: 4540 ft: 4553 corp: 8/34b exec/s: 6 rss: 323Mb\r\n#128\tpulse  cov: 6319 ft: 9483 corp: 21/196b exec/s: 4 rss: 327Mb\r\n#256\tpulse  cov: 6339 ft: 13188 corp: 104/1621b exec/s: 2 rss: 327Mb\r\n#512\tpulse  cov: 8952 ft: 24180 corp: 262/6023b exec/s: 2 rss: 335Mb\r\n#1024\tpulse  cov: 9924 ft: 36577 corp: 575/23Kb exec/s: 1 rss: 343Mb\r\n<snip>\r\n#2048\tpulse  cov: 10161 ft: 56438 corp: 1218/244Kb exec/s: 0 rss: 371Mb\r\n<snip>\r\n#3776\tINITED cov: 10988 ft: 65398 corp: 1933/10331Kb exec/s: 0 rss: 430Mb\r\n#3776\tDONE   cov: 10988 ft: 65398 corp: 1933/10331Kb lim: 1048576 exec/s: 0 rss: 430Mb\r\nDone 3776 runs in 37778 second(s)\r\n```\r\n\r\nhowever [with this branch, it takes](https://cirrus-ci.com/task/4623075795271680?) 1.5 hours:\r\n\r\n```bash\r\nRun tx_pool_standard with args ['valgrind', '--quiet', '--error-exitcode=1', '/tmp/cirrus-build-1174734651/bitcoin-core/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/test/fuzz/fuzz', '-runs=1', PosixPath('/tmp/cirrus-build-1174734651/bitcoin-core/ci/scratch/qa-assets/fuzz_seed_corpus/tx_pool_standard')]INFO: Running with entropic power schedule (0xFF, 100).\r\nINFO: Seed: 350811728\r\nINFO: Loaded 1 modules   (366489 inline 8-bit counters): 366489 [0x1c106d0, 0x1c69e69), \r\nINFO: Loaded 1 PC tables (366489 PCs): 366489 [0x1c69e70,0x2201800), \r\nINFO:     3775 files found in /tmp/cirrus-build-1174734651/bitcoin-core/ci/scratch/qa-assets/fuzz_seed_corpus/tx_pool_standard\r\nINFO: -max_len is not provided; libFuzzer will not generate inputs larger than 1048576 bytes\r\nINFO: seed corpus: files: 3775 min: 1b max: 2090089b total: 88593805b rss: 302Mb\r\n#64\tpulse  cov: 1172 ft: 1186 corp: 11/47b exec/s: 32 rss: 304Mb\r\n#128\tpulse  cov: 1793 ft: 2253 corp: 32/285b exec/s: 32 rss: 304Mb\r\n#256\tpulse  cov: 1862 ft: 3792 corp: 99/1399b exec/s: 19 rss: 305Mb\r\n#512\tpulse  cov: 3074 ft: 7764 corp: 221/4862b exec/s: 15 rss: 308Mb\r\n#1024\tpulse  cov: 3767 ft: 12721 corp: 498/20Kb exec/s: 10 rss: 314Mb\r\n#2048\tpulse  cov: 4141 ft: 22302 corp: 1101/224Kb exec/s: 5 rss: 341Mb\r\n<snip>\r\n#3776\tINITED cov: 4573 ft: 26452 corp: 1737/6505Kb exec/s: 0 rss: 400Mb\r\n#3776\tDONE   cov: 4573 ft: 26452 corp: 1737/6505Kb lim: 698384 exec/s: 0 rss: 400Mb\r\nDone 3776 runs in 5163 second(s)\r\n```\r\n\r\nRunning the native_valgrind CI (master, aarch64):\r\n```bash\r\ntest/sighash_tests.cpp(120): Entering test case \"sighash_test\"\r\n==21957== Source and destination overlap in memcpy(0x871e4b0, 0x871e4b0, 36)\r\n==21957==    at 0x488CFA0: __GI_memcpy (in /usr/libexec/valgrind/vgpreload_memcheck-arm64-linux.so)\r\n==21957==    by 0x8F7F63: CTxIn::operator=(CTxIn const&) (transaction.h:74)\r\n==21957==    by 0x93F96B: SignatureHashOld(CScript, CTransaction const&, unsigned int, int) (sighash_tests.cpp:76)\r\n==21957==    by 0x93EF1F: sighash_tests::sighash_test::test_method() (sighash_tests.cpp:138)\r\n==21957==    by 0x93EB73: sighash_tests::sighash_test_invoker() (sighash_tests.cpp:120)\r\n==21957==    by 0x36CF47: boost::detail::function::void_function_invoker0<void (*)(), void>::invoke(boost::detail::function::function_buffer&) (function_template.hpp:117)\r\n==21957==    by 0x25B367: boost::function0<void>::operator()() const (function_template.hpp:763)\r\n==21957==    by 0x2D6647: boost::detail::forward::operator()() (execution_monitor.ipp:1388)\r\n==21957==    by 0x2D627F: boost::detail::function::function_obj_invoker0<boost::detail::forward, int>::invoke(boost::detail::function::function_buffer&) (function_template.hpp:137)\r\n==21957==    by 0x2D0393: boost::function0<int>::operator()() const (function_template.hpp:763)\r\n==21957==    by 0x234A6B: int boost::detail::do_invoke<boost::shared_ptr<boost::detail::translator_holder_base>, boost::function<int ()> >(boost::shared_ptr<boost::detail::translator_holder_base> const&, boost::function<int ()> const&) (execution_monitor.ipp:301)\r\n==21957==    by 0x1F7277: boost::execution_monitor::catch_signals(boost::function<int ()> const&) (execution_monitor.ipp:903)\r\n==21957==\r\n{\r\n   <insert_a_suppression_name_here>\r\n   Memcheck:Overlap\r\n   fun:__GI_memcpy\r\n   fun:_ZN5CTxInaSERKS_\r\n   fun:_ZL16SignatureHashOld7CScriptRK12CTransactionji\r\n   fun:_ZN13sighash_tests12sighash_test11test_methodEv\r\n   fun:_ZN13sighash_testsL20sighash_test_invokerEv\r\n   fun:_ZN5boost6detail8function22void_function_invoker0IPFvvEvE6invokeERNS1_15function_bufferE\r\n   fun:_ZNK5boost9function0IvEclEv\r\n   fun:_ZN5boost6detail7forwardclEv\r\n   fun:_ZN5boost6detail8function21function_obj_invoker0INS0_7forwardEiE6invokeERNS1_15function_bufferE\r\n   fun:_ZNK5boost9function0IiEclEv\r\n   fun:_ZN5boost6detail9do_invokeINS_10shared_ptrINS0_22translator_holder_baseEEENS_8functionIFivEEEEEiRKT_RKT0_\r\n   fun:_ZN5boost17execution_monitor13catch_signalsERKNS_8functionIFivEEE\r\n}\r\n```\r\n\r\nvs running this branch:\r\n```bash\r\nreal\t118m55.057s\r\n```\r\n\r\nDisadvantages includes:\r\n* Becoming slightly more of a package manager in the CI.\r\n\r\nRelated to the discussion in https://github.com/bitcoin/bitcoin/pull/27444. See also https://github.com/bitcoin-core/qa-assets/pull/136.",
   "closed_at" : "2023-07-14T09:52:01Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
      "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
      "followers_url" : "https://api.github.com/users/fanquake/followers",
      "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
      "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/fanquake",
      "id" : 863730,
      "login" : "fanquake",
      "node_id" : "MDQ6VXNlcjg2MzczMA==",
      "organizations_url" : "https://api.github.com/users/fanquake/orgs",
      "received_events_url" : "https://api.github.com/users/fanquake/received_events",
      "repos_url" : "https://api.github.com/users/fanquake/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/fanquake"
   },
   "comments" : 11,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27992/comments",
   "created_at" : "2023-06-28T14:41:17Z",
   "draft" : false,
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27992/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/27992",
   "id" : 1779110507,
   "labels" : [
      {
         "color" : "ebd775",
         "default" : false,
         "description" : null,
         "id" : 64584,
         "name" : "Brainstorming",
         "node_id" : "MDU6TGFiZWw2NDU4NA==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Brainstorming"
      },
      {
         "color" : "d4c5f9",
         "default" : false,
         "description" : null,
         "id" : 62963516,
         "name" : "Tests",
         "node_id" : "MDU6TGFiZWw2Mjk2MzUxNg==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Tests"
      },
      {
         "color" : "cccccc",
         "default" : false,
         "description" : "",
         "id" : 5334691551,
         "name" : "CI failed",
         "node_id" : "LA_kwDOABII588AAAABPfju3w",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/CI%20failed"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27992/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "PR_kwDOABII585UJnYF",
   "number" : 27992,
   "performed_via_github_app" : null,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/27992.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27992",
      "merged_at" : null,
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/27992.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27992"
   },
   "reactions" : {
      "+1" : 0,
      "-1" : 0,
      "confused" : 0,
      "eyes" : 0,
      "heart" : 0,
      "hooray" : 0,
      "laugh" : 0,
      "rocket" : 0,
      "total_count" : 0,
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27992/reactions"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "state_reason" : null,
   "timeline_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27992/timeline",
   "title" : "ci: build Valgrind (3.21) from source",
   "updated_at" : "2023-07-14T09:52:01Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27992",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
      "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
      "followers_url" : "https://api.github.com/users/fanquake/followers",
      "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
      "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/fanquake",
      "id" : 863730,
      "login" : "fanquake",
      "node_id" : "MDQ6VXNlcjg2MzczMA==",
      "organizations_url" : "https://api.github.com/users/fanquake/orgs",
      "received_events_url" : "https://api.github.com/users/fanquake/received_events",
      "repos_url" : "https://api.github.com/users/fanquake/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/fanquake"
   }
}
