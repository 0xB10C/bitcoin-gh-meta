[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/1909#discussion_r1766996"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/1909"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1766996"
         }
      },
      "body" : "What if OutputDebugStringF is being called twice simultaneously? This doesn't solve anything, unless you have a guaranteed call of this function while still in single-thread modus. That's almost certainly the case, but if it is, why not make it obvious, and have an InitLogging() function, called in init?\r\n\r\nI'm nitpicking. ACK.",
      "commit_id" : "cac6b389d101999d98c3137b17812cce062f924d",
      "created_at" : "2012-10-04T21:02:38Z",
      "diff_hunk" : "@@ -220,8 +220,14 @@ inline int OutputDebugStringF(const char* pszFormat, ...)\n         if (fileout)\n         {\n             static bool fStartedNewLine = true;\n-            static boost::mutex mutexDebugLog;\n-            boost::mutex::scoped_lock scoped_lock(mutexDebugLog);\n+\n+            // This routine may be called by global destructors during shutdown.\n+            // Since the order of destruction of static/global objects is undefined,\n+            // allocate mutexDebugLog on the heap the first time this routine\n+            // is called to avoid crashes during shutdown.\n+            static boost::mutex* mutexDebugLog = NULL;\n+            if (mutexDebugLog == NULL) mutexDebugLog = new boost::mutex();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1909#discussion_r1766996",
      "id" : 1766996,
      "original_commit_id" : "cac6b389d101999d98c3137b17812cce062f924d",
      "original_position" : 12,
      "path" : "src/util.cpp",
      "position" : 12,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/1909",
      "updated_at" : "2012-10-04T21:02:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1766996",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/1909#discussion_r1769855"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/1909"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1769855"
         }
      },
      "body" : "@sipa I also proposed that in #1832. I'm for explicitly constructing and destructing the global objects, such as logging and db, enforced by assertions. This makes thiings more predictable and maintainable than armoring against all possible non-determinism (which is pretty much impossible, you will forget something).\r\n\r\nThen again, it's good to have a fix in for 0.7.1. ACK.",
      "commit_id" : "cac6b389d101999d98c3137b17812cce062f924d",
      "created_at" : "2012-10-05T05:27:37Z",
      "diff_hunk" : "@@ -220,8 +220,14 @@ inline int OutputDebugStringF(const char* pszFormat, ...)\n         if (fileout)\n         {\n             static bool fStartedNewLine = true;\n-            static boost::mutex mutexDebugLog;\n-            boost::mutex::scoped_lock scoped_lock(mutexDebugLog);\n+\n+            // This routine may be called by global destructors during shutdown.\n+            // Since the order of destruction of static/global objects is undefined,\n+            // allocate mutexDebugLog on the heap the first time this routine\n+            // is called to avoid crashes during shutdown.\n+            static boost::mutex* mutexDebugLog = NULL;\n+            if (mutexDebugLog == NULL) mutexDebugLog = new boost::mutex();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1909#discussion_r1769855",
      "id" : 1769855,
      "original_commit_id" : "cac6b389d101999d98c3137b17812cce062f924d",
      "original_position" : 12,
      "path" : "src/util.cpp",
      "position" : 12,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/1909",
      "updated_at" : "2012-10-05T05:27:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1769855",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Automatic sanity-testing: PASSED, see http://jenkins.bluematt.me/pull-tester/cac6b389d101999d98c3137b17812cce062f924d for binaries and test log.",
      "created_at" : "2012-10-05T12:14:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1909#issuecomment-9173452",
      "id" : 9173452,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1909",
      "updated_at" : "2012-10-05T12:14:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/9173452",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2110907?v=3",
         "events_url" : "https://api.github.com/users/BitcoinPullTester/events{/privacy}",
         "followers_url" : "https://api.github.com/users/BitcoinPullTester/followers",
         "following_url" : "https://api.github.com/users/BitcoinPullTester/following{/other_user}",
         "gists_url" : "https://api.github.com/users/BitcoinPullTester/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/BitcoinPullTester",
         "id" : 2110907,
         "login" : "BitcoinPullTester",
         "organizations_url" : "https://api.github.com/users/BitcoinPullTester/orgs",
         "received_events_url" : "https://api.github.com/users/BitcoinPullTester/received_events",
         "repos_url" : "https://api.github.com/users/BitcoinPullTester/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/BitcoinPullTester/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/BitcoinPullTester/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/BitcoinPullTester"
      }
   },
   {
      "body" : "Yeah, it just seems terribly odd and possibly error-prone to allocate a lock... in a racy fashion.\r\n\r\nJust make the lock global and put it early in main, to make sure it is instantiated/initialized before anything else in the program.\r\n\r\nAs it stands now, either this your change or without, the first-use occurs very late in the program, and that seems like a root cause (or at least contributing factor).",
      "created_at" : "2012-10-08T22:09:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1909#issuecomment-9242045",
      "id" : 9242045,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1909",
      "updated_at" : "2012-10-08T22:09:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/9242045",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "body" : "@jgarzik making it global and putting it early in main won't fix the problem; the order of global destructors is undefined in C++.\r\n\r\nAs long as there is a printf/OutputDebugStringF before we start creating threads (and there is, early in AppInit2()) there is no race.\r\n\r\nReworking logging should be done... someday...  For now, I think this little change is the right thing to do.\r\n",
      "created_at" : "2012-10-08T23:09:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1909#issuecomment-9243705",
      "id" : 9243705,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1909",
      "updated_at" : "2012-10-08T23:09:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/9243705",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "body" : "gcc has long followed the now defined C++0x order described here: http://cpp0x.centaur.ath.cx/basic.start.term.html\r\n\r\n_\"If the completion of the constructor or dynamic initialization of an object with static storage duration is sequenced before that of another, the completion of the destructor of the second is sequenced before the initiation of the destructor of the first. If an object is initialized statically, the object is destroyed in the same order as if the object was dynamically initialized\"_",
      "created_at" : "2012-10-08T23:41:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1909#issuecomment-9244380",
      "id" : 9244380,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1909",
      "updated_at" : "2012-10-08T23:41:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/9244380",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "body" : "I already acked this for 0.7.1 (assuming we want this out of the door soon), but it does need more thinking.\r\n\r\nIf you make the pointer global (i.s.o static) and explicitly initialize it in an InitLogging() (called directly at the beginning of AppInit2) function you avoid the destructor trouble, plus you don't make the safety of initialization dependent on who-calls-first. Then add an assert() to printf that the lock is allocated, just in case. Another plus is that you can use the same lock in `#ifdef WIN32 if(fPrintToDebugger)`, where the issue still exists.\r\n\r\nAfter all, printf *does* have some prerequisite requirements: it needs the arguments to be parsed and DataDir to be set correctly, which is only guaranteed when entering AppInit2. What if someone accidentally adds a printf before this is done? (ie, in GUI initialization, after all a printf looks reaaallly harmless):\r\n\r\n- It logs to the wrong datadir (the default one). Not that big of an issue for a few log messages to end up in the wrong log. However,\r\n- It *caches* this datadir in cachedPath, and will return it every time GetDataDir is called. Uh oh!\r\n\r\nAn explicit InitLogging() call would solve this, and trap all accidental calls to printf before everything is in order. \r\n\r\nTalking of GetDataDir, it has the same issue. Though we jump the shark as it will never enter the lock when the path is cached, which you expect by the time it reaches destructors :-) But I can see another subtle initialization race, I think.\r\n",
      "created_at" : "2012-10-09T06:01:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1909#issuecomment-9249891",
      "id" : 9249891,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1909",
      "updated_at" : "2012-10-09T06:02:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/9249891",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Ok.  I pinky-swear promise I'll rewrite this The Right Way for 0.8.\r\n",
      "created_at" : "2012-10-09T16:10:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1909#issuecomment-9267676",
      "id" : 9267676,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1909",
      "updated_at" : "2012-10-09T16:10:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/9267676",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "body" : "Maybe The Right Way means using http://www.boost.org/doc/libs/1_32_0/doc/html/call_once.html ?",
      "created_at" : "2012-10-10T16:12:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/1909#issuecomment-9309099",
      "id" : 9309099,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/1909",
      "updated_at" : "2012-10-10T16:12:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/9309099",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   }
]
