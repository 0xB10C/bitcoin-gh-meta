[
   {
      "body" : "utACK. Consider adding a unit test that calls it twice, with a sleep and makes sure the value changes?",
      "created_at" : "2017-05-03T01:25:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10322#issuecomment-298804130",
      "id" : 298804130,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10322",
      "updated_at" : "2017-05-03T01:25:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/298804130",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10322#discussion_r114461456"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10322"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114461456"
         }
      },
      "body" : "Maybe link to https://en.wikipedia.org/wiki/Time_Stamp_Counter for readers that don't know what this could be?\r\n\r\nAlso,  I couldn't find a description on the constraints `a` or `d`,  I assume they are just writing to the inline variables `r1` and `r2`,  but I found documentation on this to be difficult to find.\r\n\r\nAlso,  is `volatile` necessary?  It doesn't hurt I suppose?",
      "commit_id" : "88f73de0637c41d7b41426ad5e71701c02b6634b",
      "created_at" : "2017-05-03T01:43:34Z",
      "diff_hunk" : "@@ -43,15 +43,21 @@ static void RandFailure()\n \n static inline int64_t GetPerformanceCounter()\n {\n-    int64_t nCounter = 0;\n-#ifdef WIN32\n-    QueryPerformanceCounter((LARGE_INTEGER*)&nCounter);\n+#if defined(_MSC_VER)\n+    return __rdtsc();\n+#elif defined(__i386__)\n+    uint64_t r;\n+    __asm__ volatile (\"rdtsc\" : \"=A\"(r));\n+    return r;\n+#elif defined(__x86_64__) || defined(__amd64__)\n+    uint64_t r1, r2;\n+    __asm__ volatile (\"rdtsc\" : \"=a\"(r1), \"=d\"(r2));\n+    return (r2 << 32) | r1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10322#discussion_r114461456",
      "id" : 114461456,
      "original_commit_id" : "69e03dd7cad0bfc863633103e2f536977fb80ae5",
      "original_position" : 16,
      "path" : "src/random.cpp",
      "position" : null,
      "pull_request_review_id" : 35928791,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10322",
      "updated_at" : "2017-05-03T02:05:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114461456",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/413395?v=3",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10322#discussion_r114461743"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10322"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114461743"
         }
      },
      "body" : "If resuming from hibernation,  might this counter be,  or close to, zero?",
      "commit_id" : "88f73de0637c41d7b41426ad5e71701c02b6634b",
      "created_at" : "2017-05-03T01:47:18Z",
      "diff_hunk" : "@@ -43,15 +43,21 @@ static void RandFailure()\n \n static inline int64_t GetPerformanceCounter()\n {\n-    int64_t nCounter = 0;\n-#ifdef WIN32\n-    QueryPerformanceCounter((LARGE_INTEGER*)&nCounter);\n+#if defined(_MSC_VER)\n+    return __rdtsc();\n+#elif defined(__i386__)\n+    uint64_t r;\n+    __asm__ volatile (\"rdtsc\" : \"=A\"(r));\n+    return r;\n+#elif defined(__x86_64__) || defined(__amd64__)\n+    uint64_t r1, r2;\n+    __asm__ volatile (\"rdtsc\" : \"=a\"(r1), \"=d\"(r2));\n+    return (r2 << 32) | r1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10322#discussion_r114461743",
      "id" : 114461743,
      "original_commit_id" : "69e03dd7cad0bfc863633103e2f536977fb80ae5",
      "original_position" : 16,
      "path" : "src/random.cpp",
      "position" : null,
      "pull_request_review_id" : 35929075,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10322",
      "updated_at" : "2017-05-03T02:05:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114461743",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/413395?v=3",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10322#discussion_r114462518"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10322"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114462518"
         }
      },
      "body" : "I added some comments, but I don't think this warrants a full explanation of extended asm syntax in comments.\r\n\r\n> Also, I couldn't find a description on the constraints a or d, I assume they are just writing to the inline variables r1 and r2, but I found documentation on this to be difficult to find.\r\n\r\nSee https://gcc.gnu.org/onlinedocs/gcc-4.9.0/gcc/Machine-Constraints.html#Machine-Constraints\r\n\r\n\"A\" is the ax:dx register pair, so on x86 we constrain the `r` variable to be 64 bits consisting of 32 bits in ax and 32 bits in dx. Since rdtsc always stores its result in ax/dx, we get the correct result in the C++ variable r. \"a\" and \"d\" just constrain to the (r)ax and (r)dx registers, which is where the individual parts of the rdtsc result are stored on x86_64.\r\n\r\n> Also, is volatile necessary? It doesn't hurt I suppose?\r\n\r\nIt's there to limit the optimizations the compiler can apply to the assembly block. See https://gcc.gnu.org/onlinedocs/gcc/Extended-Asm.html#Volatile\r\n",
      "commit_id" : "88f73de0637c41d7b41426ad5e71701c02b6634b",
      "created_at" : "2017-05-03T01:59:24Z",
      "diff_hunk" : "@@ -43,15 +43,21 @@ static void RandFailure()\n \n static inline int64_t GetPerformanceCounter()\n {\n-    int64_t nCounter = 0;\n-#ifdef WIN32\n-    QueryPerformanceCounter((LARGE_INTEGER*)&nCounter);\n+#if defined(_MSC_VER)\n+    return __rdtsc();\n+#elif defined(__i386__)\n+    uint64_t r;\n+    __asm__ volatile (\"rdtsc\" : \"=A\"(r));\n+    return r;\n+#elif defined(__x86_64__) || defined(__amd64__)\n+    uint64_t r1, r2;\n+    __asm__ volatile (\"rdtsc\" : \"=a\"(r1), \"=d\"(r2));\n+    return (r2 << 32) | r1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10322#discussion_r114462518",
      "id" : 114462518,
      "original_commit_id" : "69e03dd7cad0bfc863633103e2f536977fb80ae5",
      "original_position" : 16,
      "path" : "src/random.cpp",
      "position" : null,
      "pull_request_review_id" : 35929894,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10322",
      "updated_at" : "2017-05-03T02:05:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114462518",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10322#discussion_r114462723"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10322"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114462723"
         }
      },
      "body" : "> If resuming from hibernation, might this counter be, or close to, zero?\r\n\r\nI don't think that's a concern. It's still a fine entropy source. This thing counts in clock cycles (~nanoseconds and less, usually). If an attacker knows how many nanoseconds ago your last wakeup from hibernation was, you probably have bigger problems.",
      "commit_id" : "88f73de0637c41d7b41426ad5e71701c02b6634b",
      "created_at" : "2017-05-03T02:01:28Z",
      "diff_hunk" : "@@ -43,15 +43,21 @@ static void RandFailure()\n \n static inline int64_t GetPerformanceCounter()\n {\n-    int64_t nCounter = 0;\n-#ifdef WIN32\n-    QueryPerformanceCounter((LARGE_INTEGER*)&nCounter);\n+#if defined(_MSC_VER)\n+    return __rdtsc();\n+#elif defined(__i386__)\n+    uint64_t r;\n+    __asm__ volatile (\"rdtsc\" : \"=A\"(r));\n+    return r;\n+#elif defined(__x86_64__) || defined(__amd64__)\n+    uint64_t r1, r2;\n+    __asm__ volatile (\"rdtsc\" : \"=a\"(r1), \"=d\"(r2));\n+    return (r2 << 32) | r1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10322#discussion_r114462723",
      "id" : 114462723,
      "original_commit_id" : "69e03dd7cad0bfc863633103e2f536977fb80ae5",
      "original_position" : 16,
      "path" : "src/random.cpp",
      "position" : null,
      "pull_request_review_id" : 35930095,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10322",
      "updated_at" : "2017-05-03T02:05:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114462723",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10322#discussion_r114464323"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10322"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114464323"
         }
      },
      "body" : "Thanks for the explanations and links @sipa,  I had been searching for that list but couldn't find it.",
      "commit_id" : "88f73de0637c41d7b41426ad5e71701c02b6634b",
      "created_at" : "2017-05-03T02:28:36Z",
      "diff_hunk" : "@@ -43,15 +43,21 @@ static void RandFailure()\n \n static inline int64_t GetPerformanceCounter()\n {\n-    int64_t nCounter = 0;\n-#ifdef WIN32\n-    QueryPerformanceCounter((LARGE_INTEGER*)&nCounter);\n+#if defined(_MSC_VER)\n+    return __rdtsc();\n+#elif defined(__i386__)\n+    uint64_t r;\n+    __asm__ volatile (\"rdtsc\" : \"=A\"(r));\n+    return r;\n+#elif defined(__x86_64__) || defined(__amd64__)\n+    uint64_t r1, r2;\n+    __asm__ volatile (\"rdtsc\" : \"=a\"(r1), \"=d\"(r2));\n+    return (r2 << 32) | r1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10322#discussion_r114464323",
      "id" : 114464323,
      "original_commit_id" : "69e03dd7cad0bfc863633103e2f536977fb80ae5",
      "original_position" : 16,
      "path" : "src/random.cpp",
      "position" : null,
      "pull_request_review_id" : 35931657,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10322",
      "updated_at" : "2017-05-03T02:28:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114464323",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/413395?v=3",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10322#discussion_r114677468"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10322"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114677468"
         }
      },
      "body" : "Does MSVC support ARM now?",
      "commit_id" : "88f73de0637c41d7b41426ad5e71701c02b6634b",
      "created_at" : "2017-05-03T23:37:52Z",
      "diff_hunk" : "@@ -43,15 +43,24 @@ static void RandFailure()\n \n static inline int64_t GetPerformanceCounter()\n {\n-    int64_t nCounter = 0;\n-#ifdef WIN32\n-    QueryPerformanceCounter((LARGE_INTEGER*)&nCounter);\n+    // Read the hardware time stamp counter when available.\n+    // See https://en.wikipedia.org/wiki/Time_Stamp_Counter for more information.\n+#if defined(_MSC_VER)\n+    return __rdtsc();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10322#discussion_r114677468",
      "id" : 114677468,
      "original_commit_id" : "88f73de0637c41d7b41426ad5e71701c02b6634b",
      "original_position" : 10,
      "path" : "src/random.cpp",
      "position" : 10,
      "pull_request_review_id" : 36164337,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10322",
      "updated_at" : "2017-05-03T23:37:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114677468",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10322#discussion_r114680293"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10322"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114680293"
         }
      },
      "body" : "No idea. But their documentation doesn't specify any restrictions on when __rdtsc is available.",
      "commit_id" : "88f73de0637c41d7b41426ad5e71701c02b6634b",
      "created_at" : "2017-05-04T00:03:24Z",
      "diff_hunk" : "@@ -43,15 +43,24 @@ static void RandFailure()\n \n static inline int64_t GetPerformanceCounter()\n {\n-    int64_t nCounter = 0;\n-#ifdef WIN32\n-    QueryPerformanceCounter((LARGE_INTEGER*)&nCounter);\n+    // Read the hardware time stamp counter when available.\n+    // See https://en.wikipedia.org/wiki/Time_Stamp_Counter for more information.\n+#if defined(_MSC_VER)\n+    return __rdtsc();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10322#discussion_r114680293",
      "id" : 114680293,
      "original_commit_id" : "88f73de0637c41d7b41426ad5e71701c02b6634b",
      "original_position" : 10,
      "path" : "src/random.cpp",
      "position" : 10,
      "pull_request_review_id" : 36167427,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10322",
      "updated_at" : "2017-05-04T00:03:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/114680293",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   }
]
