[
   {
      "author_association" : "MEMBER",
      "body" : "Nice observation.\r\n\r\n(Brainstorm idea) How about something like doubling the timeout every time it causes a disconnection. And then reducing/resetting it when the window actually moves?",
      "created_at" : "2022-08-19T19:51:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25880#issuecomment-1221043636",
      "id" : 1221043636,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25880",
      "node_id" : "IC_kwDOABII585Ix6W0",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1221043636/reactions"
      },
      "updated_at" : "2022-08-19T19:51:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1221043636",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : ">Collect statistics from recent block download times during IBD and have a dynamic timeout based on this. (Introduces more complexity, but might be better in certain situations, e.g. when 6s aren't sufficient either).\r\n\r\nRather than this, it might be better to track download speeds from each peer, and check the speeds of this peer after 2 seconds.\r\n\r\nFor an immediate fix, though, maybe just making the timeout configurable would be a good idea?\r\n\r\nPerhaps as an interim between these two ideas, if we disconnect N stalling peers, start increasing the timeout.",
      "created_at" : "2022-08-20T20:40:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25880#issuecomment-1221405113",
      "id" : 1221405113,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25880",
      "node_id" : "IC_kwDOABII585IzSm5",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1221405113/reactions"
      },
      "updated_at" : "2022-08-20T20:40:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1221405113",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Rather than this, it might be better to track download speeds from each peer, and check the speeds of this peer after 2 seconds.\r\n\r\nWe would also have to compare it to the speed of others and have some criterion what deviation would be enough to disconnect.\r\n\r\n>How about something like doubling the timeout every time it causes a disconnection. And then reducing/resetting it when the window actually moves?\r\n\r\n> Perhaps as an interim between these two ideas, if we disconnect N stalling peers, start increasing the timeout.\r\n\r\nThanks! These suggestions are similar, make a lot of sense to me, and don't look very invasive to implement, planning to change to this approach and update soon.",
      "created_at" : "2022-08-22T14:21:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25880#issuecomment-1222432129",
      "id" : 1222432129,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25880",
      "node_id" : "IC_kwDOABII585I3NWB",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1222432129/reactions"
      },
      "updated_at" : "2022-08-22T14:21:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1222432129",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I now implemented the suggestion by @sipa to double the timeout and updated the OP.\r\n\r\nI tested this manually by catching up to the best chain with an ~1 month old datadir with `-onlynet=tor` (slow, blocks take ~10s to download), while reducing `BLOCK_DOWNLOAD_WINDOW` and `MAX_BLOCKS_IN_TRANSIT_PER_PEER` to make stalling situations happen more quickly. ",
      "created_at" : "2022-08-24T15:06:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25880#issuecomment-1225853199",
      "id" : 1225853199,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25880",
      "node_id" : "IC_kwDOABII585JEQkP",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1225853199/reactions"
      },
      "updated_at" : "2022-08-24T15:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1225853199",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Nice! This seems a fine improvement.\r\n\r\nI think one way of looking at stalling is that it happens when one peer's bandwidth is less than 1/64th of the total bandwidth (64 = 1024/16 = window/max in transit) [0]. \r\n\r\nI think that means there might be a clever way of preventing slow nodes from stalling the download by reducing the in transit limit instead -- so that instead of supplying 16 blocks in the time it takes the other peers to supply 1008 to avoid stalling, the peer only needs to supply 8 or 4 blocks in the time it takes the other peers to supply 1016 or 1020. [1]\r\n\r\nI think adding the blocks only nodes probably made this slightly worse, since there are now 2 extra peers, so now you need something like 25% more bandwidth in order to still have 1/64th of the total...\r\n\r\n[0] Measured in blocks of course, so even if your bandwidth in bytes is fine, you might be unlucky to be asked for 16 blocks that are 2MB each, while everyone else is just being asked for 1008 50kB blocks at you (32MB total vs 7.2MB per peer).\r\n\r\n[1] Perhaps you could implement this by keeping a global and per-peer exponential rolling average of how many blocks you download per second; then you could set the peer's in-transit limit to `1024 * peer_avg / global_avg`; capping it at 16, and marking the peer as stalling and disconnecting if that value drops below 2 (in which case the remaining peers *each* have 50x this peer's bandwidth)?",
      "created_at" : "2022-08-26T14:31:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25880#issuecomment-1228565836",
      "id" : 1228565836,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25880",
      "node_id" : "IC_kwDOABII585JOm1M",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1228565836/reactions"
      },
      "updated_at" : "2022-08-26T14:31:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1228565836",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25880#discussion_r956425910"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25880"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/956425910"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I would think only reduce the timeout if the block was in fact downloaded in less time (than the would-be *new* timeout).",
      "commit_id" : "686936c92afa30b38ad11e4c04af6b98e104e79f",
      "created_at" : "2022-08-26T20:27:05Z",
      "diff_hunk" : "@@ -1723,6 +1729,9 @@ void PeerManagerImpl::BlockConnected(const std::shared_ptr<const CBlock>& pblock\n             m_txrequest.ForgetTxHash(ptx->GetWitnessHash());\n         }\n     }\n+    if (m_chainman.ActiveChainstate().IsInitialBlockDownload()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25880#discussion_r956425910",
      "id" : 956425910,
      "line" : 1732,
      "node_id" : "PRRC_kwDOABII5845Aea2",
      "original_commit_id" : "686936c92afa30b38ad11e4c04af6b98e104e79f",
      "original_line" : 1732,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 28,
      "pull_request_review_id" : 1087492146,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25880",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/956425910/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-26T20:28:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/956425910",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25880#discussion_r958962230"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25880"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/958962230"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I like about the current solution that it is very simple, prevents the node from getting stuck, and doesn't require additional bookkeeping of historical block download times.\r\n\r\nI think your suggestion wouldn't be completely straightforward to implement: The block being connected here might have been downloaded some time in the past, saved to disk, but only connected now (as a result of its predecessor being connected). So we'd need some data structure to keep track of download times for not-yet-connected blocks and add/remove entries from it during IBD.\r\n\r\nIf we did this, it would help us cycle through less peers in situations where we assign multiple blocks to a peer and halving the timeout after successfully downloading a block would lead to a stalling situation again - but note that there are also other sources of disconnections that could be improved if we kept track of this kind data during IBD: E.g. if doubling the timeout is not sufficient and we'd need to 4x or 8x it.\r\n\r\nSo if we want something better but more complicated (with bookkeeping), my feeling is that we should go for another approach altogether, like basing the stalling timeout on a running average over the last received block times from multiple peers instead of a doubling/halving approach.\r\n",
      "commit_id" : "686936c92afa30b38ad11e4c04af6b98e104e79f",
      "created_at" : "2022-08-30T21:54:44Z",
      "diff_hunk" : "@@ -1723,6 +1729,9 @@ void PeerManagerImpl::BlockConnected(const std::shared_ptr<const CBlock>& pblock\n             m_txrequest.ForgetTxHash(ptx->GetWitnessHash());\n         }\n     }\n+    if (m_chainman.ActiveChainstate().IsInitialBlockDownload()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25880#discussion_r958962230",
      "id" : 958962230,
      "in_reply_to_id" : 956425910,
      "line" : 1732,
      "node_id" : "PRRC_kwDOABII5845KJo2",
      "original_commit_id" : "686936c92afa30b38ad11e4c04af6b98e104e79f",
      "original_line" : 1732,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 28,
      "pull_request_review_id" : 1091011833,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25880",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/958962230/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-30T21:54:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/958962230",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25880#discussion_r958969743"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25880"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/958969743"
         }
      },
      "author_association" : "MEMBER",
      "body" : "With this current code, it will stall, get a block, stall, get a block, stall, etc repeatedly...",
      "commit_id" : "7c8c4e47137aa8c6e96163f55ccfadc75ba84c1a",
      "created_at" : "2022-08-30T22:08:04Z",
      "diff_hunk" : "@@ -1723,6 +1729,9 @@ void PeerManagerImpl::BlockConnected(const std::shared_ptr<const CBlock>& pblock\n             m_txrequest.ForgetTxHash(ptx->GetWitnessHash());\n         }\n     }\n+    if (m_chainman.ActiveChainstate().IsInitialBlockDownload()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25880#discussion_r958969743",
      "id" : 958969743,
      "in_reply_to_id" : 956425910,
      "line" : 1732,
      "node_id" : "PRRC_kwDOABII5845KLeP",
      "original_commit_id" : "686936c92afa30b38ad11e4c04af6b98e104e79f",
      "original_line" : 1732,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 28,
      "pull_request_review_id" : 1091021888,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25880",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/958969743/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-30T22:08:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/958969743",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25880#discussion_r958972383"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25880"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/958972383"
         }
      },
      "author_association" : "NONE",
      "body" : "Okay ",
      "commit_id" : "7c8c4e47137aa8c6e96163f55ccfadc75ba84c1a",
      "created_at" : "2022-08-30T22:12:46Z",
      "diff_hunk" : "@@ -1723,6 +1729,9 @@ void PeerManagerImpl::BlockConnected(const std::shared_ptr<const CBlock>& pblock\n             m_txrequest.ForgetTxHash(ptx->GetWitnessHash());\n         }\n     }\n+    if (m_chainman.ActiveChainstate().IsInitialBlockDownload()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25880#discussion_r958972383",
      "id" : 958972383,
      "in_reply_to_id" : 956425910,
      "line" : 1732,
      "node_id" : "PRRC_kwDOABII5845KMHf",
      "original_commit_id" : "686936c92afa30b38ad11e4c04af6b98e104e79f",
      "original_line" : 1732,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 28,
      "pull_request_review_id" : 1091025263,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25880",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/958972383/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-30T22:12:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/958972383",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/99142380?v=4",
         "events_url" : "https://api.github.com/users/Ellajoke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Ellajoke/followers",
         "following_url" : "https://api.github.com/users/Ellajoke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Ellajoke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Ellajoke",
         "id" : 99142380,
         "login" : "Ellajoke",
         "node_id" : "U_kgDOBejK7A",
         "organizations_url" : "https://api.github.com/users/Ellajoke/orgs",
         "received_events_url" : "https://api.github.com/users/Ellajoke/received_events",
         "repos_url" : "https://api.github.com/users/Ellajoke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Ellajoke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Ellajoke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Ellajoke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> I think that means there might be a clever way of preventing slow nodes from stalling the download by reducing the in transit limit instead -- so that instead of supplying 16 blocks in the time it takes the other peers to supply 1008 to avoid stalling, the peer only needs to supply 8 or 4 blocks in the time it takes the other peers to supply 1016 or 1020. [1]\r\n\r\nThat sounds like a very interesting alternative approach. I'm not sure I understand it completely though: Are you suggesting to assign slower peers less blocks simultaneously, to help prevent stalling situations from occurring in the first place? And also move away from the concept that a stalling situation occurs only when we can't move the 1024 block window forward, but make it dependent on the other peers instead, so that we'd possibly disconnect slow peers much earlier than that if they are slower in comparison to faster ones?\r\n",
      "created_at" : "2022-08-30T22:30:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25880#issuecomment-1232235365",
      "id" : 1232235365,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25880",
      "node_id" : "IC_kwDOABII585Jcmtl",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1232235365/reactions"
      },
      "updated_at" : "2022-08-30T22:30:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1232235365",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25880#discussion_r958991800"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25880"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/958991800"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> With this current code, it will stall, get a block, stall, get a block, stall, etc repeatedly...\r\n\r\nYes, but only a few times until the blocks preventing the tip from moving are downloaded, then the tip advances by connecting the large number of stashed blocks from the 1024 window, ending the stalling situation. If every peer is equally slow, it doesn't matter if you download a block in 2s or 1 minute from the viewpoint of the stalling logic.",
      "commit_id" : "7c8c4e47137aa8c6e96163f55ccfadc75ba84c1a",
      "created_at" : "2022-08-30T22:38:30Z",
      "diff_hunk" : "@@ -1723,6 +1729,9 @@ void PeerManagerImpl::BlockConnected(const std::shared_ptr<const CBlock>& pblock\n             m_txrequest.ForgetTxHash(ptx->GetWitnessHash());\n         }\n     }\n+    if (m_chainman.ActiveChainstate().IsInitialBlockDownload()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25880#discussion_r958991800",
      "id" : 958991800,
      "in_reply_to_id" : 956425910,
      "line" : 1732,
      "node_id" : "PRRC_kwDOABII5845KQ24",
      "original_commit_id" : "686936c92afa30b38ad11e4c04af6b98e104e79f",
      "original_line" : 1732,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 28,
      "pull_request_review_id" : 1091051121,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25880",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/958991800/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-30T22:39:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/958991800",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25880#discussion_r958999282"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25880"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/958999282"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Maybe instead of halving the timeout, we should, on block connection, multiply it with a factor `0.5 < f < 1` to let it go back slower? ",
      "commit_id" : "7c8c4e47137aa8c6e96163f55ccfadc75ba84c1a",
      "created_at" : "2022-08-30T22:54:51Z",
      "diff_hunk" : "@@ -1723,6 +1729,9 @@ void PeerManagerImpl::BlockConnected(const std::shared_ptr<const CBlock>& pblock\n             m_txrequest.ForgetTxHash(ptx->GetWitnessHash());\n         }\n     }\n+    if (m_chainman.ActiveChainstate().IsInitialBlockDownload()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25880#discussion_r958999282",
      "id" : 958999282,
      "in_reply_to_id" : 956425910,
      "line" : 1732,
      "node_id" : "PRRC_kwDOABII5845KSry",
      "original_commit_id" : "686936c92afa30b38ad11e4c04af6b98e104e79f",
      "original_line" : 1732,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 28,
      "pull_request_review_id" : 1091060970,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25880",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/958999282/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-30T22:55:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/958999282",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25880#discussion_r959253273"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25880"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/959253273"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Once the max is reached, this would print repeated messages like\r\n```\r\nIncreased timeout to 64 seconds\r\nIncreased timeout to 64 seconds\r\nIncreased timeout to 64 seconds\r\n...\r\n```\r\n\r\nwhich would be misleading because the timeout was not _increased_.",
      "commit_id" : "7c8c4e47137aa8c6e96163f55ccfadc75ba84c1a",
      "created_at" : "2022-08-31T07:34:49Z",
      "diff_hunk" : "@@ -5225,12 +5234,16 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n             m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::INV, vInv));\n \n         // Detect whether we're stalling\n-        if (state.m_stalling_since.count() && state.m_stalling_since < current_time - BLOCK_STALLING_TIMEOUT) {\n+        if (state.m_stalling_since.count() && state.m_stalling_since < current_time - m_block_stalling_timeout.load()) {\n             // Stalling only triggers when the block download window cannot move. During normal steady state,\n             // the download window should be much larger than the to-be-downloaded set of blocks, so disconnection\n             // should only happen during initial block download.\n             LogPrintf(\"Peer=%d is stalling block download, disconnecting\\n\", pto->GetId());\n             pto->fDisconnect = true;\n+            // Increase timeout for the next peer so that we don't disconnect multiple peers if our own\n+            // bandwidth is insufficient.\n+            m_block_stalling_timeout = std::min(2 * m_block_stalling_timeout.load(), MAX_BLOCK_STALLING_TIMEOUT);\n+            LogPrint(BCLog::NET, \"Increased stalling timeout temporarily to %d seconds\\n\", m_block_stalling_timeout.load().count());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25880#discussion_r959253273",
      "id" : 959253273,
      "line" : 5246,
      "node_id" : "PRRC_kwDOABII5845LQsZ",
      "original_commit_id" : "7c8c4e47137aa8c6e96163f55ccfadc75ba84c1a",
      "original_line" : 5246,
      "original_position" : 48,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 48,
      "pull_request_review_id" : 1091419557,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25880",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/959253273/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-31T08:18:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/959253273",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25880#discussion_r959286134"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25880"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/959286134"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This sequence is not atomic. If two threads execute concurrently the increase/decrease code it would lead to unexpected results. Consider this, it only does the inc/dec if no other thread changed the value in the meantime, otherwise leaves it untouched:\r\n\r\n<details>\r\n<summary>atomic</summary>\r\n\r\n```diff\r\ndiff --git i/src/net_processing.cpp w/src/net_processing.cpp\r\nindex 42686f0db0..fd2f22cdcd 100644\r\n--- i/src/net_processing.cpp\r\n+++ w/src/net_processing.cpp\r\n@@ -1726,14 +1726,16 @@ void PeerManagerImpl::BlockConnected(const std::shared_ptr<const CBlock>& pblock\r\n         LOCK(cs_main);\r\n         for (const auto& ptx : pblock->vtx) {\r\n             m_txrequest.ForgetTxHash(ptx->GetHash());\r\n             m_txrequest.ForgetTxHash(ptx->GetWitnessHash());\r\n         }\r\n     }\r\n-    if (m_chainman.ActiveChainstate().IsInitialBlockDownload()) {\r\n-        m_block_stalling_timeout = std::max(m_block_stalling_timeout.load() / 2, DEFAULT_BLOCK_STALLING_TIMEOUT);\r\n+    auto stalling_timeout = m_block_stalling_timeout.load();\r\n+    const auto new_timeout = std::max(stalling_timeout / 2, DEFAULT_BLOCK_STALLING_TIMEOUT);\r\n+    if (m_block_stalling_timeout.compare_exchange_strong(stalling_timeout, new_timeout) && stalling_timeout != new_timeout) {\r\n+        LogPrint(BCLog::NET, \"Decreased stalling timeout to %d seconds\\n\", new_timeout.count());\r\n     }\r\n }\r\n \r\n void PeerManagerImpl::BlockDisconnected(const std::shared_ptr<const CBlock> &block, const CBlockIndex* pindex)\r\n {\r\n     // To avoid relay problems with transactions that were previously\r\n@@ -5231,22 +5233,25 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\r\n                 }\r\n         }\r\n         if (!vInv.empty())\r\n             m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::INV, vInv));\r\n \r\n         // Detect whether we're stalling\r\n-        if (state.m_stalling_since.count() && state.m_stalling_since < current_time - m_block_stalling_timeout.load()) {\r\n+        auto stalling_timeout = m_block_stalling_timeout.load();\r\n+        if (state.m_stalling_since.count() && state.m_stalling_since < current_time - stalling_timeout) {\r\n             // Stalling only triggers when the block download window cannot move. During normal steady state,\r\n             // the download window should be much larger than the to-be-downloaded set of blocks, so disconnection\r\n             // should only happen during initial block download.\r\n             LogPrintf(\"Peer=%d is stalling block download, disconnecting\\n\", pto->GetId());\r\n             pto->fDisconnect = true;\r\n             // Increase timeout for the next peer so that we don't disconnect multiple peers if our own\r\n             // bandwidth is insufficient.\r\n-            m_block_stalling_timeout = std::min(2 * m_block_stalling_timeout.load(), MAX_BLOCK_STALLING_TIMEOUT);\r\n-            LogPrint(BCLog::NET, \"Increased stalling timeout temporarily to %d seconds\\n\", m_block_stalling_timeout.load().count());\r\n+            const auto new_timeout = std::min(2 * stalling_timeout, MAX_BLOCK_STALLING_TIMEOUT);\r\n+            if (m_block_stalling_timeout.compare_exchange_strong(stalling_timeout, new_timeout) && stalling_timeout != new_timeout) {\r\n+                LogPrint(BCLog::NET, \"Increased stalling timeout temporarily to %d seconds\\n\", new_timeout.count());\r\n+            }\r\n             return true;\r\n         }\r\n         // In case there is a block that has been in flight from this peer for block_interval * (1 + 0.5 * N)\r\n         // (with N the number of peers from which we're downloading validated blocks), disconnect due to timeout.\r\n         // We compensate for other peers to prevent killing off peers due to our own downstream link\r\n         // being saturated. We only count validated in-flight blocks so peers can't advertise non-existing block hashes\r\n```\r\n</details>\r\n",
      "commit_id" : "7c8c4e47137aa8c6e96163f55ccfadc75ba84c1a",
      "created_at" : "2022-08-31T08:09:15Z",
      "diff_hunk" : "@@ -5225,12 +5234,16 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n             m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::INV, vInv));\n \n         // Detect whether we're stalling\n-        if (state.m_stalling_since.count() && state.m_stalling_since < current_time - BLOCK_STALLING_TIMEOUT) {\n+        if (state.m_stalling_since.count() && state.m_stalling_since < current_time - m_block_stalling_timeout.load()) {\n             // Stalling only triggers when the block download window cannot move. During normal steady state,\n             // the download window should be much larger than the to-be-downloaded set of blocks, so disconnection\n             // should only happen during initial block download.\n             LogPrintf(\"Peer=%d is stalling block download, disconnecting\\n\", pto->GetId());\n             pto->fDisconnect = true;\n+            // Increase timeout for the next peer so that we don't disconnect multiple peers if our own\n+            // bandwidth is insufficient.\n+            m_block_stalling_timeout = std::min(2 * m_block_stalling_timeout.load(), MAX_BLOCK_STALLING_TIMEOUT);\n+            LogPrint(BCLog::NET, \"Increased stalling timeout temporarily to %d seconds\\n\", m_block_stalling_timeout.load().count());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25880#discussion_r959286134",
      "id" : 959286134,
      "line" : 5246,
      "node_id" : "PRRC_kwDOABII5845LYt2",
      "original_commit_id" : "7c8c4e47137aa8c6e96163f55ccfadc75ba84c1a",
      "original_line" : 5246,
      "original_position" : 48,
      "original_start_line" : 5245,
      "path" : "src/net_processing.cpp",
      "position" : 48,
      "pull_request_review_id" : 1091419557,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25880",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/959286134/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 5245,
      "start_side" : "RIGHT",
      "updated_at" : "2022-08-31T08:20:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/959286134",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25880#discussion_r959291124"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25880"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/959291124"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The increase would happen regardless of IBD, but decrease - only if IBD. In theory, this means that once out of IBD, the timeout could only increase or stay unchanged, but never decrease. Is this intended? \r\n\r\nMaybe better have the IBD condition on both inc/dec or remove it from both.",
      "commit_id" : "7c8c4e47137aa8c6e96163f55ccfadc75ba84c1a",
      "created_at" : "2022-08-31T08:13:38Z",
      "diff_hunk" : "@@ -5225,12 +5234,16 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n             m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::INV, vInv));\n \n         // Detect whether we're stalling\n-        if (state.m_stalling_since.count() && state.m_stalling_since < current_time - BLOCK_STALLING_TIMEOUT) {\n+        if (state.m_stalling_since.count() && state.m_stalling_since < current_time - m_block_stalling_timeout.load()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25880#discussion_r959291124",
      "id" : 959291124,
      "line" : 5237,
      "node_id" : "PRRC_kwDOABII5845LZ70",
      "original_commit_id" : "7c8c4e47137aa8c6e96163f55ccfadc75ba84c1a",
      "original_line" : 5237,
      "original_position" : 39,
      "original_start_line" : 5228,
      "path" : "src/net_processing.cpp",
      "position" : 39,
      "pull_request_review_id" : 1091419557,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25880",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/959291124/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 5228,
      "start_side" : "LEFT",
      "updated_at" : "2022-08-31T08:18:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/959291124",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25880#discussion_r959293576"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25880"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/959293576"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The decrease does not log anything, but increase does. For symmetry and more log clarity, is it better to log both operations?\r\n",
      "commit_id" : "7c8c4e47137aa8c6e96163f55ccfadc75ba84c1a",
      "created_at" : "2022-08-31T08:15:48Z",
      "diff_hunk" : "@@ -1723,6 +1729,9 @@ void PeerManagerImpl::BlockConnected(const std::shared_ptr<const CBlock>& pblock\n             m_txrequest.ForgetTxHash(ptx->GetWitnessHash());\n         }\n     }\n+    if (m_chainman.ActiveChainstate().IsInitialBlockDownload()) {\n+        m_block_stalling_timeout = std::max(m_block_stalling_timeout.load() / 2, DEFAULT_BLOCK_STALLING_TIMEOUT);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25880#discussion_r959293576",
      "id" : 959293576,
      "line" : 1733,
      "node_id" : "PRRC_kwDOABII5845LaiI",
      "original_commit_id" : "7c8c4e47137aa8c6e96163f55ccfadc75ba84c1a",
      "original_line" : 1733,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 29,
      "pull_request_review_id" : 1091419557,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25880",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/959293576/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-31T08:18:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/959293576",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25880#discussion_r959300991"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25880"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/959300991"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I agree it seems better to decrease it slowly. If it was a single slow peer, then there would be many blocks coming on time afterwards.",
      "commit_id" : "7c8c4e47137aa8c6e96163f55ccfadc75ba84c1a",
      "created_at" : "2022-08-31T08:23:38Z",
      "diff_hunk" : "@@ -1723,6 +1729,9 @@ void PeerManagerImpl::BlockConnected(const std::shared_ptr<const CBlock>& pblock\n             m_txrequest.ForgetTxHash(ptx->GetWitnessHash());\n         }\n     }\n+    if (m_chainman.ActiveChainstate().IsInitialBlockDownload()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25880#discussion_r959300991",
      "id" : 959300991,
      "in_reply_to_id" : 956425910,
      "line" : 1732,
      "node_id" : "PRRC_kwDOABII5845LcV_",
      "original_commit_id" : "686936c92afa30b38ad11e4c04af6b98e104e79f",
      "original_line" : 1732,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 28,
      "pull_request_review_id" : 1091484437,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25880",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/959300991/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-31T08:23:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/959300991",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   }
]
